<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Ruby on Rails Tutorial: Learn Rails by Example book and screencasts by Michael Hartl</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="robots" content="all" />
<meta name="MSSmartTagsPreventParsing" content="true" />
<meta name="description" content="Ruby on Rails Tutorial: Learn Rails by Example by Michael Hartl" />
<meta name="keywords" content="Learn Ruby Rails Tutorial web development Rails 3" />
<meta name="author" content="Michael Hartl" />
<meta property="og:title" content="Ruby on Rails Tutorial: Learn Rails by Example"/>
<meta property="og:site_name" content="Ruby on Rails Tutorial"/>
<meta property="og:image" content="http://railstutorial.org/images/layout/logo.png"/>
<meta property="og:url" content="http://railstutorial.org/">
<meta property="og:type" content="article" />
<meta property="og:description" content="Ruby on Rails Tutorial: Learn Rails by Example by Michael Hartl teaches web development with Ruby on Rails. Rails Tutorial is fully up-to-date with Rails 3.0." />
    <link href="http://ruby.railstutorial.org/stylesheets/polytexnic.css?1343449023" media="screen" rel="stylesheet" type="text/css" />
    <link href="http://ruby.railstutorial.org/stylesheets/pygments.css?1343449023" media="screen" rel="stylesheet" type="text/css" />

      <link href="http://ruby.railstutorial.org/stylesheets/screen.css?1343449023" media="screen, projection" rel="stylesheet" type="text/css" />
      
    <link href="http://ruby.railstutorial.org/stylesheets/print.css?1343449023" media="print" rel="stylesheet" type="text/css" />
    <!--[if lte IE 7]><link href="/stylesheets/ie.css?1343449023" media="screen" rel="stylesheet" type="text/css" /><![endif]-->
    <!--[if lt IE 7]>  <div style='border: 1px solid #F7941D; background: #FEEFDA; text-align: center; clear: both; height: 75px; position: relative;'>    <div style='position: absolute; right: 3px; top: 3px; font-family: courier new; font-weight: bold;'><a href='#' onclick='javascript:this.parentNode.parentNode.style.display="none"; return false;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-cornerx.jpg' style='border: none;' alt='Close this notice'/></a></div>    <div style='width: 640px; margin: 0 auto; text-align: left; padding: 0; overflow: hidden; color: black;'>      <div style='width: 75px; float: left;'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-warning.jpg' alt='Warning!'/></div>      <div style='width: 275px; float: left; font-family: Arial, sans-serif;'>        <div style='font-size: 14px; font-weight: bold; margin-top: 12px;'>You are using an outdated browser</div>        <div style='font-size: 12px; margin-top: 6px; line-height: 12px;'>For a better experience using this site, please upgrade to a modern web browser.</div>      </div>      <div style='width: 75px; float: left;'><a href='http://www.firefox.com' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-firefox.jpg' style='border: none;' alt='Get Firefox 3.5'/></a></div>      <div style='width: 75px; float: left;'><a href='http://www.browserforthebetter.com/download.html' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-ie8.jpg' style='border: none;' alt='Get Internet Explorer 8'/></a></div>      <div style='width: 73px; float: left;'><a href='http://www.apple.com/safari/download/' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-safari.jpg' style='border: none;' alt='Get Safari 4'/></a></div>      <div style='float: left;'><a href='http://www.google.com/chrome' target='_blank'><img src='http://www.ie6nomore.com/files/theme/ie6nomore-chrome.jpg' style='border: none;' alt='Get Google Chrome'/></a></div>    </div>  </div>  <![endif]-->
    <link href='http://feeds.feedburner.com/railstutorial' rel='alternate' title='Rails Tutorial News' type='application/rss+xml' />

    
    <script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>    
    
  <base href="http://ruby.railstutorial.org/book/ruby-on-rails-tutorial" />
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'],["\\(","\\)"]]},
    processEscapes: true,
    "HTML-CSS": {
      availableFonts: ["TeX"]
    }
  });
</script>    


  </head>
<body class="book"> 

  <div id="container">
    <div id="header" class="clearfix"><div id='title'>
  <div id='logo'><a href="http://ruby.railstutorial.org/"><img alt="Logo" src="/images/layout/logo.png?1343449023" /></a></div>
  <h1 id='name'>
    <a href="http://ruby.railstutorial.org/">Ruby on Rails Tutorial</a>
  </h1>
  <br />
  <h2 id='authors'>
    <a href="http://ruby.railstutorial.org/#author">by Michael Hartl</a>
  </h2>
</div>
</div>
    <div id="menu"><div class='links'>
  <div class='box'>
    <span>
      <a href="http://ruby.railstutorial.org/">Home</a>
    </span>
    <span class='division'>
      |
    </span>
    <span>
      <a href="/ruby-on-rails-tutorial-book">Book</a>
    </span>
    <span class='division'>
      |
    </span>
    <span>
      <a href="/help">Help</a>
    </span>
    <span class='division'>
      |
    </span>
    <span>
      <a href="/contact">Contact</a>
    </span>
    <span class='division'>
      |
    </span>
    <span>
      <a href="http://news.railstutorial.org/">News</a>
    </span>
    <span class='img'>
      <a href="http://feeds.feedburner.com/railstutorial"><img alt="Feed-icon16x16" class="feed" src="/images/icons/feed-icon16x16.png?1343449023" /></a>
    </span>
    <!-- %span.division -->
    <!-- 
    -->
    <!-- %span -->
    <!-- = link_to "By Email", email_url -->
    <!-- %span.img -->
    <!-- = link_to email_icon, email_url -->
    <span class='division'>
      |
    </span>
    <span>
      <a href="http://twitter.com/railstutorial">Follow</a>
    </span>
    <span>
      <a href="http://twitter.com/railstutorial"><img alt="Twitter-small" src="/images/icons/twitter-small.png?1343449023" /></a>
    </span>
  </div>
</div>
</div>     
      <div id="content">         
        <div id='sidebar'>
  <div class='content'>
      <!-- = link_to image_tag("icons/feed-icon32x32.png"), feed_url -->
    <!-- = link_to image_tag("icons/twitter.png"), twitter_url -->
    <!-- = link_to image_tag("icons/mail-icons/mail-icon-32x32.png"), email_url -->
    <div id='navtool'>
      <table class='layout'>
        <tr>
          <td colspan='2'><a href="#book_menu"><img alt="Up A Level" src="/images/buttons/sb_button_up.png?1343449022" /></a></td>
        </tr>
        <tr>
          <td><img alt="Previous Chapter" src="/images/buttons/sb_button_prev.png?1343449022" /></td>
          <td><img alt="Next Chapter" src="/images/buttons/sb_button_next.png?1343449022" /></td>
        </tr>
      </table>
      <!-- = render 'shared/print_edition' -->
      <!-- %br -->
      <a href="/#buy"><img alt="Buy Screencasts" src="/images/buttons/sb_button_pdf_screencasts_red.png?1343449022" /></a>
      <center><a href="http://youtu.be/bOdn9EdUquo" target="_blank"><img alt="Screencasts_thumbnail_play" src="/images/thumbnails/screencasts_thumbnail_play.png?1343449023" /></a></center>
      <div class='connect'>
        <table class='center'>
          <tr>
            <td><a href="http://feeds.feedburner.com/railstutorial"><img alt="Feed-icon24x24" src="/images/icons/feed-icon24x24.png?1343449023" title="Get news updates via RSS" /></a></td>
            <td><a href="http://feedburner.google.com/fb/a/mailverify?uri=railstutorial&amp;loc=en_US"><img alt="Mail-icon-24x24" src="/images/icons/mail-icons/mail-icon-24x24.png?1343449023" title="Get news updates by email" /></a></td>
            <td><a href="http://www.facebook.com/pages/Ruby-on-Rails-Tutorial/197151265072"><img alt="Facebook-icon24x24" src="/images/icons/facebook-icon24x24.png?1343449023" title="Become a fan on Facebook" /></a></td>
            <td><a href="http://twitter.com/railstutorial"><img alt="Twitter-icon24x24" src="/images/icons/twitter-icon24x24.png?1343449023" title="Follow on Twitter" /></a></td>
          </tr>
        </table>
      </div>
      <div class='section'>
        <div class='switcher'>
          <span class='title round'>Rails 3.2</span>
          &#149;
          <span class='switcher_link'><a href="/book?version=3.0">Rails 3.0</a></span>
        </div>
        <div class='share'><fb:like href="http://railstutorial.org/" show_faces="false" layout="button_count" colorscheme="light"></fb:like></div>
      </div>
    </div>
    <!-- .section -->
    <!-- Sidebar areas labeled with class "section", like this one, will be styled suitably for text. -->
    <!-- .section -->
    <!-- %a{ :href => '/affiliates' } -->
    <!-- Rails Tutorial Affiliate Program&mdash;50% commissions -->
  </div>
</div>
<!-- %h3 Get Involved -->
<!-- 
-->
<!-- .links -->
<!-- %p.subscribe -->
<!-- %span= link_to(image_tag('feed-icon32x32.png'), feed_url) -->
<!-- = link_to("Subscribe", feed_url) -->
<!-- %p.follow -->
<!-- = link_to(image_tag('twitter.png'), twitter_url) -->
<!-- = link_to("Follow", twitter_url) -->
<!-- 
-->

                      
        <div id="main" class="withsidebar">
          


<div id="book_menu">
  <a href="#main_content">skip to content</a>
  |
  <a href="/chapters/beginning">view as individual chapters</a>
</div>


<div id="book_wrap">
  <div id="book_top">
  </div>
    <div id="book">


<h1 class="title">Ruby on Rails Tutorial </h1>


<h1 class="subtitle">  Learn Web Development with Rails</h1>


<h2 class="author">Michael Hartl</h2>




<h1 class="contents">Contents</h1>


<div id="table_of_contents"><ol><li class="chapter"><a href="#cha:beginning"><span class="number">Chapter 1</span> From zero to deploy</a></li><li><ol><li class="section"><a href="#sec:introduction"><span class="number">1.1</span> Introduction</a></li><li><ol><li class="subsection"><a href="#sec:comments_for_various_readers"><span class="number">1.1.1</span> Comments for various readers</a></li><li class="subsection"><a href="#sec:1.1.2"><span class="number">1.1.2</span> &ldquo;Scaling&rdquo; Rails</a></li><li class="subsection"><a href="#sec:conventions"><span class="number">1.1.3</span> Conventions in this book</a></li></ol></li><li class="section"><a href="#sec:up_and_running"><span class="number">1.2</span> Up and running</a></li><li><ol><li class="subsection"><a href="#sec:development_tools"><span class="number">1.2.1</span> Development environments</a></li><li><ol><li class="subsubsection"><a href="#sec:1.2.1.1">IDEs</a></li><li class="subsubsection"><a href="#sec:1.2.1.2">Text editors and command lines</a></li><li class="subsubsection"><a href="#sec:1.2.1.3">Browsers</a></li><li class="subsubsection"><a href="#sec:1.2.1.4">A note about tools</a></li></ol></li><li class="subsection"><a href="#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, and Git</a></li><li><ol><li class="subsubsection"><a href="#sec:rails_installer_windows">Rails Installer (Windows)</a></li><li class="subsubsection"><a href="#sec:install_git">Install Git</a></li><li class="subsubsection"><a href="#sec:install_ruby">Install Ruby</a></li><li class="subsubsection"><a href="#sec:install_rubygems">Install RubyGems</a></li><li class="subsubsection"><a href="#sec:install_rails">Install Rails</a></li></ol></li><li class="subsection"><a href="#sec:the_first_application"><span class="number">1.2.3</span> The first application</a></li><li class="subsection"><a href="#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="#sec:rails_server"><span class="number">1.2.5</span> <tt>rails server</tt></a></li><li class="subsection"><a href="#sec:mvc"><span class="number">1.2.6</span> Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="#sec:version_control"><span class="number">1.3</span> Version control with Git</a></li><li><ol><li class="subsection"><a href="#sec:git_setup"><span class="number">1.3.1</span> Installation and setup</a></li><li><ol><li class="subsubsection"><a href="#sec:1.3.1.1">First-time system setup</a></li><li class="subsubsection"><a href="#sec:1.3.1.2">First-time repository setup</a></li></ol></li><li class="subsection"><a href="#sec:adding_and_committing"><span class="number">1.3.2</span> Adding and committing</a></li><li class="subsection"><a href="#sec:1.3.3"><span class="number">1.3.3</span> What good does Git do you?</a></li><li class="subsection"><a href="#sec:github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li><li><ol><li class="subsubsection"><a href="#sec:git_branch">Branch</a></li><li class="subsubsection"><a href="#sec:git_edit">Edit</a></li><li class="subsubsection"><a href="#sec:git_commit">Commit</a></li><li class="subsubsection"><a href="#sec:git_merge">Merge</a></li><li class="subsubsection"><a href="#sec:git_push">Push</a></li></ol></li></ol></li><li class="section"><a href="#sec:deploying"><span class="number">1.4</span> Deploying</a></li><li><ol><li class="subsection"><a href="#sec:1.4.1"><span class="number">1.4.1</span> Heroku setup</a></li><li class="subsection"><a href="#sec:heroku_step_one"><span class="number">1.4.2</span> Heroku deployment, step one</a></li><li class="subsection"><a href="#sec:1.4.3"><span class="number">1.4.3</span> Heroku deployment, step two</a></li><li class="subsection"><a href="#sec:heroku_commands"><span class="number">1.4.4</span> Heroku commands</a></li></ol></li><li class="section"><a href="#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li><li class="chapter"><a href="#cha:a_demo_app"><span class="number">Chapter 2</span> A demo app</a></li><li><ol><li class="section"><a href="#sec:planning_the_application"><span class="number">2.1</span> Planning the application</a></li><li><ol><li class="subsection"><a href="#sec:modeling_demo_users"><span class="number">2.1.1</span> Modeling demo users</a></li><li class="subsection"><a href="#sec:modeling_demo_microposts"><span class="number">2.1.2</span> Modeling demo microposts</a></li></ol></li><li class="section"><a href="#sec:demo_users_resource"><span class="number">2.2</span> The Users resource</a></li><li><ol><li class="subsection"><a href="#sec:a_user_tour"><span class="number">2.2.1</span> A user tour</a></li><li class="subsection"><a href="#sec:mvc_in_action"><span class="number">2.2.2</span> MVC in action</a></li><li class="subsection"><a href="#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Weaknesses of this Users resource</a></li></ol></li><li class="section"><a href="#sec:microposts_resource"><span class="number">2.3</span> The Microposts resource</a></li><li><ol><li class="subsection"><a href="#sec:a_micropost_microtour"><span class="number">2.3.1</span> A micropost microtour</a></li><li class="subsection"><a href="#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Putting the <em>micro</em> in microposts</a></li><li class="subsection"><a href="#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> A user <tt>has_many</tt> microposts</a></li><li class="subsection"><a href="#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Inheritance hierarchies</a></li><li class="subsection"><a href="#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Deploying the demo app</a></li></ol></li><li class="section"><a href="#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li><li class="chapter"><a href="#cha:static_pages"><span class="number">Chapter 3</span> Mostly static pages</a></li><li><ol><li class="section"><a href="#sec:static_pages"><span class="number">3.1</span> Static pages</a></li><li><ol><li class="subsection"><a href="#sec:truly_static_pages"><span class="number">3.1.1</span> Truly static pages</a></li><li class="subsection"><a href="#sec:static_pages_with_rails"><span class="number">3.1.2</span> Static pages with Rails</a></li></ol></li><li class="section"><a href="#sec:first_tests"><span class="number">3.2</span> Our first tests</a></li><li><ol><li class="subsection"><a href="#sec:TDD"><span class="number">3.2.1</span> Test-driven development</a></li><li class="subsection"><a href="#sec:adding_a_page"><span class="number">3.2.2</span> Adding a page</a></li><li><ol><li class="subsubsection"><a href="#sec:red">Red</a></li><li class="subsubsection"><a href="#sec:green">Green</a></li><li class="subsubsection"><a href="#sec:refactor">Refactor</a></li></ol></li></ol></li><li class="section"><a href="#sec:slightly_dynamic_pages"><span class="number">3.3</span> Slightly dynamic pages</a></li><li><ol><li class="subsection"><a href="#sec:testing_a_title_change"><span class="number">3.3.1</span> Testing a title change</a></li><li class="subsection"><a href="#sec:passing_title_tests"><span class="number">3.3.2</span> Passing title tests</a></li><li class="subsection"><a href="#sec:embedded_ruby"><span class="number">3.3.3</span> Embedded Ruby</a></li><li class="subsection"><a href="#sec:layouts"><span class="number">3.3.4</span> Eliminating duplication with layouts</a></li></ol></li><li class="section"><a href="#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li><li class="section"><a href="#sec:static_pages_exercises"><span class="number">3.5</span> Exercises</a></li><li class="section"><a href="#sec:advanced_setup"><span class="number">3.6</span> Advanced setup</a></li><li><ol><li class="subsection"><a href="#sec:eliminating_bundle_exec"><span class="number">3.6.1</span> Eliminating <tt>bundle exec</tt></a></li><li><ol><li class="subsubsection"><a href="#sec:rvm_bundler_integration">RVM Bundler integration</a></li><li class="subsubsection"><a href="#sec:binstubs">binstubs</a></li></ol></li><li class="subsection"><a href="#sec:guard"><span class="number">3.6.2</span> Automated tests with Guard</a></li><li class="subsection"><a href="#sec:spork"><span class="number">3.6.3</span> Speeding up tests with Spork</a></li><li><ol><li class="subsubsection"><a href="#sec:spork_and_guard">Guard with Spork</a></li></ol></li><li class="subsection"><a href="#sec:tests_inside_sublime_text"><span class="number">3.6.4</span> Tests inside Sublime Text</a></li></ol></li></ol></li><li class="chapter"><a href="#cha:rails_flavored_ruby"><span class="number">Chapter 4</span> Rails-flavored Ruby</a></li><li><ol><li class="section"><a href="#sec:motivation"><span class="number">4.1</span> Motivation</a></li><li class="section"><a href="#sec:strings_and_methods"><span class="number">4.2</span> Strings and methods</a></li><li><ol><li class="subsection"><a href="#sec:comments"><span class="number">4.2.1</span> Comments</a></li><li class="subsection"><a href="#sec:strings"><span class="number">4.2.2</span> Strings</a></li><li><ol><li class="subsubsection"><a href="#sec:printing">Printing</a></li><li class="subsubsection"><a href="#sec:single_quoted_strings">Single-quoted strings</a></li></ol></li><li class="subsection"><a href="#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objects and message passing</a></li><li class="subsection"><a href="#sec:method_definitions"><span class="number">4.2.4</span> Method definitions</a></li><li class="subsection"><a href="#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Back to the title helper</a></li></ol></li><li class="section"><a href="#sec:other_data_structures"><span class="number">4.3</span> Other data structures</a></li><li><ol><li class="subsection"><a href="#sec:arrays_and_ranges"><span class="number">4.3.1</span> Arrays and ranges</a></li><li class="subsection"><a href="#sec:blocks"><span class="number">4.3.2</span> Blocks</a></li><li class="subsection"><a href="#sec:hashes_and_symbols"><span class="number">4.3.3</span> Hashes and symbols</a></li><li class="subsection"><a href="#sec:css_revisited"><span class="number">4.3.4</span> CSS revisited</a></li></ol></li><li class="section"><a href="#sec:ruby_classes"><span class="number">4.4</span> Ruby classes</a></li><li><ol><li class="subsection"><a href="#sec:constructors"><span class="number">4.4.1</span> Constructors</a></li><li class="subsection"><a href="#sec:a_class_of_our_own"><span class="number">4.4.2</span> Class inheritance</a></li><li class="subsection"><a href="#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifying built-in classes</a></li><li class="subsection"><a href="#sec:a_controller_class"><span class="number">4.4.4</span> A controller class</a></li><li class="subsection"><a href="#sec:a_user_class"><span class="number">4.4.5</span> A user class</a></li></ol></li><li class="section"><a href="#sec:conclusion"><span class="number">4.5</span> Conclusion</a></li><li class="section"><a href="#sec:exercises"><span class="number">4.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="#cha:filling_in_the_layout"><span class="number">Chapter 5</span> Filling in the layout</a></li><li><ol><li class="section"><a href="#sec:structure"><span class="number">5.1</span> Adding some structure</a></li><li><ol><li class="subsection"><a href="#sec:adding_to_the_layout"><span class="number">5.1.1</span> Site navigation</a></li><li class="subsection"><a href="#sec:custom_css"><span class="number">5.1.2</span> Bootstrap and custom CSS</a></li><li class="subsection"><a href="#sec:partials"><span class="number">5.1.3</span> Partials</a></li></ol></li><li class="section"><a href="#sec:sass_and_the_asset_pipeline"><span class="number">5.2</span> Sass and the asset pipeline</a></li><li><ol><li class="subsection"><a href="#sec:the_asset_pipeline"><span class="number">5.2.1</span> The asset pipeline</a></li><li><ol><li class="subsubsection"><a href="#sec:5.2.1.1">Asset directories</a></li><li class="subsubsection"><a href="#sec:5.2.1.2">Manifest files</a></li><li class="subsubsection"><a href="#sec:5.2.1.3">Preprocessor engines</a></li><li class="subsubsection"><a href="#sec:5.2.1.4">Efficiency in production</a></li></ol></li><li class="subsection"><a href="#sec:sass"><span class="number">5.2.2</span> Syntactically awesome stylesheets</a></li><li><ol><li class="subsubsection"><a href="#sec:5.2.2.1">Nesting</a></li><li class="subsubsection"><a href="#sec:5.2.2.2">Variables</a></li></ol></li></ol></li><li class="section"><a href="#sec:layout_links"><span class="number">5.3</span> Layout links</a></li><li><ol><li class="subsection"><a href="#sec:route_tests"><span class="number">5.3.1</span> Route tests</a></li><li class="subsection"><a href="#sec:rails_routes"><span class="number">5.3.2</span> Rails routes</a></li><li class="subsection"><a href="#sec:named_routes"><span class="number">5.3.3</span> Named routes</a></li><li class="subsection"><a href="#sec:pretty_rspec"><span class="number">5.3.4</span> Pretty RSpec</a></li></ol></li><li class="section"><a href="#sec:user_signup"><span class="number">5.4</span> User signup: A first step</a></li><li><ol><li class="subsection"><a href="#sec:users_controller"><span class="number">5.4.1</span> Users controller</a></li><li class="subsection"><a href="#sec:signup_url"><span class="number">5.4.2</span> Signup URI</a></li></ol></li><li class="section"><a href="#sec:layout_conclusion"><span class="number">5.5</span> Conclusion</a></li><li class="section"><a href="#sec:layout_exercises"><span class="number">5.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="#cha:modeling_users"><span class="number">Chapter 6</span> Modeling users</a></li><li><ol><li class="section"><a href="#sec:user_model"><span class="number">6.1</span> User model</a></li><li><ol><li class="subsection"><a href="#sec:database_migrations"><span class="number">6.1.1</span> Database migrations</a></li><li class="subsection"><a href="#sec:the_model_file"><span class="number">6.1.2</span> The model file</a></li><li><ol><li class="subsubsection"><a href="#sec:model_annotation">Model annotation</a></li><li class="subsubsection"><a href="#sec:accessible_attributes">Accessible attributes</a></li></ol></li><li class="subsection"><a href="#sec:creating_user_objects"><span class="number">6.1.3</span> Creating user objects</a></li><li class="subsection"><a href="#sec:finding_user_objects"><span class="number">6.1.4</span> Finding user objects</a></li><li class="subsection"><a href="#sec:updating_user_objects"><span class="number">6.1.5</span> Updating user objects</a></li></ol></li><li class="section"><a href="#sec:user_validations"><span class="number">6.2</span> User validations</a></li><li><ol><li class="subsection"><a href="#sec:initial_user_tests"><span class="number">6.2.1</span> Initial user tests</a></li><li class="subsection"><a href="#sec:presence_validation"><span class="number">6.2.2</span> Validating presence</a></li><li class="subsection"><a href="#sec:length_validation"><span class="number">6.2.3</span> Length validation</a></li><li class="subsection"><a href="#sec:format_validation"><span class="number">6.2.4</span> Format validation</a></li><li class="subsection"><a href="#sec:uniqueness_validation"><span class="number">6.2.5</span> Uniqueness validation</a></li><li><ol><li class="subsubsection"><a href="#sec:the_caveat">The uniqueness caveat</a></li></ol></li></ol></li><li class="section"><a href="#sec:adding_a_secure_password"><span class="number">6.3</span> Adding a secure password</a></li><li><ol><li class="subsection"><a href="#sec:an_encrypted_password"><span class="number">6.3.1</span> An encrypted password</a></li><li class="subsection"><a href="#sec:password_and_confirmation"><span class="number">6.3.2</span> Password and confirmation</a></li><li class="subsection"><a href="#sec:user_authentication"><span class="number">6.3.3</span> User authentication</a></li><li class="subsection"><a href="#sec:has_secure_password"><span class="number">6.3.4</span> User has secure password</a></li><li class="subsection"><a href="#sec:creating_a_user"><span class="number">6.3.5</span> Creating a user</a></li></ol></li><li class="section"><a href="#sec:6.4"><span class="number">6.4</span> Conclusion</a></li><li class="section"><a href="#sec:6.5"><span class="number">6.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="#cha:sign_up"><span class="number">Chapter 7</span> Sign up</a></li><li><ol><li class="section"><a href="#sec:showing_users"><span class="number">7.1</span> Showing users</a></li><li><ol><li class="subsection"><a href="#sec:rails_environments"><span class="number">7.1.1</span> Debug and Rails environments</a></li><li class="subsection"><a href="#sec:a_users_resource"><span class="number">7.1.2</span> A Users resource</a></li><li class="subsection"><a href="#sec:tests_with_factories"><span class="number">7.1.3</span> Testing the user show page (with factories)</a></li><li class="subsection"><a href="#sec:a_gravatar_image"><span class="number">7.1.4</span> A Gravatar image and a sidebar</a></li></ol></li><li class="section"><a href="#sec:signup_form"><span class="number">7.2</span> Signup form</a></li><li><ol><li class="subsection"><a href="#sec:tests_for_user_signup"><span class="number">7.2.1</span> Tests for user signup</a></li><li class="subsection"><a href="#sec:using_form_for"><span class="number">7.2.2</span> Using <tt>form_for</tt></a></li><li class="subsection"><a href="#sec:the_form_html"><span class="number">7.2.3</span> The form HTML</a></li></ol></li><li class="section"><a href="#sec:signup_failure"><span class="number">7.3</span> Signup failure</a></li><li><ol><li class="subsection"><a href="#sec:a_working_form"><span class="number">7.3.1</span> A working form</a></li><li class="subsection"><a href="#sec:signup_error_messages"><span class="number">7.3.2</span> Signup error messages</a></li></ol></li><li class="section"><a href="#sec:signup_success"><span class="number">7.4</span> Signup success</a></li><li><ol><li class="subsection"><a href="#sec:the_finished_signup_form"><span class="number">7.4.1</span> The finished signup form</a></li><li class="subsection"><a href="#sec:the_flash"><span class="number">7.4.2</span> The flash</a></li><li class="subsection"><a href="#sec:the_first_signup"><span class="number">7.4.3</span> The first signup</a></li><li class="subsection"><a href="#sec:deploying_to_production_with_ssl"><span class="number">7.4.4</span> Deploying to production with SSL</a></li></ol></li><li class="section"><a href="#sec:7.5"><span class="number">7.5</span> Conclusion</a></li><li class="section"><a href="#sec:signup_exercises"><span class="number">7.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="#cha:sign_in_sign_out"><span class="number">Chapter 8</span> Sign in, sign out</a></li><li><ol><li class="section"><a href="#sec:signin_failure"><span class="number">8.1</span> Sessions and signin failure</a></li><li><ol><li class="subsection"><a href="#sec:sessions_controller"><span class="number">8.1.1</span> Sessions controller</a></li><li class="subsection"><a href="#sec:signin_tests"><span class="number">8.1.2</span> Signin tests</a></li><li class="subsection"><a href="#sec:signin_form"><span class="number">8.1.3</span> Signin form</a></li><li class="subsection"><a href="#sec:reviewing_form_submission"><span class="number">8.1.4</span> Reviewing form submission</a></li><li class="subsection"><a href="#sec:rendering_with_a_flash_message"><span class="number">8.1.5</span> Rendering with a flash message</a></li></ol></li><li class="section"><a href="#sec:signin_success"><span class="number">8.2</span> Signin success</a></li><li><ol><li class="subsection"><a href="#sec:remember_me"><span class="number">8.2.1</span> Remember me</a></li><li class="subsection"><a href="#sec:a_working_sign_in_method"><span class="number">8.2.2</span> A working <tt>sign_in</tt> method</a></li><li class="subsection"><a href="#sec:current_user"><span class="number">8.2.3</span> Current user</a></li><li class="subsection"><a href="#sec:changing_the_layout_links"><span class="number">8.2.4</span> Changing the layout links</a></li><li class="subsection"><a href="#sec:signin_upon_signup"><span class="number">8.2.5</span> Signin upon signup</a></li><li class="subsection"><a href="#sec:signing_out"><span class="number">8.2.6</span> Signing out</a></li></ol></li><li class="section"><a href="#sec:cucumber"><span class="number">8.3</span> Introduction to Cucumber (optional)</a></li><li><ol><li class="subsection"><a href="#sec:installation_and_setup"><span class="number">8.3.1</span> Installation and setup</a></li><li class="subsection"><a href="#sec:features_and_steps"><span class="number">8.3.2</span> Features and steps</a></li><li class="subsection"><a href="#sec:rspec_custom_matchers"><span class="number">8.3.3</span> Counterpoint: RSpec custom matchers</a></li></ol></li><li class="section"><a href="#sec:8.4"><span class="number">8.4</span> Conclusion</a></li><li class="section"><a href="#sec:sign_in_out_exercises"><span class="number">8.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="#cha:updating_showing_and_deleting_users"><span class="number">Chapter 9</span> Updating, showing, and deleting users</a></li><li><ol><li class="section"><a href="#sec:updating_users"><span class="number">9.1</span> Updating users</a></li><li><ol><li class="subsection"><a href="#sec:edit_form"><span class="number">9.1.1</span> Edit form</a></li><li class="subsection"><a href="#sec:unsuccessful_edits"><span class="number">9.1.2</span> Unsuccessful edits</a></li><li class="subsection"><a href="#sec:successful_edits"><span class="number">9.1.3</span> Successful edits</a></li></ol></li><li class="section"><a href="#sec:authorization"><span class="number">9.2</span> Authorization</a></li><li><ol><li class="subsection"><a href="#sec:requiring_signed_in_users"><span class="number">9.2.1</span> Requiring signed-in users</a></li><li class="subsection"><a href="#sec:requiring_the_right_user"><span class="number">9.2.2</span> Requiring the right user</a></li><li class="subsection"><a href="#sec:friendly_forwarding"><span class="number">9.2.3</span> Friendly forwarding</a></li></ol></li><li class="section"><a href="#sec:showing_all_users"><span class="number">9.3</span> Showing all users</a></li><li><ol><li class="subsection"><a href="#sec:user_index"><span class="number">9.3.1</span> User index</a></li><li class="subsection"><a href="#sec:sample_users"><span class="number">9.3.2</span> Sample users</a></li><li class="subsection"><a href="#sec:pagination"><span class="number">9.3.3</span> Pagination</a></li><li class="subsection"><a href="#sec:partial_refactoring"><span class="number">9.3.4</span> Partial refactoring</a></li></ol></li><li class="section"><a href="#sec:destroying_users"><span class="number">9.4</span> Deleting users</a></li><li><ol><li class="subsection"><a href="#sec:administrative_users"><span class="number">9.4.1</span> Administrative users</a></li><li><ol><li class="subsubsection"><a href="#sec:revisiting_attr_accessible">Revisiting <tt>attr_accessible</tt></a></li></ol></li><li class="subsection"><a href="#sec:the_destroy_action"><span class="number">9.4.2</span> The <tt>destroy</tt> action</a></li></ol></li><li class="section"><a href="#sec:9.5"><span class="number">9.5</span> Conclusion</a></li><li class="section"><a href="#sec:updating_deleting_exercises"><span class="number">9.6</span> Exercises</a></li></ol></li><li class="chapter"><a href="#cha:user_microposts"><span class="number">Chapter 10</span> User microposts</a></li><li><ol><li class="section"><a href="#sec:a_micropost_model"><span class="number">10.1</span> A Micropost model</a></li><li><ol><li class="subsection"><a href="#sec:the_basic_model"><span class="number">10.1.1</span> The basic model</a></li><li class="subsection"><a href="#sec:accessible_attribute"><span class="number">10.1.2</span> Accessible attributes and the first validation</a></li><li class="subsection"><a href="#sec:user_micropost_associations"><span class="number">10.1.3</span> User/Micropost associations</a></li><li class="subsection"><a href="#sec:ordering_and_dependency"><span class="number">10.1.4</span> Micropost refinements</a></li><li><ol><li class="subsubsection"><a href="#sec:default_scope">Default scope</a></li><li class="subsubsection"><a href="#sec:dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="#sec:micropost_validations"><span class="number">10.1.5</span> Content validations</a></li></ol></li><li class="section"><a href="#sec:showing_microposts"><span class="number">10.2</span> Showing microposts</a></li><li><ol><li class="subsection"><a href="#sec:augmenting_the_user_show_page"><span class="number">10.2.1</span> Augmenting the user show page</a></li><li class="subsection"><a href="#sec:sample_microposts"><span class="number">10.2.2</span> Sample microposts</a></li></ol></li><li class="section"><a href="#sec:manipulating_microposts"><span class="number">10.3</span> Manipulating microposts</a></li><li><ol><li class="subsection"><a href="#sec:access_control"><span class="number">10.3.1</span> Access control</a></li><li class="subsection"><a href="#sec:creating_microposts"><span class="number">10.3.2</span> Creating microposts</a></li><li class="subsection"><a href="#sec:a_proto_feed"><span class="number">10.3.3</span> A proto-feed</a></li><li class="subsection"><a href="#sec:destroying_microposts"><span class="number">10.3.4</span> Destroying microposts</a></li></ol></li><li class="section"><a href="#sec:10.4"><span class="number">10.4</span> Conclusion</a></li><li class="section"><a href="#sec:micropost_exercises"><span class="number">10.5</span> Exercises</a></li></ol></li><li class="chapter"><a href="#cha:following_users"><span class="number">Chapter 11</span> Following users</a></li><li><ol><li class="section"><a href="#sec:the_relationship_model"><span class="number">11.1</span> The Relationship model</a></li><li><ol><li class="subsection"><a href="#sec:a_problem_with_the_data_model"><span class="number">11.1.1</span> A problem with the data model (and a solution)</a></li><li class="subsection"><a href="#sec:relationship_user_associations"><span class="number">11.1.2</span> User/relationship associations</a></li><li class="subsection"><a href="#sec:relationship_validations"><span class="number">11.1.3</span> Validations</a></li><li class="subsection"><a href="#sec:following"><span class="number">11.1.4</span> Followed users</a></li><li class="subsection"><a href="#sec:followers"><span class="number">11.1.5</span> Followers</a></li></ol></li><li class="section"><a href="#sec:a_web_interface_for_following_and_followers"><span class="number">11.2</span> A web interface for following users</a></li><li><ol><li class="subsection"><a href="#sec:sample_following_data"><span class="number">11.2.1</span> Sample following data</a></li><li class="subsection"><a href="#sec:stats_and_a_follow_form"><span class="number">11.2.2</span> Stats and a follow form</a></li><li class="subsection"><a href="#sec:following_and_followers_pages"><span class="number">11.2.3</span> Following and followers pages</a></li><li class="subsection"><a href="#sec:a_working_follow_button_the_standard_way"><span class="number">11.2.4</span> A working follow button the standard way</a></li><li class="subsection"><a href="#sec:a_working_follow_button_with_ajax"><span class="number">11.2.5</span> A working follow button with Ajax</a></li></ol></li><li class="section"><a href="#sec:the_status_feed"><span class="number">11.3</span> The status feed</a></li><li><ol><li class="subsection"><a href="#sec:motivation_and_strategy"><span class="number">11.3.1</span> Motivation and strategy</a></li><li class="subsection"><a href="#sec:a_first_feed_implementation"><span class="number">11.3.2</span> A first feed implementation</a></li><li class="subsection"><a href="#sec:scopes_subselects_and_a_lambda"><span class="number">11.3.3</span> Subselects</a></li><li class="subsection"><a href="#sec:the_new_status_feed"><span class="number">11.3.4</span> The new status feed</a></li></ol></li><li class="section"><a href="#sec:following_conclusion"><span class="number">11.4</span> Conclusion</a></li><li><ol><li class="subsection"><a href="#sec:extensions_to_the_sample_application"><span class="number">11.4.1</span> Extensions to the sample application</a></li><li><ol><li class="subsubsection"><a href="#sec:replies">Replies</a></li><li class="subsubsection"><a href="#sec:messaging">Messaging</a></li><li class="subsubsection"><a href="#sec:follower_notifications">Follower notifications</a></li><li class="subsubsection"><a href="#sec:password_reminders">Password reminders</a></li><li class="subsubsection"><a href="#sec:signup_confirmation">Signup confirmation</a></li><li class="subsubsection"><a href="#sec:rss_feed">RSS feed</a></li><li class="subsubsection"><a href="#sec:rest_api">REST API</a></li><li class="subsubsection"><a href="#sec:search">Search</a></li></ol></li><li class="subsection"><a href="#sec:guide_to_further_resources"><span class="number">11.4.2</span> Guide to further resources</a></li></ol></li><li class="section"><a href="#sec:following_exercises"><span class="number">11.5</span> Exercises</a></li></ol></li></ol></div>


<div id="main_content"></div>


<p> <span class="preamble">
 <span id="foreword">
<strong> Foreword</strong> <br />
 </span>
 </span></p>

<p>My former company (CD Baby) was one of the first to loudly switch to Ruby on Rails, and then even more loudly switch back to PHP (Google me to read about the drama). This book by Michael Hartl came so highly recommended that I had to try it, and the <em>Ruby on Rails Tutorial</em> is what I used to switch back to Rails again.</p>

<p>Though I&rsquo;ve worked my way through many Rails books, this is the one that finally made me &ldquo;get&rdquo; it. Everything is done very much &ldquo;the Rails way&rdquo;&mdash;a way that felt very unnatural to me before, but now after doing this book finally feels natural. This is also the only Rails book that does test-driven development the entire time, an approach highly recommended by the experts but which has never been so clearly demonstrated before. Finally, by including Git, GitHub, and Heroku in the demo examples, the author really gives you a feel for what it&rsquo;s like to do a real-world project. The tutorial&rsquo;s code examples are not in isolation.</p>

<p>The linear narrative is such a great format. Personally, I powered through the <em>Rails Tutorial</em> in three long days, doing all the examples and challenges at the end of each chapter. Do it from start to finish, without jumping around, and you&rsquo;ll get the ultimate benefit.</p>

<p>Enjoy!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Formerly: Founder,</em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Currently: Founder,</em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Acknowledgments</strong> <br />
 </span></p>

<p>The <em>Ruby on Rails Tutorial</em> owes a lot to my previous Rails book, <em>RailsSpace</em>, and hence to my coauthor <a href="http://aure.com/">Aurelius Prochazka</a>. I&rsquo;d like to thank Aure both for the work he did on that book and for his support of this one. I&rsquo;d also like to thank Debra Williams Cauley, my editor on both <em>RailsSpace</em> and the <em>Ruby on Rails Tutorial</em>; as long as she keeps taking me to baseball games, I&rsquo;ll keep writing books for her.</p>

<p>I&rsquo;d like to acknowledge a long list of Rubyists who have taught and inspired me over the years: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Wolfram Arnold, Alex Chaffee, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, the good people at Pivotal Labs, the Heroku gang, the thoughtbot guys, and the GitHub crew. Finally, many, many readers&mdash;far too many to list&mdash;have contributed a huge number of bug reports and suggestions during the writing of this book, and I gratefully acknowledge their help in making it as good as it can&nbsp;be. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> About the author</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> is the author of the <a href="http://ruby.railstutorial.org/"><em>Ruby on Rails Tutorial</em></a>, the leading introduction to web development with <a href="http://rubyonrails.org/">Ruby on Rails</a>. His prior experience includes writing and developing <em>RailsSpace</em>, an extremely obsolete Rails tutorial book, and developing Insoshi, a once-popular and now-obsolete social networking platform in Ruby on Rails. In 2011, Michael received a <a href="http://rubyheroes.com/heroes">Ruby Hero Award</a> for his contributions to the Ruby community. He is a graduate of <a href="http://college.harvard.edu/">Harvard College</a>, has a <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. in Physics</a> from <a href="http://www.caltech.edu/">Caltech</a>, and is an alumnus of the <a href="http://ycombinator.com/">Y&nbsp;Combinator</a> entrepreneur program. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright and license</strong> <br />
 </span></p>

<p><em>Ruby on Rails Tutorial: Learn Web Devlopment with Rails</em>. Copyright &copy; 2012 by Michael Hartl. All source code in the <em>Ruby on Rails Tutorial</em> is available jointly under the <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> and the <a href="http://people.freebsd.org/~phk/">Beerware License</a>.</p>

<div class="code"><div class="highlight"><pre>The MIT License

Copyright (c) 2012 Michael Hartl

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
</pre></div>
</div>


<div class="code"><div class="highlight"><pre>/*
 * ----------------------------------------------------------------------------
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 42):
 * Michael Hartl wrote this code. As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 * ----------------------------------------------------------------------------
 */
</pre></div>
</div>


<div class="label" id="cha:beginning"></div>


<h1 class="chapter"><a id="sec:1" href="#cha:beginning" class="heading"><span class="number">Chapter 1</span> From zero to deploy</a></h1>


<p>Welcome to the <a href="http://ruby.railstutorial.org/ruby-on-rails-tutorial-book"><em>Ruby on Rails Tutorial</em></a>. The goal of this book is to be the best answer to the question, &ldquo;If I want to learn web development with <a href="http://rubyonrails.org/">Ruby on Rails</a>, where should I start?&rdquo; By the time you finish the <em>Ruby on Rails Tutorial</em>, you will have all the skills you need to develop and deploy your own custom web applications with Rails. You will also be ready to benefit from the many more advanced books, blogs, and screencasts that are part of the thriving Rails educational ecosystem. Finally, since the <em>Ruby on Rails Tutorial</em> uses Rails&nbsp;3, the knowledge you gain here represents the state of the art in web development. (The most up-to-date version of the <em>Ruby on Rails Tutorial</em> can be found on the book&rsquo;s website at <a href="http://railstutorial.org/">http://railstutorial.org/</a>; if you are reading this book offline, be sure to check the <a href="http://railstutorial.org/book">online version of the Rails Tutorial book</a> at <a href="http://railstutorial.org/book">http://railstutorial.org/book</a> for the latest updates.)</p>

<p>Note that the goal of this book is <em>not</em> merely to teach Rails, but rather to teach <em>web development with Rails</em>, which means acquiring (or expanding) the skills needed to develop software for the World Wide Web. In addition to Ruby on Rails, this skillset includes HTML &amp; CSS, databases, version control, testing, and deployment. To accomplish this goal, the <em>Ruby on Rails Tutorial</em> takes an integrated approach: you will learn Rails by example by building a substantial sample application from scratch. As <a href="http://sivers.org">Derek Sivers</a> notes in the foreword, this book is structured as a linear narrative, designed to be read from start to finish. If you are used to skipping around in technical books, taking this linear approach might require some adjustment, but I suggest giving it a try. You can think of the <em>Ruby on Rails Tutorial</em> as a video game where you are the main character, and where you level up as a Rails developer in each chapter. (The exercises are the <a href="http://en.wikipedia.org/wiki/Boss_(video_gaming)#Miniboss">minibosses</a>.)</p>

<p>In this first chapter, we&rsquo;ll get started with Ruby on Rails by installing all the necessary software and by setting up our development environment (<a class="ref" href="#sec:up_and_running">Section&nbsp;1.2</a>). We&rsquo;ll then create our first Rails application, called (appropriately enough) <code>first_app</code>. The <em>Rails Tutorial</em> emphasizes good software development practices, so immediately after creating our fresh new Rails project we&rsquo;ll put it under version control with Git (<a class="ref" href="#sec:version_control">Section&nbsp;1.3</a>). And, believe it or not, in this chapter we&rsquo;ll even put our first app on the wider web by <em>deploying</em> it to production (<a class="ref" href="#sec:deploying">Section&nbsp;1.4</a>).</p>

<p>In <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>, we&rsquo;ll make a second project, whose purpose is to demonstrate the basic workings of a Rails application. To get up and running quickly, we&rsquo;ll build this <em>demo app</em> (called <code>demo_app</code>) using scaffolding (<a class="ref" href="#sidebar:scaffolding">Box&nbsp;1.1</a>) to generate code; since this code is both ugly and complex, <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a> will focus on interacting with the demo app through its <em>URIs</em> (sometimes called <em>URLs</em>)<sup class="footnote" id="fnref:1.1"><a href="#fn:1.1">1</a></sup> using a web browser.</p>

<p>The rest of the tutorial focuses on developing a single large <em>sample application</em> (called <code>sample_app</code>), writing all the code from scratch. We&rsquo;ll develop the sample app using <em>test-driven development</em> (TDD), getting started in <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a> by creating static pages and then adding a little dynamic content. We&rsquo;ll take a quick detour in <a class="ref" href="#cha:rails_flavored_ruby">Chapter&nbsp;4</a> to learn a little about the Ruby language underlying Rails. Then, in <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a> through <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>, we&rsquo;ll complete the foundation for the sample application by making a site layout, a user data model, and a full registration and authentication system. Finally, in <a class="ref" href="#cha:user_microposts">Chapter&nbsp;10</a> and <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a> we&rsquo;ll add microblogging and social features to make a working example site.</p>

<p>The final sample application will bear more than a passing resemblance to a certain popular <a href="http://twitter.com/">social microblogging site</a>&mdash;a site which, coincidentally, was also originally written in Rails. Though of necessity our efforts will focus on this specific sample application, the emphasis throughout the <em>Rails Tutorial</em> will be on general principles, so that you will have a solid foundation no matter what kinds of web applications you want to build.</p>

<div class="label" id="sidebar:scaffolding"></div>


<div class="sidebar"><span class="title"><span class="header">Box 1.1.</span><span class="description">Scaffolding: Quicker, easier, more seductive</span></span>
<p>From the beginning, Rails has benefited from a palpable sense of excitement, starting with the famous <a href="http://media.rubyonrails.org/video/rails_take2_with_sound.mov">15-minute weblog video</a> by Rails creator David Heinemeier Hansson. That video and its successors are a great way to get a taste of Rails&rsquo; power, and I recommend watching them. But be warned: they accomplish their amazing fifteen-minute feat using a feature called <em>scaffolding</em>, which relies heavily on <em>generated code</em>, magically created by the Rails <code>generate</code> command.</p>

<p>When writing a Ruby on Rails tutorial, it is tempting to rely on the scaffolding approach&mdash;it&rsquo;s <a href="http://en.wikipedia.org/wiki/Dark_side_(Star_Wars)">quicker, easier, more seductive</a>. But the complexity and sheer amount of code in the scaffolding can be utterly overwhelming to a beginning Rails developer; you may be able to use it, but you probably won&rsquo;t understand it. Following the scaffolding approach risks turning you into a virtuoso script generator with little (and brittle) actual knowledge of Rails.</p>

<p>In the <em>Ruby on Rails Tutorial</em>, we&rsquo;ll take the (nearly) polar opposite approach: although <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a> will develop a small demo app using scaffolding, the core of the <em>Rails Tutorial</em> is the sample app, which we&rsquo;ll start writing in <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>. At each stage of developing the sample application, we will write <em>small, bite-sized</em> pieces of code&mdash;simple enough to understand, yet novel enough to be challenging. The cumulative effect will be a deeper, more flexible knowledge of Rails, giving you a good background for writing nearly any type of web application.</p>
</div>




<div class="label" id="sec:introduction"></div>


<h2><a id="sec:1.1" href="#sec:introduction" class="heading"><span class="number">1.1</span> Introduction</a></h2>


<p>Since its debut in 2004, Ruby on Rails has rapidly become one of the most powerful and popular frameworks for building dynamic web applications. Everyone from scrappy startups to huge companies have used Rails: <a href="http://37signals.com/">37signals</a>, <a href="http://github.com/">GitHub</a>, <a href="http://shopify.com/">Shopify</a>, <a href="http://scribd.com/">Scribd</a>,  <a href="http://twitter.com/">Twitter</a>, <a href="http://livingsocial.com/">LivingSocial</a>, <a href="http://groupon.com/">Groupon</a>, <a href="http://hulu.com/">Hulu</a>, the <a href="http://yellowpages.com/">Yellow Pages</a>&mdash;the <a href="http://rubyonrails.org/applications">list of sites using Rails</a> goes on and on. There are also many web development shops that specialize in Rails, such as <a href="http://entp.com/">ENTP</a>, <a href="http://thoughtbot.com/">thoughtbot</a>, <a href="http://pivotallabs.com/">Pivotal Labs</a>, and <a href="http://hashrocket.com/">Hashrocket</a>, plus innumerable independent consultants, trainers, and contractors.</p>

<p>What makes Rails so great? First of all, Ruby on Rails is 100% open-source, available under the permissive <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a>, and as a result it also costs nothing to download or use. Rails also owes much of its success to its elegant and compact design; by exploiting the malleability of the underlying <a href="http://ruby-lang.org/">Ruby</a> language, Rails effectively creates a <a href="http://en.wikipedia.org/wiki/Domain_Specific_Language">domain-specific language</a> for writing web applications. As a result, many common web programming tasks&mdash;such as generating HTML, making data models, and routing URIs&mdash;are easy with Rails, and the resulting application code is concise and readable.</p>

<p>Rails also adapts rapidly to new developments in web technology and framework design. For example, Rails was one of the first frameworks to fully digest and implement the REST architectural style for structuring web applications (which we&rsquo;ll be learning about throughout this tutorial). And when other frameworks develop successful new techniques, Rails creator <a href="http://loudthinking.com/">David Heinemeier Hansson</a> and the <a href="http://rubyonrails.org/core">Rails core team</a> don&rsquo;t hesitate to incorporate their ideas. Perhaps the most dramatic example is the merger of Rails and Merb, a rival Ruby web framework, so that Rails now benefits from Merb&rsquo;s modular design, stable <a href="http://en.wikipedia.org/wiki/Application_programming_interface">API</a>, and improved performance.</p>

<p>Finally, Rails benefits from an unusually enthusiastic and diverse community. The results include hundreds of open-source <a href="http://contributors.rubyonrails.org/">contributors</a>, well-attended <a href="http://railsconf.com/">conferences</a>, a huge number of <a href="http://agilewebdevelopment.com/plugins">plugins</a> and <a href="https://rubygems.org/">gems</a> (self-contained solutions to specific problems such as pagination and image upload), a rich variety of informative blogs, and a cornucopia of discussion forums and IRC channels. The large number of Rails programmers also makes it easier to handle the inevitable application errors: the &ldquo;Google the error message&rdquo; algorithm nearly always produces a relevant blog post or discussion-forum thread.</p>

<div class="label" id="sec:comments_for_various_readers"></div>


<h3><a id="sec:1.1.1" href="#sec:comments_for_various_readers" class="heading"><span class="number">1.1.1</span> Comments for various readers</a></h3>


<p>The <em>Rails Tutorial</em> contains integrated tutorials not only for Rails, but also for the underlying Ruby language, the RSpec testing framework, <a href="http://en.wikipedia.org/wiki/HTML">HTML</a>, <a href="http://en.wikipedia.org/wiki/CSS">CSS</a>, a small amount of <a href="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a>, and even a little <a href="http://en.wikipedia.org/wiki/SQL">SQL</a>. This means that, no matter where you currently are in your knowledge of web development, by the time you finish this tutorial you will be ready for more advanced Rails resources, as well as for the more systematic treatments of the other subjects mentioned. It also means that there&rsquo;s a <em>lot</em> of material to cover; if you don&rsquo;t already have much experience programming computers, you might find it overwhelming. The comments below contain some suggestions for approaching the <em>Rails Tutorial</em> depending on your background. <br /></p>

<p><strong>All readers:</strong> One common question when learning Rails is whether to learn Ruby first. The answer depends on your personal learning style and how much programming experience you already have. If you prefer to learn everything systematically from the ground up, or if you have never programmed before, then learning Ruby first might work well for you, and in this case I recommend <a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a> by Peter Cooper. On the other hand, many beginning Rails developers are excited about making <em>web</em> applications, and would rather not slog through a 500-page book on pure Ruby before ever writing a single web page. In this case, I recommend following the short interactive tutorial at <a href="http://tryruby.org/">Try Ruby</a>,<sup class="footnote" id="fnref:1.2"><a href="#fn:1.2">2</a></sup> and then optionally do the free tutorial at <a href="http://railsforzombies.org/">Rails for Zombies</a><sup class="footnote" id="fnref:1.3"><a href="#fn:1.3">3</a></sup> to get a taste of what Rails can do.</p>

<p>Another common question is whether to use tests from the start. As noted in the introduction, the <em>Rails Tutorial</em> uses test-driven development (also called test-first development), which in my view is the best way to develop Rails applications, but it does introduce a substantial amount of overhead and complexity. If you find yourself getting bogged down by the tests, I suggest either skipping them on a first reading or (even better) using them as a tool to verify your code&rsquo;s correctness without worrying about how they work. This latter strategy involves creating the necessary test files (called <em>specs</em>) and filling them with the test code <em>exactly</em> as it appears in the book. You can then run the test suite (as described in <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a>) to watch it fail, then write the application code as described in the tutorial, and finally re-run the test suite to watch it pass. <br /></p>

<p><strong>Inexperienced programmers:</strong> The <em>Rails Tutorial</em> is not aimed principally at beginning programmers, and web applications, even relatively simple ones, are by their nature fairly complex. If you are completely new to web programming and find the <em>Rails Tutorial</em> too difficult, I suggest learning the basics of HTML and CSS and then giving the <em>Rails Tutorial</em> another go. (Unfortunately, I don&rsquo;t have a personal recommendation here, but <a href="http://headfirstlabs.com/books/hfhtml/"><em>Head First HTML</em></a> looks promising, and one reader recommends <a href="http://www.amazon.com/gp/product/0596526873"><em>CSS: The Missing Manual</em></a> by David Sawyer McFarland.) You might also consider reading the first few chapters of <a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a> by Peter Cooper, which starts with sample applications much smaller than a full-blown web app. That said, a surprising number of beginners have used this tutorial to learn web development, so I suggest giving it a try, and I especially recommend the <a href="http://railstutorial.org/screencasts"><em>Rails Tutorial</em> screencast series</a><sup class="footnote" id="fnref:1.4"><a href="#fn:1.4">4</a></sup> to give you an &ldquo;over-the-shoulder&rdquo; look at Rails software development. <br /></p>

<p><strong>Experienced programmers new to web development:</strong> Your previous experience means you probably already understand ideas like classes, methods, data structures, etc., which is a big advantage. Be warned that if your background is in C/C++ or Java, you may find Ruby a bit of an odd duck, and it might take time to get used to it; just stick with it and eventually you&rsquo;ll be fine. (Ruby even lets you put semicolons at the ends of lines if you miss them too much.) The <em>Rails Tutorial</em> covers all the web-specific ideas you&rsquo;ll need, so don&rsquo;t worry if you don&rsquo;t currently know a <tt>PUT</tt> from a <tt>POST</tt>.<br /></p>

<p><strong>Experienced web developers new to Rails:</strong> You have a great head start, especially if you have used a dynamic language such as PHP or (even better) Python. The basics of what we cover will likely be familiar, but test-driven development may be new to you, as may be the structured REST style favored by Rails. Ruby has its own idiosyncrasies, so those will likely be new, too.<br /></p>

<p><strong>Experienced Ruby programmers:</strong> The set of Ruby programmers who don&rsquo;t know Rails is a small one nowadays, but if you are a member of this elite group you can fly through this book and then move on to <a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails&nbsp;3 Way</em></a> by Obie Fernandez. <br /></p>

<p><strong>Inexperienced Rails programmers:</strong> You&rsquo;ve perhaps read some other tutorials and made a few small Rails apps yourself. Based on reader feedback, I&rsquo;m confident that you can still get a lot out of this book. Among other things, the techniques here may be more up-to-date than the ones you picked up when you originally learned Rails. <br /></p>

<p><strong>Experienced Rails programmers:</strong> This book is unnecessary for you, but many experienced Rails developers have expressed surprise at how much they learned from this book, and you might enjoy seeing Rails from a different perspective. <br /></p>

<p>After finishing the <em>Ruby on Rails Tutorial</em>, I recommend that experienced programmers read <a href="http://www.amazon.com/gp/product/1933988657"><em>The Well-Grounded Rubyist</em></a> by David&nbsp;A. Black, which is an excellent in-depth discussion of Ruby from the ground up, or <a href="http://www.amazon.com/gp/product/0672328844"><em>The Ruby Way</em></a> by Hal Fulton, which is also fairly advanced but takes a more topical approach. Then move on to <a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails&nbsp;3 Way</em></a> to deepen your Rails expertise.<br /></p>

<p>At the end of this process, no matter where you started, you should be ready for the many more intermediate-to-advanced Rails resources out there. Here are some I particularly recommend:</p>

<ul>

<li><a href="http://railscasts.com/">RailsCasts</a> by Ryan Bates: Excellent (mostly) free Rails screencasts</li>
<li><a href="http://peepcode.com/">PeepCode</a>: Excellent commercial screencasts</li>
<li><a href="http://www.codeschool.com/">Code School</a>: Interactive programming courses</li>
<li><a href="http://guides.rubyonrails.org/">Rails Guides</a>: Good topical and up-to-date Rails references</li>
<li><a href="http://railscasts.com/">RailsCasts</a> by Ryan Bates: Did I already mention <a href="http://railscasts.com/">RailsCasts</a>? Seriously: <a href="http://railscasts.com/"><em>RailsCasts</em></a>.</li>


</ul>




<h3><a id="sec:1.1.2" href="#sec:1.1.2" class="heading"><span class="number">1.1.2</span> &ldquo;Scaling&rdquo; Rails</a></h3>


<p>Before moving on with the rest of the introduction, I&rsquo;d like to take a moment to address the one issue that dogged the Rails framework the most in its early days: the supposed inability of Rails to &ldquo;scale&rdquo;&mdash;i.e., to handle large amounts of traffic. Part of this issue relied on a misconception; <a href="http://idleprocess.wordpress.com/2009/11/24/presentation-summary-high-performance-at-massive-scale-lessons-learned-at-facebook/">you scale a <em>site</em>, not a framework</a>, and Rails, as awesome as it is, is only a framework. So the real question should have been, &ldquo;Can a site built with Rails scale?&rdquo; In any case, the question has now been definitively answered in the affirmative: some of the most heavily trafficked sites in the world use Rails. Actually <em>doing</em> the scaling is beyond the scope of just Rails, but rest assured that if <em>your</em> application ever needs to handle the load of Hulu or the Yellow Pages, Rails won&rsquo;t stop you from taking over the world.</p>

<div class="label" id="sec:conventions"></div>


<h3><a id="sec:1.1.3" href="#sec:conventions" class="heading"><span class="number">1.1.3</span> Conventions in this book</a></h3>


<p>The conventions in this book are mostly self-explanatory. In this section, I&rsquo;ll mention some that may not be.</p>

<p>Both the <a href="http://railstutorial.org/book">HTML</a> and <a href="http://railstutorial.org/">PDF</a> editions of this book are full of links, both to internal sections (such as <a class="ref" href="#sec:up_and_running">Section&nbsp;1.2</a>) and to external sites (such as the main <a href="http://rubyonrails.org/download">Ruby on Rails download</a> page).<sup class="footnote" id="fnref:1.5"><a href="#fn:1.5">5</a></sup></p>

<p>Many examples in this book use command-line commands. For simplicity, all command line examples use a Unix-style command line prompt (a dollar sign), as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">echo</span> <span class="s2">&quot;hello, world&quot;</span>
<span class="go">hello, world</span>
</pre></div>
</div>


<p>Windows users should understand that their systems will use the analogous angle prompt&nbsp;<code>&gt;</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">C:\Sites&gt; echo &quot;hello, world&quot;</span>
<span class="go">hello, world</span>
</pre></div>
</div>


<p>On Unix systems, some commands should be executed with <code>sudo</code>, which stands for &ldquo;substitute user do&rdquo;. By default, a command executed with <code>sudo</code> is run as an administrative user, which has access to files and directories that normal users can&rsquo;t touch, such as in this example from <a class="ref" href="#sec:rubygems">Section&nbsp;1.2.2</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo ruby setup.rb
</pre></div>
</div>


<p>Most Unix/Linux/OS&nbsp;X systems require <code>sudo</code> by default, unless you are using Ruby Version Manager as suggested in <a class="ref" href="#sec:install_ruby">Section&nbsp;1.2.2.3</a>; in this case, you would type this instead:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby setup.rb
</pre></div>
</div>


<p>Rails comes with lots of commands that can be run at the command line. For example, in <a class="ref" href="#sec:rails_server">Section&nbsp;1.2.5</a> we&rsquo;ll run a local development web server as follows:</p>

<div class="code"><div class="highlight"><pre><span class="nv">$ </span>rails server
</pre></div>
</div>


<p>As with the command-line prompt, the <em>Rails Tutorial</em> uses the Unix convention for directory separators (i.e., a forward slash&nbsp;<code>/</code>). My Rails Tutorial sample application, for instance, lives in</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app
</pre></div>
</div>


<p>On Windows, the analogous directory would be</p>

<div class="code"><div class="highlight"><pre>C:\Sites\sample_app
</pre></div>
</div>


<p>The root directory for any given app is known as the <em>Rails root</em>, but this terminology is confusing and many people mistakenly believe that the &ldquo;Rails root&rdquo; is the root directory for Rails itself. For clarity, the <em>Rails Tutorial</em> will refer to the Rails root as the <em>application root</em>, and henceforth all directories will be relative to this directory. For example, the <code>config</code> directory of my sample application is</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app/config
</pre></div>
</div>


<p>The application root directory here is everything before <code>config</code>, i.e.,</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app
</pre></div>
</div>


<p>For brevity, when referring to the file</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app/config/routes.rb
</pre></div>
</div>


<p>I&rsquo;ll omit the application root and simply write <code>config/routes.rb</code>.</p>

<p>The <em>Rails Tutorial</em> often shows output from various programs (shell commands, version control status, Ruby programs, etc.). Because of the innumerable small differences between different computer systems, the output you see may not always agree exactly with what is shown in the text,
but this is not cause for concern.</p>

<p>Some commands may produce errors depending on your system; rather than attempt the <a href="http://en.wikipedia.org/wiki/Sisyphus">Sisyphean</a> task of documenting all such errors in this tutorial, I will delegate to the &ldquo;Google the error message&rdquo; algorithm, which among other things is good practice for real-life software development. If you run into any problems while following the tutorial, I suggest consulting the resources listed on the <a href="http://railstutorial.org/help">Rails Tutorial help page</a>.<sup class="footnote" id="fnref:1.6"><a href="#fn:1.6">6</a></sup></p>

<div class="label" id="sec:up_and_running"></div>


<h2><a id="sec:1.2" href="#sec:up_and_running" class="heading"><span class="number">1.2</span> Up and running</a></h2>




<blockquote><p>I think of Chapter 1 as the &ldquo;weeding out phase&rdquo; in law school&mdash;if you can get your dev environment set up, the rest is easy to get through. <br />
&mdash;Bob Cavezza, <em>Rails Tutorial</em> reader</p>
</blockquote>


<p>It&rsquo;s time now to get going with a Ruby on Rails development environment and our first application. There is quite a bit of overhead here, especially if you don&rsquo;t have extensive programming experience, so don&rsquo;t get discouraged if it takes a while to get started. It&rsquo;s not just you; every developer goes through it (often more than once), but rest assured that the effort will be richly rewarded.</p>

<div class="label" id="sec:development_tools"></div>


<h3><a id="sec:1.2.1" href="#sec:development_tools" class="heading"><span class="number">1.2.1</span> Development environments</a></h3>


<p>Considering various idiosyncratic customizations, there are probably as many development environments as there are Rails programmers, but there are at least two broad types: text editor/command line environments, and integrated development environments (IDEs). Let&rsquo;s consider the latter first.</p>

<h4><a id="sec:1.2.1.1" href="#sec:1.2.1.1" class="heading">IDEs</a></h4>


<p>There is no shortage of Rails IDEs, including <a href="http://www.aptana.com/rails/">RadRails</a>, <a href="http://www.jetbrains.com/ruby/index.html">RubyMine</a>, and <a href="http://www.codegear.com/products/3rdrail">3rd Rail</a>. I&rsquo;ve heard especially good things about RubyMine, and one reader (David Loeffler) has assembled <a href="https://github.com/perfectionist/sample_project/wiki">notes on how to use RubyMine with this tutorial</a>.<sup class="footnote" id="fnref:1.7"><a href="#fn:1.7">7</a></sup> If you&rsquo;re comfortable using an IDE, I suggest taking a look at the options mentioned to see what fits with the way you work.</p>

<h4><a id="sec:1.2.1.2" href="#sec:1.2.1.2" class="heading">Text editors and command lines</a></h4>


<p>Instead of using an IDE, I prefer to use a <em>text editor</em> to edit text, and a <em>command line</em> to issue commands (<a class="ref" href="#fig:editor_shell">Figure&nbsp;1.1</a>). Which combination you use depends on your tastes and your platform.</p>

<ul>
<li><strong>Text editor:</strong> I recommend <a href="http://www.sublimetext.com/2">Sublime Text&nbsp;2</a>, an outstanding cross-platform text editor that is in beta as of this writing but has already proven to be exceptionally powerful. Sublime Text is heavily influenced by <a href="http://macromates.com">TextMate</a>, and in fact is compatible with most TextMate customizations, such as snippets and color schemes. (TextMate, which is available only on OS&nbsp;X, is still a good choice if you use a Mac.) A second excellent choice is <a href="http://www.vim.org/">Vim</a>,<sup class="footnote" id="fnref:1.8"><a href="#fn:1.8">8</a></sup> versions of which are available for all major platforms. Sublime Text can be obtained commercially, whereas Vim can be obtained at no cost; both are industrial-strength editors, but in my experience Sublime Text is <em>much</em> more accessible to beginners. </li>

<li><strong>Terminal:</strong> On OS&nbsp;X, I recommend either use <a href="http://iterm.sourceforge.net/">iTerm</a> or the native Terminal app. On Linux, the default terminal is fine. On Windows, many users prefer to develop Rails applications in a virtual machine running Linux, in which case your command-line options reduce to the previous case. If developing within Windows itself, I recommend using the command prompt that comes with <a href="http://railsinstaller.org/">Rails Installer</a> (<a class="ref" href="#sec:rails_installer_windows">Section&nbsp;1.2.2.1</a>). </li>
</ul>


<p>If you decide to use Sublime Text, you want to follow the setup instructions for <a href="https://github.com/mhartl/rails_tutorial_sublime_text">Rails Tutorial Sublime Text</a>.<sup class="footnote" id="fnref:1.9"><a href="#fn:1.9">9</a></sup> <em>Note</em>: Such configuration settings are fiddly and error-prone, so this step should only be attempted by advanced users.</p>

<div class="label" id="fig:editor_shell"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/editor_shell.png" alt="editor_shell" /></span></div><div class="caption"><span class="header">Figure 1.1: </span><span class="description">A text editor/command line development environment (TextMate/iTerm).  <a href="http://railstutorial.org/images/figures/editor_shell-full.png">(full size)</a></span></div></div>




<h4><a id="sec:1.2.1.3" href="#sec:1.2.1.3" class="heading">Browsers</a></h4>


<p>Although there are many web browsers to choose from, the vast majority of Rails programmers use Firefox, Safari, or Chrome when developing. The screenshots in Rails Tutorial will generally be of a Firefox browser. If you use Firefox, I suggest using the <a href="http://getfirebug.com/">Firebug</a> add-on, which lets you perform all sorts of magic, such as dynamically inspecting (and even editing) the HTML structure and CSS rules on any page. For those not using Firefox, both Safari and Chrome have a built-in &ldquo;Inspect element&rdquo; feature available by right-clicking on any part of the page.</p>

<h4><a id="sec:1.2.1.4" href="#sec:1.2.1.4" class="heading">A note about tools</a></h4>


<p>In the process of getting your development environment up and running, you may find that you spend a <em>lot</em> of time getting everything just right. The learning process for editors and IDEs is particularly long; you can spend weeks on Sublime Text or Vim tutorials alone. If you&rsquo;re new to this game, I want to assure you that <em>spending time learning tools is normal</em>. Everyone goes through it. Sometimes it is frustrating, and it&rsquo;s easy to get impatient when you have an awesome web app in your head and you <em>just want to learn Rails already</em>, but have to spend a week learning some weird ancient Unix editor just to get started. But a craftsman has to know his tools, and in the end the reward is worth the effort.</p>

<div class="label" id="sec:rubygems"></div>


<h3><a id="sec:1.2.2" href="#sec:rubygems" class="heading"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, and Git</a></h3>




<blockquote><p>Practically all the software
in the world is either broken or very difficult to use. So users dread software. They&rsquo;ve been trained that whenever they try to install something, or even fill out a form online, it&rsquo;s not going to work. <em>I</em> dread installing stuff, and I have a Ph.D. in computer science.</p>

<br />


<p>&mdash;Paul Graham, <em>Founders at Work</em></p>
</blockquote>


<p>Now it&rsquo;s time to install Ruby and Rails. I&rsquo;ve done my best to cover as many bases as possible, but systems vary, and many things can go wrong during these steps. Be sure to Google the error message or consult the <a href="http://railstutorial.org/help">Rails Tutorial help page</a> if you run into trouble.</p>

<p><strong>Unless otherwise noted, you should use the exact versions of all software used in the tutorial, including Rails itself, if you want the same results.</strong> Sometimes minor version differences will yield identical results, but you shouldn&rsquo;t count on this, especially with respect to Rails versions. The main exception is Ruby itself: 1.9.2 and 1.9.3 are virtually identical for the purposes of this tutorial, so feel free to use either one.</p>

<div class="label" id="sec:rails_installer_windows"></div>


<h4><a id="sec:1.2.2.1" href="#sec:rails_installer_windows" class="heading">Rails Installer (Windows)</a></h4>


<p>Installing Rails on Windows used to be a real pain, but thanks to the efforts of the good people at <a href="http://engineyard.com/">Engine Yard</a>&mdash;especially Dr.&nbsp;Nic Williams and Wayne&nbsp;E. Seguin&mdash;installing Rails and related software on Windows is now easy. If you are using Windows, go to <a href="http://railsinstaller.org/">Rails Installer</a> and download the Rails Installer executable and view the excellent installation video. Double-click the executable and follow the instructions to install Git (so you can skip <a class="ref" href="#sec:install_git">Section&nbsp;1.2.2.2</a>), Ruby (skip <a class="ref" href="#sec:install_ruby">Section&nbsp;1.2.2.3</a>), RubyGems (skip <a class="ref" href="#sec:install_rubygems">Section&nbsp;1.2.2.4</a>), and Rails itself (skip <a class="ref" href="#sec:install_rails">Section&nbsp;1.2.2.5</a>). Once the installation has finished, you can skip right to the creation of the first application in <a class="ref" href="#sec:the_first_application">Section&nbsp;1.2.3</a>.</p>

<p>Bear in mind that the Rails Installer might use a slightly different version of Rails from the one installed in <a class="ref" href="#sec:install_rails">Section&nbsp;1.2.2.5</a>, which might cause incompatibilities. To fix this, I am currently working with Nic and Wayne to create a list of Rails Installers ordered by Rails version number.</p>

<div class="label" id="sec:install_git"></div>


<h4><a id="sec:1.2.2.2" href="#sec:install_git" class="heading">Install Git</a></h4>


<p>Much of the Rails ecosystem depends in one way or another on a <a href="http://en.wikipedia.org/wiki/Revision_control">version control system</a> called <a href="http://git-scm.com/">Git</a> (covered in more detail in <a class="ref" href="#sec:version_control">Section&nbsp;1.3</a>). Because its use is ubiquitous, you should install Git even at this early stage; I suggest following the installation instructions for your platform at the <a href="http://progit.org/book/ch1-4.html">Installing Git section of <em>Pro Git</em></a>.</p>

<div class="label" id="sec:install_ruby"></div>


<h4><a id="sec:1.2.2.3" href="#sec:install_ruby" class="heading">Install Ruby</a></h4>


<p>The next step is to install Ruby. It&rsquo;s possible that your system already has it; try running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby -v
<span class="go">ruby 1.9.3</span>
</pre></div>
</div>


<p>to see the version number. Rails&nbsp;3 requires Ruby&nbsp;1.8.7 or later and works best with Ruby&nbsp;1.9.x. This tutorial assumes that most readers are using Ruby&nbsp;1.9.2 or 1.9.3, but Ruby&nbsp;1.8.7 should work as well (although there is one syntax difference, covered in <a class="ref" href="#cha:rails_flavored_ruby">Chapter&nbsp;4</a>, and assorted minor differences in output).</p>

<p>As part of installing Ruby, if you are using OS&nbsp;X or Linux I strongly recommend using <a href="http://rvm.io/">Ruby Version Manager (RVM)</a>, which allows you to install and manage multiple versions of Ruby on the same machine. (The <a href="http://github.com/vertiginous/pik">Pik</a> project accomplishes a similar feat on Windows.) This is particularly important if you want to run different versions of Ruby or Rails on the same machine. If you run into any problems with RVM, you can often find its creator, Wayne&nbsp;E. Seguin, on the RVM IRC channel (<a href="http://webchat.freenode.net/?channels=rvm">#rvm on freenode.net</a>).<sup class="footnote" id="fnref:1.10"><a href="#fn:1.10">10</a></sup> If you are running Linux, I particularly recommend <a href="http://blog.sudobits.com/2012/05/02/how-to-install-ruby-on-rails-in-ubuntu-12-04-lts/">How to install Ruby on Rails in Ubuntu on the Sudobits Blog</a>.</p>

<p>After <a href="http://rvm.io/rvm/install/">installing RVM</a>, you can install Ruby as follows:<sup class="footnote" id="fnref:1.11"><a href="#fn:1.11">11</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get head <span class="o">&amp;&amp;</span> rvm reload
<span class="gp">$</span> rvm install 1.9.3
<span class="go">&lt;wait a while&gt;</span>
</pre></div>
</div>


<p>Here the first command updates and reloads RVM itself, which is a good practice since RVM gets updated frequently. The second installs the 1.9.3 version of Ruby; depending on your system, they might take a while to download and compile, so don&rsquo;t worry if it seems to be taking forever.</p>

<p><em>Note</em>: I&rsquo;ve had reports of incompatibilities between RVM and the latest version of Xcode on Mac OS&nbsp;X. I&rsquo;m monitoring the situation and will include an update once the situation stabilizes. For now, you&rsquo;ll have to rely on web searches for the latest workaround. (I apologize for the inconvenience, but in my experience this sort of thing happens all the time when developing software.)</p>

<p>Some Linux users report having to include the path to a library called OpenSSL:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm install 1.9.3 --with-openssl-dir<span class="o">=</span><span class="nv">$HOME</span>/.rvm/
</pre></div>
</div>


<p>On some older OS&nbsp;X systems, you might have to include the path to the readline library:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm install 1.9.3 --with-readline-dir<span class="o">=</span>/opt/local
</pre></div>
</div>


<p>(Like I said, lots of things can go wrong. The only solution is web searches and determination.)</p>

<p>After installing Ruby, you should configure your system for the other software needed to run Rails applications. This typically involves installing <em>gems</em>, which are self-contained packages of Ruby code. Since gems with different version numbers sometimes conflict, it is often convenient to create separate <em>gemsets</em>, which are self-contained bundles of gems. For the purposes of this tutorial, I suggest creating a gemset called <code>rails3tutorial2ndEd</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm use 1.9.3@rails3tutorial2ndEd --create --default
<span class="go">Using /Users/mhartl/.rvm/gems/ruby-1.9.3 with gemset rails3tutorial2ndEd</span>
</pre></div>
</div>


<p>This command creates (<tt class="verb">--create</tt>) the gemset <code>rails3tutorial2ndEd</code> associated with Ruby&nbsp;1.9.3 while arranging to start using it immediately (<tt class="verb">use</tt>) and setting it as the default (<tt class="verb">--default</tt>) gemset, so that any time we open a new terminal window the <code>1.9.3@rails3tutorial2ndEd</code> Ruby/gemset combination is automatically selected. RVM supports a large variety of commands for manipulating gemsets; see the documentation at <a href="http://rvm.io/gemsets/">http://rvm.beginrescueend.com/gemsets/</a>. If you ever get stuck with RVM, running commands like these should help you get your bearings:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm --help
<span class="gp">$</span> rvm gemset --help
</pre></div>
</div>


<div class="label" id="sec:install_rubygems"></div>


<h4><a id="sec:1.2.2.4" href="#sec:install_rubygems" class="heading">Install RubyGems</a></h4>


<p>RubyGems is a package manager for Ruby projects, and there are many useful libraries (including Rails) available as Ruby packages, or <em>gems</em>. Installing RubyGems should be easy once you install Ruby. In fact, if you have <a href="http://rvm.io/rvm/install/">installed RVM</a>, you already have RubyGems, since RVM includes it automatically:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> which gem
<span class="go">/Users/mhartl/.rvm/rubies/ruby-1.9.3-p0/bin/gem</span>
</pre></div>
</div>


<p>If you don&rsquo;t already have it, you should <a href="http://rubyforge.org/frs/?group_id=126">download RubyGems</a>, extract it, and then go to the <code>rubygems</code> directory and run the setup program:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby setup.rb
</pre></div>
</div>


<p>(If you get a permissions error here, recall from <a class="ref" href="#sec:conventions">Section&nbsp;1.1.3</a> that you may have to use <code>sudo</code>.)</p>

<p>If you already have RubyGems installed, you should make sure your system uses the version used in this tutorial:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem update --system 1.8.24
</pre></div>
</div>


<p>Freezing your system to this particular version will help prevent conflicts as RubyGems changes in the future.</p>

<p>When installing gems, by default RubyGems generates two different kinds of documentation (called ri and rdoc), but many Ruby and Rails developers find that the time to build them isn&rsquo;t worth the benefit. (Many programmers rely on online documentation instead of the native ri and rdoc documents.) To prevent the automatic generation of the documentation, I recommend making a gem configuration file called <code>.gemrc</code> in your home directory as in <a class="ref" href="#code:create_gemrc">Listing&nbsp;1.1</a> with the line in <a class="ref" href="#code:gemrc">Listing&nbsp;1.2</a>. (The tilde&nbsp;&ldquo;<tt class="verb">~</tt>&rdquo; means &ldquo;home directory&rdquo;, while the dot&nbsp;<tt class="verb">.</tt> in <code>.gemrc</code> makes the file hidden, which is a common convention for configuration files. )</p>

<div class="label" id="code:create_gemrc"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.1.</span> <span class="description">Creating a gem configuration file.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl ~/.gemrc
</pre></div>
</div></div>


<p>Here <code>subl</code> is the command-line command to launch Sublime Text on OS&nbsp;X, which you can set up using the <a href="http://www.sublimetext.com/docs/2/osx_command_line.html">Sublime Text&nbsp;2 documentation for the OS&nbsp;X command line</a>. If you&rsquo;re on a different platform, or if you&rsquo;re using a different editor, you should replace this command as necessary (i.e., by double-clicking the application icon or by using an alternate command such as <code>mate</code>, <code>vim</code>, <code>gvim</code>, or <code>mvim</code>). For brevity, throughout the rest of this tutorial I&rsquo;ll use <code>subl</code> as a shorthand for &ldquo;open with your favorite text editor.&rdquo;</p>

<div class="label" id="code:gemrc"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.2.</span> <span class="description">Suppressing the ri and rdoc documentation in <code>.gemrc</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">install:</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span>
<span class="ss">update:</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span>
</pre></div>
</div></div>




<div class="label" id="sec:install_rails"></div>


<h4><a id="sec:1.2.2.5" href="#sec:install_rails" class="heading">Install Rails</a></h4>


<p>Once you&rsquo;ve installed RubyGems, installing Rails should be easy. This tutorial standardizes on Rails&nbsp;3.2, which we can install as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem install rails -v 3.2.7
</pre></div>
</div>


<p>To check your Rails installation, run the following command to print out the version number:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails -v
<span class="go">Rails 3.2.7</span>
</pre></div>
</div>


<p><em>Note:</em> If you installed Rails using the Rails Installer in <a class="ref" href="#sec:rails_installer_windows">Section&nbsp;1.2.2.1</a>, there might be slight version differences. As of this writing, those differences are not relevant, but in the future, as the current Rails version diverges from the one used in this tutorial, these differences may become significant. I am currently working with Engine Yard to create links to specific versions of the Rails Installer.</p>

<p>If you&rsquo;re running Linux, you might have to install a couple of other packages at this point:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo apt-get install libxslt-dev libxml2-dev libsqlite3-dev <span class="c"># Linux only</span>
</pre></div>
</div>




<div class="label" id="sec:the_first_application"></div>


<h3><a id="sec:1.2.3" href="#sec:the_first_application" class="heading"><span class="number">1.2.3</span> The first application</a></h3>


<p>Virtually all Rails applications start the same way, with the <code>rails</code> command. This handy program creates a skeleton Rails application in a directory of your choice. To get started, make a directory for your Rails projects and then run the <code>rails</code> command to make the first application (<a class="ref" href="#code:rails_command">Listing&nbsp;1.3</a>):</p>

<div class="label" id="code:rails_command"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.3.</span> <span class="description">Running <code>rails</code> to generate a new application.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mkdir rails_projects
<span class="gp">$</span> <span class="nb">cd </span>rails_projects
<span class="gp">$</span> rails new first_app
<span class="go">      create  </span>
<span class="go">      create  README.rdoc</span>
<span class="go">      create  Rakefile</span>
<span class="go">      create  config.ru</span>
<span class="go">      create  .gitignore</span>
<span class="go">      create  Gemfile</span>
<span class="go">      create  app</span>
<span class="go">      create  app/assets/images/rails.png</span>
<span class="go">      create  app/assets/javascripts/application.js</span>
<span class="go">      create  app/assets/stylesheets/application.css</span>
<span class="go">      create  app/controllers/application_controller.rb</span>
<span class="go">      create  app/helpers/application_helper.rb</span>
<span class="go">      create  app/mailers</span>
<span class="go">      create  app/models</span>
<span class="go">      create  app/views/layouts/application.html.erb</span>
<span class="go">      create  app/mailers/.gitkeep</span>
<span class="go">      create  app/models/.gitkeep</span>
<span class="go">      create  config</span>
<span class="go">      create  config/routes.rb</span>
<span class="go">      create  config/application.rb</span>
<span class="go">      create  config/environment.rb</span>
<span class="go">      .</span>
<span class="go">      .</span>
<span class="go">      .</span>
<span class="go">      create  vendor/plugins</span>
<span class="go">      create  vendor/plugins/.gitkeep</span>
<span class="go">         run  bundle install</span>
<span class="go">Fetching source index for https://rubygems.org/</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">Your bundle is complete! Use `bundle show [gemname]` to see where a bundled</span>
<span class="go">gem is installed.</span>
</pre></div>
</div></div>


<p>As seen at the end of <a class="ref" href="#code:rails_command">Listing&nbsp;1.3</a>, running <code>rails</code> automatically runs the <code>bundle install</code> command after the file creation is done. If that step doesn&rsquo;t work right now, don&rsquo;t worry; follow the steps in <a class="ref" href="#sec:bundler">Section&nbsp;1.2.4</a> and you should be able to get it to work.</p>

<p>Notice how many files and directories the <code>rails</code> command creates. This standard directory and file structure (<a class="ref" href="#fig:directory_structure_rails_3_2">Figure&nbsp;1.2</a>) is one of the many advantages of Rails; it immediately gets you from zero to a functional (if minimal) application. Moreover, since the structure is common to all Rails apps, you can immediately get your bearings when looking at someone else&rsquo;s code. A summary of the default Rails files appears in <a class="ref" href="#table:rails_directory_structure">Table&nbsp;1.1</a>; we&rsquo;ll learn about most of these files and directories throughout the rest of this book. In particular, starting in <a class="ref" href="#sec:the_asset_pipeline">Section&nbsp;5.2.1</a> we&rsquo;ll discuss the <code>app/assets</code> directory, part of the <em>asset pipeline</em> (new as of Rails&nbsp;3.1) that makes it easier than ever to organize and deploy assets such as cascading style sheets and JavaScript files.</p>

<div class="label" id="fig:directory_structure_rails_3_2"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/directory_structure_rails_31.png" alt="directory_structure_rails_31" /></span></div><div class="caption"><span class="header">Figure 1.2: </span><span class="description">The directory structure for a newly hatched Rails app.&nbsp;<a href="http://railstutorial.org/images/figures/directory_structure_rails_31-full.png">(full size)</a></span></div></div>




<div class="label" id="table:rails_directory_structure"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>File/Directory</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><code>app/</code></td><td class="align_left">Core application (app) code, including models, views, controllers, and helpers</td></tr><tr><td class="align_left"><code>app/assets</code></td><td class="align_left">Applications assets such as cascading style sheets (CSS), JavaScript files, and images</td></tr><tr><td class="align_left"><code>config/</code></td><td class="align_left">Application configuration</td></tr><tr><td class="align_left"><code>db/</code></td><td class="align_left">Database files</td></tr><tr><td class="align_left"><code>doc/</code></td><td class="align_left">Documentation for the application</td></tr><tr><td class="align_left"><code>lib/</code></td><td class="align_left">Library modules</td></tr><tr><td class="align_left"><code>lib/assets</code></td><td class="align_left">Library assets such as cascading style sheets (CSS), JavaScript files, and images</td></tr><tr><td class="align_left"><code>log/</code></td><td class="align_left">Application log files</td></tr><tr><td class="align_left"><code>public/</code></td><td class="align_left">Data accessible to the public (e.g., web browsers), such as error pages</td></tr><tr><td class="align_left"><code>script/rails</code></td><td class="align_left">A script for generating code, opening console sessions, or starting a local server</td></tr><tr><td class="align_left"><code>test/</code></td><td class="align_left">Application tests (made obsolete by the <code>spec/</code> directory in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a>)</td></tr><tr><td class="align_left"><code>tmp/</code></td><td class="align_left">Temporary files</td></tr><tr><td class="align_left"><code>vendor/</code></td><td class="align_left">Third-party code such as plugins and gems</td></tr><tr><td class="align_left"><code>vendor/assets</code></td><td class="align_left">Third-party assets such as cascading style sheets (CSS), JavaScript files, and images</td></tr><tr><td class="align_left"><code>README.rdoc</code></td><td class="align_left">A brief description of the application</td></tr><tr><td class="align_left"><code>Rakefile</code></td><td class="align_left">Utility tasks available via the <code>rake</code> command</td></tr><tr><td class="align_left"><code>Gemfile</code></td><td class="align_left">Gem requirements for this app</td></tr><tr><td class="align_left"><code>Gemfile.lock</code></td><td class="align_left">A list of gems used to ensure that all copies of the app use the same gem versions</td></tr><tr><td class="align_left"><code>config.ru</code></td><td class="align_left">A configuration file for <a href="http://rack.rubyforge.org/doc/">Rack middleware</a></td></tr><tr><td class="align_left"><code>.gitignore</code></td><td class="align_left">Patterns for files that should be ignored by Git</td></tr></table></div><div class="caption"><span class="header">Table 1.1: </span><span class="description">A summary of the default Rails directory structure.</span></div></div>




<div class="label" id="sec:bundler"></div>


<h3><a id="sec:1.2.4" href="#sec:bundler" class="heading"><span class="number">1.2.4</span> Bundler</a></h3>


<p>After creating a new Rails application, the next step is to use <em>Bundler</em> to install and include the gems needed by the app. As noted briefly in <a class="ref" href="#sec:the_first_application">Section&nbsp;1.2.3</a>, Bundler is run automatically (via <code>bundle install</code>) by the <code>rails</code> command, but in this section we&rsquo;ll make some changes to the default application gems and run Bundler again. This involves opening the <code>Gemfile</code> with your favorite text editor:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd </span>first_app/
<span class="gp">$</span> subl Gemfile
</pre></div>
</div>


<p>The result should look something like <a class="ref" href="#code:default_gemfile">Listing&nbsp;1.4</a>. The code in this file is Ruby, but don&rsquo;t worry at this point about the syntax; <a class="ref" href="#cha:rails_flavored_ruby">Chapter&nbsp;4</a> will cover Ruby in more depth.</p>

<div class="label" id="code:default_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.4.</span> <span class="description">The default <code>Gemfile</code> in the <code>first_app</code> directory.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>

<span class="c1"># Bundle edge Rails instead:</span>
<span class="c1"># gem &#39;rails&#39;, :git =&gt; &#39;git://github.com/rails/rails.git&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span>


<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.2&#39;</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span>

<span class="c1"># To use ActiveModel has_secure_password</span>
<span class="c1"># gem &#39;bcrypt-ruby&#39;, &#39;~&gt; 3.0.0&#39;</span>

<span class="c1"># To use Jbuilder templates for JSON</span>
<span class="c1"># gem &#39;jbuilder&#39;</span>

<span class="c1"># Use unicorn as the web server</span>
<span class="c1"># gem &#39;unicorn&#39;</span>

<span class="c1"># Deploy with Capistrano</span>
<span class="c1"># gem &#39;capistrano&#39;</span>

<span class="c1"># To use debugger</span>
<span class="c1"># gem &#39;ruby-debug19&#39;, :require =&gt; &#39;ruby-debug&#39;</span>
</pre></div>
</div></div>


<p>Many of these lines are commented out with the hash symbol&nbsp;<code>#</code>; they are there to show you some commonly needed gems and to give examples of the Bundler syntax. For now, we won&rsquo;t need any gems other than the defaults: Rails itself, some gems related to the asset pipeline (<a class="ref" href="#sec:the_asset_pipeline">Section&nbsp;5.2.1</a>), the gem for the jQuery JavaScript library, and the gem for the Ruby interface to the <a href="http://www.sqlite.org/">SQLite database</a>.</p>

<p>Unless you specify a version number to the <code>gem</code> command, Bundler will automatically install the latest version of the gem. Unfortunately, gem updates often cause minor but potentially confusing breakage, so in this tutorial we&rsquo;ll include explicit version numbers known to work, as seen in <a class="ref" href="#code:gemfile_sqlite_version">Listing&nbsp;1.5</a> (which also omits the commented-out lines from <a class="ref" href="#code:default_gemfile">Listing&nbsp;1.4</a>).</p>

<div class="label" id="code:gemfile_sqlite_version"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.5.</span> <span class="description">A <code>Gemfile</code> with an explicit version of each Ruby gem.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>


<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:gemfile_sqlite_version">Listing&nbsp;1.5</a> changes the line for jQuery, the default JavaScript library used by Rails, from</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>
</pre></div>
</div>


<p>We&rsquo;ve also changed</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>which forces Bundler to install version <code>1.3.5</code> of the <code>sqlite3</code> gem. Note that we&rsquo;ve also taken this opportunity to arrange for SQLite to be included only in a development environment (<a class="ref" href="#sec:rails_environments">Section&nbsp;7.1.1</a>), which prevents potential conflicts with the database used by Heroku (<a class="ref" href="#sec:deploying">Section&nbsp;1.4</a>).</p>

<p><a class="ref" href="#code:gemfile_sqlite_version">Listing&nbsp;1.5</a> also changes a few other lines, converting</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.2.3&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The syntax</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.2.3&#39;</span>
</pre></div>
</div>


<p>installs the latest version of the <code>uglifier</code> gem (which handles file compression for the asset pipeline) as long as it&rsquo;s greater than version&nbsp;<code>1.2.3</code>&mdash;even if it&rsquo;s, say, version&nbsp;<code>7.2</code>. Meanwhile, the code</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.2&#39;</span>
</pre></div>
</div>


<p>installs the gem <code>coffee-rails</code> (also needed by the asset pipeline) as long as it&rsquo;s lower than version&nbsp;<code>3.3</code>. In other words, the <tt class="verb">&gt;=</tt> notation always performs upgrades, whereas the <tt class="verb">~&gt; 3.2.2</tt> notation only performs upgrades to minor point releases (e.g., from <code>3.1.1</code> to <code>3.1.2</code>), but not to major point releases (e.g., from <code>3.1</code> to <code>3.2</code>). Unfortunately, experience shows that even minor point releases often break things, so for the <em>Rails Tutorial</em> we&rsquo;ll err on the side of caution by including exact version numbers for virtually all gems. (The only exception is gems that are in release candidate or beta stage as of this writing; for those gems, we&rsquo;ll use <tt class="verb">~&gt;</tt> so that the final versions will be loaded once they&rsquo;re done.)</p>

<p>Once you&rsquo;ve assembled the proper <code>Gemfile</code>, install the gems using <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
<span class="go">Fetching source index for https://rubygems.org/</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div>
</div>


<p>(If you&rsquo;re running OS&nbsp;X and you get an error about missing Ruby header files (e.g., <code>ruby.h</code>) at this point, you may need to install Xcode. These are developer tools that came with your OS&nbsp;X installation disk, but to avoid the full installation I recommend the much smaller <a href="https://developer.apple.com/downloads/">Command Line Tools for Xcode</a>.<sup class="footnote" id="fnref:1.12"><a href="#fn:1.12">12</a></sup>) The <code>bundle install</code> command might take a few moments, but when it&rsquo;s done our application will be ready to run. <em>Note:</em> This setup is fine for the first app, but it isn&rsquo;t ideal. <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a> covers a more powerful (and slightly more advanced) method for installing Ruby gems with Bundler.</p>

<div class="label" id="sec:rails_server"></div>


<h3><a id="sec:1.2.5" href="#sec:rails_server" class="heading"><span class="number">1.2.5</span> <tt>rails server</tt></a></h3>


<p>Thanks to running <code>rails new</code> in <a class="ref" href="#sec:the_first_application">Section&nbsp;1.2.3</a> and <code>bundle install</code> in <a class="ref" href="#sec:bundler">Section&nbsp;1.2.4</a>, we already have an application we can run&mdash;but how? Happily, Rails comes with a command-line program, or <em>script</em>, that runs a <em>local</em> web server, visible only from your development machine:<sup class="footnote" id="fnref:1.13"><a href="#fn:1.13">13</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server
<span class="go">=&gt; Booting WEBrick</span>
<span class="go">=&gt; Rails application starting on http://0.0.0.0:3000</span>
<span class="go">=&gt; Call with -d to detach</span>
<span class="go">=&gt; Ctrl-C to shutdown server</span>
</pre></div>
</div>


<p>(If your system complains about the lack of a JavaScript runtime, visit the <a href="https://github.com/sstephenson/execjs">execjs page at GitHub</a> for a list of possibilities. I particularly recommend installing <a href="http://nodejs.org/">Node.js</a>.) This tells us that the application is running on <a href="http://en.wikipedia.org/wiki/TCP_and_UDP_port">port number</a> 3000<sup class="footnote" id="fnref:1.14"><a href="#fn:1.14">14</a></sup> at the address <code>0.0.0.0</code>. This address tells the computer to listen on every available IP address configured on that specific machine; in particular, we can view the application using the special address <code>127.0.0.1</code>, which is also known as <code>localhost</code>. We can see the result of visiting <a href="http://localhost:3000/">http://localhost:3000/</a> in <a class="ref" href="#fig:riding_rails_31">Figure&nbsp;1.3</a>.</p>

<div class="label" id="fig:riding_rails_31"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/riding_rails_31.png" alt="riding_rails_31" /></span></div><div class="caption"><span class="header">Figure 1.3: </span><span class="description">The default Rails page.&nbsp;<a href="http://railstutorial.org/images/figures/riding_rails_31-full.png">(full size)</a></span></div></div>


<p>To see information about our first application, click on the link &ldquo;About your application&rsquo;s environment&rdquo;. The result is shown in <a class="ref" href="#fig:riding_rails_32_environment">Figure&nbsp;1.4</a>. (<a class="ref" href="#fig:riding_rails_32_environment">Figure&nbsp;1.4</a> represents the environment on my machine when I made the screenshot; your results may differ.)</p>

<div class="label" id="fig:riding_rails_32_environment"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/riding_rails_32_environment.png" alt="riding_rails_32_environment" /></span></div><div class="caption"><span class="header">Figure 1.4: </span><span class="description">The default page with the app environment.&nbsp;<a href="http://railstutorial.org/images/figures/riding_rails_32_environment-full.png">(full size)</a></span></div></div>


<p>Of course, we don&rsquo;t need the default Rails page in the long run, but it&rsquo;s nice to see it working for now. We&rsquo;ll remove the default page (and replace it with a custom home page) in <a class="ref" href="#sec:rails_routes">Section&nbsp;5.3.2</a>.</p>

<div class="label" id="sec:mvc"></div>


<h3><a id="sec:1.2.6" href="#sec:mvc" class="heading"><span class="number">1.2.6</span> Model-view-controller (MVC)</a></h3>


<p>Even at this early stage, it&rsquo;s helpful to get a high-level overview of how Rails applications work (<a class="ref" href="#fig:MVC">Figure&nbsp;1.5</a>). You might have noticed that the standard Rails application structure (<a class="ref" href="#fig:directory_structure_rails_3_2">Figure&nbsp;1.2</a>) has an application directory called <code>app/</code> with three subdirectories: <code>models</code>, <code>views</code>, and <code>controllers</code>. This is a hint that Rails follows the <a href="http://en.wikipedia.org/wiki/Model-view-controller">model-view-controller</a> (MVC) architectural pattern, which enforces a separation between &ldquo;domain logic&rdquo; (also called &ldquo;business logic&rdquo;) from the input and presentation logic associated with a graphical user interface (GUI). In the case of web applications, the &ldquo;domain logic&rdquo; typically consists of data models for things like users, articles, and products, and the GUI is just a web page in a web browser.</p>

<p>When interacting with a Rails application, a browser sends a <em>request</em>, which is received by a web server and passed on to a Rails <em>controller</em>, which is in charge of what to do next. In some cases, the controller will immediately render a <em>view</em>, which is a template that gets converted to HTML and sent back to the browser. More commonly for dynamic sites, the controller interacts with a <em>model</em>, which is a Ruby object that represents an element of the site (such as a user) and is in charge of communicating with the database. After invoking the model, the controller then renders the view and returns the complete web page to the browser as HTML.</p>

<div class="label" id="fig:MVC"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/mvc_schematic.png" alt="mvc_schematic" /></span></div><div class="caption"><span class="header">Figure 1.5: </span><span class="description">A schematic representation of the model-view-controller (MVC) architecture.</span></div></div>


<p>If this discussion seems a bit abstract right now, worry not; we&rsquo;ll refer back to this section frequently. In addition, <a class="ref" href="#sec:mvc_in_action">Section&nbsp;2.2.2</a> has a more detailed discussion of MVC in the context of the demo app.  Finally, the sample app will use all aspects of MVC; we&rsquo;ll cover controllers and views starting in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a>, models starting in <a class="ref" href="#sec:user_model">Section&nbsp;6.1</a>, and we&rsquo;ll see all three working together in <a class="ref" href="#sec:a_users_resource">Section&nbsp;7.1.2</a>.</p>

<div class="label" id="sec:version_control"></div>


<h2><a id="sec:1.3" href="#sec:version_control" class="heading"><span class="number">1.3</span> Version control with Git</a></h2>


<p>Now that we have a fresh and working Rails application, we&rsquo;ll take a moment for a step that, while technically optional, would be viewed by many Rails developers as practically essential, namely, placing our application source code under <em>version control</em>. Version control systems allow us to track changes to our project&rsquo;s code, collaborate more easily, and roll back any inadvertent errors (such as accidentally deleting files). Knowing how to use a version control system is a required skill for every software developer.</p>

<p>There are many options for version control, but the Rails community has largely standardized on <a href="http://git-scm.com/">Git</a>, a distributed version control system originally developed by Linus Torvalds to host the Linux kernel. Git is a large subject, and we&rsquo;ll only be scratching the surface in this book, but there are many good free resources online; I especially recommend <a href="http://progit.org"><em>Pro Git</em></a> by Scott Chacon (Apress, 2009). Putting your source code under version control with Git is <em>strongly</em> recommended, not only because it&rsquo;s nearly a universal practice in the Rails world, but also because it will allow you to share your code more easily (<a class="ref" href="#sec:github">Section&nbsp;1.3.4</a>) and deploy your application right here in the first chapter (<a class="ref" href="#sec:deploying">Section&nbsp;1.4</a>).</p>

<div class="label" id="sec:git_setup"></div>


<h3><a id="sec:1.3.1" href="#sec:git_setup" class="heading"><span class="number">1.3.1</span> Installation and setup</a></h3>


<p>The first step is to install Git if you haven&rsquo;t yet followed the steps in <a class="ref" href="#sec:install_git">Section&nbsp;1.2.2.2</a>. (As noted in that section, this involves following the instructions in the <a href="http://progit.org/book/ch1-4.html">Installing Git section of <em>Pro Git</em></a>.)</p>

<h4><a id="sec:1.3.1.1" href="#sec:1.3.1.1" class="heading">First-time system setup</a></h4>


<p>After installing Git, you should perform a set of one-time setup steps. These are <em>system</em> setups, meaning you only have to do them once per computer:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global user.name <span class="s2">&quot;Your Name&quot;</span>
<span class="gp">$</span> git config --global user.email your.email@example.com
</pre></div>
</div>


<p>I also like to use <code>co</code> in place of the more verbose <code>checkout</code> command, which we can arrange as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global alias.co checkout
</pre></div>
</div>


<p>This tutorial will usually use the full <code>checkout</code> command, which works for systems that don&rsquo;t have <code>co</code> configured, but in real life I nearly always use <code>git co</code>.</p>

<p>As a final setup step, you can optionally set the editor Git will use for commit messages. If you use a graphical editor such as Sublime Text, TextMate, gVim, or MacVim, you need to use a flag to make sure that the editor stays attached to the shell instead of detaching immediately:<sup class="footnote" id="fnref:1.15"><a href="#fn:1.15">15</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global core.editor <span class="s2">&quot;subl -w&quot;</span>
</pre></div>
</div>


<p>Replace <code>"subl -w"</code> with <code>"mate -w"</code> for TextMate, <code>"gvim -f"</code> for gVim, or <code>"mvim -f"</code> for MacVim.</p>

<h4><a id="sec:1.3.1.2" href="#sec:1.3.1.2" class="heading">First-time repository setup</a></h4>


<p>Now we come to some steps that are necessary each time you create a new <em>repository</em>. First navigate to the root directory of the first app and initialize a new repository:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="go">Initialized empty Git repository in /Users/mhartl/rails_projects/first_app/.git/</span>
</pre></div>
</div>


<p>The next step is to add the project files to the repository. There&rsquo;s a minor complication, though: by default Git tracks the changes of <em>all</em> the files, but there are some files we don&rsquo;t want to track. For example, Rails creates log files to record the behavior of the application; these files change frequently, and we don&rsquo;t want our version control system to have to update them constantly. Git has a simple mechanism to ignore such files: simply include a file called <code>.gitignore</code> in the application root directory with some rules telling Git which files to ignore.<sup class="footnote" id="fnref:1.16"><a href="#fn:1.16">16</a></sup></p>

<p>Looking again at <a class="ref" href="#table:rails_directory_structure">Table&nbsp;1.1</a>, we see that the <code>rails</code> command creates a default <code>.gitignore</code> file in the application root directory, as shown in <a class="ref" href="#code:default_gitignore">Listing&nbsp;1.6</a>.</p>

<div class="label" id="code:default_gitignore"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.6.</span> <span class="description">The default <code>.gitignore</code> created by the <code>rails</code> command.</span>       
</div>
<div class="code"><div class="highlight"><pre># See http://help.github.com/ignore-files/ for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile ~/.gitignore_global

# Ignore bundler config
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp
</pre></div>
</div></div>


<p><a class="ref" href="#code:default_gitignore">Listing&nbsp;1.6</a> causes Git to ignore files such as log files, Rails temporary (<code>tmp</code>) files, and SQLite databases. (For example, to ignore log files, which live in the <code>log/</code> directory, we use <code>log/*.log</code> to ignore all files that end in <code>.log</code>.) Most of these ignored files change frequently and automatically, so including them under version control is inconvenient; moreover, when collaborating with others they can cause frustrating and irrelevant conflicts.</p>

<p>The <code>.gitignore</code> file in <a class="ref" href="#code:default_gitignore">Listing&nbsp;1.6</a> is probably sufficient for this tutorial, but depending on your system you may find <a class="ref" href="#code:gitignore">Listing&nbsp;1.7</a> more convenient. This augmented <code>.gitignore</code> arranges to ignore Rails documentation files, Vim and Emacs swap files, and (for OS&nbsp;X users) the weird <code>.DS_Store</code> directories created by the Mac Finder application. If you want to use this broader set of ignored files, open up <code>.gitignore</code> in your favorite text editor and fill it with the contents of <a class="ref" href="#code:gitignore">Listing&nbsp;1.7</a>.</p>

<div class="label" id="code:gitignore"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.7.</span> <span class="description">An augmented <code>.gitignore</code> file.</span>       
</div>
<div class="code"><div class="highlight"><pre># Ignore bundler config
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore other unneeded files.
doc/
*.swp
*~
.project
.DS_Store
.idea
</pre></div>
</div></div>




<div class="label" id="sec:adding_and_committing"></div>


<h3><a id="sec:1.3.2" href="#sec:adding_and_committing" class="heading"><span class="number">1.3.2</span> Adding and committing</a></h3>


<p>Finally, we&rsquo;ll add the files in your new Rails project to Git and then commit the results. You can add all the files (apart from those that match the ignore patterns in <code>.gitignore</code>) as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
</pre></div>
</div>


<p>Here the dot &lsquo;<code>.</code>&rsquo; represents the current directory, and Git is smart enough to add the files <em>recursively</em>, so it automatically includes all the subdirectories. This command adds the project files to a <em>staging area</em>, which contains pending changes to your project; you can see which files are in the staging area using the <code>status</code> command:<sup class="footnote" id="fnref:1.17"><a href="#fn:1.17">17</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="gp">#</span>
<span class="gp">#</span> Initial commit
<span class="gp">#</span>
<span class="gp">#</span> Changes to be committed:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git rm --cached &lt;file&gt;...&quot;</span> to unstage<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       new file:   README.rdoc
<span class="gp">#</span>       new file:   Rakefile
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div>
</div>


<p>(The results are long, so I&rsquo;ve used vertical dots to indicate omitted output.)</p>

<p>To tell Git you want to keep the changes, use the <code>commit</code> command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -m <span class="s2">&quot;Initial commit&quot;</span>
<span class="go">[master (root-commit) df0a62f] Initial commit</span>
<span class="go">42 files changed, 8461 insertions(+), 0 deletions(-)</span>
<span class="go">create mode 100644 README.rdoc</span>
<span class="go">create mode 100644 Rakefile</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div>
</div>


<p>The <code>-m</code> flag lets you add a message for the commit; if you omit <code>-m</code>, Git will open the editor you set in <a class="ref" href="#sec:git_setup">Section&nbsp;1.3.1</a> and have you enter the message there.</p>

<p>It is important to note that Git commits are <em>local</em>, recorded only on the machine on which the commits occur. This is in contrast to the popular open-source version control system called Subversion, in which a commit necessarily makes changes on a remote repository. Git divides a Subversion-style commit into its two logical pieces: a local recording of the changes (<code>git commit</code>) and a push of the changes up to a remote repository (<code>git push</code>). We&rsquo;ll see an example of the push step in <a class="ref" href="#sec:git_commands">Section&nbsp;1.3.5</a>.</p>

<p>By the way, you can see a list of your commit messages using the <code>log</code> command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git log
<span class="go">commit df0a62f3f091e53ffa799309b3e32c27b0b38eb4</span>
<span class="go">Author: Michael Hartl &lt;michael@michaelhartl.com&gt;</span>
<span class="go">Date:   Thu Oct 15 11:36:21 2009 -0700</span>

<span class="go">  Initial commit</span>
</pre></div>
</div>


<p>To exit <code>git log</code>, you may have to type <code>q</code> to quit.</p>

<h3><a id="sec:1.3.3" href="#sec:1.3.3" class="heading"><span class="number">1.3.3</span> What good does Git do you?</a></h3>


<p>It&rsquo;s probably not entirely clear at this point why putting your source under version control does you any good, so let me give just one example. (We&rsquo;ll see many others in the chapters ahead.) Suppose you&rsquo;ve made some accidental changes, such as (D&rsquo;oh!) deleting the critical <code>app/controllers/</code> directory:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ls app/controllers/
<span class="go">application_controller.rb</span>
<span class="gp">$</span> rm -rf app/controllers/
<span class="gp">$</span> ls app/controllers/
<span class="go">ls: app/controllers/: No such file or directory</span>
</pre></div>
</div>


<p>Here we&rsquo;re using the Unix <code>ls</code> command to list the contents of the <code>app/controllers/</code> directory and the <code>rm</code> command to remove it. The <code>-rf</code> flag means &ldquo;recursive force&rdquo;, which recursively removes all files, directories, subdirectories, and so on, without asking for explicit confirmation of each deletion.</p>

<p>Let&rsquo;s check the status to see what&rsquo;s up:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="gp">#</span> Changed but not updated:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git add/rm &lt;file&gt;...&quot;</span> to update what will be committed<span class="o">)</span>
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git checkout -- &lt;file&gt;...&quot;</span> to discard changes in working directory<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       deleted:    app/controllers/application_controller.rb
<span class="gp">#</span>
<span class="go">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</span>
</pre></div>
</div>


<p>We see here that a file has been deleted, but the changes are only on the &ldquo;working tree&rdquo;; they haven&rsquo;t been committed yet. This means we can still undo the changes easily by having Git check out the previous commit with the <code>checkout</code> command (and a <code>-f</code> flag to force overwriting the current changes):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -f
<span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="go">nothing to commit (working directory clean)</span>
<span class="gp">$</span> ls app/controllers/
<span class="go">application_controller.rb</span>
</pre></div>
</div>


<p>The missing directory and file are back. That&rsquo;s a relief!</p>

<div class="label" id="sec:github"></div>


<h3><a id="sec:1.3.4" href="#sec:github" class="heading"><span class="number">1.3.4</span> GitHub</a></h3>


<p>Now that you&rsquo;ve put your project under version control with Git, it&rsquo;s time to push your code up to <a href="http://github.com">GitHub</a>, a social code site optimized for hosting and sharing Git repositories. Putting a copy of your Git repository at GitHub serves two purposes: it&rsquo;s a full backup of your code (including the full history of commits), and it makes any future collaboration much easier. This step is optional, but being a GitHub member will open the door to participating in a wide variety of open-source projects.</p>

<div class="label" id="fig:create_first_repository"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/create_first_repository_new.png" alt="create_first_repository_new" /></span></div><div class="caption"><span class="header">Figure 1.6: </span><span class="description">Creating the first app repository at GitHub.&nbsp;<a href="http://railstutorial.org/images/figures/create_first_repository_new-full.png">(full size)</a></span></div></div>


<p>GitHub has a variety of paid plans, but for open-source code their services are free, so sign up for a <a href="https://github.com/signup/free">free GitHub account</a> if you don&rsquo;t have one already. (You might have to follow the <a href="http://help.github.com/key-setup-redirect">GitHub tutorial on creating SSH keys</a> first.) After signing up, click on the link to <a href="http://github.com/new">create a repository</a> and fill in the information as in <a class="ref" href="#fig:create_first_repository">Figure&nbsp;1.6</a>. (Take care <em>not</em> to initialize the repository with a <code>README</code> file, as <code>rails new</code> creates one of those automatically.) After submitting the form, push up your first application as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:&lt;username&gt;/first_app.git
<span class="gp">$</span> git push -u origin master
</pre></div>
</div>


<p>These commands tell Git that you want to add GitHub as the origin for your main (<em>master</em>) branch and then push your repository up to GitHub. (Don&rsquo;t worry about what the <tt>-u</tt> flag does; if you&rsquo;re curious, do a web search for &ldquo;git set upstream&rdquo;.) Of course, you should replace <tt class="verb">&lt;username&gt;</tt> with your actual username. For example, the command I ran for the <code>railstutorial</code> user was</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:railstutorial/first_app.git
</pre></div>
</div>


<p>The result is a page at GitHub for the first application repository, with file browsing, full commit history, and lots of other goodies (<a class="ref" href="#fig:github_repository_page">Figure&nbsp;1.7</a>).</p>

<div class="label" id="fig:github_repository_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/github_repository_page.png" alt="github_repository_page" /></span></div><div class="caption"><span class="header">Figure 1.7: </span><span class="description">A GitHub repository page.&nbsp;<a href="http://railstutorial.org/images/figures/github_repository_page-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:git_commands"></div>


<h3><a id="sec:1.3.5" href="#sec:git_commands" class="heading"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></h3>


<p>If you&rsquo;ve followed the steps in <a class="ref" href="#sec:github">Section&nbsp;1.3.4</a>, you might notice that GitHub automatically shows the contents of the <code>README</code> file on the main repository page. In our case, since the project is a Rails application generated using the <code>rails</code> command, the <code>README</code> file is the one that comes with Rails (<a class="ref" href="#fig:rails_readme">Figure&nbsp;1.8</a>). Because of the <code>.rdoc</code> extension on the file, GitHub ensures that it is formatted nicely, but the contents aren&rsquo;t helpful at all, so in this section we&rsquo;ll make our first edit by changing the <code>README</code> to describe our project rather than the Rails framework itself. In the process, we&rsquo;ll see a first example of the branch, edit, commit, merge workflow that I recommend using with Git.</p>

<div class="label" id="fig:rails_readme"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rails_readme_3_2.png" alt="rails_readme_3_2" /></span></div><div class="caption"><span class="header">Figure 1.8: </span><span class="description">The initial (rather useless) <code>README</code> file for our project at GitHub.&nbsp;<a href="http://railstutorial.org/images/figures/rails_readme_3_2-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:git_branch"></div>


<h4><a id="sec:1.3.5.1" href="#sec:git_branch" class="heading">Branch</a></h4>


<p>Git is incredibly good at making <em>branches</em>, which are effectively copies of a repository where we can make (possibly experimental) changes without modifying the parent files. In most cases, the parent repository is the <em>master</em> branch, and we can create a new topic branch by using <code>checkout</code> with the <code>-b</code> flag:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b modify-README
<span class="go">Switched to a new branch &#39;modify-README&#39;</span>
<span class="gp">$</span> git branch
<span class="go">master</span>
<span class="go">* modify-README</span>
</pre></div>
</div>


<p>Here the second command, <code>git branch</code>, just lists all the local branches, and the asterisk&nbsp;<code>*</code> identifies which branch we&rsquo;re currently on. Note that <code>git checkout -b modify-README</code> both creates a new branch and switches to it, as indicated by the asterisk in front of the <code>modify-README</code> branch. (If you set up the <code>co</code> alias in <a class="ref" href="#sec:version_control">Section&nbsp;1.3</a>, you can use <code>git co -b modify-README</code> instead.)</p>

<p>The full value of branching only becomes clear when working on a project with multiple developers,<sup class="footnote" id="fnref:1.18"><a href="#fn:1.18">18</a></sup> but branches are helpful even for a single-developer tutorial such as this one. In particular, the master branch is insulated from any changes we make to the topic branch, so even if we <em>really</em> screw things up we can always abandon the changes by checking out the master branch and deleting the topic branch. We&rsquo;ll see how to do this at the end of the section.</p>

<p>By the way, for a change as small as this one I wouldn&rsquo;t normally bother with a new branch, but it&rsquo;s never too early to start practicing good habits.</p>

<div class="label" id="sec:git_edit"></div>


<h4><a id="sec:1.3.5.2" href="#sec:git_edit" class="heading">Edit</a></h4>


<p>After creating the topic branch, we&rsquo;ll edit it to make it a little more descriptive. I prefer the <a href="http://daringfireball.net/projects/markdown/">Markdown markup language</a> to the default RDoc for this purpose, and if you use the file extension <code>.md</code> then GitHub will automatically format it nicely for you. So, first we&rsquo;ll use Git&rsquo;s version of the Unix <code>mv</code> (&ldquo;move&rdquo;) command to change the name, and then fill it in with the contents of <a class="ref" href="#code:new_readme">Listing&nbsp;1.8</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README.rdoc README.md
<span class="gp">$</span> subl README.md
</pre></div>
</div>


<div class="label" id="code:new_readme"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.8.</span> <span class="description">The new <code>README</code> file, <code>README.md</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre># Ruby on Rails Tutorial: first application

This is the first application for
[*Ruby on Rails Tutorial: Learn Rails by Example*](http://railstutorial.org/)
by [Michael Hartl](http://michaelhartl.com/).
</pre></div>
</div></div>




<div class="label" id="sec:git_commit"></div>


<h4><a id="sec:1.3.5.3" href="#sec:git_commit" class="heading">Commit</a></h4>


<p>With the changes made, we can take a look at the status of our branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch modify-README
<span class="gp">#</span> Changes to be committed:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git reset HEAD &lt;file&gt;...&quot;</span> to unstage<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       renamed:    README.rdoc -&gt; README.md
<span class="gp">#</span>
<span class="gp">#</span> Changed but not updated:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> to update what will be committed<span class="o">)</span>
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git checkout -- &lt;file&gt;...&quot;</span> to discard changes in working directory<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       modified:   README.md
<span class="gp">#</span>
</pre></div>
</div>


<p>At this point, we could use <code>git add .</code> as in <a class="ref" href="#sec:adding_and_committing">Section&nbsp;1.3.2</a>, but Git provides the <code>-a</code> flag as a shortcut for the (very common) case of committing all modifications to existing files (or files created using <code>git mv</code>, which don&rsquo;t count as new files to Git):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">&quot;Improve the README file&quot;</span>
<span class="go">2 files changed, 5 insertions(+), 243 deletions(-)</span>
<span class="go">delete mode 100644 README.rdoc</span>
<span class="go">create mode 100644 README.md</span>
</pre></div>
</div>


<p>Be careful about using the <code>-a</code> flag improperly; if you have added any new files to the project since the last commit, you still have to tell Git about them using <code>git add</code> first.</p>

<p>Note that we write the commit message in the <em>present</em> tense. Git models commits as a series of patches, and in this context it makes sense to describe what each commit <em>does</em>, rather than what it did. Moreover, this usage matches up with the commit messages generated by Git commands themselves. See the GitHub post <a href="https://github.com/blog/926-shiny-new-commit-styles">Shiny new commit styles</a> for more information.</p>

<div class="label" id="sec:git_merge"></div>


<h4><a id="sec:1.3.5.4" href="#sec:git_merge" class="heading">Merge</a></h4>


<p>Now that we&rsquo;ve finished making our changes, we&rsquo;re ready to <em>merge</em> the results back into our master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="go">Switched to branch &#39;master&#39;</span>
<span class="gp">$</span> git merge modify-README
<span class="go">Updating 34f06b7..2c92bef</span>
<span class="go">Fast forward</span>
<span class="go">README.rdoc     |  243 --------------------------------------------------</span>
<span class="go">README.md       |    5 +</span>
<span class="go">2 files changed, 5 insertions(+), 243 deletions(-)</span>
<span class="go">delete mode 100644 README.rdoc</span>
<span class="go">create mode 100644 README.md</span>
</pre></div>
</div>


<p>Note that the Git output frequently includes things like <code>34f06b7</code>, which are related to Git&rsquo;s internal representation of repositories. Your exact results will differ in these details, but otherwise should essentially match the output shown above.</p>

<p>After you&rsquo;ve merged in the changes, you can tidy up your branches by deleting the topic branch using <code>git branch -d</code> if you&rsquo;re done with it:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git branch -d modify-README
<span class="go">Deleted branch modify-README (was 2c92bef).</span>
</pre></div>
</div>


<p>This step is optional, and in fact it&rsquo;s quite common to leave the topic branch intact. This way you can switch back and forth between the topic and master branches, merging in changes every time you reach a natural stopping point.</p>

<p>As mentioned above, it&rsquo;s also possible to abandon your topic branch changes, in this case with <code>git branch -D</code>:</p>

<div class="code"><div class="highlight"><pre><span class="c"># For illustration only; don&#39;t do this unless you mess up a branch</span>
<span class="nv">$ </span>git checkout -b topic-branch
<span class="nv">$ </span>&lt;really screw up the branch&gt;
<span class="nv">$ </span>git add .
<span class="nv">$ </span>git commit -a -m <span class="s2">&quot;Major screw up&quot;</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git branch -D topic-branch
</pre></div>
</div>


<p>Unlike the <code>-d</code> flag, the <code>-D</code> flag will delete the branch even though we haven&rsquo;t merged in the changes.</p>

<div class="label" id="sec:git_push"></div>


<h4><a id="sec:1.3.5.5" href="#sec:git_push" class="heading">Push</a></h4>


<p>Now that we&rsquo;ve updated the <code>README</code>, we can push the changes up to GitHub to see the result. Since we have already done one push (<a class="ref" href="#sec:github">Section&nbsp;1.3.4</a>), on most systems we can omit <code>origin master</code>, and simply run <code>git push</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div>
</div>


<p>As promised, GitHub nicely formats the new file using Markdown (<a class="ref" href="#fig:new_readme">Figure&nbsp;1.9</a>).</p>

<div class="label" id="fig:new_readme"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_readme.png" alt="new_readme" /></span></div><div class="caption"><span class="header">Figure 1.9: </span><span class="description">The improved <code>README</code> file formatted with Markdown.&nbsp;<a href="http://railstutorial.org/images/figures/new_readme-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:deploying"></div>


<h2><a id="sec:1.4" href="#sec:deploying" class="heading"><span class="number">1.4</span> Deploying</a></h2>


<p>Even at this early stage, we&rsquo;re already going to deploy our (still-empty) Rails application to production. This step is optional, but deploying early and often allows us to catch any deployment problems early in our development cycle. The alternative&mdash;deploying only after laborious effort sealed away in a development environment&mdash;often leads to terrible integration headaches when launch time comes.<sup class="footnote" id="fnref:1.19"><a href="#fn:1.19">19</a></sup></p>

<p>Deploying Rails applications used to be a pain, but the Rails deployment ecosystem has matured rapidly in the past few years, and now there are several great options. These include shared hosts or virtual private servers running <a href="http://www.modrails.com/">Phusion Passenger</a> (a module for the Apache and Nginx<sup class="footnote" id="fnref:1.20"><a href="#fn:1.20">20</a></sup> web servers), full-service deployment companies such as <a href="http://engineyard.com/">Engine Yard</a> and <a href="http://railsmachine.com/">Rails Machine</a>, and cloud deployment services such as <a href="http://cloud.engineyard.com">Engine Yard Cloud</a> and <a href="http://heroku.com/">Heroku</a>.</p>

<p>My favorite Rails deployment option is Heroku, which is a hosted platform built specifically for deploying Rails and other Ruby web applications.<sup class="footnote" id="fnref:1.21"><a href="#fn:1.21">21</a></sup> Heroku makes deploying Rails applications ridiculously easy&mdash;as long as your source code is under version control with Git. (This is yet another reason to follow the Git setup steps in <a class="ref" href="#sec:version_control">Section&nbsp;1.3</a> if you haven&rsquo;t already.) The rest of this section is dedicated to deploying our first application to Heroku.</p>

<h3><a id="sec:1.4.1" href="#sec:1.4.1" class="heading"><span class="number">1.4.1</span> Heroku setup</a></h3>


<p>After <a href="http://api.heroku.com/signup">signing up for a Heroku account</a>, install the Heroku gem:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem install heroku
</pre></div>
</div>


<p>As with GitHub (<a class="ref" href="#sec:github">Section&nbsp;1.3.4</a>), when using Heroku you will need to <a href="http://help.github.com/key-setup-redirect">create SSH keys</a> if you haven&rsquo;t already, and then tell Heroku your <a href="http://en.wikipedia.org/wiki/Public-key_cryptography">public key</a> so that you can use Git to push the sample application repository up to their servers:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku keys:add
</pre></div>
</div>


<p>Finally, use the <code>heroku</code> command to create a place on the Heroku servers for the sample app to live (<a class="ref" href="#code:heroku_create">Listing&nbsp;1.9</a>).</p>

<div class="label" id="code:heroku_create"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 1.9.</span> <span class="description">Creating a new application at Heroku.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create --stack cedar
<span class="go">Created http://stormy-cloud-5881.herokuapp.com/ |</span>
<span class="go">git@heroku.com:stormy-cloud-5881.herokuapp.com</span>
<span class="go">Git remote heroku added</span>
</pre></div>
</div></div>


<p>(The <tt class="verb">--stack cedar</tt> argument arranges to use the latest and greatest version of Heroku, called the <a href="http://devcenter.heroku.com/articles/cedar">Celadon Cedar Stack</a>.) Yes, that&rsquo;s it. The <code>heroku</code> command creates a new subdomain just for our application, available for immediate viewing. There&rsquo;s nothing there yet, though, so let&rsquo;s get busy deploying.</p>

<div class="label" id="sec:heroku_step_one"></div>


<h3><a id="sec:1.4.2" href="#sec:heroku_step_one" class="heading"><span class="number">1.4.2</span> Heroku deployment, step one</a></h3>


<p>To deploy to Heroku, the first step is to use Git to push the application to Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku master
</pre></div>
</div>


<h3><a id="sec:1.4.3" href="#sec:1.4.3" class="heading"><span class="number">1.4.3</span> Heroku deployment, step two</a></h3>


<p>There is no step two! We&rsquo;re already done (<a class="ref" href="#fig:heroku_app_31">Figure&nbsp;1.10</a>). To see your newly deployed application, you can visit the address that you saw when you ran <code>heroku create</code> (i.e., <a class="ref" href="#code:heroku_create">Listing&nbsp;1.9</a>, but with the address for your app, not the address for mine). You can also use an argument to the <code>heroku</code> command that automatically opens your browser with the right address:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p>Because of the details of their setup, the &ldquo;About your application&rsquo;s environment&rdquo; link doesn&rsquo;t work on Heroku. Don&rsquo;t worry; this is normal. The error will go away (in the context of the full sample application) when we remove the default Rails page in <a class="ref" href="#sec:rails_routes">Section&nbsp;5.3.2</a>.</p>

<div class="label" id="fig:heroku_app_31"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/heroku_app_31.png" alt="heroku_app_31" /></span></div><div class="caption"><span class="header">Figure 1.10: </span><span class="description">The first Rails Tutorial application running on Heroku.&nbsp;<a href="http://railstutorial.org/images/figures/heroku_app_31-full.png">(full size)</a></span></div></div>


<p>Once you&rsquo;ve deployed successfully, Heroku provides a beautiful interface for administering and configuring your application (<a class="ref" href="#fig:heroku_info">Figure&nbsp;1.11</a>).</p>

<div class="label" id="fig:heroku_info"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/heroku_info.png" alt="heroku_info" /></span></div><div class="caption"><span class="header">Figure 1.11: </span><span class="description">The beautiful interface at Heroku.&nbsp;<a href="http://railstutorial.org/images/figures/heroku_info-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:heroku_commands"></div>


<h3><a id="sec:1.4.4" href="#sec:heroku_commands" class="heading"><span class="number">1.4.4</span> Heroku commands</a></h3>


<p>There are many <a href="http://devcenter.heroku.com/heroku-command">Heroku commands</a>, and we&rsquo;ll barely scratch the surface in this book. Let&rsquo;s take a minute to show just one of them by renaming the application as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku rename railstutorial
</pre></div>
</div>


<p>Don&rsquo;t use this name yourself; it&rsquo;s already taken by me! In fact, you probably shouldn&rsquo;t bother with this step right now; using the default address supplied by Heroku is fine. But if you do want to rename your application, you can arrange for it to be reasonably secure by using a random or obscure subdomain, such as the following:</p>

<pre class="verbatim">hwpcbmze.heroku.com
seyjhflo.heroku.com
jhyicevg.heroku.com</pre>


<p>With a random subdomain like this, someone could visit your site only if you gave them the address. (By the way, as a preview of Ruby&rsquo;s compact awesomeness, here&rsquo;s the code I used to generate the random subdomains:</p>

<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div>
</div>


<p>Pretty sweet.)</p>

<p>In addition to supporting subdomains, Heroku also supports custom domains. (In fact, the <a href="http://railstutorial.org">Ruby on Rails Tutorial site</a> lives at Heroku; if you&rsquo;re reading this book online, you&rsquo;re looking at a Heroku-hosted site right now!) See the <a href="http://devcenter.heroku.com/">Heroku documentation</a> for more information about custom domains and other Heroku topics.</p>

<div class="label" id="sec:beginning_conclusion"></div>


<h2><a id="sec:1.5" href="#sec:beginning_conclusion" class="heading"><span class="number">1.5</span> Conclusion</a></h2>


<p>We&rsquo;ve come a long way in this chapter: installation, development environment setup, version control, and deployment. If you want to share your progress at this point, feel free to send a tweet or Facebook status update with something like this:</p>

<div class="center"><a href="http://twitter.com/?status=I'm%20learning%20Ruby%20on%20Rails%20with%20@railstutorial!%20http://railstutorial.org/">I&rsquo;m learning Ruby on Rails with @railstutorial! http://railstutorial.org/</a></div>


<p>&nbsp;</p>

<p>All that&rsquo;s left is to actually start learning Rails! Let&rsquo;s get to it.</p>

<div class="footnotes">
<ol>
<li id="fn:1.1"><em>URI</em> stands for Uniform Resource Identifier, while the slightly less general <em>URL</em> stands for Uniform Resource Locator. In practice, the URI is usually equivalent to &ldquo;the thing you see in the address bar of your browser&rdquo;.&nbsp;<a class="arrow" href="#fnref:1.1">&uarr;</a></li>
<li id="fn:1.2">http://tryruby.org/&nbsp;<a class="arrow" href="#fnref:1.2">&uarr;</a></li>
<li id="fn:1.3">http://railsforzombies.org/&nbsp;<a class="arrow" href="#fnref:1.3">&uarr;</a></li>
<li id="fn:1.4">http://railstutorial.org/screencasts&nbsp;<a class="arrow" href="#fnref:1.4">&uarr;</a></li>
<li id="fn:1.5">When reading the <em>Rails Tutorial</em>, you may find it convenient to follow an internal section link to look at the reference and then immediately go back to where you were before. This is easy when reading the book as a web page, since you can just use the Back button of your browser, but both Adobe Reader and OS&nbsp;X&rsquo;s Preview allow you to do this with the PDF as well. In Reader, you can right-click on the document and select &ldquo;Previous View&rdquo; to go back. In Preview, use the Go menu: <tt>Go &gt; Back</tt>.&nbsp;<a class="arrow" href="#fnref:1.5">&uarr;</a></li>
<li id="fn:1.6">http://railstutorial.org/help&nbsp;<a class="arrow" href="#fnref:1.6">&uarr;</a></li>
<li id="fn:1.7">https://github.com/perfectionist/sample_project/wiki&nbsp;<a class="arrow" href="#fnref:1.7">&uarr;</a></li>
<li id="fn:1.8">The vi editor is one of the most ancient yet powerful weapons in the Unix arsenal, and Vim is &ldquo;vi improved&rdquo;.&nbsp;<a class="arrow" href="#fnref:1.8">&uarr;</a></li>
<li id="fn:1.9">https://github.com/mhartl/rails_tutorial_sublime_text&nbsp;<a class="arrow" href="#fnref:1.9">&uarr;</a></li>
<li id="fn:1.10">If you haven&rsquo;t used IRC before, I suggest you start by searching the web for &ldquo;irc client &lt;your platform&gt;&rdquo;. Two good native clients for OS&nbsp;X are <a href="http://colloquy.info/">Colloquy</a> and <a href="http://limechat.net/mac/">LimeChat</a>. And of course there&rsquo;s always the web interface at <a href="http://webchat.freenode.net/?channels=rvm">http://webchat.freenode.net/?channels=rvm</a>.&nbsp;<a class="arrow" href="#fnref:1.10">&uarr;</a></li>
<li id="fn:1.11">You might have to install the <a href="http://subversion.tigris.org/">Subversion version control system</a> to get this to work.&nbsp;<a class="arrow" href="#fnref:1.11">&uarr;</a></li>
<li id="fn:1.12">https://developer.apple.com/downloads/&nbsp;<a class="arrow" href="#fnref:1.12">&uarr;</a></li>
<li id="fn:1.13">Recall from <a class="ref" href="#sec:conventions">Section&nbsp;1.1.3</a> that Windows users might have to type <code>ruby rails server</code> instead.&nbsp;<a class="arrow" href="#fnref:1.13">&uarr;</a></li>
<li id="fn:1.14">Normally, websites run on port 80, but this usually requires special privileges, so Rails picks a less restricted higher-numbered port for the development server.&nbsp;<a class="arrow" href="#fnref:1.14">&uarr;</a></li>
<li id="fn:1.15">Normally this is a feature, since it lets you continue to use the command line after launching your editor, but Git interprets the detachment as closing the file with an empty commit message, which prevents the commit from going through. I only mention this point because it can be seriously confusing if you try to set your editor to <code>subl</code> or <code>gvim</code> without the flag. If you find this note confusing, feel free to ignore it.&nbsp;<a class="arrow" href="#fnref:1.15">&uarr;</a></li>
<li id="fn:1.16">If you can&rsquo;t see the <code>.gitignore</code> file in your directory, you may need to configure your directory viewer to show hidden files.&nbsp;<a class="arrow" href="#fnref:1.16">&uarr;</a></li>
<li id="fn:1.17">If in the future any unwanted files start showing up when you type <code>git status</code>, just add them to your <code>.gitignore</code> file from <a class="ref" href="#code:gitignore">Listing&nbsp;1.7</a>.&nbsp;<a class="arrow" href="#fnref:1.17">&uarr;</a></li>
<li id="fn:1.18">See the chapter <a href="http://progit.org/book/ch3-0.html">Git Branching in <em>Pro Git</em></a> for details.&nbsp;<a class="arrow" href="#fnref:1.18">&uarr;</a></li>
<li id="fn:1.19">Though it shouldn&rsquo;t matter for the example applications in the <em>Rails Tutorial</em>, if you&rsquo;re worried about accidentally making your app public too soon there are several options; see <a class="ref" href="#sec:heroku_commands">Section&nbsp;1.4.4</a> for one.&nbsp;<a class="arrow" href="#fnref:1.19">&uarr;</a></li>
<li id="fn:1.20">Pronounced &ldquo;Engine X&rdquo;.&nbsp;<a class="arrow" href="#fnref:1.20">&uarr;</a></li>
<li id="fn:1.21">Heroku works with any Ruby web platform that uses <a href="http://rack.rubyforge.org/">Rack middleware</a>, which provides a standard interface between web frameworks and web servers. Adoption of the Rack interface has been extraordinarily strong in the Ruby community, including frameworks as varied as <a href="http://www.sinatrarb.com/">Sinatra</a>, <a href="http://ramaze.net/">Ramaze</a>, <a href="http://camping.rubyforge.org/files/README.html">Camping</a>, and Rails, which means that Heroku basically supports any Ruby web app.&nbsp;<a class="arrow" href="#fnref:1.21">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:a_demo_app"></div>


<h1 class="chapter"><a id="sec:2" href="#cha:a_demo_app" class="heading"><span class="number">Chapter 2</span> A demo app</a></h1>


<p>In this chapter, we&rsquo;ll develop a simple demonstration application to show off some of the power of Rails. The purpose is to get a high-level overview of Ruby on Rails programming (and web development in general) by rapidly generating an application using <em>scaffold generators</em>. As discussed in <a class="ref" href="#sidebar:scaffolding">Box&nbsp;1.1</a>, the rest of the book will take the opposite approach, developing a full application incrementally and explaining each new concept as it arises, but for a quick overview (and some instant gratification) there is no substitute for scaffolding. The resulting demo app will allow us to interact with it through its URIs, giving us insight into the structure of a Rails application, including a first example of the <em>REST architecture</em> favored by Rails.</p>

<p>As with the forthcoming sample application, the demo app will consist of <em>users</em> and their associated <em>microposts</em> (thus constituting a minimalist Twitter-style app). The functionality will be utterly under-developed, and many of the steps will seem like magic, but worry not: the full sample app will develop a similar application from the ground up starting in <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>, and I will provide plentiful forward-references to later material. In the mean time, have patience and a little faith&mdash;the whole point of this tutorial is to take you <em>beyond</em> this superficial, scaffold-driven approach to achieve a deeper understanding of Rails.</p>

<div class="label" id="sec:planning_the_application"></div>


<h2><a id="sec:2.1" href="#sec:planning_the_application" class="heading"><span class="number">2.1</span> Planning the application</a></h2>


<p>In this section, we&rsquo;ll outline our plans for the demo application. As in <a class="ref" href="#sec:the_first_application">Section&nbsp;1.2.3</a>, we&rsquo;ll start by generating the application skeleton using the <code>rails</code> command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects
<span class="gp">$</span> rails new demo_app
<span class="gp">$</span> <span class="nb">cd </span>demo_app
</pre></div>
</div>


<p>Next, we&rsquo;ll use a text editor to update the <code>Gemfile</code> needed by Bundler with the contents of <a class="ref" href="#code:demo_gemfile_sqlite_version_redux">Listing&nbsp;2.1</a>.</p>

<div class="label" id="code:demo_gemfile_sqlite_version_redux"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.1.</span> <span class="description">A <code>Gemfile</code> for the demo app.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>


<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that <a class="ref" href="#code:demo_gemfile_sqlite_version_redux">Listing&nbsp;2.1</a> is identical to <a class="ref" href="#code:gemfile_sqlite_version">Listing&nbsp;1.5</a> except for the addition of a gem needed in production at Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The&nbsp;<code>pg</code> gem is needed to access <a href="http://www.postgresql.org/">PostgreSQL</a> (&ldquo;post-gres-cue-ell&rdquo;), the database used by Heroku.</p>

<p>We then install and include the gems using the <code>bundle install</code> command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --without production
</pre></div>
</div>


<p>The <tt class="verb">--without production</tt> option prevents the installation of the production gems, which in this case is just the PostgreSQL gem&nbsp;<tt>pg</tt>. (If Bundler complains about</p>

<pre class="verbatim">no such file to load -- readline (LoadError)</pre>


<p>try adding <code>gem &rsquo;rb-readline&rsquo;</code> to your <code>Gemfile</code>.)</p>

<p>Finally, we&rsquo;ll put the demo app under version control. Recall that the <code>rails</code> command generates a default <code>.gitignore</code> file, but depending on your system you may find the augmented file from <a class="ref" href="#code:gitignore">Listing&nbsp;1.7</a> to be more convenient. Then initialize a Git repository and make the first commit:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Initial commit&quot;</span>
</pre></div>
</div>


<div class="label" id="fig:create_demo_repo"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/create_demo_repo_new.png" alt="create_demo_repo_new" /></span></div><div class="caption"><span class="header">Figure 2.1: </span><span class="description">Creating a demo app repository at GitHub.&nbsp;<a href="http://railstutorial.org/images/figures/create_demo_repo_new-full.png">(full size)</a></span></div></div>


<p>You can also optionally create a new repository (<a class="ref" href="#fig:create_demo_repo">Figure&nbsp;2.1</a>) and push it up to GitHub:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:&lt;username&gt;/demo_app.git
<span class="gp">$</span> git push -u origin master
</pre></div>
</div>


<p>(As with the first app, take care <em>not</em> to initialize the GitHub repository with a <code>README</code> file.)</p>

<p>Now we&rsquo;re ready to start making the app itself. The typical first step when making a web application is to create a <em>data model</em>, which is a representation of the structures needed by our application. In our case, the demo app will be a microblog, with only users and short (micro)posts. Thus, we&rsquo;ll begin with a model for <em>users</em> of the app (<a class="ref" href="#sec:modeling_demo_users">Section&nbsp;2.1.1</a>), and then we&rsquo;ll add a model for  <em>microposts</em> (<a class="ref" href="#sec:modeling_demo_microposts">Section&nbsp;2.1.2</a>).</p>

<div class="label" id="sec:modeling_demo_users"></div>


<h3><a id="sec:2.1.1" href="#sec:modeling_demo_users" class="heading"><span class="number">2.1.1</span> Modeling demo users</a></h3>


<p>There are as many choices for a user data model as there are different registration forms on the web; we&rsquo;ll go with a distinctly minimalist approach. Users of our demo app will have a unique <code>integer</code> identifier called <code>id</code>, a publicly viewable <code>name</code> (of type <code>string</code>), and an <code>email</code> address (also a <code>string</code>) that will double as a username. A summary of the data model for users appears in <a class="ref" href="#fig:demo_user_model">Figure&nbsp;2.2</a>.</p>

<div class="label" id="fig:demo_user_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_user_model.png" alt="demo_user_model" /></span></div><div class="caption"><span class="header">Figure 2.2: </span><span class="description">The data model for users.</span></div></div>


<p>As we&rsquo;ll see starting in <a class="ref" href="#sec:database_migrations">Section&nbsp;6.1.1</a>, the label <code>users</code> in <a class="ref" href="#fig:demo_user_model">Figure&nbsp;2.2</a> corresponds to a <em>table</em> in a database, and the <code>id</code>, <code>name</code>, and <code>email</code> attributes are <em>columns</em> in that table.</p>

<div class="label" id="sec:modeling_demo_microposts"></div>


<h3><a id="sec:2.1.2" href="#sec:modeling_demo_microposts" class="heading"><span class="number">2.1.2</span> Modeling demo microposts</a></h3>


<p>The core of the micropost data model is even simpler than the one for users: a micropost has only an <code>id</code> and a <code>content</code> field for the micropost&rsquo;s text (of type <code>string</code>).<sup class="footnote" id="fnref:2.1"><a href="#fn:2.1">1</a></sup> There&rsquo;s an additional complication, though: we want to <em>associate</em> each micropost with a particular user; we&rsquo;ll accomplish this by recording the <code>user_id</code> of the owner of the post. The results are shown in <a class="ref" href="#fig:demo_micropost_model">Figure&nbsp;2.3</a>.</p>

<div class="label" id="fig:demo_micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_micropost_model.png" alt="demo_micropost_model" /></span></div><div class="caption"><span class="header">Figure 2.3: </span><span class="description">The data model for microposts.</span></div></div>


<p>We&rsquo;ll see in <a class="ref" href="#sec:demo_user_has_many_microposts">Section&nbsp;2.3.3</a> (and more fully in <a class="ref" href="#cha:user_microposts">Chapter&nbsp;10</a>) how this <code>user_id</code> attribute allows us to succinctly express the notion that a user potentially has many associated microposts.</p>

<div class="label" id="sec:demo_users_resource"></div>


<h2><a id="sec:2.2" href="#sec:demo_users_resource" class="heading"><span class="number">2.2</span> The Users resource</a></h2>


<p>In this section, we&rsquo;ll implement the users data model in <a class="ref" href="#sec:modeling_demo_users">Section&nbsp;2.1.1</a>, along with a web interface to that model.
The combination will constitute a <em>Users resource</em>, which will allow us to think of users as objects that can be created, read, updated, and deleted through the web via the <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP protocol</a>. As promised in the introduction, our Users resource will be created by a scaffold generator program, which comes standard with each Rails project. I urge you not to look too closely at the generated code; at this stage, it will only serve to confuse you.</p>

<p>Rails scaffolding is generated by passing the <code>scaffold</code> command to the <code>rails generate</code> script. The argument of the <code>scaffold</code> command is the singular version of the resource name (in this case, <code>User</code>), together with optional parameters for the data model&rsquo;s attributes:<sup class="footnote" id="fnref:2.2"><a href="#fn:2.2">2</a></sup></p>

<div class="code"><div class="highlight"><pre>$ rails generate scaffold User name:string email:string
      invoke  active_record
      create    db/migrate/20111123225336_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      test/unit/user_test.rb
      create      test/fixtures/users.yml
       route  resources :users
      invoke  scaffold_controller
      create    app/controllers/users_controller.rb
      invoke    erb
      create      app/views/users
      create      app/views/users/index.html.erb
      create      app/views/users/edit.html.erb
      create      app/views/users/show.html.erb
      create      app/views/users/new.html.erb
      create      app/views/users/_form.html.erb
      invoke    test_unit
      create      test/functional/users_controller_test.rb
      invoke    helper
      create      app/helpers/users_helper.rb
      invoke      test_unit
      create        test/unit/helpers/users_helper_test.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/users.js.coffee
      invoke    scss
      create      app/assets/stylesheets/users.css.scss
      invoke  scss
      create    app/assets/stylesheets/scaffolds.css.scss
</pre></div>
</div>


<p>By including <code>name:string</code> and <code>email:string</code>, we have arranged for the User model to have the form shown in <a class="ref" href="#fig:demo_user_model">Figure&nbsp;2.2</a>. (Note that there is no need to include a parameter for&nbsp;<code>id</code>; it is created automatically by Rails for use as the <em>primary key</em> in the database.)</p>

<p>To proceed with the demo application, we first need to <em>migrate</em> the database using <em>Rake</em> (<a class="ref" href="#sidebar:rake">Box&nbsp;2.1</a>):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="go">==  CreateUsers: migrating ====================================================</span>
<span class="go">-- create_table(:users)</span>
<span class="go">   -&gt; 0.0017s</span>
<span class="go">==  CreateUsers: migrated (0.0018s) ===========================================</span>
</pre></div>
</div>


<p>This simply updates the database with our new <code>users</code> data model. (We&rsquo;ll learn more about database migrations starting in <a class="ref" href="#sec:database_migrations">Section&nbsp;6.1.1</a>.) Note that, in order to ensure that the command uses the version of Rake corresponding to our <code>Gemfile</code>, we need to run <code>rake</code> using <code>bundle exec</code>.</p>

<p>With that, we can run the local web server using <code>rails s</code>, which is a shortcut for <code>rails server</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails s
</pre></div>
</div>


<p>Now the demo application should be ready to go at <a href="http://localhost:3000/">http://localhost:3000/</a>.</p>

<div class="label" id="sidebar:rake"></div>


<div class="sidebar"><span class="title"><span class="header">Box 2.1.</span><span class="description">Rake</span></span>
<p>In the Unix tradition, the <a href="http://en.wikipedia.org/wiki/Make_(software)"><em>make</em></a> utility has played an important role in building executable programs from source code; many a computer hacker has committed to muscle memory the line</p>

<pre class="verbatim">  $ ./configure &amp;&amp; make &amp;&amp; sudo make install</pre>


<p>commonly used to compile code on Unix systems (including Linux and Mac OS&nbsp;X).</p>

<p>Rake is <em>Ruby make</em>, a make-like language written in Ruby. Rails uses Rake extensively, especially for the innumerable little administrative tasks necessary when developing database-backed web applications. The <code>rake db:migrate</code> command is probably the most common, but there are many others; you can see a list of database tasks using <code>-T db</code>:</p>

<pre class="verbatim">$ bundle exec rake -T db</pre>


<p>To see all the Rake tasks available, run</p>

<pre class="verbatim">$ bundle exec rake -T</pre>


<p>The list is likely to be overwhelming, but don&rsquo;t worry, you don&rsquo;t have to know all (or even most) of these commands. By the end of the <em>Rails Tutorial</em>, you&rsquo;ll know all the most important ones.</p>
</div>




<div class="label" id="sec:a_user_tour"></div>


<h3><a id="sec:2.2.1" href="#sec:a_user_tour" class="heading"><span class="number">2.2.1</span> A user tour</a></h3>


<p>Visiting the root url&nbsp;<a href="http://localhost:3000/">http://localhost:3000/</a> shows the same default Rails page shown in <a class="ref" href="#fig:riding_rails_31">Figure&nbsp;1.3</a>, but in generating the Users resource scaffolding we have also created a large number of pages for manipulating users. For example, the page for listing all users is at <a href="http://localhost:3000/users">/users</a>, and the
page for making a new user is at <a href="http://localhost:3000/users/new">/users/new</a>.  The rest of this section is dedicated to taking a whirlwind tour through these user pages. As we proceed, it may help to refer to <a class="ref" href="#table:user_urls">Table&nbsp;2.1</a>, which shows the correspondence between pages and URIs.</p>

<div class="label" id="table:user_urls"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><a href="http://localhost:3000/users">/users</a></td><td class="align_left"><code>index</code></td><td class="align_left">page to list all users</td></tr><tr><td class="align_left"><a href="http://localhost:3000/users/1">/users/1</a></td><td class="align_left"><code>show</code></td><td class="align_left">page to show user with id <code>1</code></td></tr><tr><td class="align_left"><a href="http://localhost:3000/users/new">/users/new</a></td><td class="align_left"><code>new</code></td><td class="align_left">page to make a new user</td></tr><tr><td class="align_left"><a href="http://localhost:3000/users/1/edit">/users/1/edit</a></td><td class="align_left"><code>edit</code></td><td class="align_left">page to edit user with id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 2.1: </span><span class="description">The correspondence between pages and URIs for the Users resource.</span></div></div>


<p>We start with the page to show all the users in our application, called <a href="http://localhost:3000/users"><tt>index</tt></a>; as you might expect, initially there are no users at all (<a class="ref" href="#fig:demo_blank_user_index_rails_3">Figure&nbsp;2.4</a>).</p>

<div class="label" id="fig:demo_blank_user_index_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_blank_user_index_rails_3.png" alt="demo_blank_user_index_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.4: </span><span class="description">The initial index page for the Users resource (<a href="http://localhost:3000/users">/users</a>).&nbsp;<a href="/images/figures/demo_blank_user_index_rails_3-full.png">(full size)</a></span></div></div>


<p>To make a new user, we visit the <a href="http://localhost:3000/users/new"><tt>new</tt></a> page, as shown in <a class="ref" href="#fig:demo_new_user_rails_3">Figure&nbsp;2.5</a>. (Since the http://localhost:3000 part of the address is implicit whenever we are developing locally, I&rsquo;ll usually omit it from now on.) In <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, this will become the user signup page.</p>

<div class="label" id="fig:demo_new_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_new_user_rails_3.png" alt="demo_new_user_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.5: </span><span class="description">The new user page (<a href="http://localhost:3000/users/new">/users/new</a>).&nbsp;<a href="/images/figures/demo_new_user_rails_3-full.png">(full size)</a></span></div></div>


<p>We can create a user by entering name and email values in the text fields and then clicking the Create User button. The result is the user <a href="http://localhost:3000/users/1"><tt>show</tt></a> page, as seen in <a class="ref" href="#fig:demo_show_user_rails_3">Figure&nbsp;2.6</a>. (The green welcome message is accomplished using the <em>flash</em>, which we&rsquo;ll learn about in <a class="ref" href="#sec:the_flash">Section&nbsp;7.4.2</a>.) Note that the URI is <a href="http://localhost:3000/users/1">/users/1</a>; as you might suspect, the number&nbsp;<code>1</code> is simply the user&rsquo;s&nbsp;<code>id</code> attribute from <a class="ref" href="#fig:demo_user_model">Figure&nbsp;2.2</a>. In <a class="ref" href="#sec:showing_users">Section&nbsp;7.1</a>, this page will become the user&rsquo;s profile.</p>

<div class="label" id="fig:demo_show_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_show_user_rails_3.png" alt="demo_show_user_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.6: </span><span class="description">The page to show a user (<a href="http://localhost:3000/users/1">/users/1</a>).&nbsp;<a href="/images/figures/demo_show_user_rails_3-full.png">(full size)</a></span></div></div>


<p>To change a user&rsquo;s information, we visit the <a href="http://localhost:3000/users/1/edit"><tt>edit</tt></a> page (<a class="ref" href="#fig:demo_edit_user_rails_3">Figure&nbsp;2.7</a>). By modifying the user information and clicking the Update User button, we arrange to change the information for the user in the demo application (<a class="ref" href="#fig:demo_update_user_rails_3">Figure&nbsp;2.8</a>). (As we&rsquo;ll see in detail starting in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>, this user data is stored in a database back-end.) We&rsquo;ll add user edit/update functionality to the sample application in <a class="ref" href="#sec:updating_users">Section&nbsp;9.1</a>.</p>

<div class="label" id="fig:demo_edit_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_edit_user_rails_3.png" alt="demo_edit_user_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.7: </span><span class="description">The user edit page (<a href="http://localhost:3000/users/1/edit">/users/1/edit</a>).&nbsp;<a href="/images/figures/demo_edit_user_rails_3-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:demo_update_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_update_user_rails_3.png" alt="demo_update_user_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.8: </span><span class="description">A user with updated information.&nbsp;<a href="/images/figures/demo_update_user_rails_3-full.png">(full size)</a></span></div></div>


<p>Now we&rsquo;ll create a second user by revisiting the <a href="http://localhost:3000/users/new"><tt>new</tt></a> page and submitting a second set of user information; the resulting user <a href="http://localhost:3000/users"><tt>index</tt></a> is shown in <a class="ref" href="#fig:demo_user_index_two_rails_3">Figure&nbsp;2.9</a>. <a class="ref" href="#sec:showing_users">Section&nbsp;7.1</a> will develop the user index into a more polished page for showing all users.</p>

<div class="label" id="fig:demo_user_index_two_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_user_index_two_rails_3.png" alt="demo_user_index_two_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.9: </span><span class="description">The user index page (<a href="http://localhost:3000/users">/users</a>) with a second user.&nbsp;<a href="/images/figures/demo_user_index_two_rails_3-full.png">(full size)</a></span></div></div>


<p>Having shown how to create, show, and edit users, we come finally to destroying them (<a class="ref" href="#fig:demo_destroy_user_rails_3">Figure&nbsp;2.10</a>). You should verify that clicking on the link in <a class="ref" href="#fig:demo_destroy_user_rails_3">Figure&nbsp;2.10</a> destroys the second user, yielding an index page with only one user. (If it doesn&rsquo;t work, be sure that JavaScript is enabled in your browser; Rails uses JavaScript to issue the request needed to destroy a user.) <a class="ref" href="#sec:destroying_users">Section&nbsp;9.4</a> adds user deletion to the sample app, taking care to restrict its use to a special class of administrative users.</p>

<div class="label" id="fig:demo_destroy_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_destroy_user_rails_3.png" alt="demo_destroy_user_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.10: </span><span class="description">Destroying a user.&nbsp;<a href="/images/figures/demo_destroy_user_rails_3-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:mvc_in_action"></div>


<h3><a id="sec:2.2.2" href="#sec:mvc_in_action" class="heading"><span class="number">2.2.2</span> MVC in action</a></h3>


<p>Now that we&rsquo;ve completed a quick overview of the Users resource, let&rsquo;s examine one particular part of it in the context of the Model-View-Controller (MVC) pattern introduced in <a class="ref" href="#sec:mvc">Section&nbsp;1.2.6</a>. Our strategy will be to describe the results of a typical browser hit&mdash;a visit to the user index page at <a href="http://localhost:3000/users">/users</a>&mdash;in terms of MVC (<a class="ref" href="#fig:mvc_detailed">Figure&nbsp;2.11</a>).</p>

<div class="label" id="fig:mvc_detailed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/mvc_detailed.png" alt="mvc_detailed" /></span></div><div class="caption"><span class="header">Figure 2.11: </span><span class="description">A detailed diagram of MVC in Rails.&nbsp;<a href="/images/figures/mvc_detailed-full.png">(full size)</a></span></div></div>




<ol>
<li>The browser issues a request for the /users URI.</li>
<li>Rails routes /users to the <code>index</code> action in the Users controller.</li>
<li>The <code>index</code> action asks the User model to retrieve all users (<code>User.all</code>).</li>
<li>The User model pulls all the users from the database.</li>
<li>The User model returns the list of users to the controller.</li>
<li>The controller captures the users in the <code>@users</code> variable, which is passed to the <code>index</code> view.</li>
<li>The view uses embedded Ruby to render the page as HTML.</li>
<li>The controller passes the HTML back to the browser.<sup class="footnote" id="fnref:2.3"><a href="#fn:2.3">3</a></sup></li>
</ol>


<p>We start with a request issued from the browser&mdash;i.e., the result of typing a URI in the address bar or clicking on a link (Step&nbsp;1 in <a class="ref" href="#fig:mvc_detailed">Figure&nbsp;2.11</a>). This request hits the <em>Rails router</em> (Step&nbsp;2), which dispatches to the proper <em>controller action</em> based on the URI (and, as we&rsquo;ll see in <a class="ref" href="#sidebar:get_etc">Box&nbsp;3.2</a>, the type of request). The code to create the mapping of user URIs to controller actions for the Users resource appears in <a class="ref" href="#code:rails_routes">Listing&nbsp;2.2</a>; this code effectively sets up the table of URI/action pairs seen in <a class="ref" href="#table:user_urls">Table&nbsp;2.1</a>. (The strange notation <code>:users</code> is a <em>symbol</em>, which we&rsquo;ll learn about in <a class="ref" href="#sec:hashes_and_symbols">Section&nbsp;4.3.3</a>.)</p>

<div class="label" id="code:rails_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.2.</span> <span class="description">The Rails routes, with a rule for the Users resource. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">DemoApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The pages from the tour in <a class="ref" href="#sec:a_user_tour">Section&nbsp;2.2.1</a> correspond to <em>actions</em> in the Users <em>controller</em>, which is a collection of related actions; the controller generated by the scaffolding is shown schematically in <a class="ref" href="#code:demo_users_controller">Listing&nbsp;2.3</a>. Note the notation <code>class UsersController &lt; ApplicationController</code>; this is an example of a Ruby <em>class</em> with <em>inheritance</em>. (We&rsquo;ll discuss inheritance briefly in <a class="ref" href="#sec:inheritance_hierarchies">Section&nbsp;2.3.4</a> and cover both subjects in more detail in <a class="ref" href="#sec:ruby_classes">Section&nbsp;4.4</a>.)</p>

<div class="label" id="code:demo_users_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.3.</span> <span class="description">The Users controller in schematic form. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You may notice that there are more actions than there are pages; the <code>index</code>, <code>show</code>, <code>new</code>, and <code>edit</code> actions all correspond to pages from <a class="ref" href="#sec:a_user_tour">Section&nbsp;2.2.1</a>, but there are additional <code>create</code>, <code>update</code>, and <code>destroy</code> actions as well. These actions don&rsquo;t typically render pages (although they sometimes do); instead, their main purpose is to modify information about users in the database. This full suite of controller actions, summarized in <a class="ref" href="#table:demo_RESTful_users">Table&nbsp;2.2</a>, represents the implementation of the REST architecture in Rails (<a class="ref" href="#sidebar:REST">Box&nbsp;2.2</a>), which is based on the ideas of <em>representational state transfer</em> identified and named by computer scientist <a href="http://en.wikipedia.org/wiki/Roy_Fielding">Roy Fielding</a>.<sup class="footnote" id="fnref:2.4"><a href="#fn:2.4">4</a></sup> Note from <a class="ref" href="#table:demo_RESTful_users">Table&nbsp;2.2</a> that there is some overlap in the URIs; for example, both the user <code>show</code> action and the <code>update</code> action correspond to the URI /users/1. The difference between them is the <a href="http://en.wikipedia.org/wiki/HTTP_request#Request_methods">HTTP request method</a> they respond to. We&rsquo;ll learn more about HTTP request methods starting in <a class="ref" href="#sec:TDD">Section&nbsp;3.2.1</a>.</p>

<div class="label" id="table:demo_RESTful_users"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users</td><td class="align_left"><code>index</code></td><td class="align_left">page to list all users</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>show</code></td><td class="align_left">page to show user with id <code>1</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/new</td><td class="align_left"><code>new</code></td><td class="align_left">page to make a new user</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/users</td><td class="align_left"><code>create</code></td><td class="align_left">create a new user</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left">page to edit user with id <code>1</code></td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>update</code></td><td class="align_left">update user with id <code>1</code></td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">delete user with id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 2.2: </span><span class="description">RESTful routes provided by the Users resource in <a class="ref" href="#code:rails_routes">Listing&nbsp;2.2</a>.</span></div></div>




<div class="label" id="sidebar:REST"></div>


<div class="sidebar"><span class="title"><span class="header">Box 2.2.</span><span class="description">REpresentational State Transfer (REST)</span></span>
<p>If you read much about Ruby on Rails web development, you&rsquo;ll see a lot of references to &ldquo;REST&rdquo;, which is an acronym for REpresentational State Transfer. REST is an architectural style for developing distributed, networked systems and software applications such as the World Wide Web and web applications. Although REST theory is rather abstract, in the context of Rails applications REST means that most application components (such as users and microposts) are modeled as <em>resources</em> that can be created, read, updated, and deleted&mdash;operations that correspond both to the <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD operations of relational databases</a> and the four fundamental <a href="http://en.wikipedia.org/wiki/HTTP_request#Request_methods">HTTP request methods</a>: <tt>POST</tt>, <tt>GET</tt>, <tt>PUT</tt>, and <tt>DELETE</tt>. (We&rsquo;ll learn more about HTTP requests in <a class="ref" href="#sec:TDD">Section&nbsp;3.2.1</a> and especially <a class="ref" href="#sidebar:get_etc">Box&nbsp;3.2</a>.)</p>

<p>As a Rails application developer, the RESTful style of development helps you make choices about which controllers and actions to write: you simply structure the application using resources that get created, read, updated, and deleted. In the case of users and microposts, this process is straightforward, since they are naturally resources in their own right. In <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>, we&rsquo;ll see an example where REST principles allow us to model a subtler problem, &ldquo;following users&rdquo;, in a natural and convenient way.</p>
</div>


<p>To examine the relationship between the Users controller and the User model, let&rsquo;s focus on a simplified version of the <code>index</code> action, shown in <a class="ref" href="#code:demo_index_action">Listing&nbsp;2.4</a>. (The scaffold code is ugly and confusing, so I&rsquo;ve suppressed it.)</p>

<div class="label" id="code:demo_index_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.4.</span> <span class="description">The simplified user <code>index</code> action for the demo application. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This <code>index</code> action has the line <code>@users = User.all</code> (Step&nbsp;3), which asks the User model to retrieve a list of all the users from the database (Step&nbsp;4), and then places them in the  variable <code>@users</code> (pronounced &ldquo;at-users&rdquo;) (Step&nbsp;5). The User model itself appears in <a class="ref" href="#code:demo_user_model">Listing&nbsp;2.5</a>; although it is rather plain, it comes equipped with a large amount of functionality because of inheritance (<a class="ref" href="#sec:inheritance_hierarchies">Section&nbsp;2.3.4</a> and <a class="ref" href="#sec:ruby_classes">Section&nbsp;4.4</a>). In particular, by using the Rails library called <em>Active Record</em>, the code in <a class="ref" href="#code:demo_user_model">Listing&nbsp;2.5</a> arranges for <code>User.all</code> to return all the users. (We&rsquo;ll learn about the <code>attr_accessible</code> line in <a class="ref" href="#sec:accessible_attributes">Section&nbsp;6.1.2.2</a>. <em>Note</em>: This line will not appear if you are using Rails&nbsp;3.2.2 or earlier.)</p>

<div class="label" id="code:demo_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.5.</span> <span class="description">The User model for the demo application. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:name</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Once the <code>@users</code> variable is defined, the controller calls the <em>view</em> (Step&nbsp;6), shown in <a class="ref" href="#code:demo_index_view">Listing&nbsp;2.6</a>. Variables that start with the <code>@</code>&nbsp;sign, called <em>instance variables</em>, are automatically available in the view; in this case, the <code>index.html.erb</code> view in <a class="ref" href="#code:demo_index_view">Listing&nbsp;2.6</a> iterates through the <code>@users</code> list and outputs a line of HTML for each one. (Remember, you aren&rsquo;t supposed to understand this code right now. It is shown only for purposes of illustration.)</p>

<div class="label" id="code:demo_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.6.</span> <span class="description">The view for the user index. <br /> <code>app/views/users/index.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Listing users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Email<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>

<span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Show&#39;</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Destroy&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s1">&#39;Are you sure?&#39;</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;New User&#39;</span><span class="p">,</span> <span class="n">new_user_path</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>The view converts its contents to HTML (Step&nbsp;7), which is then returned by the controller to the browser for display (Step&nbsp;8).</p>

<div class="label" id="sec:weaknesses_of_this_users_resource"></div>


<h3><a id="sec:2.2.3" href="#sec:weaknesses_of_this_users_resource" class="heading"><span class="number">2.2.3</span> Weaknesses of this Users resource</a></h3>


<p>Though good for getting a general overview of Rails, the scaffold Users resource suffers from a number of severe weaknesses.</p>

<ul>
<li><strong>No data validations.</strong> Our User model accepts data such as blank names and invalid email addresses without complaint.</li>
<li><strong>No authentication.</strong> We have no notion signing in or out, and no way to prevent any user from performing any operation.</li>
<li><strong>No tests.</strong> This isn&rsquo;t technically true&mdash;the scaffolding includes rudimentary tests&mdash;but the generated tests are ugly and inflexible, and they don&rsquo;t test for data validation, authentication, or any other custom requirements.</li>
<li><strong>No layout.</strong> There is no consistent site styling or navigation.</li>
<li><strong>No real understanding.</strong> If you understand the scaffold code, you probably shouldn&rsquo;t be reading this book.</li>
</ul>




<div class="label" id="sec:microposts_resource"></div>


<h2><a id="sec:2.3" href="#sec:microposts_resource" class="heading"><span class="number">2.3</span> The Microposts resource</a></h2>


<p>Having generated and explored the Users resource, we turn now to the associated Microposts resource. Throughout this section, I recommend comparing the elements of the Microposts resource with the analogous user elements from <a class="ref" href="#sec:demo_users_resource">Section&nbsp;2.2</a>; you should see that the two resources parallel each other in many ways. The RESTful structure of Rails applications is best absorbed by this sort of repetition of form; indeed, seeing the parallel structure of Users and Microposts even at this early stage is one of the prime motivations for this chapter. (As we&rsquo;ll see, writing applications more robust than the toy example in this chapter takes considerable effort&mdash;we won&rsquo;t see the Microposts resource again until <a class="ref" href="#cha:user_microposts">Chapter&nbsp;10</a>&mdash;and I didn&rsquo;t want to defer its first appearance quite that far.)</p>

<div class="label" id="sec:a_micropost_microtour"></div>


<h3><a id="sec:2.3.1" href="#sec:a_micropost_microtour" class="heading"><span class="number">2.3.1</span> A micropost microtour</a></h3>


<p>As with the Users resource, we&rsquo;ll generate scaffold code for the Microposts resource using <code>rails generate scaffold</code>, in this case implementing the data model from <a class="ref" href="#fig:demo_micropost_model">Figure&nbsp;2.3</a>:<sup class="footnote" id="fnref:2.5"><a href="#fn:2.5">5</a></sup></p>

<div class="code"><div class="highlight"><pre>$ rails generate scaffold Micropost content:string user_id:integer
      invoke  active_record
      create    db/migrate/20111123225811_create_microposts.rb
      create    app/models/micropost.rb
      invoke    test_unit
      create      test/unit/micropost_test.rb
      create      test/fixtures/microposts.yml
       route  resources :microposts
      invoke  scaffold_controller
      create    app/controllers/microposts_controller.rb
      invoke    erb
      create      app/views/microposts
      create      app/views/microposts/index.html.erb
      create      app/views/microposts/edit.html.erb
      create      app/views/microposts/show.html.erb
      create      app/views/microposts/new.html.erb
      create      app/views/microposts/_form.html.erb
      invoke    test_unit
      create      test/functional/microposts_controller_test.rb
      invoke    helper
      create      app/helpers/microposts_helper.rb
      invoke      test_unit
      create        test/unit/helpers/microposts_helper_test.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/microposts.js.coffee
      invoke    scss
      create      app/assets/stylesheets/microposts.css.scss
      invoke  scss
   identical    app/assets/stylesheets/scaffolds.css.scss
</pre></div>
</div>


<p>To update our database with the new data model, we need to run a migration as in <a class="ref" href="#sec:demo_users_resource">Section&nbsp;2.2</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="go">==  CreateMicroposts: migrating ===============================================</span>
<span class="go">-- create_table(:microposts)</span>
<span class="go">   -&gt; 0.0023s</span>
<span class="go">==  CreateMicroposts: migrated (0.0026s) ======================================</span>
</pre></div>
</div>


<p>Now we are in a position to create microposts in the same way we created users in <a class="ref" href="#sec:a_user_tour">Section&nbsp;2.2.1</a>. As you might guess, the scaffold generator has updated the Rails routes file with a rule for Microposts resource, as seen in <a class="ref" href="#code:demo_microposts_resource">Listing&nbsp;2.7</a>.<sup class="footnote" id="fnref:2.6"><a href="#fn:2.6">6</a></sup> As with users, the <code>resources :microposts</code> routing rule maps micropost URIs to actions in the Microposts controller, as seen in <a class="ref" href="#table:demo_RESTful_microposts">Table&nbsp;2.3</a>.</p>

<div class="label" id="code:demo_microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.7.</span> <span class="description">The Rails routes, with a new rule for Microposts resources. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">DemoApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:microposts</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table:demo_RESTful_microposts"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>index</code></td><td class="align_left">page to list all microposts</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>show</code></td><td class="align_left">page to show micropost with id <code>1</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts/new</td><td class="align_left"><code>new</code></td><td class="align_left">page to make a new micropost</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>create</code></td><td class="align_left">create a new micropost</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left">page to edit micropost with id <code>1</code></td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>update</code></td><td class="align_left">update micropost with id <code>1</code></td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">delete micropost with id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 2.3: </span><span class="description">RESTful routes provided by the Microposts resource in <a class="ref" href="#code:demo_microposts_resource">Listing&nbsp;2.7</a>.</span></div></div>


<p>The Microposts controller itself appears in schematic form <a class="ref" href="#code:demo_microposts_controller">Listing&nbsp;2.8</a>. Note that, apart from having <code>MicropostsController</code> in place of <code>UsersController</code>, <a class="ref" href="#code:demo_microposts_controller">Listing&nbsp;2.8</a> is <em>identical</em> to the code in <a class="ref" href="#code:demo_users_controller">Listing&nbsp;2.3</a>. This is a reflection of the REST architecture common to both resources.</p>

<div class="label" id="code:demo_microposts_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.8.</span> <span class="description">The Microposts controller in schematic form. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To make some actual microposts, we enter information at the new microposts page, <a href="http://localhost:3000/microposts/new">/microposts/new</a>, as seen in <a class="ref" href="#fig:demo_new_micropost_rails_3">Figure&nbsp;2.12</a>.</p>

<div class="label" id="fig:demo_new_micropost_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_new_micropost_rails_3.png" alt="demo_new_micropost_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.12: </span><span class="description">The new micropost page (<a href="http://localhost:3000/microposts/new">/microposts/new</a>).&nbsp;<a href="http://railstutorial.org/images/figures/demo_new_micropost-full.png">(full size)</a></span></div></div>


<p>At this point, go ahead and create a micropost or two, taking care to make sure that at least one has a <code>user_id</code> of&nbsp;<code>1</code> to match the id of the first user created in <a class="ref" href="#sec:a_user_tour">Section&nbsp;2.2.1</a>. The result should look something like <a class="ref" href="#fig:demo_micropost_index_rails_3">Figure&nbsp;2.13</a>.</p>

<div class="label" id="fig:demo_micropost_index_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_micropost_index_rails_3.png" alt="demo_micropost_index_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.13: </span><span class="description">The micropost index page (<a href="http://localhost:3000/microposts">/microposts</a>).&nbsp;<a href="http://railstutorial.org/images/figures/demo_micropost_index_rails_3-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:putting_the_micro_in_microposts"></div>


<h3><a id="sec:2.3.2" href="#sec:putting_the_micro_in_microposts" class="heading"><span class="number">2.3.2</span> Putting the <em>micro</em> in microposts</a></h3>


<p>Any <em>micro</em>post worthy of the name should have some means of enforcing the length of the post. Implementing this constraint in Rails is easy with <em>validations</em>; to accept microposts with at most 140 characters (&agrave; la Twitter), we use a <em>length</em> validation. At this point, you should open the file <code>app/models/micropost.rb</code> in your text editor or IDE and fill it with the contents of <a class="ref" href="#code:demo_length_validation">Listing&nbsp;2.9</a>. (The use of <code>validates</code> in <a class="ref" href="#code:demo_length_validation">Listing&nbsp;2.9</a> is characteristic of Rails&nbsp;3; if you&rsquo;ve previously worked with Rails&nbsp;2.3, you should compare this to the use of <code>validates_length_of</code>.)</p>

<div class="label" id="code:demo_length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.9.</span> <span class="description">Constraining microposts to be at most 140 characters. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:demo_length_validation">Listing&nbsp;2.9</a> may look rather mysterious&mdash;we&rsquo;ll cover validations more thoroughly starting in <a class="ref" href="#sec:user_validations">Section&nbsp;6.2</a>&mdash;but its effects are readily apparent if we go to the new micropost page and enter more than 140 characters for the content of the post. As seen in <a class="ref" href="#fig:micropost_length_error_rails_3">Figure&nbsp;2.14</a>, Rails renders <em>error messages</em> indicating that the micropost&rsquo;s content is too long. (We&rsquo;ll learn more about error messages in <a class="ref" href="#sec:signup_error_messages">Section&nbsp;7.3.2</a>.)</p>

<div class="label" id="fig:micropost_length_error_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_length_error_rails_3.png" alt="micropost_length_error_rails_3" /></span></div><div class="caption"><span class="header">Figure 2.14: </span><span class="description">Error messages for a failed micropost creation.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_length_error_rails_3-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:demo_user_has_many_microposts"></div>


<h3><a id="sec:2.3.3" href="#sec:demo_user_has_many_microposts" class="heading"><span class="number">2.3.3</span> A user <tt>has_many</tt> microposts</a></h3>


<p>One of the most powerful features of Rails is the ability to form <em>associations</em> between different data models. In the case of our User model, each user potentially has many microposts. We can express this in code by updating the User and Micropost models as in <a class="ref" href="#code:demo_user_has_many_microposts">Listing&nbsp;2.10</a> and <a class="ref" href="#code:demo_micropost_belongs_to_user">Listing&nbsp;2.11</a>.</p>

<div class="label" id="code:demo_user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.10.</span> <span class="description">A user has many microposts. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:name</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:demo_micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.11.</span> <span class="description">A micropost belongs to a user. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can visualize the result of this association in <a class="ref" href="#fig:micropost_user_association">Figure&nbsp;2.15</a>. Because of the <code>user_id</code> column in the <code>microposts</code> table, Rails (using Active Record) can infer the microposts associated with each user.</p>

<div class="label" id="fig:micropost_user_association"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_user_association.png" alt="micropost_user_association" /></span></div><div class="caption"><span class="header">Figure 2.15: </span><span class="description">The association between microposts and users.</span></div></div>


<p>In <a class="ref" href="#cha:user_microposts">Chapter&nbsp;10</a> and <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>, we will use the association of users and microposts both to display all a user&rsquo;s microposts and to construct a Twitter-like micropost feed. For now, we can examine the implications of the user-micropost association by using the <em>console</em>, which is a useful tool for interacting with Rails applications. We first invoke the console with <code>rails console</code> at the command line, and then retrieve the first user from the database using <code>User.first</code> (putting the results in the variable <code>first_user</code>):<sup class="footnote" id="fnref:2.7"><a href="#fn:2.7">7</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">first_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;michael@example.org&quot;,</span>
<span class="go">created_at: &quot;2011-11-03 02:01:31&quot;, updated_at: &quot;2011-11-03 02:01:31&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">first_user</span><span class="o">.</span><span class="n">microposts</span>
<span class="go">=&gt; [#&lt;Micropost id: 1, content: &quot;First micropost!&quot;, user_id: 1, created_at:</span>
<span class="go">&quot;2011-11-03 02:37:37&quot;, updated_at: &quot;2011-11-03 02:37:37&quot;&gt;, #&lt;Micropost id: 2,</span>
<span class="go">content: &quot;Second micropost&quot;, user_id: 1, created_at: &quot;2011-11-03 02:38:54&quot;,</span>
<span class="go">updated_at: &quot;2011-11-03 02:38:54&quot;&gt;]</span>
<span class="gp">&gt;&gt; </span><span class="nb">exit</span>
</pre></div>
</div>


<p>(I include the last line just to demonstrate how to exit the console, and on most systems you can Ctrl-d for the same purpose.) Here we have accessed the user&rsquo;s microposts using the code <code>first_user.microposts</code>: with this code, Active Record automatically returns all the microposts with <code>user_id</code> equal to the id of <code>first_user</code> (in this case,&nbsp;<code>1</code>). We&rsquo;ll learn much more about the association facilities in Active Record in <a class="ref" href="#cha:user_microposts">Chapter&nbsp;10</a> and <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>.</p>

<div class="label" id="sec:inheritance_hierarchies"></div>


<h3><a id="sec:2.3.4" href="#sec:inheritance_hierarchies" class="heading"><span class="number">2.3.4</span> Inheritance hierarchies</a></h3>


<p>We end our discussion of the demo application with a brief description of the controller and model class hierarchies in Rails. This discussion will only make much sense if you have some experience with object-oriented programming (OOP); if you haven&rsquo;t studied OOP, feel free to skip this section. In particular, if you are unfamiliar with <em>classes</em> (discussed in <a class="ref" href="#sec:ruby_classes">Section&nbsp;4.4</a>), I suggest looping back to this section at a later time.</p>

<p>We start with the inheritance structure for models. Comparing  <a class="ref" href="#code:demo_user_class">Listing&nbsp;2.12</a> and <a class="ref" href="#code:demo_micropost_class">Listing&nbsp;2.13</a>, we see that both the User model and the Micropost model inherit (via the left angle bracket&nbsp;<code>&lt;</code>) from <code>ActiveRecord::Base</code>, which is the base class for models provided by ActiveRecord; a diagram summarizing this relationship appears in <a class="ref" href="#fig:demo_model_inheritance">Figure&nbsp;2.16</a>. It is by inheriting from <code>ActiveRecord::Base</code> that our model objects gain the ability to communicate with the database, treat the database columns as Ruby attributes, and so&nbsp;on.</p>

<div class="label" id="code:demo_user_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.12.</span> <span class="description">The <code>User</code> class, with inheritance. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:demo_micropost_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.13.</span> <span class="description">The <code>Micropost</code> class, with inheritance. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:demo_model_inheritance"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_model_inheritance.png" alt="demo_model_inheritance" /></span></div><div class="caption"><span class="header">Figure 2.16: </span><span class="description">The inheritance hierarchy for the User and Micropost models.</span></div></div>


<p>The inheritance structure for controllers is only slightly more complicated. Comparing <a class="ref" href="#code:demo_users_controller_class">Listing&nbsp;2.14</a> and <a class="ref" href="#code:demo_microposts_controller_class">Listing&nbsp;2.15</a>, we see that both the Users controller and the Microposts controller inherit from the Application controller. Examining <a class="ref" href="#code:demo_application_controller_class">Listing&nbsp;2.16</a>, we see that <code>ApplicationController</code> itself inherits from <code>ActionController::Base</code>; this is the base class for controllers provided by the Rails library Action Pack. The relationships between these classes is illustrated in <a class="ref" href="#fig:demo_controller_inheritance">Figure&nbsp;2.17</a>.</p>

<div class="label" id="code:demo_users_controller_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.14.</span> <span class="description">The <code>UsersController</code> class, with inheritance. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:demo_microposts_controller_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.15.</span> <span class="description">The <code>MicropostsController</code> class, with inheritance. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:demo_application_controller_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 2.16.</span> <span class="description">The <code>ApplicationController</code> class, with inheritance. <br /> <code>app/controllers/application_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:demo_controller_inheritance"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_controller_inheritance.png" alt="demo_controller_inheritance" /></span></div><div class="caption"><span class="header">Figure 2.17: </span><span class="description">The inheritance hierarchy for the Users and Microposts controllers.</span></div></div>


<p>As with model inheritance, by inheriting ultimately from <code>ActionController::Base</code> both the Users and Microposts controllers gain a large amount of functionality, such as the ability to manipulate model objects, filter inbound HTTP requests, and render views as HTML. Since all Rails controllers inherit from <code>ApplicationController</code>, rules defined in the Application controller automatically apply to every action in the application. For example, in <a class="ref" href="#sec:remember_me">Section&nbsp;8.2.1</a> we&rsquo;ll see how to include helpers for signing in and signing out of all of the sample application&rsquo;s controllers.</p>

<div class="label" id="sec:deploying_the_demo_app"></div>


<h3><a id="sec:2.3.5" href="#sec:deploying_the_demo_app" class="heading"><span class="number">2.3.5</span> Deploying the demo app</a></h3>


<p>With the completion of the Microposts resource, now is a good time to push the repository up to GitHub:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish demo app&quot;</span>
<span class="gp">$</span> git push
</pre></div>
</div>


<p>Ordinarily, you should make smaller, more frequent commits, but for the purposes of this chapter a single big commit at the end is fine.</p>

<p>At this point, you can also deploy the demo app to Heroku as in <a class="ref" href="#sec:deploying">Section&nbsp;1.4</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create --stack cedar
<span class="gp">$</span> git push heroku master
</pre></div>
</div>


<p>Finally, migrate the production database (see below if you get a deprecation warning):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>This updates the database at Heroku with the necessary user/micropost data model. You may get a deprecation warning regarding assets in <code>vendor/plugins</code>, which you should ignore since there aren&rsquo;t any plugins in that directory.</p>

<h2><a id="sec:2.4" href="#sec:2.4" class="heading"><span class="number">2.4</span> Conclusion</a></h2>


<p>We&rsquo;ve come now to the end of the 30,000-foot view of a Rails application. The demo app developed in this chapter has several strengths and a host of weaknesses. <br /></p>

<p><strong>Strengths</strong></p>

<ul>
<li>High-level overview of Rails</li>
<li>Introduction to MVC</li>
<li>First taste of the REST architecture</li>
<li>Beginning data modeling</li>
<li>A live, database-backed web application in production</li>
</ul>


<p><strong>Weaknesses</strong></p>

<ul>
<li>No custom layout or styling</li>
<li>No static pages (like &ldquo;Home&rdquo; or &ldquo;About&rdquo;)</li>
<li>No user passwords</li>
<li>No user images</li>
<li>No signing in</li>
<li>No security</li>
<li>No automatic user/micropost association</li>
<li>No notion of &ldquo;following&rdquo; or &ldquo;followed&rdquo;</li>
<li>No micropost feed</li>
<li>No test-driven development</li>
<li><strong>No real understanding</strong></li>
</ul>


<p>The rest of this tutorial is dedicated to building on the strengths and eliminating the weaknesses.</p>

<div class="footnotes">
<ol>
<li id="fn:2.1">When modeling longer posts, such as those for a normal (non-micro) blog, you should use the <code>text</code> type in place of <code>string</code>.&nbsp;<a class="arrow" href="#fnref:2.1">&uarr;</a></li>
<li id="fn:2.2">The name of the scaffold follows the convention of <em>models</em>, which are singular, rather than resources and controllers, which are plural. Thus, we have <code>User</code> instead <code>Users</code>.&nbsp;<a class="arrow" href="#fnref:2.2">&uarr;</a></li>
<li id="fn:2.3">Some references indicate that the view returns the HTML directly to the browser (via a web server such as Apache or Nginx). Regardless of the implementation details, I prefer to think of the controller as a central hub through which all the application&rsquo;s information flows.&nbsp;<a class="arrow" href="#fnref:2.3">&uarr;</a></li>
<li id="fn:2.4">Fielding, Roy Thomas. <em>Architectural Styles and the Design of Network-based Software Architectures</em>. Doctoral dissertation, University of California, Irvine, 2000.&nbsp;<a class="arrow" href="#fnref:2.4">&uarr;</a></li>
<li id="fn:2.5">As with the User scaffold, the scaffold generator for microposts follows the singular convention of Rails models; thus, we have <code>generate Micropost</code>.&nbsp;<a class="arrow" href="#fnref:2.5">&uarr;</a></li>
<li id="fn:2.6">The scaffold code may have extra newlines compared to <a class="ref" href="#code:demo_microposts_resource">Listing&nbsp;2.7</a>. This is not a cause for concern, as Ruby ignores extra newlines.&nbsp;<a class="arrow" href="#fnref:2.6">&uarr;</a></li>
<li id="fn:2.7">Your console prompt might be something like <code>ruby-1.9.3-head &gt;</code>, but the examples use&nbsp;<tt class="verb">&gt;&gt;</tt> since Ruby versions will vary.&nbsp;<a class="arrow" href="#fnref:2.7">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:static_pages"></div>


<h1 class="chapter"><a id="sec:3" href="#cha:static_pages" class="heading"><span class="number">Chapter 3</span> Mostly static pages</a></h1>


<p>In this chapter, we will begin developing the sample application that will serve as our example throughout the rest of this tutorial. Although the sample app will eventually have users, microposts, and a full login and authentication framework, we will begin with a seemingly limited topic: the creation of static pages. Despite its apparent simplicity, making static pages is a highly instructive exercise, rich in implications&mdash;a perfect start for our nascent application.</p>

<p>Although Rails is designed for making database-backed dynamic websites, it also excels at making the kind of static pages we might make with raw HTML files. In fact, using Rails even for static pages yields a distinct advantage: we can easily add just a <em>small</em> amount of dynamic content. In this chapter we&rsquo;ll learn how. Along the way, we&rsquo;ll get our first taste of <em>automated testing</em>, which will help us be more confident that our code is correct. Moreover, having a good test suite will allow us to <em>refactor</em> our code with confidence, changing its form without changing its function.</p>

<p>There&rsquo;s a lot of code in this chapter, especially in <a class="ref" href="#sec:first_tests">Section&nbsp;3.2</a> and <a class="ref" href="#sec:slightly_dynamic_pages">Section&nbsp;3.3</a>, and if you&rsquo;re new to Ruby you shouldn&rsquo;t worry about understanding the details right now. As noted in <a class="ref" href="#sec:comments_for_various_readers">Section&nbsp;1.1.1</a>, one strategy is to copy-and-paste the tests and use them to verify the application code, without worrying at this point how they work. In addition, <a class="ref" href="#cha:rails_flavored_ruby">Chapter&nbsp;4</a> covers Ruby in more depth, so there is plenty of opportunity for these ideas to sink in. Finally, RSpec tests will recur throughout the tutorial, so if you get stuck now I recommend forging ahead; you&rsquo;ll be amazed how, after just a few more chapters, initially inscrutable code will suddenly look simple.</p>

<p>As in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>, before getting started we need to create a new Rails project, this time called <code>sample_app</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects
<span class="gp">$</span> rails new sample_app --skip-test-unit
<span class="gp">$</span> <span class="nb">cd </span>sample_app
</pre></div>
</div>


<p>Here the <tt class="verb">--skip-test-unit</tt> option to the <code>rails</code> command tells Rails not to generate a <code>test</code> directory associated with the default <code>Test::Unit</code> framework. This is not because we won&rsquo;t be writing tests; on the contrary, starting in <a class="ref" href="#sec:first_tests">Section&nbsp;3.2</a> we will be using an alternate testing framework called <em>RSpec</em> to write a thorough test suite.</p>

<p>As in <a class="ref" href="#sec:planning_the_application">Section&nbsp;2.1</a>, our next step is to use a text editor to update the <code>Gemfile</code> with the gems needed by our application. On the other hand, for the sample application we&rsquo;ll also need two gems we didn&rsquo;t need before: the gem for RSpec and the gem for the RSpec library specific to Rails. The code to include them is shown in <a class="ref" href="#code:gemfile_rspec">Listing&nbsp;3.1</a>. (<em>Note</em>: If you would like to install <em>all</em> the gems needed for the sample application, you should use the code in <a class="ref" href="#code:final_gemfile">Listing&nbsp;9.49</a> at this time.)</p>

<div class="label" id="code:gemfile_rspec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.1.</span> <span class="description">A <code>Gemfile</code> for the sample app.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.10.0&#39;</span>
<span class="k">end</span>

<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This includes <tt>rspec-rails</tt> in development mode so that we have access to RSpec-specific generators, and it includes it in test mode in order to run the tests. We don&rsquo;t have to install RSpec itself because it is a dependency of <tt>rspec-rails</tt> and will thus be installed automatically. We also include the <a href="https://github.com/jnicklas/capybara">Capybara gem</a>, which allows us to simulate a user&rsquo;s interaction with the sample application using a natural English-like syntax.<sup class="footnote" id="fnref:3.1"><a href="#fn:3.1">1</a></sup> As in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>, we also must include the PostgreSQL gem in production for deployment to Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Heroku recommends against using different databases in development and production, but for the sample application it won&rsquo;t make any difference, and SQLite is <em>much</em> easier than PostgreSQL to install and configure. Installing and configuring PostgreSQL on your local machine is left as an exercise (<a class="ref" href="#sec:static_pages_exercises">Section&nbsp;3.5</a>).</p>

<p>To install and include the new gems, we run <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --without production
</pre></div>
</div>


<p>As in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>, we suppress the installation of production gems using the option <tt class="verb">--without</tt> <tt class="verb">production</tt>. This is a &ldquo;remembered option&rdquo;, which means that we don&rsquo;t have to include it in future invocations of Bundler. Instead, we can write simply <code>bundle install</code>.<sup class="footnote" id="fnref:3.2"><a href="#fn:3.2">2</a></sup></p>

<p>Next, we need to configure Rails to use RSpec in place of <code>Test::Unit</code>. This can be accomplished with <code>rails generate rspec:install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate rspec:install
</pre></div>
</div>


<p>If your system complains about the lack of a JavaScript runtime, visit the <a href="https://github.com/sstephenson/execjs">execjs page at GitHub</a> for a list of possibilities. I particularly recommend installing <a href="http://nodejs.org/">Node.js</a>.</p>

<p>With that, all we have left is to initialize the Git repository:<sup class="footnote" id="fnref:3.3"><a href="#fn:3.3">3</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Initial commit&quot;</span>
</pre></div>
</div>


<p>As with the first application, I suggest updating the <code>README</code> file (located in the root directory of the application) to be more helpful and descriptive, as shown in <a class="ref" href="#code:sample_app_readme">Listing&nbsp;3.2</a>.</p>

<div class="label" id="code:sample_app_readme"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.2.</span> <span class="description">An improved <code>README</code> file for the sample app.</span>       
</div>
<div class="code"><div class="highlight"><pre># Ruby on Rails Tutorial: sample application

This is the sample application for
[*Ruby on Rails Tutorial: Learn Rails by Example*](http://railstutorial.org/)
by [Michael Hartl](http://michaelhartl.com/).
</pre></div>
</div></div>


<p>Then change it to use the Markdown extension&nbsp;<code>.md</code> and commit the changes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README.rdoc README.md
<span class="gp">$</span> git commit -a -m <span class="s2">&quot;Improve the README&quot;</span>
</pre></div>
</div>




<div class="label" id="fig:create_repository"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/create_repository_new.png" alt="create_repository_new" /></span></div><div class="caption"><span class="header">Figure 3.1: </span><span class="description">Creating the sample app repository at GitHub.&nbsp;<a href="http://railstutorial.org/images/figures/create_repository_new-full.png">(full size)</a></span></div></div>


<p>Since we&rsquo;ll be using this sample app throughout the rest of the book, it&rsquo;s a good idea to make a repository at GitHub (<a class="ref" href="#fig:create_repository">Figure&nbsp;3.1</a>) and push it up:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:&lt;username&gt;/sample_app.git
<span class="gp">$</span> git push -u origin master
</pre></div>
</div>


<p>As a result of my performing this step, you can find the <a href="https://github.com/railstutorial/sample_app_2nd_ed">Rails Tutorial sample application code on GitHub</a> (under a slightly different name).<sup class="footnote" id="fnref:3.4"><a href="#fn:3.4">4</a></sup></p>

<p>Of course, we can optionally deploy the app to Heroku even at this early stage:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create --stack cedar
<span class="gp">$</span> git push heroku master
</pre></div>
</div>


<p>As you proceed through the rest of the book, I recommend pushing and deploying the application regularly:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>This provides remote backups and lets you catch any production errors as soon as possible. If you run into problems at Heroku, make sure to take a look at the production logs to try to diagnose the problem:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>With all the preparation finished, we&rsquo;re finally ready to get started developing the sample application.</p>

<div class="label" id="sec:static_pages"></div>


<h2><a id="sec:3.1" href="#sec:static_pages" class="heading"><span class="number">3.1</span> Static pages</a></h2>


<p>Rails has two main ways of making static web pages. First, Rails can handle <em>truly</em> static pages consisting of raw HTML files. Second, Rails allows us to define <em>views</em> containing raw HTML, which Rails can <em>render</em> so that the web server can send it to the browser.</p>

<p>In order to get our bearings, it&rsquo;s helpful to recall the Rails directory structure from <a class="ref" href="#sec:the_first_application">Section&nbsp;1.2.3</a> (<a class="ref" href="#fig:directory_structure_rails_3_2">Figure&nbsp;1.2</a>). In this section, we&rsquo;ll be working mainly in the <code>app/controllers</code> and <code>app/views</code> directories. (In <a class="ref" href="#sec:first_tests">Section&nbsp;3.2</a>, we&rsquo;ll even add a new directory of our own.)</p>

<p>This is the first section where it&rsquo;s useful to be able to open the entire Rails directory in your text editor or IDE. Unfortunately, how to do this is system-dependent, but in many cases you can open the current application directory, represented in Unix by a dot&nbsp;<code>.</code>, using the command-line command for your editor of choice:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects/sample_app
<span class="gp">$</span> &lt;editor name&gt; .
</pre></div>
</div>


<p>For example, to open the sample app in Sublime Text, you type</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl .
</pre></div>
</div>


<p>For Vim, you type <code>vim .</code>, <code>gvim .</code>, or <code>mvim .</code> depending on which flavor of Vim you use.</p>

<div class="label" id="sec:truly_static_pages"></div>


<h3><a id="sec:3.1.1" href="#sec:truly_static_pages" class="heading"><span class="number">3.1.1</span> Truly static pages</a></h3>


<p>We start with truly static pages. Recall from <a class="ref" href="#sec:rails_server">Section&nbsp;1.2.5</a> that every Rails application comes with a minimal working application thanks to the <code>rails</code> script, with a default welcome page at the address <a href="http://localhost:3000/">http://localhost:3000/</a> (<a class="ref" href="#fig:riding_rails_31">Figure&nbsp;1.3</a>).</p>

<div class="label" id="fig:public_index_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/public_index_rails_3.png" alt="public_index_rails_3" /></span></div><div class="caption"><span class="header">Figure 3.2: </span><span class="description">The <code>public/index.html</code> file.&nbsp;<a href="http://railstutorial.org/images/figures/public_index_rails_3-full.png">(full size)</a></span></div></div>


<p>To learn where this page comes from, take a look at the file <code>public/index.html</code> (<a class="ref" href="#fig:public_index_rails_3">Figure&nbsp;3.2</a>). Because the file contains its own stylesheet information, it&rsquo;s a little messy, but it gets the job done: by default, Rails serves any files in the <code>public</code> directory directly to the browser.<sup class="footnote" id="fnref:3.5"><a href="#fn:3.5">5</a></sup> In the case of the special <code>index.html</code> file, you don&rsquo;t even have to indicate the file in the URI, as <code>index.html</code> is the default. You can include it if you want, though; the addresses http://localhost:3000/ http://localhost:3000/index.html are equivalent.</p>

<p>As you might expect, if we want we can make our own static HTML files and put them in the same <code>public</code> directory as <code>index.html</code>. For example, let&rsquo;s create a file with a friendly greeting (<a class="ref" href="#code:hello_world">Listing&nbsp;3.3</a>):<sup class="footnote" id="fnref:3.6"><a href="#fn:3.6">6</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl public/hello.html
</pre></div>
</div>


<div class="label" id="code:hello_world"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.3.</span> <span class="description">A typical HTML file, with a friendly greeting. <br /> <code>public/hello.html</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Greeting<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>Hello, world!<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>We see in <a class="ref" href="#code:hello_world">Listing&nbsp;3.3</a> the typical structure of an HTML document: a <em>document type</em>, or doctype, declaration at the top to tell browsers which version of HTML we&rsquo;re using (in this case, <a href="http://en.wikipedia.org/wiki/HTML5">HTML5</a>);<sup class="footnote" id="fnref:3.7"><a href="#fn:3.7">7</a></sup> a <code>head</code> section, in this case with &ldquo;Greeting&rdquo; inside a <code>title</code> tag; and a <code>body</code> section, in this case with &ldquo;Hello, world!&rdquo; inside a <code>p</code> (paragraph) tag. (The indentation is optional&mdash;HTML is not sensitive to whitespace, and ignores both tabs and spaces&mdash;but it makes the document&rsquo;s structure easier to see.)</p>

<p>Now run a local server using</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server
</pre></div>
</div>


<p>and navigate to <a href="http://localhost:3000/hello.html">http://localhost:3000/hello.html</a>. As promised, Rails renders the page straightaway (<a class="ref" href="#fig:hello_world">Figure&nbsp;3.3</a>). Note that the title displayed at the top of the browser window in <a class="ref" href="#fig:hello_world">Figure&nbsp;3.3</a> is just the contents inside the <code>title</code> tag, namely, &ldquo;Greeting&rdquo;.</p>

<div class="label" id="fig:hello_world"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/hello_world.png" alt="hello_world" /></span></div><div class="caption"><span class="header">Figure 3.3: </span><span class="description">A new static HTML file.&nbsp;<a href="http://railstutorial.org/images/figures/hello_world-full.png">(full size)</a></span></div></div>


<p>Since this file is just for demonstration purposes, we don&rsquo;t really want it to be part of our sample application, so it&rsquo;s probably best to remove it once the thrill of creating it has worn off:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm public/hello.html
</pre></div>
</div>


<p>We&rsquo;ll leave the <code>index.html</code> file alone for now, but of course eventually we should remove it: we don&rsquo;t want the root of our application to be the Rails default page shown in <a class="ref" href="#fig:riding_rails_31">Figure&nbsp;1.3</a>. We&rsquo;ll see in <a class="ref" href="#sec:layout_links">Section&nbsp;5.3</a> how to change the address <a href="http://localhost:3000/">http://localhost:3000/</a> to point to something other than <code>public/index.html</code>.</p>

<div class="label" id="sec:static_pages_with_rails"></div>


<h3><a id="sec:3.1.2" href="#sec:static_pages_with_rails" class="heading"><span class="number">3.1.2</span> Static pages with Rails</a></h3>


<p>The ability to return static HTML files is nice, but it&rsquo;s not particularly useful for making dynamic web applications. In this section, we&rsquo;ll take a first step toward making dynamic pages by creating a set of Rails <em>actions</em>, which are a more powerful way to define URIs than static files.<sup class="footnote" id="fnref:3.8"><a href="#fn:3.8">8</a></sup> Rails actions come bundled together inside <em>controllers</em> (the C in MVC from <a class="ref" href="#sec:mvc">Section&nbsp;1.2.6</a>), which contain sets of actions related by a common purpose. We got a glimpse of controllers in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>, and will come to a deeper understanding once we explore the <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST architecture</a> more fully (starting in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>); in essence, a controller is a container for a group of (possibly dynamic) web pages.</p>

<p>To get started, recall from <a class="ref" href="#sec:git_commands">Section&nbsp;1.3.5</a> that, when using Git, it&rsquo;s a good practice to do our work on a separate topic branch rather than the master branch. If you&rsquo;re using Git for version control, you should run the following command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b static-pages
</pre></div>
</div>


<p>Rails comes with a script for making controllers called <code>generate</code>; all it needs to work its magic is the controller&rsquo;s name. In order to use <code>generate</code> with RSpec, you need to run the RSpec generator command if you didn&rsquo;t run it when following the introduction to this chapter:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate rspec:install
</pre></div>
</div>


<p>Since we&rsquo;ll be making a controller to handle static pages, we&rsquo;ll call it the StaticPages controller. We&rsquo;ll also plan to make actions for a Home page, a Help page, and an About page. The <code>generate</code> script takes an optional list of actions, so we&rsquo;ll include two of the initial actions directly on the command line (<a class="ref" href="#code:generating_pages">Listing&nbsp;3.4</a>).</p>

<div class="label" id="code:generating_pages"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.4.</span> <span class="description">Generating a StaticPages controller.</span>       
</div>
<div class="code"><div class="highlight"><pre>$ rails generate controller StaticPages home help --no-test-framework
      create  app/controllers/static_pages_controller.rb
       route  get &quot;static_pages/help&quot;
       route  get &quot;static_pages/home&quot;
      invoke  erb
      create    app/views/static_pages
      create    app/views/static_pages/home.html.erb
      create    app/views/static_pages/help.html.erb
      invoke  helper
      create    app/helpers/static_pages_helper.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/static_pages.js.coffee
      invoke    scss
      create      app/assets/stylesheets/static_pages.css.scss
</pre></div>
</div></div>


<p>Note that we&rsquo;ve used the option <tt class="verb">--no-test-framework</tt> to suppress the generation of the default RSpec tests, which we won&rsquo;t be using. Instead, we&rsquo;ll create the tests by hand starting in <a class="ref" href="#sec:first_tests">Section&nbsp;3.2</a>. We&rsquo;ve also intentionally left off the <code>about</code> action from the command line arguments in <a class="ref" href="#code:generating_pages">Listing&nbsp;3.4</a> so that we can see how to add it using test-driven development, or TDD (<a class="ref" href="#sec:first_tests">Section&nbsp;3.2</a>).</p>

<p>By the way, if you ever make a mistake when generating code, it&rsquo;s useful to know how to reverse the process. See <a class="ref" href="#sidebar:undoing_things">Box&nbsp;3.1</a> for some techniques on how to undo things in Rails.</p>

<div class="label" id="sidebar:undoing_things"></div>


<div class="sidebar"><span class="title"><span class="header">Box 3.1.</span><span class="description">Undoing things</span></span>
<p>Even when you&rsquo;re very careful, things can sometimes go wrong when developing Rails applications. Happily, Rails has some facilities to help you recover.</p>

<p>One common scenario is wanting to undo code generation&mdash;for example, if you change your mind on the name of a controller. When generating a controller, Rails creates many more files than the controller file itself (as seen in <a class="ref" href="#code:generating_pages">Listing&nbsp;3.4</a>). Undoing the generation means removing not only the principal generated file, but all the ancillary files as well. (In fact, we also want to undo any automatic edits made to the <tt>routes.rb</tt> file.) In Rails, this can be accomplished with <tt>rails destroy</tt>. In particular, these two commands cancel each other out:</p>

<pre class="verbatim">  $ rails generate controller FooBars baz quux
  $ rails destroy  controller FooBars baz quux</pre>


<p>Similarly, in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a> we&rsquo;ll generate a <em>model</em> as follows:</p>

<pre class="verbatim">  $ rails generate model Foo bar:string baz:integer</pre>


<p>This can be undone using</p>

<pre class="verbatim">  $ rails destroy model Foo</pre>


<p>(In this case, it turns out we can omit the other command-line arguments. When you get to <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>, see if you can figure out why.)</p>

<p>Another technique related to models involves undoing <em>migrations</em>, which we saw briefly in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a> and will see much more of starting in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>. Migrations change the state of the database using</p>

<pre class="verbatim">  $ rake db:migrate</pre>


<p>We can undo a single migration step using</p>

<pre class="verbatim">  $ rake db:rollback</pre>


<p>To go all the way back to the beginning, we can use</p>

<pre class="verbatim">  $ rake db:migrate VERSION=0</pre>


<p>As you might guess, substituting any other number for <tt>0</tt> migrates to that version number, where the version numbers come from listing the migrations sequentially.</p>

<p>With these techniques in hand, we are well-equipped to recover from the inevitable development <a href="http://en.wikipedia.org/wiki/SNAFU">snafus</a>.</p>
</div>


<p>The StaticPages controller generation in <a class="ref" href="#code:generating_pages">Listing&nbsp;3.4</a> automatically updates the <em>routes</em> file, called <code>config/routes.rb</code>, which Rails uses to find the correspondence between URIs and web pages. This is our first encounter with the <code>config</code> directory, so it&rsquo;s helpful to take a quick look at it (<a class="ref" href="#fig:config_directory_rails_3">Figure&nbsp;3.4</a>). The <code>config</code> directory is where Rails collects files needed for the application configuration&mdash;hence the name.</p>

<div class="label" id="fig:config_directory_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/config_directory_rails_3.png" alt="config_directory_rails_3" /></span></div><div class="caption"><span class="header">Figure 3.4: </span><span class="description">Contents of the sample app&rsquo;s <code>config</code> directory.&nbsp;<a href="http://railstutorial.org/images/figures/config_directory_rails_3-full.png">(full size)</a></span></div></div>


<p>Since we generated <code>home</code> and <code>help</code> actions, the routes file already has a rule for each one, as seen in <a class="ref" href="#code:pages_routes">Listing&nbsp;3.5</a>.</p>

<div class="label" id="code:pages_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.5.</span> <span class="description">The routes for the <code>home</code> and <code>help</code> actions in the StaticPages controller. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/help&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here the rule</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
</pre></div>
</div>


<p>maps requests for the URI /static_pages/home to the <code>home</code> action in the StaticPages controller. Moreover, by using <code>get</code> we arrange for the route to respond to a <tt>GET</tt> request, which is one of the fundamental
<em>HTTP verbs</em> supported by the hypertext transfer protocol (<a class="ref" href="#sidebar:get_etc">Box&nbsp;3.2</a>). In our case, this means that when we generate a <code>home</code> action inside the StaticPages controller we automatically get a page at the address /static_pages/home. To see the results, navigate to <a href="http://localhost:3000/static_pages/home">/static_pages/home</a> (<a class="ref" href="#fig:raw_home_view">Figure&nbsp;3.5</a>).</p>

<div class="label" id="fig:raw_home_view"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/raw_home_view_31.png" alt="raw_home_view_31" /></span></div><div class="caption"><span class="header">Figure 3.5: </span><span class="description">The raw home view (<a href="http://localhost:3000/static_pages/home">/static_pages/home</a>).&nbsp;<a href="http://railstutorial.org/images/figures/raw_home_view_31-full.png">(full size)</a></span></div></div>




<div class="label" id="sidebar:get_etc"></div>


<div class="sidebar"><span class="title"><span class="header">Box 3.2.</span><span class="description"><tt>GET</tt>, et cet.</span></span>
<p>The hypertext transfer protocol (<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">HTTP</a>) defines four basic operations, corresponding to the four verbs <em>get</em>, <em>post</em>, <em>put</em>, and <em>delete</em>. These refer to operations between a <em>client</em> computer (typically running a web browser such as Firefox or Safari) and a <em>server</em> (typically running a web server such as Apache or Nginx). (It&rsquo;s important to understand that, when developing Rails applications on a local computer, the client and server are the same physical machine, but in general they are different.) An emphasis on HTTP verbs is typical of web frameworks (including Rails) influenced by the <em>REST architecture</em>, which we saw briefly in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a> and will start learning about more in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>.</p>

<p><tt>GET</tt> is the most common HTTP operation, used for <em>reading</em> data on the web; it just means &ldquo;get a page&rdquo;, and every time you visit a site like google.com or wikipedia.org your browser is submitting a <tt>GET</tt> request. <tt>POST</tt> is the next most common operation; it is the request sent by your browser when you submit a form. In Rails applications, <tt>POST</tt> requests are typically used for <em>creating</em> things (although HTTP also allows <tt>POST</tt> to perform updates); for example, the <tt>POST</tt> request sent when you submit a registration form creates a new user on the remote site. The other two verbs, <tt>PUT</tt> and <tt>DELETE</tt>, are designed for <em>updating</em> and <em>destroying</em> things on the remote server. These requests are less common than <tt>GET</tt> and <tt>POST</tt> since browsers are incapable of sending them natively, but some web frameworks (including Ruby on Rails) have clever ways of making it <em>seem</em> like browsers are issuing such requests.</p>
</div>


<p>To understand where this page comes from, let&rsquo;s start by taking a look at the StaticPages controller in a text editor; you should see something like <a class="ref" href="#code:static_pages_controller">Listing&nbsp;3.6</a>. You may note that, unlike the demo Users and Microposts controllers from <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>, the StaticPages controller does not use the standard REST actions. This is normal for a collection of static pages&mdash;the REST architecture isn&rsquo;t the best solution to every problem.</p>

<div class="label" id="code:static_pages_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.6.</span> <span class="description">The StaticPages controller made by <a class="ref" href="#code:generating_pages">Listing&nbsp;3.4</a>. <br /> <code>app/controllers/static_pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We see from the <code>class</code> keyword in <a class="ref" href="#code:static_pages_controller">Listing&nbsp;3.6</a> that <code>static_pages_controller.rb</code> defines a <em>class</em>, in this case called <code>StaticPagesController</code>. Classes are simply a convenient way to organize <em>functions</em> (also called <em>methods</em>) like the <code>home</code> and <code>help</code> actions, which are defined using the <code>def</code> keyword. The angle bracket&nbsp;<code>&lt;</code> indicates that <code>StaticPagesController</code> <em>inherits</em> from the Rails class <code>ApplicationController</code>; as we&rsquo;ll see momentarily, this means that our pages come equipped with a large amount of Rails-specific functionality. (We&rsquo;ll learn more about both classes and inheritance in <a class="ref" href="#sec:ruby_classes">Section&nbsp;4.4</a>.)</p>

<p>In the case of the StaticPages controller, both its methods are initially empty:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">help</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In plain Ruby, these methods would simply do nothing. In Rails, the situation is different; <code>StaticPagesController</code> is a Ruby class, but because it inherits from <code>ApplicationController</code> the behavior of its methods is specific to Rails: when visiting the URI /static_pages/home, Rails looks in the StaticPages controller and executes the code in the <code>home</code> action, and then renders the <em>view</em> (the V in MVC from <a class="ref" href="#sec:mvc">Section&nbsp;1.2.6</a>) corresponding to the action. In the present case, the <code>home</code> action is empty, so all visiting /static_pages/home does is render the view. So, what does a view look like, and how do we find it?</p>

<p>If you take another look at the output in <a class="ref" href="#code:generating_pages">Listing&nbsp;3.4</a>, you might be able to guess the correspondence between actions and views: an action like <code>home</code> has a corresponding view called <code>home.html.erb</code>. We&rsquo;ll learn in <a class="ref" href="#sec:slightly_dynamic_pages">Section&nbsp;3.3</a> what the <code>.erb</code> part means; from the <code>.html</code> part you probably won&rsquo;t be surprised that it basically looks like HTML (<a class="ref" href="#code:raw_home_view">Listing&nbsp;3.7</a>).</p>

<div class="label" id="code:raw_home_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.7.</span> <span class="description">The generated view for the Home page. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#home<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/home.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>The view for the <code>help</code> action is analogous (<a class="ref" href="#code:raw_help_view">Listing&nbsp;3.8</a>).</p>

<div class="label" id="code:raw_help_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.8.</span> <span class="description">The generated view for the Help page. <br /> <code>app/views/static_pages/help.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/help.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>Both of these views are just placeholders: they have a top-level heading (inside the <code>h1</code> tag) and a paragraph (<code>p</code> tag) with the full path to the relevant file. We&rsquo;ll add some (very slightly) dynamic content starting in <a class="ref" href="#sec:slightly_dynamic_pages">Section&nbsp;3.3</a>, but as they stand these views underscore an important point: Rails views can simply contain static HTML. As far as the browser is concerned, the raw HTML files from <a class="ref" href="#sec:truly_static_pages">Section&nbsp;3.1.1</a> and the controller/action method of delivering pages are indistinguishable: all the browser ever sees is HTML.</p>

<p>In the remainder of this chapter, we&rsquo;ll add some custom content to the Home and Help pages, and then add in the About page we left off in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a>. Then we&rsquo;ll add a very small amount of dynamic content by changing the title on a per-page basis.</p>

<p>Before moving on, if you&rsquo;re using Git it&rsquo;s a good idea to add the files for the StaticPages controller to the repository:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add a StaticPages controller&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:first_tests"></div>


<h2><a id="sec:3.2" href="#sec:first_tests" class="heading"><span class="number">3.2</span> Our first tests</a></h2>


<p>The <em>Rails Tutorial</em> takes an intuitive approach to testing that emphasizes the behavior of the application rather than its precise implementation, a variant of test-driven development (TDD) known as behavior-driven development (BDD). Our main tools will be <em>integration tests</em> (starting in this section) and <em>unit tests</em> (starting in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>). Integration tests, known as <em>request specs</em> in the context of RSpec, allow us to simulate the actions of a user interacting with our application using a web browser. Together with the natural-language syntax provided by Capybara, integration tests provide a powerful method to test our application&rsquo;s functionality without having to manually check each page with a browser. (Another popular choice for BDD, called Cucumber, is introduced in <a class="ref" href="#sec:cucumber">Section&nbsp;8.3</a>.)</p>

<p>The defining quality of TDD is writing tests <em>first</em>, before the application code. Initially, this might take some getting used to, but the benefits are significant. By writing a <em>failing</em> test first and then implementing the application code to get it to pass, we increase our confidence that the test is actually covering the functionality we think it is. Moreover, the fail-implement-pass development cycle induces a <a href="http://en.wikipedia.org/wiki/Flow_(psychology)">flow state</a>, leading to enjoyable coding and high productivity. Finally, the tests act as a <em>client</em> for the application code, often leading to more elegant software designs.</p>

<p>It&rsquo;s important to understand that TDD is not always the right tool for the job: there&rsquo;s no reason to dogmatically insist that tests always should be written first, that they should cover every single feature, or that there should necessarily be any tests at all. For example, when you aren&rsquo;t at all sure how to solve a given programming problem, it&rsquo;s often useful to skip the tests and write only application code, just to get a sense of what the solution will look like. (In the language of <a href="http://en.wikipedia.org/wiki/Extreme_Programming">Extreme Programming (XP)</a>, this exploratory step is called a <em>spike</em>.) Once you see the general shape of the solution, you can then use TDD to implement a more polished version.</p>

<p>In this section, we&rsquo;ll be running the tests using the <code>rspec</code> command supplied by the RSpec gem. This practice is straightforward but not ideal, and if you are a more advanced user I suggest setting up your system as described in <a class="ref" href="#sec:advanced_setup">Section&nbsp;3.6</a>.</p>

<div class="label" id="sec:TDD"></div>


<h3><a id="sec:3.2.1" href="#sec:TDD" class="heading"><span class="number">3.2.1</span> Test-driven development</a></h3>


<p>In test-driven development, we first write a <em>failing</em> test, represented in many testing tools by the color red. We then implement code to get the test to pass, represented by the color green. Finally, if necessary, we refactor the code, changing its form (by eliminating duplication, for example) without changing its function. This cycle is known as &ldquo;Red, Green, Refactor&rdquo;.</p>

<p>We&rsquo;ll begin by adding some content to the Home page using test-driven development, including a top-level heading (<code>&lt;h1&gt;</code>) with the content <code>Sample App</code>. The first step is to generate an integration test (request spec) for our static pages:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test static_pages
<span class="go">      invoke  rspec</span>
<span class="go">      create    spec/requests/static_pages_spec.rb</span>
</pre></div>
</div>


<p>This creates the <code>static_pages_spec.rb</code> in the <code>spec/requests</code> directory. As with most generated code, the result is not pretty, so let&rsquo;s open <code>static_pages_spec.rb</code> with a text editor and replace it with the contents of <a class="ref" href="#code:home_page_content_spec">Listing&nbsp;3.9</a>.</p>

<div class="label" id="code:home_page_content_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.9.</span> <span class="description">Code to test the contents of the Home page. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:home_page_content_spec">Listing&nbsp;3.9</a> is pure Ruby, but even if you&rsquo;ve studied Ruby before it probably won&rsquo;t look very familiar. This is because RSpec uses the general malleability of Ruby to define a <em>domain-specific language</em> (DSL) built just for testing. The important point is that <em>you do not need to understand RSpec&rsquo;s syntax to be able to use RSpec</em>. It may seem like magic at first, but RSpec and Capybara are designed to read more or less like English, and if you follow the examples from the <code>generate</code> script and the other examples in this tutorial you&rsquo;ll pick it up fairly quickly.</p>

<p><a class="ref" href="#code:home_page_content_spec">Listing&nbsp;3.9</a> contains a <code>describe</code> block with one <em>example</em>, i.e., a block starting with <code>it "&hellip;" do</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The first line indicates that we are describing the Home page. This is just a string, and it can be anything you want; RSpec doesn&rsquo;t care, but you and other human readers probably do. Then the spec says that when you visit the Home page at <code>/static_pages/home</code>, the content should contain the words &ldquo;Sample App&rdquo;. As with the first line, what goes inside the quote marks is irrelevant to RSpec, and is intended to be descriptive to human readers. Then the line</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
</pre></div>
</div>


<p>uses the Capybara function <code>visit</code> to simulate visiting the URI <code>/static_pages/home</code> in a browser, while the line</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>uses the <code>page</code> variable (also provided by Capybara) to test that the resulting page has the right content.</p>

<p>To run the test, we have several options, including some convenient but rather advanced tools discussed in <a class="ref" href="#sec:advanced_setup">Section&nbsp;3.6</a>. For now, we&rsquo;ll use the <code>rspec</code> command at the command line (executed with <code>bundle exec</code> to ensure that RSpec runs in the environment specified by our <code>Gemfile</code>):<sup class="footnote" id="fnref:3.9"><a href="#fn:3.9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>This yields a failing test. The appearance of the result depends on your system; on my system, the red failing test appears as in <a class="ref" href="#fig:red_failing_spec">Figure&nbsp;3.6</a>.<sup class="footnote" id="fnref:3.10"><a href="#fn:3.10">10</a></sup> (The screenshot, which predates, the current Git branching strategy, shows work on the <tt>master</tt> branch instead the <tt>static-pages</tt> branch, but this is not cause for concern.)</p>

<div class="label" id="fig:red_failing_spec"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/red_failing_spec.png" alt="red_failing_spec" /></span></div><div class="caption"><span class="header">Figure 3.6: </span><span class="description">A red (failing) test.&nbsp;<a href="http://railstutorial.org/images/figures/red_failing_spec-full.png">(full size)</a></span></div></div>


<p>To get the test to pass, we&rsquo;ll replace the default Home page test with the HTML in <a class="ref" href="#code:home_page_passing">Listing&nbsp;3.10</a>.</p>

<div class="label" id="code:home_page_passing"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.10.</span> <span class="description">Code to get a passing test for the Home page. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>This arranges for a top-level heading (<code>&lt;h1&gt;</code>) with the content <code>Sample App</code>, which should get the test to pass. We also include an <em>anchor</em> tag&nbsp;<code>a</code>, which creates links to the given URI (called an &ldquo;href&rdquo;, or &ldquo;hypertext reference&rdquo;, in the context of an anchor tag):</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>Now re-run the test to see the effect:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>On my system, the passing test appears as in <a class="ref" href="#fig:green_passing_spec">Figure&nbsp;3.7</a>.</p>

<div class="label" id="fig:green_passing_spec"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/green_passing_spec.png" alt="green_passing_spec" /></span></div><div class="caption"><span class="header">Figure 3.7: </span><span class="description">A green (passing) test.&nbsp;<a href="http://railstutorial.org/images/figures/green_passing_spec-full.png">(full size)</a></span></div></div>


<p>Based on the example for the Home page, you can probably guess the analogous test and application code for the Help page. We start by testing for the relevant content, in this case the string <code>&rsquo;Help&rsquo;</code> (<a class="ref" href="#code:help_content_spec">Listing&nbsp;3.11</a>).</p>

<div class="label" id="code:help_content_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.11.</span> <span class="description">Adding code to test the contents of the Help page. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Then run the tests:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>One test should fail. (Since systems will vary, and since keeping track of how many tests there are at each stage of the tutorial is a maintenance nightmare, I&rsquo;ll omit the RSpec output from now on.)</p>

<p>The application code (which for now is raw HTML) is similar to the code in <a class="ref" href="#code:home_page_passing">Listing&nbsp;3.10</a>, as seen in <a class="ref" href="#code:help_page_passing">Listing&nbsp;3.12</a>.</p>

<div class="label" id="code:help_page_passing"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.12.</span> <span class="description">Code to get a passing test for the Help page. <br /> <code>app/views/static_pages/help.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>The tests should now pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<div class="label" id="sec:adding_a_page"></div>


<h3><a id="sec:3.2.2" href="#sec:adding_a_page" class="heading"><span class="number">3.2.2</span> Adding a page</a></h3>


<p>Having seen test-driven development in action in a simple example, we&rsquo;ll use the same technique to accomplish the slightly more complicated task of adding a new page, namely, the About page that we intentionally left off in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a>. By writing a test and running RSpec at each step, we&rsquo;ll see how TDD can guide us through the development of our application code.</p>

<div class="label" id="sec:red"></div>


<h4><a id="sec:3.2.2.1" href="#sec:red" class="heading">Red</a></h4>


<p>We&rsquo;ll get to the Red part of the Red-Green cycle by writing a failing test for the About page. Following the models from <a class="ref" href="#code:help_content_spec">Listing&nbsp;3.11</a>, you can probably guess the right test (<a class="ref" href="#code:about_page_content_spec">Listing&nbsp;3.13</a>).</p>

<div class="label" id="code:about_page_content_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.13.</span> <span class="description">Adding code to test the contents of the About page. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:green"></div>


<h4><a id="sec:3.2.2.2" href="#sec:green" class="heading">Green</a></h4>


<p>Recall from <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a> that we can generate a static page in Rails by creating an action and corresponding view with the page&rsquo;s name. In our case, the About page will first need an action called <code>about</code> in the StaticPages controller. Having written a failing test, we can now be confident that, in getting it to pass, we will actually have created a working About page.</p>

<p>If you run the RSpec example using</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>the output includes the following complaint:</p>

<div class="code"><div class="highlight"><pre>No route matches [GET] &quot;/static_pages/about&quot;
</pre></div>
</div>


<p>This is a hint that we need to add <code>/static_pages/about</code> to the routes file, which we can accomplish by following the pattern in <a class="ref" href="#code:pages_routes">Listing&nbsp;3.5</a>, as shown in  <a class="ref" href="#code:about_route">Listing&nbsp;3.14</a>.</p>

<div class="label" id="code:about_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.14.</span> <span class="description">Adding the <code>about</code> route. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/help&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/about&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>complains that</p>

<div class="code"><div class="highlight"><pre>The action &#39;about&#39; could not be found for StaticPagesController
</pre></div>
</div>


<p>To solve this problem, we follow the model provided by <code>home</code> and <code>help</code> from <a class="ref" href="#code:static_pages_controller">Listing&nbsp;3.6</a> by adding an <code>about</code> action in the StaticPages controller (<a class="ref" href="#code:adding_the_about_page">Listing&nbsp;3.15</a>).</p>

<div class="label" id="code:adding_the_about_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.15.</span> <span class="description">The StaticPages controller with added <code>about</code> action. <br /> <code>app/controllers/static_pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>says that we are missing a &ldquo;template&rdquo;, i.e., a view:</p>

<div class="code"><div class="highlight"><pre>ActionView::MissingTemplate:
  Missing template static_pages/about
</pre></div>
</div>


<p>To solve this issue, we add the <code>about</code> view. This involves creating a new file called <code>about.html.erb</code> in the <code>app/views/static_pages</code> directory with the contents shown in <a class="ref" href="#code:about_view">Listing&nbsp;3.16</a>.</p>

<div class="label" id="code:about_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.16.</span> <span class="description">Code for the About page. <br /> <code>app/views/static_pages/about.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  is a project to make a book and screencasts to teach web development
  with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
  is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>Running RSpec should now get us back to Green:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>Of course, it&rsquo;s never a bad idea to take a look at the page in a browser to make sure our tests aren&rsquo;t completely crazy (<a class="ref" href="#fig:about_us">Figure&nbsp;3.8</a>).</p>

<div class="label" id="fig:about_us"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/about_us_2nd_edition.png" alt="about_us_2nd_edition" /></span></div><div class="caption"><span class="header">Figure 3.8: </span><span class="description">The new About page (<a href="http://localhost:3000/static_pages/about">/static_pages/about</a>).&nbsp;<a href="http://railstutorial.org/images/figures/about_us_2nd_edition-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:refactor"></div>


<h4><a id="sec:3.2.2.3" href="#sec:refactor" class="heading">Refactor</a></h4>


<p>Now that we&rsquo;ve gotten to Green, we are free to refactor our code with confidence. Oftentimes code will start to &ldquo;smell&rdquo;, meaning that it gets ugly, bloated, or filled with repetition. The computer doesn&rsquo;t care, of course, but humans do, so it is important to keep the code base clean by refactoring frequently. Having a good test suite is an invaluable tool in this regard, as it dramatically lowers the probability of introducing bugs while refactoring.</p>

<p>Our sample app is a little too small to refactor right now, but code smell seeps in at every crack, so we won&rsquo;t have to wait long: we&rsquo;ll already get busy refactoring in <a class="ref" href="#sec:layouts">Section&nbsp;3.3.4</a>.</p>

<div class="label" id="sec:slightly_dynamic_pages"></div>


<h2><a id="sec:3.3" href="#sec:slightly_dynamic_pages" class="heading"><span class="number">3.3</span> Slightly dynamic pages</a></h2>


<p>Now that we&rsquo;ve created the actions and views for some static pages, we&rsquo;ll make them <em>very slightly</em> dynamic by adding some content that changes on a per-page basis: we&rsquo;ll have the title of each page change to reflect its content. Whether a changing title represents <em>truly</em> dynamic content is debatable, but in any case it lays the necessary foundation for unambiguously dynamic content in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>.</p>

<p>If you skipped the TDD material in <a class="ref" href="#sec:first_tests">Section&nbsp;3.2</a>, be sure to create an About page at this point using the code from <a class="ref" href="#code:about_route">Listing&nbsp;3.14</a>, <a class="ref" href="#code:adding_the_about_page">Listing&nbsp;3.15</a>, and <a class="ref" href="#code:about_view">Listing&nbsp;3.16</a>.</p>

<div class="label" id="sec:testing_a_title_change"></div>


<h3><a id="sec:3.3.1" href="#sec:testing_a_title_change" class="heading"><span class="number">3.3.1</span> Testing a title change</a></h3>


<p>Our plan is to edit the Home, Help, and About pages to make page titles that change on each page. This will involve using the <code>&lt;title&gt;</code> tag in our page views. Most browsers display the contents of the title tag at the top of the browser window (Google Chrome is an odd exception), and it is also important for search-engine optimization. We&rsquo;ll start by writing tests for the titles, then add the titles themselves, and then use a <em>layout</em> file to refactor the resulting pages and eliminate duplication.</p>

<p>You may have noticed that the <code>rails new</code> command already created a layout file. We&rsquo;ll learn its purpose shortly, but for now you should rename it before proceeding:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv app/views/layouts/application.html.erb foobar   <span class="c"># temporary change</span>
</pre></div>
</div>


<p>(<code>mv</code> is a Unix command; on Windows you may need to rename the file using the file browser or the <code>rename</code> command.) You wouldn&rsquo;t normally do this in a real application, but it&rsquo;s easier to understand the purpose of the layout file if we start by disabling it.</p>

<div class="label" id="table:static_pages"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_center"><strong>Page</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Base title</strong></th><th class="align_left"><strong>Variable title</strong></th></tr><tr class="top_bar"><td class="align_center">Home</td><td class="align_left">/static_pages/home</td><td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td><td class="align_left"><code>"Home"</code></td></tr><tr><td class="align_center">Help</td><td class="align_left">/static_pages/help</td><td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td><td class="align_left"><code>"Help"</code></td></tr><tr><td class="align_center">About</td><td class="align_left">/static_pages/about</td><td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td><td class="align_left"><code>"About"</code></td></tr></table></div><div class="caption"><span class="header">Table 3.1: </span><span class="description">The (mostly) static pages for the sample app.</span></div></div>


<p>By the end of this section, all three of our static pages will have titles of the form &ldquo;Ruby on Rails Tutorial Sample App | Home&rdquo;, where the last part of the title will vary depending on the page (<a class="ref" href="#table:static_pages">Table&nbsp;3.1</a>). We&rsquo;ll build on the tests in <a class="ref" href="#code:about_page_content_spec">Listing&nbsp;3.13</a>, adding title tests following the model in <a class="ref" href="#code:title_test">Listing&nbsp;3.17</a>.</p>

<div class="label" id="code:title_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.17.</span> <span class="description">A title test.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This uses the <code>have_selector</code> method, which checks for an HTML element (the &ldquo;selector&rdquo;) with the given content. In other words, the code</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                  <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>checks to see that the content inside the <code>title</code> tag is</p>

<div class="code"><div class="highlight"><pre><span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span>
</pre></div>
</div>


<p>(We&rsquo;ll learn in <a class="ref" href="#sec:hashes_and_symbols">Section&nbsp;4.3.3</a> that the <code>:text =&gt; "&hellip;"</code> syntax is a <em>hash</em> using a <em>symbol</em> as the key.) It&rsquo;s worth mentioning that the content need not be an exact match; any substring works as well, so that</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot; | Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>will also match the full title.</p>

<p>Note that in <a class="ref" href="#code:title_test">Listing&nbsp;3.17</a> we&rsquo;ve broken the material inside <code>have_selector</code> into two lines; this tells you something important about Ruby syntax: Ruby doesn&rsquo;t care about newlines.<sup class="footnote" id="fnref:3.11"><a href="#fn:3.11">11</a></sup> The <em>reason</em> I chose to break the code into pieces is that I prefer to keep lines of source code under 80 characters for legibility.<sup class="footnote" id="fnref:3.12"><a href="#fn:3.12">12</a></sup> As it stands, this code formatting is still rather ugly; <a class="ref" href="#sec:static_pages_exercises">Section&nbsp;3.5</a> has a refactoring exercise that makes them prettier, and <a class="ref" href="#sec:pretty_rspec">Section&nbsp;5.3.4</a> completely rewrites the StaticPages tests to take advantage of the latest features in RSpec.</p>

<p>Adding new tests for each of our three static pages, following the model of <a class="ref" href="#code:title_test">Listing&nbsp;3.17</a>, gives us our new StaticPages test (<a class="ref" href="#code:pages_controller_spec_title">Listing&nbsp;3.18</a>).</p>

<div class="label" id="code:pages_controller_spec_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.18.</span> <span class="description">The StaticPages controller spec with title tests. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Home&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Help&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | About Us&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we&rsquo;ve changed <code>have_content</code> to the more specific <code>have_selector(&rsquo;h1&rsquo;, &hellip;)</code>. See if you can figure out why. (<em>Hint:</em> What would happen if the title contained, say, &lsquo;Help&rsquo;, but the content inside <code>h1</code> tag had &lsquo;Helf&rsquo; instead?)</p>

<p>With the tests from <a class="ref" href="#code:pages_controller_spec_title">Listing&nbsp;3.18</a> in place, you should run</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>to verify that our code is now Red (failing tests).</p>

<div class="label" id="sec:passing_title_tests"></div>


<h3><a id="sec:3.3.2" href="#sec:passing_title_tests" class="heading"><span class="number">3.3.2</span> Passing title tests</a></h3>


<p>Now we&rsquo;ll get our title tests to pass, and at the same time add the full HTML structure needed to make valid web pages. Let&rsquo;s start with the Home page (<a class="ref" href="#code:home_view_full_html">Listing&nbsp;3.19</a>), using the same basic HTML skeleton as in the &ldquo;hello&rdquo; page from <a class="ref" href="#code:hello_world">Listing&nbsp;3.3</a>.</p>

<div class="label" id="code:home_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.19.</span> <span class="description">The view for the Home page with full HTML structure. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:home_view_full_html">Listing&nbsp;3.19</a> uses the title tested for in <a class="ref" href="#code:pages_controller_spec_title">Listing&nbsp;3.18</a>:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>As a result, the tests for the Home page should now pass. We&rsquo;re still Red because of the failing Help and About tests, and we can get to Green with the code in <a class="ref" href="#code:help_view_full_html">Listing&nbsp;3.20</a> and <a class="ref" href="#code:about_view_full_html">Listing&nbsp;3.21</a>.</p>

<div class="label" id="code:help_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.20.</span> <span class="description">The view for the Help page with full HTML structure. <br /> <code>app/views/static_pages/help.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Help<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:about_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.21.</span> <span class="description">The view for the About page with full HTML structure. <br /> <code>app/views/static_pages/about.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | About Us<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec:embedded_ruby"></div>


<h3><a id="sec:3.3.3" href="#sec:embedded_ruby" class="heading"><span class="number">3.3.3</span> Embedded Ruby</a></h3>


<p>We&rsquo;ve achieved a lot already in this section, generating three valid pages using Rails controllers and actions, but they are purely static HTML and hence don&rsquo;t show off the power of Rails. Moreover, they suffer from terrible duplication:</p>

<ul>
<li>The page titles are almost (but not quite) exactly the same.</li>
<li>&ldquo;Ruby on Rails Tutorial Sample App&rdquo; is common to all three titles.</li>
<li>The entire HTML skeleton structure is repeated on each page.</li>
</ul>


<p>This repeated code is a violation of the important &ldquo;Don&rsquo;t Repeat Yourself&rdquo; (DRY) principle; in this section and the next we&rsquo;ll &ldquo;DRY out our code&rdquo; by removing the repetition.</p>

<p>Paradoxically, we&rsquo;ll take the first step toward eliminating duplication by first adding some more: we&rsquo;ll make the titles of the pages, which are currently quite similar, match <em>exactly</em>. This will make it much simpler to remove all the repetition at a stroke.</p>

<p>The technique involves using <em>Embedded Ruby</em> in our views. Since the Home, Help, and About page titles have a variable component, we&rsquo;ll use a special Rails function called <code>provide</code> to set a different title on each page. We can see how this works by replacing the literal title &ldquo;Home&rdquo; in the <code>home.html.erb</code> view with the code in <a class="ref" href="#code:home_view_erb_title">Listing&nbsp;3.22</a>.</p>

<div class="label" id="code:home_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.22.</span> <span class="description">The view for the Home page with an Embedded Ruby title. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:home_view_erb_title">Listing&nbsp;3.22</a> is our first example of Embedded Ruby, also called <em>ERb</em>. (Now you know why HTML views have the file extension <code>.html.erb</code>.) ERb is the primary template system for including dynamic content in web pages.<sup class="footnote" id="fnref:3.13"><a href="#fn:3.13">13</a></sup> The code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>indicates using <tt class="verb">&lt;% ... %&gt;</tt> that Rails should call the <code>provide</code> function and associate the string <code>&rsquo;Home&rsquo;</code> with the label <code>:title</code>.<sup class="footnote" id="fnref:3.14"><a href="#fn:3.14">14</a></sup> Then, in the title, we use the closely related notation <tt class="verb">&lt;%= ... %&gt;</tt> to insert the title into the template using Ruby&rsquo;s <code>yield</code> function:<sup class="footnote" id="fnref:3.15"><a href="#fn:3.15">15</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>(The distinction between the two types of embedded Ruby is that  <tt class="verb">&lt;% ... %&gt;</tt> <em>executes</em> the code inside, while <tt class="verb">&lt;%= ... %&gt;</tt> executes it and <em>inserts</em> the result into the template.) The resulting page is exactly the same as before, only now the variable part of the title is generated dynamically by ERb.</p>

<p>We can verify that all this works by running the tests from <a class="ref" href="#sec:testing_a_title_change">Section&nbsp;3.3.1</a> and see that they still pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>Then we can make the corresponding replacements for the Help and About pages (<a class="ref" href="#code:help_view_erb_title">Listing&nbsp;3.23</a> and <a class="ref" href="#code:about_view_erb_title">Listing&nbsp;3.24</a>).</p>

<div class="label" id="code:help_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.23.</span> <span class="description">The view for the Help page with an Embedded Ruby title. <br /> <code>app/views/static_pages/help.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:about_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.24.</span> <span class="description">The view for the About page with an Embedded Ruby title. <br /> <code>app/views/static_pages/about.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec:layouts"></div>


<h3><a id="sec:3.3.4" href="#sec:layouts" class="heading"><span class="number">3.3.4</span> Eliminating duplication with layouts</a></h3>


<p>Now that we&rsquo;ve replaced the variable part of the page titles with ERb, each of our pages looks something like this:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
      Contents
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>


<p>In other words, <em>all</em> our pages are identical in structure, including the contents of the title tag, with the sole exception of the material inside the <code>body</code> tag.</p>

<p>In order to factor out this common structure, Rails comes with a special <em>layout</em> file called <code>application.html.erb</code>, which we renamed in <a class="ref" href="#sec:testing_a_title_change">Section&nbsp;3.3.1</a> and which we&rsquo;ll now restore:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv foobar app/views/layouts/application.html.erb
</pre></div>
</div>


<p>To get the layout to work, we have to replace the default title with the Embedded Ruby from the examples above:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>The resulting layout appears in <a class="ref" href="#code:application_layout">Listing&nbsp;3.25</a>.</p>

<div class="label" id="code:application_layout"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.25.</span> <span class="description">The sample application site layout. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Note here the special line</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This code is responsible for inserting the contents of each page into the layout. It&rsquo;s not important to know exactly how this works; what matters is that using this layout ensures that, for example, visiting the page /static_pages/home converts the contents of <code>home.html.erb</code> to HTML and then inserts it in place of <tt class="verb">&lt;%= yield %&gt;</tt>.</p>

<p>It&rsquo;s also worth noting that the default Rails layout includes several additional lines:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This code arranges to include the application stylesheet and JavaScript, which are part of the asset pipeline (<a class="ref" href="#sec:the_asset_pipeline">Section&nbsp;5.2.1</a>), together with the Rails method <code>csrf_meta_tags</code>, which prevents <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">cross-site request forgery</a> (CSRF), a type of malicious web attack.</p>

<p>Of course, the views in <a class="ref" href="#code:home_view_erb_title">Listing&nbsp;3.22</a>, <a class="ref" href="#code:help_view_erb_title">Listing&nbsp;3.23</a>, and <a class="ref" href="#code:about_view_erb_title">Listing&nbsp;3.24</a> are still filled with all the HTML structure included in the layout, so we have to remove it, leaving only the interior contents. The resulting cleaned-up views appear in <a class="ref" href="#code:home_view_interior">Listing&nbsp;3.26</a>, <a class="ref" href="#code:help_view_interior">Listing&nbsp;3.27</a>, and <a class="ref" href="#code:about_view_interior">Listing&nbsp;3.28</a>.</p>

<div class="label" id="code:home_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.26.</span> <span class="description">The Home page with HTML structure removed. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:help_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.27.</span> <span class="description">The Help page with HTML structure removed. <br /> <code>app/views/static_pages/help.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:about_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.28.</span> <span class="description">The About page with HTML structure removed. <br /> <code>app/views/static_pages/about.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  is a project to make a book and screencasts to teach web development
  with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
  is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>With these views defined, the Home, Help, and About pages are the same as before, but they have much less duplication. Verifying that the test suite still passes gives us confidence that this code refactoring was successful:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec:static_pages_conclusion"></div>


<h2><a id="sec:3.4" href="#sec:static_pages_conclusion" class="heading"><span class="number">3.4</span> Conclusion</a></h2>


<p>Seen from the outside, this chapter hardly accomplished anything: we started with static pages, and ended with&hellip; <em>mostly</em> static pages. But appearances are deceiving: by developing in terms of Rails controllers, actions, and views, we are now in a position to add arbitrary amounts of dynamic content to our site. Seeing exactly how this plays out is the task for the rest of this tutorial.</p>

<p>Before moving on, let&rsquo;s take a minute to commit our changes and merge them into the master branch. Back in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a> we created a Git branch for the development of static pages. If you haven&rsquo;t been making commits as we&rsquo;ve been moving along, first make a commit indicating that we&rsquo;ve reached a stopping point:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish static pages&quot;</span>
</pre></div>
</div>


<p>Then merge the changes back into the master branch using the same technique as in <a class="ref" href="#sec:git_commands">Section&nbsp;1.3.5</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge static-pages
</pre></div>
</div>


<p>Once you reach a stopping point like this, it&rsquo;s usually a good idea to push your code up to a remote repository (which, if you followed the steps in <a class="ref" href="#sec:github">Section&nbsp;1.3.4</a>, will be GitHub):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div>
</div>


<p>If you like, at this point you can even deploy the updated application to Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div>
</div>




<div class="label" id="sec:static_pages_exercises"></div>


<h2><a id="sec:3.5" href="#sec:static_pages_exercises" class="heading"><span class="number">3.5</span> Exercises</a></h2>




<ol>

<li>Make a Contact page for the sample app. First write a test for the existence of a page at the URI /static_pages/contact. (<em>Hint</em>: Test for the right title.) Then write a second test for the title &ldquo;Ruby on Rails Tutorial Sample App | Contact&rdquo;. Get your tests to pass, and then fill in the Contact page with the content from <a class="ref" href="#code:proposed_contact_page">Listing&nbsp;3.29</a>. (This exercise is solved as part of <a class="ref" href="#sec:layout_links">Section&nbsp;5.3</a>.)</li>

<li>You may have noticed some repetition in the StaticPages controller spec (<a class="ref" href="#code:pages_controller_spec_title">Listing&nbsp;3.18</a>). In particular, the base title, &ldquo;Ruby on Rails Tutorial Sample App&rdquo;, is the same for every title test. Using the RSpec <code>let</code> function, which creates a variable corresponding to its argument, verify that the tests in <a class="ref" href="#code:pages_controller_spec_exercise">Listing&nbsp;3.30</a> still pass. <a class="ref" href="#code:pages_controller_spec_exercise">Listing&nbsp;3.30</a> introduces <em>string interpolation</em>, which is covered further in <a class="ref" href="#sec:strings">Section&nbsp;4.2.2</a>. </li>

<li><strong>(advanced)</strong> As noted on the <a href="http://devcenter.heroku.com/articles/how-do-i-use-sqlite3-for-development">Heroku page on using <tt>sqlite3</tt> for development</a>, it&rsquo;s a good idea to use the same database in development, test, and production environments to minimize the possibility of subtle incompatibilities. Follow the <a href="http://devcenter.heroku.com/articles/local-postgresql">Heroku instructions for local PostgreSQL installation</a> to install the PostgreSQL database on your local system. Update your <code>Gemfile</code> to eliminate the <tt>sqlite3</tt> gem and use the <tt>pg</tt> gem exclusively, as shown in <a class="ref" href="#code:Gemfile_pg_gem">Listing&nbsp;3.31</a>. You will also have to learn about the <code>config/database.yml</code> file and how to run PostgreSQL locally. Your goal should be to create and configure both the development database and the test database to use PostgreSQL. <strong>Warning:</strong> You may find this exercise challenging, and I recommend it only for advanced users. If you get stuck, don&rsquo;t hesitate to skip it; as noted previously, the sample application developed in this tutorial is fully compatible with both SQLite and PostgreSQL. </li>

</ol>




<div class="label" id="code:proposed_contact_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.29.</span> <span class="description">Code for a proposed Contact page. <br /> <code>app/views/static_pages/contact.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/contact&quot;</span><span class="nt">&gt;</span>contact page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:pages_controller_spec_exercise"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.30.</span> <span class="description">The StaticPages controller spec with a base title. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:base_title</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Home&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Home&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Help&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | About Us&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:Gemfile_pg_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.31.</span> <span class="description">The <code>Gemfile</code> needed to use PostgreSQL instead of SQLite.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.10.0&#39;</span>
<span class="k">end</span>

<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:advanced_setup"></div>


<h2><a id="sec:3.6" href="#sec:advanced_setup" class="heading"><span class="number">3.6</span> Advanced setup</a></h2>


<p>As mentioned briefly in <a class="ref" href="#sec:first_tests">Section&nbsp;3.2</a>, using the <code>rspec</code> command directly is not ideal. In this section, we&rsquo;ll first discuss a method to eliminate the necessity of typing <code>bundle exec</code>, and then set up testing setup to automate the running of the test suite using Guard (<a class="ref" href="#sec:guard">Section&nbsp;3.6.2</a>) and, optionally, Spork (<a class="ref" href="#sec:spork">Section&nbsp;3.6.3</a>). Finally, we&rsquo;ll mention a method for running tests directly inside Sublime Text, a technique especially useful when used in concert with Spork.</p>

<p>This section should only be attempted by fairly advanced users and can be skipped without loss of continuity. Among other things, this material is likely to go out of date faster than the rest of the tutorial, so you shouldn&rsquo;t expect everything on your system to match the examples exactly, and you may have to Google around to get everything to work.</p>

<div class="label" id="sec:eliminating_bundle_exec"></div>


<h3><a id="sec:3.6.1" href="#sec:eliminating_bundle_exec" class="heading"><span class="number">3.6.1</span> Eliminating <tt>bundle exec</tt></a></h3>


<p>As mentioned briefly in <a class="ref" href="#sec:TDD">Section&nbsp;3.2.1</a>, it is necessary in general to prefix commands such as <code>rake</code> or <code>rspec</code> with <code>bundle exec</code> so that the programs run in the exact gem environment specified by the <code>Gemfile</code>. (For technical reasons, the only exception to this is the <code>rails</code> command itself.) This practice is rather cumbersome, and in this section we discuss two ways to eliminate its necessity.</p>

<div class="label" id="sec:rvm_bundler_integration"></div>


<h4><a id="sec:3.6.1.1" href="#sec:rvm_bundler_integration" class="heading">RVM Bundler integration</a></h4>


<p>The first and preferred method is to use the <a href="http://www.beginrescueend.com/integration/bundler/">RVM Bundler integration</a><sup class="footnote" id="fnref:3.16"><a href="#fn:3.16">16</a></sup> to configure the Ruby Version Manager to include the proper executables automatically in the local environment. The steps are simple if somewhat mysterious. First, run these two commands:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get head <span class="o">&amp;&amp;</span> rvm reload
<span class="gp">$</span> chmod +x <span class="nv">$rvm_path</span>/hooks/after_cd_bundler
</pre></div>
</div>


<p>Then run these:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects/sample_app
<span class="gp">$</span> bundle install --without production --binstubs<span class="o">=</span>./bundler_stubs
</pre></div>
</div>


<p>Together, these commands combine RVM and Bundler magic to ensure that commands such as <code>rake</code> and <code>rspec</code> are automatically executed in the right environment. Since these files are specific to your local setup, you should add the <code>bundler_stubs</code> directory to your <code>.gitignore</code> file (<a class="ref" href="#code:bundler_stubs_gitignore">Listing&nbsp;3.32</a>).</p>

<div class="label" id="code:bundler_stubs_gitignore"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.32.</span> <span class="description">Adding <code>bundler_stubs</code> to the <code>.gitignore</code> file.</span>       
</div>
<div class="code"><div class="highlight"><pre># Ignore bundler config
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore other unneeded files.
doc/
*.swp
*~
.project
.DS_Store
bundler_stubs/
</pre></div>
</div></div>


<p>If you add another executable (such as <code>guard</code> in <a class="ref" href="#sec:guard">Section&nbsp;3.6.2</a>), you should re-run the <code>bundle install</code> command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --binstubs<span class="o">=</span>./bundler_stubs
</pre></div>
</div>




<div class="label" id="sec:binstubs"></div>


<h4><a id="sec:3.6.1.2" href="#sec:binstubs" class="heading">binstubs</a></h4>


<p>If you&rsquo;re not using RVM, you can still avoid typing <code>bundle exec</code>.  Bundler allows the creation of the associated binaries as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle --binstubs
</pre></div>
</div>


<p>(In fact, this step, with a different target directory, is also used when using RVM.) This command creates all the necessary executables in the <code>bin/</code> directory of the application, so that we can now run the test suite as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bin/rspec spec/
</pre></div>
</div>


<p>The same goes for <code>rake</code>, etc.:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bin/rake db:migrate
</pre></div>
</div>


<p>If you add another executable (such as <code>guard</code> in <a class="ref" href="#sec:guard">Section&nbsp;3.6.2</a>), you should re-run the <tt class="verb">bundle</tt> <tt class="verb">--binstubs</tt> command.</p>

<p>For the sake of readers who skip this section, the rest of this tutorial will err on the side of caution and explicitly use <code>bundle exec</code>, but of course you should feel free to use the more compact version if your system is properly configured.</p>

<div class="label" id="sec:guard"></div>


<h3><a id="sec:3.6.2" href="#sec:guard" class="heading"><span class="number">3.6.2</span> Automated tests with Guard</a></h3>


<p>One annoyance associated with using the <code>rspec</code> command is having to switch to the command line and run the tests by hand. (A second annoyance, the slow start-up time of the test suite, is addressed in <a class="ref" href="#sec:spork">Section&nbsp;3.6.3</a>.) In this section, we&rsquo;ll show how to use <a href="https://github.com/guard/guard">Guard</a> to automate the running of the tests. Guard monitors changes in the filesystem so that, for example, when we change the <code>static_pages_spec.rb</code> file only those tests get run. Even better, we can configure Guard so that when, say, the <code>home.html.erb</code> file is modified, the <code>static_pages_spec.rb</code> automatically runs.</p>

<p>First we add <code>guard-rspec</code> to the <code>Gemfile</code> (<a class="ref" href="#code:gemfile_guard">Listing&nbsp;3.33</a>).</p>

<div class="label" id="code:gemfile_guard"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.33.</span> <span class="description">A <code>Gemfile</code> for the sample app, including Guard.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.10.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;guard-rspec&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5.5&#39;</span>
<span class="k">end</span>

<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="c1"># System-dependent gems</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Then we have to replace the comment at the end of the test group with some system-dependent gems (OS&nbsp;X users may have to install <a href="http://growl.info/downloads#generaldownloads">Growl and growlnotify</a> as well):</p>

<div class="code"><div class="highlight"><pre><span class="c1"># Test gems on Macintosh OS X</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-fsevent&#39;</span><span class="p">,</span> <span class="s1">&#39;0.4.3.1&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;growl&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.3&#39;</span>
<span class="k">end</span> 
</pre></div>
</div>


<div class="code"><div class="highlight"><pre><span class="c1"># Test gems on Linux</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-inotify&#39;</span><span class="p">,</span> <span class="s1">&#39;0.8.8&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;libnotify&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5.9&#39;</span>
<span class="k">end</span> 
</pre></div>
</div>


<div class="code"><div class="highlight"><pre><span class="c1"># Test gems on Windows</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-fchange&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-notifu&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;win32console&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.0&#39;</span>
<span class="k">end</span> 
</pre></div>
</div>


<p>We next install the gems by running <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Then initialize Guard so that it works with RSpec:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard init rspec
<span class="go">Writing new Guardfile to /Users/mhartl/rails_projects/sample_app/Guardfile</span>
<span class="go">rspec guard added to Guardfile, feel free to edit it</span>
</pre></div>
</div>


<p>Now edit the resulting <code>Guardfile</code> so that Guard will run the right tests when the integration tests and views are updated (<a class="ref" href="#code:guardfile">Listing&nbsp;3.34</a>).</p>

<div class="label" id="code:guardfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.34.</span> <span class="description">Additions to the default <code>Guardfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;active_support/core_ext&#39;</span>

<span class="n">guard</span> <span class="s1">&#39;rspec&#39;</span><span class="p">,</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:all_after_pass</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/controllers/(.+)_(controller)\.rb$}</span><span class="p">)</span>  <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="o">[</span><span class="s2">&quot;spec/routing/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_routing_spec.rb&quot;</span><span class="p">,</span>
     <span class="s2">&quot;spec/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">s/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span><span class="p">,</span>
     <span class="s2">&quot;spec/acceptance/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span><span class="p">,</span>
     <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][/</span><span class="n">_pages</span><span class="o">/]</span> <span class="p">?</span> <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span> <span class="p">:</span> 
                       <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb&quot;</span><span class="p">)</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/views/(.+)/}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][/</span><span class="n">_pages</span><span class="o">/]</span> <span class="p">?</span> <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span> <span class="p">:</span> 
                       <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here the line</p>

<div class="code"><div class="highlight"><pre><span class="n">guard</span> <span class="s1">&#39;rspec&#39;</span><span class="p">,</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:all_after_pass</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
</pre></div>
</div>


<p>ensures that Guard doesn&rsquo;t run all the tests after a failing test passes (to speed up the Red-Green-Refactor cycle).</p>

<p>We can now start <code>guard</code> as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard
</pre></div>
</div>


<p>To eliminate the need to prefix the command with <code>bundle exec</code>, re-follow the steps in <a class="ref" href="#sec:eliminating_bundle_exec">Section&nbsp;3.6.1</a>.</p>

<p>By the way, if you get a Guard error complaining about the absence of a <code>spec/routing</code> directory, you can fix it by creating an empty one:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mkdir spec/routing
</pre></div>
</div>




<div class="label" id="sec:spork"></div>


<h3><a id="sec:3.6.3" href="#sec:spork" class="heading"><span class="number">3.6.3</span> Speeding up tests with Spork</a></h3>


<p>When running <code>bundle exec rspec</code>, you may have noticed that it takes several seconds just to start running the tests, but once they start running they finish quickly. This is because each time RSpec runs the tests it has to reload the entire Rails environment. The <a href="http://github.com/sporkrb/spork">Spork test server</a><sup class="footnote" id="fnref:3.17"><a href="#fn:3.17">17</a></sup> aims to solve this problem. Spork loads the environment <em>once</em>, and then maintains a pool of processes for running future tests. Spork is particularly useful when combined with Guard (<a class="ref" href="#sec:guard">Section&nbsp;3.6.2</a>).</p>

<p>The first step is to add the <code>spork</code> gem dependency to the <code>Gemfile</code> (<a class="ref" href="#code:gemfile_spork">Listing&nbsp;3.35</a>).</p>

<div class="label" id="code:gemfile_spork"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.35.</span> <span class="description">A <code>Gemfile</code> for the sample app.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;guard-spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9.0&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Then install Spork using <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Next, bootstrap the Spork configuration:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork --bootstrap
</pre></div>
</div>


<p>Now we need to edit the RSpec configuration file, located in <code>spec/spec_helper.rb</code>, so that the environment gets loaded in a <em>prefork</em> block, which arranges for it to be loaded only once (<a class="ref" href="#code:spork_spec_helper">Listing&nbsp;3.36</a>).</p>

<div class="label" id="code:spork_spec_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.36.</span> <span class="description">Adding environment loading to the <code>Spork.prefork</code> block. <br /> <code>spec/spec_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;spork&#39;</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">prefork</span> <span class="k">do</span>
  <span class="c1"># Loading more in this block will cause your tests to run faster. However, </span>
  <span class="c1"># if you change any configuration or code from libraries loaded here, you&#39;ll</span>
  <span class="c1"># need to restart spork for it take effect.</span>
  <span class="c1"># This file is copied to spec/ when you run &#39;rails generate rspec:install&#39;</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;test&#39;</span>
  <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../../config/environment&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">&#39;rspec/rails&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;rspec/autorun&#39;</span>

  <span class="c1"># Requires supporting ruby files with custom matchers and macros, etc,</span>
  <span class="c1"># in spec/support/ and its subdirectories.</span>
  <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;spec/support/**/*.rb&quot;</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span><span class="p">}</span>

  <span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="c1"># == Mock Framework</span>
    <span class="c1">#</span>
    <span class="c1"># If you prefer to use mocha, flexmock or RR, uncomment the appropriate line:</span>
    <span class="c1">#</span>
    <span class="c1"># config.mock_with :mocha</span>
    <span class="c1"># config.mock_with :flexmock</span>
    <span class="c1"># config.mock_with :rr</span>
    <span class="n">config</span><span class="o">.</span><span class="n">mock_with</span> <span class="ss">:rspec</span>

    <span class="c1"># Remove this line if you&#39;re not using ActiveRecord or ActiveRecord fixtures</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fixture_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="o">::</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/spec/fixtures&quot;</span>

    <span class="c1"># If you&#39;re not using ActiveRecord, or you&#39;d prefer not to run each of your</span>
    <span class="c1"># examples within a transaction, remove the following line or assign false</span>
    <span class="c1"># instead of true.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">use_transactional_fixtures</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># If true, the base class of anonymous controllers will be inferred</span>
    <span class="c1"># automatically. This will be the default behavior in future versions of</span>
    <span class="c1"># rspec-rails.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">infer_base_class_for_anonymous_controllers</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">each_run</span> <span class="k">do</span>
  <span class="c1"># This code will be run each time you run your specs.</span>

<span class="k">end</span>
</pre></div>
</div></div>


<p>Before running Spork, we can get a baseline for the testing overhead by timing our test suite as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
<span class="go">......</span>

<span class="go">6 examples, 0 failures</span>

<span class="go">real	0m8.633s</span>
<span class="go">user	0m7.240s</span>
<span class="go">sys	0m1.068s</span>
</pre></div>
</div>


<p>Here the test suite takes more than seven seconds to run even though the actual tests run in under a tenth of a second. To speed this up, we can open a dedicated terminal window, navigate to the application root directory, and then start a Spork server:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
</pre></div>
</div>


<p>(To eliminate the need to prefix the command with <code>bundle exec</code>, re-follow the steps in <a class="ref" href="#sec:eliminating_bundle_exec">Section&nbsp;3.6.1</a>.) In another terminal window, we can now run our test suite with the <tt class="verb">--drb</tt> (&ldquo;distributed Ruby&rdquo;) option and verify that the environment-loading overhead is greatly reduced:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb --drb
<span class="go">......</span>

<span class="go">6 examples, 0 failures</span>

<span class="go">real	0m2.649s</span>
<span class="go">user	0m1.259s</span>
<span class="go">sys	0m0.258s</span>
</pre></div>
</div>


<p>It&rsquo;s inconvenient to have to include the <tt class="verb">--drb</tt> option every time we run <code>rspec</code>, so I recommend adding it to the <code>.rspec</code> file in the application&rsquo;s root directory, as shown in <a class="ref" href="#code:rspec_drb">Listing&nbsp;3.37</a>.</p>

<div class="label" id="code:rspec_drb"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.37.</span> <span class="description">Configuring RSpec to automatically use Spork. <br /> <code>.rspec</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">--</span><span class="n">colour</span>
<span class="o">--</span><span class="n">drb</span>
</pre></div>
</div></div>


<p>One word of advice when using Spork: after changing a file included in the prefork loading (such as <code>routes.rb</code>), you will have to restart the Spork server to load the new Rails environment. If your tests are failing when you think they should be passing, quit the Spork server with <tt>Control-C</tt> and restart it:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
<span class="go">^C</span>
<span class="gp">$</span> bundle <span class="nb">exec </span>spork
</pre></div>
</div>


<div class="label" id="sec:spork_and_guard"></div>


<h4><a id="sec:3.6.3.1" href="#sec:spork_and_guard" class="heading">Guard with Spork</a></h4>


<p>Spork is especially useful when used with Guard, which we can arrange as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard init spork
</pre></div>
</div>


<p>We then need to change the <code>Guardfile</code> as in <a class="ref" href="#code:spork_guardfile">Listing&nbsp;3.38</a>.</p>

<div class="label" id="code:spork_guardfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 3.38.</span> <span class="description">The <code>Guardfile</code> updated for Spork.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;active_support/core_ext&#39;</span>

<span class="n">guard</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="ss">:rspec_env</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;RAILS_ENV&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span> <span class="p">}</span> <span class="k">do</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;config/application.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;config/environment.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^config/environments/.+\.rb$}</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^config/initializers/.+\.rb$}</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;Gemfile&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;Gemfile.lock&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;spec/spec_helper.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;test/test_helper.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;spec/support/&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">guard</span> <span class="s1">&#39;rspec&#39;</span><span class="p">,</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:all_after_pass</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:cli</span> <span class="o">=&gt;</span> <span class="s1">&#39;--drb&#39;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we&rsquo;ve updated the arguments to <code>guard</code> to include
<tt class="verb">:cli =&gt; --drb</tt>, which ensures that Guard uses the command-line interface (cli) to the Spork server. We&rsquo;ve also added a command to watch the <code>spec/support/</code> directory, which we&rsquo;ll start modifying in <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a>.</p>

<p>With that configuration in place, we can start Guard and Spork at the same time with the <code>guard</code> command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard
</pre></div>
</div>


<p>Guard automatically starts a Spork server, dramatically reducing the overhead each time a test gets run.</p>

<p>A well-configured testing environment with Guard, Spork, and (optionally) test notifications makes test-driven development positively addictive. See the <a href="http://railstutorial.org/screencasts">Rails Tutorial screencasts</a><sup class="footnote" id="fnref:3.18"><a href="#fn:3.18">18</a></sup> for more information.</p>

<div class="label" id="sec:tests_inside_sublime_text"></div>


<h3><a id="sec:3.6.4" href="#sec:tests_inside_sublime_text" class="heading"><span class="number">3.6.4</span> Tests inside Sublime Text</a></h3>


<p>If you&rsquo;re using Sublime Text, there is a powerful set of helper commands to run tests directly inside the editor. To get them working, follow the instructions for your platform at <a href="https://github.com/maltize/sublime-text-2-ruby-tests">Sublime Text 2 Ruby Tests</a>.<sup class="footnote" id="fnref:3.19"><a href="#fn:3.19">19</a></sup> On my platform (Macintosh OS&nbsp;X), I can install the commands as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/Library/Application<span class="se">\ </span>Support/Sublime<span class="se">\ </span>Text<span class="se">\ </span>2/Packages
<span class="gp">$</span> git clone https://github.com/maltize/sublime-text-2-ruby-tests.git RubyTest
</pre></div>
</div>


<p>You may also want to follow the setup instructions for <a href="https://github.com/mhartl/rails_tutorial_sublime_text">Rails Tutorial Sublime Text</a> at this time.<sup class="footnote" id="fnref:3.20"><a href="#fn:3.20">20</a></sup></p>

<p>After restarting Sublime Text, the RubyTest package supplies the following commands:</p>

<ul>
<li><strong>Command-Shift-R</strong>: run a single test (if run on an <code>it</code> block) or group of tests (if run on a <code>describe</code> block)</li>
<li><strong>Command-Shift-E</strong>: run the last test(s)</li>
<li><strong>Command-Shift-T</strong>: run all the tests in current file</li>
</ul>


<p>Because test suites can become quite slow even for relatively small projects, being able to run one test (or a small group of tests) at a time can be a huge win. Even a single test requires the same Rails environment overhead, of course, which is why these commands are perfectly complemented by Spork: running a single test eliminates the overhead of running the entire test file, while running Spork eliminates the overhead of starting the test environment. Here is the sequence I recommend:</p>

<ol>
<li>Start Spork in a terminal window.</li>
<li>Write a single test or small group of tests.</li>
<li>Run Command-Shift-R to verify that the test or test group is red.</li>
<li>Write the corresponding application code.</li>
<li>Run Command-Shift-E to run the same test/group again, verifying that it&rsquo;s green.</li>
<li>Repeat steps 2&ndash;5 as necessary.</li>
<li>When reaching a natural stopping point (such as before a commit), run <code>rspec spec/</code> at the command line to confirm that the entire test suite is still green.</li>
</ol>


<p>Even with the ability to run tests inside of Sublime Text, I still sometimes prefer using Guard, but at this point my bread-and-butter TDD technique is the one enumerated above.</p>

<div class="footnotes">
<ol>
<li id="fn:3.1">The successor to <em>Webrat</em>, Capybara is named after the world&rsquo;s <a href="http://en.wikipedia.org/wiki/Capybara">largest rodent</a>.&nbsp;<a class="arrow" href="#fnref:3.1">&uarr;</a></li>
<li id="fn:3.2">In fact, you can even leave off <code>install</code>. The <code>bundle</code> command by itself is an alias for <code>bundle install</code>.&nbsp;<a class="arrow" href="#fnref:3.2">&uarr;</a></li>
<li id="fn:3.3">As before, you may find the augmented file from <a class="ref" href="#code:gitignore">Listing&nbsp;1.7</a> to be more convenient depending on your system.&nbsp;<a class="arrow" href="#fnref:3.3">&uarr;</a></li>
<li id="fn:3.4">https://github.com/railstutorial/sample_app_2nd_ed&nbsp;<a class="arrow" href="#fnref:3.4">&uarr;</a></li>
<li id="fn:3.5">In fact, Rails ensures that requests for such files never hit the main Rails stack; they are delivered directly from the filesystem. (See <a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails&nbsp;3 Way</em></a> for more details.)&nbsp;<a class="arrow" href="#fnref:3.5">&uarr;</a></li>
<li id="fn:3.6">As usual, replace <code>subl</code> with the command for your text editor.&nbsp;<a class="arrow" href="#fnref:3.6">&uarr;</a></li>
<li id="fn:3.7">HTML changes with time; by explicitly making a doctype declaration we make it likelier that browsers will render our pages properly in the future. The extremely simple doctype <code>&lt;!DOCTYPE html&gt;</code> is characteristic of the latest HTML standard, HTML5.&nbsp;<a class="arrow" href="#fnref:3.7">&uarr;</a></li>
<li id="fn:3.8">Our method for making static pages is probably the simplest, but it&rsquo;s not the only way. The optimal method really depends on your needs; if you expect a <em>large</em> number of static pages, using a StaticPages controller can get quite cumbersome, but in our sample app we&rsquo;ll only need a few. See this <a href="http://blog.hasmanythrough.com/2008/4/2/simple-pages/">blog post on simple pages at <tt>has_many :through</tt></a> for a survey of techniques for making static pages with Rails. <em>Warning:</em> The discussion is fairly advanced, so you might want to wait a while before trying to understand it.&nbsp;<a class="arrow" href="#fnref:3.8">&uarr;</a></li>
<li id="fn:3.9">Running <code>bundle exec</code> every time is rather cumbersome; see <a class="ref" href="#sec:advanced_setup">Section&nbsp;3.6</a> for some options to eliminate it.&nbsp;<a class="arrow" href="#fnref:3.9">&uarr;</a></li>
<li id="fn:3.10">I actually use a dark background for both my terminal and editor, but the light background looks better in the screenshots.&nbsp;<a class="arrow" href="#fnref:3.10">&uarr;</a></li>
<li id="fn:3.11">A newline is what comes at the end of a line, thereby starting a new line. In code, it is represented by the character <tt class="verb">\n</tt>.&nbsp;<a class="arrow" href="#fnref:3.11">&uarr;</a></li>
<li id="fn:3.12">Actually <em>counting</em> columns could drive you crazy, which is why many text editors have a visual aid to help you. For example, if you take a look back at <a class="ref" href="#fig:editor_shell">Figure&nbsp;1.1</a>, you&rsquo;ll see a small vertical line on the right to help keep code under 80 characters. (It&rsquo;s actually at 78 columns, which gives you a little margin for error.) If you use TextMate, you can find this feature under <tt>View &gt; Wrap Column &gt; 78</tt>. In Sublime Text, you can use <tt>View &gt; Ruler &gt; 78</tt> or <tt>View &gt; Ruler &gt; 80</tt>.&nbsp;<a class="arrow" href="#fnref:3.12">&uarr;</a></li>
<li id="fn:3.13">There is a second popular template system called <a href="http://haml-lang.com/">Haml</a>, which I personally love, but it&rsquo;s not <em>quite</em> standard enough yet for use in an introductory tutorial.&nbsp;<a class="arrow" href="#fnref:3.13">&uarr;</a></li>
<li id="fn:3.14">Experienced Rails developers might have expected the use of <code>content_for</code> at this point, but it doesn&rsquo;t work well with the asset pipeline. The <code>provide</code> function is its replacement.&nbsp;<a class="arrow" href="#fnref:3.14">&uarr;</a></li>
<li id="fn:3.15">If you&rsquo;ve studied Ruby before, you might suspect that Rails is <em>yielding</em> the contents to a block, and your suspicion would be correct. But you don&rsquo;t need to know this to develop applications with Rails.&nbsp;<a class="arrow" href="#fnref:3.15">&uarr;</a></li>
<li id="fn:3.16">http://www.beginrescueend.com/integration/bundler/&nbsp;<a class="arrow" href="#fnref:3.16">&uarr;</a></li>
<li id="fn:3.17">A <em>spork</em> is a combination spoon-fork. The project&rsquo;s name is a pun on Spork&rsquo;s use of <a href="http://en.wikipedia.org/wiki/POSIX">POSIX</a> <a href="http://en.wikipedia.org/wiki/Fork_(software_development)">forks</a>.&nbsp;<a class="arrow" href="#fnref:3.17">&uarr;</a></li>
<li id="fn:3.18">http://railstutorial.org/screencasts&nbsp;<a class="arrow" href="#fnref:3.18">&uarr;</a></li>
<li id="fn:3.19">https://github.com/maltize/sublime-text-2-ruby-tests&nbsp;<a class="arrow" href="#fnref:3.19">&uarr;</a></li>
<li id="fn:3.20">https://github.com/mhartl/rails_tutorial_sublime_text&nbsp;<a class="arrow" href="#fnref:3.20">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:rails_flavored_ruby"></div>


<h1 class="chapter"><a id="sec:4" href="#cha:rails_flavored_ruby" class="heading"><span class="number">Chapter 4</span> Rails-flavored Ruby</a></h1>


<p>Grounded in examples from <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>, this chapter explores some elements of Ruby important for Rails. Ruby is a big language, but fortunately the subset needed to be productive as a Rails developer is relatively small. Moreover, this subset is <em>different</em> from the usual approaches to learning Ruby, which is why, if your goal is making dynamic web applications, I recommend learning Rails first, picking up bits of Ruby along the way. To become a Rails <em>expert</em>, you need to understand Ruby more deeply, and this book gives you a good foundation for developing that expertise. As noted in <a class="ref" href="#sec:comments_for_various_readers">Section&nbsp;1.1.1</a>, after finishing the <em>Rails Tutorial</em> I suggest reading a pure Ruby book such as <a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a>, <a href="http://www.amazon.com/gp/product/1933988657"><em>The Well-Grounded Rubyist</em></a>, or <a href="http://www.amazon.com/gp/product/0672328844"><em>The Ruby Way</em></a>.</p>

<p>This chapter covers a lot of material, and it&rsquo;s OK not to get it all on the first pass. I&rsquo;ll refer back to it frequently in future chapters.</p>

<div class="label" id="sec:motivation"></div>


<h2><a id="sec:4.1" href="#sec:motivation" class="heading"><span class="number">4.1</span> Motivation</a></h2>


<p>As we saw in the last chapter, it&rsquo;s possible to develop the skeleton of a Rails application, and even start testing it, with essentially no knowledge of the underlying Ruby language. We did this by relying on the test code provided by the tutorial and addressing each error message until the test suite was passing. This situation can&rsquo;t last forever, though, and we&rsquo;ll open this chapter with an addition to the site that brings us face-to-face with our Ruby limitations.</p>

<p>When we last saw our new application, we had just updated our mostly static pages to use Rails layouts to eliminate duplication in our views (<a class="ref" href="#code:application_layout_redux">Listing&nbsp;4.1</a>).</p>

<div class="label" id="code:application_layout_redux"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.1.</span> <span class="description">The sample application site layout. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Let&rsquo;s focus on one particular line in <a class="ref" href="#code:application_layout_redux">Listing&nbsp;4.1</a>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This uses the built-in Rails function <code>stylesheet_link_tag</code> (which you can read more about at the <a href="http://api.rubyonrails.org/v3.2.0/classes/ActionView/Helpers/AssetTagHelper/StylesheetTagHelpers.html#method-i-stylesheet_link_tag">Rails API</a>) to include <code>application.css</code> for all <a href="http://www.w3.org/TR/CSS2/media.html">media types</a> (including computer screens and printers). To an experienced Rails developer, this line looks simple, but there are at least four potentially confusing Ruby ideas: built-in Rails methods, method invocation with missing parentheses, symbols, and hashes. We&rsquo;ll cover all of these ideas in this chapter.</p>

<p>In addition to coming equipped with a large number of built-in functions for use in the views, Rails also allows the creation of new ones. Such functions are called <em>helpers</em>; to see how to make a custom helper, let&rsquo;s start by examining the title line from <a class="ref" href="#code:application_layout_redux">Listing&nbsp;4.1</a>:</p>

<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This relies on the definition of a page title (using  <code>provide</code>) in each view, as in</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>


<p>But what if we don&rsquo;t provide a title? It&rsquo;s a good convention to have a <em>base title</em> we use on every page, with an optional page title if we want to be more specific. We&rsquo;ve <em>almost</em> achieved that with our current layout, with one wrinkle: as you can see if you delete the <code>provide</code> call in one of the views, in the absence of a page-specific  title the full title appears as follows:</p>

<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App | 
</pre></div>
</div>


<p>In other words, there&rsquo;s a suitable base title, but there&rsquo;s also a trailing vertical bar character <code>|</code> at the end.</p>

<p>To solve the problem of a missing page title, we&rsquo;ll define a custom helper called <code>full_title</code>. The <code>full_title</code> helper returns a base title, &ldquo;Ruby on Rails Tutorial Sample App&rdquo;, if no page title is defined, and adds a vertical bar followed by the page title if one is defined (<a class="ref" href="#code:title_helper">Listing&nbsp;4.2</a>).<sup class="footnote" id="fnref:4.1"><a href="#fn:4.1">1</a></sup></p>

<div class="label" id="code:title_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.2.</span> <span class="description">Defining a <code>full_title</code> helper. <br /> <code>app/helpers/application_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># Returns the full title on a per-page basis.</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">base_title</span>
    <span class="k">else</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now that we have a helper, we can use it to simplify our layout by replacing</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>with</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>as seen in <a class="ref" href="#code:application_layout_full_title">Listing&nbsp;4.3</a>.</p>

<div class="label" id="code:application_layout_full_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.3.</span> <span class="description">The sample application site layout. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>To put our helper to work, we can eliminate the unnecessary word &ldquo;Home&rdquo; from the Home page, allowing it to revert to the base title. We do this by first updating our test with the code in <a class="ref" href="#code:home_base_title_spec">Listing&nbsp;4.4</a>, which updates the previous title test and adds one to test for the absence of the custom <code>&rsquo;Home&rsquo;</code> string in the title.</p>

<div class="label" id="code:home_base_title_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.4.</span> <span class="description">Updated tests for the Home page&rsquo;s title. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>See if you can figure out why we&rsquo;ve added a new test instead of just altering the current one. (<em>Hint</em>: The answer is in <a class="ref" href="#sec:testing_a_title_change">Section&nbsp;3.3.1</a>.)</p>

<p>Let&rsquo;s run the test suite to verify that one test fails:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>To get the test suite to pass, we&rsquo;ll remove the <code>provide</code> line from the Home page&rsquo;s view, as seen in <a class="ref" href="#code:home_page_base_title">Listing&nbsp;4.5</a>.</p>

<div class="label" id="code:home_page_base_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.5.</span> <span class="description">The Home page with no custom page title. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>At this point the tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>As with the line to include the application stylesheet, the code in <a class="ref" href="#code:title_helper">Listing&nbsp;4.2</a> may look simple to the eyes of an experienced Rails developer, but it&rsquo;s <em>full</em> of potentially confusing Ruby ideas: modules, comments, local variable assignment, booleans, control flow, string interpolation, and return values. This chapter will cover all of these ideas as well.</p>

<div class="label" id="sec:strings_and_methods"></div>


<h2><a id="sec:4.2" href="#sec:strings_and_methods" class="heading"><span class="number">4.2</span> Strings and methods</a></h2>


<p>Our principal tool for learning Ruby will be the <em>Rails console</em>, a command-line tool for interacting with Rails applications first seen in <a class="ref" href="#sec:demo_user_has_many_microposts">Section&nbsp;2.3.3</a>. The console itself is built on top of interactive Ruby (<code>irb</code>), and thus has access to the full power of the Ruby language. (As we&rsquo;ll see in <a class="ref" href="#sec:a_controller_class">Section&nbsp;4.4.4</a>, the console also has access to the Rails environment.) Start the console at the command line as follows:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment</span>
<span class="gp">&gt;&gt; </span>
</pre></div>
</div>


<p>By default, the console starts in a <em>development environment</em>, which is one of three separate environments defined by Rails (the others are <em>test</em> and <em>production</em>). This distinction won&rsquo;t be important in this chapter, but we&rsquo;ll learn more about environments in <a class="ref" href="#sec:rails_environments">Section&nbsp;7.1.1</a>.</p>

<p>The console is a great learning tool, and you should feel free to explore&mdash;don&rsquo;t worry, you (probably) won&rsquo;t break anything. When using the console, type Ctrl-C if you get stuck, or Ctrl-D to exit the console altogether. Throughout the rest of this chapter, you might find it helpful to consult the <a href="http://ruby-doc.org/core-1.9.3/">Ruby API</a>. It&rsquo;s packed (perhaps even <em>too</em> packed) with information; for example, to learn more about Ruby strings you can look at the Ruby API entry for the <code>String</code> class.</p>

<div class="label" id="sec:comments"></div>


<h3><a id="sec:4.2.1" href="#sec:comments" class="heading"><span class="number">4.2.1</span> Comments</a></h3>


<p>Ruby <em>comments</em> start with the pound sign&nbsp;<code>#</code> (also called the &ldquo;hash mark&rdquo; or, more poetically, the &ldquo;octothorpe&rdquo;) and extend to the end of the line. Ruby ignores comments, but they are useful for human readers (including, often, the original author!). In the code</p>

<div class="code"><div class="highlight"><pre>  <span class="c1"># Returns the full title on a per-page basis.</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>the first line is a comment indicating the purpose of the subsequent function definition.</p>

<p>You don&rsquo;t ordinarily include comments in console sessions, but for instructional purposes I&rsquo;ll include some comments in what follows, like this:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="mi">17</span> <span class="o">+</span> <span class="mi">42</span>   <span class="c1"># Integer addition</span>
<span class="go">=&gt; 59</span>
</pre></div>
</div>


<p>If you follow along in this section typing or copying-and-pasting commands into your own console, you can of course omit the comments if you like; the console will ignore them in any case.</p>

<div class="label" id="sec:strings"></div>


<h3><a id="sec:4.2.2" href="#sec:strings" class="heading"><span class="number">4.2.2</span> Strings</a></h3>


<p><em>Strings</em> are probably the most important data structure for web applications, since web pages ultimately consist of strings of characters sent from the server to the browser. Let&rsquo;s start exploring strings with the console, this time started with <code>rails&nbsp;c</code>, which is a shortcut for <code>rails console</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails c</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span>         <span class="c1"># An empty string</span>
<span class="go">=&gt; &quot;&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span>      <span class="c1"># A nonempty string</span>
<span class="go">=&gt; &quot;foo&quot;</span>
</pre></div>
</div>


<p>These are <em>string literals</em> (also, amusingly, called <em>literal strings</em>), created using the double quote character&nbsp;<code>"</code>. The console prints the result of evaluating each line, which in the case of a string literal is just the string itself.</p>

<p>We can also concatenate strings with the <code>+</code> operator:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span> <span class="o">+</span> <span class="s2">&quot;bar&quot;</span>    <span class="c1"># String concatenation</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>Here the result of evaluating <code>"foo"</code> plus <code>"bar"</code> is the string <code>"foobar"</code>.<sup class="footnote" id="fnref:4.2"><a href="#fn:4.2">2</a></sup></p>

<p>Another way to build up strings is via <em>interpolation</em> using the special syntax <code>#{}</code>:<sup class="footnote" id="fnref:4.3"><a href="#fn:4.3">3</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>    <span class="c1"># Variable assignment</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> Hartl&quot;</span>     <span class="c1"># String interpolation</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
</pre></div>
</div>


<p>Here we&rsquo;ve <em>assigned</em> the value <code>"Michael"</code> to the variable <code>first_name</code> and then interpolated it into the string <code>"#{first_name} Hartl"</code>. We could also assign both strings a variable name:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">&quot;Hartl&quot;</span>
<span class="go">=&gt; &quot;Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">last_name</span>    <span class="c1"># Concatenation, with a space in between</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>    <span class="c1"># The equivalent interpolation</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
</pre></div>
</div>


<p>Note that the final two expressions are equivalent, but I prefer the interpolated version; having to add the single space <code>"&nbsp;"</code> seems a bit awkward.</p>

<div class="label" id="sec:printing"></div>


<h4><a id="sec:4.2.2.1" href="#sec:printing" class="heading">Printing</a></h4>


<p>To <em>print</em> a string, the most commonly used Ruby function is <code>puts</code> (pronounced &ldquo;put ess&rdquo;, for &ldquo;put string&rdquo;):</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;foo&quot;</span>     <span class="c1"># put string</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>The <code>puts</code> method operates as a <em>side-effect</em>: the expression <code>puts "foo"</code> prints the string to the screen and then returns <a href="http://www.answers.com/nil">literally nothing</a>: <code>nil</code> is a special Ruby value for &ldquo;nothing at all&rdquo;. (In what follows, I&rsquo;ll sometimes suppress the <code>=&gt; nil</code> part for simplicity.)</p>

<p>Using <code>puts</code> automatically appends a newline character&nbsp;<tt class="verb">\n</tt> to the output; the related <code>print</code> method does not:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">&quot;foo&quot;</span>    <span class="c1"># print string (same as puts, but without the newline)</span>
<span class="go">foo=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">&quot;foo</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Same as puts &quot;foo&quot;</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>




<div class="label" id="sec:single_quoted_strings"></div>


<h4><a id="sec:4.2.2.2" href="#sec:single_quoted_strings" class="heading">Single-quoted strings</a></h4>


<p>All the examples so far have used <em>double-quoted strings</em>, but Ruby also supports <em>single-quoted</em> strings. For many uses, the two types of strings are effectively identical:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;foo&#39;</span>          <span class="c1"># A single-quoted string</span>
<span class="go">=&gt; &quot;foo&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s1">&#39;foo&#39;</span> <span class="o">+</span> <span class="s1">&#39;bar&#39;</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>There&rsquo;s an important difference, though; Ruby won&rsquo;t interpolate into single-quoted strings:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;#{foo} bar&#39;</span>     <span class="c1"># Single-quoted strings don&#39;t allow interpolation</span>
<span class="go">=&gt; &quot;\#{foo} bar&quot;</span>
</pre></div>
</div>


<p>Note how the console returns values using double-quoted strings, which requires a backslash to <em>escape</em> special characters such as&nbsp;<code>#</code>.</p>

<p>If double-quoted strings can do everything that single-quoted strings can do, and interpolate to boot, what&rsquo;s the point of single-quoted strings? They are often useful because they are truly literal, and contain exactly the characters you type. For example, the &ldquo;backslash&rdquo; character is special on most systems, as in the literal newline&nbsp;<tt class="verb">\n</tt>. If you want a variable to contain a literal backslash, single quotes make it easier:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;\n&#39;</span>       <span class="c1"># A literal &#39;backslash n&#39; combination</span>
<span class="go">=&gt; &quot;\\n&quot;</span>
</pre></div>
</div>


<p>As with the&nbsp;<code>#</code> character in our previous example, Ruby needs to escape the backslash with an additional backslash; inside double-quoted strings, a literal backslash is represented with <em>two</em> backslashes. For a small example like this, there&rsquo;s not much savings, but if there are lots of things to escape it can be a real help:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;Newlines (\n) and tabs (\t) both use the backslash character \.&#39;</span>
<span class="go">=&gt; &quot;Newlines (\\n) and tabs (\\t) both use the backslash character \\.&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:objects_and_message_passing"></div>


<h3><a id="sec:4.2.3" href="#sec:objects_and_message_passing" class="heading"><span class="number">4.2.3</span> Objects and message passing</a></h3>


<p>Everything in Ruby, including strings and even <code>nil</code>, is an <em>object</em>. We&rsquo;ll see the technical meaning of this in <a class="ref" href="#sec:a_class_of_our_own">Section&nbsp;4.4.2</a>, but I don&rsquo;t think anyone ever understood objects by reading the definition in a book; you have to build up your intuition for objects by seeing lots of examples.</p>

<p>It&rsquo;s easier to describe what objects <em>do</em>, which is respond to messages. An object like a string, for example, can respond to the message <code>length</code>, which returns the number of characters in the string:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">length</span>        <span class="c1"># Passing the &quot;length&quot; message to a string</span>
<span class="go">=&gt; 6</span>
</pre></div>
</div>


<p>Typically, the messages that get passed to objects are <em>methods</em>, which are functions defined on those objects.<sup class="footnote" id="fnref:4.4"><a href="#fn:4.4">4</a></sup> Strings also respond to the <code>empty?</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Note the question mark at the end of the <code>empty?</code> method. This is a Ruby convention indicating that the return value is <em>boolean</em>: <code>true</code> or <code>false</code>. Booleans are especially useful for <em>control flow</em>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">&quot;The string is empty&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">&quot;The string is nonempty&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; &quot;The string is nonempty&quot;</span>
</pre></div>
</div>


<p>Booleans can also be combined using the <code>&amp;&amp;</code> (&ldquo;and&rdquo;), <code>||</code> (&ldquo;or&rdquo;), and <code>!</code> (&ldquo;not&rdquo;) operators:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
<span class="go">=&gt; &quot;foo&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="go">=&gt; &quot;&quot;</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;Both strings are empty&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;One of the strings is empty&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">&quot;One of the strings is empty&quot;</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;x is not empty&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">&quot;x is not empty&quot;</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Since everything in Ruby is an object, it follows that <code>nil</code> is an object, so it too can respond to methods. One example is the <code>to_s</code> method that can convert virtually any object to a string:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span>
<span class="go">=&gt; &quot;&quot;</span>
</pre></div>
</div>


<p>This certainly appears to be an empty string, as we can verify by <em>chaining</em> the messages we pass to <code>nil</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">NoMethodError: You have a nil object when you didn&#39;t expect it!</span>
<span class="go">You might have expected an instance of Array.</span>
<span class="go">The error occurred while evaluating nil.empty?</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span>      <span class="c1"># Message chaining</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>We see here that the <code>nil</code> object doesn&rsquo;t itself respond to the <code>empty?</code> method, but <code>nil.to_s</code> does.</p>

<p>There&rsquo;s a special method for testing for <code>nil</code>-ness, which you might be able to guess:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>The code</p>

<div class="code"><div class="highlight"><pre><span class="nb">puts</span> <span class="s2">&quot;x is not empty&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
</pre></div>
</div>


<p>also shows an alternate use of the <code>if</code> keyword: Ruby allows you to write a statement that is evaluated only if the statement following <code>if</code> is true. There&rsquo;s a complementary <code>unless</code> keyword that works the same way:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;The string &#39;</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">&#39; is nonempty.&quot;</span> <span class="k">unless</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">The string &#39;foobar&#39; is nonempty.</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>It&rsquo;s worth noting that the <code>nil</code> object is special, in that it is the <em>only</em> Ruby object that is false in a boolean context, apart from <code>false</code> itself:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="kp">nil</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>        <span class="c1"># nil is false</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>In particular, all other Ruby objects are <em>true</em>, even 0:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="mi">0</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>        <span class="c1"># 0 (and everything other than nil and false itself) is true</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<div class="label" id="sec:method_definitions"></div>


<h3><a id="sec:4.2.4" href="#sec:method_definitions" class="heading"><span class="number">4.2.4</span> Method definitions</a></h3>


<p>The console allows us to define methods the same way we did with the <code>home</code> action from <a class="ref" href="#code:static_pages_controller">Listing&nbsp;3.6</a> or the <code>full_title</code> helper from <a class="ref" href="#code:title_helper">Listing&nbsp;4.2</a>. (Defining methods in the console is a bit cumbersome, and ordinarily you would use a file, but it&rsquo;s convenient for demonstration purposes.) For example, let&rsquo;s define a function <code>string_message</code> that takes a single <em>argument</em> and returns a message based on whether the argument is empty or not:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">&quot;It&#39;s an empty string!&quot;</span>
<span class="gp">&gt;&gt; </span>  <span class="k">else</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">&quot;The string is nonempty.&quot;</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">It&#39;s an empty string!</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">The string is nonempty.</span>
</pre></div>
</div>


<p>Note that Ruby functions have an <em>implicit return</em>, meaning they return the last statement evaluated&mdash;in this case, one of the two message strings, depending on whether the method&rsquo;s argument <code>string</code> is empty or not. Ruby also has an explicit return option; the following function is equivalent to the one above:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">&quot;It&#39;s an empty string!&quot;</span> <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">&quot;The string is nonempty.&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
</pre></div>
</div>


<p>The alert reader might notice at this point that the second <code>return</code> here is actually unnecessary&mdash;being the last expression in the function, the string <code>"The string is nonempty."</code> will be returned regardless of the <code>return</code> keyword, but using <code>return</code> in both places has a pleasing symmetry to it.</p>

<div class="label" id="sec:back_to_the_title_helper"></div>


<h3><a id="sec:4.2.5" href="#sec:back_to_the_title_helper" class="heading"><span class="number">4.2.5</span> Back to the title helper</a></h3>


<p>We are now in a position to understand the <code>full_title</code> helper from <a class="ref" href="#code:title_helper">Listing&nbsp;4.2</a>:<sup class="footnote" id="fnref:4.5"><a href="#fn:4.5">5</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># Returns the full title on a per-page basis.       # Documentation comment</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>                          <span class="c1"># Method definition</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>  <span class="c1"># Variable assignment</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>                              <span class="c1"># Boolean test</span>
      <span class="n">base_title</span>                                      <span class="c1"># Implicit return</span>
    <span class="k">else</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>                 <span class="c1"># String interpolation</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>These elements&mdash;function definition, variable assignment, boolean tests, control flow, and string interpolation&mdash;come together to make a compact helper method for use in our site layout. The final element is <code>module ApplicationHelper</code>: modules give us a way to package together related methods, which can then be <em>mixed in</em> to Ruby classes using <code>include</code>. When writing ordinary Ruby, you often write modules and include them explicitly yourself, but in the case of a helper module Rails handles the inclusion for us. The result is that the <code>full_title</code> method is <a href="http://catb.org/jargon/html/A/automagically.html">automagically</a> available in all our views.</p>

<div class="label" id="sec:other_data_structures"></div>


<h2><a id="sec:4.3" href="#sec:other_data_structures" class="heading"><span class="number">4.3</span> Other data structures</a></h2>


<p>Although web apps are ultimately about strings, actually <em>making</em> those strings requires using other data structures as well. In this section, we&rsquo;ll learn about some Ruby data structures important for writing Rails applications.</p>

<div class="label" id="sec:arrays_and_ranges"></div>


<h3><a id="sec:4.3.1" href="#sec:arrays_and_ranges" class="heading"><span class="number">4.3.1</span> Arrays and ranges</a></h3>


<p>An array is just a list of elements in a particular order. We haven&rsquo;t discussed arrays yet in the <em>Rails Tutorial</em>, but understanding them gives a good foundation for understanding hashes (<a class="ref" href="#sec:hashes_and_symbols">Section&nbsp;4.3.3</a>) and for aspects of Rails data modeling (such as the <code>has_many</code> association seen in <a class="ref" href="#sec:demo_user_has_many_microposts">Section&nbsp;2.3.3</a> and covered more in <a class="ref" href="#sec:user_micropost_associations">Section&nbsp;10.1.3</a>).</p>

<p>So far we&rsquo;ve spent a lot of time understanding strings, and there&rsquo;s a natural way to get from strings to arrays using the <code>split</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span> <span class="s2">&quot;foo bar     baz&quot;</span><span class="o">.</span><span class="n">split</span>     <span class="c1"># Split a string into a three-element array</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>The result of this operation is an array of three strings. By default, <code>split</code> divides a string into an array by splitting on whitespace, but you can split on nearly anything else as well:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;fooxbarxbazx&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>As is conventional in most computer languages, Ruby arrays are <em>zero-offset</em>, which means that the first element in the array has index&nbsp;0, the second has index&nbsp;1, and so on:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="o">]</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>               <span class="c1"># Ruby uses square brackets for array access.</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>              <span class="c1"># Indices can even be negative!</span>
<span class="go">=&gt; 17</span>
</pre></div>
</div>


<p>We see here that Ruby uses square brackets to access array elements.
In addition to this bracket notation, Ruby offers synonyms for some commonly accessed elements:<sup class="footnote" id="fnref:4.6"><a href="#fn:4.6">6</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>                  <span class="c1"># Just a reminder of what &#39;a&#39; is</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">second</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>    <span class="c1"># Comparison using ==</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>This last line introduces the equality comparison operator <code>==</code>, which Ruby shares with many other languages, along with the associated <code>!=</code> (&ldquo;not equal&rdquo;), etc.:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span>       <span class="c1"># Like strings, arrays respond to the &#39;length&#39; method.</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">3</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">!=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>In addition to <code>length</code> (seen in the first line above), arrays respond to a wealth of other methods:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; [17, 8, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shuffle</span>
<span class="go">=&gt; [17, 42, 8]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
</pre></div>
</div>


<p>Note that none of the methods above changes <code>a</code> itself. To <em>mutate</em> the array, use the corresponding &ldquo;bang&rdquo; methods (so-called because the exclamation point is usually pronounced &ldquo;bang&rdquo; in this context):</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort!</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [8, 17, 42]</span>
</pre></div>
</div>


<p>You can also add to arrays with the <code>push</code> method or its equivalent operator, <tt class="verb">&lt;&lt;</tt>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>                  <span class="c1"># Pushing 6 onto an array</span>
<span class="go">=&gt; [42, 8, 17, 6]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>                     <span class="c1"># Pushing 7 onto an array</span>
<span class="go">=&gt; [42, 8, 17, 6, 7]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;foo&quot;</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;bar&quot;</span>        <span class="c1"># Chaining array pushes</span>
<span class="go">=&gt; [42, 8, 17, 6, 7, &quot;foo&quot;, &quot;bar&quot;]</span>
</pre></div>
</div>


<p>This last example shows that you can chain pushes together, and also that, unlike arrays in many other languages, Ruby arrays can contain a mixture of different types (in this case, integers and strings).</p>

<p>Before we saw <code>split</code> convert a string to an array. We can also go the other way with the <code>join</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17, 7, &quot;foo&quot;, &quot;bar&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span>                       <span class="c1"># Join on nothing</span>
<span class="go">=&gt; &quot;428177foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>                 <span class="c1"># Join on comma-space</span>
<span class="go">=&gt; &quot;42, 8, 17, 7, foo, bar&quot;</span>
</pre></div>
</div>


<p>Closely related to arrays are <em>ranges</em>, which can probably most easily be understood by converting them to arrays using the <code>to_a</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span>
<span class="go">=&gt; 0..9</span>
<span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="o">.</span><span class="n">to_a</span>              <span class="c1"># Oops, call to_a on 9</span>
<span class="go">NoMethodError: undefined method `to_a&#39; for 9:Fixnum</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># Use parentheses to call to_a on the range</span>
<span class="go">=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
</pre></div>
</div>


<p>Though <code>0..9</code> is a valid range, the second expression above shows that we need to add parentheses to call a method on it.</p>

<p>Ranges are useful for pulling out array elements:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="sx">%w[foo bar baz quux]</span>         <span class="c1"># Use %w to make a string array.</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;, &quot;quux&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>Ranges also work with characters:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;e&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</span>
</pre></div>
</div>


<div class="label" id="sec:blocks"></div>


<h3><a id="sec:4.3.2" href="#sec:blocks" class="heading"><span class="number">4.3.2</span> Blocks</a></h3>


<p>Both arrays and ranges respond to a host of methods that accept <em>blocks</em>, which are simultaneously one of Ruby&rsquo;s most powerful and most confusing features:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="p">}</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>This code calls the <code>each</code> method on the range <code>(1..5)</code> and passes it the block <code>{ |i| puts 2 * i }</code>. The vertical bars around the variable name in&nbsp;<code>|i|</code> are Ruby syntax for a block variable, and it&rsquo;s up to the method to know what to do with the block. In this case, the range&rsquo;s <code>each</code> method can handle a block with a single local variable, which we&rsquo;ve called&nbsp;<code>i</code>, and it just executes the block for each value in the range.</p>

<p>Curly braces are one way to indicate a block, but there is a second way as well:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>Blocks can be more than one line, and often are. In the <em>Rails Tutorial</em> we&rsquo;ll follow the common convention of using curly braces only for short one-line blocks and the <code>do..end</code> syntax for longer one-liners and for multi-line blocks:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">number</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">number</span>
<span class="gp">&gt;&gt; </span>  <span class="nb">puts</span> <span class="s1">&#39;--&#39;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">--</span>
<span class="go">4</span>
<span class="go">--</span>
<span class="go">6</span>
<span class="go">--</span>
<span class="go">8</span>
<span class="go">--</span>
<span class="go">10</span>
<span class="go">--</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>Here I&rsquo;ve used <code>number</code> in place of&nbsp;<code>i</code> just to emphasize that any variable name will do.</p>

<p>Unless you already have a substantial programming background, there is no shortcut to understanding blocks; you just have to see them a lot, and eventually you&rsquo;ll get used to them.<sup class="footnote" id="fnref:4.7"><a href="#fn:4.7">7</a></sup> Luckily, humans are quite good at making generalizations from concrete examples; here are a few more, including a couple using the <code>map</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Betelgeuse!&quot;</span> <span class="p">}</span>   <span class="c1"># 3.times takes a block with no variables.</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="p">}</span>          <span class="c1"># The ** notation is for &#39;power&#39;.</span>
<span class="go">=&gt; [1, 4, 9, 16, 25]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span>                        <span class="c1"># Recall that %w makes string arrays.</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[A B C]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>
</pre></div>
</div>


<p>As you can see, the <code>map</code> method returns the result of applying the given block to each element in the array or range.</p>

<p>By the way, we&rsquo;re now in a position to understand the line of Ruby I threw into <a class="ref" href="#sec:heroku_commands">Section&nbsp;1.4.4</a> to generate random subdomains:</p>

<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div>
</div>


<p>Let&rsquo;s build it up step-by-step:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>                     <span class="c1"># An alphabet array</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;, &quot;g&quot;, &quot;h&quot;, &quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;l&quot;, &quot;m&quot;, &quot;n&quot;, &quot;o&quot;,</span>
<span class="go">&quot;p&quot;, &quot;q&quot;, &quot;r&quot;, &quot;s&quot;, &quot;t&quot;, &quot;u&quot;, &quot;v&quot;, &quot;w&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span>             <span class="c1"># Shuffle it.</span>
<span class="go">=&gt; [&quot;c&quot;, &quot;g&quot;, &quot;l&quot;, &quot;k&quot;, &quot;h&quot;, &quot;z&quot;, &quot;s&quot;, &quot;i&quot;, &quot;n&quot;, &quot;d&quot;, &quot;y&quot;, &quot;u&quot;, &quot;t&quot;, &quot;j&quot;, &quot;q&quot;,</span>
<span class="go">&quot;b&quot;, &quot;r&quot;, &quot;o&quot;, &quot;f&quot;, &quot;e&quot;, &quot;w&quot;, &quot;v&quot;, &quot;m&quot;, &quot;a&quot;, &quot;x&quot;, &quot;p&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">]</span>       <span class="c1"># Pull out the first eight elements.</span>
<span class="go">=&gt; [&quot;f&quot;, &quot;w&quot;, &quot;i&quot;, &quot;a&quot;, &quot;h&quot;, &quot;p&quot;, &quot;c&quot;, &quot;x&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>  <span class="c1"># Join them together to make one string.</span>
<span class="go">=&gt; &quot;mznpybuj&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:hashes_and_symbols"></div>


<h3><a id="sec:4.3.3" href="#sec:hashes_and_symbols" class="heading"><span class="number">4.3.3</span> Hashes and symbols</a></h3>


<p>Hashes are essentially a generalization of arrays: you can think of hashes as basically like arrays, but not limited to integer indices. (In fact, some languages, especially Perl, sometimes call hashes <em>associative arrays</em> for this reason.) Instead, hash indices, or <em>keys</em>, can be almost any object. For example, we can use strings as keys:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>                          <span class="c1"># {} is an empty hash.</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;first_name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>     <span class="c1"># Key &quot;first_name&quot;, value &quot;Michael&quot;</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;last_name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Hartl&quot;</span>        <span class="c1"># Key &quot;last_name&quot;, value &quot;Hartl&quot;</span>
<span class="go">=&gt; &quot;Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;first_name&quot;</span><span class="o">]</span>                 <span class="c1"># Element access is like arrays.</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span>                               <span class="c1"># A literal representation of the hash</span>
<span class="go">=&gt; {&quot;last_name&quot;=&gt;&quot;Hartl&quot;, &quot;first_name&quot;=&gt;&quot;Michael&quot;}</span>
</pre></div>
</div>


<p>Hashes are indicated with curly braces containing key-value pairs; a pair of braces with no key-value pairs&mdash;i.e., <code>{}</code>&mdash;is an empty hash. It&rsquo;s important to note that the curly braces for hashes have nothing to do with the curly braces for blocks. (Yes, this can be confusing.) Although hashes resemble arrays, one important difference is that hashes don&rsquo;t generally guarantee keeping their elements in a particular order.<sup class="footnote" id="fnref:4.8"><a href="#fn:4.8">8</a></sup> If order matters, use an array.</p>

<p>Instead of defining hashes one item at a time using square brackets, it&rsquo;s easy to use a literal representation with keys and values separated by&nbsp;<code>=&gt;</code>, called a &ldquo;hashrocket&rdquo;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;first_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hartl&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {&quot;last_name&quot;=&gt;&quot;Hartl&quot;, &quot;first_name&quot;=&gt;&quot;Michael&quot;}</span>
</pre></div>
</div>


<p>Here I&rsquo;ve used the usual Ruby convention of putting an extra space at the two ends of the hash&mdash;a convention ignored by the console output. (Don&rsquo;t ask me why the spaces are conventional; probably some early influential Ruby programmer liked the look of the extra spaces, and the convention stuck.)</p>

<p>So far we&rsquo;ve used strings as hash keys, but in Rails it is much more common to use <em>symbols</em> instead. Symbols look kind of like strings, but prefixed with a colon instead of surrounded by quotes. For example, <code>:name</code> is a symbol. You can think of symbols as basically strings without all the extra baggage:<sup class="footnote" id="fnref:4.9"><a href="#fn:4.9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;name&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="go">=&gt; [&quot;n&quot;, &quot;a&quot;, &quot;m&quot;, &quot;e&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="ss">:name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="go">NoMethodError: undefined method `split&#39; for :name:Symbol</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; &quot;raboof&quot;</span>
<span class="gp">&gt;&gt; </span><span class="ss">:foobar</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">NoMethodError: undefined method `reverse&#39; for :foobar:Symbol</span>
</pre></div>
</div>


<p>Symbols are a special Ruby data type shared with very few other languages, so they may seem weird at first, but Rails uses them a lot, so you&rsquo;ll get used to them fast.</p>

<p>In terms of symbols as hash keys, we can define a <code>user</code> hash as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>              <span class="c1"># Access the value corresponding to :name.</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>          <span class="c1"># Access the value of an undefined key.</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>We see here from the last example that the hash value for an undefined key is simply <code>nil</code>.</p>

<p>Since it&rsquo;s so common for hashes to use symbols as keys, Ruby&nbsp;1.9 supports a new syntax just for this special case:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;} </span>
<span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">==</span> <span class="n">h2</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>The second syntax replaces the symbol/hashrocket combination with the name of the key followed by a colon and a value:</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>This construction more closely follows the hash notation in other languages (such as JavaScript) and enjoys growing popularity in the Rails community. Both syntaxes are still in common use, so it&rsquo;s essential to be able to recognize them. Most hashes in the rest of this book use the new notation, which won&rsquo;t work with Ruby&nbsp;1.8.7 or earlier; if you are using an earlier version of Ruby, you will either have to upgrade to Ruby&nbsp;1.9 (recommended) or use the old hash notation.</p>

<p>Hash values can be virtually anything, even other hashes, as seen in <a class="ref" href="#code:nested_hashes">Listing&nbsp;4.6</a>.</p>

<div class="label" id="code:nested_hashes"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.6.</span> <span class="description">Nested hashes.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># Define a hash called &#39;params&#39; (short for &#39;parameters&#39;).</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;mhartl@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span>
<span class="go">=&gt; {:user=&gt;{:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;mhartl@example.com&quot;}}</span>
<span class="gp">&gt;&gt; </span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
</pre></div>
</div></div>


<p>These sorts of hashes-of-hashes, or <em>nested hashes</em>, are heavily used by Rails, as we&rsquo;ll see starting in <a class="ref" href="#sec:signup_failure">Section&nbsp;7.3</a>.</p>

<p>As with arrays and ranges, hashes respond to the <code>each</code> method. For example, consider a hash named <code>flash</code> with keys for two conditions, <code>:success</code> and <code>:error</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success:</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">error:</span> <span class="s2">&quot;It failed.&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, :error=&gt;&quot;It failed.&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;Key </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">Key :success has value &quot;It worked!&quot;</span>
<span class="go">Key :error has value &quot;It failed.&quot;</span>
</pre></div>
</div>


<p>Note that, while the <code>each</code> method for arrays takes a block with only one variable, <code>each</code> for hashes takes two, a <em>key</em> and a <em>value</em>. Thus, the <code>each</code> method for a hash iterates through the hash one key-value <em>pair</em> at a time.</p>

<p>The last example uses the useful <code>inspect</code> method, which returns a string with a literal representation of the object it&rsquo;s called on:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># Put an array as a string.</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">4</span>
<span class="go">5</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">inspect</span>    <span class="c1"># Put a literal array.</span>
<span class="go">[1, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:name</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">name</span>
<span class="go">:name</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="s2">&quot;It worked!&quot;</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">It worked!</span>
<span class="go">&quot;It worked!&quot;</span>
</pre></div>
</div>


<p>By the way, using <code>inspect</code> to print an object is common enough that there&rsquo;s a shortcut for it, the <code>p</code> function:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">p</span> <span class="ss">:name</span>             <span class="c1"># Same as &#39;puts :name.inspect&#39;</span>
<span class="go">:name</span>
</pre></div>
</div>




<div class="label" id="sec:css_revisited"></div>


<h3><a id="sec:4.3.4" href="#sec:css_revisited" class="heading"><span class="number">4.3.4</span> CSS revisited</a></h3>


<p>It&rsquo;s time now to revisit the line from <a class="ref" href="#code:application_layout_redux">Listing&nbsp;4.1</a> used in the layout to include the cascading style sheets:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>We are now nearly in a position to understand this. As mentioned briefly in <a class="ref" href="#sec:motivation">Section&nbsp;4.1</a>, Rails defines a special function to include stylesheets, and</p>

<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>is a call to this function. But there are two mysteries. First, where are the parentheses? In Ruby, they are optional; these two lines are equivalent:</p>

<div class="code"><div class="highlight"><pre><span class="c1"># Parentheses on function calls are optional.</span>
<span class="n">stylesheet_link_tag</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>Second, the <code>:media</code> argument sure looks like a hash, but where are the curly braces? When hashes are the <em>last</em> argument in a function call, the curly braces are optional; these two lines are equivalent:</p>

<div class="code"><div class="highlight"><pre><span class="c1"># Curly braces on final hash arguments are optional.</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="p">}</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>So, we see now that the line</p>

<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>calls the <code>stylesheet_link_tag</code> function with two arguments: a string, indicating the path to the stylesheet, and a hash, indicating the media type. Because of the <tt class="verb">&lt;%= %&gt;</tt> brackets, the results are inserted into the template by ERb, and if you view the source of the page in your browser you should see the HTML needed to include a stylesheet (<a class="ref" href="#code:scss_source">Listing&nbsp;4.7</a>). (You may see some extra things, like <code>?body=1</code>, after the CSS filenames. These are inserted by Rails to ensure that browsers reload the CSS when it changes on the server.)</p>

<div class="label" id="code:scss_source"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.7.</span> <span class="description">The HTML source produced by the CSS includes.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/assets/application.css&quot;</span> <span class="na">media=</span><span class="s">&quot;all&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
<span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div></div>


<p>If you actually view the CSS file by navigating to <a href="http://localhost:3000/assets/application.css">http://localhost:3000/assets/application.css</a>, you&rsquo;ll see that (apart from some comments) it is empty. We&rsquo;ll set about changing this in <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a>.</p>

<div class="label" id="sec:ruby_classes"></div>


<h2><a id="sec:4.4" href="#sec:ruby_classes" class="heading"><span class="number">4.4</span> Ruby classes</a></h2>


<p>We&rsquo;ve said before that everything in Ruby is an object, and in this section we&rsquo;ll finally get to define some of our own. Ruby, like many object-oriented languages, uses <em>classes</em> to organize methods; these classes are then <em>instantiated</em> to create objects. If you&rsquo;re new to object-oriented programming, this may sound like gibberish, so let&rsquo;s look at some concrete examples.</p>

<div class="label" id="sec:constructors"></div>


<h3><a id="sec:4.4.1" href="#sec:constructors" class="heading"><span class="number">4.4.1</span> Constructors</a></h3>


<p>We&rsquo;ve seen lots of examples of using classes to instantiate objects, but we have yet to do so explicitly. For example, we instantiated a string using the double quote characters, which is a <em>literal constructor</em> for strings:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>       <span class="c1"># A literal constructor for strings using double quotes</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
</pre></div>
</div>


<p>We see here that strings respond to the method <code>class</code>, and simply return the class they belong to.</p>

<p>Instead of using a literal constructor, we can use the equivalent <em>named constructor</em>, which involves calling the <code>new</code> method on the class name:<sup class="footnote" id="fnref:4.10"><a href="#fn:4.10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>   <span class="c1"># A named constructor for a string</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;foobar&quot;</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>This is equivalent to the literal constructor, but it&rsquo;s more explicit about what we&rsquo;re doing.</p>

<p>Arrays work the same way as strings:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span>
<span class="go">=&gt; [1, 3, 2]</span>
</pre></div>
</div>


<p>Hashes, in contrast, are different. While the array constructor <code>Array.new</code> takes an initial value for the array, <code>Hash.new</code> takes a <em>default</em> value for the hash, which is the value of the hash for a nonexistent key:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>            <span class="c1"># Try to access the value for the nonexistent key :foo.</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># Arrange for nonexistent keys to return 0 instead of nil.</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>When a method gets called on the class itself, as in the case of <code>new</code>, it&rsquo;s called a <em>class method</em>. The result of calling <code>new</code> on a class is an object of that class, also called an <em>instance</em> of the class. A method called on an instance, such as <code>length</code>, is called an <em>instance method</em>.</p>

<div class="label" id="sec:a_class_of_our_own"></div>


<h3><a id="sec:4.4.2" href="#sec:a_class_of_our_own" class="heading"><span class="number">4.4.2</span> Class inheritance</a></h3>


<p>When learning about classes, it&rsquo;s useful to find out the <em>class hierarchy</em> using the <code>superclass</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>                        <span class="c1"># Find the class of s.</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>             <span class="c1"># Find the superclass of String.</span>
<span class="go">=&gt; Object</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>  <span class="c1"># Ruby 1.9 uses a new BasicObject base class</span>
<span class="go">=&gt; BasicObject </span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>A diagram of this inheritance hierarchy appears in <a class="ref" href="#fig:string_inheritance_ruby_1_9">Figure&nbsp;4.1</a>. We see here that the superclass of <code>String</code> is <code>Object</code> and the superclass of <code>Object</code> is <code>BasicObject</code>, but <code>BasicObject</code> has no superclass. This pattern is true of every Ruby object: trace back the class hierarchy far enough and every class in Ruby ultimately inherits from <code>BasicObject</code>, which has no superclass itself. This is the technical meaning of &ldquo;everything in Ruby is an object&rdquo;.</p>

<div class="label" id="fig:string_inheritance_ruby_1_9"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/string_inheritance_ruby_1_9.png" alt="string_inheritance_ruby_1_9" /></span></div><div class="caption"><span class="header">Figure 4.1: </span><span class="description">The inheritance hierarchy for the <code>String</code> class.</span></div></div>


<p>To understand classes a little more deeply, there&rsquo;s no substitute for making one of our own. Let&rsquo;s make a <code>Word</code> class with a <code>palindrome?</code> method that returns <code>true</code> if the word is the same spelled forward and backward:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>    <span class="n">string</span> <span class="o">==</span> <span class="n">string</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>We can use it as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">w</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span>              <span class="c1"># Make a new Word object.</span>
<span class="go">=&gt; #&lt;Word:0x22d0b20&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>If this example strikes you as a bit contrived, good; this is by design. It&rsquo;s odd to create a new class just to create a method that takes a string as an argument. Since a word <em>is a</em> string, it&rsquo;s more natural to have our <code>Word</code> class <em>inherit</em> from <code>String</code>, as seen in <a class="ref" href="#code:word_class">Listing&nbsp;4.8</a>. (You should exit the console and re-enter it to clear out the old definition of <code>Word</code>.)</p>

<div class="label" id="code:word_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.8.</span> <span class="description">Defining a <code>Word</code> class in the console.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span> <span class="o">&lt;</span> <span class="nb">String</span>             <span class="c1"># Word inherits from String.</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># Returns true if the string is its own reverse.</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>        <span class="c1"># self is the string itself.</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div></div>


<p>Here <code>Word &lt; String</code> is the Ruby syntax for inheritance (discussed briefly in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a>), which ensures that, in addition to the new <code>palindrome?</code> method, words also have all the same methods as strings:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>    <span class="c1"># Make a new Word, initialized with &quot;level&quot;.</span>
<span class="go">=&gt; &quot;level&quot;                  </span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">palindrome?</span>            <span class="c1"># Words have the palindrome? method.</span>
<span class="go">=&gt; true                     </span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>                 <span class="c1"># Words also inherit all the normal string methods.</span>
<span class="go">=&gt; 5</span>
</pre></div>
</div>


<p>Since the <code>Word</code> class inherits from <code>String</code>, we can use the console to see the class hierarchy explicitly:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Word</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div>
</div>


<p>This hierarchy is illustrated in <a class="ref" href="#fig:word_inheritance_ruby_1_9">Figure&nbsp;4.2</a>.</p>

<div class="label" id="fig:word_inheritance_ruby_1_9"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/word_inheritance_ruby_1_9.png" alt="word_inheritance_ruby_1_9" /></span></div><div class="caption"><span class="header">Figure 4.2: </span><span class="description">The inheritance hierarchy for the (non-built-in) <code>Word</code> class from <a class="ref" href="#code:word_class">Listing&nbsp;4.8</a>.</span></div></div>


<p>In <a class="ref" href="#code:word_class">Listing&nbsp;4.8</a>, note that checking that the word is its own reverse involves accessing the word inside the <code>Word</code> class. Ruby allows us to do this using the <code>self</code> keyword: inside the <code>Word</code> class, <code>self</code> is the object itself, which means we can use</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
</pre></div>
</div>


<p>to check if the word is a palindrome.<sup class="footnote" id="fnref:4.11"><a href="#fn:4.11">11</a></sup></p>

<div class="label" id="sec:modifying_built_in_classes"></div>


<h3><a id="sec:4.4.3" href="#sec:modifying_built_in_classes" class="heading"><span class="number">4.4.3</span> Modifying built-in classes</a></h3>


<p>While inheritance is a powerful idea, in the case of palindromes it might be even more natural to add the <code>palindrome?</code> method to the <code>String</code> class itself, so that (among other things) we can call <code>palindrome?</code> on a string literal, which we currently can&rsquo;t do:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;level&quot;</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">NoMethodError: undefined method `palindrome?&#39; for &quot;level&quot;:String</span>
</pre></div>
</div>


<p>Somewhat amazingly, Ruby lets you do just this; Ruby classes can be <em>opened</em> and modified, allowing ordinary mortals such as ourselves to add methods to them:<sup class="footnote" id="fnref:4.12"><a href="#fn:4.12">12</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># Returns true if the string is its own reverse.</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;deified&quot;</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>(I don&rsquo;t know which is cooler: that Ruby lets you add methods to built-in classes, or that <code>"deified"</code> is a palindrome.)</p>

<p>Modifying built-in classes is a powerful technique, but with great power comes great responsibility, and it&rsquo;s considered bad form to add methods to built-in classes without having a <em>really</em> good reason for doing so. Rails does have some good reasons; for example, in web applications we often want to prevent variables from being <em>blank</em>&mdash;e.g., a user&rsquo;s name should be something other than spaces and other <a href="http://en.wikipedia.org/wiki/Whitespace_(computer_science)">whitespace</a>&mdash;so Rails adds a <code>blank?</code> method to Ruby. Since the Rails console automatically includes the Rails extensions, we can see an example here (this won&rsquo;t work in plain <code>irb</code>):</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;      &quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;      &quot;</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>We see that a string of spaces is not <em>empty</em>, but it is <em>blank</em>. Note also that <code>nil</code> is blank; since <code>nil</code> isn&rsquo;t a string, this is a hint that Rails actually adds <code>blank?</code> to <code>String</code>&rsquo;s base class, which (as we saw at the beginning of this section) is <code>Object</code> itself. We&rsquo;ll see some other examples of Rails additions to Ruby classes in <a class="ref" href="#sec:remember_me">Section&nbsp;8.2.1</a>.</p>

<div class="label" id="sec:a_controller_class"></div>


<h3><a id="sec:4.4.4" href="#sec:a_controller_class" class="heading"><span class="number">4.4.4</span> A controller class</a></h3>


<p>All this talk about classes and inheritance may have triggered a flash of recognition, because we have seen both before, in the StaticPages controller (<a class="ref" href="#code:adding_the_about_page">Listing&nbsp;3.15</a>):</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>You&rsquo;re now in a position to appreciate, at least vaguely, what this code means: <code>StaticPagesController</code> is a class that inherits from <code>ApplicationController</code>, and comes equipped with <code>home</code>, <code>help</code>, and <code>about</code> methods. Since each Rails console session loads the local Rails environment, we can even create a controller explicitly and examine its class hierarchy:<sup class="footnote" id="fnref:4.13"><a href="#fn:4.13">13</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span> <span class="o">=</span> <span class="no">StaticPagesController</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;StaticPagesController:0x22855d0&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; StaticPagesController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ApplicationController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Metal</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; AbstractController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div>
</div>


<p>A diagram of this hierarchy appears in <a class="ref" href="#fig:static_pages_controller_inheritance">Figure&nbsp;4.3</a>.</p>

<div class="label" id="fig:static_pages_controller_inheritance"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/static_pages_controller_inheritance.png" alt="static_pages_controller_inheritance" /></span></div><div class="caption"><span class="header">Figure 4.3: </span><span class="description">The inheritance hierarchy for the StaticPages controller.</span></div></div>


<p>We can even call the controller actions inside the console, which are just methods:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">home</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Here the return value is <code>nil</code> because the <code>home</code> action is blank.</p>

<p>But wait&mdash;actions don&rsquo;t have return values, at least not ones that matter. The point of the <code>home</code> action, as we saw in <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>, is to render a web page, not to return a value. And I sure don&rsquo;t remember ever calling <code>StaticPagesController.new</code> anywhere. What&rsquo;s going on?</p>

<p>What&rsquo;s going on is that Rails is <em>written in</em> Ruby, but Rails isn&rsquo;t Ruby. Some Rails classes are used like ordinary Ruby objects, but some are just <a href="http://www.answers.com/grist">grist</a> for Rails&rsquo; magic mill. Rails is <a href="http://en.wikipedia.org/wiki/Sui_generis"><em>sui generis</em></a>, and should be studied and understood separately from Ruby. This is why, if your principal programming interest is writing web applications, I recommend learning Rails first, then learning Ruby, then looping back to Rails.</p>

<div class="label" id="sec:a_user_class"></div>


<h3><a id="sec:4.4.5" href="#sec:a_user_class" class="heading"><span class="number">4.4.5</span> A user class</a></h3>


<p>We end our tour of Ruby with a complete class of our own, a <code>User</code> class that anticipates the User model coming up in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>.</p>

<p>So far we&rsquo;ve entered class definitions at the console, but this quickly becomes tiresome; instead, create the file <code>example_user.rb</code> in your application root directory and fill it with the contents of <a class="ref" href="#code:example_user">Listing&nbsp;4.9</a>.</p>

<div class="label" id="code:example_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.9.</span> <span class="description">Code for an example user. <br /> <code>example_user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>There&rsquo;s quite a bit going on here, so let&rsquo;s take it step by step. The first line,</p>

<div class="code"><div class="highlight"><pre>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
</pre></div>
</div>


<p>creates <em>attribute accessors</em> corresponding to a user&rsquo;s name and email address. This creates &ldquo;getter&rdquo; and &ldquo;setter&rdquo; methods that allow us to retrieve (get) and assign (set) <code>@name</code> and <code>@email</code> <em>instance variables</em>, which were mentioned briefly in <a class="ref" href="#sec:mvc_in_action">Section&nbsp;2.2.2</a>. In Rails, the principal importance of instance variables is that they are automatically available in the views, but in general they are used for variables that need to be available throughout a Ruby class. (We&rsquo;ll have more to say about this in a moment.) Instance variables always begin with an&nbsp;<code>@</code> sign, and are <code>nil</code> when undefined.</p>

<p>The first method, <code>initialize</code>, is special in Ruby: it&rsquo;s the method called when we execute <code>User.new</code>. This particular <code>initialize</code> takes one argument, <code>attributes</code>:</p>

<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>Here the <code>attributes</code> variable has a <em>default value</em> equal to the empty hash, so that we can define a user with no name or email address (recall from <a class="ref" href="#sec:hashes_and_symbols">Section&nbsp;4.3.3</a> that hashes return <code>nil</code> for nonexistent keys, so <code>attributes[:name]</code> will be <code>nil</code> if there is no <code>:name</code> key, and similarly for <code>attributes[:email]</code>).</p>

<p>Finally, our class defines a method called <code>formatted_email</code> that uses the values of the assigned <code>@name</code> and <code>@email</code> variables to build up a nicely formatted version of the user&rsquo;s email address using string interpolation (<a class="ref" href="#sec:strings">Section&nbsp;4.2.2</a>):</p>

<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>Because <code>@name</code> and <code>@email</code> are both instance variables (as indicated with the&nbsp;<code>@</code> sign), they are automatically available in the <code>formatted_email</code> method.</p>

<p>Let&rsquo;s fire up the console, <code>require</code> the example user code, and take our User class out for a spin:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">require</span> <span class="s1">&#39;./example_user&#39;</span>     <span class="c1"># This is how you load the example_user code.</span>
<span class="go">=&gt; [&quot;User&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User:0x224ceec @email=nil, @name=nil&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span>                 <span class="c1"># nil since attributes[:name] is nil</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Example User&quot;</span>           <span class="c1"># Assign a non-nil name</span>
<span class="go">=&gt; &quot;Example User&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;user@example.com&quot;</span>      <span class="c1"># and a non-nil email address</span>
<span class="go">=&gt; &quot;user@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; &quot;Example User &lt;user@example.com&gt;&quot;</span>
</pre></div>
</div>


<p>Here the <code>&rsquo;.&rsquo;</code> is Unix for &ldquo;current directory&rdquo;, and <code>&rsquo;./example_user&rsquo;</code> tells Ruby to look for an example user file relative to that location. The subsequent code creates an empty example user and then fills in the name and email address by assigning directly to the corresponding attributes (assignments made possible by the <code>attr_accessor</code> line in <a class="ref" href="#code:example_user">Listing&nbsp;4.9</a>). When we write</p>

<div class="code"><div class="highlight"><pre><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Example User&quot;</span>
</pre></div>
</div>


<p>Ruby is setting the <code>@name</code> variable to <code>"Example User"</code> (and similarly for the <code>email</code> attribute), which we then use in the <code>formatted_email</code> method.</p>

<p>Recalling from <a class="ref" href="#sec:css_revisited">Section&nbsp;4.3.4</a> we can omit the curly braces for final hash arguments, we can create another user by passing a hash to the <code>initialize</code> method to create a user with pre-defined attributes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User:0x225167c @email=&quot;mhartl@example.com&quot;, @name=&quot;Michael Hartl&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; &quot;Michael Hartl &lt;mhartl@example.com&gt;&quot;</span>
</pre></div>
</div>


<p>We will see starting in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a> that initializing objects using a hash argument, a technique known as <em>mass assignment</em>, is common in Rails applications.</p>

<div class="label" id="sec:conclusion"></div>


<h2><a id="sec:4.5" href="#sec:conclusion" class="heading"><span class="number">4.5</span> Conclusion</a></h2>


<p>This concludes our overview of the Ruby language. In <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a>, we&rsquo;ll start putting it to good use in developing the sample application.</p>

<p>We won&rsquo;t be using the <code>example_user.rb</code> file from <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>, so I suggest removing it:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm example_user.rb
</pre></div>
</div>


<p>Then commit the other changes to the main source code repository:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add a full_title helper&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:exercises"></div>


<h2><a id="sec:4.6" href="#sec:exercises" class="heading"><span class="number">4.6</span> Exercises</a></h2>




<ol>

<li>By replacing the question marks in <a class="ref" href="#code:string_shuffle">Listing&nbsp;4.10</a> with the appropriate methods, combine <code>split</code>, <code>shuffle</code>, and <code>join</code> to write a function that shuffles the letters in a given string.</li>

<li>Using <a class="ref" href="#code:string_shuffle_two">Listing&nbsp;4.11</a> as a guide, add a <code>shuffle</code> method to the <code>String</code> class.</li>

<li>Create three hashes called <code>person1</code>, <code>person2</code>, and <code>person3</code>, with first and last names under the keys <code>:first</code> and <code>:last</code>. Then create a <code>params</code> hash so that <code>params[:father]</code> is <code>person1</code>, <code>params[:mother]</code> is <code>person2</code>, and <code>params[:child]</code> is <code>person3</code>. Verify that, for example, <code>params[:father][:first]</code> has the right value.</li>

<li>Find an online version of the Ruby API and read about the <code>Hash</code> method <code>merge</code>.</li>

<li>Find and follow the Ruby Koans to reach Ruby enlightenment.</li>
</ol>




<div class="label" id="code:string_shuffle"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.10.</span> <span class="description">Skeleton for a string shuffle function.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_shuffle</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">string_shuffle</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div></div>




<div class="label" id="code:string_shuffle_two"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 4.11.</span> <span class="description">Skeleton for a <code>shuffle</code> method attached to the <code>String</code> class.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">shuffle</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">shuffle</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn:4.1">If a helper is specific to a particular controller, you should put it in the corresponding helper file; for example, helpers for the StaticPages controller generally go in <code>app/helpers/static_pages_helper.rb</code>. In our case, we expect the <code>full_title</code> helper to be used on all the site&rsquo;s pages, and Rails has a special helper file for this case: <code>app/helpers/application_helper.rb</code>.&nbsp;<a class="arrow" href="#fnref:4.1">&uarr;</a></li>
<li id="fn:4.2">For more on the origins of &ldquo;foo&rdquo; and &ldquo;bar&rdquo;&mdash;and, in particular, the possible <em>non</em>-relation of &ldquo;foobar&rdquo; to &ldquo;FUBAR&rdquo;&mdash;see the <a href="http://www.catb.org/jargon/html/F/foo.html">Jargon File entry on &ldquo;foo&rdquo;</a>.&nbsp;<a class="arrow" href="#fnref:4.2">&uarr;</a></li>
<li id="fn:4.3">Programmers familiar with Perl or PHP should compare this to the automatic interpolation of dollar sign variables in expressions like <code>"foo $bar"</code>.&nbsp;<a class="arrow" href="#fnref:4.3">&uarr;</a></li>
<li id="fn:4.4">Apologies in advance for switching haphazardly between <em>function</em> and <em>method</em> throughout this chapter; in Ruby, they&rsquo;re the same thing: all methods are functions, and all functions are methods, because everything is an object.&nbsp;<a class="arrow" href="#fnref:4.4">&uarr;</a></li>
<li id="fn:4.5">Well, there will still be <em>one</em> thing left that we don&rsquo;t understand, which is how Rails ties this all together: mapping URIs to actions, making the <code>full_title</code> helper available in views, etc. This is an interesting subject, and I encourage you to investigate it further, but knowing exactly <em>how</em> Rails works is not necessary when <em>using</em> Rails. (For a deeper understanding, I recommend <a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails&nbsp;3 Way</em></a> by Obie Fernandez.)&nbsp;<a class="arrow" href="#fnref:4.5">&uarr;</a></li>
<li id="fn:4.6">The <code>second</code> method used here isn&rsquo;t currently part of Ruby itself, but rather is added by Rails. It works in this case because the Rails console automatically includes the Rails extensions to Ruby.&nbsp;<a class="arrow" href="#fnref:4.6">&uarr;</a></li>
<li id="fn:4.7">Programming experts, on the other hand, might benefit from knowing that blocks are <em>closures</em>, which are one-shot anonymous functions with data attached.&nbsp;<a class="arrow" href="#fnref:4.7">&uarr;</a></li>
<li id="fn:4.8">Ruby 1.9 actually guarantees that hashes keep their elements in the same order entered, but it would be unwise ever to count on a particular ordering.&nbsp;<a class="arrow" href="#fnref:4.8">&uarr;</a></li>
<li id="fn:4.9">As a result of having less baggage, symbols are easier to compare to each other; strings need to be compared character by character, while symbols can be compared all in one go. This makes them ideal for use as hash keys.&nbsp;<a class="arrow" href="#fnref:4.9">&uarr;</a></li>
<li id="fn:4.10">These results will vary based on the version of Ruby you are using. This example assumes you are using Ruby&nbsp;1.9.3.&nbsp;<a class="arrow" href="#fnref:4.10">&uarr;</a></li>
<li id="fn:4.11">For more on Ruby classes and the <code>self</code> keyword, see the <a href="http://railstips.org/">RailsTips</a> post &ldquo;<a href="http://railstips.org/blog/archives/2006/11/18/class-and-instance-variables-in-ruby/">Class and Instance Variables in Ruby</a>&rdquo;.&nbsp;<a class="arrow" href="#fnref:4.11">&uarr;</a></li>
<li id="fn:4.12">For those familiar with JavaScript, this functionality is comparable to using a built-in class prototype object to augment the class. (Thanks to reader <a href="http://getsatisfaction.com/railstutorial/topics/adding_methods_to_built_in_classes_comparable_to_using_javascripts_prototype_object">Erik Eldridge</a> for pointing this out.)&nbsp;<a class="arrow" href="#fnref:4.12">&uarr;</a></li>
<li id="fn:4.13">You don&rsquo;t have to know what each class in this hierarchy does. <em>I</em> don&rsquo;t know what they all do, and I&rsquo;ve been programming in Ruby on Rails since 2005. This means either that (a) I&rsquo;m grossly incompetent or (b) you can be a skilled Rails developer without knowing all its innards. I hope for both our sakes that it&rsquo;s the latter.&nbsp;<a class="arrow" href="#fnref:4.13">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:filling_in_the_layout"></div>


<h1 class="chapter"><a id="sec:5" href="#cha:filling_in_the_layout" class="heading"><span class="number">Chapter 5</span> Filling in the layout</a></h1>


<p>In the process of taking a brief tour of Ruby in <a class="ref" href="#cha:rails_flavored_ruby">Chapter&nbsp;4</a>, we learned about including the application stylesheet into the sample application&mdash;but, as noted in <a class="ref" href="#sec:css_revisited">Section&nbsp;4.3.4</a>, this stylesheet is currently empty. In this chapter, we&rsquo;ll change this by incorporating the <em>Bootstrap</em> framework into our application, and then we&rsquo;ll add some custom styles of our own.<sup class="footnote" id="fnref:5.1"><a href="#fn:5.1">1</a></sup> We&rsquo;ll also start filling in the layout with links to the pages (such as Home and About) that we&rsquo;ve created so far (<a class="ref" href="#sec:structure">Section&nbsp;5.1</a>). Along the way, we&rsquo;ll learn about partials, Rails routes, and the asset pipeline, including an introduction to Sass (<a class="ref" href="#sec:sass_and_the_asset_pipeline">Section&nbsp;5.2</a>). We&rsquo;ll also refactor the tests from <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a> using the latest RSpec techniques. We&rsquo;ll end by taking a first important step toward letting users sign up to our site.</p>

<div class="label" id="sec:structure"></div>


<h2><a id="sec:5.1" href="#sec:structure" class="heading"><span class="number">5.1</span> Adding some structure</a></h2>


<p>The <em>Rails Tutorial</em> is a book on web development, not web design, but it would be depressing to work on an application that looks like <em>complete</em> crap, so in this section we&rsquo;ll add some structure to the layout and give it some minimal styling with CSS. In addition to using some custom CSS rules, we&rsquo;ll make use of <a href="http://twitter.github.com/bootstrap/">Bootstrap</a>, an open-source web design framework from Twitter. We&rsquo;ll also give our <em>code</em> some styling, so to speak, using <em>partials</em> to tidy up the layout once it gets a little cluttered.</p>

<p>When building web applications, it is often useful to get a high-level overview of the user interface as early as possible. Throughout the rest of this book, I will thus often include <em>mockups</em> (in a web context often called <em>wireframes</em>), which are rough sketches of what the eventual application will look like.<sup class="footnote" id="fnref:5.2"><a href="#fn:5.2">2</a></sup> In this chapter, we will principally be developing the static pages introduced in <a class="ref" href="#sec:static_pages">Section&nbsp;3.1</a>, including a site logo, a navigation header, and a site footer. A mockup for the most important of these pages, the Home page, appears in <a class="ref" href="#fig:home_page_mockup">Figure&nbsp;5.1</a>. You can see the final result in <a class="ref" href="#fig:site_with_footer">Figure&nbsp;5.7</a>. You&rsquo;ll note that it differs in some details&mdash;for example, we&rsquo;ll end up adding a Rails logo on the page&mdash;but that&rsquo;s fine, since a mockup need not be exact.</p>

<div class="label" id="fig:home_page_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_mockup_bootstrap.png" alt="home_page_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 5.1: </span><span class="description">A mockup of the sample application&rsquo;s Home page.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>As usual, if you&rsquo;re using Git for version control, now would be a good time to make a new branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b filling-in-layout
</pre></div>
</div>


<div class="label" id="sec:adding_to_the_layout"></div>


<h3><a id="sec:5.1.1" href="#sec:adding_to_the_layout" class="heading"><span class="number">5.1.1</span> Site navigation</a></h3>


<p>As a first step toward adding links and styles to the sample application, we&rsquo;ll update the site layout file <code>application.html.erb</code> (last seen in <a class="ref" href="#code:application_layout_full_title">Listing&nbsp;4.3</a>) with additional HTML structure. This includes some additional divisions, some CSS classes, and the start of our site navigation. The full file is in <a class="ref" href="#code:layout_new_structure">Listing&nbsp;5.1</a>; explanations for the various pieces follow immediately thereafter. If you&rsquo;d rather not delay gratification, you can see the results in <a class="ref" href="#fig:layout_no_logo_or_custom_css">Figure&nbsp;5.2</a>. (<em>Note:</em> it&rsquo;s not (yet) very gratifying.)</p>

<div class="label" id="code:layout_new_structure"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.1.</span> <span class="description">The site layout with added structure. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">    &lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;&lt;/script&gt;</span>
<span class="c">    &lt;![endif]--&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;nav&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>One thing to note immediately is the switch from Ruby&nbsp;1.8&ndash;style hashes to the new Ruby&nbsp;1.9 style (<a class="ref" href="#sec:hashes_and_symbols">Section&nbsp;4.3.3</a>). That is,</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>has been replaced with</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>It&rsquo;s important to note the old hash syntax is deeply entrenched, so it&rsquo;s important to be able to recognize both.</p>

<p>Let&rsquo;s look at the other new elements in <a class="ref" href="#code:layout_new_structure">Listing&nbsp;5.1</a> from top to bottom. As noted briefly in <a class="ref" href="#sec:static_pages">Section&nbsp;3.1</a>, Rails&nbsp;3 uses HTML5 by default (as indicated by the doctype <code>&lt;!DOCTYPE html&gt;</code>); since the HTML5 standard is relatively new, some browsers (especially older versions Internet Explorer) don&rsquo;t fully support it, so we include some JavaScript code (known as an &ldquo;<a href="http://code.google.com/p/html5shim/">HTML5 shim</a>&rdquo;) to work around the issue:</p>

<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">&lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;&lt;/script&gt;</span>
<span class="c">&lt;![endif]--&gt;</span>
</pre></div>
</div>


<p>The somewhat odd syntax</p>

<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
</pre></div>
</div>


<p>includes the enclosed line only if the version of Microsoft Internet Explorer&nbsp;(IE) is less than&nbsp;9 (<code>if lt IE 9</code>). The weird <code>[if lt IE 9]</code> syntax is <em>not</em> part of Rails; it&rsquo;s actually a <a href="http://en.wikipedia.org/wiki/Conditional_comment">conditional comment</a> supported by Internet Explorer browsers for just this sort of situation. It&rsquo;s a good thing, too, because it means we can include the HTML5 shim <em>only</em> for IE browsers less than version&nbsp;9, leaving other browsers such as Firefox, Chrome, and Safari unaffected.</p>

<p>The next section includes a <code>header</code> for the site&rsquo;s (plain-text) logo, a couple of divisions (using the <code>div</code> tag), and a list of elements with navigation links:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div>


<p>Here the <code>header</code> tag indicates elements that should go at the top of the page. We&rsquo;ve given the <code>header</code> tag two <em>CSS classes</em>,<sup class="footnote" id="fnref:5.3"><a href="#fn:5.3">3</a></sup> called <code>navbar</code> and <code>navbar-fixed-top</code>, separated with a space:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>All HTML elements can be assigned both classes and <em>ids</em>; these are merely labels, and are useful for styling with CSS (<a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a>). The main difference between classes and ids is that classes can be used multiple times on a page, but ids can be used only once. In the present case, both of the <code>navbar</code> and <code>navbar-fixed-top</code> classes have special meaning to the Bootstrap framework, which we&rsquo;ll install and use in <a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a>.</p>

<p>Inside the <code>header</code> tag, we see a couple of <code>div</code> tags:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>The <code>div</code> tag is a generic division; it doesn&rsquo;t do anything apart from divide the document into distinct parts. In older-style HTML, <code>div</code> tags are used for nearly all site divisions, but HTML5 adds the <code>header</code>, <code>nav</code>, and <code>section</code> elements for divisions common to many applications. In this case, each <code>div</code> has a CSS class as well. As with the <code>header</code> tag&rsquo;s classes, these classes have special meaning to Bootstrap.</p>

<p>After the divs, we encounter some embedded Ruby:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div>
</div>


<p>This uses the Rails helper <code>link_to</code> to create links (which we created directly with the anchor tag&nbsp;<code>a</code> in <a class="ref" href="#sec:passing_title_tests">Section&nbsp;3.3.2</a>); the first argument to <code>link_to</code> is the link text, while the second is the URI. We&rsquo;ll fill in the URIs with <em>named routes</em> in <a class="ref" href="#sec:named_routes">Section&nbsp;5.3.3</a>, but for now we use the stub URI <code>&rsquo;#&rsquo;</code> commonly used in web design. The third argument is an options hash, in this case adding the CSS&nbsp;id <code>logo</code> to the sample app link. (The other three links have no options hash, which is fine since it&rsquo;s optional.) Rails helpers often take options hashes in this way, giving us the flexibility to add arbitrary HTML options without ever leaving Rails.</p>

<p>The second element inside the divs is a list of navigation links, made using the <em>unordered list</em> tag <code>ul</code>, together with the <em>list item</em> tag <code>li</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div>
</div>


<p>The <code>nav</code> tag, though formally unnecessary here, communicates the purpose of the navigation links. The <code>nav</code> and <code>pull-right</code> classes on the <code>ul</code> tag have special meaning to Bootstrap. Once Rails has processed this layout and evaluated the embedded Ruby, the list looks like this:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Help<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Sign in<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div>
</div>


<p>The final part of the layout is a <code>div</code> for the main content:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>As before, the <code>container</code> class has special meaning to Bootstrap. As we learned in <a class="ref" href="#sec:layouts">Section&nbsp;3.3.4</a>, the <code>yield</code> method inserts the contents of each page into the site layout.</p>

<p>Apart from the site footer, which we&rsquo;ll add in <a class="ref" href="#sec:partials">Section&nbsp;5.1.3</a>, our layout is now complete, and we can look at the results by visiting the Home page. To take advantage of the upcoming style elements, we&rsquo;ll add some extra elements to
the <code>home.html.erb</code> view (<a class="ref" href="#code:signup_button">Listing&nbsp;5.2</a>).</p>

<div class="label" id="code:signup_button"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.2.</span> <span class="description">The Home page with a link to the signup page. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;h2&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/h2&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>In preparation for adding users to our site in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, the first <code>link_to</code> creates a stub link of the form</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span><span class="nt">&gt;</span>Sign up now!<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>In the <code>div</code> tag, the <code>hero-unit</code> CSS class has a special meaning to Bootstrap, as do the <code>btn</code>, <code>btn-large</code>, and <code>btn-primary</code> classes in the signup button.</p>

<p>The second <code>link_to</code> shows off the <code>image_tag</code> helper, which takes as arguments the path to an image and an optional options hash, in this case setting the <code>alt</code> attribute of the image tag using symbols. To make this clearer, let&rsquo;s look at the HTML this tag produces:<sup class="footnote" id="fnref:5.4"><a href="#fn:5.4">4</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">alt=</span><span class="s">&quot;Rails&quot;</span> <span class="na">src=</span><span class="s">&quot;/assets/rails.png&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>The <code>alt</code> attribute is what will be displayed if there is no image, and it is also what will be displayed by screen readers for the visually impaired. Although people are sometimes sloppy about including the <code>alt</code> attribute for images, it is in fact required by the HTML standard. Luckily, Rails includes a default <code>alt</code> attribute; if you don&rsquo;t specify the attribute in the call to <code>image_tag</code>, Rails just uses the image filename (minus extension). In this case, though, we&rsquo;ve set the <code>alt</code> text explicitly in order to capitalize &ldquo;Rails&rdquo;.</p>

<p>Now we&rsquo;re finally ready to see the fruits of our labors (<a class="ref" href="#fig:layout_no_logo_or_custom_css">Figure&nbsp;5.2</a>). Pretty underwhelming, you say? Perhaps so. Happily, though, we&rsquo;ve done a good job of giving our HTML elements sensible classes, which puts us in a great position to add style to the site with CSS.</p>

<p>By the way, you might be surprised to discover that the <code>rails.png</code> image actually exists. Where did it come from? It&rsquo;s included for free with every new Rails application, and you will find it in <code>app/assets/images/rails.png</code>. Because we used the <code>image_tag</code> helper, Rails finds it automatically using the asset pipeline (<a class="ref" href="#sec:sass_and_the_asset_pipeline">Section&nbsp;5.2</a>).</p>

<div class="label" id="fig:layout_no_logo_or_custom_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/layout_no_logo_or_custom_css_bootstrap.png" alt="layout_no_logo_or_custom_css_bootstrap" /></span></div><div class="caption"><span class="header">Figure 5.2: </span><span class="description">The Home page (<a href="http://localhost:3000/static_pages/home">/static_pages/home</a>) with no custom CSS.&nbsp;<a href="http://railstutorial.org/images/figures/layout_no_logo_or_custom_css_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:custom_css"></div>


<h3><a id="sec:5.1.2" href="#sec:custom_css" class="heading"><span class="number">5.1.2</span> Bootstrap and custom CSS</a></h3>


<p>In <a class="ref" href="#sec:adding_to_the_layout">Section&nbsp;5.1.1</a>, we associated many of the HTML elements with CSS classes, which gives us considerable flexibility in constructing a layout based on CSS. As noted in <a class="ref" href="#sec:adding_to_the_layout">Section&nbsp;5.1.1</a>, many of these classes are specific to <a href="http://twitter.github.com/bootstrap/">Bootstrap</a>, a framework from Twitter that makes it easy to add nice web design and user interface elements to an HTML5 application. In this section, we&rsquo;ll combine Bootstrap with some custom CSS rules to start adding some style to the sample application.</p>

<p>Our first step is to add Bootstrap, which in Rails applications can be accomplished with the <tt>bootstrap-sass</tt> gem, as shown in <a class="ref" href="#code:bootstrap_sass">Listing&nbsp;5.3</a>. The Bootstrap framework natively uses the <a href="http://lesscss.org/">LESS CSS</a> language for making dynamic stylesheets, but the Rails asset pipeline supports the (very similar) Sass language by default (<a class="ref" href="#sec:sass_and_the_asset_pipeline">Section&nbsp;5.2</a>), so <tt>bootstrap-sass</tt> converts LESS to Sass and makes all the necessary Bootstrap files available to the current application.<sup class="footnote" id="fnref:5.5"><a href="#fn:5.5">5</a></sup></p>

<div class="label" id="code:bootstrap_sass"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.3.</span> <span class="description">Adding the <tt>bootstrap-sass</tt> gem to the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>To install Bootstrap, we run <code>bundle install</code> as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Then restart the web server to incorporate the changes into the development application.</p>

<p>The first step in adding custom CSS to our application is to create a file to contain it:</p>

<div class="code"><div class="highlight"><pre><span class="go">app/assets/stylesheets/custom.css.scss</span>
</pre></div>
</div>


<p>(Use your text editor or IDE to create the new file.) Here both the directory name and filename are important. The directory</p>

<div class="code"><div class="highlight"><pre><span class="go">app/assets/stylesheets</span>
</pre></div>
</div>


<p>is part of the asset pipeline (<a class="ref" href="#sec:sass_and_the_asset_pipeline">Section&nbsp;5.2</a>), and any stylesheets in this directory will automatically be included as part of the <code>application.css</code> file included in the site layout. Furthermore, the filename <code>custom.css.scss</code> includes the <code>.css</code> extension, which indicates a CSS file, and the <code>.scss</code> extension, which indicates a &ldquo;Sassy CSS&rdquo; file and arranges for the asset pipeline to process the file using Sass. (We won&rsquo;t be using Sass until <a class="ref" href="#sec:sass">Section&nbsp;5.2.2</a>, but it&rsquo;s needed now for the <tt>bootstrap-sass</tt> gem to work its magic.)</p>

<p>After creating the file for custom CSS, we can use the <code>@import</code> function to include Bootstrap, as shown in <a class="ref" href="#code:bootstrap_css">Listing&nbsp;5.4</a>.</p>

<div class="label" id="code:bootstrap_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.4.</span> <span class="description">Adding Bootstrap CSS. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
</pre></div>
</div></div>


<p>This one line includes the entire Bootstrap CSS framework, with the result shown in in <a class="ref" href="#fig:sample_app_only_bootstrap">Figure&nbsp;5.3</a>. (You may have to restart the local web server.) The placement of the text isn&rsquo;t good and the logo doesn&rsquo;t have any style, but the colors and signup button look promising.</p>

<div class="label" id="fig:sample_app_only_bootstrap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_only_bootstrap.png" alt="sample_app_only_bootstrap" /></span></div><div class="caption"><span class="header">Figure 5.3: </span><span class="description">The sample application with Bootstrap CSS.&nbsp;<a href="http://railstutorial.org/images/figures/sample_app_only_bootstrap-full.png">(full size)</a></span></div></div>


<p>Next we&rsquo;ll add some CSS that will be used site-wide for styling the layout and each individual page, as shown in <a class="ref" href="#code:universal_css">Listing&nbsp;5.5</a>. There are quite a few rules in <a class="ref" href="#code:universal_css">Listing&nbsp;5.5</a>; to get a sense of what a CSS rule does, it&rsquo;s often helpful to comment it out using CSS comments, i.e., by putting it inside <code>/* &hellip; */</code>, and seeing what changes.
The result of the CSS in <a class="ref" href="#code:universal_css">Listing&nbsp;5.5</a> is shown in <a class="ref" href="#fig:sample_app_universal">Figure&nbsp;5.4</a>.</p>

<div class="label" id="code:universal_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.5.</span> <span class="description">Adding CSS for some universal styling applying to all pages. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* universal */</span>

<span class="nt">html</span> <span class="p">{</span>
  <span class="na">overflow-y</span><span class="o">:</span> <span class="no">scroll</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">textarea</span> <span class="p">{</span>
  <span class="na">resize</span><span class="o">:</span> <span class="n">vertical</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:sample_app_universal"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_universal.png" alt="sample_app_universal" /></span></div><div class="caption"><span class="header">Figure 5.4: </span><span class="description">Adding some spacing and other universal styling.&nbsp;<a href="http://railstutorial.org/images/figures/sample_app_universal-full.png">(full size)</a></span></div></div>


<p>Note that the CSS in <a class="ref" href="#code:universal_css">Listing&nbsp;5.5</a> has a consistent form. In general, CSS rules refer either to a class, an id, an HTML tag, or some combination thereof, followed by a list of styling commands. For example,</p>

<div class="code"><div class="highlight"><pre><span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>puts 60&nbsp;pixels of padding at the top of the page. Because of the <code>navbar-fixed-top</code> class in the <code>header</code> tag, Bootstrap fixes the navigation bar to the top of the page, so the padding serves to separate the main text from the navigation. Meanwhile, the CSS in the rule</p>

<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>associates the <code>center</code> class with the <code>text-align: center</code> property. In other words, the dot <code>.</code> in <code>.center</code> indicates that the rule styles a class. (As we&rsquo;ll see in <a class="ref" href="#code:logo_css">Listing&nbsp;5.7</a>, the pound sign <code>#</code> identifies a rule to style a CSS <em>id</em>.) This means that elements inside any tag (such as a <code>div</code>) with class <code>center</code> will be centered on the page. (We saw an example of this class in <a class="ref" href="#code:signup_button">Listing&nbsp;5.2</a>.)</p>

<p>Although Bootstrap comes with CSS rules for nice typography, we&rsquo;ll also add some custom rules for the appearance of the text on our site, as shown in <a class="ref" href="#code:typography_css">Listing&nbsp;5.6</a>. (Not all of these rules apply to the Home page, but each rule here will be used at some point in the sample application.) The result of <a class="ref" href="#code:typography_css">Listing&nbsp;5.6</a> is shown in <a class="ref" href="#fig:sample_app_typography">Figure&nbsp;5.5</a>.</p>

<div class="label" id="code:typography_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.6.</span> <span class="description">Adding CSS for nice typography. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">typography</span> <span class="o">*/</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span> <span class="p">{</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">3</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-2</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:sample_app_typography"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_typography.png" alt="sample_app_typography" /></span></div><div class="caption"><span class="header">Figure 5.5: </span><span class="description">Adding some typographic styling.&nbsp;<a href="http://railstutorial.org/images/figures/sample_app_typography-full.png">(full size)</a></span></div></div>


<p>Finally, we&rsquo;ll add some rules to style the site&rsquo;s logo, which simply consists of the text &ldquo;sample app&rdquo;. The CSS in <a class="ref" href="#code:logo_css">Listing&nbsp;5.7</a> converts the text to uppercase and modifies its size, color, and placement. (We&rsquo;ve used a CSS&nbsp;id because we expect the site logo to appear on the page only once, but you could use a class instead.)</p>

<div class="label" id="code:logo_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.7.</span> <span class="description">Adding CSS for the site logo. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">header</span> <span class="o">*/</span>

<span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nn">#logo</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>Here <code>color: #fff</code> changes the color of the logo to white. HTML colors can be coded with three pairs of base-16 (hexadecimal) numbers, one each for the primary colors red, green, and blue (in that order). The code <code>#ffffff</code> maxes out all three colors, yielding pure white, and <code>#fff</code> is a shorthand for the full <code>#ffffff</code>. The CSS standard also defines a large number of synonyms for common <a href="http://www.w3schools.com/html/html_colornames.asp">HTML colors</a>, including <code>white</code> for <code>#fff</code>. The result of the CSS in <a class="ref" href="#code:logo_css">Listing&nbsp;5.7</a> is shown in <a class="ref" href="#fig:sample_app_logo">Figure&nbsp;5.6</a>.</p>

<div class="label" id="fig:sample_app_logo"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_logo.png" alt="sample_app_logo" /></span></div><div class="caption"><span class="header">Figure 5.6: </span><span class="description">The sample app with nicely styled logo.&nbsp;<a href="http://railstutorial.org/images/figures/sample_app_logo-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:partials"></div>


<h3><a id="sec:5.1.3" href="#sec:partials" class="heading"><span class="number">5.1.3</span> Partials</a></h3>


<p>Although the layout in <a class="ref" href="#code:layout_new_structure">Listing&nbsp;5.1</a> serves its purpose, it&rsquo;s getting a little cluttered. The HTML shim takes up three lines and uses weird IE-specific syntax, so it would be nice to tuck it away somewhere on its own. In addition, the header HTML forms a logical unit, so it should all be packaged up in one place. The way to achieve this in Rails is to use a facility called <em>partials</em>. Let&rsquo;s first take a look at what the layout looks like after the partials are defined (<a class="ref" href="#code:layout_with_partials">Listing&nbsp;5.8</a>).</p>

<div class="label" id="code:layout_with_partials"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.8.</span> <span class="description">The site layout with partials for the stylesheets and header. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/shim&#39;</span> <span class="cp">%&gt;</span>    
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>In <a class="ref" href="#code:layout_with_partials">Listing&nbsp;5.8</a>, we&rsquo;ve replaced the HTML shim stylesheet lines with a single call to a Rails helper called <code>render</code>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/shim&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The effect of this line is to look for a file called  <code>app/views/layouts/_shim.html.erb</code>, evaluate its contents, and insert the results into the view.<sup class="footnote" id="fnref:5.6"><a href="#fn:5.6">6</a></sup> (Recall that <tt class="verb">&lt;%= ... %&gt;</tt> is the embedded Ruby syntax needed to evaluate a Ruby expression and then insert the results into the template.) Note the leading underscore on the filename <code>_shim.html.erb</code>; this underscore is the universal convention for naming partials, and among other things makes it possible to identify all the partials in a directory at a glance.</p>

<p>Of course, to get the partial to work, we have to fill it with some content; in the case of the shim partial, this is just the three lines of shim code from <a class="ref" href="#code:layout_new_structure">Listing&nbsp;5.1</a>; the result appears in <a class="ref" href="#code:stylesheets_partial">Listing&nbsp;5.9</a>.</p>

<div class="label" id="code:stylesheets_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.9.</span> <span class="description">A partial for the HTML shim. <br /> <code>app/views/layouts/_shim.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">&lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;&lt;/script&gt;</span>
<span class="c">&lt;![endif]--&gt;</span>
</pre></div>
</div></div>


<p>Similarly, we can move the header material into the partial shown in <a class="ref" href="#code:header_partial">Listing&nbsp;5.10</a> and insert it into the layout with another call to <code>render</code>.</p>

<div class="label" id="code:header_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.10.</span> <span class="description">A partial for the site header. <br /> <code>app/views/layouts/_header.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>Now that we know how to make partials, let&rsquo;s add a site footer to go along with the header. By now you can probably guess that we&rsquo;ll call it <code>_footer.html.erb</code> and put it in the layouts directory (<a class="ref" href="#code:footer_partial">Listing&nbsp;5.11</a>).<sup class="footnote" id="fnref:5.7"><a href="#fn:5.7">7</a></sup></p>

<div class="label" id="code:footer_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.11.</span> <span class="description">A partial for the site footer. <br /> <code>app/views/layouts/_footer.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span>   <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Contact&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://news.railstutorial.org/&quot;</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div>
</div></div>


<p>As with the header, in the footer we&rsquo;ve used <code>link_to</code> for the internal links to the About and Contact pages and stubbed out the URIs with <code>&rsquo;#&rsquo;</code> for now. (As with <code>header</code>, the <code>footer</code> tag is new in HTML5.)</p>

<p>We can render the footer partial in the layout by following the same pattern as the stylesheets and header partials (<a class="ref" href="#code:layout_with_footer">Listing&nbsp;5.12</a>).</p>

<div class="label" id="code:layout_with_footer"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.12.</span> <span class="description">The site layout with a footer partial. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/shim&#39;</span> <span class="cp">%&gt;</span>    
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Of course, the footer will be ugly without some styling (<a class="ref" href="#code:footer_css">Listing&nbsp;5.13</a>). The results appear in <a class="ref" href="#fig:site_with_footer">Figure&nbsp;5.7</a>.</p>

<div class="label" id="code:footer_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.13.</span> <span class="description">Adding the CSS for the site footer. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">footer</span> <span class="o">*/</span>

<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#eaeaea</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#555</span><span class="p">;</span>
<span class="p">}</span>  

<span class="nt">footer</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span> 
  <span class="na">color</span><span class="o">:</span> <span class="mh">#222</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">small</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">ul</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:site_with_footer"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/site_with_footer_bootstrap.png" alt="site_with_footer_bootstrap" /></span></div><div class="caption"><span class="header">Figure 5.7: </span><span class="description">The Home page (<a href="http://localhost:3000/static_pages/home">/static_pages/home</a>) with an added footer.&nbsp;<a href="http://railstutorial.org/images/figures/site_with_footer_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:sass_and_the_asset_pipeline"></div>


<h2><a id="sec:5.2" href="#sec:sass_and_the_asset_pipeline" class="heading"><span class="number">5.2</span> Sass and the asset pipeline</a></h2>


<p>One of the most notable differences between Rails&nbsp;3.0 and more recent versions is the asset pipeline, which significantly improves the production and management of static assets such as CSS, JavaScript, and images. This section gives a high-level overview of the asset pipeline and then shows how to use a remarkable tool for making CSS called <em>Sass</em>, now included by default as part of the asset pipeline.</p>

<div class="label" id="sec:the_asset_pipeline"></div>


<h3><a id="sec:5.2.1" href="#sec:the_asset_pipeline" class="heading"><span class="number">5.2.1</span> The asset pipeline</a></h3>


<p>The asset pipeline involves lots of changes under Rails&rsquo; hood, but from the perspective of a typical Rails developer there are three principal features to understand: asset directories, manifest files, and preprocessor engines.<sup class="footnote" id="fnref:5.8"><a href="#fn:5.8">8</a></sup> Let&rsquo;s consider each in turn.</p>

<h4><a id="sec:5.2.1.1" href="#sec:5.2.1.1" class="heading">Asset directories</a></h4>


<p>In versions of Rails before 3.0 (including 3.0 itself), static assets lived in the <code>public/</code> directory, as follows:</p>

<ul>
<li><code>public/stylesheets</code></li>
<li><code>public/javascripts</code></li>
<li><code>public/images</code></li>
</ul>


<p>Files in these directories are (even post-3.0) automatically served up via requests to http://example.com/stylesheets, etc.</p>

<p>Starting in Rails 3.1, there are <em>three</em> canonical directories for static assets, each with its own purpose:</p>

<ul>
<li><code>app/assets</code>: assets specific to the present application</li>
<li><code>lib/assets</code>: assets for libraries written by your dev team</li>
<li><code>vendor/assets</code>: assets from third-party vendors</li>
</ul>


<p>As you might guess, each of these directories has a subdirectory for each asset class, e.g.,</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ls app/assets/
<span class="go">images      javascripts stylesheets</span>
</pre></div>
</div>


<p>At this point, we&rsquo;re in a position to understand the motivation behind the location of the <code>custom.css.scss</code> file in <a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a>: <code>custom.css.scss</code> is specific to the sample application, so it goes in <code>app/assets/stylesheets</code>.</p>

<h4><a id="sec:5.2.1.2" href="#sec:5.2.1.2" class="heading">Manifest files</a></h4>


<p>Once you&rsquo;ve placed your assets in their logical locations, you can use <em>manifest files</em> to tell Rails (via the <a href="https://github.com/sstephenson/sprockets">Sprockets</a> gem) how to combine them to form single files. (This applies to CSS and JavaScript but not to images.) As an example, let&rsquo;s take a look at the default manifest file for app stylesheets (<a class="ref" href="#code:app_css_manifest">Listing&nbsp;5.14</a>).</p>

<div class="label" id="code:app_css_manifest"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.14.</span> <span class="description">The manifest file for app-specific CSS. <br /> <code>app/assets/stylesheets/application.css</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is a manifest file that&#39;ll automatically include all the stylesheets</span>
<span class="cm"> * available in this directory and any sub-directories. You&#39;re free to add</span>
<span class="cm"> * application-wide styles to this file and they&#39;ll appear at the top of the</span>
<span class="cm"> * compiled file, but it&#39;s generally better to create a new file per style </span>
<span class="cm"> * scope.</span>
<span class="cm"> *= require_self</span>
<span class="cm"> *= require_tree . </span>
<span class="cm">*/</span>
</pre></div>
</div></div>


<p>The key lines here are actually CSS comments, but they are used by Sprockets to include the proper files:</p>

<div class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> .</span>
<span class="cm"> .</span>
<span class="cm"> .</span>
<span class="cm"> *= require_self</span>
<span class="cm"> *= require_tree . </span>
<span class="cm">*/</span>
</pre></div>
</div>


<p>Here</p>

<div class="code"><div class="highlight"><pre><span class="go">*= require_tree .</span>
</pre></div>
</div>


<p>ensures that all CSS files in the <code>app/assets/stylesheets</code> directory (including the tree subdirectories) are included into the application CSS. The line</p>

<div class="code"><div class="highlight"><pre><span class="go">*= require_self</span>
</pre></div>
</div>


<p>ensures that CSS in <code>application.css</code> is also included.</p>

<p>Rails comes with sensible default manifest files, and in the <em>Rails Tutorial</em> we won&rsquo;t need to make any changes, but the <a href="http://guides.rubyonrails.org/asset_pipeline.html">Rails Guides entry on the asset pipeline</a> has more detail if you need it.</p>

<h4><a id="sec:5.2.1.3" href="#sec:5.2.1.3" class="heading">Preprocessor engines</a></h4>


<p>After you&rsquo;ve assembled your assets, Rails prepares them for the site template by running them through several preprocessing engines and using the manifest files to combine them for delivery to the browser. We tell Rails which processor to use using filename extensions; the three most common cases are <code>.scss</code> for Sass, <code>.coffee</code> for CoffeeScript, and <code>.erb</code> for embedded Ruby (ERb). We first covered ERb in <a class="ref" href="#sec:embedded_ruby">Section&nbsp;3.3.3</a>, and cover Sass in <a class="ref" href="#sec:sass">Section&nbsp;5.2.2</a>. We won&rsquo;t be needing CoffeeScript in this tutorial, but it&rsquo;s an elegant little language that compiles to JavaScript. (The <a href="http://railscasts.com/episodes/267-coffeescript-basics">RailsCast on CoffeeScript basics</a> is a good place to start.)</p>

<p>The preprocessor engines can be chained, so that</p>

<p><code>foobar.js.coffee</code></p>

<p>gets run through the CoffeeScript processor, and</p>

<p><code>foobar.js.erb.coffee</code></p>

<p>gets run through both CoffeeScript and ERb (with the code running from right to left, i.e., CoffeeScript first).</p>

<h4><a id="sec:5.2.1.4" href="#sec:5.2.1.4" class="heading">Efficiency in production</a></h4>


<p>One of the best things about the asset pipeline is that it automatically results in assets that are optimized to be efficient in a production application.  Traditional methods for organizing CSS and JavaScript involve splitting functionality into separate files and using nice formatting (with lots of indentation). While convenient for the programmer, this is inefficient in production; including multiple full-sized files can significantly slow page-load times (one of the most important factors affecting the quality of the user experience). With the asset pipeline, in production all the application stylesheets get rolled into one CSS file (<code>application.css</code>), all the application JavaScript code gets rolled into one JavaScript file (<code>javascripts.js</code>), and all such files (including those in <code>lib/assets</code> and <code>vendor/assets</code>) are <em>minified</em> to remove the unnecessary whitespace that bloats file size. As a result, we get the best of both worlds: multiple nicely formatted files for programmer convenience, with single optimized files in production.</p>

<div class="label" id="sec:sass"></div>


<h3><a id="sec:5.2.2" href="#sec:sass" class="heading"><span class="number">5.2.2</span> Syntactically awesome stylesheets</a></h3>


<p><em>Sass</em> is a language for writing stylesheets that improves on CSS in many ways. In this section, we cover two of the most important improvements, <em>nesting</em> and <em>variables</em>. (A third technique, <em>mixins</em>, is introduced in <a class="ref" href="#sec:rails_environments">Section&nbsp;7.1.1</a>.)</p>

<p>As noted briefly in <a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a>, Sass supports a format called SCSS (indicated with a <code>.scss</code> filename extension), which is a strict superset of CSS itself; that is, SCSS only <em>adds</em> features to CSS, rather than defining an entirely new syntax.<sup class="footnote" id="fnref:5.9"><a href="#fn:5.9">9</a></sup> This means that every valid CSS file is also a valid SCSS file, which is convenient for projects with existing style rules. In our case, we used SCSS from the start in order to take advantage of Bootstrap. Since the Rails asset pipeline automatically uses Sass to process files with the <code>.scss</code> extension, the <code>custom.css.scss</code> file will be run through the Sass preprocessor before being packaged up for delivery to the browser.</p>

<h4><a id="sec:5.2.2.1" href="#sec:5.2.2.1" class="heading">Nesting</a></h4>


<p>A common pattern in stylesheets is having rules that apply to nested elements. For example, in <a class="ref" href="#code:universal_css">Listing&nbsp;5.5</a> we have rules both for <code>.center</code> and for <code>.center h1</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>We can replace this in Sass with</p>

<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="nt">h1</span> <span class="p">{</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>  
<span class="p">}</span>
</pre></div>
</div>


<p>Here the nested <code>h1</code> rule automatically inherits the <code>.center</code> context.</p>

<p>There&rsquo;s a second candidate for nesting that requires a slightly different syntax. In <a class="ref" href="#code:logo_css">Listing&nbsp;5.7</a>, we have the code</p>

<div class="code"><div class="highlight"><pre><span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nn">#logo</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>Here the logo id <code>#logo</code> appears twice, once by itself and once with the <code>hover</code> attribute (which controls its appearance when the mouse pointer hovers over the element in question). In order to nest the second rule, we need to reference the parent element <code>#logo</code>; in SCSS, this is accomplished with the ampersand character&nbsp;<code>&amp;</code> as follows:</p>

<div class="code"><div class="highlight"><pre><span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
    <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>


<p>Sass changes <code>&amp;:hover</code> into <code>#logo:hover</code> as part of converting from SCSS to CSS.</p>

<p>Both of these nesting techniques apply to the footer CSS in <a class="ref" href="#code:footer_css">Listing&nbsp;5.13</a>, which can be transformed into the following:</p>

<div class="code"><div class="highlight"><pre><span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#eaeaea</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="mh">#555</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span> 
      <span class="na">color</span><span class="o">:</span> <span class="mh">#222</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>  
  <span class="nt">small</span> <span class="p">{</span> 
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span> 
  <span class="p">}</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="nt">li</span> <span class="p">{</span>
      <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>


<p>Converting <a class="ref" href="#code:footer_css">Listing&nbsp;5.13</a> by hand is a good exercise, and you should verify that the CSS still works properly after the conversion.</p>

<h4><a id="sec:5.2.2.2" href="#sec:5.2.2.2" class="heading">Variables</a></h4>


<p>Sass allows us to define <em>variables</em> to eliminate duplication and write more expressive code. For example, looking at <a class="ref" href="#code:typography_css">Listing&nbsp;5.6</a> and <a class="ref" href="#code:footer_css">Listing&nbsp;5.13</a>, we see that there are repeated references to the same color:</p>

<div class="code"><div class="highlight"><pre><span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>In this case, <code>#999</code> is a light gray, and we can give it a name by defining a variable as follows:</p>

<div class="code"><div class="highlight"><pre><span class="nv">$lightGray</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
</pre></div>
</div>


<p>This allows us to rewrite our SCSS like this:</p>

<div class="code"><div class="highlight"><pre><span class="nv">$lightGray</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$lightGray</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$lightGray</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>Because variable names such as <code>$lightGray</code> are more descriptive than <code>#999</code>, it&rsquo;s often useful to define variables even for values that aren&rsquo;t repeated. Indeed, the Bootstrap framework defines a large number of variables for colors, available online on the <a href="http://twitter.github.com/bootstrap/less.html#variables">Bootstrap page of LESS variables</a>. That page defines variables using LESS, not Sass, but the <tt>bootstrap-sass</tt> gem provides the Sass equivalents. It is not difficult to guess the correspondence; where LESS uses an &ldquo;at&rdquo; sign&nbsp;<code>@</code>, Sass uses a dollar sign&nbsp;<code>$</code>. Looking the Bootstrap variable page, we see that there is a variable for light gray:</p>

<div class="code"><div class="highlight"><pre> <span class="k">@grayLight</span><span class="nd">:</span> <span class="nn">#999</span><span class="o">;</span>
</pre></div>
</div>


<p>This means that, via the <tt>bootstrap-sass</tt> gem, there should be a corresponding SCSS variable <code>$grayLight</code>. We can use this to replace our custom variable, <code>$lightGray</code>, which gives</p>

<div class="code"><div class="highlight"><pre><span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>Applying the Sass nesting and variable definition features to the full SCSS file gives the file in <a class="ref" href="#code:refactored_scss">Listing&nbsp;5.15</a>. This uses both Sass variables (as inferred from the Bootstrap LESS variable page) and built-in named colors (i.e., <code>white</code> for <code>#fff</code>). Note in particular the dramatic improvement in the rules for the <code>footer</code> tag.</p>

<div class="label" id="code:refactored_scss"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.15.</span> <span class="description">The initial SCSS file converted to use nesting and variables. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="cm">/* universal */</span>

<span class="nt">html</span> <span class="p">{</span>
  <span class="na">overflow-y</span><span class="o">:</span> <span class="no">scroll</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">textarea</span> <span class="p">{</span>
  <span class="na">resize</span><span class="o">:</span> <span class="n">vertical</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="nt">h1</span> <span class="p">{</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* typography */</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span> <span class="p">{</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">3</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-2</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* header */</span>

<span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
    <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* footer */</span>

<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayMediumLight</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nv">$gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span> 
      <span class="na">color</span><span class="o">:</span> <span class="nv">$grayDarker</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>  
  <span class="nt">small</span> <span class="p">{</span> 
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span> 
  <span class="p">}</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="nt">li</span> <span class="p">{</span>
      <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>Sass gives us even more ways to simplify our stylesheets, but the code in <a class="ref" href="#code:refactored_scss">Listing&nbsp;5.15</a> uses the most important features and gives us a great start. See the <a href="http://sass-lang.com/">Sass website</a> for more details.</p>

<div class="label" id="sec:layout_links"></div>


<h2><a id="sec:5.3" href="#sec:layout_links" class="heading"><span class="number">5.3</span> Layout links</a></h2>


<p>Now that we&rsquo;ve finished a site layout with decent styling, it&rsquo;s time to start filling in the links we&rsquo;ve stubbed out with <code>&rsquo;#&rsquo;</code>. Of course, we could hard-code links like</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/static_pages/about&quot;</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>but that isn&rsquo;t the Rails Way. For one, it would be nice if the URI for the about page were /about rather than /static_pages/about; moreover, Rails conventionally uses <em>named routes</em>, which involves code like</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="n">about_path</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This way the code has a more transparent meaning, and it&rsquo;s also more flexible since we can change the definition of <code>about_path</code> and have the URI change everywhere <code>about_path</code> is used.</p>

<p>The full list of our planned links appears in <a class="ref" href="#table:url_mapping">Table&nbsp;5.1</a>, along with their mapping to URIs and routes. We&rsquo;ll implement all but the last one by the end of this chapter. (We&rsquo;ll make the last one in <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>.)</p>

<div class="label" id="table:url_mapping"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>Page</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_right"><strong>Named route</strong></th></tr><tr class="top_bar"><td class="align_left">Home</td><td class="align_left">/</td><td class="align_right"><code>root_path</code></td></tr><tr><td class="align_left">About</td><td class="align_left">/about</td><td class="align_right"><code>about_path</code></td></tr><tr><td class="align_left">Help</td><td class="align_left">/help</td><td class="align_right"><code>help_path</code></td></tr><tr><td class="align_left">Contact</td><td class="align_left">/contact</td><td class="align_right"><code>contact_path</code></td></tr><tr><td class="align_left">Sign up</td><td class="align_left">/signup</td><td class="align_right"><code>signup_path</code></td></tr><tr><td class="align_left">Sign in</td><td class="align_left">/signin</td><td class="align_right"><code>signin_path</code></td></tr></table></div><div class="caption"><span class="header">Table 5.1: </span><span class="description">Route and URI mapping for site links.</span></div></div>


<p>Before moving on, let&rsquo;s add a Contact page (left as an exercise in <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>). The test appears as in <a class="ref" href="#code:contact_page_test">Listing&nbsp;5.16</a>, which simply follows the model last seen in <a class="ref" href="#code:pages_controller_spec_title">Listing&nbsp;3.18</a>. Note that, as in the application code, in <a class="ref" href="#code:contact_page_test">Listing&nbsp;5.16</a> we&rsquo;ve switched to Ruby&nbsp;1.9&ndash;style hashes.</p>

<div class="label" id="code:contact_page_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.16.</span> <span class="description">Tests for a Contact page. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You should verify that these tests fail:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>The application code parallels the addition of the About page in <a class="ref" href="#sec:adding_a_page">Section&nbsp;3.2.2</a>: first we update the routes (<a class="ref" href="#code:contact_route">Listing&nbsp;5.17</a>), then we add a <code>contact</code> action to the StaticPages controller (<a class="ref" href="#code:contact_action">Listing&nbsp;5.18</a>), and finally we create a Contact view (<a class="ref" href="#code:contact_view">Listing&nbsp;5.19</a>).</p>

<div class="label" id="code:contact_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.17.</span> <span class="description">Adding a route for the Contact page. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/help&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/about&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/contact&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:contact_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.18.</span> <span class="description">Adding an action for the Contact page. <br /> <code>app/controllers/static_pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:contact_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.19.</span> <span class="description">The view for the Contact page. <br /> <code>app/views/static_pages/contact.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/contact&quot;</span><span class="nt">&gt;</span>contact page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>Now make sure that the tests pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec:route_tests"></div>


<h3><a id="sec:5.3.1" href="#sec:route_tests" class="heading"><span class="number">5.3.1</span> Route tests</a></h3>


<p>With the work we&rsquo;ve done writing integration test for the static pages, writing tests for the routes is simple: we just replace each occurrence of a hard-coded address with the desired named route from <a class="ref" href="#table:url_mapping">Table&nbsp;5.1</a>. In other words, we change</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">about_path</span>
</pre></div>
</div>


<p>and so on for the other pages. The result appears in <a class="ref" href="#code:route_tests">Listing&nbsp;5.20</a>.</p>

<div class="label" id="code:route_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.20.</span> <span class="description">Tests for the named routes. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">help_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">help_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Help&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;About&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | About Us&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">contact_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">contact_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As usual, you should check that the tests are now red:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>By the way, if the code in <a class="ref" href="#code:route_tests">Listing&nbsp;5.20</a> strikes you as repetitive and verbose, you&rsquo;re not alone. We&rsquo;ll refactor this mess into a beautiful jewel in <a class="ref" href="#sec:pretty_rspec">Section&nbsp;5.3.4</a>.</p>

<div class="label" id="sec:rails_routes"></div>


<h3><a id="sec:5.3.2" href="#sec:rails_routes" class="heading"><span class="number">5.3.2</span> Rails routes</a></h3>


<p>Now that we have tests for the URIs we want, it&rsquo;s time to get them to work. As noted in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a>, the file Rails uses for URI mappings is <code>config/routes.rb</code>. If you take a look at the default routes file, you&rsquo;ll see that it&rsquo;s quite a mess, but it&rsquo;s a useful mess&mdash;full of commented-out example route mappings. I suggest reading through it at some point, and I also suggest taking a look at the <a href="http://guides.rubyonrails.org/routing.html">Rails Guides article &ldquo;Rails Routing from the outside in&rdquo;</a> for a much more in-depth treatment of routes.</p>

<p>To define the named routes, we need to replace rules such as</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;static_pages/help&#39;</span>
</pre></div>
</div>


<p>with</p>

<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
</pre></div>
</div>


<p>This arranges both for a valid page at <code>/help</code> and a named route called <code>help_path</code> that returns the path to that page. (Actually, using <code>get</code> in place of <code>match</code> gives the same named routes, but using <code>match</code> is more conventional.)</p>

<p>Applying this pattern to the other static pages gives <a class="ref" href="#code:static_page_routes">Listing&nbsp;5.21</a>. The only exception is the Home page, which we&rsquo;ll take care of in <a class="ref" href="#code:root_route">Listing&nbsp;5.23</a>.</p>

<div class="label" id="code:static_page_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.21.</span> <span class="description">Routes for static pages. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span>    <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>   <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/contact&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#contact&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>If you read the code in <a class="ref" href="#code:static_page_routes">Listing&nbsp;5.21</a> carefully, you can probably figure out what it does; for example, you can see that</p>

<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
</pre></div>
</div>


<p>matches <code>&rsquo;/about&rsquo;</code> and routes it to the <code>about</code> action in the StaticPages controller.  Before, this was more explicit: we used</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;static_pages/about&#39;</span>
</pre></div>
</div>


<p>to get to the same place, but <code>/about</code> is more succinct. In addition, as mentioned above, the code <code>match &rsquo;/about&rsquo;</code> also automatically creates <em>named routes</em> for use in the controllers and views:</p>

<div class="code"><div class="highlight"><pre><span class="n">about_path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/about&#39;</span>
<span class="n">about_url</span>  <span class="o">=&gt;</span> <span class="s1">&#39;http://localhost:3000/about&#39;</span>
</pre></div>
</div>


<p>Note that <code>about_url</code> is the <em>full</em> URI http://localhost:3000/about (with <code>localhost:3000</code> being replaced with the domain name, such as <code>example.com</code>, for a fully deployed site). As discussed in <a class="ref" href="#sec:layout_links">Section&nbsp;5.3</a>, to get just /about, you use <code>about_path</code>. (The <em>Rails Tutorial</em> uses the <code>path</code> form for consistency, but the difference rarely matters in practice.)</p>

<p>With these routes now defined, the tests for the Help, About, and Contact pages should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>This leaves the test for the Home page as the last one to fail.</p>

<p>To establish the route mapping for the Home page, we <em>could</em> use code like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>
</pre></div>
</div>


<p>This is unnecessary, though; Rails has special instructions for the root URI&nbsp;/ (&ldquo;slash&rdquo;) located lower down in the file (<a class="ref" href="#code:root_route_hint">Listing&nbsp;5.22</a>).</p>

<div class="label" id="code:root_route_hint"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.22.</span> <span class="description">The commented-out hint for defining the root route. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># You can have the root of your site routed with &quot;root&quot;</span>
  <span class="c1"># just remember to delete public/index.html.</span>
  <span class="c1"># root :to =&gt; &quot;welcome#index&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Using <a class="ref" href="#code:root_route_hint">Listing&nbsp;5.22</a> as a model, we arrive at <a class="ref" href="#code:root_route">Listing&nbsp;5.23</a> to route the root URI&nbsp;/ to the Home page.</p>

<div class="label" id="code:root_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.23.</span> <span class="description">Adding a mapping for the root route. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span>    <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>   <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/contact&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#contact&#39;</span>  
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code maps the root URI&nbsp;/ to /static_pages/home, and also gives URI helpers as follows:</p>

<div class="code"><div class="highlight"><pre><span class="n">root_path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span>
<span class="n">root_url</span>  <span class="o">=&gt;</span> <span class="s1">&#39;http://localhost:3000/&#39;</span>
</pre></div>
</div>


<p>We should also heed the comment in <a class="ref" href="#code:root_route_hint">Listing&nbsp;5.22</a> and delete <code>public/index.html</code> to prevent Rails from rendering the default page (<a class="ref" href="#fig:riding_rails_31">Figure&nbsp;1.3</a>) when we visit&nbsp;/. You can of course simply remove the file by trashing it, but if you&rsquo;re using Git for version control there&rsquo;s a way to tell Git about the removal at the same time using <code>git rm</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git rm public/index.html
</pre></div>
</div>


<p>You may recall from <a class="ref" href="#sec:git_commands">Section&nbsp;1.3.5</a> that we used the Git command <code>git commit -a -m "Message"</code>, with flags for &ldquo;all changes&rdquo; (<code>-a</code>) and a message (<code>-m</code>). As shown above, Git also lets us roll the two flags into one using <code>git commit -am "Message"</code>.</p>

<p>With that, all of the routes for static pages are working, and the tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>Now we just have to fill in the links in the layout.</p>

<div class="label" id="sec:named_routes"></div>


<h3><a id="sec:5.3.3" href="#sec:named_routes" class="heading"><span class="number">5.3.3</span> Named routes</a></h3>


<p>Let&rsquo;s put the named routes created in <a class="ref" href="#sec:rails_routes">Section&nbsp;5.3.2</a> to work in our layout. This will entail filling in the second arguments of the <code>link_to</code> functions with the proper named routes. For example, we&rsquo;ll convert</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="n">about_path</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>and so on.</p>

<p>We&rsquo;ll start in the header partial, <code>_header.html.erb</code> (<a class="ref" href="#code:header_partial_links">Listing&nbsp;5.24</a>), which has links to the Home and Help pages. While we&rsquo;re at it, we&rsquo;ll follow a common web convention and link the logo to the Home page as well.</p>

<div class="label" id="code:header_partial_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.24.</span> <span class="description">Header partial with links. <br /> <code>app/views/layouts/_header.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>We won&rsquo;t have a named route for the &ldquo;Sign in&rdquo; link until <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>, so we&rsquo;ve left it as <code>&rsquo;#&rsquo;</code> for now.</p>

<p>The other place with links is the footer partial, <code>_footer.html.erb</code>, which has links for the About and Contact pages (<a class="ref" href="#code:footer_partial_links">Listing&nbsp;5.25</a>).</p>

<div class="label" id="code:footer_partial_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.25.</span> <span class="description">Footer partial with links. <br /> <code>app/views/layouts/_footer.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span>   <span class="n">about_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Contact&quot;</span><span class="p">,</span> <span class="n">contact_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://news.railstutorial.org/&quot;</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div>
</div></div>


<p>With that, our layout has links to all the static pages created in <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>, so that, for example, <a href="http://localhost:3000/about">/about</a> goes to the About page (<a class="ref" href="#fig:about_page">Figure&nbsp;5.8</a>).</p>

<p>By the way, it&rsquo;s worth noting that, although we haven&rsquo;t actually tested for the presence of the links on the layout, our tests will fail if the routes aren&rsquo;t defined. You can check this by commenting out the routes in <a class="ref" href="#code:static_page_routes">Listing&nbsp;5.21</a> and running your test suite. For a testing method that actually makes sure the links go to the right places, see <a class="ref" href="#sec:layout_exercises">Section&nbsp;5.6</a>.</p>

<div class="label" id="fig:about_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/about_page_styled.png" alt="about_page_styled" /></span></div><div class="caption"><span class="header">Figure 5.8: </span><span class="description">The About page at  <a href="http://localhost:3000/about">/about</a>.&nbsp;<a href="http://railstutorial.org/images/figures/about_page_styled-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:pretty_rspec"></div>


<h3><a id="sec:5.3.4" href="#sec:pretty_rspec" class="heading"><span class="number">5.3.4</span> Pretty RSpec</a></h3>


<p>We noted in <a class="ref" href="#sec:route_tests">Section&nbsp;5.3.1</a> that the tests for the static pages are getting a little verbose and repetitive (<a class="ref" href="#code:route_tests">Listing&nbsp;5.20</a>). In this section we&rsquo;ll make use of the latest features of RSpec to make our tests more compact and elegant.</p>

<p>Let&rsquo;s take a look at a couple of the examples to see how they can be improved:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                      <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>One thing we notice is that all three examples include a visit to the root path. We can eliminate this duplication with a <code>before</code> block:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

  <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                      <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>This uses the line</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>
</pre></div>
</div>


<p>to visit the root path before each example. (The <code>before</code> method can also be invoked with <code>before(:each)</code>, which is a synonym.)</p>

<p>Another source of duplication appears in each example; we have both</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>which say essentially the same thing. In addition, both examples reference the <code>page</code> variable. We can eliminate these sources of duplication by telling RSpec that <code>page</code> is the <em>subject</em> of the tests using</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
</pre></div>
</div>


<p>and then using a variant of the <code>it</code> method to collapse the code and description into one line:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>Because of <code>subject { page }</code>, the call to <code>should</code> automatically uses the <code>page</code> variable supplied by Capybara (<a class="ref" href="#sec:TDD">Section&nbsp;3.2.1</a>).</p>

<p>Applying these changes gives much more compact tests for the Home page:</p>

<div class="code"><div class="highlight"><pre>  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>This code looks nicer, but the title test is still a bit long. Indeed, most of the title tests in <a class="ref" href="#code:route_tests">Listing&nbsp;5.20</a> have long title text of the form</p>

<div class="code"><div class="highlight"><pre><span class="s2">&quot;Ruby on Rails Tutorial Sample App | About&quot;</span>
</pre></div>
</div>


<p>An exercise in <a class="ref" href="#sec:static_pages_exercises">Section&nbsp;3.5</a> proposes eliminating some of this duplication by defining a <code>base_title</code> variable and using string interpolation (<a class="ref" href="#code:pages_controller_spec_exercise">Listing&nbsp;3.30</a>). We can do even better by defining a <code>full_title</code>, which parallels the <code>full_title</code> helper from <a class="ref" href="#code:title_helper">Listing&nbsp;4.2</a>. We do this by creating both a <code>spec/support</code> directory and a <code>utilities.rb</code> file for RSpec utilities (<a class="ref" href="#code:rspec_utilities">Listing&nbsp;5.26</a>).</p>

<div class="label" id="code:rspec_utilities"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.26.</span> <span class="description">A file for RSpec utilities with a <code>full_title</code> function. <br /> <code>spec/support/utilities.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
  <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>
  <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">base_title</span>
  <span class="k">else</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Of course, this is essentially a duplicate of the helper in <a class="ref" href="#code:title_helper">Listing&nbsp;4.2</a>, but having two independent methods allows us to catch any typos in the base title. This is dubious design, though, and a better (slightly more advanced) approach, which tests the original <code>full_title</code> helper directly, appears in the exercises (<a class="ref" href="#sec:layout_exercises">Section&nbsp;5.6</a>).</p>

<p>Files in the <code>spec/support</code> directory are automatically included by RSpec, which means that we can write the Home tests as follows:</p>

<div class="code"><div class="highlight"><pre>  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>We can now simplify the tests for the Help, About, and Contact pages using the same methods used for the Home page. The results appear in <a class="ref" href="#code:pretty_page_tests">Listing&nbsp;5.27</a>.</p>

<div class="label" id="code:pretty_page_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.27.</span> <span class="description">Prettier tests for the static pages. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">help_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Help&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">about_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;About&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;About Us&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">contact_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Contact&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You should now verify that the tests still  pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>This RSpec style in <a class="ref" href="#code:pretty_page_tests">Listing&nbsp;5.27</a> is much pithier than the style in <a class="ref" href="#code:route_tests">Listing&nbsp;5.20</a>&mdash;indeed, it can be made even pithier (<a class="ref" href="#sec:layout_exercises">Section&nbsp;5.6</a>). We will use this more compact style whenever possible when developing the rest of the sample application.</p>

<div class="label" id="sec:user_signup"></div>


<h2><a id="sec:5.4" href="#sec:user_signup" class="heading"><span class="number">5.4</span> User signup: A first step</a></h2>


<p>As a capstone to our work on the layout and routing, in this section we&rsquo;ll make a route for the signup page, which will mean creating a second controller along the way. This is a first important step toward allowing users to register for our site; we&rsquo;ll take the next step, modeling users, in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>, and we&rsquo;ll finish the job in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>.</p>

<div class="label" id="sec:users_controller"></div>


<h3><a id="sec:5.4.1" href="#sec:users_controller" class="heading"><span class="number">5.4.1</span> Users controller</a></h3>


<p>It&rsquo;s been a while since we created our first controller, the StaticPages controller, way back in <a class="ref" href="#sec:static_pages_with_rails">Section&nbsp;3.1.2</a>. It&rsquo;s time to create a second one, the Users controller. As before, we&rsquo;ll use <code>generate</code> to make the simplest controller that meets our present needs, namely, one with a stub signup page for new users. Following the conventional <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST architecture</a> favored by Rails, we&rsquo;ll call the action for new users <code>new</code> and pass it as an argument to <code>generate controller</code> to create it automatically (<a class="ref" href="#code:generate_users_controller">Listing&nbsp;5.28</a>).</p>

<div class="label" id="code:generate_users_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.28.</span> <span class="description">Generating a Users controller (with a <code>new</code> action).</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new --no-test-framework
<span class="go">      create  app/controllers/users_controller.rb</span>
<span class="go">       route  get &quot;users/new&quot;</span>
<span class="go">      invoke  erb</span>
<span class="go">      create    app/views/users</span>
<span class="go">      create    app/views/users/new.html.erb</span>
<span class="go">      invoke  helper</span>
<span class="go">      create    app/helpers/users_helper.rb</span>
<span class="go">      invoke  assets</span>
<span class="go">      invoke    coffee</span>
<span class="go">      create      app/assets/javascripts/users.js.coffee</span>
<span class="go">      invoke    scss</span>
<span class="go">      create      app/assets/stylesheets/users.css.scss</span>
</pre></div>
</div></div>


<p>This creates a Users controller with a <code>new</code> action (<a class="ref" href="#code:initial_users_controller">Listing&nbsp;5.29</a>) and a stub user view (<a class="ref" href="#code:initial_new_action">Listing&nbsp;5.30</a>).</p>

<div class="label" id="code:initial_users_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.29.</span> <span class="description">The initial Users controller, with a <code>new</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:initial_new_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.30.</span> <span class="description">The initial <code>new</code> action for Users. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Users#new<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/users/new.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec:signup_url"></div>


<h3><a id="sec:5.4.2" href="#sec:signup_url" class="heading"><span class="number">5.4.2</span> Signup URI</a></h3>


<p>With the code from <a class="ref" href="#sec:users_controller">Section&nbsp;5.4.1</a>, we already have a working page for new users at /users/new, but recall from <a class="ref" href="#table:url_mapping">Table&nbsp;5.1</a> that we want the URI to be /signup instead. As in <a class="ref" href="#sec:layout_links">Section&nbsp;5.3</a>, we&rsquo;ll first write some integration tests, which we&rsquo;ll now generate:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test user_pages
</pre></div>
</div>


<p>Then, following the model of the static pages spec in <a class="ref" href="#code:pretty_page_tests">Listing&nbsp;5.27</a>, we&rsquo;ll fill in the user pages test with code to test for the contents of the <code>h1</code> and <code>title</code> tags, as seen in <a class="ref" href="#code:user_pages_spec">Listing&nbsp;5.31</a>.</p>

<div class="label" id="code:user_pages_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.31.</span> <span class="description">The initial spec for users, with a test for the signup page. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signup page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can run these tests using the <code>rspec</code> command as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb
</pre></div>
</div>


<p>It&rsquo;s worth noting that we can also run all the request specs by passing the whole directory instead of just one file:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/
</pre></div>
</div>


<p>Based on this pattern, you may be able to guess how to run <em>all</em> the specs:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>For completeness, we&rsquo;ll usually use this method to run the tests through the rest of the tutorial. By the way, it&rsquo;s worth noting (since you may see other people use it) that you can also run the test suite using the <code>spec</code> Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake spec
</pre></div>
</div>


<p>(In fact, you can just type <code>rake</code> by itself; the default behavior of <code>rake</code> is to run the test suite.)</p>

<p>By construction, the Users controller already has a <code>new</code> action, so to get the test to pass all we need is the right route and the right view content. We&rsquo;ll follow the examples from <a class="ref" href="#code:static_page_routes">Listing&nbsp;5.21</a> and add a <code>match &rsquo;/signup&rsquo;</code> rule for the signup URI (<a class="ref" href="#code:signup_route">Listing&nbsp;5.32</a>).</p>

<div class="label" id="code:signup_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.32.</span> <span class="description">A route for the signup page. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>

  <span class="n">root</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span>    <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>   <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/contact&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#contact&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we have kept the rule <code>get "users/new"</code>, which was generated automatically by the Users controller generation in <a class="ref" href="#code:generate_users_controller">Listing&nbsp;5.28</a>. Currently, this rule is necessary for the <code>&rsquo;users/new&rsquo;</code> routing to work, but it doesn&rsquo;t follow the proper REST conventions (<a class="ref" href="#table:demo_RESTful_users">Table&nbsp;2.2</a>), and we will eliminate it in <a class="ref" href="#sec:a_users_resource">Section&nbsp;7.1.2</a>.</p>

<p>To get the tests to pass, all we need now is a view with the title and heading &ldquo;Sign up&rdquo; (<a class="ref" href="#code:initial_signup_page">Listing&nbsp;5.33</a>).</p>

<div class="label" id="code:initial_signup_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.33.</span> <span class="description">The initial (stub) signup page. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/users/new.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>At this point, the signup test in <a class="ref" href="#code:user_pages_spec">Listing&nbsp;5.31</a> should pass. All that&rsquo;s left is to add the proper link to the button on the Home page. As with the other routes, <code>match &rsquo;/signup&rsquo;</code> gives us the named route <code>signup_path</code>, which we put to use in <a class="ref" href="#code:home_page_signup_link">Listing&nbsp;5.34</a>.</p>

<div class="label" id="code:home_page_signup_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.34.</span> <span class="description">Linking the button to the Signup page. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;h2&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/h2&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>With that, we&rsquo;re done with the links and named routes, at least until we add a route for signing in (<a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>). The resulting new user page (at the URI /signup) appears in <a class="ref" href="#fig:new_signup_page">Figure&nbsp;5.9</a>.</p>

<div class="label" id="fig:new_signup_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_signup_page_bootstrap.png" alt="new_signup_page_bootstrap" /></span></div><div class="caption"><span class="header">Figure 5.9: </span><span class="description">The new signup page at <a href="http://localhost:3000/signup">/signup</a>.&nbsp;<a href="http://railstutorial.org/images/figures/new_signup_page_bootstrap-full.png">(full size)</a></span></div></div>


<p>At this point the tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:layout_conclusion"></div>


<h2><a id="sec:5.5" href="#sec:layout_conclusion" class="heading"><span class="number">5.5</span> Conclusion</a></h2>


<p>In this chapter, we&rsquo;ve hammered our application layout into shape and polished up the routes. The rest of the book is dedicated to fleshing out the sample application: first, by adding users who can sign up, sign in, and sign out; next, by adding user microposts; and, finally, by adding the ability to follow other users.</p>

<p>At this point, if you are using Git you should merge the changes back into the master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish layout and routes&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge filling-in-layout
</pre></div>
</div>


<p>You can also push up to GitHub:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div>
</div>


<p>Finally, you can deploy to Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>The result should be a working sample application on the production server:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p>If you run into trouble, try running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>to debug the error using the Heroku logfile.</p>

<div class="label" id="sec:layout_exercises"></div>


<h2><a id="sec:5.6" href="#sec:layout_exercises" class="heading"><span class="number">5.6</span> Exercises</a></h2>




<ol>

<li>The code in <a class="ref" href="#code:pretty_page_tests">Listing&nbsp;5.27</a> for testing static pages is compact but is still a bit repetitive. RSpec supports a facility called <em>shared examples</em> to eliminate the kind of duplication. By following the example in <a class="ref" href="#code:static_pages_spec_shared_example">Listing&nbsp;5.35</a>, fill in the missing tests for the Help, About, and Contact pages. Note that the <code>let</code> command, introduced briefly in <a class="ref" href="#code:pages_controller_spec_exercise">Listing&nbsp;3.30</a>, creates a local variable with the given value on demand (i.e., when the variable is used), in contrast to an instance variable, which is created upon assignment.</li>

<li>You may have noticed that our tests for the layout links test the routing but don&rsquo;t actually check that the links on the layout go to the right pages. One way to implement these tests is to use <code>visit</code> and <code>click_link</code> inside the RSpec integration test. Fill in the code in <a class="ref" href="#code:layout_links_test">Listing&nbsp;5.36</a> to verify that all the layout links are properly defined.</li>

<li>Eliminate the need for the <code>full_title</code> test helper in <a class="ref" href="#code:rspec_utilities">Listing&nbsp;5.26</a> by writing tests for the original helper method, as shown in <a class="ref" href="#code:full_title_helper_tests">Listing&nbsp;5.37</a>. (You will have to create both the <code>spec/helpers</code> directory and the <code>application_helper_spec.rb</code> file.) Then <code>include</code> it into the test using the code in <a class="ref" href="#code:rspec_utilities_simplified">Listing&nbsp;5.38</a>.  Verify by running the test suite that the new code is still valid. <em>Note</em>: <a class="ref" href="#code:full_title_helper_tests">Listing&nbsp;5.37</a> uses <em>regular expressions</em>, which we&rsquo;ll learn more about in <a class="ref" href="#sec:format_validation">Section&nbsp;6.2.4</a>. (Thanks to <a href="http://alexchaffee.com/">Alex Chaffee</a> for the suggestion and code used in this exercise.)</li>

</ol>




<div class="label" id="code:static_pages_spec_shared_example"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.35.</span> <span class="description">Using an RSpec shared example to eliminate test duplication. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">shared_examples_for</span> <span class="s2">&quot;all static pages&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">heading</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:heading</span><span class="p">)</span>    <span class="p">{</span> <span class="s1">&#39;Sample App&#39;</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:page_title</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;&#39;</span> <span class="p">}</span>

    <span class="n">it_should_behave_like</span> <span class="s2">&quot;all static pages&quot;</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:layout_links_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.36.</span> <span class="description">A test for the links on the layout. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should have the right links on the layout&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">click_link</span> <span class="s2">&quot;About&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="n">click_link</span> <span class="s2">&quot;Help&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">&quot;Contact&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span>
    <span class="n">click_link</span> <span class="s2">&quot;Sign up now!&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">&quot;sample app&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:full_title_helper_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.37.</span> <span class="description">Tests for the <code>full_title</code> helper. <br /> <code>spec/helpers/application_helper_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">ApplicationHelper</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;full_title&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should include the page title&quot;</span> <span class="k">do</span>
      <span class="n">full_title</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/foo/</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should include the base title&quot;</span> <span class="k">do</span>
      <span class="n">full_title</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/^Ruby on Rails Tutorial Sample App/</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not include a bar for the home page&quot;</span> <span class="k">do</span>
      <span class="n">full_title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="o">=~</span> <span class="sr">/\|/</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:rspec_utilities_simplified"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 5.38.</span> <span class="description">Replacing the <code>full_title</code> test helper with a simple <code>include</code>. <br /> <code>spec/support/utilities.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn:5.1">Thanks to reader <a href="https://twitter.com/colmtuite">Colm Tuite</a> for his excellent work in helping to convert the sample application over to Bootstrap.&nbsp;<a class="arrow" href="#fnref:5.1">&uarr;</a></li>
<li id="fn:5.2">The mockups in the <em>Ruby on Rails Tutorial</em> are made with an excellent online mockup application called <a href="http://gomockingbird.com">Mockingbird</a>.&nbsp;<a class="arrow" href="#fnref:5.2">&uarr;</a></li>
<li id="fn:5.3">These are completely unrelated to Ruby classes.&nbsp;<a class="arrow" href="#fnref:5.3">&uarr;</a></li>
<li id="fn:5.4">You might notice that the <code>img</code> tag, rather than looking like <tt class="verb">&lt;img&gt;...&lt;/img&gt;</tt>, instead looks like <tt class="verb">&lt;img ... /&gt;</tt>. Tags that follow this form are known as <em>self-closing</em> tags.&nbsp;<a class="arrow" href="#fnref:5.4">&uarr;</a></li>
<li id="fn:5.5">It is also possible to use LESS with the asset pipeline; see the <a href="http://rubygems.org/gems/less-rails-bootstrap"><tt>less-rails-bootstrap</tt> gem</a> for details.&nbsp;<a class="arrow" href="#fnref:5.5">&uarr;</a></li>
<li id="fn:5.6">Many Rails developers use a <code>shared</code> directory for partials shared across different views. I prefer to use the <code>shared</code> folder for utility partials that are useful on multiple views, while putting partials that are literally on every page (as part of the site layout) in the <code>layouts</code> directory. (We&rsquo;ll create the <code>shared</code> directory starting in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>.) That seems to me a logical division, but putting them all in the <code>shared</code> folder certainly works fine, too.&nbsp;<a class="arrow" href="#fnref:5.6">&uarr;</a></li>
<li id="fn:5.7">You may wonder why we use both the <code>footer</code> tag and <code>.footer</code> class. The answer is that the tag has a clear meaning to human readers, and the class is used by Bootstrap. Using a <code>div</code> tag in place of <code>footer</code> would work as well.&nbsp;<a class="arrow" href="#fnref:5.7">&uarr;</a></li>
<li id="fn:5.8">The structure of this section is based on the excellent blog post <a href="http://2beards.net/2011/11/the-rails-3-asset-pipeline-in-about-5-minutes/">The Rails 3 Asset Pipeline in (about) 5 Minutes</a> by Michael Erasmus. For more details, see the <a href="http://guides.rubyonrails.org/asset_pipeline.html">Rails Guide on the Asset Pipeline</a>.&nbsp;<a class="arrow" href="#fnref:5.8">&uarr;</a></li>
<li id="fn:5.9">The older <code>.sass</code> format, also supported by Sass, defines a new language which is less verbose (and has fewer curly braces) but is less convenient for existing projects and is harder to learn for those already familiar with CSS.&nbsp;<a class="arrow" href="#fnref:5.9">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:modeling_users"></div>


<h1 class="chapter"><a id="sec:6" href="#cha:modeling_users" class="heading"><span class="number">Chapter 6</span> Modeling users</a></h1>


<p>In <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a>, we ended with a stub page for creating new users (<a class="ref" href="#sec:user_signup">Section&nbsp;5.4</a>); over the course of the next four chapters, we&rsquo;ll fulfill the promise implicit in this incipient signup page. The first critical step is to create a <em>data model</em> for users of our site, together with a way to store that data. In <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, we&rsquo;ll give users the ability to sign up for our site and create a user profile page. Once users can sign up, we&rsquo;ll let them sign in and sign out as well (<a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>), and in <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a> (<a class="ref" href="#sec:requiring_signed_in_users">Section&nbsp;9.2.1</a>) we&rsquo;ll learn how to protect pages from improper access. Taken together, the material in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a> through <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a> develops a full Rails login and authentication system. As you may know, there are various pre-built authentication solutions for Rails; <a class="ref" href="#sidebar:roll_your_own">Box&nbsp;6.1</a> explains why, at least at first, it&rsquo;s probably a better idea to roll your own.</p>

<p>This is a long and action-packed chapter, and you may find it unusually challenging, especially if you are new to data modeling. By the end of it, though, we will have created an industrial-strength system for validating, storing, and retrieving user information.</p>

<div class="label" id="sidebar:roll_your_own"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.1.</span><span class="description">Roll your own authentication system</span></span>
<p>Virtually all web applications require a login and authentication system of some sort. As a result, most web frameworks have a plethora of options for implementing such systems, and Rails is no exception. Examples of authentication and authorization systems include <a href="http://github.com/thoughtbot/clearance">Clearance</a>, <a href="http://github.com/binarylogic/authlogic">Authlogic</a>, <a href="http://github.com/plataformatec/devise">Devise</a>, and <a href="http://railscasts.com/episodes/192-authorization-with-cancan">CanCan</a> (as well as non-Rails-specific solutions built on top of <a href="http://en.wikipedia.org/wiki/OpenID">OpenID</a> or <a href="http://en.wikipedia.org/wiki/Oauth">OAuth</a>). It&rsquo;s reasonable to ask why we should reinvent the wheel. Why not just use an off-the-shelf solution instead of rolling our own?</p>

<p>For one, practical experience shows that authentication on most sites requires extensive customization, and modifying a third-party product is often more work than writing the system from scratch. In addition, off-the-shelf systems can be &ldquo;black boxes&rdquo;, with potentially mysterious innards; when you write your own system, you are far more likely to understand it. Moreover, recent additions to Rails (<a class="ref" href="#sec:adding_a_secure_password">Section&nbsp;6.3</a>) make it easy to write a custom authentication system. Finally, if you <em>do</em> end up using a third-party system later on, you&rsquo;ll be in a much better position to understand and modify it if you&rsquo;ve first built one yourself.</p>
</div>


<p>As usual, if you&rsquo;re following along using Git for version control, now would be a good time to make a topic branch for modeling users:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div>
</div>


<p>(The first line here is just to make sure that you start on the master branch, so that the <code>modeling-users</code> topic branch is based on <code>master</code>. You can skip that command if you&rsquo;re already on the master branch.)</p>

<div class="label" id="sec:user_model"></div>


<h2><a id="sec:6.1" href="#sec:user_model" class="heading"><span class="number">6.1</span> User model</a></h2>


<p>Although the ultimate goal of the next three chapters is to make a signup page for our site (mocked up in <a class="ref" href="#fig:signup_mockup_preview">Figure&nbsp;6.1</a>), it would do little good now to accept information for new users: we don&rsquo;t currently have any place to put it. Thus, the first step in signing up users is to make a data structure to capture and store their information.</p>

<div class="label" id="fig:signup_mockup_preview"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_mockup_bootstrap.png" alt="signup_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 6.1: </span><span class="description">A mockup of the user signup page.&nbsp;<a href="http://railstutorial.org/images/figures/signup_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>In Rails, the default data structure for a data model is called, naturally enough, a&nbsp;<em>model</em> (the M in MVC from <a class="ref" href="#sec:mvc">Section&nbsp;1.2.6</a>). The default Rails solution to the problem of persistence is to use a <em>database</em> for long-term data storage, and the default library for interacting with the database is called <em>Active Record</em>.<sup class="footnote" id="fnref:6.1"><a href="#fn:6.1">1</a></sup> Active Record comes with a host of methods for creating, saving, and finding data objects, all without having to use the structured query language (SQL)<sup class="footnote" id="fnref:6.2"><a href="#fn:6.2">2</a></sup> used by <a href="http://en.wikipedia.org/wiki/Relational_database">relational databases</a>. Moreover, Rails has a feature called <em>migrations</em> to allow data definitions to be written in pure Ruby, without having to learn an SQL data definition language (DDL). The effect is that Rails insulates you almost entirely from the details of the data store. In this book, by using SQLite for development and PostgreSQL (via Heroku) for deployment (<a class="ref" href="#sec:deploying">Section&nbsp;1.4</a>), we have developed this theme even further, to the point where we barely ever have to think about how Rails stores data, even for production applications.</p>

<div class="label" id="sec:database_migrations"></div>


<h3><a id="sec:6.1.1" href="#sec:database_migrations" class="heading"><span class="number">6.1.1</span> Database migrations</a></h3>


<p>You may recall from <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a> that we have already encountered, via a custom-built <code>User</code> class, user objects with <code>name</code> and <code>email</code> attributes. That class served as a useful example, but it lacked the critical property of <em>persistence</em>: when we created a User object at the Rails console, it disappeared as soon as we exited. Our goal in this section is to create a model for users that won&rsquo;t disappear quite so easily.</p>

<p>As with the User class in <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>, we&rsquo;ll start by modeling a user with two attributes, a <code>name</code> and an <code>email</code> address, the latter of which we&rsquo;ll use as a unique username.<sup class="footnote" id="fnref:6.3"><a href="#fn:6.3">3</a></sup> (We&rsquo;ll add an attribute for passwords in <a class="ref" href="#sec:adding_a_secure_password">Section&nbsp;6.3</a>.) In <a class="ref" href="#code:example_user">Listing&nbsp;4.9</a>, we did this with Ruby&rsquo;s <code>attr_accessor</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In contrast, when using Rails to model users we don&rsquo;t need to identify the attributes explicitly. As noted briefly above, to store data Rails uses a relational database by default, which consists of <em>tables</em> composed of data <em>rows</em>, where each row has <em>columns</em> of data attributes. For example, to store users with names and email addresses, we&rsquo;ll create a <code>users</code> table with <code>name</code> and <code>email</code> columns (with each row corresponding to one user). By naming the columns in this way, we&rsquo;ll let Active Record figure out the User object attributes for us.</p>

<p>Let&rsquo;s see how this works. (If this discussion gets too abstract for your taste, be patient; the console examples starting in <a class="ref" href="#sec:creating_user_objects">Section&nbsp;6.1.3</a> and the database browser screenshots in <a class="ref" href="#fig:sqlite_database_browser">Figure&nbsp;6.3</a> and <a class="ref" href="#fig:sqlite_user_row">Figure&nbsp;6.6</a> should make things clearer.) You may recall from <a class="ref" href="#code:generate_users_controller">Listing&nbsp;5.28</a> that we created a Users controller (along with a <code>new</code> action) using the command</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new --no-test-framework
</pre></div>
</div>


<p>There is an analogous command for making a model: <code>generate model</code>. <a class="ref" href="#code:generate_user_model">Listing&nbsp;6.1</a> shows the command to generate a User model with two attributes, <code>name</code> and <code>email</code>.</p>

<div class="label" id="code:generate_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.1.</span> <span class="description">Generating a User model.</span>       
</div>
<div class="code"><div class="highlight"><pre>$ rails generate model User name:string email:string
      invoke  active_record
      create    db/migrate/[timestamp]_create_users.rb
      create    app/models/user.rb
      invoke    rspec
      create      spec/models/user_spec.rb
</pre></div>
</div></div>


<p>(Note that, in contrast to the plural convention for controller names, model names are singular: a Users controller, but a User model.) By passing the optional parameters <code>name:string</code> and <code>email:string</code>, we tell Rails about the two attributes we want, along with what types those attributes should be (in this case, <code>string</code>). Compare this with including the action names in <a class="ref" href="#code:generating_pages">Listing&nbsp;3.4</a> and <a class="ref" href="#code:generate_users_controller">Listing&nbsp;5.28</a>.</p>

<p>One of the results of the <code>generate</code> command in <a class="ref" href="#code:generate_user_model">Listing&nbsp;6.1</a> is a new file called a <em>migration</em>.  Migrations provide a way to alter the structure of the database incrementally, so that our data model can adapt to changing requirements. In the case of the User model, the migration is created automatically by the model generation script; it creates a <code>users</code> table with two columns, <code>name</code> and <code>email</code>, as shown in <a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a>. (We&rsquo;ll see in <a class="ref" href="#sec:uniqueness_validation">Section&nbsp;6.2.5</a> and again in <a class="ref" href="#sec:adding_a_secure_password">Section&nbsp;6.3</a> how to make a migration from scratch.)</p>

<div class="label" id="code:users_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.2.</span> <span class="description">Migration for the User model (to create a <code>users</code> table). <br /> <code>db/migrate/[timestamp]_create_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that the name of the migration file is prefixed by a <em>timestamp</em> based on when the migration was generated. In the early days of migrations, the filenames were prefixed with incrementing integers, which caused conflicts for collaborating teams if multiple programmers had migrations with the same number. Barring the improbable scenario of migrations generated the same second, using timestamps conveniently avoids such collisions.</p>

<p>The migration itself consists of a <code>change</code> method that determines the change to be made to the database. In the case of <a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a>, <code>change</code> uses a Rails method called <code>create_table</code> to create a <em>table</em> in the database for storing users. The <code>create_table</code> method accepts a block (<a class="ref" href="#sec:blocks">Section&nbsp;4.3.2</a>) with one block variable, in this case called <code>t</code> (for &ldquo;table&rdquo;). Inside the block, the <code>create_table</code> method uses the <code>t</code>&nbsp;object to create <code>name</code> and <code>email</code> columns in the database, both of type <code>string</code>.<sup class="footnote" id="fnref:6.4"><a href="#fn:6.4">4</a></sup> Here the table name is plural (<code>users</code>) even though the model name is singular (User), which reflects a linguistic convention followed by Rails: a model represents a single user, whereas a database table consists of many users. The final line in the block, <code>t.timestamps</code>, is a special command that creates two <em>magic columns</em> called <code>created_at</code> and <code>updated_at</code>, which are timestamps that automatically record when a given user is created and updated. (We&rsquo;ll see concrete examples of the magic columns starting in <a class="ref" href="#sec:creating_user_objects">Section&nbsp;6.1.3</a>.) The full data model represented by this migration is shown in <a class="ref" href="#fig:user_model_initial">Figure&nbsp;6.2</a>.</p>

<div class="label" id="fig:user_model_initial"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_initial.png" alt="user_model_initial" /></span></div><div class="caption"><span class="header">Figure 6.2: </span><span class="description">The users data model produced by <a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a>.</span></div></div>


<p>We can run the migration, known as &ldquo;migrating up&rdquo;, using the <code>rake</code> command (<a class="ref" href="#sidebar:rake">Box&nbsp;2.1</a>) as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>(You may recall that we ran this command once before, in <a class="ref" href="#sec:demo_users_resource">Section&nbsp;2.2</a>.) The first time <code>db:migrate</code> is run, it creates a file called <code>db/development.sqlite3</code>, which is an <a href="http://sqlite.org/">SQLite</a><sup class="footnote" id="fnref:6.5"><a href="#fn:6.5">5</a></sup> database. We can see the structure of the database using the excellent <a href="http://sourceforge.net/projects/sqlitebrowser/">SQLite Database Browser</a> to open the <code>db/development.sqlite3</code> file (<a class="ref" href="#fig:sqlite_database_browser">Figure&nbsp;6.3</a>); compare with the diagram in <a class="ref" href="#fig:user_model_initial">Figure&nbsp;6.2</a>.  You might note that there&rsquo;s one column in <a class="ref" href="#fig:sqlite_database_browser">Figure&nbsp;6.3</a> not accounted for in the migration: the <code>id</code> column. As noted briefly in <a class="ref" href="#sec:demo_users_resource">Section&nbsp;2.2</a>, this column is created automatically, and is used by Rails to identify each row uniquely.</p>

<div class="label" id="fig:sqlite_database_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_database_browser.png" alt="sqlite_database_browser" /></span></div><div class="caption"><span class="header">Figure 6.3: </span><span class="description">The  <a href="http://sqlitebrowser.sourceforge.net/">SQLite Database Browser</a> with our new <code>users</code> table.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_database_browser-full.png">(full size)</a></span></div></div>


<p>Most migrations, including all the ones in the <em>Rails Tutorial</em>, are <em>reversible</em>, which means we can &ldquo;migrate down&rdquo; and undo them with a single Rake task, called <code>db:rollback</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:rollback
</pre></div>
</div>


<p>(See <a class="ref" href="#sidebar:undoing_things">Box&nbsp;3.1</a> for another technique useful for reversing migrations.) Under the hood, this command executes the <code>drop_table</code> command to remove the users table from the database. The reason this works is that the <code>change</code> method knows that <code>drop_table</code> is the inverse of <code>create_table</code>, which means that the rollback migration can be easily inferred. In the case of an irreversible migration, such as one to remove a database column, it is necessary to define separate <code>up</code> and <code>down</code> methods in place of the single <code>change</code> method. Read about <a href="http://guides.rubyonrails.org/migrations.html">migrations in the Rails Guides</a> for more information.</p>

<p>If you rolled back the database, migrate up again before proceeding:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>




<div class="label" id="sec:the_model_file"></div>


<h3><a id="sec:6.1.2" href="#sec:the_model_file" class="heading"><span class="number">6.1.2</span> The model file</a></h3>


<p>We&rsquo;ve seen how the User model generation in <a class="ref" href="#code:generate_user_model">Listing&nbsp;6.1</a> generated a migration file (<a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a>), and we saw in <a class="ref" href="#fig:sqlite_database_browser">Figure&nbsp;6.3</a> the results of running this migration: it updated a file called <code>development.sqlite3</code> by creating a table <code>users</code> with columns <code>id</code>, <code>name</code>, <code>email</code>, <code>created_at</code>, and <code>updated_at</code>. <a class="ref" href="#code:generate_user_model">Listing&nbsp;6.1</a> also created the model itself; the rest of this section is dedicated to understanding it.</p>

<p>We begin by looking at the code for the User model, which lives in the file <code>user.rb</code> inside the <code>app/models/</code> directory. It is, to put it mildly, very compact (<a class="ref" href="#code:raw_user_model">Listing&nbsp;6.3</a>). (<em>Note</em>: The <code>attr_accessible</code> line will not appear if you are using Rails&nbsp;3.2.2 or earlier. In this case, you should add it in <a class="ref" href="#sec:accessible_attributes">Section&nbsp;6.1.2.2</a>.)</p>

<div class="label" id="code:raw_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.3.</span> <span class="description">The brand new User model. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Recall from <a class="ref" href="#sec:a_class_of_our_own">Section&nbsp;4.4.2</a> that the syntax <code>class User &lt; ActiveRecord::Base</code> means that the <code>User</code> class <em>inherits</em> from <code>ActiveRecord::Base</code>, so that the User model automatically has all the functionality of the <code>ActiveRecord::Base</code> class. Of course, knowledge of this inheritance doesn&rsquo;t do any good unless we know what <code>ActiveRecord::Base</code> contains, and we&rsquo;ll get a first look momentarily. Before we move on, though, there are two tasks to complete.</p>

<div class="label" id="sec:model_annotation"></div>


<h4><a id="sec:6.1.2.1" href="#sec:model_annotation" class="heading">Model annotation</a></h4>


<p>Although it&rsquo;s not strictly necessary, you might find it convenient to <em>annotate</em> your Rails models using the <code>annotate</code> gem (<a class="ref" href="#code:gemfile_annotate">Listing&nbsp;6.4</a>).</p>

<div class="label" id="code:gemfile_annotate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.4.</span> <span class="description">Adding the <code>annotate</code> gem to the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.10.0&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;annotate&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span><span class="p">,</span> <span class="ss">group:</span> <span class="ss">:development</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(We place the <code>annotate</code> gem in a <code>group :development</code> block (analogous to <code>group :test</code>) because the annotations aren&rsquo;t needed in production applications.) We next install it with <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>This gives us a command called <code>annotate</code>, which simply adds comments containing the data model to the model file:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>annotate
<span class="go">Annotated (1): User</span>
</pre></div>
</div>


<p>The results appear in <a class="ref" href="#code:annotated_user_model">Listing&nbsp;6.5</a>.</p>

<div class="label" id="code:annotated_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.5.</span> <span class="description">The annotated User model. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c1"># == Schema Information</span>
<span class="c1">#</span>
<span class="c1"># Table name: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer         not null, primary key</span>
<span class="c1">#  name       :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>I find that having the data model visible in the model files helps remind me which attributes the model has, but future code listings will omit the annotations for brevity. (Note that, if you want your annotations to be up-to-date, you&rsquo;ll have to run <code>annotate</code> again any time the data model changes.)</p>

<div class="label" id="sec:accessible_attributes"></div>


<h4><a id="sec:6.1.2.2" href="#sec:accessible_attributes" class="heading">Accessible attributes</a></h4>


<p>Let&rsquo;s revisit the User model, focusing now on the <code>attr_accessible</code> line (<a class="ref" href="#code:attr_accessible">Listing&nbsp;6.6</a>). This line tells Rails which attributes of the model are <em>accessible</em>, i.e., which attributes can be modified automatically by outside users (such as users submitting requests with web browsers).</p>

<div class="label" id="code:attr_accessible"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.6.</span> <span class="description">Making the <code>name</code> and <code>email</code> attributes accessible. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:attr_accessible">Listing&nbsp;6.6</a> doesn&rsquo;t do quite what you might think. By default, <em>all</em> model attributes are accessible. What <a class="ref" href="#code:attr_accessible">Listing&nbsp;6.6</a> does is to ensure that the <code>name</code> and <code>email</code> attributes&mdash;and <em>only</em> the <code>name</code> and <code>email</code> attributes&mdash;are automatically accessible to outside users. We&rsquo;ll see why this is important in <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>: using <code>attr_accessible</code> is important for preventing a <em>mass assignment</em> vulnerability, a distressingly common and often serious security hole in many Rails applications.</p>

<div class="label" id="sec:creating_user_objects"></div>


<h3><a id="sec:6.1.3" href="#sec:creating_user_objects" class="heading"><span class="number">6.1.3</span> Creating user objects</a></h3>


<p>We&rsquo;ve done some good prep work, and now it&rsquo;s time to cash in and learn about Active Record by playing with our newly created User model. As in <a class="ref" href="#cha:rails_flavored_ruby">Chapter&nbsp;4</a>, our tool of choice is the Rails console. Since we don&rsquo;t (yet) want to make any changes to our database, we&rsquo;ll start the console in a <em>sandbox</em>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="go">Loading development environment in sandbox</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;&gt; </span>
</pre></div>
</div>


<p>As indicated by the helpful message &ldquo;Any modifications you make will be rolled back on exit&rdquo;, when started in a sandbox the console will &ldquo;roll back&rdquo; (i.e., undo) any database changes introduced during the session.</p>

<p>In the console session in <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>, we created a new user object with <code>User.new</code>, which we had access to only after requiring the example user file in <a class="ref" href="#code:example_user">Listing&nbsp;4.9</a>. With models, the situation is different; as you may recall from <a class="ref" href="#sec:a_controller_class">Section&nbsp;4.4.4</a>, the Rails console automatically loads the Rails environment, which includes the models. This means that we can make a new user object without any further work:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>We see here the default console representation of a user object, which prints out the same attributes shown in <a class="ref" href="#fig:user_model_initial">Figure&nbsp;6.2</a> and <a class="ref" href="#code:annotated_user_model">Listing&nbsp;6.5</a>.</p>

<p>When called with no arguments, <code>User.new</code> returns an object with all <code>nil</code> attributes. In <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>, we designed the example User class to take an <em>initialization hash</em> to set the object attributes; that design choice was motivated by Active Record, which allows objects to be initialized in the same way:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>Here we see that the name and email attributes have been set as expected.</p>

<p>If you&rsquo;ve been tailing the development log, you may have noticed that no new lines have shown up yet. This is because calling <code>User.new</code> doesn&rsquo;t touch the database; it simply creates a new Ruby object in memory. To save the user object to the database, we call the <code>save</code> method on the <code>user</code> variable:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>The <code>save</code> method returns <code>true</code> if it succeeds and <code>false</code> otherwise. (Currently, all saves should succeed; we&rsquo;ll see cases in <a class="ref" href="#sec:user_validations">Section&nbsp;6.2</a> when some will fail.) As soon as you save, you should see a line in the development log with the SQL command to <code>INSERT INTO "users"</code>. Because of the many methods supplied by Active Record, we won&rsquo;t ever need raw SQL in this book, and I&rsquo;ll omit discussion of the SQL commands from now on. But you can learn a lot by watching the log.</p>

<p>You may have noticed that the new user object had <code>nil</code> values for the <code>id</code> and the magic columns <code>created_at</code> and <code>updated_at</code> attributes. Let&rsquo;s see if our <code>save</code> changed anything:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>We see that the <code>id</code> has been assigned a value of&nbsp;<code>1</code>, while the magic columns have been assigned the current time and date.<sup class="footnote" id="fnref:6.6"><a href="#fn:6.6">6</a></sup> Currently, the created and updated timestamps are identical; we&rsquo;ll see them differ in <a class="ref" href="#sec:updating_user_objects">Section&nbsp;6.1.5</a>.</p>

<p>As with the User class in <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>, instances of the User model allow access to their attributes using a dot notation:<sup class="footnote" id="fnref:6.7"><a href="#fn:6.7">7</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Tue, 05 Dec 2011 00:57:46 UTC +00:00</span>
</pre></div>
</div>


<p>As we&rsquo;ll see in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, it&rsquo;s often convenient to make and save a model in two steps as we have above, but Active Record also lets you combine them into one step with <code>User.create</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;A Nother&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;another@example.org&quot;</span><span class="p">)</span>
<span class="go">#&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2011-12-05 01:05:24&quot;, updated_at: &quot;2011-12-05 01:05:24&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">)</span>
<span class="go">#&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Note that <code>User.create</code>, rather than returning <code>true</code> or <code>false</code>, returns the User object itself, which we can optionally assign to a variable (such as <code>foo</code> in the second command above).</p>

<p>The inverse of <code>create</code> is <code>destroy</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Oddly, <code>destroy</code>, like <code>create</code>, returns the object in question, though I can&rsquo;t recall ever having used the return value of <code>destroy</code>. Even odder, perhaps, is that the <code>destroy</code>ed object still exists in memory:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>How do we know if we really destroyed an object? And for saved and non-destroyed objects, how can we retrieve users from the database? It&rsquo;s time to learn how to use Active Record to find user objects.</p>

<div class="label" id="sec:finding_user_objects"></div>


<h3><a id="sec:6.1.4" href="#sec:finding_user_objects" class="heading"><span class="number">6.1.4</span> Finding user objects</a></h3>


<p>Active Record provides several options for finding objects. Let&rsquo;s use them to find the first user we created while verifying that the third user (<code>foo</code>) has been destroyed. We&rsquo;ll start with the existing user:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Here we&rsquo;ve passed the id of the user to <code>User.find</code>; Active Record returns the user with that&nbsp;id.</p>

<p>Let&rsquo;s see if the user with an <code>id</code> of&nbsp;<code>3</code> still exists in the database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn&#39;t find User with ID=3</span>
</pre></div>
</div>


<p>Since we destroyed our third user in <a class="ref" href="#sec:creating_user_objects">Section&nbsp;6.1.3</a>, Active Record can&rsquo;t find it in the database. Instead, <code>find</code> raises an <em>exception</em>, which is a way of indicating an exceptional event in the execution of a program&mdash;in this case, a nonexistent Active Record id, which causes <code>find</code> to raise an <code>ActiveRecord::RecordNotFound</code> exception.<sup class="footnote" id="fnref:6.8"><a href="#fn:6.8">8</a></sup></p>

<p>In addition to the generic <code>find</code>, Active Record also allows us to find users by specific attributes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>The <code>find_by_email</code> method is automatically created by Active Record based on the <code>email</code> attribute in the <code>users</code> table. (As you might guess, Active Record creates a <code>find_by_name</code> method as well.) Since we will be using email addresses as usernames, this sort of <code>find</code> will be useful when we learn how to let users sign in to our site (<a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>). If you&rsquo;re worried that <code>find_by_email</code> will be inefficient if there are a large number of users, you&rsquo;re ahead of the game; we&rsquo;ll cover this issue, and its solution via database indices, in <a class="ref" href="#sec:uniqueness_validation">Section&nbsp;6.2.5</a>.</p>

<p>We&rsquo;ll end with a couple of more general ways of finding users. First, there&rsquo;s <code>first</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Naturally, <code>first</code> just returns the first user in the database. There&rsquo;s also <code>all</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; [#&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;,</span>
<span class="go">#&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2011-12-05 01:05:24&quot;, updated_at: &quot;2011-12-05 01:05:24&quot;&gt;]</span>
</pre></div>
</div>


<p>No prizes for inferring that <code>all</code> returns an array (<a class="ref" href="#sec:arrays_and_ranges">Section&nbsp;4.3.1</a>) of all users in the database.</p>

<div class="label" id="sec:updating_user_objects"></div>


<h3><a id="sec:6.1.5" href="#sec:updating_user_objects" class="heading"><span class="number">6.1.5</span> Updating user objects</a></h3>


<p>Once we&rsquo;ve created objects, we often want to update them. There are two basic ways to do this. First, we can assign attributes individually, as we did in <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user&#39;s attributes</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;mhartl@example.net&quot;</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Note that the final step is necessary to write the changes to the database. We can see what happens without a save by using <code>reload</code>, which reloads the object based on the database information:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;foo@bar.com&quot;</span>
<span class="go">=&gt; &quot;foo@bar.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
</pre></div>
</div>


<p>Now that we&rsquo;ve updated the user, the magic columns differ, as promised in <a class="ref" href="#sec:creating_user_objects">Section&nbsp;6.1.3</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; &quot;2011-12-05 00:57:46&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; &quot;2011-12-05 01:37:32&quot;</span>
</pre></div>
</div>


<p>The second way to update attributes is to use <code>update_attributes</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;The Dude&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;dude@abides.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; &quot;The Dude&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;dude@abides.org&quot;</span>
</pre></div>
</div>


<p>The <code>update_attributes</code> method accepts a hash of attributes, and on success performs both the update and the save in one step (returning <code>true</code> to indicate that the save went through). It&rsquo;s worth noting that, once you have defined some attributes as accessible using <code>attr_accessible</code> (<a class="ref" href="#sec:accessible_attributes">Section&nbsp;6.1.2.2</a>), <em>only</em> those attributes can be modified using <code>update_attributes</code>. If you ever find that your models mysteriously start refusing to update certain columns, check to make sure that those columns are included in the call to <code>attr_accessible</code>.</p>

<div class="label" id="sec:user_validations"></div>


<h2><a id="sec:6.2" href="#sec:user_validations" class="heading"><span class="number">6.2</span> User validations</a></h2>


<p>The User model we created in <a class="ref" href="#sec:user_model">Section&nbsp;6.1</a> now has working <code>name</code> and <code>email</code> attributes, but they are completely generic: any string (including an empty one) is currently valid in either case. And yet, names and email addresses are more specific than this. For example, <code>name</code> should be non-blank, and <code>email</code> should match the specific format characteristic of email addresses. Moreover, since we&rsquo;ll be using email addresses as unique usernames when users sign in, we shouldn&rsquo;t allow email duplicates in the database.</p>

<p>In short, we shouldn&rsquo;t allow <code>name</code> and <code>email</code> to be just any strings; we should enforce certain constraints on their values. Active Record allows us to impose such constraints using <em>validations</em>. In this section, we&rsquo;ll cover several of the most common cases, validating <em>presence</em>, <em>length</em>, <em>format</em> and <em>uniqueness</em>. In <a class="ref" href="#sec:has_secure_password">Section&nbsp;6.3.4</a> we&rsquo;ll add a final common validation, <em>confirmation</em>. And we&rsquo;ll see in <a class="ref" href="#sec:signup_failure">Section&nbsp;7.3</a> how validations give us convenient error messages when users make submissions that violate them.</p>

<div class="label" id="sec:initial_user_tests"></div>


<h3><a id="sec:6.2.1" href="#sec:initial_user_tests" class="heading"><span class="number">6.2.1</span> Initial user tests</a></h3>


<p>As with the other features of our sample app, we&rsquo;ll add User model validations using test-driven development. Because we didn&rsquo;t pass the</p>

<pre class="verbatim">--no-test-framework</pre>


<p>flag when we generated the User model (unlike, e.g., <a class="ref" href="#code:generate_users_controller">Listing&nbsp;5.28</a>), the command in <a class="ref" href="#code:generate_user_model">Listing&nbsp;6.1</a> produces an initial spec for testing users, but in this case it&rsquo;s practically blank (<a class="ref" href="#code:default_user_spec">Listing&nbsp;6.7</a>).</p>

<div class="label" id="code:default_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.7.</span> <span class="description">The practically blank default User spec. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This simply uses the <code>pending</code> method to indicate that we should fill the spec with something useful. We can see its effect by running the User model spec:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb 
<span class="go">*</span>


<span class="go">Finished in 0.01999 seconds</span>
<span class="go">1 example, 0 failures, 1 pending</span>

<span class="go">Pending:</span>
<span class="go">  User add some examples to (or delete)</span>
<span class="go">  /Users/mhartl/rails_projects/sample_app/spec/models/user_spec.rb</span>
<span class="go">  (Not Yet Implemented)</span>
</pre></div>
</div>


<p>On many systems, pending specs will be displayed in yellow to indicate that they are in between passing (green) and failing (red).</p>

<p>We&rsquo;ll follow the advice of the default spec by filling it in with some RSpec examples, shown in <a class="ref" href="#code:user_spec">Listing&nbsp;6.8</a>.</p>

<div class="label" id="code:user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.8.</span> <span class="description">Testing for the <code>:name</code> and <code>:email</code> attributes. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The <code>before</code> block, which we saw in <a class="ref" href="#code:pretty_page_tests">Listing&nbsp;5.27</a>), runs the code inside the block before each example&mdash;in this case, creating a new <code>@user</code> instance variable using <code>User.new</code> and a valid initialization hash. Then</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
</pre></div>
</div>


<p>makes <code>@user</code> the default subject of the test example, as seen before in the context of the <code>page</code> variable in <a class="ref" href="#sec:pretty_rspec">Section&nbsp;5.3.4</a>.</p>

<p>The two examples in <a class="ref" href="#code:user_spec">Listing&nbsp;6.8</a> test for the existence of <code>name</code> and <code>email</code> attributes:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>These examples implicitly use the Ruby method <code>respond_to?</code>, which accepts a symbol and returns <code>true</code> if the object responds to the given method or attribute and <code>false</code> otherwise:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:foobar</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>(Recall from <a class="ref" href="#sec:objects_and_message_passing">Section&nbsp;4.2.3</a> that Ruby uses a question mark to indicate such true/false boolean methods.) The tests themselves rely on the <em>boolean convention</em> used by RSpec: the code</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>


<p>can be tested using the RSpec code</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>


<p>Because of <code>subject { @user }</code>, we can leave off <code>@user</code> in the test, yielding</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>These kinds of tests allow us to use TDD to add new attributes and methods to our User model, and as a side-effect we get a nice specification for the methods that all <code>User</code> objects should respond to.</p>

<p>You should verify at this point that the tests fail:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Even though we created a development database with <code>rake db:migrate</code> in <a class="ref" href="#sec:database_migrations">Section&nbsp;6.1.1</a>, the tests fail because the <em>test database</em> doesn&rsquo;t yet know about the data model (indeed, it doesn&rsquo;t yet exist at all). We can create a test database with the correct structure, and thereby get the tests to pass, using the <code>db:test:prepare</code> Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>This just ensures that the data model from the development database, <code>db/development.sqlite3</code>, is reflected in the test database, <code>db/test.sqlite3</code>. Failure to run this Rake task after a migration is a common source of confusion. In addition, sometimes the test database gets corrupted and needs to be reset. If your test suite is mysteriously breaking, be sure to try running <code>rake db:test:prepare</code> to see if that fixes the problem.</p>

<div class="label" id="sec:presence_validation"></div>


<h3><a id="sec:6.2.2" href="#sec:presence_validation" class="heading"><span class="number">6.2.2</span> Validating presence</a></h3>


<p>Perhaps the most elementary validation is <em>presence</em>, which simply verifies that a given attribute is present. For example, in this section we&rsquo;ll ensure that both the name and email fields are present before a user gets saved to the database. In <a class="ref" href="#sec:signup_error_messages">Section&nbsp;7.3.2</a>, we&rsquo;ll see how to propagate this requirement up to the signup form for creating new users.</p>

<p>We&rsquo;ll start with a test for the presence of a <code>name</code> attribute. Although the first step in TDD is to write a <em>failing</em> test (<a class="ref" href="#sec:TDD">Section&nbsp;3.2.1</a>), in this case we don&rsquo;t yet know enough about validations to write the proper test, so we&rsquo;ll write the validation first, using the console to understand it. Then we&rsquo;ll comment out the validation, write a failing test, and verify that uncommenting the validation gets the test to pass. This procedure may seem pedantic for such a simple test, but I have seen many &ldquo;simple&rdquo; tests that actually test the wrong thing; being meticulous about TDD is simply the <em>only</em> way to be confident that we&rsquo;re testing the right thing. (This comment-out technique is also useful when rescuing an application whose application code is already written but&mdash;<a href="http://en.wiktionary.org/wiki/quelle_horreur"><em>quelle horreur!</em></a>&mdash;has no tests.)</p>

<p>The way to validate the presence of the name attribute is to use the <code>validates</code> method with argument <code>presence: true</code>, as shown in  <a class="ref" href="#code:validates_presence_of_name">Listing&nbsp;6.9</a>. The <code>presence: true</code> argument is a one-element <em>options hash</em>; recall from <a class="ref" href="#sec:css_revisited">Section&nbsp;4.3.4</a> that curly braces are optional when passing hashes as the final argument in a method. (As noted in <a class="ref" href="#sec:adding_to_the_layout">Section&nbsp;5.1.1</a>, the use of options hashes is a recurring theme in Rails.)</p>

<div class="label" id="code:validates_presence_of_name"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.9.</span> <span class="description">Validating the presence of a <code>name</code> attribute. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:validates_presence_of_name">Listing&nbsp;6.9</a> may look like magic, but <code>validates</code> is just a method, as indeed is <code>attr_accessible</code>. An equivalent formulation of <a class="ref" href="#code:validates_presence_of_name">Listing&nbsp;6.9</a> using parentheses is as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>

  <span class="n">validates</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Let&rsquo;s drop into the console to see the effects of adding a validation to our User model:<sup class="footnote" id="fnref:6.9"><a href="#fn:6.9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Here <code>user.save</code> returns <code>false</code>, indicating a failed save. In the final command, we use the <code>valid?</code> method, which returns <code>false</code> when the object fails one or more validations, and <code>true</code> when all validations pass. In this case, we only have one validation, so we know which one failed, but it can still be helpful to check using the <code>errors</code> object generated on failure:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Name can&#39;t be blank&quot;]</span>
</pre></div>
</div>


<p>(The error message is a hint that Rails validates the presence of an attribute using the <code>blank?</code> method, which we saw at the end of <a class="ref" href="#sec:modifying_built_in_classes">Section&nbsp;4.4.3</a>.)</p>

<p>Now for the failing test. To ensure that our incipient test will fail, let&rsquo;s comment out the validation at this point (<a class="ref" href="#code:commented_out_validation">Listing&nbsp;6.10</a>).</p>

<div class="label" id="code:commented_out_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.10.</span> <span class="description">Commenting out a validation to ensure a failing test. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="c1"># validates :name, presence: true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The initial validation tests then appear as in <a class="ref" href="#code:failing_validates_name_spec">Listing&nbsp;6.11</a>.</p>

<div class="label" id="code:failing_validates_name_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.11.</span> <span class="description">A failing test for validation of the <code>name</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when name is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The first new example is just a sanity check, verifying that the <code>@user</code> object is initially valid:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div>
</div>


<p>This is another example of the RSpec boolean convention we saw in <a class="ref" href="#sec:initial_user_tests">Section&nbsp;6.2.1</a>: whenever an object responds to a boolean method <code>foo?</code>, there is a corresponding test method called <code>be_foo</code>. In this case, we can test the result of calling</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</pre></div>
</div>


<p>with</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
</pre></div>
</div>


<p>As before, <code>subject { @user }</code> lets us leave off <code>@user</code>, yielding</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div>
</div>


<p>The second test first sets the user&rsquo;s name to an invalid (blank) value, and then tests to see that the resulting <code>@user</code> object is invalid:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when name is not present&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>This uses a <code>before</code> block to set the user&rsquo;s name to an invalid (blank) value and then checks that the resulting user object is not valid.</p>

<p>You should verify that the tests fail at this point:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">...F</span>
<span class="go">4 examples, 1 failure</span>
</pre></div>
</div>


<p>Now uncomment the validation (i.e., revert <a class="ref" href="#code:commented_out_validation">Listing&nbsp;6.10</a> back to <a class="ref" href="#code:validates_presence_of_name">Listing&nbsp;6.9</a>) to get the tests to pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">....</span>
<span class="go">4 examples, 0 failures</span>
</pre></div>
</div>


<p>Of course, we also want to validate the presence of email addresses. The test (<a class="ref" href="#code:validates_email_spec">Listing&nbsp;6.12</a>) is analogous to the one for the <code>name</code> attribute.</p>

<div class="label" id="code:validates_email_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.12.</span> <span class="description">A test for presence of the <code>email</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The implementation is also virtually the same, as seen in <a class="ref" href="#code:validates_presence_of_email">Listing&nbsp;6.13</a>.</p>

<div class="label" id="code:validates_presence_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.13.</span> <span class="description">Validating the presence of the <code>name</code> and <code>email</code> attributes. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now all the tests should pass, and the presence validations are complete.</p>

<div class="label" id="sec:length_validation"></div>


<h3><a id="sec:6.2.3" href="#sec:length_validation" class="heading"><span class="number">6.2.3</span> Length validation</a></h3>


<p>We&rsquo;ve constrained our User model to require a name for each user, but we should go further: the user&rsquo;s names will be displayed on the sample site, so we should enforce some limit on their length. With all the work we did in <a class="ref" href="#sec:presence_validation">Section&nbsp;6.2.2</a>, this step is easy.</p>

<p>We start with a test. There&rsquo;s no science to picking a maximum length; we&rsquo;ll just pull&nbsp;<code>50</code> out of thin air as a reasonable upper bound, which means verifying that names of&nbsp;<code>51</code> characters are too long   (<a class="ref" href="#code:length_validation_test">Listing&nbsp;6.14</a>).</p>

<div class="label" id="code:length_validation_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.14.</span> <span class="description">A test for <code>name</code> length validation. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when name is too long&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>For convenience, we&rsquo;ve used &ldquo;string multiplication&rdquo; in <a class="ref" href="#code:length_validation_test">Listing&nbsp;6.14</a> to make a string 51 characters long. We can see how this works using the console:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div>
</div>


<p>The test in <a class="ref" href="#code:length_validation_test">Listing&nbsp;6.14</a> should fail. To get it to pass, we need to know about the validation argument to constrain length, <code>:length</code>, along with the <code>:maximum</code> parameter to enforce the upper bound (<a class="ref" href="#code:length_validation">Listing&nbsp;6.15</a>).</p>

<div class="label" id="code:length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.15.</span> <span class="description">Adding a length validation for the <code>name</code> attribute. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now the tests should pass. With our test suite passing again, we can move on to a more challenging validation: email format.</p>

<div class="label" id="sec:format_validation"></div>


<h3><a id="sec:6.2.4" href="#sec:format_validation" class="heading"><span class="number">6.2.4</span> Format validation</a></h3>


<p>Our validations for the <code>name</code> attribute enforce only minimal constraints&mdash;any non-blank name under 51 characters will do&mdash;but of course the <code>email</code> attribute must satisfy more stringent requirements. So far we&rsquo;ve only rejected blank email addresses; in this section, we&rsquo;ll require email addresses to conform to the familiar pattern <code>user@example.com</code>.</p>

<p>Neither the tests nor the validation will be exhaustive, just good enough to accept most valid email addresses and reject most invalid ones. We&rsquo;ll start with a couple tests involving collections of valid and invalid addresses. To make these collections, it&rsquo;s worth knowing about the useful  <code>%w[]</code> technique for making arrays of strings, as seen in this console session:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.COM THE_US-ER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; [&quot;user@foo.COM&quot;, &quot;THE_US-ER@foo.bar.org&quot;, &quot;first.last@foo.jp&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">user@foo.COM</span>
<span class="go">THE_US-ER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div>
</div>


<p>Here we&rsquo;ve iterated over the elements of the <code>addresses</code> array using the <code>each</code> method (<a class="ref" href="#sec:blocks">Section&nbsp;4.3.2</a>). With this technique in hand, we&rsquo;re ready to write some basic email format validation tests (<a class="ref" href="#code:email_format_validation_tests">Listing&nbsp;6.16</a>).</p>

<div class="label" id="code:email_format_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.16.</span> <span class="description">Tests for email format validation. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email format is invalid&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be invalid&quot;</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo,com user_at_foo.org example.user@foo.</span>
<span class="sx">                     foo@bar_baz.com foo@bar+baz.com]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invalid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">invalid_address</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
      <span class="k">end</span>      
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when email format is valid&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be valid&quot;</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.COM A_US-ER@f.b.org frst.lst@foo.jp a+b@baz.cn]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">valid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">valid_address</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
      <span class="k">end</span>      
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As noted above, these are far from exhaustive, but we do check the common valid email forms <code>user@foo.COM</code>, <code>THE_US-ER@foo.bar.org </code> (uppercase, underscores, and compound domains), and <code>first.last@foo.jp</code> (the standard corporate username <code>first.last</code>, with a two-letter top-level domain&nbsp;<code>jp</code>), along with several invalid forms.</p>

<p>The application code for email format validation uses a <em>regular expression</em> (or <em>regex</em>) to define the format, along with the <code>:format</code> argument to the <code>validates</code> method (<a class="ref" href="#code:validates_format_of_email">Listing&nbsp;6.17</a>).</p>

<div class="label" id="code:validates_format_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.17.</span> <span class="description">Validating the email format with a regular expression. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here the regex <code>VALID_EMAIL_REGEX</code> is a <em>constant</em>, indicated in Ruby by a name starting with a capital letter. The code</p>

<div class="code"><div class="highlight"><pre>  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</pre></div>
</div>


<p>ensures that only email addresses that match the pattern will be considered valid. (Because it starts with a capital letter, <code>VALID_EMAIL_REGEX</code> is a Ruby <em>constant</em>, so its value can&rsquo;t change.)</p>

<p>So, where does the pattern come from? Regular expressions consist of a terse (some would say <a href="http://catb.org/jargon/html/L/line-noise.html">unreadable</a>) language for matching text patterns; learning to construct regexes is an art, and to get you started I&rsquo;ve broken <code>VALID_EMAIL_REGEX</code> into bite-sized pieces (<a class="ref" href="#table:valid_email_regex">Table&nbsp;6.1</a>).<sup class="footnote" id="fnref:6.10"><a href="#fn:6.10">10</a></sup> To really learn about regular expressions, though, I consider the amazing <a href="http://www.rubular.com/">Rubular</a> regular expression editor (<a class="ref" href="#fig:rubular">Figure&nbsp;6.4</a>) to be simply essential.<sup class="footnote" id="fnref:6.11"><a href="#fn:6.11">11</a></sup> The Rubular website has a beautiful interactive interface for making regular expressions, along with a handy regex quick reference. I encourage you to study <a class="ref" href="#table:valid_email_regex">Table&nbsp;6.1</a> with a browser window open to Rubular&mdash;no amount of reading about regular expressions can replace a couple of hours playing with Rubular. (Note: If you use the regex from <a class="ref" href="#code:validates_format_of_email">Listing&nbsp;6.17</a> in Rubular, you should leave off the <tt class="verb">\A</tt> and <tt class="verb">\z</tt> characters.)</p>

<div class="label" id="table:valid_email_regex"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>Expression</strong></th><th class="align_left"><strong>Meaning</strong></th></tr><tr class="top_bar"><td class="align_left"><tt class="verb">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</tt></td><td class="align_left">full regex</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">start of regex</td></tr><tr><td class="align_left"><tt class="verb">\A</tt></td><td class="align_left">match start of a string</td></tr><tr><td class="align_left"><tt class="verb">[\w+\-.]+</tt></td><td class="align_left">at least one word character, plus, hyphen, or dot</td></tr><tr><td class="align_left"><tt class="verb">@</tt></td><td class="align_left">literal &ldquo;at sign&rdquo;</td></tr><tr><td class="align_left"><tt class="verb">[a-z\d\-.]+</tt></td><td class="align_left">at least one letter, digit, hyphen, or dot</td></tr><tr><td class="align_left"><tt class="verb">\.</tt></td><td class="align_left">literal dot</td></tr><tr><td class="align_left"><tt class="verb">[a-z]+</tt></td><td class="align_left">at least one letter</td></tr><tr><td class="align_left"><tt class="verb">\z</tt></td><td class="align_left">match end of a string</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">end of regex</td></tr><tr><td class="align_left"><tt class="verb">i</tt></td><td class="align_left">case insensitive</td></tr></table></div><div class="caption"><span class="header">Table 6.1: </span><span class="description">Breaking down the email regex from <a class="ref" href="#code:validates_format_of_email">Listing&nbsp;6.17</a>.</span></div></div>


<p>By the way, there actually exists a full regex for matching email addresses according to the official standard, but it&rsquo;s really not worth the trouble. The one in <a class="ref" href="#code:validates_format_of_email">Listing&nbsp;6.17</a> is fine, maybe even better than the official one.<sup class="footnote" id="fnref:6.12"><a href="#fn:6.12">12</a></sup></p>

<div class="label" id="fig:rubular"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rubular.png" alt="rubular" /></span></div><div class="caption"><span class="header">Figure 6.4: </span><span class="description">The awesome  <a href="http://www.rubular.com/">Rubular</a> regular expression editor.&nbsp;<a href="http://railstutorial.org/images/figures/rubular-full.png">(full size)</a></span></div></div>


<p>The tests should all be passing now. (In fact, the tests for valid email addresses should have been passing all along; since regexes are notoriously error-prone, the valid email tests are there mainly as a sanity check on <code>VALID_EMAIL_REGEX</code>.) This means that there&rsquo;s only one constraint left: enforcing the email addresses to be unique.</p>

<div class="label" id="sec:uniqueness_validation"></div>


<h3><a id="sec:6.2.5" href="#sec:uniqueness_validation" class="heading"><span class="number">6.2.5</span> Uniqueness validation</a></h3>


<p>To enforce uniqueness of email addresses (so that we can use them as usernames), we&rsquo;ll be using the <code>:unique</code> option to the <code>validates</code> method. But be warned: there&rsquo;s a <em>major</em> caveat, so don&rsquo;t just skim this section&mdash;read it carefully.</p>

<p>We&rsquo;ll start, as usual, with our tests. In our previous model tests, we&rsquo;ve mainly used <code>User.new</code>, which just creates a Ruby object in memory, but for uniqueness tests we actually need to put a record into the database.<sup class="footnote" id="fnref:6.13"><a href="#fn:6.13">13</a></sup> The (first) duplicate email test appears in <a class="ref" href="#code:validates_uniqueness_of_email_test">Listing&nbsp;6.18</a>.</p>

<div class="label" id="code:validates_uniqueness_of_email_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.18.</span> <span class="description">A test for the rejection of duplicate email addresses. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email address is already taken&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The method here is to make a user with the same email address as <code>@user</code>, which we accomplish using <code>@user.dup</code>, which creates a duplicate user with the same attributes. Since we then save that user, the original <code>@user</code> has an email address that already exists in the database, and hence should not be valid.</p>

<p>We can get the new test in <a class="ref" href="#code:validates_uniqueness_of_email_test">Listing&nbsp;6.18</a> to pass with the code in <a class="ref" href="#code:validates_uniqueness_of_email">Listing&nbsp;6.19</a>.</p>

<div class="label" id="code:validates_uniqueness_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.19.</span> <span class="description">Validating the uniqueness of email addresses. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;re not quite done, though. Email addresses are case-insensitive&mdash;<code>foo@bar.com</code> goes to the same place as <code>FOO@BAR.COM</code> or <code>FoO@BAr.coM</code>&mdash;so our validation should cover this case as well. We test for this with the code in <a class="ref" href="#code:validates_uniqueness_of_email_case_insensitive_test">Listing&nbsp;6.20</a>.</p>

<div class="label" id="code:validates_uniqueness_of_email_case_insensitive_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.20.</span> <span class="description">A test for the rejection of duplicate email addresses, insensitive to case. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email address is already taken&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we are using the <code>upcase</code> method on strings (seen briefly in <a class="ref" href="#sec:blocks">Section&nbsp;4.3.2</a>). This test does the same thing as the first duplicate email test, but with an upper-case email address instead. If this test feels a little abstract, go ahead and fire up the console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="go">=&gt; &quot;USER@EXAMPLE.COM&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">dup</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Of course, <code>user_with_same_email.valid?</code> is <code>true</code>, because the uniqueness validation is currently case-sensitive, but we want it to be <code>false</code>. Fortunately, <code>:uniqueness</code> accepts an option, <code>:case_sensitive</code>, for just this purpose (<a class="ref" href="#code:validates_uniqueness_of_email_case_insensitive">Listing&nbsp;6.21</a>).</p>

<div class="label" id="code:validates_uniqueness_of_email_case_insensitive"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.21.</span> <span class="description">Validating the uniqueness of email addresses, ignoring case. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="p">{</span> <span class="ss">case_sensitive:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we have simply replaced <code>true</code> with <code>case_sensitive: false</code>; Rails infers in this case that <code>:uniqueness</code> should be <code>true</code>. At this point, our application&mdash;with an important caveat&mdash;enforces email uniqueness, and our test suite should pass.</p>

<div class="label" id="sec:the_caveat"></div>


<h4><a id="sec:6.2.5.1" href="#sec:the_caveat" class="heading">The uniqueness caveat</a></h4>


<p>There&rsquo;s just one small problem, the caveat alluded to above:</p>

<p><strong>Using <code>validates :uniqueness</code> does not guarantee uniqueness.</strong></p>

<p>D&rsquo;oh! But what can go wrong? Here&rsquo;s what:</p>

<ol>
<li>Alice signs up for the sample app, with address alice@wonderland.com.</li>
<li>Alice accidentally clicks on &ldquo;Submit&rdquo; <em>twice</em>, sending two requests in quick succession.</li>
<li>The following sequence occurs: request 1 creates a user in memory that passes validation, request 2 does the same, request&nbsp;1&rsquo;s user gets saved, request&nbsp;2&rsquo;s user gets saved.</li>
<li>Result: two user records with the exact same email address, despite the uniqueness validation.</li>
</ol>


<p>If the above sequence seems implausible, believe me, it isn&rsquo;t: it can happen on any Rails website with significant traffic. Luckily, the solution is straightforward to implement; we just need to enforce uniqueness at the database level as well. Our method is to create a database <em>index</em> on the email column, and then require that the index be unique.</p>

<p>The email index represents an update to our data modeling requirements, which (as discussed in <a class="ref" href="#sec:database_migrations">Section&nbsp;6.1.1</a>) is handled in Rails using migrations. We saw in <a class="ref" href="#sec:database_migrations">Section&nbsp;6.1.1</a> that generating the User model automatically created a new migration (<a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a>); in the present case, we are adding structure to an existing model, so we need to create a migration directly using the <code>migration</code> generator:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_index_to_users_email
</pre></div>
</div>


<p>Unlike the migration for users, the email uniqueness migration is not pre-defined, so we need to fill in its contents with <a class="ref" href="#code:email_uniqueness_index">Listing&nbsp;6.22</a>.<sup class="footnote" id="fnref:6.14"><a href="#fn:6.14">14</a></sup></p>

<div class="label" id="code:email_uniqueness_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.22.</span> <span class="description">The migration for enforcing email uniqueness. <br /> <code>db/migrate/[timestamp]_add_index_to_users_email.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIndexToUsersEmail</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This uses a Rails method called <code>add_index</code> to add an index on the <code>email</code> column of the <code>users</code> table. The index by itself doesn&rsquo;t enforce uniqueness, but the option <code>unique: true</code> does.</p>

<p>The final step is to migrate the database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>(If this fails, try exiting any running sandbox console sessions, which can lock the database and prevent migrations.) If you&rsquo;re interested in seeing the practical effect of this, take a look at the file <code>db/schema.rb</code>, which should now include a line like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;index_users_on_email&quot;</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div>
</div>


<p>Unfortunately, there&rsquo;s one more change we need to make to be assured of email uniqueness, which is to make sure that the email address is all lower-case before it gets saved to the database. The reason is that not all database adapters use case-sensitive indices.<sup class="footnote" id="fnref:6.15"><a href="#fn:6.15">15</a></sup> The way to do this is with a <a href="http://en.wikipedia.org/wiki/Callback_(computer_science)"><em>callback</em></a>, which is a method that gets invoked at a particular point in the lifetime of an Active Record object (see the <a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveRecord/Callbacks.html">Rails API entry on callbacks</a>). In the present case, we&rsquo;ll use a <code>before_save</code> callback to force Rails to downcase the email attribute before saving the user to the database, as shown in <a class="ref" href="#code:email_downcase">Listing&nbsp;6.23</a>.</p>

<div class="label" id="code:email_downcase"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.23.</span> <span class="description">Ensuring email uniqueness by downcasing the email attribute. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:email_downcase">Listing&nbsp;6.23</a> passes a block to the <code>before_save</code> callback and sets the user&rsquo;s email address to a lower-case version of its current value using the <code>downcase</code> string method. This code is a little advanced, and at this point I suggest you simply trust that it works; if you&rsquo;re skeptical, comment out the uniqueness validation from <a class="ref" href="#code:validates_uniqueness_of_email">Listing&nbsp;6.19</a> and try to create users with identical email addresses to see the error that results. (We&rsquo;ll see this technique again in <a class="ref" href="#sec:remember_me">Section&nbsp;8.2.1</a>.)</p>

<p>Now the Alice scenario above will work fine: the database will save a user record based on the first request, and will reject the second save for violating the uniqueness constraint. (An error will appear in the Rails log, but that doesn&rsquo;t do any harm. You can actually catch the <code>ActiveRecord::StatementInvalid</code> exception that gets raised&mdash;see <a href="http://github.com/insoshi/insoshi/blob/master/app/controllers/people_controller.rb">Insoshi</a> for an example&mdash;but in this tutorial we won&rsquo;t bother with this step.) Adding this index on the email attribute accomplishes a second goal, alluded to briefly in <a class="ref" href="#sec:finding_user_objects">Section&nbsp;6.1.4</a>: it fixes an efficiency problem in <code>find_by_email</code> (<a class="ref" href="#sidebar:database_indices">Box&nbsp;6.2</a>).</p>

<div class="label" id="sidebar:database_indices"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.2.</span><span class="description">Database indices</span></span>
<p>When creating a column in a database, it is important to consider whether we will need to <em>find</em> records by that column. Consider, for example, the <tt>email</tt> attribute created by the migration in <a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a>. When we allow users to sign in to the sample app starting in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, we will need to find the user record corresponding to the submitted email address; unfortunately, based on the na&iuml;ve data model, the only way to find a user by email address is to look through <em>each</em> user row in the database and compare its email attribute to the given email. This is known in the database business as a <em>full-table scan</em>, and for a real site with thousands of users it is a <a href="http://catb.org/jargon/html/B/Bad-Thing.html">Bad Thing</a>.</p>

<p>Putting an index on the email column fixes the problem. To understand a database index, it&rsquo;s helpful to consider the analogy of a book index. In a book, to find all the occurrences of a given string, say &ldquo;foobar&rdquo;, you would have to scan each page for &ldquo;foobar&rdquo;. With a book index, on the other hand, you can just look up &ldquo;foobar&rdquo; in the index to see all the pages containing &ldquo;foobar&rdquo;. A database index works essentially the same way.</p>
</div>




<div class="label" id="sec:adding_a_secure_password"></div>


<h2><a id="sec:6.3" href="#sec:adding_a_secure_password" class="heading"><span class="number">6.3</span> Adding a secure password</a></h2>


<p>In this section we&rsquo;ll add the last of the basic User attributes: a secure password used to authenticate users of the sample application. The method is to require each user to have a password (with a password confirmation), and then store an encrypted version of the password in the database. We&rsquo;ll also add a way to <em>authenticate</em> a user based on a given password, a method we&rsquo;ll use in <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a> to allow users to sign in to the site.</p>

<p>The method for authenticating users will be to take a submitted password, encrypt it, and compare the result to the encrypted value stored in the database. If the two match, then the submitted password is correct and the user is authenticated. By comparing encrypted values instead of raw passwords, we will be able to authenticate users without storing the passwords themselves, thereby avoiding a serious security hole.</p>

<div class="label" id="sec:an_encrypted_password"></div>


<h3><a id="sec:6.3.1" href="#sec:an_encrypted_password" class="heading"><span class="number">6.3.1</span> An encrypted password</a></h3>


<p>We&rsquo;ll start with the necessary change to the data model for users, which involves adding a <code>password_digest</code> column to the <code>users</code> table (<a class="ref" href="#fig:user_model_password_digest">Figure&nbsp;6.5</a>). The name <em>digest</em> comes from the terminology of <a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function">cryptographic hash functions</a>, and the exact name <code>password_digest</code> is necessary for the implementation in <a class="ref" href="#sec:has_secure_password">Section&nbsp;6.3.4</a> to work. By encrypting the password properly, we&rsquo;ll ensure that an attacker won&rsquo;t be able to sign in to the site even if he manages to obtain a copy of the database.</p>

<div class="label" id="fig:user_model_password_digest"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_password_digest.png" alt="user_model_password_digest" /></span></div><div class="caption"><span class="header">Figure 6.5: </span><span class="description">The User model with an added <code>password_digest</code> attribute.</span></div></div>


<p>We&rsquo;ll use the state-of-the-art hash function called <a href="http://en.wikipedia.org/wiki/Bcrypt">bcrypt</a> to irreversibly encrypt the password to form the password hash. To use bcrypt in the sample application, we need to add the <code>bcrypt-ruby</code> gem to our <code>Gemfile</code> (<a class="ref" href="#code:bcrypt_ruby">Listing&nbsp;6.24</a>).</p>

<div class="label" id="code:bcrypt_ruby"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.24.</span> <span class="description">Adding <code>bcrypt-ruby</code> to the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then run <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Since we want users to have a password digest column, a user object should respond to <code>password_digest</code>, which suggests the test shown in <a class="ref" href="#code:respond_to_password_digest">Listing&nbsp;6.25</a>.</p>

<div class="label" id="code:respond_to_password_digest"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.25.</span> <span class="description">Ensuring that a User object has a <code>password_digest</code> column. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To get the test to pass, we first generate an appropriate migration for the <code>password_digest</code> column:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_password_digest_to_users password_digest:string
</pre></div>
</div>


<p>Here the first argument is the migration name, and we&rsquo;ve also supplied a second argument with the name and type of attribute we want to create. (Compare this to the original generation of the <code>users</code> table in <a class="ref" href="#code:generate_user_model">Listing&nbsp;6.1</a>.) We can choose any migration name we want, but it&rsquo;s convenient to end the name with <code>_to_users</code>, since in this case Rails automatically constructs a migration to add columns to the <code>users</code> table. Moreover, by including the second argument, we&rsquo;ve given Rails enough information to construct the entire migration for us, as seen in <a class="ref" href="#code:password_migration">Listing&nbsp;6.26</a>.</p>

<div class="label" id="code:password_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.26.</span> <span class="description">The migration to add a <code>password_digest</code> column to the <code>users</code> table. <br /> <code>db/migrate/[ts]_add_password_digest_to_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordDigestToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code uses the <code>add_column</code> method to add a <code>password_digest</code> column to the <code>users</code> table.</p>

<p>We can get the failing test from <a class="ref" href="#code:respond_to_password_digest">Listing&nbsp;6.25</a> to pass by migrating the development database and preparing the test database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
<span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:password_and_confirmation"></div>


<h3><a id="sec:6.3.2" href="#sec:password_and_confirmation" class="heading"><span class="number">6.3.2</span> Password and confirmation</a></h3>


<p>As seen in the mockup in <a class="ref" href="#fig:signup_mockup_preview">Figure&nbsp;6.1</a>, we expect to have users confirm their passwords, a common practice on the web meant to minimize typos. We could enforce this at the controller layer, but it&rsquo;s conventional to put it in the model and use Active Record to enforce the constraint. The method is to add <code>password</code> and <code>password_confirmation</code> attributes to the User model, and then require that the two attributes match before the record is saved to the database. Unlike the other attributes we&rsquo;ve seen so far, the password attributes will be <em>virtual</em>&mdash;they will only exist temporarily in memory, and will not be persisted to the database.</p>

<p>We&rsquo;ll start with <code>respond_to</code> tests for a password and its confirmation, as seen in <a class="ref" href="#code:user_respond_to_password">Listing&nbsp;6.27</a>.</p>

<div class="label" id="code:user_respond_to_password"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.27.</span> <span class="description">Testing for the <code>password</code> and <code>password_confirmation</code> attributes. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we&rsquo;ve added <code>:password</code> and <code>:password_confirmation</code> to the initialization hash for <code>User.new</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                   <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We definitely don&rsquo;t want users to enter a blank password, so we&rsquo;ll add another test to validate password presence:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password is not present&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Since we&rsquo;ll be testing password mismatch in a moment, here we make sure to test the <em>presence</em> validation by setting both the password and its confirmation to a blank string. This uses Ruby&rsquo;s ability to make more than one assignment in a line. For example, in the console we can set both <code>a</code>&nbsp;and&nbsp;<code>b</code> to&nbsp;<code>3</code> as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>


<p>In the present case, we use it to set both password attributes to&nbsp;<code>" "</code>:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
</pre></div>
</div>


<p>We also want to ensure that the password and confirmation match. The case where they <em>do</em> match is already covered by <code>it { should be_valid }</code>, so we only need to test the case of a mismatch:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password doesn&#39;t match confirmation&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;mismatch&quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In principle, we are now done, but there is one case that doesn&rsquo;t quite work. What if the password confirmation is blank? If it is empty or consists of whitespace but the password is valid, then the two don&rsquo;t match and the confirmation validation will catch it. If both the password and its confirmation are empty or consist of whitespace, then the password presence validation will catch it. Unfortunately, there&rsquo;s one more possibility, which is that the password confirmation is <em>nil</em>. This can never happen through the web, but it can at the console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>            <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div>
</div>


<p>When the confirmation is <code>nil</code>, Rails doesn&rsquo;t run the confirmation validation, which means that we can create users at the console without password confirmations. (Of course, right <em>now</em> we haven&rsquo;t added the validations yet, so the code above will work in any case.) To prevent this, we&rsquo;ll add a test to catch this case:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password confirmation is nil&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>(This behavior strikes me as a minor bug in Rails, and perhaps it will be fixed in a future version, and in any case adding the validation does no harm.)</p>

<p>Putting everything together gives the (failing) tests in <a class="ref" href="#code:password_tests">Listing&nbsp;6.28</a>. We&rsquo;ll get them to pass in <a class="ref" href="#sec:has_secure_password">Section&nbsp;6.3.4</a>.</p>

<div class="label" id="code:password_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.28.</span> <span class="description">Test for the password and password confirmation. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when password is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when password doesn&#39;t match confirmation&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;mismatch&quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when password confirmation is nil&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:user_authentication"></div>


<h3><a id="sec:6.3.3" href="#sec:user_authentication" class="heading"><span class="number">6.3.3</span> User authentication</a></h3>


<p>The final piece of our password machinery is a method to retrieve users based on their email and passwords. This divides naturally into two parts: first, find a user by email address; second, authenticate the user with a given password.</p>

<p>The first step is simple; as we saw in <a class="ref" href="#sec:finding_user_objects">Section&nbsp;6.1.4</a>, we can find a user with a given email address using the <code>find_by_email</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</pre></div>
</div>


<p>The second step is then to use an <code>authenticate</code> method to verify that the user has the given password. In <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>, we&rsquo;ll retrieve the current (signed-in) user using code something like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>


<p>If the given password matches the user&rsquo;s password, it should return the user; otherwise, it should return <code>false</code>.</p>

<p>As usual, we can express the requirement for <code>authenticate</code> using RSpec. The resulting tests are more advanced than the others we&rsquo;ve seen, so let&rsquo;s break them down into pieces; if you&rsquo;re new to RSpec, you might want to read this section a couple of times. We start by requiring a User object to respond to <code>authenticate</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>We then cover the two cases of password match and mismatch:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;return value of authenticate method&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;with valid password&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The <code>before</code> block saves the user to the database so that it can be retrieved using <code>find_by_email</code>, which we accomplish using the <code>let</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>We&rsquo;ve used <code>let</code> in a couple of exercises, but this is the first time we&rsquo;ve seen it in the body of the tutorial. <a class="ref" href="#sidebar:let">Box&nbsp;6.3</a> covers <code>let</code> in more detail.</p>

<p>The two <code>describe</code> blocks cover the case where <code>@user</code> and <code>found_user</code> should be the same (password match) and different (password mismatch); they use the &ldquo;double equals&rdquo; <code>==</code> test for object equivalence (<a class="ref" href="#sec:arrays_and_ranges">Section&nbsp;4.3.1</a>). Note that the tests in</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>use <code>let</code> a second time, and also use the <code>specify</code> method. This is just a synonym for <code>it</code>, and can be used when writing <code>it</code> would sound unnatural. In this case, it sounds good to say &ldquo;it [i.e., the user] should not equal wrong user&rdquo;, but it sounds strange to say &ldquo;user: user with invalid password should be false&rdquo;; saying &ldquo;specify: user with invalid password should be false&rdquo; sounds better.</p>

<div class="label" id="sidebar:let"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.3.</span><span class="description">Using <tt>let</tt></span></span>
<p>RSpec&rsquo;s <tt>let</tt> method provides a convenient way to create local variables inside tests. The syntax might look a little strange, but its effect is similar to variable assignment. The argument of <tt>let</tt> is a symbol, and it takes a block whose return value is assigned to a local variable with the symbol&rsquo;s name. In other words,</p>

<pre class="verbatim">let(:found_user) { User.find_by_email(@user.email) }</pre>


<p>creates a <tt>found_user</tt> variable whose value is equal to the result of <tt>find_by_email</tt>. We can then use this variable in any of the <tt>before</tt> or <tt>it</tt> blocks throughout the rest of the test. One advantage of <tt>let</tt> is that it <em>memoizes</em> its value, which means that it remembers the value from one invocation to the next. (Note that <a href="http://en.wikipedia.org/wiki/Memoization"><em>memoize</em></a> is a technical term; in particular, it&rsquo;s <em>not</em> a misspelling of &ldquo;memorize&rdquo;.) In the present case, because <tt>let</tt> memoizes the <tt>found_user</tt> variable, the <tt>find_by_email</tt> method will only be called once whenever the User model specs are run.</p>
</div>


<p>Finally, as a security precaution, we&rsquo;ll test for a length validation on passwords, requiring that they be at least six characters long:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with a password that&#39;s too short&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Putting together all the tests above gives <a class="ref" href="#code:authenticate_spec">Listing&nbsp;6.29</a>.</p>

<div class="label" id="code:authenticate_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.29.</span> <span class="description">Test for the <code>authenticate</code> method. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;with a password that&#39;s too short&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;return value of authenticate method&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid password&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As noted in <a class="ref" href="#sidebar:let">Box&nbsp;6.3</a>, <code>let</code> memoizes its value, so that the first nested <code>describe</code> block in <a class="ref" href="#code:authenticate_spec">Listing&nbsp;6.29</a> invokes <code>let</code> to retrieve the user from the database using <code>find_by_email</code>, but the second <code>describe</code> block doesn&rsquo;t hit the database a second time.</p>

<div class="label" id="sec:has_secure_password"></div>


<h3><a id="sec:6.3.4" href="#sec:has_secure_password" class="heading"><span class="number">6.3.4</span> User has secure password</a></h3>


<p>In previous versions of Rails, adding a secure password was difficult and time-consuming, as seen in the <a href="http://railstutorial.org/book?version=3.0">Rails&nbsp;3.0 version of the <em>Rails Tutorial</em></a><sup class="footnote" id="fnref:6.16"><a href="#fn:6.16">16</a></sup>, which covers the creation of an authentication system from scratch. But web developers&rsquo; understanding of how best to authenticate users has matured enough that it now comes bundled with the latest version of Rails. As a result, we&rsquo;ll complete the implementation of secure passwords (and get to a green test suite) using only a few lines of code.</p>

<p>First, we need to make the <code>password</code> and <code>password_confirmation</code> columns accessible (<a class="ref" href="#sec:accessible_attributes">Section&nbsp;6.1.2.2</a>) so that we can instantiate new users with an initialization hash:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                 <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Following the model in <a class="ref" href="#code:attr_accessible">Listing&nbsp;6.6</a>, we do this by adding the appropriate symbols to the list of accessible attributes:</p>

<div class="code"><div class="highlight"><pre><span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
</pre></div>
</div>


<p>Second, we need presence and length validations for the password, the latter of which uses the <code>:minimum</code> key in analogy with the <code>:maximum</code> key from <a class="ref" href="#code:length_validation">Listing&nbsp;6.15</a>:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">minimum:</span> <span class="mi">6</span> <span class="p">}</span>
</pre></div>
</div>


<p>Next, we need to add <code>password</code> and <code>password_confirmation</code> attributes, require the presence of the password, require that they match, and add an <code>authenticate</code> method to compare an encrypted password to the <code>password_digest</code> to authenticate users. This is the only nontrivial step, and in the latest version of Rails all these features come for free with one method, <code>has_secure_password</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_secure_password</span>
</pre></div>
</div>


<p>As long as there is a <code>password_digest</code> column in the database, adding this one method to our model gives us a secure way to create and authenticate new users. (If <code>has_secure_password</code> seems a bit too magical for your taste, I suggest taking a look at <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb">the source code for <tt>secure_password.rb</tt></a>, which is well-documented and quite readable. You&rsquo;ll see that, among other things, it automatically includes a validation for the <code>password_digest</code> attribute. In <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, we&rsquo;ll see that this is a mixed blessing.)</p>

<p>Finally, we need a presence validation for the password confirmation:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>Putting these three elements together yields the User model shown in <a class="ref" href="#code:password_implementation">Listing&nbsp;6.30</a>, which completes the implementation of secure passwords.</p>

<div class="label" id="code:password_implementation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.30.</span> <span class="description">The complete implementation for secure passwords. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span>   <span class="kp">true</span><span class="p">,</span>
                    <span class="nb">format</span><span class="p">:</span>     <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="p">{</span> <span class="ss">case_sensitive:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">minimum:</span> <span class="mi">6</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You should confirm at this point that the test suite passes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:creating_a_user"></div>


<h3><a id="sec:6.3.5" href="#sec:creating_a_user" class="heading"><span class="number">6.3.5</span> Creating a user</a></h3>


<p>Now that the basic User model is complete, we&rsquo;ll create a user in the database as preparation for making a page to show the user&rsquo;s information in <a class="ref" href="#sec:showing_users">Section&nbsp;7.1</a>. This also gives us a chance to make the work from the previous sections feel more concrete; merely getting the test suite to pass may seem anti-climactic, and it will be gratifying to see an actual user record in the development database.</p>

<p>Since we can&rsquo;t yet sign up through the web&mdash;that&rsquo;s the goal of <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>&mdash;we&rsquo;ll use the Rails console to create a new user by hand. In contrast to <a class="ref" href="#sec:creating_user_objects">Section&nbsp;6.1.3</a>, in this section we&rsquo;ll take care <em>not</em> to start in a sandbox, since this time the whole point is to save a record to the database:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>            <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-07 03:38:14&quot;, updated_at: &quot;2011-12-07 03:38:14&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJgjlw0G4f21y...&quot;&gt; </span>
</pre></div>
</div>


<p>To check that this worked, let&rsquo;s look at the row in the development database (<code>db/development.sqlite3</code>) using the SQLite Database Browser (<a class="ref" href="#fig:sqlite_user_row">Figure&nbsp;6.6</a>). Note that the columns correspond to the attributes of the data model defined in <a class="ref" href="#fig:user_model_password_digest">Figure&nbsp;6.5</a>.</p>

<div class="label" id="fig:sqlite_user_row"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_user_row_with_password.png" alt="sqlite_user_row_with_password" /></span></div><div class="caption"><span class="header">Figure 6.6: </span><span class="description">A user row in the SQLite database <code>db/development.sqlite3</code>.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_user_row_with_password-full.png">(full size)</a></span></div></div>


<p>Returning to the console, we can see the effect of <code>has_secure_password</code> from <a class="ref" href="#code:password_implementation">Listing&nbsp;6.30</a> by looking at the <code>password_digest</code> attribute:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password_digest</span>
<span class="go">=&gt; &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJgjlw0G4f21yZIMSH/xoy&quot;</span>
</pre></div>
</div>


<p>This is the encrypted version of the password (<code>"foobar"</code>) used to initialize the user object. We can also verify that the <code>authenticate</code> command is working by first using an invalid password and then a valid one:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-07 03:38:14&quot;, updated_at: &quot;2011-12-07 03:38:14&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJgjlw0G4f21y...&quot;&gt; </span>
</pre></div>
</div>


<p>As required, <code>authenticate</code> returns <code>false</code> if the password is invalid and the user itself if the password is valid.</p>

<h2><a id="sec:6.4" href="#sec:6.4" class="heading"><span class="number">6.4</span> Conclusion</a></h2>


<p>Starting from scratch, in this chapter we created a working User model with <code>name</code>, <code>email</code>, and various password attributes, together with validations enforcing several important constraints on their values. In addition, we can securely authenticate users using a given password. In previous versions of Rails, such a feat would have taken more than twice as much code, but because of the compact <code>validates</code> method and <code>has_secure_password</code>, we were able to build a complete User model in only ten source lines of code.</p>

<p>In the next chapter, <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, we&rsquo;ll make a working signup form to create new users, together with a page to display each user&rsquo;s information. In <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>, we&rsquo;ll use the authentication machinery from <a class="ref" href="#sec:adding_a_secure_password">Section&nbsp;6.3</a> to let users sign into the site.</p>

<p>If you&rsquo;re using Git, now would be a good time to commit if you haven&rsquo;t done so in a while:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Make a basic User model (including secure passwords)&quot;</span>
</pre></div>
</div>


<p>Then merge back into the master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
</pre></div>
</div>


<h2><a id="sec:6.5" href="#sec:6.5" class="heading"><span class="number">6.5</span> Exercises</a></h2>




<ol>

<li>Add a test for the email downcasing from <a class="ref" href="#code:email_downcase">Listing&nbsp;6.23</a>, as shown in <a class="ref" href="#code:email_downcase_test">Listing&nbsp;6.31</a>. By commenting out the <code>before_save</code> line, verify that <a class="ref" href="#code:email_downcase_test">Listing&nbsp;6.31</a> tests the right thing.</li>

<li>By running the test suite, verify that the <code>before_save</code> callback can be written as shown in <a class="ref" href="#code:downcase_bang">Listing&nbsp;6.32</a>.</li>

<li>Read through the Rails API entry for <code>ActiveRecord::Base</code> to get a sense of its capabilities.</li>
<li>Study the entry in the Rails API for the <code>validates</code> method to learn more about its capabilities and options.</li>
<li>Spend a couple of hours playing with <a href="http://www.rubular.com/">Rubular</a>.</li>

</ol>




<div class="label" id="code:email_downcase_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.31.</span> <span class="description">A test for the email downcasing from <a class="ref" href="#code:email_downcase">Listing&nbsp;6.23</a>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;email address with mixed case&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:mixed_case_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Foo@ExAMPle.CoM&quot;</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should be saved as all lower-case&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">mixed_case_email</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">mixed_case_email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:downcase_bang"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.32.</span> <span class="description">An alternate implementation of the <code>before_save</code> callback. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase!</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<div class="footnotes">
<ol>
<li id="fn:6.1">The name comes from the &ldquo;<a href="http://en.wikipedia.org/wiki/Active_record_pattern">active record pattern</a>&rdquo;, identified and named in <em>Patterns of Enterprise Application Architecture</em> by Martin Fowler.&nbsp;<a class="arrow" href="#fnref:6.1">&uarr;</a></li>
<li id="fn:6.2">Pronounced &ldquo;ess-cue-ell&rdquo;, though the alternate pronunciation &ldquo;sequel&rdquo; is also common.&nbsp;<a class="arrow" href="#fnref:6.2">&uarr;</a></li>
<li id="fn:6.3">By using an email address as the username, we open the theoretical possibility of communicating with our users at a future date.&nbsp;<a class="arrow" href="#fnref:6.3">&uarr;</a></li>
<li id="fn:6.4">Don&rsquo;t worry about exactly how the <code>t</code>&nbsp;object manages to do this; the beauty of <em>abstraction layers</em> is that we don&rsquo;t have to know. We can just trust the <code>t</code>&nbsp;object to do its job.&nbsp;<a class="arrow" href="#fnref:6.4">&uarr;</a></li>
<li id="fn:6.5">Officially pronounced &ldquo;ess-cue-ell-ite&rdquo;, although the (mis)pronunciation &ldquo;sequel-ite&rdquo; is also common.&nbsp;<a class="arrow" href="#fnref:6.5">&uarr;</a></li>
<li id="fn:6.6">In case you&rsquo;re curious about <code>"2011-12-05 00:57:46"</code>, I&rsquo;m not writing this after midnight; the timestamps are recorded in <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordinated Universal Time</a> (UTC), which for most practical purposes is the same as <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time">Greenwich Mean Time</a>. From the <a href="http://tf.nist.gov/general/misc.htm">NIST Time and Frequency FAQ</a>:   <strong>Q:</strong> Why is UTC used as the acronym for Coordinated Universal Time instead of CUT? <strong>A:</strong> In 1970 the Coordinated Universal Time system was devised by an international advisory group of technical experts within the International Telecommunication Union (ITU). The ITU felt it was best to designate a single abbreviation for use in all languages in order to minimize confusion. Since unanimous agreement could not be achieved on using either the English word order, CUT, or the French word order, TUC, the acronym UTC was chosen as a compromise.&nbsp;<a class="arrow" href="#fnref:6.6">&uarr;</a></li>
<li id="fn:6.7">Note the value of <code>user.updated_at</code>. Told you the timestamp was in UTC.&nbsp;<a class="arrow" href="#fnref:6.7">&uarr;</a></li>
<li id="fn:6.8">Exceptions and exception handling are somewhat advanced Ruby subjects, and we won&rsquo;t need them much in this book. They are important, though, and I suggest learning about them using one of the Ruby books recommended in <a class="ref" href="#sec:comments_for_various_readers">Section&nbsp;1.1.1</a>.&nbsp;<a class="arrow" href="#fnref:6.8">&uarr;</a></li>
<li id="fn:6.9">I&rsquo;ll omit the output of console commands when they are not particularly instructive&mdash;for example, the results of <code>User.new</code>.&nbsp;<a class="arrow" href="#fnref:6.9">&uarr;</a></li>
<li id="fn:6.10">Note that, in <a class="ref" href="#table:valid_email_regex">Table&nbsp;6.1</a>, &ldquo;letter&rdquo; really means &ldquo;lower-case letter&rdquo;, but the <code>i</code> at the end of the regex enforces case-insensitive matching.&nbsp;<a class="arrow" href="#fnref:6.10">&uarr;</a></li>
<li id="fn:6.11">If you find it as useful as I do, I encourage you to <a href="http://bit.ly/donate-to-rubular">donate to Rubular</a> to reward developer <a href="http://lovitt.net/">Michael Lovitt</a> for his wonderful work.&nbsp;<a class="arrow" href="#fnref:6.11">&uarr;</a></li>
<li id="fn:6.12">Did you know that <code>"Michael Hartl"@example.com</code>, with quotation marks and a space in the middle, is a valid email address according to the standard? Incredibly, it is&mdash;but it&rsquo;s absurd. If you don&rsquo;t have an email address that contains only letters, numbers, underscores, and dots, then I recommend getting one. N.B. The regex in <a class="ref" href="#code:validates_format_of_email">Listing&nbsp;6.17</a> allows plus signs, too, because Gmail (and possibly other email services) does something useful with them: to filter email from example.com, you can use <tt>username+example@gmail.com</tt>, which will go to the Gmail address <tt>username@gmail.com</tt>, allowing you to filter on the string <tt>example</tt>.&nbsp;<a class="arrow" href="#fnref:6.12">&uarr;</a></li>
<li id="fn:6.13">As noted briefly in the introduction to this section, there is a dedicated test database, <code>db/test.sqlite3</code>, for this purpose.&nbsp;<a class="arrow" href="#fnref:6.13">&uarr;</a></li>
<li id="fn:6.14">Of course, we could just edit the migration file for the <code>users</code> table in <a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a> but that would require rolling back and then migrating back up. The Rails Way is to use migrations every time we discover that our data model needs to change.&nbsp;<a class="arrow" href="#fnref:6.14">&uarr;</a></li>
<li id="fn:6.15">Direct experimentation with SQLite on my system and PostgreSQL on Heroku show that this step is, in fact, necessary.&nbsp;<a class="arrow" href="#fnref:6.15">&uarr;</a></li>
<li id="fn:6.16">http://railstutorial.org/book?version=3.0&nbsp;<a class="arrow" href="#fnref:6.16">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:sign_up"></div>


<h1 class="chapter"><a id="sec:7" href="#cha:sign_up" class="heading"><span class="number">Chapter 7</span> Sign up</a></h1>


<p>Now that we have a working User model, it&rsquo;s time to add an ability few websites can live without: letting users sign up for the site. We&rsquo;ll use an HTML <em>form</em> to submit user signup information to our application in <a class="ref" href="#sec:signup_form">Section&nbsp;7.2</a>, which will then be used to create a new user and save its attributes to the database in <a class="ref" href="#sec:signup_success">Section&nbsp;7.4</a>. At the end of the signup process, it&rsquo;s important to render a profile page with the newly created user&rsquo;s information, so we&rsquo;ll begin by making a page for <em>showing</em> users, which will serve as the first step toward implementing the REST architecture for users (<a class="ref" href="#sec:mvc_in_action">Section&nbsp;2.2.2</a>). As usual, we&rsquo;ll write tests as we develop, extending the theme of using RSpec and Capybara to write succinct and expressive integration tests.</p>

<p>In order to make a user profile page, we need to have a user in the database, which introduces a chicken-and-egg problem: how can the site have a user before there is a working signup page? Happily, this problem has already been solved: in <a class="ref" href="#sec:creating_a_user">Section&nbsp;6.3.5</a>, we created a User record by hand using the Rails console. If you skipped that section, you should go there now and complete it before proceeding.</p>

<p>If you&rsquo;re following along with version control, make a topic branch as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b sign-up
</pre></div>
</div>


<div class="label" id="sec:showing_users"></div>


<h2><a id="sec:7.1" href="#sec:showing_users" class="heading"><span class="number">7.1</span> Showing users</a></h2>


<p>In this section, we&rsquo;ll take the first steps toward the final profile by making a page to display a user&rsquo;s name and profile photo, as indicated by the mockup in <a class="ref" href="#fig:profile_mockup_profile_name">Figure&nbsp;7.1</a>.<sup class="footnote" id="fnref:7.1"><a href="#fn:7.1">1</a></sup> Our eventual goal for the user profile pages is to show the user&rsquo;s profile image, basic user data, and a list of microposts, as mocked up in <a class="ref" href="#fig:profile_mockup">Figure&nbsp;7.2</a>.<sup class="footnote" id="fnref:7.2"><a href="#fn:7.2">2</a></sup> (<a class="ref" href="#fig:profile_mockup">Figure&nbsp;7.2</a> has our first example of <em>lorem ipsum</em> text, which has a <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">fascinating story</a> that you should definitely read about some time.) We&rsquo;ll complete this task, and with it the sample application, in <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>.</p>

<div class="label" id="fig:profile_mockup_profile_name"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_profile_name_bootstrap.png" alt="profile_mockup_profile_name_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.1: </span><span class="description">A mockup of the user profile made in this section.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup_profile_name_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_bootstrap.png" alt="profile_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.2: </span><span class="description">A mockup of our best guess at the final profile page.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:rails_environments"></div>


<h3><a id="sec:7.1.1" href="#sec:rails_environments" class="heading"><span class="number">7.1.1</span> Debug and Rails environments</a></h3>


<p>The profiles in this section will be the first truly dynamic pages in our application. Although the view will exist as a single page of code, each profile will be customized using information retrieved from the site&rsquo;s database. As preparation for adding dynamic pages to our sample application, now is a good time to add some debug information to our site layout (<a class="ref" href="#code:rails_debug">Listing&nbsp;7.1</a>). This displays some useful information about each page using the built-in <code>debug</code> method and <code>params</code> variable (which we&rsquo;ll learn more about in <a class="ref" href="#sec:a_users_resource">Section&nbsp;7.1.2</a>).</p>

<div class="label" id="code:rails_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.1.</span> <span class="description">Adding some debug information to the site layout. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>To make the debug output look nice, we&rsquo;ll add some rules to the custom stylesheet created in <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a>, as shown in <a class="ref" href="#code:mixin_and_debug">Listing&nbsp;7.2</a>.</p>

<div class="label" id="code:mixin_and_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.2.</span> <span class="description">Adding code for a pretty debug box, including a Sass mixin. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="k">@mixin</span><span class="nf"> box_sizing</span> <span class="p">{</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">miscellaneous</span> <span class="o">*/</span>

<span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">clear</span><span class="o">:</span> <span class="no">both</span><span class="p">;</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>This introduces the Sass <em>mixin</em> facility, in this case called <code>box_sizing</code>. A mixin allows a group of CSS rules to be packaged up and used for multiple elements, converting</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="o">@</span><span class="nt">include</span> <span class="nt">box_sizing</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>We&rsquo;ll put this mixin to use again in <a class="ref" href="#sec:using_form_for">Section&nbsp;7.2.2</a>. The result in the case of the debug box is shown in <a class="ref" href="#fig:home_page_with_debug_2nd_ed">Figure&nbsp;7.3</a>.</p>

<div class="label" id="fig:home_page_with_debug_2nd_ed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_debug_2nd_ed.png" alt="home_page_with_debug_2nd_ed" /></span></div><div class="caption"><span class="header">Figure 7.3: </span><span class="description">The sample application Home page (<a href="http://localhost:3000/">/</a>) with debug information.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_debug_2nd_ed-full.png">(full size)</a></span></div></div>


<p>The debug output in <a class="ref" href="#fig:home_page_with_debug_2nd_ed">Figure&nbsp;7.3</a> gives potentially useful information about the page being rendered:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static_pages</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">home</span>
</pre></div>
</div>


<p>This is a YAML<sup class="footnote" id="fnref:7.3"><a href="#fn:7.3">3</a></sup> representation of <code>params</code>, which is basically a hash, and in this case identifies the controller and action for the page. We&rsquo;ll see another example in <a class="ref" href="#sec:a_users_resource">Section&nbsp;7.1.2</a></p>

<p>Since we don&rsquo;t want to display debug information to users of a deployed application, <a class="ref" href="#code:rails_debug">Listing&nbsp;7.1</a> uses</p>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>


<p>to restrict the debug information to the <em>development environment</em>, which is one of three environments defined by default in Rails (<a class="ref" href="#sidebar:rails_environments">Box&nbsp;7.1</a>).<sup class="footnote" id="fnref:7.4"><a href="#fn:7.4">4</a></sup> In particular, <code>Rails.env.development?</code> is <code>true</code> only in a development environment, so the Embedded Ruby</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>won&rsquo;t be inserted into production applications or tests. (Inserting the debug information into tests probably wouldn&rsquo;t do any harm, but it probably wouldn&rsquo;t do any good, either, so it&rsquo;s best to restrict the debug display to development only.)</p>

<div class="label" id="sidebar:rails_environments"></div>


<div class="sidebar"><span class="title"><span class="header">Box 7.1.</span><span class="description">Rails environments</span></span>
<p>Rails comes equipped with three environments: <tt>test</tt>, <tt>development</tt>, and <tt>production</tt>. The default environment for the Rails console is <tt>development</tt>:</p>

<pre class="verbatim">  $ rails console 
  Loading development environment
  &gt;&gt; Rails.env
  =&gt; &quot;development&quot;
  &gt;&gt; Rails.env.development?
  =&gt; true
  &gt;&gt; Rails.env.test?
  =&gt; false</pre>


<p>As you can see, Rails provides a <tt>Rails</tt> object with an <tt>env</tt> attribute and associated environment boolean methods, so that, for example, <tt>Rails.env.test?</tt> returns <tt>true</tt> in a test environment and <tt>false</tt> otherwise.</p>

<p>If you ever need to run a console in a different environment (to debug a test, for example), you can pass the environment as a parameter to the <tt>console</tt> script:</p>

<pre class="verbatim">  $ rails console test
  Loading test environment
  &gt;&gt; Rails.env
  =&gt; &quot;test&quot;
  &gt;&gt; Rails.env.test?
  =&gt; true</pre>


<p>As with the console, <tt>development</tt> is the default environment for the local Rails server, but you can also run it in a different environment:</p>

<pre class="verbatim">  $ rails server --environment production</pre>


<p>If you view your app running in production, it won&rsquo;t work without a production database, which we can create by running <tt>rake db:migrate</tt> in production:</p>

<pre class="verbatim">  $ bundle exec rake db:migrate RAILS_ENV=production</pre>


<p>(I find it confusing that the console, server, and migrate commands specify non-default environments in three mutually incompatible ways, which is why I bothered showing all three.)</p>

<p>By the way, if you have deployed your sample app to Heroku, you can see its environment using the <tt>heroku</tt> command, which provides its own (remote) console:</p>

<pre class="verbatim">  $ heroku run console
  Ruby console for yourapp.herokuapp.com
  &gt;&gt; Rails.env
  =&gt; &quot;production&quot;
  &gt;&gt; Rails.env.production?
  =&gt; true</pre>


<p>Naturally, since Heroku is a platform for production sites, it runs each application in a production environment.</p>
</div>




<div class="label" id="sec:a_users_resource"></div>


<h3><a id="sec:7.1.2" href="#sec:a_users_resource" class="heading"><span class="number">7.1.2</span> A Users resource</a></h3>


<p>At the end of <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>, we created a new user in the database. As seen in <a class="ref" href="#sec:creating_a_user">Section&nbsp;6.3.5</a>, this user has id&nbsp;<code>1</code>, and our goal now is to make a page to display this user&rsquo;s information. We&rsquo;ll follow the conventions of the REST architecture favored in Rails applications (<a class="ref" href="#sidebar:REST">Box&nbsp;2.2</a>), which means representing data as <em>resources</em> that can be created, shown, updated, or destroyed&mdash;four actions corresponding to the four fundamental operations <tt>POST</tt>, <tt>GET</tt>, <tt>PUT</tt>, and <tt>DELETE</tt> defined by the <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP standard</a> (<a class="ref" href="#sidebar:get_etc">Box&nbsp;3.2</a>).</p>

<p>When following REST principles, resources are typically referenced using the resource name and a unique identifier. What this means in the context of users&mdash;which we&rsquo;re now thinking of as a Users <em>resource</em>&mdash;is that we should view the user with id&nbsp;<code>1</code> by issuing a <tt>GET</tt> request to the URI /users/1. Here the <code>show</code> action is <em>implicit</em> in the type of request&mdash;when Rails&rsquo; REST features are activated, <tt>GET</tt> requests are automatically handled by the <code>show</code> action.</p>

<p>We saw in <a class="ref" href="#sec:a_user_tour">Section&nbsp;2.2.1</a> that the page for a user with id&nbsp;<code>1</code> has URI /users/1. Unfortunately, visiting that URI right now just gives an error (<a class="ref" href="#fig:profile_routing_error">Figure&nbsp;7.4</a>).</p>

<div class="label" id="fig:profile_routing_error"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_routing_error.png" alt="profile_routing_error" /></span></div><div class="caption"><span class="header">Figure 7.4: </span><span class="description">The error page for /users/1.&nbsp;<a href="http://railstutorial.org/images/figures/profile_routing_error-full.png">(full size)</a></span></div></div>


<p>We can get the REST-style URI to work by adding a single line to our routes file (<code>config/routes.rb</code>):</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span>
</pre></div>
</div>


<p>The result appears in <a class="ref" href="#code:users_resource">Listing&nbsp;7.3</a>.</p>

<div class="label" id="code:users_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.3.</span> <span class="description">Adding a Users resource to the routes file. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>

  <span class="n">root</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You might have noticed that <a class="ref" href="#code:users_resource">Listing&nbsp;7.3</a> removes the line</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>
</pre></div>
</div>


<p>last seen in <a class="ref" href="#code:signup_route">Listing&nbsp;5.32</a>. This is because <code>resources :users</code> doesn&rsquo;t just add a working /users/1 URI; it endows our sample application with <em>all</em> the actions needed for a RESTful Users resource,<sup class="footnote" id="fnref:7.5"><a href="#fn:7.5">5</a></sup> along with a large number of named routes (<a class="ref" href="#sec:named_routes">Section&nbsp;5.3.3</a>) for generating user URIs. The resulting correspondence of URIs, actions, and named routes is shown in <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>. (Compare to <a class="ref" href="#table:demo_RESTful_users">Table&nbsp;2.2</a>.) Over the course of the next three chapters, we&rsquo;ll cover all of the other entries in <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a> as we fill in all the actions necessary to make Users a fully RESTful resource.</p>

<div class="label" id="table:RESTful_users"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Named route</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users</td><td class="align_left"><code>index</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">page to list all users</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>show</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">page to show user</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/new</td><td class="align_left"><code>new</code></td><td class="align_left"><code>new_user_path</code></td><td class="align_left">page to make a new user (signup)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/users</td><td class="align_left"><code>create</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">create a new user</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left"><code>edit_user_path(user)</code></td><td class="align_left">page to edit user with id <code>1</code></td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>update</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">update user</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>destroy</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">delete user</td></tr></table></div><div class="caption"><span class="header">Table 7.1: </span><span class="description">RESTful routes provided by the Users resource in <a class="ref" href="#code:users_resource">Listing&nbsp;7.3</a>.</span></div></div>


<p>With the code in <a class="ref" href="#code:users_resource">Listing&nbsp;7.3</a>, the routing works, but there&rsquo;s still no page there (<a class="ref" href="#fig:user_show_unknown_action_31">Figure&nbsp;7.5</a>). To fix this, we&rsquo;ll begin with a minimalist version of the profile page, which we&rsquo;ll flesh out in <a class="ref" href="#sec:a_gravatar_image">Section&nbsp;7.1.4</a>.</p>

<div class="label" id="fig:user_show_unknown_action_31"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_unknown_action_31.png" alt="user_show_unknown_action_31" /></span></div><div class="caption"><span class="header">Figure 7.5: </span><span class="description">The URI /users/1 with routing but no page.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_unknown_action_31-full.png">(full size)</a></span></div></div>


<p>We&rsquo;ll use the standard Rails location for showing a user, which is <code>app/views/users/show.html.erb</code>. Unlike the <code>new.html.erb</code> view, which we created with the generator in <a class="ref" href="#code:generate_users_controller">Listing&nbsp;5.28</a>, the <code>show.html.erb</code> file doesn&rsquo;t currently exist, so you&rsquo;ll have to create it by hand, filling it with the content shown in <a class="ref" href="#code:stub_user_view">Listing&nbsp;7.4</a>.</p>

<div class="label" id="code:stub_user_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.4.</span> <span class="description">A stub view for showing user information. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>This view uses Embedded Ruby to display the user&rsquo;s name and email address, assuming the existence of an instance variable called <code>@user</code>. Of course, eventually the real user show page will look very different, and won&rsquo;t display the email address publicly.</p>

<p>In order to get the user show view to work, we need to define an <code>@user</code> variable in the corresponding <code>show</code> action in the Users controller. As you might expect, we use the <code>find</code> method on the User model (<a class="ref" href="#sec:finding_user_objects">Section&nbsp;6.1.4</a>) to retrieve the user from the database, as shown in <a class="ref" href="#code:user_show_action">Listing&nbsp;7.5</a>.</p>

<div class="label" id="code:user_show_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.5.</span> <span class="description">The Users controller with a <code>show</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we&rsquo;ve used <code>params</code> to retrieve the user&nbsp;id. When we make the appropriate request to the Users controller, <code>params[:id]</code> will be the user id&nbsp;<tt>1</tt>, so the effect is the same as the <code>find</code> method</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>we saw in <a class="ref" href="#sec:finding_user_objects">Section&nbsp;6.1.4</a>. (Technically, <code>params[:id]</code> is the string&nbsp;<code>"1"</code>, but <code>find</code> is smart enough to convert this to an integer.)</p>

<p>With the user view and action defined, the URI <a href="http://localhost:3000/users/1">/users/1</a> works perfectly (<a class="ref" href="#fig:user_show_rails_3">Figure&nbsp;7.6</a>). Note that the debug information in <a class="ref" href="#fig:user_show_rails_3">Figure&nbsp;7.6</a> confirms the value of <code>params[:id]</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&#39;1&#39;</span>
</pre></div>
</div>


<p>This is why the code</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>in <a class="ref" href="#code:user_show_action">Listing&nbsp;7.5</a> finds the user with id&nbsp;<tt>1</tt>.</p>

<div class="label" id="fig:user_show_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_bootstrap.png" alt="user_show_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.6: </span><span class="description">The user show page at <a href="http://localhost:3000/users/1">/users/1</a> after adding a Users resource.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:tests_with_factories"></div>


<h3><a id="sec:7.1.3" href="#sec:tests_with_factories" class="heading"><span class="number">7.1.3</span> Testing the user show page (with factories)</a></h3>


<p>Now that we have a minimal working profile, it&rsquo;s time to start working on the version mocked up in <a class="ref" href="#fig:profile_mockup_profile_name">Figure&nbsp;7.1</a>. As with the creation of static pages (<a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>) and the User model (<a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>), we&rsquo;ll proceed using test-driven development.</p>

<p>Recall from <a class="ref" href="#sec:signup_url">Section&nbsp;5.4.2</a> that we have elected to use integration tests for the pages associated with the Users resource. In the case of the signup page, our test first visits the <code>signup_path</code> and then checks for the right <code>h1</code> and <code>title</code> tags, as seen in <a class="ref" href="#code:user_pages_spec">Listing&nbsp;5.31</a> and reproduced in <a class="ref" href="#code:initial_signup_test">Listing&nbsp;7.6</a>. (Note that we&rsquo;ve omitted the <code>full_title</code> helper from <a class="ref" href="#sec:pretty_rspec">Section&nbsp;5.3.4</a> since the full title is already adequately tested there.)</p>

<div class="label" id="code:initial_signup_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.6.</span> <span class="description">A recap of the initial User pages spec. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signup page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To test the user show page, we&rsquo;ll need a User model object so that the code in the <code>show</code> action (<a class="ref" href="#code:user_show_action">Listing&nbsp;7.5</a>) has something to find:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
  <span class="c1"># Code to make a user variable</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>where we need to fill in the comment with the appropriate code. This uses the <code>user_path</code> named route (<a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>) to generate the path to the show page for the given user. It then tests that the <code>h1</code> and <code>title</code> tags both contain the user&rsquo;s name.</p>

<p>In order to make the necessary User model object, we could use Active Record to create a user with <code>User.create</code>, but experience shows that user <em>factories</em> are a more convenient way to define user objects and insert them in the database. We&rsquo;ll be using the factories generated by <a href="http://github.com/thoughtbot/factory_girl">Factory Girl</a>,<sup class="footnote" id="fnref:7.6"><a href="#fn:7.6">6</a></sup> a Ruby gem produced by the good people at <a href="http://thoughtbot.com/">thoughtbot</a>. As with RSpec, Factory Girl defines a domain-specific language in Ruby, in this case specialized for defining Active Record objects. The syntax is simple, relying on Ruby blocks and custom methods to define the attributes of the desired object. For cases such as the one in this chapter, the advantage over Active Record may not be obvious, but we&rsquo;ll use more advanced features of factories in future chapters. For example, in <a class="ref" href="#sec:pagination">Section&nbsp;9.3.3</a> it will be important to create a sequence of users with unique email addresses, and factories make it easy to do this.</p>

<p>As with other Ruby gems, we can install Factory Girl by adding a line to the <code>Gemfile</code> used by Bundler (<a class="ref" href="#code:gemfile_factory_girl">Listing&nbsp;7.7</a>). (Since Factory Girl is only needed in the tests, we&rsquo;ve put it in the <code>:test</code> group.)</p>

<div class="label" id="code:gemfile_factory_girl"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.7.</span> <span class="description">Adding Factory Girl to the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.4.0&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span> 
</pre></div>
</div></div>


<p>Then install as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>We&rsquo;ll put all our Factory Girl factories in the file <code>spec/factories.rb</code>, which automatically gets loaded by RSpec. The code needed to make a User factory appears in <a class="ref" href="#code:user_factory">Listing&nbsp;7.8</a>.</p>

<div class="label" id="code:user_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.8.</span> <span class="description">A factory to simulate User model objects. <br /> <code>spec/factories.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">&quot;Michael Hartl&quot;</span>
    <span class="n">email</span>    <span class="s2">&quot;michael@example.com&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By passing the symbol <code>:user</code> to the <code>factory</code> command, we tell Factory Girl that the subsequent definition is for a User model object.</p>

<p>With the definition in <a class="ref" href="#code:user_factory">Listing&nbsp;7.8</a>, we can create a User factory in the tests using the <code>let</code> command (<a class="ref" href="#sidebar:let">Box&nbsp;6.3</a>) and the <code>FactoryGirl</code> method supplied by Factory Girl:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>The final result appears in <a class="ref" href="#code:user_show_page_test">Listing&nbsp;7.9</a>.</p>

<div class="label" id="code:user_show_page_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.9.</span> <span class="description">A test for the user show page. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You should verify at this point that the test suite is red:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>We can get the tests to green with the code in <a class="ref" href="#code:name_title_and_heading">Listing&nbsp;7.10</a>.</p>

<div class="label" id="code:name_title_and_heading"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.10.</span> <span class="description">Adding a title and heading for the user profile page. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>Running the tests again should confirm that the test in <a class="ref" href="#code:user_show_page_test">Listing&nbsp;7.9</a> is passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>One thing you will quickly notice when running tests with Factory Girl is that they are <em>slow</em>. The reason is not Factory Girl&rsquo;s fault, and in fact it is a <em>feature</em>, not a bug. The issue is that the BCrypt algorithm used in <a class="ref" href="#sec:an_encrypted_password">Section&nbsp;6.3.1</a> to create a secure password hash is slow by design: BCrypt&rsquo;s slow speed is part of what makes it so hard to attack. Unfortunately, this means that creating users can bog down the test suite; happily, there is an easy fix. BCrypt uses a <em>cost factor</em> to control how computationally costly it is to create the secure hash. The default value is designed for security, not for speed, which is perfect for production applications, but in tests our needs are reversed: we want <em>fast</em> tests, and don&rsquo;t care at all about the security of the test users&rsquo; password hashes. The solution is to add a few lines to the test configuration file, <code>config/environments/test.rb</code>, redefining the cost factor from its secure default value to its fast minimum value, as shown in <a class="ref" href="#code:test_bcrypt_cost_factor">Listing&nbsp;7.11</a>. Even for a small test suite, the gains in speed from this step can be considerable, and I strongly recommend including <a class="ref" href="#code:test_bcrypt_cost_factor">Listing&nbsp;7.11</a> in your <code>test.rb</code>.</p>

<div class="label" id="code:test_bcrypt_cost_factor"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.11.</span> <span class="description">Redefining the BCrypt cost factor in a test environment. <br /> <code>config/environments/test.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Speed up tests by lowering BCrypt&#39;s cost function.</span>
  <span class="nb">require</span> <span class="s1">&#39;bcrypt&#39;</span>
  <span class="n">silence_warnings</span> <span class="k">do</span>
    <span class="ss">BCrypt::Engine</span><span class="o">::</span><span class="no">DEFAULT_COST</span> <span class="o">=</span> <span class="ss">BCrypt::Engine</span><span class="o">::</span><span class="no">MIN_COST</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:a_gravatar_image"></div>


<h3><a id="sec:7.1.4" href="#sec:a_gravatar_image" class="heading"><span class="number">7.1.4</span> A Gravatar image and a sidebar</a></h3>


<p>Having defined a basic user page in the previous section, we&rsquo;ll now flesh it out a little with a profile image for each user and the first cut of the user sidebar. When making views, we&rsquo;ll focus on the visual appearance and not worry too much about the exact structure of the page, which means that (at least for now) we won&rsquo;t be writing tests. When we come to more error-prone aspects of view, such as pagination (<a class="ref" href="#sec:pagination">Section&nbsp;9.3.3</a>), we&rsquo;ll resume test-driven development.</p>

<p>We&rsquo;ll start by adding a &ldquo;globally recognized avatar&rdquo;, or <a href="http://gravatar.com/">Gravatar</a>, to the user profile.<sup class="footnote" id="fnref:7.7"><a href="#fn:7.7">7</a></sup> Originally created by Tom Preston-Werner (cofounder of <a href="http://github.com/">GitHub</a>) and later acquired by <a href="http://automattic.com/">Automattic</a> (the makers of <a href="http://wordpress.com/">WordPress</a>), Gravatar is a free service that allows users to upload images and associate them with email addresses they control. Gravatars are a convenient way to include user profile images without going through the trouble of managing image upload, cropping, and storage; all we need to do is construct the proper Gravatar image URI using the user&rsquo;s email address and the corresponding Gravatar image will automatically appear.<sup class="footnote" id="fnref:7.8"><a href="#fn:7.8">8</a></sup></p>

<p>Our plan is to define a <code>gravatar_for</code> helper function to return a Gravatar image for a given user, as shown in <a class="ref" href="#code:user_show_view_with_gravatar">Listing&nbsp;7.12</a>.</p>

<div class="label" id="code:user_show_view_with_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.12.</span> <span class="description">The user show view with name and Gravatar. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>You can verify at this point that the test suite is failing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Because the <code>gravatar_for</code> method is undefined, the user show view is currently broken. (Catching errors of this nature is perhaps the most useful aspect of view specs. This is why having <em>some</em> test of the view, even a minimalist one, is so important.)</p>

<p>By default, methods defined in any helper file are automatically available in any view, but for convenience we&rsquo;ll put the <code>gravatar_for</code> method in the file for helpers associated with the Users controller. As <a href="http://en.gravatar.com/site/implement/hash/">noted at the Gravatar home page</a>, Gravatar URIs are based on an <a href="http://en.wikipedia.org/wiki/MD5">MD5 hash</a> of the user&rsquo;s email address. In Ruby, the MD5 hashing algorithm is implemented using the <code>hexdigest</code> method, which is part of the <code>Digest</code> library:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;MHARTL@example.COM&quot;</span><span class="o">.</span>
<span class="gp">&gt;&gt; </span><span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
<span class="go">=&gt; &quot;1fda4469bcbec3badf5418269ffc5968&quot; </span>
</pre></div>
</div>


<p>Since email addresses are case-insensitive (<a class="ref" href="#sec:format_validation">Section&nbsp;6.2.4</a>) but MD5 hashes are not, we&rsquo;ve used the <code>downcase</code> method to ensure that the argument to <code>hexdigest</code> is all lower-case. The resulting <code>gravatar_for</code> helper appears in  <a class="ref" href="#code:gravatar_for_helper">Listing&nbsp;7.13</a>.</p>

<div class="label" id="code:gravatar_for_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.13.</span> <span class="description">Defining a <code>gravatar_for</code> helper method. <br /> <code>app/helpers/users_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:gravatar_for_helper">Listing&nbsp;7.13</a> returns an image tag for the Gravatar with a <code>"gravatar"</code> class and alt text equal to the user&rsquo;s name (which is especially convenient for sight-impaired browsers using a screen reader). You can confirm that the test suite is now passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>The profile page appears as in <a class="ref" href="#fig:profile_with_gravatar">Figure&nbsp;7.7</a>, which shows the default Gravatar image, which appears because <code>user@example.com</code> is an invalid email address (the <a href="http://example.com/">example.com</a> domain is reserved for examples).</p>

<div class="label" id="fig:profile_with_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_with_gravatar_bootstrap.png" alt="profile_with_gravatar_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.7: </span><span class="description">The user profile page  <a href="http://localhost:3000/users/1">/users/1</a> with the default Gravatar.&nbsp;<a href="http://railstutorial.org/images/figures/profile_with_gravatar_bootstrap-full.png">(full size)</a></span></div></div>


<p>To get our application to display a custom Gravatar, we&rsquo;ll use <code>update_attributes</code> (<a class="ref" href="#sec:updating_user_objects">Section&nbsp;6.1.5</a>) to update the user in the database:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Here we&rsquo;ve assigned the user the email address <code>example@railstutorial.org</code>, which I&rsquo;ve associated with the Rails Tutorial logo, as seen in <a class="ref" href="#fig:profile_custom_gravatar">Figure&nbsp;7.8</a>.</p>

<div class="label" id="fig:profile_custom_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_custom_gravatar_bootstrap.png" alt="profile_custom_gravatar_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.8: </span><span class="description">The user show page with a custom Gravatar.&nbsp;<a href="http://railstutorial.org/images/figures/profile_custom_gravatar_bootstrap-full.png">(full size)</a></span></div></div>


<p>The last element needed to complete the mockup from <a class="ref" href="#fig:profile_mockup_profile_name">Figure&nbsp;7.1</a> is the initial version of the user sidebar. We&rsquo;ll implement it using the <code>aside</code> tag, which is used for content (such as sidebars) that complements the rest of the page but can also stand alone. We include <code>row</code> and <code>span4</code> classes, which are both part of Bootstrap. The code for the modified user show page appears in <a class="ref" href="#code:user_show_with_sidebar">Listing&nbsp;7.14</a>.</p>

<div class="label" id="code:user_show_with_sidebar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.14.</span> <span class="description">Adding a sidebar to the user <code>show</code> view. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>With the HTML elements and CSS classes in place, we can style the profile page (including the sidebar and the Gravatar) with the SCSS shown in <a class="ref" href="#code:sidebar_css">Listing&nbsp;7.15</a>. (Note the nesting of the table CSS rules, which works only because of the Sass engine used by the asset pipeline.) The resulting page is shown in <a class="ref" href="#fig:user_show_sidebar_css">Figure&nbsp;7.9</a>.</p>

<div class="label" id="code:sidebar_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.15.</span> <span class="description">SCSS for styling the user show page, including the sidebar. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">section</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">span</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.6</span><span class="kt">em</span><span class="p">;</span>
      <span class="na">text-align</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_sidebar_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_sidebar_css_bootstrap.png" alt="user_show_sidebar_css_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.9: </span><span class="description">The user show page  <a href="http://localhost:3000/users/1">/users/1</a> with a sidebar and CSS.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_sidebar_css_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:signup_form"></div>


<h2><a id="sec:7.2" href="#sec:signup_form" class="heading"><span class="number">7.2</span> Signup form</a></h2>


<p>Now that we have a working (though not yet complete) user profile page, we&rsquo;re ready to make a signup form for our site. We saw in <a class="ref" href="#fig:new_signup_page">Figure&nbsp;5.9</a> (shown again in <a class="ref" href="#fig:blank_signup_page_recap">Figure&nbsp;7.10</a>) that the signup page is currently blank: useless for signing up new users. The goal of this section is to start changing this sad state of affairs by producing the signup form mocked up in <a class="ref" href="#fig:signup_mockup">Figure&nbsp;7.11</a>.</p>

<div class="label" id="fig:blank_signup_page_recap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_signup_page_bootstrap.png" alt="new_signup_page_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.10: </span><span class="description">The current state of the signup page  <a href="http://localhost:3000/signup">/signup</a>.&nbsp;<a href="http://railstutorial.org/images/figures/new_signup_page_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:signup_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_mockup_bootstrap.png" alt="signup_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.11: </span><span class="description">A mockup of the user signup page.&nbsp;<a href="http://railstutorial.org/images/figures/signup_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>Since we&rsquo;re about to add the ability to create new users through the web, let&rsquo;s remove the user created at the console in <a class="ref" href="#sec:creating_a_user">Section&nbsp;6.3.5</a>. The cleanest way to do this is to reset the database with the <code>db:reset</code> Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
</pre></div>
</div>


<p>After resetting the database, on some systems the test database needs to be re-prepared as well:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>Finally, on some systems you might have to restart the web server for the changes to take effect.<sup class="footnote" id="fnref:7.9"><a href="#fn:7.9">9</a></sup></p>

<div class="label" id="sec:tests_for_user_signup"></div>


<h3><a id="sec:7.2.1" href="#sec:tests_for_user_signup" class="heading"><span class="number">7.2.1</span> Tests for user signup</a></h3>


<p>In the days before powerful web frameworks with full testing capabilities, testing was often painful and error-prone. For example, to test a signup page manually, we would have to visit the page in a browser and then submit alternately invalid and valid data, verifying in each case that the application&rsquo;s behavior was correct. Moreover, we would have to remember to repeat the process any time the application changed. With RSpec and Capybara, we will be able to write expressive tests to automate tasks that used to have to be done by hand.</p>

<p>We&rsquo;ve already seen how Capybara supports an intuitive web-navigation syntax. So far, we&rsquo;ve mostly used <code>visit</code> to visit particular pages, but Capybara can do a lot more, including filling in the kind of fields we see in <a class="ref" href="#fig:signup_mockup">Figure&nbsp;7.11</a> and clicking on the button. The syntax looks like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>Our goal now is to write tests for the right behavior given invalid and valid signup information. Because these tests are fairly advanced, we&rsquo;ll build them up piece by piece. If you want to see how they work (including which file to put them in), you can skip ahead to <a class="ref" href="#code:basic_signup_tests">Listing&nbsp;7.16</a>.</p>

<p>Our first task is to test for a failing signup form, and we can simulate the submission of invalid data by visiting the page and clicking the button using <code>click_button</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>This is equivalent to visiting the signup page and submitting blank signup information (which is invalid). Similarly, to simulate the submission of valid data, we fill in valid information using <code>fill_in</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>The purpose of our tests is to verify that clicking the signup button results in the correct behavior, creating a new user when the information is valid and not creating a user when it&rsquo;s invalid. The way to do this is to check the <em>count</em> of users, and under the hood our tests will use the <code>count</code> method available on every Active Record class, including <code>User</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>Here <code>User.count</code> is <code>0</code> because we reset the database at the beginning of this section.</p>

<p>When submitting invalid data, we expect the user count not to change; when submitting valid data, we expect it to change by 1. We can express this in RSpec by combining the <code>expect</code> method with either the <code>to</code> method or the <code>not_to</code> method. We&rsquo;ll start with the invalid case since it is simpler; we visit the signup path and click the button, and we expect it <em>not to</em> change the user count:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>Note that, as indicated by the curly braces, <code>expect</code> wraps <code>click_button</code> in a block (<a class="ref" href="#sec:blocks">Section&nbsp;4.3.2</a>). This is for the benefit of the <code>change</code> method, which takes as arguments an object and a symbol and then calculates the result of calling that symbol as a method on the object both before and after the block. In other words, the code</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>calculates</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>before and after the execution of</p>

<div class="code"><div class="highlight"><pre><span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>In the present case, we want the given code <em>not</em> to change the count, which we express using the <code>not_to</code> method. In effect, by enclosing the button click in a block we are able to replace</p>

<div class="code"><div class="highlight"><pre><span class="n">initial</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="n">final</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">initial</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">final</span>
</pre></div>
</div>


<p>with the single line</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>which reads like natural language and is much more compact.</p>

<p>The case of valid data is similar, but instead of verifying that the user count doesn&rsquo;t change, we check that clicking the button changes the count by 1:</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">expect</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>This uses the <code>to</code> method because we expect a click on the signup button with valid data <em>to</em> change the user count by one.</p>

<p>Combining the two cases with the appropriate <code>describe</code> blocks and pulling the common code into <code>before</code> blocks yields good basic tests for signing up users, as shown in <a class="ref" href="#code:basic_signup_tests">Listing&nbsp;7.16</a>. Here we&rsquo;ve factored out the common text for the submit button using the <code>let</code> method to define a <code>submit</code> variable.</p>

<div class="label" id="code:basic_signup_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.16.</span> <span class="description">Good basic tests for signing up users. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:submit</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;should not create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;ll add a few more tests as needed in the sections that follow, but the basic tests in <a class="ref" href="#code:basic_signup_tests">Listing&nbsp;7.16</a> already cover an impressive amount of functionality. To get them to pass, we have to create a signup page with just the right elements, arrange for the page&rsquo;s submission to be routed to the right place, and successfully create a new user in the database only if the resulting user data is valid.</p>

<p>Of course, at this point the tests should fail:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:using_form_for"></div>


<h3><a id="sec:7.2.2" href="#sec:using_form_for" class="heading"><span class="number">7.2.2</span> Using <tt>form_for</tt></a></h3>


<p>Now that we have good failing tests for user signup, we&rsquo;ll start getting them to pass by making a <em>form</em> for signing up users. We can accomplish this in Rails with the <code>form_for</code> helper method, which takes in an Active Record object and constructs a form using the object&rsquo;s attributes. The result appears in <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a>. (Readers familiar with Rails&nbsp;2.x should note that <code>form_for</code> uses the &ldquo;percent-equals&rdquo; ERb syntax for inserting content; that is, where Rails&nbsp;2.x used <tt class="verb">&lt;% form_for ... %&gt;</tt>, Rails&nbsp;3 uses <tt class="verb">&lt;%= form_for ... %&gt;</tt> instead.)</p>

<div class="label" id="code:signup_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.17.</span> <span class="description">A form to sign up new users. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Create my account&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Let&rsquo;s break this down into pieces. The presence of the <code>do</code> keyword indicates that <code>form_for</code> takes a block with one variable, which we&rsquo;ve called <code>f</code> for &ldquo;form&rdquo;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>As is usually the case with Rails helpers, we don&rsquo;t need to know any details about the implementation, but what we <em>do</em> need to know is what the <code>f</code> object does: when called with a method corresponding to an <a href="http://www.w3schools.com/html/html_forms.asp">HTML form element</a>&mdash;such as a text field, radio button, or password field&mdash;it returns code for that element specifically designed to set an attribute of the <code>@user</code> object. In other words,</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>creates the HTML needed to make a labeled text field element appropriate for setting the <code>name</code> attribute of a User model. (We&rsquo;ll take a look at the HTML itself in <a class="ref" href="#sec:the_form_html">Section&nbsp;7.2.3</a>.)</p>

<p>To see this in action, we need to drill down and look at the actual HTML produced by this form, but here we have a problem: the page currently breaks, because we have not set the <code>@user</code> variable&mdash;like all undefined instance variables (<a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>), <code>@user</code> is currently <code>nil</code>. Appropriately, if you run your test suite at this point, you&rsquo;ll see that the tests for the structure of the signup page from <a class="ref" href="#code:initial_signup_test">Listing&nbsp;7.6</a> (i.e., the <code>h1</code> and the <code>title</code>) now fail:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>(The <code>-e</code> here arranges to run just the examples whose description strings match <code>"signup page"</code>. Note in particular that this is <em>not</em> the substring <code>"signup"</code>, which would run all the test in <a class="ref" href="#code:basic_signup_tests">Listing&nbsp;7.16</a>.) To get these tests to pass again and to get our form to render, we must define an <code>@user</code> variable in the controller action corresponding to <code>new.html.erb</code>, i.e., the <code>new</code> action in the Users controller. The <code>form_for</code> helper expects <code>@user</code> to be a User object, and since we&rsquo;re creating a <em>new</em> user we simply use <code>User.new</code>, as seen in <a class="ref" href="#code:new_action_with_user">Listing&nbsp;7.18</a>.</p>

<div class="label" id="code:new_action_with_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.18.</span> <span class="description">Adding an <code>@user</code> variable to the <code>new</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the <code>@user</code> variable so defined, the test for the signup page should be passing again:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>At this point, the form (with the styling from <a class="ref" href="#code:form_css">Listing&nbsp;7.19</a>) appears as in <a class="ref" href="#fig:signup_form">Figure&nbsp;7.12</a>. Note the reuse of the <code>box_sizing</code> mixin from <a class="ref" href="#code:mixin_and_debug">Listing&nbsp;7.2</a>.</p>

<div class="label" id="code:form_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.19.</span> <span class="description">CSS for the signup form. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>

<span class="nt">input</span><span class="o">,</span> <span class="nt">textarea</span><span class="o">,</span> <span class="nt">select</span><span class="o">,</span> <span class="nc">.uneditable-input</span> <span class="p">{</span>
  <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#bbb</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">height</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_form_bootstrap.png" alt="signup_form_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.12: </span><span class="description">The signup form  <a href="http://localhost:3000/signup">/signup</a> for new users.&nbsp;<a href="http://railstutorial.org/images/figures/signup_form_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:the_form_html"></div>


<h3><a id="sec:7.2.3" href="#sec:the_form_html" class="heading"><span class="number">7.2.3</span> The form HTML</a></h3>


<p>As indicated by <a class="ref" href="#fig:signup_form">Figure&nbsp;7.12</a>, the signup page now renders properly, indicating that the <code>form_for</code> code in <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a> is producing valid HTML. If you look at the HTML for the generated form (using either <a href="http://getfirebug.com/">Firebug</a> or the &ldquo;view page source&rdquo; feature of your browser), you should see markup as in <a class="ref" href="#code:signup_form_html">Listing&nbsp;7.20</a>. Although many of the details are irrelevant for our purposes, let&rsquo;s take a moment to highlight the most important parts of its structure.</p>

<div class="label" id="code:signup_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.20.</span> <span class="description">The HTML for the form in <a class="ref" href="#fig:signup_form">Figure&nbsp;7.12</a>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span>
      <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span>
         <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password_confirmation&quot;</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password_confirmation&quot;</span> 
         <span class="na">name=</span><span class="s">&quot;user[password_confirmation]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> 
         <span class="na">value=</span><span class="s">&quot;Create my account&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span> 
</pre></div>
</div></div>


<p>(Here I&rsquo;ve omitted some HTML related to the <em>authenticity token</em>, which Rails automatically includes to thwart a particular kind of attack called a <em>cross-site request forgery</em> (CSRF). See <a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token">the Stack Overflow entry on the Rails authenticity token</a> if you&rsquo;re interested in the details of how this works and why it&rsquo;s important.)</p>

<p>We&rsquo;ll start with the internal structure of the document. Comparing <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a> with <a class="ref" href="#code:signup_form_html">Listing&nbsp;7.20</a>, we see that the Embedded Ruby</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>produces the HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>produces the HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>As seen in <a class="ref" href="#fig:filled_in_form">Figure&nbsp;7.13</a>, text fields (<code>type="text"</code>) simply display their contents, whereas password fields (<code>type="password"</code>) obscure the input for security purposes, as seen in <a class="ref" href="#fig:filled_in_form">Figure&nbsp;7.13</a>.</p>

<div class="label" id="fig:filled_in_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/filled_in_form_bootstrap.png" alt="filled_in_form_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.13: </span><span class="description">A filled-in form with <code>text</code> and <code>password</code> fields.&nbsp;<a href="http://railstutorial.org/images/figures/filled_in_form_bootstrap-full.png">(full size)</a></span></div></div>


<p>As we&rsquo;ll see in <a class="ref" href="#sec:signup_success">Section&nbsp;7.4</a>, the key to creating a user is the special <code>name</code> attribute in each <code>input</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>These <code>name</code> values allow Rails to construct an initialization hash (via the <code>params</code> variable) for creating users using the values entered by the user, as we&rsquo;ll see in <a class="ref" href="#sec:signup_failure">Section&nbsp;7.3</a>.</p>

<p>The second important element is the <code>form</code> tag itself. Rails creates the <code>form</code> tag using the <code>@user</code> object: because every Ruby object knows its own class (<a class="ref" href="#sec:constructors">Section&nbsp;4.4.1</a>), Rails figures out that <code>@user</code> is of class <code>User</code>; moreover, since <code>@user</code> is a <em>new</em> user, Rails knows to construct a form with the <code>post</code> method, which is the proper verb for creating a new object (<a class="ref" href="#sidebar:get_etc">Box&nbsp;3.2</a>):</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>Here the <code>class</code> and <code>id</code> attributes are largely irrelevant; what&rsquo;s important is <code>action="/users"</code> and <code>method="post"</code>. Together, these constitute instructions to issue an HTTP <tt>POST</tt> request to the /users URI. We&rsquo;ll see in the next two sections what effects this has.</p>

<div class="label" id="sec:signup_failure"></div>


<h2><a id="sec:7.3" href="#sec:signup_failure" class="heading"><span class="number">7.3</span> Signup failure</a></h2>


<p>Although we&rsquo;ve briefly examined the HTML for the form in <a class="ref" href="#fig:signup_form">Figure&nbsp;7.12</a> (shown in <a class="ref" href="#code:signup_form_html">Listing&nbsp;7.20</a>), it&rsquo;s best understood in the context of <em>signup failure</em>. In this section, we&rsquo;ll create a signup form that accepts an invalid submission and re-renders the signup page with a list of errors, as mocked up in <a class="ref" href="#fig:signup_failure_mockup">Figure&nbsp;7.14</a>.</p>

<div class="label" id="fig:signup_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_mockup_bootstrap.png" alt="signup_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.14: </span><span class="description">A mockup of the signup failure page.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:a_working_form"></div>


<h3><a id="sec:7.3.1" href="#sec:a_working_form" class="heading"><span class="number">7.3.1</span> A working form</a></h3>


<p>Our first step is to eliminate the error that currently results when submitting the signup form, as you can verify in your browser or by running the test for signup with invalid information:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>


<p>Recall from <a class="ref" href="#sec:a_users_resource">Section&nbsp;7.1.2</a> that adding <code>resources :users</code> to the <code>routes.rb</code> file (<a class="ref" href="#code:users_resource">Listing&nbsp;7.3</a>) automatically ensures that our Rails application responds to the RESTful URIs from <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>. In particular, it ensures that a <tt>POST</tt> request to /users is handled by the <code>create</code> action. Our strategy for the <code>create</code> action is to use the form submission to make a new user object using <code>User.new</code>, try (and fail) to save that user, and then render the signup page for possible resubmission. Let&rsquo;s get started by reviewing the code for the signup form:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>As noted in <a class="ref" href="#sec:the_form_html">Section&nbsp;7.2.3</a>, this HTML issues a <tt>POST</tt> request to the /users URI.</p>

<p>We can get the test for invalid information from <a class="ref" href="#code:basic_signup_tests">Listing&nbsp;7.16</a> to pass with the code in <a class="ref" href="#code:first_create_action">Listing&nbsp;7.21</a>. This listing includes a second use of the <code>render</code> method, which we first saw in the context of partials (<a class="ref" href="#sec:partials">Section&nbsp;5.1.3</a>); as you can see, <code>render</code> works in controller actions as well. Note that we&rsquo;ve taken this opportunity to introduce an <code>if</code>-<code>else</code> branching structure, which allows us to handle the cases of failure and success separately based on the value of <code>@user.save</code>, which (as we saw in <a class="ref" href="#sec:creating_user_objects">Section&nbsp;6.1.3</a>) is either <code>true</code> or <code>false</code> depending on whether the save succeeds.</p>

<div class="label" id="code:first_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.21.</span> <span class="description">A <code>create</code> action that can handle signup failure (but not success). <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The best way to understand how the code in <a class="ref" href="#code:first_create_action">Listing&nbsp;7.21</a> works is to <em>submit</em> the form with some invalid signup data; the result appears in <a class="ref" href="#fig:signup_failure_rails_3">Figure&nbsp;7.15</a>, and the full debug information appears in <a class="ref" href="#fig:signup_failure_rails_3_bootstrap_debug">Figure&nbsp;7.16</a>.</p>

<div class="label" id="fig:signup_failure_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3_bootstrap.png" alt="signup_failure_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.15: </span><span class="description">Signup failure.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_rails_3_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:signup_failure_rails_3_bootstrap_debug"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3_bootstrap_debug.png" alt="signup_failure_rails_3_bootstrap_debug" /></span></div><div class="caption"><span class="header">Figure 7.16: </span><span class="description">Signup failure debug information.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_rails_3_bootstrap_debug-full.png">(full size)</a></span></div></div>


<p>To get a clearer picture of how Rails handles the submission, let&rsquo;s take a closer look at the <code>params</code> hash from the debug information (<a class="ref" href="#fig:signup_failure_rails_3_bootstrap_debug">Figure&nbsp;7.16</a>):</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Foo Bar</span>
  <span class="l-Scalar-Plain">password_confirmation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bar</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo@invalid</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create my account</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
</pre></div>
</div>


<p>We saw starting in <a class="ref" href="#sec:a_users_resource">Section&nbsp;7.1.2</a> that the <code>params</code> hash contains information about each request; in the case of a URI like /users/1, the value of <code>params[:id]</code> is the <code>id</code> of the corresponding user (<code>1</code>&nbsp;in this example). In the case of posting to the signup form, <code>params</code> instead contains a hash of hashes, a construction we first saw in <a class="ref" href="#sec:hashes_and_symbols">Section&nbsp;4.3.3</a>, which introduced the strategically named <code>params</code> variable in a console session. The debug information above shows that submitting the form results in a <code>user</code> hash with attributes corresponding to the submitted values, where the keys come from the <code>name</code> attributes of the <code>input</code> tags seen in <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a>; for example, the value of</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>with name <code>"user[email]"</code> is precisely the <code>email</code> attribute of the <code>user</code> hash.</p>

<p>Although the hash keys appear as strings in the debug output, internally Rails uses symbols, so that <code>params[:user]</code> is the hash of user attributes&mdash;in fact, exactly the attributes needed as an argument to <code>User.new</code>, as first seen in <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a> and appearing in <a class="ref" href="#code:first_create_action">Listing&nbsp;7.21</a>. This means that the line</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>is equivalent to</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Of course, instantiating such a variable has implications for successful signup&mdash;as we&rsquo;ll see in <a class="ref" href="#sec:signup_success">Section&nbsp;7.4</a>, once <code>@user</code> is defined properly, calling <code>@user.save</code> is all that&rsquo;s needed to complete the registration&mdash;but it has consequences even in the failed signup considered here. Note in <a class="ref" href="#fig:signup_failure_rails_3">Figure&nbsp;7.15</a> that the fields are <em>pre-filled</em> with the data from the failed submission. This is because <code>form_for</code> automatically fills in the fields with the attributes of the <code>@user</code> object, so that, for example, if <code>@user.name</code> is <code>"Foo"</code> then</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>will produce the HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;Foo&quot;</span><span class="nt">/&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>Here the <code>value</code> of the <code>input</code> tag is <code>"Foo"</code>, so that&rsquo;s what appears in the text field.</p>

<p>As you might guess, now that we can submit a form without generating an error, the test for invalid submission should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:signup_error_messages"></div>


<h3><a id="sec:7.3.2" href="#sec:signup_error_messages" class="heading"><span class="number">7.3.2</span> Signup error messages</a></h3>


<p>Though not strictly necessary, it&rsquo;s helpful to output error messages on failed signup to indicate the problems that prevented successful user registration. Rails provides just such messages based on the User model validations. For example, consider trying to save a user with an invalid email address and with a password that&rsquo;s too short:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                <span class="ss">password:</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Email is invalid&quot;, &quot;Password is too short (minimum is 6 characters)&quot;]</span>
</pre></div>
</div>


<p>Here the <code>errors.full_messages</code> object (which we saw briefly in <a class="ref" href="#sec:presence_validation">Section&nbsp;6.2.2</a>) contains an array of error messages.</p>

<p>As in the console session above, the failed save in <a class="ref" href="#code:first_create_action">Listing&nbsp;7.21</a> generates a list of error messages associated with the <code>@user</code> object. To display the messages in the browser, we&rsquo;ll render an error-messages partial on the user <code>new</code> page, as shown in <a class="ref" href="#code:f_error_messages">Listing&nbsp;7.22</a>. (Writing a test for the error messages first is a good idea and is left as an exercise; see <a class="ref" href="#sec:signup_exercises">Section&nbsp;7.6</a>.) It&rsquo;s worth noting that this error messages partial is only a first attempt; the final version appears in <a class="ref" href="#sec:creating_microposts">Section&nbsp;10.3.2</a>.</p>

<div class="label" id="code:f_error_messages"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.22.</span> <span class="description">Code to display error messages on the signup form. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Notice here that we <code>render</code> a partial called <code>&rsquo;shared/error_messages&rsquo;</code>; this reflects the common Rails convention of using a dedicated <code>shared/</code> directory for partials expected to be used in views across multiple controllers. (We&rsquo;ll see this expectation fulfilled in <a class="ref" href="#sec:edit_form">Section&nbsp;9.1.1</a>.) This means that we have to create both the new <code>app/views/shared</code> directory and the <code>_error_messages.html.erb</code> partial file. The partial itself appears in <a class="ref" href="#code:errors_partial">Listing&nbsp;7.23</a>.</p>

<div class="label" id="code:errors_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.23.</span> <span class="description">A partial for displaying form submission error messages. <br /> <code>app/views/shared/_error_messages.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>This partial introduces several new Rails and Ruby constructs, including two methods for Rails error objects. The first method is <code>count</code>, which simply returns the number of errors:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 2</span>
</pre></div>
</div>


<p>The other new method is <code>any?</code>, which (together with <code>empty?</code>) is one of a pair of complementary methods:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>We see here that the <code>empty?</code> method, which we first saw in <a class="ref" href="#sec:objects_and_message_passing">Section&nbsp;4.2.3</a> in the context of strings, also works on Rails error objects, returning <code>true</code> for an empty object and <code>false</code> otherwise. The <code>any?</code> method is just the opposite of <code>empty?</code>, returning <code>true</code> if there are any elements present and <code>false</code> otherwise. (By the way, all of these methods&mdash;<code>count</code>, <code>empty?</code>, and <code>any?</code>&mdash;work on Ruby arrays as well. We&rsquo;ll put this fact to good use starting in <a class="ref" href="#sec:showing_microposts">Section&nbsp;10.2</a>.)</p>

<p>The other new idea is the <code>pluralize</code> text helper. It isn&rsquo;t available in the console by default, but we can include it explicitly through the <code>ActionView::Helpers::TextHelper</code> module:<sup class="footnote" id="fnref:7.10"><a href="#fn:7.10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="ss">ActionView::Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1 error&quot; </span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;5 errors&quot;</span>
</pre></div>
</div>


<p>We see here that <code>pluralize</code> takes an integer argument and then returns the number with a properly pluralized version of its second argument. Underlying this method is a powerful <em>inflector</em> that knows how to pluralize a large number of words, including many with irregular plurals:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;woman&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;2 women&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;erratum&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;3 errata&quot;</span>
</pre></div>
</div>


<p>As a result of its use of <code>pluralize</code>, the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>returns <code>"0 errors"</code>, <code>"1 error"</code>, <code>"2 errors"</code>, and so on, depending on how many errors there are, thereby avoiding ungrammatical phrases such as <code>"1 errors"</code> (a distressingly common mistake on <a href="http://www.urbandictionary.com/define.php?term=interwebs">teh interwebs</a>).</p>

<p>Note that <a class="ref" href="#code:errors_partial">Listing&nbsp;7.23</a> includes the CSS&nbsp;id <code>error_explanation</code> for use in styling the error messages. (Recall from <a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a> that CSS uses the pound sign <code>#</code> to style ids.) In addition, on error pages Rails automatically wraps the fields with errors in <code>div</code>s with the CSS class <code>field_with_errors</code>. These labels then allow us to style the error messages with the SCSS shown in <a class="ref" href="#code:error_messages_css">Listing&nbsp;7.24</a>, which makes use of Sass&rsquo;s <code>@extend</code> function to include the functionality of two Bootstrap classes <code>control-group</code> and <code>error</code>. As a result, on failed submission the error messages appear surrounded by red, as seen in <a class="ref" href="#fig:signup_error_messages">Figure&nbsp;7.17</a>. Because the messages are generated by the model validations, they will automatically change if you ever change your mind about, say, the format of email addresses, or the minimum length of passwords.</p>

<div class="label" id="code:error_messages_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.24.</span> <span class="description">CSS for styling error messages. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nn">#error_explanation</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#f00</span><span class="p">;</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">18</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">@extend</span> <span class="nc">.control-group</span><span class="o">;</span>
  <span class="o">@</span><span class="nt">extend</span> <span class="nc">.error</span><span class="o">;</span>
 <span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_error_messages"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_error_messages_bootstrap.png" alt="signup_error_messages_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.17: </span><span class="description">Failed signup with error messages.&nbsp;<a href="http://railstutorial.org/images/figures/signup_error_messages_bootstrap-full.png">(full size)</a></span></div></div>


<p>To see the results of our work in this section, we&rsquo;ll recapitulate the steps in the failed signup test from <a class="ref" href="#code:basic_signup_tests">Listing&nbsp;7.16</a> by visiting the signup page and clicking &ldquo;Create my account&rdquo; with blank input fields. The result is shown in <a class="ref" href="#fig:blank_signup_password_digest">Figure&nbsp;7.18</a>. As you might guess from the working page, at this point the corresponding test should also pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with invalid information&quot;</span>
</pre></div>
</div>


<div class="label" id="fig:blank_signup_password_digest"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/blank_signup_password_digest_bootstrap.png" alt="blank_signup_password_digest_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.18: </span><span class="description">The result of visiting <a href="http://localhost:3000/signup">/signup</a> and just clicking &ldquo;Create my account&rdquo;.&nbsp;<a href="http://railstutorial.org/images/figures/blank_signup_password_digest_bootstrap-full.png">(full size)</a></span></div></div>


<p>Unfortunately, there&rsquo;s a minor blemish in the error messages shown in <a class="ref" href="#fig:blank_signup_password_digest">Figure&nbsp;7.18</a>: the error for a missing password reads as &ldquo;Password digest can&rsquo;t be blank&rdquo; instead of the more sensible &ldquo;Password can&rsquo;t be blank&rdquo;. This is due to the password digest presence validation hiding in <code>has_secure_password</code>, as mentioned briefly in <a class="ref" href="#sec:has_secure_password">Section&nbsp;6.3.4</a>. Fixing this problem is left as an exercise (<a class="ref" href="#sec:signup_exercises">Section&nbsp;7.6</a>).</p>

<div class="label" id="sec:signup_success"></div>


<h2><a id="sec:7.4" href="#sec:signup_success" class="heading"><span class="number">7.4</span> Signup success</a></h2>


<p>Having handled invalid form submissions, now it&rsquo;s time to complete the signup form by actually saving a new user (if valid) to the database. First, we try to save the user; if the save succeeds, the user&rsquo;s information gets written to the database automatically, and we then <em>redirect</em> the browser to show the user&rsquo;s profile (together with a friendly greeting), as mocked up in <a class="ref" href="#fig:signup_success_mockup">Figure&nbsp;7.19</a>. If it fails, we simply fall back on the behavior developed in <a class="ref" href="#sec:signup_failure">Section&nbsp;7.3</a>.</p>

<div class="label" id="fig:signup_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_success_mockup_bootstrap.png" alt="signup_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.19: </span><span class="description">A mockup of successful signup.&nbsp;<a href="http://railstutorial.org/images/figures/signup_success_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:the_finished_signup_form"></div>


<h3><a id="sec:7.4.1" href="#sec:the_finished_signup_form" class="heading"><span class="number">7.4.1</span> The finished signup form</a></h3>


<p>To complete a working signup form, we need to fill in the commented-out section in <a class="ref" href="#code:first_create_action">Listing&nbsp;7.21</a> with the appropriate behavior. Currently, the test for valid submission should be failing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with valid information&quot;</span>
</pre></div>
</div>


<p>This is because the default behavior for a Rails action is to render the corresponding view, but there is not (nor should there be) a view template corresponding to the <code>create</code> action. Instead, we need to redirect to a different page, and it makes sense for that page to be the newly created user&rsquo;s profile. Testing that the proper page gets rendered is left as an exercise (<a class="ref" href="#sec:signup_exercises">Section&nbsp;7.6</a>); the application code appears in <a class="ref" href="#code:user_create_action">Listing&nbsp;7.25</a>.</p>

<div class="label" id="code:user_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.25.</span> <span class="description">The user <code>create</code> action with a save and a redirect. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we can omit the <code>user_path</code> in the redirect, writing simply <code>redirect_to @user</code> to redirect to the user show page.</p>

<p>With the code in <a class="ref" href="#code:user_create_action">Listing&nbsp;7.25</a>, our signup form is working, as you can verify by running the test suite:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:the_flash"></div>


<h3><a id="sec:7.4.2" href="#sec:the_flash" class="heading"><span class="number">7.4.2</span> The flash</a></h3>


<p>Before submitting a valid registration in a browser, we&rsquo;re going to add a bit of polish common in web applications: a message that appears on the subsequent page (in this case, welcoming our new user to the application) and then disappears upon visiting a second page or on page reload. The Rails way to accomplish this is to use a special variable called the <em>flash</em>, which operates like <a href="http://en.wikipedia.org/wiki/Flash_memory">flash memory</a> in that it stores its data temporarily. The <code>flash</code> variable is effectively a hash; you may even recall the console example in <a class="ref" href="#sec:hashes_and_symbols">Section&nbsp;4.3.3</a>, where we saw how to iterate through a hash using a strategically named <code>flash</code> hash:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success:</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">error:</span> <span class="s2">&quot;It failed.&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, error: &quot;It failed.&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">error</span>
<span class="go">It failed.</span>
</pre></div>
</div>


<p>We can arrange to display the contents of the flash site-wide by including it in our application layout, as in <a class="ref" href="#code:layout_flash">Listing&nbsp;7.26</a>. (This code is a particularly ugly combination of HTML and ERb; an exercise in <a class="ref" href="#sec:signup_exercises">Section&nbsp;7.6</a> shows how to make it prettier.)</p>

<div class="label" id="code:layout_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.26.</span> <span class="description">Adding the contents of the <code>flash</code> variable to the site layout. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:layout_flash">Listing&nbsp;7.26</a> arranges to insert a <code>div</code> tag for each element in the flash, with a CSS class indicating the type of message. For example, if <code>flash[:success] = "Welcome to the Sample App!"</code>, then the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span> 
</pre></div>
</div>


<p>will produce this HTML:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>(Note that the key <code>:success</code> is a symbol, but embedded Ruby automatically converts it to the string <code>"success"</code> before inserting it into the template.) The reason we iterate through all possible key/value pairs is so that we can include other kinds of flash messages. For example, in <a class="ref" href="#sec:rendering_with_a_flash_message">Section&nbsp;8.1.5</a> we&rsquo;ll see <code>flash[:error]</code> used to indicate a failed signin attempt.<sup class="footnote" id="fnref:7.11"><a href="#fn:7.11">11</a></sup></p>

<p>Writing a test for the right flash message is left as an exercise (<a class="ref" href="#sec:signup_exercises">Section&nbsp;7.6</a>), and we can get the test to pass by assigning <code>flash[:success]</code> a welcome message in the <code>create</code> action, as shown in <a class="ref" href="#code:signup_flash">Listing&nbsp;7.27</a>.</p>

<div class="label" id="code:signup_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.27.</span> <span class="description">Adding a flash message to user signup. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:the_first_signup"></div>


<h3><a id="sec:7.4.3" href="#sec:the_first_signup" class="heading"><span class="number">7.4.3</span> The first signup</a></h3>


<p>We can see the result of all this work by signing up our first user under the name &ldquo;Rails Tutorial&rdquo; and email address &ldquo;<tt>example@railstutorial.org</tt>&rdquo;. The resulting page (<a class="ref" href="#fig:signup_flash">Figure&nbsp;7.20</a>) shows a friendly message upon successful signup, including nice green styling for the <code>success</code> class, which comes included with the Bootstrap CSS framework from <a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a>. (If instead you get an error message indicating that the email address has already been taken, be sure to run the <code>db:reset</code> Rake task as indicated in <a class="ref" href="#sec:signup_form">Section&nbsp;7.2</a>.) Then, upon reloading the user show page, the flash message disappears as promised (<a class="ref" href="#fig:signup_flash_reloaded">Figure&nbsp;7.21</a>).</p>

<div class="label" id="fig:signup_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_bootstrap.png" alt="signup_flash_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.20: </span><span class="description">The results of a successful user signup, with flash message.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:signup_flash_reloaded"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_reloaded_bootstrap.png" alt="signup_flash_reloaded_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.21: </span><span class="description">The flash-less profile page after a browser reload.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash_reloaded_bootstrap-full.png">(full size)</a></span></div></div>


<p>We can now check our database just to be double-sure that the new user was actually created:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Rails Tutorial&quot;, email: &quot;example@railstutorial.org&quot;,</span>
<span class="go">created_at: &quot;2011-12-13 05:51:34&quot;, updated_at: &quot;2011-12-13 05:51:34&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$A58/j7wwh3aAffGkMAO9Q.jjh3jshd.6akhDKtchAz/R...&quot;&gt;</span>
</pre></div>
</div>




<div class="label" id="sec:deploying_to_production_with_ssl"></div>


<h3><a id="sec:7.4.4" href="#sec:deploying_to_production_with_ssl" class="heading"><span class="number">7.4.4</span> Deploying to production with SSL</a></h3>


<p>Having developed the User model and the signup functionality, now is a good time to deploy the sample application to production. (If you didn&rsquo;t follow the setup steps in the introduction to <a class="ref" href="#cha:static_pages">Chapter&nbsp;3</a>, you should go back and do them now.) As part of this, we will add <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">Secure Sockets Layer (SSL)</a><sup class="footnote" id="fnref:7.12"><a href="#fn:7.12">12</a></sup> to the production application, thereby making signup secure. Since we&rsquo;ll implement SSL site-wide, the sample application will also be secure during user signin (<a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>) and will also be immune to the <em>session hijacking</em> vulnerability (<a class="ref" href="#sec:a_working_sign_in_method">Section&nbsp;8.2.2</a>).</p>

<p>As preparation for the deployment, you should merge your changes into the <code>master</code> branch at this point:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user signup&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-up
</pre></div>
</div>


<p>To get the deployment to work, we first need to add a line forcing the use of SSL in production. The result, which involves editing the production configuration file <code>config/environments/production.rb</code>, appears in <a class="ref" href="#code:ssl_in_production">Listing&nbsp;7.28</a>.</p>

<div class="label" id="code:ssl_in_production"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.28.</span> <span class="description">Configuring the application to use SSL in production. <br /> <code>config/environments/production.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security, </span>
  <span class="c1"># and use secure cookies.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To get the production site working, we have to commit the change to the configuration file and push the result up to Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">&quot;Add SSL in production&quot;</span>
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>Next, we need to run the migration on the production database to tell Heroku about the User data model:<sup class="footnote" id="fnref:7.13"><a href="#fn:7.13">13</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>(You might see some deprecation warnings at this point, which you should ignore.)</p>

<p>Finally, we need to set up SSL on the remote server. Configuring a production site to use SSL is painful and error-prone, and among other things it involves purchasing an <em>SSL certificate</em> for your domain. Luckily, for an application running on a Heroku domain (such as the sample application), we can piggyback on Heroku&rsquo;s SSL certificate, a feature that is included automatically as part of the Heroku platform. If you want to run SSL on a custom domain, such as <code>example.com</code>, you&rsquo;ll have no choice but to endure some pain, which you can read about on <a href="http://devcenter.heroku.com/articles/ssl">Heroku&rsquo;s page on SSL</a>.</p>

<p>The result of all this work is a working signup form on the production server (<a class="ref" href="#fig:signup_in_production">Figure&nbsp;7.22</a>):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p>Note in <a class="ref" href="#fig:signup_in_production">Figure&nbsp;7.22</a> the <tt>https://</tt> in place of the usual <tt>http://</tt>. The extra &lsquo;s&rsquo; is an indication that SSL is working.</p>

<p>You should feel free to visit the signup page and create a new user at this time. If you have trouble, try running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>to debug the error using the Heroku logfile.</p>

<div class="label" id="fig:signup_in_production"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_in_production_bootstrap.png" alt="signup_in_production_bootstrap" /></span></div><div class="caption"><span class="header">Figure 7.22: </span><span class="description">A working signup page on the live Web.&nbsp;<a href="http://railstutorial.org/images/figures/signup_in_production_bootstrap-full.png">(full size)</a></span></div></div>




<h2><a id="sec:7.5" href="#sec:7.5" class="heading"><span class="number">7.5</span> Conclusion</a></h2>


<p>Being able to sign up users is a major milestone for our application. Although the sample app has yet to accomplish anything useful, we have laid an essential foundation for all future development. In <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>, we will complete our authentication machinery by allowing users to sign in and out of the application. In <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>, we will allow all users to update their account information, and will allow site administrators to delete users, thereby completing the full suite of the Users resource REST actions from <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>. Finally, we&rsquo;ll add authorization methods to our actions to enforce a site security model.</p>

<div class="label" id="sec:signup_exercises"></div>


<h2><a id="sec:7.6" href="#sec:signup_exercises" class="heading"><span class="number">7.6</span> Exercises</a></h2>




<ol>

<li>Verify that the code in <a class="ref" href="#code:gravatar_option">Listing&nbsp;7.29</a> allows the <code>gravatar_for</code> helper defined in <a class="ref" href="#sec:a_gravatar_image">Section&nbsp;7.1.4</a> to take an optional <code>size</code> parameter, allowing code like <code>gravatar_for user, size: 40</code> in the view.</li>

<li>Write tests for the error messages implemented in <a class="ref" href="#code:f_error_messages">Listing&nbsp;7.22</a>. A suggested start appears in <a class="ref" href="#code:error_messages_test">Listing&nbsp;7.31</a>.</li>

<li>Using the code in <a class="ref" href="#code:password_digest_message_fix">Listing&nbsp;7.30</a>, replace the error message for a missing password, currently &ldquo;Password digest can&rsquo;t be blank&rdquo;, with the more understandable &ldquo;Password can&rsquo;t be blank&rdquo;. (This uses Rails&rsquo; internationalization support to produce a functional but rather hacky solution. Take special care to use spaces and not tab characters; <a href="http://www.yaml.org/faq.html">the YAML format forbids tabs</a>.) Note that, to avoid duplication of error messages, you should also remove the password&rsquo;s <code>presence: true</code> validation in the User model.</li>

<li>By writing the test first or by intentionally breaking and then fixing the application code, verify that the tests in <a class="ref" href="#code:after_save_tests">Listing&nbsp;7.32</a> correctly specify the desired behavior after saving the user in the <code>create</code> action.</li>

<li>As noted before, the flash HTML in <a class="ref" href="#code:layout_flash">Listing&nbsp;7.26</a> is ugly. Verify by running the test suite that the cleaner code in <a class="ref" href="#code:layout_flash_content_tag">Listing&nbsp;7.33</a>, which uses the Rails <code>content_tag</code> helper, also works.</li>

</ol>




<div class="label" id="code:gravatar_option"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.29.</span> <span class="description">Defining an optional <code>:size</code> parameter for the <code>gravatar_for</code> helper. <br /> <code>app/helpers/users_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size:</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">?s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:password_digest_message_fix"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.30.</span> <span class="description">Hacking a better error message for missing passwords. <br /> <code>config/locales/en.yml</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">en</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">activerecord</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="s">&quot;Password&quot;</span>
</pre></div>
</div></div>




<div class="label" id="code:error_messages_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.31.</span> <span class="description">Suggested error messages tests. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after submission&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code:after_save_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.32.</span> <span class="description">Tests for the post-save behavior in the <code>create</code> action. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre>    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s1">&#39;user@example.com&#39;</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Welcome&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code:layout_flash_content_tag"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 7.33.</span> <span class="description">The <code>flash</code> ERb in the site layout using <code>content_tag</code>. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;alert alert-</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<div class="footnotes">
<ol>
<li id="fn:7.1"><a href="http://gomockingbird.com/">Mockingbird</a> doesn&rsquo;t support custom images like the profile photo in <a class="ref" href="#fig:profile_mockup_profile_name">Figure&nbsp;7.1</a>; I put that in by hand using <a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a>. &nbsp;<a class="arrow" href="#fnref:7.1">&uarr;</a></li>
<li id="fn:7.2">The hippo here is from <a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a>.&nbsp;<a class="arrow" href="#fnref:7.2">&uarr;</a></li>
<li id="fn:7.3">The Rails <code>debug</code> information is shown as <a href="http://www.yaml.org/">YAML</a> (a <a href="http://catb.org/jargon/html/R/recursive-acronym.html">recursive acronym</a> standing for &ldquo;YAML Ain&rsquo;t Markup Language&rdquo;), which is a friendly data format designed to be both machine- <em>and</em> human-readable.&nbsp;<a class="arrow" href="#fnref:7.3">&uarr;</a></li>
<li id="fn:7.4">You can define your own custom environments as well; see the <a href="http://railscasts.com/episodes/72-adding-an-environment">RailsCast on adding an environment</a> for details.&nbsp;<a class="arrow" href="#fnref:7.4">&uarr;</a></li>
<li id="fn:7.5">This means that the <em>routing</em> works, but the corresponding pages don&rsquo;t necessarily work at this point. For example, /users/1/edit gets routed properly to the <code>edit</code> action of the Users controller, but since the <code>edit</code> action doesn&rsquo;t exist yet actually hitting that URI will return an error.&nbsp;<a class="arrow" href="#fnref:7.5">&uarr;</a></li>
<li id="fn:7.6">Presumably &ldquo;Factory Girl&rdquo; is a reference to the <a href="http://www.imdb.com/title/tt0432402/">movie of the same name</a>.&nbsp;<a class="arrow" href="#fnref:7.6">&uarr;</a></li>
<li id="fn:7.7">In Hinduism, an avatar is the manifestation of a deity in human or animal form. By extension, the term <em>avatar</em> is commonly used to mean some kind of personal representation, especially in a virtual environment. But you&rsquo;ve seen the <a href="http://www.imdb.com/title/tt0499549/">movie</a>, so you already knew this.&nbsp;<a class="arrow" href="#fnref:7.7">&uarr;</a></li>
<li id="fn:7.8">If your application does need to handle custom images or other file uploads, I recommend the <a href="http://github.com/thoughtbot/paperclip">Paperclip</a> gem.&nbsp;<a class="arrow" href="#fnref:7.8">&uarr;</a></li>
<li id="fn:7.9">Weird, right? I don&rsquo;t get it either.&nbsp;<a class="arrow" href="#fnref:7.9">&uarr;</a></li>
<li id="fn:7.10">I figured this out by looking up <code>pluralize</code> in the <a href="http://api.rubyonrails.org/v3.2.0/classes/ActionView/Helpers/TextHelper.html#method-i-pluralize">Rails API</a>.&nbsp;<a class="arrow" href="#fnref:7.10">&uarr;</a></li>
<li id="fn:7.11">Actually, we&rsquo;ll use the closely related <code>flash.now</code>, but we&rsquo;ll defer that subtlety until we need it.&nbsp;<a class="arrow" href="#fnref:7.11">&uarr;</a></li>
<li id="fn:7.12">Technically, SSL is now TLS, for Transport Layer Security, but everyone I know still says &ldquo;SSL&rdquo;.&nbsp;<a class="arrow" href="#fnref:7.12">&uarr;</a></li>
<li id="fn:7.13">Readers interested in using Heroku for real-life production applications might be interested in <a href="https://github.com/thoughtbot/kumade">Kumade</a>, which handles things like database migrations automatically.&nbsp;<a class="arrow" href="#fnref:7.13">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:sign_in_sign_out"></div>


<h1 class="chapter"><a id="sec:8" href="#cha:sign_in_sign_out" class="heading"><span class="number">Chapter 8</span> Sign in, sign out</a></h1>


<p>Now that new users can sign up for our site (<a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>), it&rsquo;s time to give registered users the ability to sign in and sign out. This will allow us to add customizations based on signin status and based on the identity of the current user. For example, in this chapter we&rsquo;ll update the site header with signin/signout links and a profile link. In <a class="ref" href="#cha:user_microposts">Chapter&nbsp;10</a>, we&rsquo;ll use the identity of a signed-in user to create microposts associated with that user, and in <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a> we&rsquo;ll allow the current user to follow other users of the application (thereby receiving a feed of their microposts).</p>

<p>Having users sign in will also allow us to implement a security model, restricting access to particular pages based on the identity of the signed-in user. For instance, as we&rsquo;ll see in <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>, only signed-in users will be able to access the page used to edit user information. The signin system will also make possible special privileges for administrative users, such as the ability (also introduced in <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>) to delete users from the database.</p>

<p>After implementing the core authentication machinery, we&rsquo;ll take a short detour to investigate <em>Cucumber</em>, a popular system for behavior-driven development (<a class="ref" href="#sec:cucumber">Section&nbsp;8.3</a>). In particular, we&rsquo;ll re-implement a couple of the RSpec integration tests in Cucumber to see how the two methods compare.</p>

<p>As in previous chapters, we&rsquo;ll do our work on a topic branch and merge in the changes at the end:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b sign-in-out
</pre></div>
</div>


<div class="label" id="sec:signin_failure"></div>


<h2><a id="sec:8.1" href="#sec:signin_failure" class="heading"><span class="number">8.1</span> Sessions and signin failure</a></h2>


<p>A <a href="http://en.wikipedia.org/wiki/Session_(computer_science)"><em>session</em></a> is a semi-permanent connection between two computers, such as a client computer running a web browser and a server running Rails. We&rsquo;ll be using sessions to implement the common pattern of &ldquo;signing in&rdquo;, and in this context there are several different models for session behavior common on the web: &ldquo;forgetting&rdquo; the session on browser close, using an optional &ldquo;remember me&rdquo; checkbox for persistent sessions, and automatically remembering sessions until the user explicitly signs out.<sup class="footnote" id="fnref:8.1"><a href="#fn:8.1">1</a></sup> We&rsquo;ll opt for the final of these options: when users sign in, we will remember their signin status &ldquo;forever&rdquo;, clearing the session only when the user explicitly signs out. (We&rsquo;ll see in <a class="ref" href="#sec:remember_me">Section&nbsp;8.2.1</a> just how long &ldquo;forever&rdquo; is.)</p>

<p>It&rsquo;s convenient to model sessions as a RESTful resource: we&rsquo;ll have a signin page for <em>new</em> sessions, signing in will <em>create</em> a session, and signing out will <em>destroy</em> it. Unlike the Users resource, which uses a database back-end (via the User model) to persist data, the Sessions resource will use a <a href="http://en.wikipedia.org/wiki/HTTP_cookie"><em>cookie</em></a>, which is a small piece of text placed on the user&rsquo;s browser. Much of the work involved in signin comes from building this cookie-based authentication machinery. In this section and the next, we&rsquo;ll prepare for this work by constructing a Sessions controller, a signin form, and the relevant controller actions. We&rsquo;ll then complete user signin in <a class="ref" href="#sec:signin_success">Section&nbsp;8.2</a> by adding the necessary cookie-manipulation code.</p>

<div class="label" id="sec:sessions_controller"></div>


<h3><a id="sec:8.1.1" href="#sec:sessions_controller" class="heading"><span class="number">8.1.1</span> Sessions controller</a></h3>


<p>The elements of signing in and out correspond to particular REST actions of the Sessions controller: the signin form is handled by the <code>new</code> action (covered in  this section), actually signing in is handled by sending a <tt>POST</tt> request to the <code>create</code> action (<a class="ref" href="#sec:signin_failure">Section&nbsp;8.1</a> and <a class="ref" href="#sec:signin_success">Section&nbsp;8.2</a>), and signing out is handled by sending a <tt>DELETE</tt> request to the <code>destroy</code> action (<a class="ref" href="#sec:signing_out">Section&nbsp;8.2.6</a>). (Recall the association of HTTP verbs with REST actions from <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>.) To get started, we&rsquo;ll generate a Sessions controller and an integration test for the authentication machinery:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions --no-test-framework
<span class="gp">$</span> rails generate integration_test authentication_pages
</pre></div>
</div>


<p>Following the model from <a class="ref" href="#sec:signup_form">Section&nbsp;7.2</a> for the signup page, we&rsquo;ll create a signin form for creating new sessions, as mocked up in <a class="ref" href="#fig:signin_mockup">Figure&nbsp;8.1</a>.</p>

<div class="label" id="fig:signin_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_mockup_bootstrap.png" alt="signin_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.1: </span><span class="description">A mockup of the signin form.&nbsp;<a href="http://railstutorial.org/images/figures/signin_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>The signin page will live at the URI given by <code>signin_path</code> (defined momentarily), and as usual we&rsquo;ll start with a minimalist test, as shown in <a class="ref" href="#code:new_session_tests">Listing&nbsp;8.1</a>. (Compare to the analogous code for the signup page in <a class="ref" href="#code:initial_signup_test">Listing&nbsp;7.6</a>.)</p>

<div class="label" id="code:new_session_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.1.</span> <span class="description">Tests for the <code>new</code> session action and view. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The tests initially fail, as required:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>To get the tests in <a class="ref" href="#code:new_session_tests">Listing&nbsp;8.1</a> to pass, we first need to define routes for the Sessions resource, together with a custom named route for the signin page (which we&rsquo;ll map to the Session controller&rsquo;s <code>new</code> action). As with the Users resource, we can use the <code>resources</code> method to define the standard RESTful routes:</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</pre></div>
</div>


<p>Since we have no need to show or edit sessions, we&rsquo;ve restricted the actions to <code>new</code>, <code>create</code>, and <code>destroy</code> using the <code>:only</code> option accepted by <code>resources</code>. The full result, including named routes for signin and signout, appears in <a class="ref" href="#code:sessions_resource">Listing&nbsp;8.2</a>.</p>

<div class="label" id="code:sessions_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.2.</span> <span class="description">Adding a resource to get the standard RESTful actions for sessions. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signin&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;sessions#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signout&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">via:</span> <span class="ss">:delete</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note the use of <code>via: :delete</code> for the signout route, which indicated that it should be invoked using an HTTP <tt>DELETE</tt> request.</p>

<p>The resources defined in <a class="ref" href="#code:sessions_resource">Listing&nbsp;8.2</a> provide URIs and actions similar to those for users (<a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>), as shown in <a class="ref" href="#table:RESTful_sessions">Table&nbsp;8.1</a>. Note that the routes for signin and signout are custom, but the route for creating a session is simply the default (i.e., <code>[resource name]_path</code>).</p>

<div class="label" id="table:RESTful_sessions"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Named route</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/signin</td><td class="align_left"><code>signin_path</code></td><td class="align_left"><code>new</code></td><td class="align_left">page for  a new session (signin)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/sessions</td><td class="align_left"><code>sessions_path</code></td><td class="align_left"><code>create</code></td><td class="align_left">create a new session</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/signout</td><td class="align_left"><code>signout_path</code></td><td class="align_left"><code>destroy</code></td><td class="align_left">delete a session (sign out)</td></tr></table></div><div class="caption"><span class="header">Table 8.1: </span><span class="description">RESTful routes provided by the sessions rules in <a class="ref" href="#code:sessions_resource">Listing&nbsp;8.2</a>.</span></div></div>


<p>The next step to get the tests in <a class="ref" href="#code:new_session_tests">Listing&nbsp;8.1</a> to pass is to add a <code>new</code> action to the Sessions controller, as shown in <a class="ref" href="#code:new_session_title">Listing&nbsp;8.3</a> (which also defines the <code>create</code> and <code>destroy</code> actions for future reference).</p>

<div class="label" id="code:new_session_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.3.</span> <span class="description">The initial Sessions controller. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The final step is to define the initial version of the signin page. Note that, since it is the page for a new session, the signin page lives in the file <code>app/views/sessions/new.html.erb</code>, which we have to create. The contents, which for now only define the page title and top-level heading, appear as in <a class="ref" href="#code:initial_signin_page">Listing&nbsp;8.4</a>.</p>

<div class="label" id="code:initial_signin_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.4.</span> <span class="description">The initial signin view. <br /> <code>app/views/sessions/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>With that, the tests in <a class="ref" href="#code:new_session_tests">Listing&nbsp;8.1</a> should be passing, and we&rsquo;re ready to make the actual signin form.</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:signin_tests"></div>


<h3><a id="sec:8.1.2" href="#sec:signin_tests" class="heading"><span class="number">8.1.2</span> Signin tests</a></h3>


<p>Comparing <a class="ref" href="#fig:signin_mockup">Figure&nbsp;8.1</a> with <a class="ref" href="#fig:signup_mockup">Figure&nbsp;7.11</a>, we see that the signin form (or, equivalently, the new session form) is similar in appearance to the signup form, except with two fields (email and password) in place of four. As with the signup form, we can test the signin form by using Capybara to fill in the form values and then click the button.</p>

<p>In the process of writing the tests, we&rsquo;ll be forced to design aspects of the application, which is one of the nice side-effects of test-driven development. We&rsquo;ll start with invalid signin, as mocked up in <a class="ref" href="#fig:signin_failure_mockup">Figure&nbsp;8.2</a>.</p>

<div class="label" id="fig:signin_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_failure_mockup_bootstrap.png" alt="signin_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.2: </span><span class="description">A mockup of signin failure.&nbsp;<a href="http://railstutorial.org/images/figures/signin_failure_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>As seen in <a class="ref" href="#fig:signin_failure_mockup">Figure&nbsp;8.2</a>, when the signin information is invalid we want to re-render the signin page and display an error message. We&rsquo;ll render the error as a flash message, which we can test for as follows:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>(We saw similar code in <a class="ref" href="#code:after_save_tests">Listing&nbsp;7.32</a> from the exercises in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>.) Here the selector element (i.e., the tag) we&rsquo;re looking for is</p>

<div class="code"><div class="highlight"><pre><span class="n">div</span><span class="o">.</span><span class="n">alert</span><span class="o">.</span><span class="n">alert</span><span class="o">-</span><span class="n">error</span>
</pre></div>
</div>


<p>Recalling that the dot means &ldquo;class&rdquo; in CSS (<a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a>), you might be able to guess that this tests for a <code>div</code> tag with the classes <code>"alert"</code> and <code>"alert-error"</code>. We also test that the error message contains the text <code>"Invalid"</code>. Putting these together, the test looks for an element of the following form:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>Invalid...<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Combining the title and flash tests gives the code in <a class="ref" href="#code:initial_failing_signin_test">Listing&nbsp;8.5</a>. As we&rsquo;ll see, these tests miss an important subtlety, which we&rsquo;ll address in <a class="ref" href="#sec:rendering_with_a_flash_message">Section&nbsp;8.1.5</a>.</p>

<div class="label" id="code:initial_failing_signin_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.5.</span> <span class="description">The tests for signin failure. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Having written tests for signin failure, we now turn to signin success. The changes we&rsquo;ll test for are the rendering of the user&rsquo;s profile page (as determined by the page title, which should be the user&rsquo;s name), together with three planned changes to the site navigation:</p>

<ol>
<li>The appearance of a link to the profile page</li>
<li>The appearance of a &ldquo;Sign out&rdquo; link</li>
<li>The disappearance of the &ldquo;Sign in&rdquo; link</li>
</ol>


<p>(We&rsquo;ll defer the test for the &ldquo;Settings&rdquo; link to <a class="ref" href="#sec:updating_users">Section&nbsp;9.1</a> and for the &ldquo;Users&rdquo; link to <a class="ref" href="#sec:showing_all_users">Section&nbsp;9.3</a>.) A mockup of these changes appears in <a class="ref" href="#fig:signin_success_mockup">Figure&nbsp;8.3</a>.<sup class="footnote" id="fnref:8.2"><a href="#fn:8.2">2</a></sup> Note that the signout and profile links appear in a dropdown &ldquo;Account&rdquo; menu; in <a class="ref" href="#sec:changing_the_layout_links">Section&nbsp;8.2.4</a>, we&rsquo;ll see how to make such a menu with Bootstrap.</p>

<div class="label" id="fig:signin_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_success_mockup_bootstrap.png" alt="signin_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.3: </span><span class="description">A mockup of the user profile after a successful signin.&nbsp;<a href="http://railstutorial.org/images/figures/signin_success_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>The test code for signin success appears in <a class="ref" href="#code:signin_success_tests">Listing&nbsp;8.6</a>.</p>

<div class="label" id="code:signin_success_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.6.</span> <span class="description">Test for signin success. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we&rsquo;ve used the <code>have_link</code> method. It takes as arguments the text of the link and an optional <code>:href</code> parameter, so that</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>ensures that the anchor tag&nbsp;<code>a</code> has the right <code>href</code> (URI) attribute&mdash;in this case, a link to the user&rsquo;s profile page.</p>

<div class="label" id="sec:signin_form"></div>


<h3><a id="sec:8.1.3" href="#sec:signin_form" class="heading"><span class="number">8.1.3</span> Signin form</a></h3>


<p>With our tests in place, we&rsquo;re ready to start developing the signin form. Recall from <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a> that the signup form uses the <code>form_for</code> helper, taking as an argument the user instance variable <code>@user</code>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The main difference between this and the signin form is that we have no Session model, and hence no analogue for the <code>@user</code> variable. This means that, in constructing the new session form, we have to give <code>form_for</code> slightly more information; in particular, whereas</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>allows Rails to infer that the <code>action</code> of the form should be to <tt>POST</tt> to the URI /users, in the case of sessions we need to indicate the <em>name</em> of the resource and the corresponding URI:</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span>
</pre></div>
</div>


<p>(A second option is to use <code>form_tag</code> in place of <code>form_for</code>; this might be more even idiomatically correct Rails, but it has less in common with the signup form, and at this stage I want to emphasize the parallel structure. Making a working form with <code>form_tag</code> is left as an exercise (<a class="ref" href="#sec:sign_in_out_exercises">Section&nbsp;8.5</a>).)</p>

<p>With the proper <code>form_for</code> in hand, it&rsquo;s easy to make a signin form to match the mockup in <a class="ref" href="#fig:signin_mockup">Figure&nbsp;8.1</a> using the signup form (<a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a>) as a model, as shown in <a class="ref" href="#code:signin_form">Listing&nbsp;8.7</a>.</p>

<div class="label" id="code:signin_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.7.</span> <span class="description">Code for the signin form. <br /> <code>app/views/sessions/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Note that we&rsquo;ve added a link to the signup page for convenience. With the code in <a class="ref" href="#code:signin_form">Listing&nbsp;8.7</a>, the signin form appears as in <a class="ref" href="#fig:signin_form">Figure&nbsp;8.4</a>.</p>

<div class="label" id="fig:signin_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_form_bootstrap.png" alt="signin_form_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.4: </span><span class="description">The signin form  (<a href="http://localhost:3000/signin">/signin</a>).&nbsp;<a href="http://railstutorial.org/images/figures/signin_form_bootstrap-full.png">(full size)</a></span></div></div>


<p>Though you&rsquo;ll soon get out of the habit of looking at the HTML generated by Rails (instead trusting the helpers to do their job), for now let&rsquo;s take a look at it (<a class="ref" href="#code:signin_form_html">Listing&nbsp;8.8</a>).</p>

<div class="label" id="code:signin_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.8.</span> <span class="description">HTML for the signin form produced by <a class="ref" href="#code:signin_form">Listing&nbsp;8.7</a>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/sessions&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_email&quot;</span> <span class="na">name=</span><span class="s">&quot;session[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_password&quot;</span> <span class="na">name=</span><span class="s">&quot;session[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> 
           <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> 
       <span class="na">value=</span><span class="s">&quot;Sign in&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>Comparing <a class="ref" href="#code:signin_form_html">Listing&nbsp;8.8</a> with <a class="ref" href="#code:signup_form_html">Listing&nbsp;7.20</a>, you might be able to guess that submitting this form will result in a <code>params</code> hash where <code>params[:session][:email]</code> and <code>params[:session][:password]</code> correspond to the email and password fields.</p>

<div class="label" id="sec:reviewing_form_submission"></div>


<h3><a id="sec:8.1.4" href="#sec:reviewing_form_submission" class="heading"><span class="number">8.1.4</span> Reviewing form submission</a></h3>


<p>As in the case of creating users (signup), the first step in creating sessions (signin) is to handle <em>invalid</em> input. We already have tests for the signup failure (<a class="ref" href="#code:initial_failing_signin_test">Listing&nbsp;8.5</a>), and the application code is simple apart from a couple of subtleties. We&rsquo;ll start by reviewing what happens when a form gets submitted, and then arrange for helpful error messages to appear in the case of signin failure (as mocked up in <a class="ref" href="#fig:signin_failure_mockup">Figure&nbsp;8.2</a>.) Then we&rsquo;ll lay the foundation for successful signin (<a class="ref" href="#sec:signin_success">Section&nbsp;8.2</a>) by evaluating each signin submission based on the validity of its email/password combination.</p>

<p>Let&rsquo;s start by defining a minimalist <code>create</code> action for the Sessions controller (<a class="ref" href="#code:initial_create_session">Listing&nbsp;8.9</a>), which does nothing but render the <code>new</code> view. Submitting the <a href="http://localhost:3000/sessions/new">/sessions/new</a> form with blank fields then yields the result shown in <a class="ref" href="#fig:initial_failed_signin_rails_3">Figure&nbsp;8.5</a>.</p>

<div class="label" id="code:initial_create_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.9.</span> <span class="description">A preliminary version of the Sessions <code>create</code> action. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:initial_failed_signin_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/initial_failed_signin_rails_3_bootstrap.png" alt="initial_failed_signin_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.5: </span><span class="description">The initial failed signin, with <code>create</code> as in <a class="ref" href="#code:initial_create_session">Listing&nbsp;8.9</a>.&nbsp;<a href="http://railstutorial.org/images/figures/initial_failed_signin_rails_3_bootstrap-full.png">(full size)</a></span></div></div>


<p>Carefully inspecting the debug information in <a class="ref" href="#fig:initial_failed_signin_rails_3">Figure&nbsp;8.5</a> shows that, as hinted at the end of <a class="ref" href="#sec:signin_form">Section&nbsp;8.1.3</a>, the submission results in a <code>params</code> hash containing the email and password under the key <code>:session</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sign in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div>
</div>


<p>As with the case of user signup (<a class="ref" href="#fig:signup_failure_rails_3">Figure&nbsp;7.15</a>) these parameters form a <em>nested</em> hash like the one we saw in <a class="ref" href="#code:nested_hashes">Listing&nbsp;4.6</a>. In particular, <code>params</code> contains a nested hash of the form</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session:</span> <span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>


<p>
This means that</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div>
</div>


<p>is itself a hash:</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>As a result,</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div>
</div>


<p>is the submitted email address and</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div>
</div>


<p>is the submitted password.</p>

<p>In other words, inside the <code>create</code> action the <code>params</code> hash has all the information needed to authenticate users by email and password. Not coincidentally, we already have exactly the methods we need: the <code>User.find_by_email</code> method provided by Active Record (<a class="ref" href="#sec:finding_user_objects">Section&nbsp;6.1.4</a>) and the  <code>authenticate</code> method provided by <code>has_secure_password</code> (<a class="ref" href="#sec:user_authentication">Section&nbsp;6.3.3</a>). Recalling that <code>authenticate</code> returns <code>false</code> for an invalid authentication, our strategy for user signin can be summarized as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># Sign the user in and redirect to the user&#39;s show page.</span>
  <span class="k">else</span>
    <span class="c1"># Create an error message and re-render the signin form.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The first line here pulls the user out of the database using the submitted email address. The next line is common in idiomatic Ruby:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>This uses <code>&amp;&amp;</code> (logical <em>and</em>) to determine if the resulting user is valid. Taking into account that any object other than <code>nil</code> and <code>false</code> itself is <code>true</code> in a boolean context (<a class="ref" href="#sec:objects_and_message_passing">Section&nbsp;4.2.3</a>), the possibilities appear as in <a class="ref" href="#table:user_and_and">Table&nbsp;8.2</a>. We see from <a class="ref" href="#table:user_and_and">Table&nbsp;8.2</a> that the <code>if</code> statement is <code>true</code> only if a user with the given email both exists in the database and has the given password, exactly as required.</p>

<div class="label" id="table:user_and_and"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>User</strong></th><th class="align_left"><strong>Password</strong></th><th class="align_left"><strong>a &amp;&amp; b</strong></th></tr><tr class="top_bar"><td class="align_left">nonexistent</td><td class="align_left"><em>anything</em></td><td class="align_left"><code>nil &amp;&amp; [anything] == false</code></td></tr><tr><td class="align_left">valid user</td><td class="align_left">wrong password</td><td class="align_left"><code>true &amp;&amp; false == false</code></td></tr><tr><td class="align_left">valid user</td><td class="align_left">right password</td><td class="align_left"><code>true &amp;&amp; true == true</code></td></tr></table></div><div class="caption"><span class="header">Table 8.2: </span><span class="description">Possible results of <code>user &amp;&amp; user.authenticate(&hellip;)</code>.</span></div></div>




<div class="label" id="sec:rendering_with_a_flash_message"></div>


<h3><a id="sec:8.1.5" href="#sec:rendering_with_a_flash_message" class="heading"><span class="number">8.1.5</span> Rendering with a flash message</a></h3>


<p>Recall from <a class="ref" href="#sec:signup_error_messages">Section&nbsp;7.3.2</a> that we displayed signup errors using the User model error messages. These errors are associated with a particular Active Record object, but this strategy won&rsquo;t work here because the session isn&rsquo;t an Active Record model. Instead, we&rsquo;ll put a message in the flash to be displayed upon failed signin. A first, slightly incorrect, attempt appears in <a class="ref" href="#code:failed_signin_attempt">Listing&nbsp;8.10</a>.</p>

<div class="label" id="code:failed_signin_attempt"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.10.</span> <span class="description">An (unsuccessful) attempt at handling failed signin. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user&#39;s show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span> <span class="c1"># Not quite right!</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Because of the flash message display in the site layout (<a class="ref" href="#code:layout_flash">Listing&nbsp;7.26</a>), the <code>flash[:error]</code> message automatically gets displayed; because of the Bootstrap CSS, it automatically gets nice styling (<a class="ref" href="#fig:failed_signin_flash">Figure&nbsp;8.6</a>).</p>

<div class="label" id="fig:failed_signin_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/failed_signin_flash_bootstrap.png" alt="failed_signin_flash_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.6: </span><span class="description">The flash message for a failed signin.&nbsp;<a href="http://railstutorial.org/images/figures/failed_signin_flash_bootstrap-full.png">(full size)</a></span></div></div>


<p>Unfortunately, as noted in the text and in the comment in <a class="ref" href="#code:failed_signin_attempt">Listing&nbsp;8.10</a>, this code isn&rsquo;t quite right. The page looks fine, though, so what&rsquo;s the problem? The issue is that the contents of the flash persist for one <em>request</em>, but&mdash;unlike a redirect, which we used in <a class="ref" href="#code:signup_flash">Listing&nbsp;7.27</a>&mdash;re-rendering a template with <code>render</code> doesn&rsquo;t count as a request. The result is that the flash message persists one request longer than we want. For example, if we submit invalid information, the flash is set and gets displayed on the signin page (<a class="ref" href="#fig:failed_signin_flash">Figure&nbsp;8.6</a>); if we then click on another page, such as the Home page, that&rsquo;s the first request since the form submission, and the flash gets displayed again (<a class="ref" href="#fig:flash_persistence">Figure&nbsp;8.7</a>).</p>

<div class="label" id="fig:flash_persistence"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/flash_persistence_bootstrap.png" alt="flash_persistence_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.7: </span><span class="description">An example of the flash persisting.&nbsp;<a href="http://railstutorial.org/images/figures/flash_persistence_bootstrap-full.png">(full size)</a></span></div></div>


<p>This flash persistence is a bug in our application, and before proceeding with a fix it is a good idea to write a test catching the error. In particular, the signin failure tests are currently passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>But the tests should never pass when there is a known bug, so we should add a failing test to catch it. Fortunately, dealing with a problem like flash persistence is one of many areas where integration tests really shine; they let us say exactly what we mean:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>After submitting invalid signin data, this test follows the Home link in the site layout and then requires that the flash error message not appear. The updated code, with the modified flash test, is shown in <a class="ref" href="#code:correct_signin_failure_test">Listing&nbsp;8.11</a>.</p>

<div class="label" id="code:correct_signin_failure_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.11.</span> <span class="description">Correct tests for signin failure. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The new test fails, as required:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>To get the failing test to pass, instead of <code>flash</code> we use <code>flash.now</code>, which is specifically designed for displaying flash messages on rendered pages; unlike the contents of <code>flash</code>, its contents disappear as soon as there is an additional request. The corrected application code appears in <a class="ref" href="#code:correct_signin_failure">Listing&nbsp;8.12</a>.</p>

<div class="label" id="code:correct_signin_failure"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.12.</span> <span class="description">Correct code for failed signin. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user&#39;s show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now the test suite for users with invalid information should be green:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:signin_success"></div>


<h2><a id="sec:8.2" href="#sec:signin_success" class="heading"><span class="number">8.2</span> Signin success</a></h2>


<p>Having handled a failed signin, we now need to actually sign a user in. Getting there will require some of the most challenging Ruby programming so far in this tutorial, so hang in there through the end and be prepared for a little heavy lifting. Happily, the first step is easy&mdash;completing the Sessions controller <code>create</code> action is a snap. Unfortunately, it&rsquo;s also a cheat.</p>

<p>Filling in the area now occupied by the signin comment (<a class="ref" href="#code:correct_signin_failure">Listing&nbsp;8.12</a>) is simple: upon successful signin, we sign the user in using the <code>sign_in</code> function, and then redirect to the profile page (<a class="ref" href="#code:sign_in_success_not_yet_working">Listing&nbsp;8.13</a>). We see now why this is a cheat: alas, <code>sign_in</code> doesn&rsquo;t currently exist. Writing it will occupy the rest of this section.</p>

<div class="label" id="code:sign_in_success_not_yet_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.13.</span> <span class="description">The completed Sessions controller <code>create</code> action (not yet working). <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:remember_me"></div>


<h3><a id="sec:8.2.1" href="#sec:remember_me" class="heading"><span class="number">8.2.1</span> Remember me</a></h3>


<p>We&rsquo;re now in a position to start implementing our signin model, namely, remembering user signin status &ldquo;forever&rdquo; and clearing the session only when the user explicitly signs out. The signin functions themselves will end up crossing the traditional Model-View-Controller lines; in particular, several signin functions will need to be available in both controllers and views. You may recall from <a class="ref" href="#sec:back_to_the_title_helper">Section&nbsp;4.2.5</a> that Ruby provides a <em>module</em> facility for packaging functions together and including them in multiple places, and that&rsquo;s the plan for the authentication functions. We could make an entirely new module for authentication, but the Sessions controller already comes equipped with a module, namely, <code>SessionsHelper</code>. Moreover, such helpers are automatically included in Rails views, so all we need to do to use the Sessions helper functions in controllers is to include the module into the Application controller (<a class="ref" href="#code:sessions_helper_include">Listing&nbsp;8.14</a>).</p>

<div class="label" id="code:sessions_helper_include"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.14.</span> <span class="description">Including the Sessions helper module into the Application controller. <br /> <code>app/controllers/application_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController::Base</span>
  <span class="n">protect_from_forgery</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By default, all the helpers are available in the views but not in the controllers. We need the methods from the Sessions helper in both places, so we have to include it explicitly.</p>

<p>Because HTTP is a <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state"><em>stateless protocol</em></a>, web applications requiring user signin must implement a way to track each user&rsquo;s progress from page to page. One technique for maintaining the user signin status is to use a traditional Rails session (via the special <code>session</code> function) to store a <em>remember token</em> equal to the user&rsquo;s id:</p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>


<p>This <code>session</code> object makes the user id available from page to page by storing it in a cookie that expires upon browser close. On each page, the application could simply call</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>to retrieve the user. Because of the way Rails handles sessions, this process is secure; if a malicious user tries to spoof the user id, Rails will detect a mismatch based on a special <em>session id</em> generated for each session.</p>

<p>For our application&rsquo;s design choice, which involves <em>persistent</em> sessions&mdash;that is, signin status that lasts even after browser close&mdash;we need to use a <em>permanent</em> identifier for the signed-in user. To accomplish this, we&rsquo;ll generate a unique, secure remember token for each user and store it as a <em>permanent</em> cookie rather than one that expires on browser close.</p>

<p>The remember token needs to be associated with a user and stored for future use, so we&rsquo;ll add it as an attribute to the User model, as shown in <a class="ref" href="#fig:user_model_remember_token">Figure&nbsp;8.8</a>.</p>

<div class="label" id="fig:user_model_remember_token"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_remember_token_31.png" alt="user_model_remember_token_31" /></span></div><div class="caption"><span class="header">Figure 8.8: </span><span class="description">The User model with an added <code>remember_token</code> attribute.</span></div></div>


<p>We&rsquo;ll start with a small addition to the User model specs (<a class="ref" href="#code:user_responds_to_remember_token">Listing&nbsp;8.15</a>).</p>

<div class="label" id="code:user_responds_to_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.15.</span> <span class="description">A first test for the remember token. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>  
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can get this test to pass by generating a remember token at the command line:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_token_to_users
</pre></div>
</div>


<p>Next we fill in the resulting migration with the code from <a class="ref" href="#code:add_remember_token_to_users">Listing&nbsp;8.16</a>. Note that, because we expect to retrieve users by remember token, we&rsquo;ve added an index (<a class="ref" href="#sidebar:database_indices">Box&nbsp;6.2</a>) to the <code>remember_token</code> column.</p>

<div class="label" id="code:add_remember_token_to_users"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.16.</span> <span class="description">A migration to add a <code>remember_token</code> to the <code>users</code> table. <br /> <code>db/migrate/[timestamp]_add_remember_token_to_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberTokenToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Next we update the development and test databases as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>At this point the User model specs should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>Now we have to decide what to use as a remember token. There are many mostly equivalent possibilities&mdash;essentially, any large random string will do just fine. In principle, since the user passwords are securely encrypted, we could use each user&rsquo;s <code>password_hash</code> attribute, but it seems like a terrible idea to unnecessarily expose our users&rsquo; passwords to potential attackers. We&rsquo;ll err on the side of caution and make a custom remember token using the <code>urlsafe_base64</code> method from the <code>SecureRandom</code> module in the Ruby standard library, which creates a <a href="http://en.wikipedia.org/wiki/Base64">Base64</a> string safe for use in URIs (and hence safe for use in cookies as well).<sup class="footnote" id="fnref:8.3"><a href="#fn:8.3">3</a></sup> As of this writing, <code>SecureRandom.urlsafe_base64</code> returns a random string of length 16 composed of the characters A&ndash;Z, a&ndash;z, 0&ndash;9, &ldquo;-&rdquo;, and &ldquo;_&rdquo; (for a total of 64 possibilities). This means that the probability of two remember tokens being the same is $1/64^{16} = 2^{-96} \approx 10^{-29}$, which is negligible.</p>

<p>We&rsquo;ll create a remember token using a <em>callback</em>, a technique introduced in <a class="ref" href="#sec:uniqueness_validation">Section&nbsp;6.2.5</a> in the context of email uniqueness. As in that section, we&rsquo;ll use a <code>before_save</code> callback, this time to create <code>remember_token</code> just before the user is saved.<sup class="footnote" id="fnref:8.4"><a href="#fn:8.4">4</a></sup> To test for this, we first save the test user and then check that the user&rsquo;s <code>remember_token</code> attribute isn&rsquo;t blank. This gives us sufficient flexibility to change the random string if we ever need to. The result appears in <a class="ref" href="#code:remember_token_should_not_be_blank">Listing&nbsp;8.17</a>.</p>

<div class="label" id="code:remember_token_should_not_be_blank"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.17.</span> <span class="description">A test for a valid (nonblank) remember token. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;remember token&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:remember_token_should_not_be_blank">Listing&nbsp;8.17</a> introduces the <code>its</code> method, which is like <code>it</code> but applies the subsequent test to the given attribute rather than the subject of the test. In other words,</p>

<div class="code"><div class="highlight"><pre><span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>is equivalent to</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">remember_token</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>The application code introduces several new elements. First, we add a callback method to create the remember token:</p>

<div class="code"><div class="highlight"><pre><span class="n">before_save</span> <span class="ss">:create_remember_token</span>
</pre></div>
</div>


<p>This arranges for Rails to look for a method called <code>create_remember_token</code> and run it before saving the user. Second, the method itself is only used internally by the User model, so there&rsquo;s no need to expose it to outside users. The Ruby way to accomplish this is to use the <code>private</code> keyword:</p>

<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_remember_token</span>
    <span class="c1"># Create the token.</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>All methods defined in a class after <code>private</code> are automatically hidden, so that</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_remember_token</span>
</pre></div>
</div>


<p>will raise a <code>NoMethodError</code> exception.</p>

<p>Finally, the <code>create_remember_token</code> method needs to <em>assign</em> to one of the user attributes, and in this context it is necessary to use the <code>self</code> keyword in front of <code>remember_token</code>:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_remember_token</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
<span class="k">end</span>
</pre></div>
</div>


<p>(<em>Note</em>: If you are using Ruby 1.8.7, you should use <code>SecureRandom.hex</code> here instead.) Because of the way Active Record synthesizes attributes based on database columns, without <code>self</code> the assignment would create a <em>local</em> variable called <code>remember_token</code>, which isn&rsquo;t what we want at all. Using <code>self</code> ensures that assignment sets the user&rsquo;s <code>remember_token</code> so that it will be written to the database along with the other attributes when the user is saved.</p>

<p>Putting this all together yields the User model shown in <a class="ref" href="#code:before_save_create_remember_token">Listing&nbsp;8.18</a>.</p>

<div class="label" id="code:before_save_create_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.18.</span> <span class="description">A <code>before_save</code> callback to create <code>remember_token</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">before_save</span> <span class="ss">:create_remember_token</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By the way, the extra level of indentation on <code>create_remember_token</code> is there to make it visually apparent which methods are defined after <code>private</code>.</p>

<p>Since the <code>SecureRandom.urlsafe_base64</code> string is definitely <em>not</em> blank, the tests for the User model should now be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<div class="label" id="sec:a_working_sign_in_method"></div>


<h3><a id="sec:8.2.2" href="#sec:a_working_sign_in_method" class="heading"><span class="number">8.2.2</span> A working <tt>sign_in</tt> method</a></h3>


<p>Now we&rsquo;re ready to write the first signin element, the <code>sign_in</code> function itself. As noted above, our desired authentication method is to place a remember token as a cookie on the user&rsquo;s browser, and then use the token to find the user record in the database as the user moves from page to page (implemented in <a class="ref" href="#sec:current_user">Section&nbsp;8.2.3</a>). The result, <a class="ref" href="#code:sign_in_function">Listing&nbsp;8.19</a>, introduces two new ideas: the <code>cookies</code> hash and <code>current_user</code>.</p>

<div class="label" id="code:sign_in_function"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.19.</span> <span class="description">The complete (but not-yet-working) <code>sign_in</code> function. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:sign_in_function">Listing&nbsp;8.19</a> introduces the <code>cookies</code> utility supplied by Rails. We can use <code>cookies</code> as if it were a hash; each element in the cookie is itself a hash of two elements, a <code>value</code> and an optional <code>expires</code> date. For example, we could implement user signin by placing a cookie with value equal to the user&rsquo;s remember token that expires 20 years from now:</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value:</span>   <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div>
</div>


<p>(This uses one of the convenient Rails time helpers, as discussed in <a class="ref" href="#sidebar:time_helpers">Box&nbsp;8.1</a>.)</p>

<div class="label" id="sidebar:time_helpers"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.1.</span><span class="description">Cookies expire <tt>20.years.from_now</tt></span></span>
<p>You may recall from <a class="ref" href="#sec:a_class_of_our_own">Section&nbsp;4.4.2</a> that Ruby lets you add methods to <em>any</em> class, even built-in ones. In that section, we added a <tt>palindrome?</tt> method to the <tt>String</tt> class (and discovered as a result that <tt>"deified"</tt> is a palindrome), and we also saw how Rails adds a <tt>blank?</tt> method to class <tt>Object</tt> (so that <tt>"".blank?</tt>, <tt>"&nbsp;".blank?</tt>, and <tt>nil.blank?</tt> are all <tt>true</tt>). The cookie code in <a class="ref" href="#code:sign_in_function">Listing&nbsp;8.19</a> (which internally sets a cookie that expires <tt>20.years.from_now</tt>) gives yet another example of this practice through one of Rails&rsquo; <em>time helpers</em>, which are methods added to <tt>Fixnum</tt> (the base class for numbers):</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</pre>


<p>Rails adds other helpers, too:</p>

<pre class="verbatim">  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>


<p>These are useful for upload validations, making it easy to restrict, say, image uploads to <tt>5.megabytes</tt>.</p>

<p>Though it must be used with caution, the flexibility to add methods to built-in classes allows for extraordinarily natural additions to plain Ruby. Indeed, much of the elegance of Rails ultimately derives from the malleability of the underlying Ruby language.</p>
</div>


<p>This pattern of setting a cookie that expires 20 years in the future became so common that Rails added a special <code>permanent</code> method to implement it, so that we can simply write</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</pre></div>
</div>


<p>Under the hood, using <code>permanent</code> causes Rails to set the expiration to <code>20.years.from_now</code> automatically.</p>

<p>After the cookie is set, on subsequent page views we can retrieve the user with code like</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>Of course, <code>cookies</code> isn&rsquo;t <em>really</em> a hash, since assigning to <code>cookies</code> actually <em>saves</em> a piece of text on the browser, but part of the beauty of Rails is that it lets you forget about that detail and concentrate on writing the application.</p>

<p>You may be aware that storing authentication cookies on a user&rsquo;s browser and transmitting them over the network exposes an application to a <a href="http://en.wikipedia.org/wiki/Session_hijacking"><em>session hijacking</em></a> attack, which involves copying the remember token and using it to sign in as the corresponding user. This attack was publicized by the <a href="http://codebutler.com/firesheep">Firesheep</a> application, which showed that many high-profile sites (including Facebook and Twitter) were vulnerable. The solution is to use site-wide SSL as described in <a class="ref" href="#sec:deploying_to_production_with_ssl">Section&nbsp;7.4.4</a>.</p>

<div class="label" id="sec:current_user"></div>


<h3><a id="sec:8.2.3" href="#sec:current_user" class="heading"><span class="number">8.2.3</span> Current user</a></h3>


<p>Having discussed how to store the user&rsquo;s remember token in a cookie for later use, we now need to learn how to retrieve the user on subsequent page views. Let&rsquo;s look again at the <code>sign_in</code> function to see where we are:</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Our focus now is the second line:</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>The purpose of this line is to create <code>current_user</code>, accessible in both controllers and views, which will allow constructions such as</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div>
</div>


<p>The use of <code>self</code> is necessary in this context for the same essential reason noted in the discussion leading up to <a class="ref" href="#code:before_save_create_remember_token">Listing&nbsp;8.18</a>: without <code>self</code>, Ruby would simply create a local variable called <code>current_user</code>.</p>

<p>To start writing the code for <code>current_user</code>, note that the line</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>is an <em>assignment</em>, which we must define. Ruby has a special syntax for defining such an assignment function, shown in <a class="ref" href="#code:current_user_equals">Listing&nbsp;8.20</a>.</p>

<div class="label" id="code:current_user_equals"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.20.</span> <span class="description">Defining assignment to <code>current_user</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This might look confusing&mdash;most languages don&rsquo;t let you use the equals sign in a method definition&mdash;but it simply defines a method <code>current_user=</code> expressly designed to handle assignment to <code>current_user</code>. In other words, the code</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div>
</div>


<p>is automatically converted to</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>thereby invoking the <code>current_user=</code> method. Its one argument is the right-hand side of the assignment, in this case the user to be signed in. The one-line method body just sets an instance variable <code>@current_user</code>, effectively storing the user for later use.</p>

<p>In ordinary Ruby, we could define a second method, <code>current_user</code>, designed to return the value of <code>@current_user</code>, as shown in  <a class="ref" href="#code:current_user_wrong">Listing&nbsp;8.21</a>.</p>

<div class="label" id="code:current_user_wrong"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.21.</span> <span class="description">A tempting but useless definition for <code>current_user</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span>     <span class="c1"># Useless! Don&#39;t use this line.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>If we did this, we would effectively replicate the functionality of <code>attr_accessor</code>, which we saw in <a class="ref" href="#sec:a_user_class">Section&nbsp;4.4.5</a>.<sup class="footnote" id="fnref:8.5"><a href="#fn:8.5">5</a></sup> The problem is that it utterly fails to solve our problem: with the code in <a class="ref" href="#code:current_user_wrong">Listing&nbsp;8.21</a>, the user&rsquo;s signin status would be forgotten: as soon as the user went to another page&mdash;<em>poof!</em>&mdash;the session would end and the user would be automatically signed out.
To avoid this problem, we can find the user corresponding to the remember token created by the code in <a class="ref" href="#code:sign_in_function">Listing&nbsp;8.19</a>, as shown in <a class="ref" href="#code:current_user_working">Listing&nbsp;8.22</a>.</p>

<div class="label" id="code:current_user_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.22.</span> <span class="description">Finding the current user using the <code>remember_token</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:current_user_working">Listing&nbsp;8.22</a> uses the common but initially obscure <code>||=</code> (&ldquo;or equals&rdquo;) assignment operator (<a class="ref" href="#sidebar:or_equals">Box&nbsp;8.2</a>). Its effect is to set the <code>@current_user</code> instance variable to the user corresponding to the remember token, but only if <code>@current_user</code> is undefined.<sup class="footnote" id="fnref:8.6"><a href="#fn:8.6">6</a></sup> In other words, the construction</p>

<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>calls the <code>find_by_remember_token</code> method the first time <code>current_user</code> is called, but on subsequent invocations returns <code>@current_user</code> without hitting the database.<sup class="footnote" id="fnref:8.7"><a href="#fn:8.7">7</a></sup> This is only useful if <code>current_user</code> is used more than once for a single user request; in any case, <code>find_by_remember_token</code> will be called at least once every time a user visits a page on the site.</p>

<div class="label" id="sidebar:or_equals"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.2.</span><span class="description">What the *$@! is <tt>||=</tt> ? </span></span>
<p>The <tt>||=</tt> construction is very Rubyish&mdash;that is, it is highly characteristic of the Ruby language&mdash;and hence important to learn if you plan on doing much Ruby programming. Though at first it may seem mysterious, <em>or equals</em> is easy to understand by analogy.</p>

<p>We start by noting a common idiom for changing a currently defined variable. Many computer programs involve incrementing a variable, as in</p>

<pre class="verbatim">  x = x + 1</pre>


<p>Most languages provide a syntactic shortcut for this operation; in Ruby (and in C, C++, Perl, Python, Java, etc.), it appears as follows:</p>

<pre class="verbatim">  x += 1</pre>


<p>Analogous constructs exist for other operators as well:</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 7
  =&gt; -1</pre>


<p>In each case, the pattern is that <tt>x = x O y</tt> and <tt>x O= y</tt> are equivalent for any operator <tt>O</tt>.</p>

<p>Another common Ruby pattern is assigning to a variable if it&rsquo;s <tt>nil</tt> but otherwise leaving it alone. Recalling the <em>or</em>&nbsp;operator <tt>||</tt> seen in <a class="ref" href="#sec:objects_and_message_passing">Section&nbsp;4.2.3</a>, we can write this as follows:</p>

<pre class="verbatim">  &gt;&gt; @user
  =&gt; nil
  &gt;&gt; @user = @user || &quot;the user&quot;
  =&gt; &quot;the user&quot;
  &gt;&gt; @user = @user || &quot;another user&quot;
  =&gt; &quot;the user&quot;</pre>


<p>Since <tt>nil</tt> is false in a boolean context, the first assignment is <tt>nil || "the user"</tt>, which evaluates to <tt>"the user"</tt>; similarly, the second assignment is <tt>"the user" || "another user"</tt>, which also evaluates to <tt>"the user"</tt>&mdash;since strings are <tt>true</tt> in a boolean context, the series of <tt>||</tt> expressions terminates after the first expression is evaluated. (This practice of evaluating <tt>||</tt> expressions from left to right and stopping on the first true value is known as <em>short-circuit evaluation</em>.)</p>

<p>Comparing the console sessions for the various operators, we see that <tt>@user = @user || value</tt> follows the <tt>x = x O y</tt> pattern with <tt>||</tt> in the place of <tt>O</tt>, which suggests the following equivalent construction:</p>

<pre class="verbatim">  &gt;&gt; @user ||= &quot;the user&quot;
  =&gt; &quot;the user&quot;</pre>


<p>Voil&agrave;&nbsp;!</p>
</div>




<div class="label" id="sec:changing_the_layout_links"></div>


<h3><a id="sec:8.2.4" href="#sec:changing_the_layout_links" class="heading"><span class="number">8.2.4</span> Changing the layout links</a></h3>


<p>We come finally to a practical application of all our signin/out work: we&rsquo;ll change the layout links based on signin status. In particular, as seen in the <a class="ref" href="#fig:signin_success_mockup">Figure&nbsp;8.3</a> mockup, we&rsquo;ll arrange for the links to change when users sign in or sign out, and we&rsquo;ll also add links for listing all users and user settings (to be completed in <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>) and one for the current user&rsquo;s profile page. In doing so, we&rsquo;ll get the tests in <a class="ref" href="#code:signin_success_tests">Listing&nbsp;8.6</a> to pass, which means our test suite will be green for the first time since the beginning of the chapter.</p>

<p>The way to change the links in the site layout involves using an
if-else branching structure inside of Embedded Ruby:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  # Links for signed-in users
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  # Links for non-signed-in-users
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This kind of code requires the existence of a <code>signed_in?</code> boolean, which we&rsquo;ll now define.</p>

<p>A user is signed in if there is a current user in the session, i.e., if <code>current_user</code> is non-<code>nil</code>. This requires the use of the &ldquo;not&rdquo; operator, written using an exclamation point&nbsp;<code>!</code> and usually read as &ldquo;bang&rdquo;. In the present context, a user is signed in if <code>current_user</code> is <em>not</em> <code>nil</code>, as shown in <a class="ref" href="#code:signed_in_p">Listing&nbsp;8.23</a>.</p>

<div class="label" id="code:signed_in_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.23.</span> <span class="description">The <code>signed_in?</code> helper method. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the <code>signed_in?</code> method in hand, we&rsquo;re ready to finish the layout links. There are four new links, two of which are stubbed out (to be completed in <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>):</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The signout link, meanwhile, uses the signout path defined in <a class="ref" href="#code:sessions_resource">Listing&nbsp;8.2</a>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>(Notice that the signout link passes a hash argument indicating that it should submit with an HTTP <tt>DELETE</tt> request.<sup class="footnote" id="fnref:8.8"><a href="#fn:8.8">8</a></sup>) Finally, we&rsquo;ll add a profile link as follows:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Here we could write</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>but Rails allows us to link directly to the user, in this context automatically converting <code>current_user</code> into <code>user_path(current_user)</code>.</p>

<p>In the process of putting the new links into the layout, we&rsquo;ll take advantage of Bootstrap&rsquo;s ability to make dropdown menus, which you can read more about on the <a href="http://twitter.github.com/bootstrap/components.html">Bootstrap components page</a>. The full result appears in <a class="ref" href="#code:layout_signin_signout_links">Listing&nbsp;8.24</a>. Note in particular the CSS&nbsp;ids and classes related to the Bootstrap dropdown menu.</p>

<div class="label" id="code:layout_signin_signout_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.24.</span> <span class="description">Changing the layout links for signed-in users. <br /> <code>app/views/layouts/_header.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>The dropdown menu requires the use of Bootstrap&rsquo;s JavaScript library, which we can include using the Rails asset pipeline by editing the application JavaScript file, as shown in <a class="ref" href="#code:bootstrap_js">Listing&nbsp;8.25</a>.</p>

<div class="label" id="code:bootstrap_js"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.25.</span> <span class="description">Adding the Bootstrap JavaScript library to <code>application.js</code>. <br /> <code>app/assets/javascripts/application.js</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require bootstrap</span>
<span class="c1">//= require_tree .</span>
</pre></div>
</div></div>


<p>This uses the Sprockets library to include the Bootstrap JavaScript, which in turn is available thanks to the <tt>bootstrap-sass</tt> gem from <a class="ref" href="#sec:custom_css">Section&nbsp;5.1.2</a>.</p>

<p>With the code in <a class="ref" href="#code:layout_signin_signout_links">Listing&nbsp;8.24</a>, all the tests should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Unfortunately, if you actually examine the application in the browser, you&rsquo;ll see that it doesn&rsquo;t yet work. This is because the &ldquo;remember me&rdquo; functionality requires the user to have a remember token, but the current user doesn&rsquo;t have one: we created the first user back in <a class="ref" href="#sec:the_first_signup">Section&nbsp;7.4.3</a>, long before implementing the callback that sets the remember token. To fix this, we need to save each user to invoke the <code>before_save</code> callback defined in <a class="ref" href="#code:before_save_create_remember_token">Listing&nbsp;8.18</a>, which creates a remember token as a side-effect:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">validate:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; &quot;Im9P0kWtZvD0RdyiK9UHtg&quot;</span>
</pre></div>
</div>


<p>Here we&rsquo;ve iterated over all the users in case you added more than one while playing with the signup form. Note that we&rsquo;ve passed an option to the <code>save</code> method; as currently written, <code>save</code> by itself wouldn&rsquo;t work because we haven&rsquo;t included the password or its confirmation. Indeed, for a real site we wouldn&rsquo;t even know any of the passwords, but we would still want to be able to save the users. The solution is to pass <code>validate: false</code> to tell Active Record skip the validations (<a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveRecord/Persistence.html#method-i-save">Rails API <tt>save</tt></a>).</p>

<p>With that change, a signed-in user now sees the new links and dropdown menu defined by <a class="ref" href="#code:layout_signin_signout_links">Listing&nbsp;8.24</a>, as shown in <a class="ref" href="#fig:profile_with_signout_link">Figure&nbsp;8.9</a>.</p>

<div class="label" id="fig:profile_with_signout_link"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_with_signout_link_bootstrap.png" alt="profile_with_signout_link_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.9: </span><span class="description">A signed-in user with new links and a dropdown menu.&nbsp;<a href="http://railstutorial.org/images/figures/profile_with_signout_link_bootstrap-full.png">(full size)</a></span></div></div>


<p>At this point, you should verify that you can sign in, close the browser, and then still be signed in when you visit the sample application. If you want, you can even inspect the browser cookies to see the result directly (<a class="ref" href="#fig:cookie_in_browser">Figure&nbsp;8.10</a>).</p>

<div class="label" id="fig:cookie_in_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/cookie_in_browser.png" alt="cookie_in_browser" /></span></div><div class="caption"><span class="header">Figure 8.10: </span><span class="description">The remember token cookie in the local browser.&nbsp;<a href="http://railstutorial.org/images/figures/cookie_in_browser-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:signin_upon_signup"></div>


<h3><a id="sec:8.2.5" href="#sec:signin_upon_signup" class="heading"><span class="number">8.2.5</span> Signin upon signup</a></h3>


<p>In principle, although we are now done with authentication, newly registered users might be confused, as they are not signed in by default. Implementing this is the last bit of polish before letting users sign out. We&rsquo;ll start by adding a line to the authentication tests (<a class="ref" href="#code:sign_up_sign_in">Listing&nbsp;8.26</a>). This includes the &ldquo;after saving the user&rdquo; <code>describe</code> block from <a class="ref" href="#code:after_save_tests">Listing&nbsp;7.32</a> (<a class="ref" href="#sec:signup_exercises">Section&nbsp;7.6</a>), which you should add to the test now if you didn&rsquo;t already do the corresponding exercise.</p>

<div class="label" id="code:sign_up_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.26.</span> <span class="description">Testing that newly signed-up users are also signed in. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we&rsquo;ve tested the appearance of the signout link to verify that the user was successfully signed in after signing up.</p>

<p>With the <code>sign_in</code> method from <a class="ref" href="#sec:signin_success">Section&nbsp;8.2</a>, getting this test to pass by actually signing in the user is easy: just add <code>sign_in @user</code> right after saving the user to the database (<a class="ref" href="#code:signin_upon_signup">Listing&nbsp;8.27</a>).</p>

<div class="label" id="code:signin_upon_signup"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.27.</span> <span class="description">Signing in the user upon signup. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:signing_out"></div>


<h3><a id="sec:8.2.6" href="#sec:signing_out" class="heading"><span class="number">8.2.6</span> Signing out</a></h3>


<p>As discussed in <a class="ref" href="#sec:signin_failure">Section&nbsp;8.1</a>, our authentication model is to keep users signed in until they sign out explicitly. In this section, we&rsquo;ll add this necessary signout capability.</p>

<p>So far, the Sessions controller actions have followed the RESTful convention of using <code>new</code> for a signin page and <code>create</code> to complete the signin. We&rsquo;ll continue this theme by using a <code>destroy</code> action to delete sessions, i.e., to sign out. To test this, we&rsquo;ll click on the &ldquo;Sign out&rdquo; link and then look for the reappearance of the signin link (<a class="ref" href="#code:signout_test">Listing&nbsp;8.28</a>).</p>

<div class="label" id="code:signout_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.28.</span> <span class="description">A test for signing out a user. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;followed by signout&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Sign out&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As with user signin, which relied on the <code>sign_in</code> function, user signout just defers to a <code>sign_out</code> function (<a class="ref" href="#code:destroy_session">Listing&nbsp;8.29</a>).</p>

<div class="label" id="code:destroy_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.29.</span> <span class="description">Destroying a session (user signout). <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">sign_out</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As with the other authentication elements, we&rsquo;ll put <code>sign_out</code> in the Sessions helper module. The implementation is simple: we set the current user to <code>nil</code> and use the <code>delete</code> method on cookies to remove the remember token from the session (<a class="ref" href="#code:sign_out_method">Listing&nbsp;8.30</a>). (Setting the current user to <code>nil</code> isn&rsquo;t currently necessary because of the immediate redirect in the <code>destroy</code> action, but it&rsquo;s a good idea in case we ever want to use <code>sign_out</code> without a redirect.)</p>

<div class="label" id="code:sign_out_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.30.</span> <span class="description">The <code>sign_out</code> method in the Sessions helper module. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">sign_out</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This completes the signup/signin/signout triumvirate, and the test suite should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/ 
</pre></div>
</div>


<p>It&rsquo;s worth noting that our test suite covers most of the authentication machinery, but not all of it. For instance, we don&rsquo;t test how long the &ldquo;remember me&rdquo; cookie lasts or whether it gets set at all. It is possible to do so, but experience shows that direct tests of cookie values are brittle and have a tendency to rely on implementation details that sometimes change from one Rails release to the next. The result is breaking tests for application code that still works fine. By focusing on high-level functionality&mdash;verifying that users can sign in, stay signed in from page to page, and can sign out&mdash;we test the core application code without focusing on less important details.</p>

<div class="label" id="sec:cucumber"></div>


<h2><a id="sec:8.3" href="#sec:cucumber" class="heading"><span class="number">8.3</span> Introduction to Cucumber (optional)</a></h2>


<p>Having finished the foundation of the sample application&rsquo;s authentication system, we&rsquo;re going to take this opportunity to show how to write signin tests using <a href="http://cukes.info">Cucumber</a>, a popular tool for behavior-driven development that enjoys significant popularity in the Ruby community. This section is optional and can be skipped without loss of continuity.</p>

<p>Cucumber allows the definition of plain-text <em>stories</em> describing application behavior. Many Rails programmers find Cucumber especially convenient when doing client work; since they can be read even by non-technical users, Cucumber tests can be shared with (and can sometimes even be written by) the client. Of course, using a testing framework that isn&rsquo;t pure Ruby has a downside, and I find that the plain-text stories can be a bit verbose. Nevertheless, Cucumber does have a place in the Ruby testing toolkit, and I especially like its emphasis on high-level behavior over low-level implementation.</p>

<p>Since the emphasis in this book is on RSpec and Capybara, the presentation that follows is necessarily superficial and incomplete, and will be a bit light on explanation. Its purpose is just to give you a taste of Cucumber (crisp and juicy, no doubt)&mdash;if it strikes your fancy, there are entire books on the subject waiting to satisfy your appetite. (I particularly recommend <a href="http://www.amazon.com/gp/product/1934356379"><em>The RSpec Book</em></a> by David Chelimsky, <a href="http://www.amazon.com/gp/product/1935182277"><em>Rails 3 in Action</em></a> by Ryan Bigg and Yehuda Katz, and <a href="http://www.amazon.com/gp/product/1934356808"><em>The Cucumber Book</em></a> by Matt Wynne and Aslak Helles&oslash;y.)</p>

<div class="label" id="sec:installation_and_setup"></div>


<h3><a id="sec:8.3.1" href="#sec:installation_and_setup" class="heading"><span class="number">8.3.1</span> Installation and setup</a></h3>


<p>To install Cucumber, first add the <tt>cucumber-rails</tt> gem and a utility gem called <tt>database_cleaner</tt> to the <code>:test</code> group in the <code>Gemfile</code> (<a class="ref" href="#code:cucumber_rails">Listing&nbsp;8.31</a>).</p>

<div class="label" id="code:cucumber_rails"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.31.</span> <span class="description">Adding the <tt>cucumber-rails</tt> gem to the <code>Gemfile.</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.0&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then install as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>To set up the application to use Cucumber, we next generate some necessary support files and directories:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate cucumber:install
</pre></div>
</div>


<p>This creates a <code>features/</code> directory where the files associated with Cucumber will live.</p>

<div class="label" id="sec:features_and_steps"></div>


<h3><a id="sec:8.3.2" href="#sec:features_and_steps" class="heading"><span class="number">8.3.2</span> Features and steps</a></h3>


<p>Cucumber features are descriptions of expected behavior using a plain-text  language called <a href="https://github.com/cucumber/gherkin">Gherkin</a>. Gherkin tests read much like well-written RSpec examples, but because they are plain-text they are more accessible to those more comfortable reading English than Ruby code.</p>

<p>Our Cucumber features will implement a subset of the signin examples in <a class="ref" href="#code:initial_failing_signin_test">Listing&nbsp;8.5</a> and <a class="ref" href="#code:signin_success_tests">Listing&nbsp;8.6</a>. To get started, we&rsquo;ll create a file in the <code>features/</code> directory called <code>signing_in.feature</code>.</p>

<p>Cucumber features start with a short description of the feature, as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
</pre></div>
</div>


<p>Then they add individual <em>scenarios</em>. For example, to test unsuccessful signin, we could write the following scenario:</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>Similarly, to test successful signin, we could add this:</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div>


<p>Collecting these together yields the Cucumber feature file shown in  <a class="ref" href="#code:signin_features">Listing&nbsp;8.32</a>.</p>

<div class="label" id="code:signin_features"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.32.</span> <span class="description">Cucumber features to test user signin. <br /> <code>features/signing_in.feature</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div></div>


<p>To run the features, we use the <code>cucumber</code> executable:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>Compare this to</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>In this context, it&rsquo;s worth noting that, like RSpec, Cucumber can be invoked using a Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake cucumber
</pre></div>
</div>


<p>(For reasons that escape me, this is sometimes written as <code>rake cucumber:ok</code>.)</p>

<p>All we&rsquo;ve done so far is write some plain text, so it shouldn&rsquo;t be surprising that the Cucumber scenarios aren&rsquo;t yet passing. To get the test suite to green, we need to add a <em>step</em> file that maps the plain-text lines to Ruby code. The step file goes in the <code>features/step_definitions</code> directory; we&rsquo;ll call it <code>authentication_steps.rb</code>.</p>

<p>The <code>Feature</code> and <code>Scenario</code> lines are mainly for documentation, but each of the other lines needs some corresponding Ruby. For example, the line</p>

<div class="code"><div class="highlight"><pre><span class="k">Given </span><span class="nf">a user visits the signin page</span>
</pre></div>
</div>


<p>in the feature file gets handled by the step definition</p>

<div class="code"><div class="highlight"><pre><span class="no">Given</span><span class="sr"> /^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In the feature, <code>Given</code> is just a string, but in the step file <code>Given</code> is a <em>method</em> that takes a regular expression and a block. The regex matches the text of the line in the scenario, and the contents of the block are the Ruby code needed to implement the step. In this case, &ldquo;a user visits the signin page&rdquo; is implemented by</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>If this looks familiar, it should: it&rsquo;s just Capybara, which is included by default in Cucumber step files. The next two lines should also look familiar; the scenario steps</p>

<div class="code"><div class="highlight"><pre><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>in the feature file are handled by these steps:</p>

<div class="code"><div class="highlight"><pre><span class="no">When</span><span class="sr"> /^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span><span class="sr"> /^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The first step also uses Capybara, while the second uses Capybara&rsquo;s <code>page</code> object with RSpec. Evidently, all the testing work we&rsquo;ve done so far with RSpec and Capybara is also useful with Cucumber.</p>

<p>The rest of the steps proceed similarly. The final step definition file appears in <a class="ref" href="#code:authentication_steps">Listing&nbsp;8.33</a>. Try adding one step at a time, running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>each time until the tests pass.</p>

<div class="label" id="code:authentication_steps"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.33.</span> <span class="description">The complete steps needed to get the signin features to pass. <br /> <code>features/step_definitions/authentication_steps.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">Given</span><span class="sr"> /^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>

<span class="no">When</span><span class="sr"> /^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span><span class="sr"> /^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Given</span><span class="sr"> /^the user has an account$/</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                      <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">When</span><span class="sr"> /^the user submits valid signin information$/</span> <span class="k">do</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> 
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span><span class="sr"> /^he should see his profile page$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Then</span><span class="sr"> /^he should see a signout link$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the code in <a class="ref" href="#code:authentication_steps">Listing&nbsp;8.33</a>, the Cucumber tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>




<div class="label" id="sec:rspec_custom_matchers"></div>


<h3><a id="sec:8.3.3" href="#sec:rspec_custom_matchers" class="heading"><span class="number">8.3.3</span> Counterpoint: RSpec custom matchers</a></h3>


<p>Having written some simple Cucumber scenarios, it&rsquo;s worth comparing the result to the equivalent RSpec examples. First, take a look at the Cucumber feature in <a class="ref" href="#code:signin_features">Listing&nbsp;8.32</a> and the corresponding step definitions in <a class="ref" href="#code:authentication_steps">Listing&nbsp;8.33</a>. Then take a look at the RSpec request specs (integration tests):</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span> 

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>You can see how a case could be made for either Cucumber or integration tests. Cucumber features are easily readable, but they are entirely separate from the code that implements them&mdash;a property that cuts both ways. I find that Cucumber is easy to read and awkward to write, while integration tests are (for a programmer) a little harder to read and <em>much</em> easier to write.</p>

<p>One nice effect of Cucumber&rsquo;s separation of concerns is that it operates at a higher level of abstraction. For example, we write</p>

<div class="code"><div class="highlight"><pre><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>to express the expectation of seeing an error message, and</p>

<div class="code"><div class="highlight"><pre><span class="no">Then</span><span class="sr"> /^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>to implement the test. What&rsquo;s especially convenient about this is that only the second element (the step) is dependent on the implementation, so that if we change, e.g., the CSS class used for error messages, the feature file would stay the same.</p>

<p>In this vein, it might make you unhappy to write</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>in a bunch of places, when what you really want is to indicate that the page should have an error message. This practice couples the test tightly to the implementation, and we would have to change it everywhere if the implementation changed. In the context of pure RSpec, there is a solution, which is to use a <em>custom matcher</em>, allowing us to write the following instead:</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>We can define such a matcher in the same utilities file where we put the <code>full_title</code> test helper in <a class="ref" href="#sec:pretty_rspec">Section&nbsp;5.3.4</a>. The code itself looks like this:</p>

<div class="code"><div class="highlight"><pre><span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We can also define helper functions for common operations:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The resulting support code is shown in <a class="ref" href="#code:have_error_message">Listing&nbsp;8.34</a> (which incorporates the results of <a class="ref" href="#code:full_title_helper_tests">Listing&nbsp;5.37</a> and <a class="ref" href="#code:rspec_utilities_simplified">Listing&nbsp;5.38</a> from <a class="ref" href="#sec:layout_exercises">Section&nbsp;5.6</a>). I find this approach to be more flexible than Cucumber step definitions, particularly when the matchers or should helpers naturally take an argument, such as <code>valid_signin(user)</code>. Step definitions can replicate this functionality with regex matchers, but I generally find this approach to be more (cu)cumbersome.</p>

<div class="label" id="code:have_error_message"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.34.</span> <span class="description">Adding a helper method and a custom RSpec matcher. <br /> <code>spec/support/utilities.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>

<span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the code in <a class="ref" href="#code:have_error_message">Listing&nbsp;8.34</a>, we can write</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>There are many other examples of coupling between our tests and the site&rsquo;s implementation. Sweeping through the current test suite and decoupling the tests from the implementation details by making custom matchers and methods is left as an exercise (<a class="ref" href="#sec:sign_in_out_exercises">Section&nbsp;8.5</a>).</p>

<h2><a id="sec:8.4" href="#sec:8.4" class="heading"><span class="number">8.4</span> Conclusion</a></h2>


<p>We&rsquo;ve covered a lot of ground in this chapter, transforming our promising but unformed application into a site capable of the full suite of registration and login behaviors. All that is needed to complete the authentication functionality is to restrict access to pages based on signin status and user identity. We&rsquo;ll accomplish this task en route to giving users the ability to edit their information and giving administrators the ability to remove users from the system, which are the main goals of <a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a>.</p>

<p>Before moving on, merge your changes back into the master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish sign in&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-in-out
</pre></div>
</div>


<p>Then push up the remote GitHub repository and the Heroku production server:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>If you&rsquo;ve created any users on the production server, I recommend following the steps in <a class="ref" href="#sec:changing_the_layout_links">Section&nbsp;8.2.4</a> to give each user a valid remember token. The only difference is using the Heroku console instead of the local one:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run console
<span class="gp">&gt;</span>&gt; User.all.each <span class="o">{</span> |user| user.save<span class="o">(</span>validate: <span class="nb">false</span><span class="o">)</span> <span class="o">}</span>
</pre></div>
</div>


<div class="label" id="sec:sign_in_out_exercises"></div>


<h2><a id="sec:8.5" href="#sec:sign_in_out_exercises" class="heading"><span class="number">8.5</span> Exercises</a></h2>




<ol>

<li>Refactor the signin form to use <code>form_tag</code> in place of <code>form_for</code>. Make sure the test suite still passes. <em>Hint</em>: See the <a href="http://railscasts.com/episodes/270-authentication-in-rails-3-1">RailsCast on authentication in Rails&nbsp;3.1</a>, and note in particular the change in the structure of the <code>params</code> hash.</li>

<li>Following the example in <a class="ref" href="#sec:rspec_custom_matchers">Section&nbsp;8.3.3</a>, go through the user and authentication request specs (i.e., the files currently in the <code>spec/requests</code> directory) and define utility functions in <code>spec/support/utilities.rb</code> to decouple the tests from the implementation. <em>Extra credit:</em> Organize the support code into separate files and modules, and get everything to work by including the modules properly in the spec helper file.</li>

</ol>




<div class="footnotes">
<ol>
<li id="fn:8.1">Another common model is to expire the session after a certain amount of time. This is especially appropriate on sites containing sensitive information, such as banking and financial trading accounts.&nbsp;<a class="arrow" href="#fnref:8.1">&uarr;</a></li>
<li id="fn:8.2">Image from <a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>.&nbsp;<a class="arrow" href="#fnref:8.2">&uarr;</a></li>
<li id="fn:8.3">This choice is based on the <a href="http://railscasts.com/episodes/274-remember-me-reset-password">RailsCast on remember me</a>.&nbsp;<a class="arrow" href="#fnref:8.3">&uarr;</a></li>
<li id="fn:8.4">For more details on the kind of callbacks supported by Active Record, see the <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#callbacks-overview">discussion of callbacks at the Rails Guides</a>.&nbsp;<a class="arrow" href="#fnref:8.4">&uarr;</a></li>
<li id="fn:8.5">In fact, the two are exactly equivalent; <code>attr_accessor</code> is merely a convenient way to create just such getter/setter methods automatically.&nbsp;<a class="arrow" href="#fnref:8.5">&uarr;</a></li>
<li id="fn:8.6">Typically, this means assigning to variables that are initially <code>nil</code>, but note that <code>false</code> values will also be overwritten by the <code>||=</code> operator.&nbsp;<a class="arrow" href="#fnref:8.6">&uarr;</a></li>
<li id="fn:8.7">This is an example of <em>memoization</em>, which we discussed before in <a class="ref" href="#sidebar:let">Box&nbsp;6.3</a>.&nbsp;<a class="arrow" href="#fnref:8.7">&uarr;</a></li>
<li id="fn:8.8">Web browsers can&rsquo;t actually issue <tt>DELETE</tt> requests; Rails fakes it with JavaScript.&nbsp;<a class="arrow" href="#fnref:8.8">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:updating_showing_and_deleting_users"></div>


<h1 class="chapter"><a id="sec:9" href="#cha:updating_showing_and_deleting_users" class="heading"><span class="number">Chapter 9</span> Updating, showing, and deleting users</a></h1>


<p>In this chapter, we will complete the REST actions for the Users resource (<a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>) by adding <code>edit</code>, <code>update</code>, <code>index</code>, and <code>destroy</code> actions. We&rsquo;ll start by giving users the ability to update their profiles, which will also provide a natural opportunity to enforce a security model (made possible by the authorization code in <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>). Then we&rsquo;ll make a listing of all users (also requiring authorization), which will motivate the introduction of sample data and pagination. Finally, we&rsquo;ll add the ability to destroy users, wiping them clear from the database. Since we can&rsquo;t allow just any user to have such dangerous powers, we&rsquo;ll take care to create a privileged class of administrative users (admins) authorized to delete other users.</p>

<p>To get started, let&rsquo;s start work on an <code>updating-users</code> topic branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div>
</div>


<div class="label" id="sec:updating_users"></div>


<h2><a id="sec:9.1" href="#sec:updating_users" class="heading"><span class="number">9.1</span> Updating users</a></h2>


<p>The pattern for editing user information closely parallels that for creating new users (<a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>). Instead of a <code>new</code> action rendering a view for new users, we have an <code>edit</code> action rendering a view to edit users; instead of <code>create</code> responding to a <tt>POST</tt> request, we have an <code>update</code> action responding to a <tt>PUT</tt> request (<a class="ref" href="#sidebar:get_etc">Box&nbsp;3.2</a>). The biggest difference is that, while anyone can sign up, only the current user should be able to update his information. This means that we need to enforce access control so that only authorized users can edit and update; the authentication machinery from <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a> will allow us to use a <em>before filter</em> to ensure that this is the case.</p>

<div class="label" id="sec:edit_form"></div>


<h3><a id="sec:9.1.1" href="#sec:edit_form" class="heading"><span class="number">9.1.1</span> Edit form</a></h3>


<p>We start with the edit form, whose mockup appears in <a class="ref" href="#fig:edit_user_mockup">Figure&nbsp;9.1</a>.<sup class="footnote" id="fnref:9.1"><a href="#fn:9.1">1</a></sup> As usual, we&rsquo;ll begin with some tests. First, note the link to change the Gravatar image; if you poke around the Gravatar site, you&rsquo;ll see that the page to add or edit images is located at <a href="http://gravatar.com/emails">http://gravatar.com/emails</a>, so we test the <code>edit</code> page for a link with that URI.<sup class="footnote" id="fnref:9.2"><a href="#fn:9.2">2</a></sup></p>

<div class="label" id="fig:edit_user_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_user_mockup_bootstrap.png" alt="edit_user_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.1: </span><span class="description">A mockup of the user edit page.&nbsp;<a href="http://railstutorial.org/images/figures/edit_user_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>The tests for the edit user form are analogous to the test for the new user form in <a class="ref" href="#code:error_messages_test">Listing&nbsp;7.31</a> from the <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a> exercises, which added a test for the error message on invalid submission. The result appears in <a class="ref" href="#code:user_edit_specs">Listing&nbsp;9.1</a>.</p>

<div class="label" id="code:user_edit_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.1.</span> <span class="description">Tests for the user edit page. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;page&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s2">&quot;Update your profile&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="s1">&#39;http://gravatar.com/emails&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Save changes&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To write the application code, we need to fill in the <code>edit</code> action in the Users controller. Note from <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a> that the proper URI for a user&rsquo;s edit page is /users/1/edit (assuming the user&rsquo;s id is&nbsp;<tt>1</tt>). Recall that the id of the user is available in the <code>params[:id]</code> variable, which means that we can find the user with the code in  <a class="ref" href="#code:initial_edit_action">Listing&nbsp;9.2</a>.</p>

<div class="label" id="code:initial_edit_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.2.</span> <span class="description">The user <code>edit</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Getting the tests to pass requires making the actual edit view, shown in <a class="ref" href="#code:user_edit_view">Listing&nbsp;9.3</a>. Note how closely this resembles the new user view from <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a>; the large overlap suggests factoring the repeated code into a partial, which is left as an exercise (<a class="ref" href="#sec:updating_deleting_exercises">Section&nbsp;9.6</a>).</p>

<div class="label" id="code:user_edit_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.3.</span> <span class="description">The user edit view. <br /> <code>app/views/users/edit.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span> 
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirm Password&quot;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Save changes&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Here we have reused the shared <code>error_messages</code> partial introduced in <a class="ref" href="#sec:signup_error_messages">Section&nbsp;7.3.2</a>.</p>

<p>With the <code>@user</code> instance variable from <a class="ref" href="#code:initial_edit_action">Listing&nbsp;9.2</a>, the edit page tests from <a class="ref" href="#code:user_edit_specs">Listing&nbsp;9.1</a> should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;edit page&quot;</span>
</pre></div>
</div>


<p>The corresponding page appears in <a class="ref" href="#fig:edit_page">Figure&nbsp;9.2</a>, which shows how Rails automatically pre-fills the Name and Email fields using the attributes of the <code>@user</code> variable.</p>

<div class="label" id="fig:edit_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_page_bootstrap.png" alt="edit_page_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.2: </span><span class="description">The initial user edit page with pre-filled name &amp; email.&nbsp;<a href="http://railstutorial.org/images/figures/edit_page_bootstrap-full.png">(full size)</a></span></div></div>


<p>Looking at the HTML source for <a class="ref" href="#fig:edit_page">Figure&nbsp;9.2</a>, we see a form tag as expected (<a class="ref" href="#code:edit_form_html">Listing&nbsp;9.4</a>).</p>

<div class="label" id="code:edit_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.4.</span> <span class="description">HTML for the edit form defined in <a class="ref" href="#code:user_edit_view">Listing&nbsp;9.3</a> and shown in <a class="ref" href="#fig:edit_page">Figure&nbsp;9.2</a>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users/1&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_user&quot;</span> <span class="na">id=</span><span class="s">&quot;edit_user_1&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>Note here the hidden input field</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Since web browsers can&rsquo;t natively send <tt>PUT</tt> requests (as required by the REST conventions from <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>), Rails fakes it with a <tt>POST</tt> request and a hidden <code>input</code> field.<sup class="footnote" id="fnref:9.3"><a href="#fn:9.3">3</a></sup></p>

<p>There&rsquo;s another subtlety to address here: the code <code>form_for(@user)</code> in <a class="ref" href="#code:user_edit_view">Listing&nbsp;9.3</a> is <em>exactly</em> the same as the code in <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a>&mdash;so how does Rails know to use a <tt>POST</tt> request for new users and a <tt>PUT</tt> for editing users? The answer is that it is possible to tell whether a user is new or already exists in the database via Active Record&rsquo;s <code>new_record?</code> boolean method:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>When constructing a form using <code>form_for(@user)</code>, Rails uses <tt>POST</tt> if <code>@user.new_record?</code> is <code>true</code> and <tt>PUT</tt> if it is <code>false</code>.</p>

<p>As a final touch, we&rsquo;ll add a URI to the user settings link to the site navigation. Since it depends on the signin status of the user, the test for the &ldquo;Settings&rdquo; link belongs with the other authentication tests, as shown in <a class="ref" href="#code:settings_link_test">Listing&nbsp;9.5</a>. (It would be nice to have additional tests verifying that such links <em>don&rsquo;t</em> appear for users who aren&rsquo;t signed in; writing these tests is left as an exercise (<a class="ref" href="#sec:updating_deleting_exercises">Section&nbsp;9.6</a>).)</p>

<div class="label" id="code:settings_link_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.5.</span> <span class="description">Adding a test for the &ldquo;Settings&rdquo; link. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span>  <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Settings&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>For convenience, the code in <a class="ref" href="#code:settings_link_test">Listing&nbsp;9.5</a> uses a helper to sign in a user inside the tests. The method is to visit the signin page and submit valid information, as shown in <a class="ref" href="#code:sign_in_helper">Listing&nbsp;9.6</a>.</p>

<div class="label" id="code:sign_in_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.6.</span> <span class="description">A test helper to sign users in. <br /> <code>spec/support/utilities.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
  <span class="c1"># Sign in when not using Capybara as well.</span>
  <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As noted in the comment line, filling in the form doesn&rsquo;t work when not using Capybara, so to cover this case we also add the user&rsquo;s remember token to the cookies:</p>

<div class="code"><div class="highlight"><pre><span class="c1"># Sign in when not using Capybara as well.</span>
<span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</pre></div>
</div>


<p>This is necessary when using one of the HTTP request methods directly (<code>get</code>, <code>post</code>, <code>put</code>, or <code>delete</code>), as we&rsquo;ll see in <a class="ref" href="#code:delete_destroy_test">Listing&nbsp;9.47</a>. (Note that the test <code>cookies</code> object isn&rsquo;t a perfect simulation of the real cookies object; in particular, the <code>cookies.permanent</code> method seen in <a class="ref" href="#code:sign_in_function">Listing&nbsp;8.19</a> doesn&rsquo;t work inside tests.) As you might suspect, the <code>sign_in</code> method will prove useful in future tests, and in fact it can already be used to eliminate some duplication (<a class="ref" href="#sec:updating_deleting_exercises">Section&nbsp;9.6</a>).</p>

<p>The application code to add the URI for the &ldquo;Settings&rdquo; link is simple: we just use the named route <code>edit_user_path</code> from <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>, together with the handy <code>current_user</code> helper method defined in <a class="ref" href="#code:current_user_working">Listing&nbsp;8.22</a>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The full application code appears in <a class="ref" href="#code:settings_link">Listing&nbsp;9.7</a>).</p>

<div class="label" id="code:settings_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.7.</span> <span class="description">Adding a &ldquo;Settings&rdquo; link. <br /> <code>app/views/layouts/_header.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec:unsuccessful_edits"></div>


<h3><a id="sec:9.1.2" href="#sec:unsuccessful_edits" class="heading"><span class="number">9.1.2</span> Unsuccessful edits</a></h3>


<p>In this section we&rsquo;ll handle unsuccessful edits and get the error messages test in <a class="ref" href="#code:user_edit_specs">Listing&nbsp;9.1</a> to pass. The application code creates an <code>update</code> action that uses <code>update_attributes</code> (<a class="ref" href="#sec:updating_user_objects">Section&nbsp;6.1.5</a>) to update the user based on the submitted <code>params</code> hash, as shown in <a class="ref" href="#code:user_update_action_unsuccessful">Listing&nbsp;9.8</a>. With invalid information, the update attempt returns <code>false</code>, so the <code>else</code> branch re-renders the edit page. We&rsquo;ve seen this pattern before; the structure closely parallels the first version of the <code>create</code> action (<a class="ref" href="#code:first_create_action">Listing&nbsp;7.21</a>).</p>

<div class="label" id="code:user_update_action_unsuccessful"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.8.</span> <span class="description">The initial user <code>update</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Handle a successful update.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The resulting error message (<a class="ref" href="#fig:edit_with_invalid_information">Figure&nbsp;9.3</a>) is the one needed to get the error message test to pass, as you should verify by running the test suite:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<div class="label" id="fig:edit_with_invalid_information"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_with_invalid_information_bootstrap.png" alt="edit_with_invalid_information_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.3: </span><span class="description">Error message from submitting the update form.&nbsp;<a href="http://railstutorial.org/images/figures/edit_with_invalid_information_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:successful_edits"></div>


<h3><a id="sec:9.1.3" href="#sec:successful_edits" class="heading"><span class="number">9.1.3</span> Successful edits</a></h3>


<p>Now it&rsquo;s time to get the edit form to work. Editing the profile images is already functional since we&rsquo;ve outsourced image upload to Gravatar; we can edit gravatars by clicking on the &ldquo;change&rdquo; link from <a class="ref" href="#fig:edit_page">Figure&nbsp;9.2</a>, as shown in <a class="ref" href="#fig:gravatar_cropper">Figure&nbsp;9.4</a>. Let&rsquo;s get the rest of the user edit functionality working as well.</p>

<div class="label" id="fig:gravatar_cropper"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/gravatar_cropper.png" alt="gravatar_cropper" /></span></div><div class="caption"><span class="header">Figure 9.4: </span><span class="description">The  <a href="http://gravatar.com/">Gravatar</a> image-cropping interface, with a picture of <a href="http://michaelhartl.com/">some dude</a>.</span></div></div>


<p>The tests for the <code>update</code> action are similar to those for <code>create</code>. <a class="ref" href="#code:user_update_specs">Listing&nbsp;9.9</a> show how to use Capybara to fill in the form fields with valid information and then test that the resulting behavior is correct. This is a lot of code; see if you can work through it by referring back to the tests in <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>.</p>

<div class="label" id="code:user_update_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.9.</span> <span class="description">Tests for the user <code>update</code> action. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_name</span><span class="p">)</span>  <span class="p">{</span> <span class="s2">&quot;New Name&quot;</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;new@example.com&quot;</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>             <span class="ss">with:</span> <span class="n">new_name</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>            <span class="ss">with:</span> <span class="n">new_email</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirm Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Save changes&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">new_name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="n">new_name</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_email</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The only real novelty in <a class="ref" href="#code:user_update_specs">Listing&nbsp;9.9</a> is the <code>reload</code> method, which appears in the test for changing the user&rsquo;s attributes:</p>

<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="n">new_name</span> <span class="p">}</span>
<span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_email</span> <span class="p">}</span>
</pre></div>
</div>


<p>This reloads the <code>user</code> variable from the test database using <code>user.reload</code>, and then verifies that the user&rsquo;s new name and email match the new values.</p>

<p>The <code>update</code> action needed to get the tests in <a class="ref" href="#code:user_update_specs">Listing&nbsp;9.9</a> to pass is similar to the final form of the <code>create</code> action (<a class="ref" href="#code:signin_upon_signup">Listing&nbsp;8.27</a>), as seen in <a class="ref" href="#code:user_update_action">Listing&nbsp;9.10</a>. All this does is add</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
<span class="n">sign_in</span> <span class="vi">@user</span>
<span class="n">redirect_to</span> <span class="vi">@user</span>
</pre></div>
</div>


<p>to the code in <a class="ref" href="#code:user_update_action_unsuccessful">Listing&nbsp;9.8</a>. Note that we sign in the user as part of a successful profile update; this is because the remember token gets reset when the user is saved (<a class="ref" href="#code:before_save_create_remember_token">Listing&nbsp;8.18</a>), which invalidates the user&rsquo;s session (<a class="ref" href="#code:current_user_working">Listing&nbsp;8.22</a>). This is a nice security feature, as it means that any hijacked sessions will automatically expire when the user information is changed.</p>

<div class="label" id="code:user_update_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.10.</span> <span class="description">The user <code>update</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that, as currently constructed, every edit requires the user to reconfirm the password (as implied by the empty confirmation text box in <a class="ref" href="#fig:edit_page">Figure&nbsp;9.2</a>), which is a minor annoyance but makes updates much more secure.</p>

<p>With the code in this section, the user edit page should be working, as you can double-check by re-running the test suite, which should now be green:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:authorization"></div>


<h2><a id="sec:9.2" href="#sec:authorization" class="heading"><span class="number">9.2</span> Authorization</a></h2>


<p>One nice effect of building the authentication machinery in <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a> is that we are now in a position to implement authorization as well: <em>authentication</em> allows us to identify users of our site, and <em>authorization</em> lets us control what they can do.</p>

<p>Although the edit and update actions from <a class="ref" href="#sec:updating_users">Section&nbsp;9.1</a> are functionally complete, they suffer from a ridiculous security flaw: they allow anyone (even non-signed-in users) to access either action, and any signed-in user can update the information for any other user. In this section, we&rsquo;ll implement a security model that requires users to be signed in and prevents them from updating any information other than their own. Users who aren&rsquo;t signed in and who try to access protected pages will be forwarded to the signin page with a helpful message, as mocked up in <a class="ref" href="#fig:signin_page_protected_mockup">Figure&nbsp;9.5</a>.</p>

<div class="label" id="fig:signin_page_protected_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_page_protected_mockup_bootstrap.png" alt="signin_page_protected_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.5: </span><span class="description">A mockup of the result of visiting a protected page&nbsp;<a href="http://railstutorial.org/images/figures/signin_page_protected_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:requiring_signed_in_users"></div>


<h3><a id="sec:9.2.1" href="#sec:requiring_signed_in_users" class="heading"><span class="number">9.2.1</span> Requiring signed-in users</a></h3>


<p>Since the security restrictions for the <code>edit</code> and <code>update</code> actions are identical, we&rsquo;ll handle them in a single RSpec <code>describe</code> block. Starting with the sign-in requirement, our initial tests verify that non-signed-in users attempting to access either action are simply sent to the signin page, as seen in <a class="ref" href="#code:protected_edit_update_tests">Listing&nbsp;9.11</a>.</p>

<div class="label" id="code:protected_edit_update_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.11.</span> <span class="description">Testing that the <code>edit</code> and <code>update</code> actions are protected. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">&quot;visiting the edit page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the update action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:protected_edit_update_tests">Listing&nbsp;9.11</a> introduces a second way, apart from Capybara&rsquo;s <code>visit</code> method, to access a controller action: by issuing the appropriate HTTP request directly, in this case using the <code>put</code> method to issue a <tt>PUT</tt> request:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;submitting to the update action&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>This issues a <tt>PUT</tt> request directly to <code>/users/1</code>, which gets routed to the <code>update</code> action of the Users controller (<a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>). This is necessary because there is no way for a browser to visit the <code>update</code> action directly&mdash;it can only get there indirectly by submitting the edit form&mdash;so Capybara can&rsquo;t do it either. But visiting the edit page only tests the authorization for the <code>edit</code> action, not for <code>update</code>. As a result, the only way to test the proper authorization for the <code>update</code> action itself is to issue a direct request. (As you might guess, in addition to <code>put</code> Rails tests support <code>get</code>, <code>post</code>, and <code>delete</code> as well.)</p>

<p>When using one of the methods to issue HTTP requests directly, we get access to the low-level <code>response</code> object. Unlike the Capybara <code>page</code> object, <code>response</code> lets us test for the server response itself, in this case verifying that the <code>update</code> action responds by redirecting to the signin page:</p>

<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>The authorization application code uses a <em>before filter</em>, which arranges for a particular method to be called before the given actions. To require users to be signed in, we define a <code>signed_in_user</code> method and invoke it using <code>before_filter :signed_in_user</code>, as shown in <a class="ref" href="#code:authorize_before_filter">Listing&nbsp;9.12</a>.</p>

<div class="label" id="code:authorize_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.12.</span> <span class="description">Adding a <code>signed_in_user</code> before filter. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By default, before filters apply to <em>every</em> action in a controller, so here we restrict the filter to act only on the <code>:edit</code> and <code>:update</code> actions by passing the appropriate <code>:only</code> options hash.</p>

<p>Note that <a class="ref" href="#code:authorize_before_filter">Listing&nbsp;9.12</a> uses a shortcut for setting <code>flash[:notice]</code> by passing an options hash to the <code>redirect_to</code> function. The code in <a class="ref" href="#code:authorize_before_filter">Listing&nbsp;9.12</a> is equivalent to the more verbose</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please sign in.&quot;</span>
<span class="n">redirect_to</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>(The same construction works for the <code>:error</code> key, but not for <code>:success</code>.)</p>

<p>Together with <code>:success</code> and <code>:error</code>, the <code>:notice</code> key completes our triumvirate of <code>flash</code> styles, all of which are supported natively by Bootstrap CSS. By signing out and attempting to access the user edit page <a href="http://localhost:3000/users/1/edit">/users/1/edit</a>, we can see the resulting yellow &ldquo;notice&rdquo;  box, as seen in <a class="ref" href="#fig:protected_sign_in">Figure&nbsp;9.6</a>.</p>

<div class="label" id="fig:protected_sign_in"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/protected_sign_in_bootstrap.png" alt="protected_sign_in_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.6: </span><span class="description">The signin form after trying to access a protected page.&nbsp;<a href="http://railstutorial.org/images/figures/protected_sign_in_bootstrap-full.png">(full size)</a></span></div></div>


<p>Unfortunately, in the process of getting the authorization tests from <a class="ref" href="#code:protected_edit_update_tests">Listing&nbsp;9.11</a> to pass, we&rsquo;ve broken the tests in <a class="ref" href="#code:user_edit_specs">Listing&nbsp;9.1</a>. Code like</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>no longer works because visiting the edit user path requires a signed-in user. The solution is to sign in the user with the <code>sign_in</code> utility from <a class="ref" href="#code:sign_in_helper">Listing&nbsp;9.6</a>, as shown in <a class="ref" href="#code:edit_update_tests_with_signin">Listing&nbsp;9.13</a>.</p>

<div class="label" id="code:edit_update_tests_with_signin"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.13.</span> <span class="description">Adding a signin step to the edit and update tests. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point our, test suite should be green:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/ 
</pre></div>
</div>




<div class="label" id="sec:requiring_the_right_user"></div>


<h3><a id="sec:9.2.2" href="#sec:requiring_the_right_user" class="heading"><span class="number">9.2.2</span> Requiring the right user</a></h3>


<p>Of course, requiring users to sign in isn&rsquo;t quite enough; users should only be allowed to edit their <em>own</em> information. We can test for this by first signing in as an incorrect user and then hitting the <code>edit</code> and <code>update</code> actions (<a class="ref" href="#code:edit_update_wrong_user_tests">Listing&nbsp;9.14</a>). Note that, since users should never even <em>try</em> to edit another user&rsquo;s profile, we redirect not to the signin page but to the root URL.</p>

<div class="label" id="code:edit_update_wrong_user_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.14.</span> <span class="description">Testing that the <code>edit</code> and <code>update</code> actions require the right user. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;as wrong user&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:wrong_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;wrong@example.com&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;visiting Users#edit page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Edit user&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;submitting a PUT request to the Users#update action&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note here that a factory can take an option:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;wrong@example.com&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>This creates a user with a different email address from the default. The tests specify that this wrong user should not have access to the original user&rsquo;s <code>edit</code> or <code>update</code> actions.</p>

<p>The application code adds a second before filter to call the <code>correct_user</code> method, as shown in <a class="ref" href="#code:correct_user_before_filter">Listing&nbsp;9.15</a>.</p>

<div class="label" id="code:correct_user_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.15.</span> <span class="description">A <code>correct_user</code> before filter to protect the edit/update pages. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The <code>correct_user</code> filter uses the <code>current_user?</code> boolean method, which  we define in the Sessions helper (<a class="ref" href="#code:current_user_p">Listing&nbsp;9.16</a>).</p>

<div class="label" id="code:current_user_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.16.</span> <span class="description">The <code>current_user?</code> method. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:correct_user_before_filter">Listing&nbsp;9.15</a> also shows the updated <code>edit</code> and <code>update</code> actions. Before, in <a class="ref" href="#code:initial_edit_action">Listing&nbsp;9.2</a>, we had</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>and similarly for <code>update</code>. Now that the <code>correct_user</code> before filter defines <code>@user</code>, we can omit it from both actions.</p>

<p>Before moving on, you should verify that the test suite passes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:friendly_forwarding"></div>


<h3><a id="sec:9.2.3" href="#sec:friendly_forwarding" class="heading"><span class="number">9.2.3</span> Friendly forwarding</a></h3>


<p>Our site authorization is complete as written, but there is one minor blemish: when users try to access a protected page, they are currently redirected to their profile pages regardless of where they were trying to go. In other words, if a non-logged-in user tries to visit the edit page, after signing in the user will be redirected to /users/1 instead of /users/1/edit. It would be much friendlier to redirect them to their intended destination instead.</p>

<p>To test for such &ldquo;friendly forwarding&rdquo;, we first visit the user edit page, which redirects to the signin page. We then enter valid signin information and click the &ldquo;Sign in&rdquo; button. The resulting page, which by default is the user&rsquo;s profile, should in this case be the &ldquo;Edit user&rdquo; page. The test for this sequence appears in <a class="ref" href="#code:friendly_forwarding_test">Listing&nbsp;9.17</a>.</p>

<div class="label" id="code:friendly_forwarding_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.17.</span> <span class="description">A test for friendly forwarding. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;when attempting to visit a protected page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;after signing in&quot;</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">&quot;should render the desired protected page&quot;</span> <span class="k">do</span>
            <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Edit user&#39;</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now for the implementation.<sup class="footnote" id="fnref:9.4"><a href="#fn:9.4">4</a></sup> In order to forward users to their intended destination, we need to store the location of the requested page somewhere, and then redirect to that location instead. We accomplish this with a pair of methods, <code>store_location</code> and <code>redirect_back_or</code>, both defined in the Sessions helper (<a class="ref" href="#code:friendly_forwarding_code">Listing&nbsp;9.18</a>).</p>

<div class="label" id="code:friendly_forwarding_code"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.18.</span> <span class="description">Code to implement friendly forwarding. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:return_to</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">store_location</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">fullpath</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The storage mechanism is the <code>session</code> facility provided by Rails, which you can think of as being like an instance of the <code>cookies</code> variable from <a class="ref" href="#sec:remember_me">Section&nbsp;8.2.1</a> that automatically expires upon browser close. We also use the <code>request</code> object to get the <code>fullpath</code>, i.e., the full path (URI) of the requested page. The <code>store_location</code> method puts the requested URI in the <code>session</code> variable under the key <code>:return_to</code>.</p>

<p>To make use of <code>store_location</code>, we need to add it to the <code>signed_in_user</code> before filter, as shown in <a class="ref" href="#code:add_store_location">Listing&nbsp;9.19</a>.</p>

<div class="label" id="code:add_store_location"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.19.</span> <span class="description">Adding <code>store_location</code> to the signed-in user before filter. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="k">unless</span> <span class="n">signed_in?</span>
        <span class="n">store_location</span>
        <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To implement the forwarding itself, we use the <code>redirect_back_or</code> method to redirect to the requested URI if it exists, or some default URI otherwise, which we add to the Sessions controller <code>create</code> action to redirect after successful signin (<a class="ref" href="#code:friendly_session_create">Listing&nbsp;9.20</a>). The <code>redirect_back_or</code> method uses the or operator&nbsp;<code>||</code> through</p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div>
</div>


<p>This evaluates to <code>session[:return_to]</code> unless it&rsquo;s <code>nil</code>, in which case it evaluates to the given default URI. Note that <a class="ref" href="#code:friendly_forwarding_code">Listing&nbsp;9.18</a> is careful to remove the forwarding URI; otherwise, subsequent signin attempts would forward to the protected page until the user closed his browser. (Testing for this is left as an exercise (<a class="ref" href="#sec:updating_deleting_exercises">Section&nbsp;9.6</a>.)</p>

<div class="label" id="code:friendly_session_create"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.20.</span> <span class="description">The Sessions <code>create</code> action with friendly forwarding. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With that, the friendly forwarding integration test in <a class="ref" href="#code:friendly_forwarding_test">Listing&nbsp;9.17</a> should pass, and the basic user authentication and page protection implementation is complete. As usual, it&rsquo;s a good idea to verify that the test suite is green before proceeding:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:showing_all_users"></div>


<h2><a id="sec:9.3" href="#sec:showing_all_users" class="heading"><span class="number">9.3</span> Showing all users</a></h2>


<p>In this section, we&rsquo;ll add the <a href="http://www.answers.com/penultimate">penultimate</a> user action, the <code>index</code> action, which is designed to display <em>all</em> the users instead of just one. Along the way, we&rsquo;ll learn about populating the database with sample users and <em>paginating</em> the user output so that the index page can scale up to display a potentially large number of users. A mockup of the result&mdash;users, pagination links, and a &ldquo;Users&rdquo; navigation link&mdash;appears in <a class="ref" href="#fig:user_index_mockup">Figure&nbsp;9.7</a>.<sup class="footnote" id="fnref:9.5"><a href="#fn:9.5">5</a></sup> In <a class="ref" href="#sec:destroying_users">Section&nbsp;9.4</a>, we&rsquo;ll add an administrative interface to the user index so that (presumably troublesome) users can be destroyed.</p>

<div class="label" id="fig:user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_mockup_bootstrap.png" alt="user_index_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.7: </span><span class="description">A mockup of the user index, with pagination and a &ldquo;Users&rdquo; nav link.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:user_index"></div>


<h3><a id="sec:9.3.1" href="#sec:user_index" class="heading"><span class="number">9.3.1</span> User index</a></h3>


<p>Although we&rsquo;ll keep individual user <code>show</code> pages visible to all site visitors, the user <code>index</code> will be restricted to signed-in users so that there&rsquo;s a limit to how much unregistered users can see by default. We&rsquo;ll start by testing that the <code>index</code> action is protected by visiting the <code>users_path</code> (<a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>) and verifying that we are redirected to the signin page. As with other authorization tests, we&rsquo;ll put this example in the authentication integration test, as shown in <a class="ref" href="#code:protected_index_test">Listing&nbsp;9.21</a>.</p>

<div class="label" id="code:protected_index_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.21.</span> <span class="description">Testing that the <code>index</code> action is protected. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">&quot;visiting the user index&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">users_path</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The corresponding application code simply involves adding <code>index</code> to the list of actions protected by the <code>signed_in_user</code> before filter, as shown in <a class="ref" href="#code:signed_in_user_index">Listing&nbsp;9.22</a>.</p>

<div class="label" id="code:signed_in_user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.22.</span> <span class="description">Requiring a signed-in user for the <code>index</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The next set of tests makes sure that, for signed-in users, the index page has the right title/heading and lists all of the site&rsquo;s users. The method is to make three factory users (signing in as the first one) and then verify that the index page has a list element (<code>li</code>) tag for the name of each one. Note that we&rsquo;ve taken care to give the users different names so that each element in the list of users has a unique entry, as shown in <a class="ref" href="#code:user_index_tests">Listing&nbsp;9.23</a>.</p>

<div class="label" id="code:user_index_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.23.</span> <span class="description">Tests for the user index page. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Ben&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;ben@example.com&quot;</span><span class="p">)</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should list each user&quot;</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As you may recall from the corresponding action in the demo app (<a class="ref" href="#code:demo_index_action">Listing&nbsp;2.4</a>), the application code uses <code>User.all</code> to pull all the users out of the database, assigning them to an <code>@users</code> instance variable for use in the view, as seen in <a class="ref" href="#code:user_index">Listing&nbsp;9.24</a>. (If displaying all the users at once seems like a bad idea, you&rsquo;re right, and we&rsquo;ll remove this blemish in <a class="ref" href="#sec:pagination">Section&nbsp;9.3.3</a>.)</p>

<div class="label" id="code:user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.24.</span> <span class="description">The user <code>index</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To make the actual index page, we need to make a view that iterates through the users and wraps each one in an&nbsp;<code>li</code> tag. We do this with the <code>each</code> method, displaying each user&rsquo;s Gravatar and name, while wrapping the whole thing in an unordered list (<code>ul</code>) tag (<a class="ref" href="#code:user_index_view">Listing&nbsp;9.25</a>). The code in <a class="ref" href="#code:user_index_view">Listing&nbsp;9.25</a> uses the result of  <a class="ref" href="#code:gravatar_option">Listing&nbsp;7.29</a> from <a class="ref" href="#sec:signup_exercises">Section&nbsp;7.6</a>, which allows us to pass an option to the Gravatar helper specifying a size other than the default. If you didn&rsquo;t do that exercise, update your Users helper file with the contents of <a class="ref" href="#code:gravatar_option">Listing&nbsp;7.29</a> before proceeding.</p>

<div class="label" id="code:user_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.25.</span> <span class="description">The user index view. <br /> <code>app/views/users/index.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div></div>


<p>Let&rsquo;s also add a little CSS (or, rather, SCSS) for style (<a class="ref" href="#code:user_index_css">Listing&nbsp;9.26</a>).</p>

<div class="label" id="code:user_index_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.26.</span> <span class="description">CSS for the user index. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:last-child</span> <span class="p">{</span>
      <span class="na">border-bottom</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>Finally, we&rsquo;ll add the URI to the users link in the site&rsquo;s navigation header using <code>users_path</code>, thereby using the last of the unused named routes in <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>. The test (<a class="ref" href="#code:users_link_test">Listing&nbsp;9.27</a>) and application code (<a class="ref" href="#code:users_link">Listing&nbsp;9.28</a>) are both straightforward.</p>

<div class="label" id="code:users_link_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.27.</span> <span class="description">A test for the &ldquo;Users&rdquo; link URI. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span>    <span class="ss">href:</span> <span class="n">users_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span>  <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Settings&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:users_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.28.</span> <span class="description">Adding the URI to the users link. <br /> <code>app/views/layouts/_header.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>With that, the user index is fully functional, with all tests passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>On the other hand, as seen in <a class="ref" href="#fig:user_index_only_one">Figure&nbsp;9.8</a>, it is a bit&hellip; lonely. Let&rsquo;s remedy this sad situation.</p>

<div class="label" id="fig:user_index_only_one"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_only_one_bootstrap.png" alt="user_index_only_one_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.8: </span><span class="description">The user index page  <a href="http://localhost:3000/users">/users</a> with only one user.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_only_one_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:sample_users"></div>


<h3><a id="sec:9.3.2" href="#sec:sample_users" class="heading"><span class="number">9.3.2</span> Sample users</a></h3>


<p>In this section, we&rsquo;ll give our lonely sample user some company. Of course, to create enough users to make a decent user index, we <em>could</em> use our web browser to visit the signup page and make the new users one by one, but far a better solution is to use Ruby (and Rake) to make the users for us.</p>

<p>First, we&rsquo;ll add the <em>Faker</em> gem to the <code>Gemfile</code>, which will allow us to make sample users with semi-realistic names and email addresses (<a class="ref" href="#code:faker_gemfile">Listing&nbsp;9.29</a>).</p>

<div class="label" id="code:faker_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.29.</span> <span class="description">Adding the Faker gem to the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then install as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Next, we&rsquo;ll add a Rake task to create sample users. Rake tasks live in the <code>lib/tasks</code> directory, and are defined using <em>namespaces</em> (in this case, <code>:db</code>), as seen in <a class="ref" href="#code:db_populate">Listing&nbsp;9.30</a>. (This is a bit advanced, so don&rsquo;t worry too much about the details.)</p>

<div class="label" id="code:db_populate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.30.</span> <span class="description">A Rake task for populating the database with sample users. <br /> <code>lib/tasks/sample_data.rake</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                 <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                 <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker::Name</span><span class="o">.</span><span class="n">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
      <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
                   <span class="ss">email:</span> <span class="n">email</span><span class="p">,</span>
                   <span class="ss">password:</span> <span class="n">password</span><span class="p">,</span>
                   <span class="ss">password_confirmation:</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This defines a task <code>db:populate</code> that creates an example user with name and email address replicating our previous one, and then makes 99 more. The line</p>

<div class="code"><div class="highlight"><pre><span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
</pre></div>
</div>


<p>ensures that the Rake task has access to the local Rails environment, including the User model (and hence <code>User.create!</code>). Here <code>create!</code> is just like the <code>create</code> method, except it raises an exception (<a class="ref" href="#sec:finding_user_objects">Section&nbsp;6.1.4</a>) for an invalid user rather than returning <code>false</code>. This noisier construction makes debugging easier by avoiding silent errors.</p>

<p>With the <code>:db</code> namespace as in <a class="ref" href="#code:db_populate">Listing&nbsp;9.30</a>, we can invoke the Rake task as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>After running the Rake task, our application has 100 sample users, as seen in <a class="ref" href="#fig:user_index_all">Figure&nbsp;9.9</a>. (I&rsquo;ve taken the liberty of associating the first few sample addresses with photos so that they&rsquo;re not all the default Gravatar image.)</p>

<div class="label" id="fig:user_index_all"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_all_bootstrap.png" alt="user_index_all_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.9: </span><span class="description">The user index page <a href="http://localhost:3000/users">/users</a> with 100 sample users.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_all_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:pagination"></div>


<h3><a id="sec:9.3.3" href="#sec:pagination" class="heading"><span class="number">9.3.3</span> Pagination</a></h3>


<p>Our original user doesn&rsquo;t suffer from loneliness any more, but now we have the opposite problem: our user has <em>too many</em> companions, and they all appear on the same page. Right now there are a hundred, which is already a reasonably large number, and on a real site it could be thousands. The solution is to <em>paginate</em> the users, so that (for example) only 30 show up on a page at any one time.</p>

<p>There are several pagination methods in Rails; we&rsquo;ll use one of the simplest and most robust, called <a href="http://wiki.github.com/mislav/will_paginate/">will_paginate</a>. To use it, we need to include both the <tt>will_paginate</tt> gem and <tt>bootstrap-will_paginate</tt>, which configures will_paginate to use Bootstrap&rsquo;s pagination styles. The updated <code>Gemfile</code> appears in <a class="ref" href="#code:will_paginate_gem">Listing&nbsp;9.31</a>.</p>

<div class="label" id="code:will_paginate_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.31.</span> <span class="description">Including <tt>will_paginate</tt> in the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.6&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then run <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>You should also restart the web server to insure that the new gems are loaded properly.</p>

<p>Because the <tt>will_paginate</tt> gem is in wide use, there&rsquo;s no need to test it thoroughly, so we&rsquo;ll take a lightweight approach. First, we&rsquo;ll test for a <code>div</code> with CSS class &ldquo;pagination&rdquo;, which is what gets output by <tt>will_paginate</tt>. Then we&rsquo;ll verify that the correct users appear on the first page of results. This requires the use of the <code>paginate</code> method, which we&rsquo;ll cover shortly.</p>

<p>As before, we&rsquo;ll use Factory Girl to simulate users, but immediately we have a problem: user email addresses must be unique, which would appear to require creating more than 30 users by hand&mdash;a terribly cumbersome job. In addition, when testing for user listings it would be convenient for them all to have different names. Fortunately, Factory Girl anticipates this issue, and provides <em>sequences</em> to solve it. Our original factory (<a class="ref" href="#code:user_factory">Listing&nbsp;7.8</a>) hard-coded the name and email address:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">&quot;Michael Hartl&quot;</span>
    <span class="n">email</span>    <span class="s2">&quot;michael@example.com&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Instead, we can arrange for a sequence of names and email addresses using the <code>sequence</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>Here <code>sequence</code> takes a symbol corresponding to the desired attribute (such as <code>:name</code>) and a block with one variable, which we have called&nbsp;<code>n</code>. Upon successive invocations of the <code>FactoryGirl</code> method,</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>
</div>


<p>The block variable <code>n</code> is automatically incremented, so that the first user has name &ldquo;Person&nbsp;1&rdquo; and email address &ldquo;person_1@example.com&rdquo;, the second user has name &ldquo;Person&nbsp;2&rdquo; and email address &ldquo;person_2@example.com&rdquo;, and so on. The full
code appears in <a class="ref" href="#code:factory_sequence">Listing&nbsp;9.32</a>.</p>

<div class="label" id="code:factory_sequence"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.32.</span> <span class="description">Defining a Factory Girl sequence. <br /> <code>spec/factories.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Applying the idea of factory sequences, we can make 30 users in our test, which (as we will see) will be sufficient to invoke pagination:</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>    
</pre></div>
</div>


<p>Note here the use of <code>before(:all)</code>, which ensures that the sample users are created <em>once</em>, before all the tests in the block. This is an optimization for speed, as creating 30 users can be slow on some systems. We use the complementary method <code>after(:all)</code> to delete the users once we&rsquo;re done.</p>

<p>The tests for the appearance of the pagination <code>div</code> and the right users appears in <a class="ref" href="#code:will_paginate_test">Listing&nbsp;9.33</a>. Note the replacement of the <code>User.all</code> array from <a class="ref" href="#code:user_index_tests">Listing&nbsp;9.23</a> with <code>User.paginate(page: 1)</code>, which (as we&rsquo;ll see momentarily) is how to pull out the first page of users from the database. Note also that <a class="ref" href="#code:will_paginate_test">Listing&nbsp;9.33</a> uses <code>before(:each)</code> to emphasize the contrast with <code>before(:all)</code>.</p>

<div class="label" id="code:will_paginate_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.33.</span> <span class="description">Tests for pagination. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;pagination&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.pagination&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">&quot;should list each user&quot;</span> <span class="k">do</span>
        <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To get pagination working, we need to add some code to the index view telling Rails to paginate the users, and we need to replace <code>User.all</code> in the <code>index</code> action with an object that knows about pagination. We&rsquo;ll start by adding the special <code>will_paginate</code> method in the view (<a class="ref" href="#code:will_paginate_index_view">Listing&nbsp;9.34</a>); we&rsquo;ll see in a moment why the code appears both above and below the user list.</p>

<div class="label" id="code:will_paginate_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.34.</span> <span class="description">The user index with pagination. <br /> <code>app/views/users/index.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>The <code>will_paginate</code> method is a little magical; inside a <code>users</code> view, it automatically looks for an <code>@users</code> object, and then displays pagination links to access other pages. The view in <a class="ref" href="#code:will_paginate_index_view">Listing&nbsp;9.34</a> doesn&rsquo;t work yet, though, because currently <code>@users</code> contains the results of <code>User.all</code> (<a class="ref" href="#code:user_index">Listing&nbsp;9.24</a>), which is of class <code>Array</code>, whereas <code>will_paginate</code> expects an object of class <code>ActiveRecord::Relation</code>. Happily, this is just the kind of object returned by the <code>paginate</code> method added by the <tt>will_paginate</tt> gem to all Active Record objects:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Array</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; ActiveRecord::Relation</span>
</pre></div>
</div>


<p>Note that <code>paginate</code> takes a hash argument with key <code>:page</code> and value equal to the page requested. <code>User.paginate</code> pulls the users out of the database one chunk at a time (30 by default), based on the <code>:page</code> parameter. So, for example, page&nbsp;1 is users 1&ndash;30, page&nbsp;2 is users 31&ndash;60, etc. If the page is <code>nil</code>, <code>paginate</code> simply returns the first page.</p>

<p>Using the <code>paginate</code> method, we can paginate the users in the sample application by using <code>paginate</code> in place of <code>all</code> in the <code>index</code> action (<a class="ref" href="#code:will_paginate_index_action">Listing&nbsp;9.35</a>). Here the <code>:page</code> parameter comes from <code>params[:page]</code>, which is generated automatically by <code>will_paginate</code>.</p>

<div class="label" id="code:will_paginate_index_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.35.</span> <span class="description">Paginating the users in the <code>index</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The user index page should now be working, appearing as in <a class="ref" href="#fig:user_index_pagination_rails_3">Figure&nbsp;9.10</a>. (On some systems, you may have to restart the Rails server at this point.) Because we included <code>will_paginate</code> both above and below the user list, the pagination links appear in both places.</p>

<div class="label" id="fig:user_index_pagination_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_pagination_rails_3_bootstrap.png" alt="user_index_pagination_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.10: </span><span class="description">The user index page  <a href="http://localhost:3000/users">/users</a> with pagination.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_pagination_rails_3_bootstrap-full.png">(full size)</a></span></div></div>


<p>If you now click on either the&nbsp;<a href="http://localhost:3000/users?page=2">2</a> link or <a href="http://localhost:3000/users?page=2">Next</a> link, you&rsquo;ll get the second page of results, as shown in <a class="ref" href="#fig:user_index_page_two_rails_3">Figure&nbsp;9.11</a>.</p>

<div class="label" id="fig:user_index_page_two_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_page_two_rails_3_bootstrap.png" alt="user_index_page_two_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.11: </span><span class="description">Page 2 of the user index (<a href="http://localhost:3000/users?page=2">/users?page=2</a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_index_page_two_rails_3_bootstrap-full.png">(full size)</a></span></div></div>


<p>You should also verify that the tests are passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:partial_refactoring"></div>


<h3><a id="sec:9.3.4" href="#sec:partial_refactoring" class="heading"><span class="number">9.3.4</span> Partial refactoring</a></h3>


<p>The paginated user index is now complete, but there&rsquo;s one improvement I can&rsquo;t resist including: Rails has some incredibly slick tools for making compact views, and in this section we&rsquo;ll refactor the index page to use them. Because our code is well-tested, we can refactor with confidence, assured that we are unlikely to break our site&rsquo;s functionality.</p>

<p>The first step in our refactoring is to replace the user&nbsp;<code>li</code> from <a class="ref" href="#code:will_paginate_index_view">Listing&nbsp;9.34</a> with a <code>render</code> call (<a class="ref" href="#code:index_view_first_refactoring">Listing&nbsp;9.36</a>).</p>

<div class="label" id="code:index_view_first_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.36.</span> <span class="description">The first refactoring attempt at the index view. <br /> <code>app/views/users/index.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Here we call <code>render</code> not on a string with the name of a partial, but rather on a <code>user</code> variable of class <code>User</code>;<sup class="footnote" id="fnref:9.6"><a href="#fn:9.6">6</a></sup> in this context, Rails automatically looks for a partial called <code>_user.html.erb</code>, which we must create (<a class="ref" href="#code:user_partial">Listing&nbsp;9.37</a>).</p>

<div class="label" id="code:user_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.37.</span> <span class="description">A partial to render a single user. <br /> <code>app/views/users/_user.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>This is a definite improvement, but we can do even better: we can call <code>render</code> <em>directly</em> on the <code>@users</code> variable (<a class="ref" href="#code:index_final_refactoring">Listing&nbsp;9.38</a>).</p>

<div class="label" id="code:index_final_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.38.</span> <span class="description">The fully refactored user index. <br /> <code>app/views/users/index.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Here Rails infers that <code>@users</code> is a list of <code>User</code> objects; moreover, when called with a collection of users, Rails automatically iterates through them and renders each one with the <code>_user.html.erb</code> partial. The result is the impressively compact code in <a class="ref" href="#code:index_final_refactoring">Listing&nbsp;9.38</a>. As with any refactoring, you should verify that the test suite is still green after changing the application code:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:destroying_users"></div>


<h2><a id="sec:9.4" href="#sec:destroying_users" class="heading"><span class="number">9.4</span> Deleting users</a></h2>


<p>Now that the user index is complete, there&rsquo;s only one canonical REST action left: <code>destroy</code>. In this section, we&rsquo;ll add links to delete users, as mocked up in <a class="ref" href="#fig:user_index_delete_links_mockup">Figure&nbsp;9.12</a>, and define the <code>destroy</code> action necessary to accomplish the deletion. But first, we&rsquo;ll create the class of administrative users authorized to do so.</p>

<div class="label" id="fig:user_index_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_delete_links_mockup_bootstrap.png" alt="user_index_delete_links_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.12: </span><span class="description">A mockup of the user index with delete links.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_delete_links_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:administrative_users"></div>


<h3><a id="sec:9.4.1" href="#sec:administrative_users" class="heading"><span class="number">9.4.1</span> Administrative users</a></h3>


<p>We will identify privileged administrative users with a boolean <code>admin</code> attribute in the User model, which, as we&rsquo;ll see, will automatically lead to an <code>admin?</code> boolean method to test for admin status. We can write tests for this attribute as in <a class="ref" href="#code:admin_specs">Listing&nbsp;9.39</a>.</p>

<div class="label" id="code:admin_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.39.</span> <span class="description">Tests for an <code>admin</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_admin</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;with admin attribute set to &#39;true&#39;&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save!</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we&rsquo;ve used the <code>toggle!</code> method to flip the <code>admin</code> attribute from <code>false</code> to <code>true</code>. Also note that the line</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
</pre></div>
</div>


<p>implies (via the RSpec boolean convention) that the user should have an <code>admin?</code> boolean method.</p>

<p>As usual, we add the <code>admin</code> attribute with a migration, indicating the <code>boolean</code> type on the command line:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div>
</div>


<p>The migration simply adds the <code>admin</code> column to the <code>users</code> table (<a class="ref" href="#code:admin_migration">Listing&nbsp;9.40</a>), yielding the data model in <a class="ref" href="#fig:user_model_admin">Figure&nbsp;9.13</a>.</p>

<div class="label" id="code:admin_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.40.</span> <span class="description">The migration to add a boolean <code>admin</code> attribute to users. <br /> <code>db/migrate/[timestamp]_add_admin_to_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default:</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we&rsquo;ve added the argument <code>default: false</code> to <code>add_column</code> in <a class="ref" href="#code:admin_migration">Listing&nbsp;9.40</a>, which means that users will <em>not</em> be administrators by default. (Without the <code>default: false</code> argument, <code>admin</code> will be <code>nil</code> by default, which is still <code>false</code>, so this step is not strictly necessary. It is more explicit, though, and communicates our intentions more clearly both to Rails and to readers of our code.)</p>

<div class="label" id="fig:user_model_admin"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_admin_31.png" alt="user_model_admin_31" /></span></div><div class="caption"><span class="header">Figure 9.13: </span><span class="description">The User model with an added <code>admin</code> boolean attribute.</span></div></div>


<p>Finally, we migrate the development database and prepare the test database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>As expected, Rails figures out the boolean nature of the <code>admin</code> attribute and automatically adds the question-mark method <code>admin?</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>As a result, the admin tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>As a final step, let&rsquo;s update our sample data populator to make the first user an admin by default (<a class="ref" href="#code:populator_with_admin">Listing&nbsp;9.41</a>).</p>

<div class="label" id="code:populator_with_admin"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.41.</span> <span class="description">The sample data populator code with an admin user. <br /> <code>lib/tasks/sample_data.rake</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                         <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                         <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                         <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Then reset the database and re-populate the sample data:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<div class="label" id="sec:revisiting_attr_accessible"></div>


<h4><a id="sec:9.4.1.1" href="#sec:revisiting_attr_accessible" class="heading">Revisiting <tt>attr_accessible</tt></a></h4>


<p>You might have noticed that <a class="ref" href="#code:populator_with_admin">Listing&nbsp;9.41</a> makes the user an admin with <code>toggle!(:admin)</code>, but why not just add <code>admin: true</code> to the initialization hash? The answer is, it won&rsquo;t work, and this is by design: only <code>attr_accessible</code> attributes can be assigned through mass assignment (that is, using an initialization hash, as in <code>User.new(name: "Foo", ...)</code>), and the <code>admin</code> attribute isn&rsquo;t accessible. <a class="ref" href="#code:attr_accessible_review">Listing&nbsp;9.42</a> reproduces the most recent list of <code>attr_accessible</code> attributes&mdash;note that <code>:admin</code> is <em>not</em> on the list.</p>

<div class="label" id="code:attr_accessible_review"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.42.</span> <span class="description">The <code>attr_accessible</code> attributes for the User model <em>without</em> an <code>:admin</code> attribute.  <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Explicitly defining accessible attributes is crucial for good site security. If we omitted the <code>attr_accessible</code> list in the User model (or foolishly added <code>:admin</code> to the list), a malicious user could send a <tt>PUT</tt> request as follows:<sup class="footnote" id="fnref:9.7"><a href="#fn:9.7">7</a></sup></p>

<div class="code"><div class="highlight"><pre>put /users/17?admin=1
</pre></div>
</div>


<p>This request would make user 17 an admin, which would be a potentially serious security breach, to say the least. Because of this danger, it is a good practice to define <code>attr_accessible</code> for every model. In fact, it&rsquo;s a good idea to write a test for any attribute that <em>isn&rsquo;t</em> accessible; writing such a test for the <code>admin</code> attribute is left as an exercise (<a class="ref" href="#sec:updating_deleting_exercises">Section&nbsp;9.6</a>).</p>

<div class="label" id="sec:the_destroy_action"></div>


<h3><a id="sec:9.4.2" href="#sec:the_destroy_action" class="heading"><span class="number">9.4.2</span> The <tt>destroy</tt> action</a></h3>


<p>The final step needed to complete the Users resource is to add delete links and a <code>destroy</code> action. We&rsquo;ll start by adding a delete link for each user on the user index page, restricting access to administrative users.</p>

<p>To write tests for the delete functionality, it&rsquo;s helpful to be able to have a factory to create admins. We can accomplish this by adding an <code>:admin</code> block to our factories, as shown in <a class="ref" href="#code:admin_factory">Listing&nbsp;9.43</a>.</p>

<div class="label" id="code:admin_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.43.</span> <span class="description">Adding a factory for administrative users. <br /> <code>spec/factories.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the code in <a class="ref" href="#code:admin_factory">Listing&nbsp;9.43</a>, we can now use <code>FactoryGirl.create(:admin)</code> to create an administrative user in our tests.</p>

<p>Our security model requires that ordinary users not see delete links:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>But administrative users should see such links, and by clicking on a delete link we expect an admin to delete the user, i.e., to change the <code>User</code> count by&nbsp;<code>-1</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="s2">&quot;should be able to delete another user&quot;</span> <span class="k">do</span>
  <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>Note that we have added a test to verify that the admin does not see a link to delete himself. The full set of delete link tests appears in <a class="ref" href="#code:delete_link_tests">Listing&nbsp;9.44</a>.</p>

<div class="label" id="code:delete_link_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.44.</span> <span class="description">Tests for delete links. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;pagination&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;delete links&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;as an admin user&quot;</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">sign_in</span> <span class="n">admin</span>
          <span class="n">visit</span> <span class="n">users_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="s2">&quot;should be able to delete another user&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The application code links to <code>"delete"</code> if the current user is an admin (<a class="ref" href="#code:delete_links">Listing&nbsp;9.45</a>). Note the <code>method: :delete</code> argument, which arranges for the link to issue the necessary <tt>DELETE</tt> request. We&rsquo;ve also wrapped each link inside an&nbsp;<code>if</code> statement so that only admins can see them. The result for our admin user appears in <a class="ref" href="#fig:index_delete_links_rails_3">Figure&nbsp;9.14</a>.</p>

<div class="label" id="code:delete_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.45.</span> <span class="description">User delete links (viewable only by admins). <br /> <code>app/views/users/_user.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                  <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>Web browsers can&rsquo;t send <tt>DELETE</tt> requests natively, so Rails fakes them with JavaScript. This means that the delete links won&rsquo;t work if the user has JavaScript disabled. If you must support non-JavaScript-enabled browsers you can fake a <tt>DELETE</tt> request using a form and a <tt>POST</tt> request, which works even without JavaScript; see the RailsCast on &ldquo;<a href="http://railscasts.com/episodes/77-destroy-without-javascript">Destroy Without JavaScript</a>&rdquo; for details.</p>

<div class="label" id="fig:index_delete_links_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/index_delete_links_rails_3_bootstrap.png" alt="index_delete_links_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Figure 9.14: </span><span class="description">The user index <a href="http://localhost:3000/users">/users</a> with delete links.&nbsp;<a href="http://railstutorial.org/images/figures/index_delete_links_rails_3_bootstrap-full.png">(full size)</a></span></div></div>


<p>To get the delete links to work, we need to add a <code>destroy</code> action (<a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>), which finds the corresponding user and destroys it with the Active Record <code>destroy</code> method, finally redirecting to the user index, as seen in <a class="ref" href="#code:destroy_action">Listing&nbsp;9.46</a>. Note that we also add <code>:destroy</code> to the <code>signed_in_user</code> before filter.</p>

<div class="label" id="code:destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.46.</span> <span class="description">Adding a working <code>destroy</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;User destroyed.&quot;</span>
    <span class="n">redirect_to</span> <span class="n">users_path</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that the <code>destroy</code> action uses method chaining to combine the <code>find</code> and <code>destroy</code> into one line:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>


<p>As constructed, only admins can destroy users through the web, because only admins can see the delete links. Unfortunately, there&rsquo;s still a terrible security hole: any sufficiently sophisticated attacker could simply issue <tt>DELETE</tt> requests directly from the command line to delete any user on the site. To secure the site properly, we also need access control on the <code>destroy</code> action, so our tests should check not only that admins <em>can</em> delete users, but also that other users <em>can&rsquo;t</em>. The results appear in <a class="ref" href="#code:delete_destroy_test">Listing&nbsp;9.47</a>. Note that, in analogy with the <code>put</code> method from <a class="ref" href="#code:protected_edit_update_tests">Listing&nbsp;9.11</a>, we use <code>delete</code> to issue a <tt>DELETE</tt> request directly to the specified URI (in this case, the user path, as required by <a class="ref" href="#table:RESTful_users">Table&nbsp;7.1</a>).</p>

<div class="label" id="code:delete_destroy_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.47.</span> <span class="description">A test for protecting the <code>destroy</code> action. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;as non-admin user&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:non_admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">non_admin</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;submitting a DELETE request to the Users#destroy action&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="p">}</span>        
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>In principle, there&rsquo;s still a minor security hole, which is that an admin could delete himself by issuing a <tt>DELETE</tt> request directly. One might argue that such an admin is only getting what he deserves, but it would be nice to prevent such an occurrence, and doing so is left as an exercise (<a class="ref" href="#sec:updating_deleting_exercises">Section&nbsp;9.6</a>).</p>

<p>As you might suspect by now, the application code uses a before filter, this time to restrict access to the <code>destroy</code> action to admins. The resulting <code>admin_user</code> before filter appears in <a class="ref" href="#code:admin_destroy_before_filter">Listing&nbsp;9.48</a>.</p>

<div class="label" id="code:admin_destroy_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.48.</span> <span class="description">A before filter restricting the <code>destroy</code> action to admins. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:admin_user</span><span class="p">,</span>     <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point, all the tests should be passing, and the Users resource&mdash;with its controller, model, and views&mdash;is functionally complete.</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<h2><a id="sec:9.5" href="#sec:9.5" class="heading"><span class="number">9.5</span> Conclusion</a></h2>


<p>We&rsquo;ve come a long way since introducing the Users controller way back in <a class="ref" href="#sec:user_signup">Section&nbsp;5.4</a>. Those users couldn&rsquo;t even sign up; now users can sign up, sign in, sign out, view their profiles, edit their settings, and see an index of all users&mdash;and some can even destroy other users.</p>

<p>The rest of this book builds on the foundation of the Users resource (and associated authorization system) to make a site with Twitter-like microposts (<a class="ref" href="#cha:user_microposts">Chapter&nbsp;10</a>) and a status feed of posts from followed users (<a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>). These chapters will introduce some of the most powerful features of Rails, including data modeling with <code>has_many</code> and <code>has_many through</code>.</p>

<p>Before moving on, be sure to merge all the changes into the master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user edit, update, index, and destroy actions&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
</pre></div>
</div>


<p>You can also deploy the application and even populate the production database with sample users (using the <code>pg:reset</code> task to reset the production database):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset SHARED_DATABASE --confirm &lt;name-heroku-gave-to-your-app&gt;
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<p>(If you forgot the name of the Heroku app, just run <code>heroku pg:reset SHARED_DATABASE</code> by itself and Heroku will remind you.)</p>

<p>It&rsquo;s also worth noting that this chapter saw the last of the necessary gem installations. For reference, the final <code>Gemfile</code> is shown in <a class="ref" href="#code:final_gemfile">Listing&nbsp;9.49</a>.</p>

<div class="label" id="code:final_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.49.</span> <span class="description">The final <code>Gemfile</code> for the sample application.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.6&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>

<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.0&#39;</span>

<span class="n">group</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.10.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;guard-rspec&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;guard-spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9.0&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.4.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.0&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:updating_deleting_exercises"></div>


<h2><a id="sec:9.6" href="#sec:updating_deleting_exercises" class="heading"><span class="number">9.6</span> Exercises</a></h2>




<ol>

<li>Following the model in <a class="ref" href="#code:micropost_belongs_to_user_spec">Listing&nbsp;10.8</a>, add a test to verify that the User <code>admin</code> attribute isn&rsquo;t accessible. Be sure to get first to Red, and then to Green. (<em>Hint</em>: Your first step should be to <em>add</em> <code>admin</code> to the accessible list.)</li>

<li>Arrange for the Gravatar &ldquo;change&rdquo; link in <a class="ref" href="#code:user_edit_view">Listing&nbsp;9.3</a> to open in a new window (or tab). <em>Hint:</em> Search the web; you should find one particularly robust method involving something called <code>_blank</code>. </li>

<li>The current authentication tests check that navigation links such as &ldquo;Profile&rdquo; and &ldquo;Settings&rdquo; appear when a user is signed in. Add tests to make sure that these links <em>don&rsquo;t</em> appear when a user isn&rsquo;t signed in.</li>

<li>Use the <code>sign_in</code> test helper from <a class="ref" href="#code:sign_in_helper">Listing&nbsp;9.6</a> in as many places as you can find.</li>

<li>Remove the duplicated form code by refactoring the <code>new.html.erb</code> and <code>edit.html.erb</code> views to use the partial in <a class="ref" href="#code:new_edit_partial">Listing&nbsp;9.50</a>. Note that you will have to pass the form variable&nbsp;<code>f</code> explicitly as a local variable, as shown in <a class="ref" href="#code:new_user_with_partial">Listing&nbsp;9.51</a>. You will also have to update the tests, as the forms aren&rsquo;t currently <em>exactly</em> the same; identify the slight difference and update the tests accordingly.</li>

<li>Signed-in users have no reason to access the <code>new</code> and <code>create</code> actions in the Users controller. Arrange for such users to be redirected to the root URL if they do try to hit those pages.</li>

<li>Learn about the <code>request</code> object by inserting some of the methods listed in the <a href="http://api.rubyonrails.org/v3.2.0/classes/ActionDispatch/Request.html">Rails API</a><sup class="footnote" id="fnref:9.8"><a href="#fn:9.8">8</a></sup> into the site layout. (Refer to <a class="ref" href="#code:rails_debug">Listing&nbsp;7.1</a> if you get stuck.)</li>

<li>Write a test to make sure that the friendly forwarding only forwards to the given URI the first time. On subsequent signin attempts, the forwarding URI should revert to the default (i.e., the profile page). See <a class="ref" href="#code:friendly_forgetting_test">Listing&nbsp;9.52</a> for a hint (and, by a hint, I mean the solution).</li>

<li>Modify the <code>destroy</code> action to prevent admin users from destroying themselves. (Write a test first.)</li>

</ol>




<div class="label" id="code:new_edit_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.50.</span> <span class="description">A partial for the new and edit form fields. <br /> <code>app/views/users/_fields.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirm Password&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:new_user_with_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.51.</span> <span class="description">The new user view with partial. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="ss">f:</span> <span class="n">f</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Create my account&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:friendly_forgetting_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 9.52.</span> <span class="description">A test for forwarding to the default page after friendly forwarding. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>    
      <span class="n">describe</span> <span class="s2">&quot;when attempting to visit a protected page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;after signing in&quot;</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">&quot;should render the desired protected page&quot;</span> <span class="k">do</span>
            <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Edit user&#39;</span><span class="p">)</span>
          <span class="k">end</span>

          <span class="n">describe</span> <span class="s2">&quot;when signing in again&quot;</span> <span class="k">do</span>
            <span class="n">before</span> <span class="k">do</span>
              <span class="n">visit</span> <span class="n">signin_path</span>
              <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
              <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
              <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
            <span class="k">end</span>

            <span class="n">it</span> <span class="s2">&quot;should render the default (profile) page&quot;</span> <span class="k">do</span>
              <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> 
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn:9.1">Image from <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="#fnref:9.1">&uarr;</a></li>
<li id="fn:9.2">The Gravatar site actually redirects this to <a href="http://en.gravatar.com/emails">http://en.gravatar.com/emails</a>, which is for English language users, but I&rsquo;ve omitted the <tt>en</tt> part to account for the use of other languages.&nbsp;<a class="arrow" href="#fnref:9.2">&uarr;</a></li>
<li id="fn:9.3">Don&rsquo;t worry about how this works; the details are of interest to developers of the Rails framework itself, and by design are not important for Rails application developers.&nbsp;<a class="arrow" href="#fnref:9.3">&uarr;</a></li>
<li id="fn:9.4">The code in this section is adapted from the <a href="http://github.com/thoughtbot/clearance">Clearance</a> gem by <a href="http://thoughtbot.com/">thoughtbot</a>.&nbsp;<a class="arrow" href="#fnref:9.4">&uarr;</a></li>
<li id="fn:9.5">Baby photo from <a href="http://www.flickr.com/photos/glasgows/338937124/">http://www.flickr.com/photos/glasgows/338937124/</a>.&nbsp;<a class="arrow" href="#fnref:9.5">&uarr;</a></li>
<li id="fn:9.6">The name <code>user</code> is immaterial&mdash;we could have written <code>@users.each do |foobar|</code> and then used <code>render foobar</code>. The key is the <em>class</em> of the object&mdash;in this case, <code>User</code>.&nbsp;<a class="arrow" href="#fnref:9.6">&uarr;</a></li>
<li id="fn:9.7">Command-line tools such as <tt>curl</tt> can issue <tt>PUT</tt> requests of this form.&nbsp;<a class="arrow" href="#fnref:9.7">&uarr;</a></li>
<li id="fn:9.8">http://api.rubyonrails.org/v3.2.0/classes/ActionDispatch/Request.html&nbsp;<a class="arrow" href="#fnref:9.8">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:user_microposts"></div>


<h1 class="chapter"><a id="sec:10" href="#cha:user_microposts" class="heading"><span class="number">Chapter 10</span> User microposts</a></h1>


<p><a class="ref" href="#cha:updating_showing_and_deleting_users">Chapter&nbsp;9</a> saw the completion of the REST actions for the Users resource, so the time has finally come to add a second full resource: user <em>microposts</em>.<sup class="footnote" id="fnref:10.1"><a href="#fn:10.1">1</a></sup> These are short messages associated with a particular user, first seen in larval form in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>. In this chapter, we will make a full-strength version of the sketch from <a class="ref" href="#sec:microposts_resource">Section&nbsp;2.3</a> by constructing the Micropost data model, associating it with the User model using the <code>has_many</code> and <code>belongs_to</code> methods, and then making the forms and partials needed to manipulate and display the results. In <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>, we&rsquo;ll complete our tiny Twitter clone by adding the notion of <em>following</em> users in order to receive a <em>feed</em> of their microposts.</p>

<p>If you&rsquo;re using Git for version control, I suggest making a topic branch as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div>
</div>




<div class="label" id="sec:a_micropost_model"></div>


<h2><a id="sec:10.1" href="#sec:a_micropost_model" class="heading"><span class="number">10.1</span> A Micropost model</a></h2>


<p>We begin the Microposts resource by creating a Micropost model, which captures the essential characteristics of microposts. What follows builds on the work from <a class="ref" href="#sec:microposts_resource">Section&nbsp;2.3</a>; as with the model in that section, our new Micropost model will include data validations and an association with the User model. Unlike that model, the present Micropost model will be fully tested, and will also have a default <em>ordering</em> and automatic <em>destruction</em> if its parent user is destroyed.</p>

<div class="label" id="sec:the_basic_model"></div>


<h3><a id="sec:10.1.1" href="#sec:the_basic_model" class="heading"><span class="number">10.1.1</span> The basic model</a></h3>


<p>The Micropost model needs only two attributes: a <code>content</code> attribute to hold the micropost&rsquo;s content,<sup class="footnote" id="fnref:10.2"><a href="#fn:10.2">2</a></sup> and a <code>user_id</code> to associate a micropost with a particular user. As with the case of the User model (<a class="ref" href="#code:generate_user_model">Listing&nbsp;6.1</a>), we generate it using <code>generate model</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div>
</div>


<p>This produces a migration to create a <code>microposts</code> table in the database (<a class="ref" href="#code:micropost_migration">Listing&nbsp;10.1</a>); compare it to the analogous migration for the <code>users</code> table from <a class="ref" href="#code:users_migration">Listing&nbsp;6.2</a>.</p>

<div class="label" id="code:micropost_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.1.</span> <span class="description">The Micropost migration. (Note the index on <code>user_id</code> and <code>created_at</code>.) <br /> <code>db/migrate/[timestamp]_create_microposts.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that, since we expect to retrieve all the microposts associated with a given user&nbsp;id in reverse order of creation, <a class="ref" href="#code:micropost_migration">Listing&nbsp;10.1</a> adds an index (<a class="ref" href="#sidebar:database_indices">Box&nbsp;6.2</a>) on the <code>user_id</code> and <code>created_at</code> columns:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div>
</div>


<p>By including both the <code>user_id</code> and <code>created_at</code> columns as an array, we arrange for Rails to create a <em>multiple key index</em>, which means that Active Record uses <em>both</em> keys at the same time. Note also the <code>t.timestamps</code> line, which (as mentioned in <a class="ref" href="#sec:database_migrations">Section&nbsp;6.1.1</a>) adds the magic <code>created_at</code> and <code>updated_at</code> columns. We&rsquo;ll put the <code>created_at</code> column to work in <a class="ref" href="#sec:ordering_and_dependency">Section&nbsp;10.1.4</a> and <a class="ref" href="#sec:augmenting_the_user_show_page">Section&nbsp;10.2.1</a>.</p>

<p>We&rsquo;ll start with some minimal tests for the Micropost model based on the analogous tests for the User model (<a class="ref" href="#code:user_spec">Listing&nbsp;6.8</a>). In particular, we verify that a micropost object responds to the <code>content</code> and <code>user_id</code> attributes, as shown in <a class="ref" href="#code:initial_micropost_spec">Listing&nbsp;10.2</a>.</p>

<div class="label" id="code:initial_micropost_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.2.</span> <span class="description">The initial Micropost spec. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is wrong!</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can get these tests to pass by running the microposts migration and preparing the test database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>The result is a Micropost model with the structure shown in <a class="ref" href="#fig:micropost_model">Figure&nbsp;10.1</a>.</p>

<div class="label" id="fig:micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_model.png" alt="micropost_model" /></span></div><div class="caption"><span class="header">Figure 10.1: </span><span class="description">The Micropost data model.</span></div></div>


<p>You should verify that the tests pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/micropost_spec.rb
</pre></div>
</div>


<p>Even though the tests are passing, you might have noticed this code:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is wrong!</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The comment indicates that the code in the <code>before</code> block is wrong. See if you can guess why. We&rsquo;ll see the answer in the next section.</p>

<div class="label" id="sec:accessible_attribute"></div>


<h3><a id="sec:10.1.2" href="#sec:accessible_attribute" class="heading"><span class="number">10.1.2</span> Accessible attributes and the first validation</a></h3>


<p>To see why the code in the <code>before</code> block is wrong, we first start with validation tests for the Micropost model (<a class="ref" href="#code:micropost_validity_test">Listing&nbsp;10.3</a>). (Compare with the User model tests in <a class="ref" href="#code:failing_validates_name_spec">Listing&nbsp;6.11</a>.)</p>

<div class="label" id="code:micropost_validity_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.3.</span> <span class="description">Tests for the validity of a new micropost. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is wrong!</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code requires that the micropost be valid and tests for the presence of the <code>user_id</code> attribute. We can get these tests to pass with the simple presence validation shown in <a class="ref" href="#code:micropost_user_id_validation">Listing&nbsp;10.4</a>.</p>

<div class="label" id="code:micropost_user_id_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.4.</span> <span class="description">A validation for the micropost&rsquo;s <code>user_id</code>. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>  
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now we&rsquo;re prepared to see why</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>


<p>is wrong. The problem is that by default (as of Rails&nbsp;3.2.3) <em>all</em> of the attributes for our Micropost model are accessible. As discussed in <a class="ref" href="#sec:accessible_attributes">Section&nbsp;6.1.2.2</a> and <a class="ref" href="#sec:revisiting_attr_accessible">Section&nbsp;9.4.1.1</a>, this means that anyone could change any aspect of a micropost object simply by using a command-line client to issue malicious requests. For example, a malicious user could change the <code>user_id</code> attributes on microposts, thereby associating microposts with the wrong users. This means that we should remove <code>:user_id</code> from the <code>attr_accessible</code> list, and once we do, the code above will fail. We&rsquo;ll fix this issue in <a class="ref" href="#sec:user_micropost_associations">Section&nbsp;10.1.3</a>.</p>

<div class="label" id="sec:user_micropost_associations"></div>


<h3><a id="sec:10.1.3" href="#sec:user_micropost_associations" class="heading"><span class="number">10.1.3</span> User/Micropost associations</a></h3>


<p>When constructing data models for web applications, it is essential to be able to make <em>associations</em> between individual models. In the present case, each micropost is associated with one user, and each user is associated with (potentially) many microposts&mdash;a relationship seen briefly in <a class="ref" href="#sec:demo_user_has_many_microposts">Section&nbsp;2.3.3</a> and shown schematically in <a class="ref" href="#fig:micropost_belongs_to_user">Figure&nbsp;10.2</a> and <a class="ref" href="#fig:user_has_many_microposts">Figure&nbsp;10.3</a>. As part of implementing these associations, we&rsquo;ll write tests for the Micropost model that, unlike <a class="ref" href="#code:initial_micropost_spec">Listing&nbsp;10.2</a>, are compatible with the use of <code>attr_accessible</code> in <a class="ref" href="#code:micropost_accessible_attribute">Listing&nbsp;10.7</a>.</p>

<div class="label" id="fig:micropost_belongs_to_user"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_belongs_to_user.png" alt="micropost_belongs_to_user" /></span></div><div class="caption"><span class="header">Figure 10.2: </span><span class="description">The <code>belongs_to</code> relationship between a micropost and its user.</span></div></div>




<div class="label" id="fig:user_has_many_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_microposts.png" alt="user_has_many_microposts" /></span></div><div class="caption"><span class="header">Figure 10.3: </span><span class="description">The <code>has_many</code> relationship between a user and its microposts.</span></div></div>


<p>Using the <code>belongs_to</code>/<code>has_many</code> association defined in this section, Rails constructs the methods shown in <a class="ref" href="#table:association_methods">Table&nbsp;10.1</a>.</p>

<div class="label" id="table:association_methods"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>Method</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><code>micropost.user</code></td><td class="align_left">Return the User object associated with the micropost.</td></tr><tr><td class="align_left"><code>user.microposts</code></td><td class="align_left">Return an array of the user&rsquo;s microposts.</td></tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td><td class="align_left">Create a micropost (<code>user_id = user.id</code>).</td></tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td><td class="align_left">Create a micropost (exception on failure).</td></tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td><td class="align_left">Return a new Micropost object (<code>user_id = user.id</code>).</td></tr></table></div><div class="caption"><span class="header">Table 10.1: </span><span class="description">A summary of user/micropost association methods.</span></div></div>


<p>Note from <a class="ref" href="#table:association_methods">Table&nbsp;10.1</a> that instead of</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>


<p>we have</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>This pattern is the canonical way to make a micropost: <em>through</em> its association with a user. When a new micropost is made in this way, its <code>user_id</code> is <em>automatically</em> set to the right value, which fixes the issue noted in <a class="ref" href="#sec:accessible_attribute">Section&nbsp;10.1.2</a>. In particular, we can replace the code</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># This code is wrong!</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>from <a class="ref" href="#code:micropost_validity_test">Listing&nbsp;10.3</a> with</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>Once we define the proper associations, the resulting <code>@micropost</code> variable will automatically have <code>user_id</code> equal to its associated user.</p>

<p>Building the micropost through the User association doesn&rsquo;t fix the security problem of having an accessible <code>user_id</code>, and
because this is such an important security concern we&rsquo;ll add a failing test to catch it, as shown in <a class="ref" href="#code:attr_accessible_user_id_test">Listing&nbsp;10.5</a>.</p>

<div class="label" id="code:attr_accessible_user_id_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.5.</span> <span class="description">A test to ensure that the <code>user_id</code> isn&rsquo;t accessible. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to user_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This test verifies that calling <code>Micropost.new</code> with a nonempty <code>user_id</code> raises a mass assignment security error exception. This behavior is on by default as of Rails&nbsp;3.2.3, but previous versions had it off, so you should make sure that your application is configured properly, as shown in <a class="ref" href="#code:application_whitelist">Listing&nbsp;10.6</a>.</p>

<div class="label" id="code:application_whitelist"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.6.</span> <span class="description">Ensuring that Rails throws errors on invalid mass assignment. <br /> <code>config/application.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails::Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">whitelist_attributes</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>In the case of the Micropost model, there is only <em>one</em> attribute that needs to be editable through the web, namely, the <code>content</code> attribute, so we need to remove <code>:user_id</code> from the accessible list, as shown in <a class="ref" href="#code:micropost_accessible_attribute">Listing&nbsp;10.7</a>.</p>

<div class="label" id="code:micropost_accessible_attribute"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.7.</span> <span class="description">Making the <code>content</code> attribute (and <em>only</em> the <code>content</code> attribute) accessible. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As seen in <a class="ref" href="#table:association_methods">Table&nbsp;10.1</a>, another result of the user/micropost association is <code>micropost.user</code>, which simply returns the micropost&rsquo;s user. We can test this with the <code>it</code> and <code>its</code> methods as follows:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>
</pre></div>
</div>


<p>The resulting Micropost model tests are shown in <a class="ref" href="#code:micropost_belongs_to_user_spec">Listing&nbsp;10.8</a>.</p>

<div class="label" id="code:micropost_belongs_to_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.8.</span> <span class="description">Tests for the micropost&rsquo;s user association. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to user_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>On the User model side of the association, we&rsquo;ll defer the more detailed tests to <a class="ref" href="#sec:ordering_and_dependency">Section&nbsp;10.1.4</a>; for now, we&rsquo;ll simply test for the presence of a <code>microposts</code> attribute (<a class="ref" href="#code:user_has_many_microposts_spec">Listing&nbsp;10.9</a>).</p>

<div class="label" id="code:user_has_many_microposts_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.9.</span> <span class="description">A test for the user&rsquo;s <code>microposts</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>After all that work, the code to implement the association is almost comically short: we can get the tests in both <a class="ref" href="#code:micropost_belongs_to_user_spec">Listing&nbsp;10.8</a> and <a class="ref" href="#code:user_has_many_microposts_spec">Listing&nbsp;10.9</a> to pass by adding just two lines: <code>belongs_to :user</code> (<a class="ref" href="#code:micropost_belongs_to_user">Listing&nbsp;10.10</a>) and <code>has_many :microposts</code> (<a class="ref" href="#code:user_has_many_microposts">Listing&nbsp;10.11</a>).</p>

<div class="label" id="code:micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.10.</span> <span class="description">A micropost <code>belongs_to</code> a user. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>  
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.11.</span> <span class="description">A user <code>has_many</code> microposts. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point, you should compare the entries in <a class="ref" href="#table:association_methods">Table&nbsp;10.1</a> with the code in <a class="ref" href="#code:micropost_belongs_to_user_spec">Listing&nbsp;10.8</a> and <a class="ref" href="#code:user_has_many_microposts_spec">Listing&nbsp;10.9</a> to satisfy yourself that you understand the basic nature of the associations. You should also check that the tests pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models
</pre></div>
</div>




<div class="label" id="sec:ordering_and_dependency"></div>


<h3><a id="sec:10.1.4" href="#sec:ordering_and_dependency" class="heading"><span class="number">10.1.4</span> Micropost refinements</a></h3>


<p>The test in <a class="ref" href="#code:user_has_many_microposts_spec">Listing&nbsp;10.9</a> of the <code>has_many</code> association doesn&rsquo;t test for much&mdash;it merely verifies the <em>existence</em> of a <code>microposts</code> attribute. In this section, we&rsquo;ll add <em>ordering</em> and <em>dependency</em> to microposts, while also testing that the <code>user.microposts</code> method actually returns an array of microposts.</p>

<p>We will need to construct some microposts in the User model test, which means that we should make a micropost factory at this point. To do this, we need a way to make an association in Factory Girl. Happily, this is easy, as seen in <a class="ref" href="#code:micropost_factory">Listing&nbsp;10.12</a>.</p>

<div class="label" id="code:micropost_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.12.</span> <span class="description">The complete factory file, including a new factory for microposts. <br /> <code>spec/factories.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we tell Factory Girl about the micropost&rsquo;s associated user just by including a user in the definition of the factory:</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div>
</div>


<p>As we&rsquo;ll see in the next section, this allows us to define factory microposts as follows:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<div class="label" id="sec:default_scope"></div>


<h4><a id="sec:10.1.4.1" href="#sec:default_scope" class="heading">Default scope</a></h4>


<p>By default, using <code>user.microposts</code> to pull a user&rsquo;s microposts from the database makes no guarantees about the order of the posts, but (following the convention of blogs and Twitter) we want the microposts to come out in reverse order of when they were created, i.e., most recent first. To test this ordering, we first create a couple of microposts as follows:</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
<span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<p>Here we indicate (using the time helpers discussed in <a class="ref" href="#sidebar:time_helpers">Box&nbsp;8.1</a>) that the second post was created more recently, i.e., <code>1.hour.ago</code>, while the first post was created <code>1.day.ago</code>. Note how convenient the use of Factory Girl is: not only can we assign the user using mass assignment (since factories bypass <code>attr_accessible</code>), we can also set <code>created_at</code> manually, which Active Record won&rsquo;t allow us to do. (Recall that <code>created_at</code> and <code>updated_at</code> are &ldquo;magic&rdquo; columns, automatically set to the proper creation and update timestamps, so any explicit initialization values are overwritten by the magic.)</p>

<p>Most database adapters (including the one for SQLite) return the microposts in order of their ids, so we can arrange for an initial test that almost certainly fails using the code in <a class="ref" href="#code:micropost_ordering_test">Listing&nbsp;10.13</a>. This uses the <code>let!</code> (read &ldquo;let bang&rdquo;) method in place of <code>let</code>; the reason is that <code>let</code> variables are <em>lazy</em>, meaning that they only spring into existence when referenced. The problem is that we want the microposts to exist immediately, so that the timestamps are in the right order and so that <code>@user.microposts</code> isn&rsquo;t empty. We accomplish this with <code>let!</code>, which forces the corresponding variable to come into existence immediately.</p>

<div class="label" id="code:micropost_ordering_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.13.</span> <span class="description">Testing the order of a user&rsquo;s microposts. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right microposts in the right order&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The key line here is</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
</pre></div>
</div>


<p>indicating that the posts should be ordered newest first. This should fail because by default the posts will be ordered by&nbsp;id, i.e., <code>[older_micropost, newer_micropost]</code>. This test also verifies the basic correctness of the <code>has_many</code> association itself, by checking (as indicated in <a class="ref" href="#table:association_methods">Table&nbsp;10.1</a>) that <code>user.microposts</code> is an array of microposts.</p>

<p>To get the ordering test to pass, we use a Rails facility called <code>default_scope</code> with an <code>:order</code> parameter, as shown in <a class="ref" href="#code:micropost_ordering">Listing&nbsp;10.14</a>. (This is our first example of the notion of <em>scope</em>. We will learn about scope in a more general context in <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>.)</p>

<div class="label" id="code:micropost_ordering"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.14.</span> <span class="description">Ordering the microposts with <code>default_scope</code>.  <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The order here is <code>&rsquo;microposts.created_at DESC&rsquo;</code>, where <code>DESC</code> is SQL for &ldquo;descending&rdquo;, i.e., in descending order from newest to oldest.</p>

<div class="label" id="sec:dependent_destroy"></div>


<h4><a id="sec:10.1.4.2" href="#sec:dependent_destroy" class="heading">Dependent: destroy</a></h4>


<p>Apart from proper ordering, there is a second refinement we&rsquo;d like to add to microposts. Recall from <a class="ref" href="#sec:destroying_users">Section&nbsp;9.4</a> that site administrators have the power to <em>destroy</em> users. It stands to reason that, if a user is destroyed, the user&rsquo;s microposts should be destroyed as well. We can test for this by first destroying a micropost&rsquo;s user and then verifying that the associated microposts are no longer in the database (<a class="ref" href="#code:micropost_dependency_test">Listing&nbsp;10.15</a>).</p>

<div class="label" id="code:micropost_dependency_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.15.</span> <span class="description">Testing that microposts are destroyed when users are. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should destroy associated microposts&quot;</span> <span class="k">do</span>
      <span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we have used <code>Micropost.find_by_id</code>, which returns <code>nil</code> if the record is not found, whereas <code>Micropost.find</code> raises an exception on failure, which is a bit harder to test for. (In case you&rsquo;re curious,</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span> 
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveRecord::RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>


<p>does the trick in this case.)</p>

<p>The application code to get <a class="ref" href="#code:micropost_dependency_test">Listing&nbsp;10.15</a> to pass is less than one line; in fact, it&rsquo;s just an option to the <code>has_many</code> association method, as shown in <a class="ref" href="#code:micropost_dependency">Listing&nbsp;10.16</a>.</p>

<div class="label" id="code:micropost_dependency"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.16.</span> <span class="description">Ensuring that a user&rsquo;s microposts are destroyed along with the user. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here the option <code>dependent: :destroy</code> in</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
</pre></div>
</div>


<p>arranges for the dependent microposts (i.e., the ones belonging to the given user) to be destroyed when the user itself is destroyed. This prevents userless microposts from being stranded in the database when admins choose to remove users from the system.</p>

<p>With that, the final form of the user/micropost association is in place, and all the tests should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:micropost_validations"></div>


<h3><a id="sec:10.1.5" href="#sec:micropost_validations" class="heading"><span class="number">10.1.5</span> Content validations</a></h3>


<p>Before leaving the Micropost model, we&rsquo;ll add validations for the micropost <code>content</code>  (following the example from <a class="ref" href="#sec:putting_the_micro_in_microposts">Section&nbsp;2.3.2</a>). Like the <code>user_id</code>, the <code>content</code> attribute must be present, and it is further constrained to be no longer than 140 characters, making it an honest <em>micro</em>post. The tests generally follow the examples from the User model validation tests in <a class="ref" href="#sec:user_validations">Section&nbsp;6.2</a>, as shown in <a class="ref" href="#code:micropost_validations_tests">Listing&nbsp;10.17</a>.</p>

<div class="label" id="code:micropost_validations_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.17.</span> <span class="description">Tests for the Micropost model validations. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with blank content&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with content that is too long&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">141</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As in <a class="ref" href="#sec:user_validations">Section&nbsp;6.2</a>, the code in <a class="ref" href="#code:micropost_validations_tests">Listing&nbsp;10.17</a> uses string multiplication to test the micropost length validation:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 10
<span class="go">=&gt; &quot;aaaaaaaaaa&quot;</span>
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 141
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
</pre></div>
</div>


<p>The application code is a one-liner:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
</pre></div>
</div>


<p>The resulting Micropost model is shown in <a class="ref" href="#code:micropost_validations">Listing&nbsp;10.18</a>.</p>

<div class="label" id="code:micropost_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.18.</span> <span class="description">The Micropost model validations. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:showing_microposts"></div>


<h2><a id="sec:10.2" href="#sec:showing_microposts" class="heading"><span class="number">10.2</span> Showing microposts</a></h2>


<p>Although we don&rsquo;t yet have a way to create microposts through the web&mdash;that comes in <a class="ref" href="#sec:creating_microposts">Section&nbsp;10.3.2</a>&mdash;that won&rsquo;t stop us from displaying them (and testing that display). Following Twitter&rsquo;s lead, we&rsquo;ll plan to display a user&rsquo;s microposts not on a separate microposts <code>index</code> page, but rather directly on the user <code>show</code> page itself, as mocked up in <a class="ref" href="#fig:user_microposts_mockup">Figure&nbsp;10.4</a>. We&rsquo;ll start with fairly simple ERb templates for adding a micropost display to the user profile, and then we&rsquo;ll add microposts to the sample data populator from <a class="ref" href="#sec:sample_users">Section&nbsp;9.3.2</a> so that we have something to display.</p>

<div class="label" id="fig:user_microposts_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_microposts_mockup_bootstrap.png" alt="user_microposts_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.4: </span><span class="description">A mockup of a profile page with microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_microposts_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>As with the discussion of the signin machinery in <a class="ref" href="#sec:remember_me">Section&nbsp;8.2.1</a>, <a class="ref" href="#sec:augmenting_the_user_show_page">Section&nbsp;10.2.1</a> will often push several elements onto the <a href="http://en.wikipedia.org/wiki/Stack_(data_structure)">stack</a> at a time, and then pop them off one by one. If you start getting bogged down, be patient; there&rsquo;s some nice payoff in <a class="ref" href="#sec:sample_microposts">Section&nbsp;10.2.2</a>.</p>

<div class="label" id="sec:augmenting_the_user_show_page"></div>


<h3><a id="sec:10.2.1" href="#sec:augmenting_the_user_show_page" class="heading"><span class="number">10.2.1</span> Augmenting the user show page</a></h3>


<p>We begin with tests for displaying the user&rsquo;s microposts, which we&rsquo;ll create in the request spec for Users. Our strategy is to create a couple of factory microposts associated with the user, and then verify that the show page contains each post&rsquo;s content. We&rsquo;ll also verify that, as in <a class="ref" href="#fig:user_microposts_mockup">Figure&nbsp;10.4</a>, the total number of microposts also gets displayed.</p>

<p>We can create the posts with the <code>let</code> method, but as in <a class="ref" href="#code:micropost_ordering_test">Listing&nbsp;10.13</a> we want the association to exist immediately so that the posts appear on the user show page. To accomplish this, we use the <code>let!</code> variant:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

<span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>With the microposts so defined, we can test for their appearance on the profile page using the code in <a class="ref" href="#code:user_show_microposts_test">Listing&nbsp;10.19</a>.</p>

<div class="label" id="code:user_show_microposts_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.19.</span> <span class="description">A test for showing microposts on the user <code>show</code> page. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;microposts&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note here that we can use the <code>count</code> method <em>through</em> the association:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>The association <code>count</code> method is smart, and performs the count directly in the database. In particular, it does <em>not</em> pull all the microposts out of the database and then call <code>length</code> on the resulting array, as this could become inefficient as the number of microposts grew. Instead, it asks the database to count the microposts with the given <code>user_id</code>. In the unlikely event that finding the count is still a bottleneck in your application, you can make it even faster with a <a href="http://railscasts.com/episodes/23-counter-cache-column"><em>counter cache</em></a>.</p>

<p>Although the tests in <a class="ref" href="#code:user_show_microposts_test">Listing&nbsp;10.19</a> won&rsquo;t pass until <a class="ref" href="#code:micropost_partial">Listing&nbsp;10.21</a>, we&rsquo;ll get started on the application code by inserting a list of microposts into the user profile page, as shown in <a class="ref" href="#code:user_show_microposts">Listing&nbsp;10.20</a>.</p>

<div class="label" id="code:user_show_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.20.</span> <span class="description">Adding microposts to the user <code>show</code> page. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
  <span class="nt">&lt;aside&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>We&rsquo;ll deal with the microposts list momentarily, but there are several other things to note first. In <a class="ref" href="#code:user_show_microposts">Listing&nbsp;10.20</a>, the use of <code>if @user.microposts.any?</code> (a construction we saw before in <a class="ref" href="#code:errors_partial">Listing&nbsp;7.23</a>) makes sure that an empty list won&rsquo;t be displayed when the user has no microposts.</p>

<p>Also note from <a class="ref" href="#code:user_show_microposts">Listing&nbsp;10.20</a> that we&rsquo;ve preemptively added pagination for microposts through</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>If you compare this with the analogous line on the user index page, <a class="ref" href="#code:will_paginate_index_view">Listing&nbsp;9.34</a>, you&rsquo;ll see that before we had just</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This worked because, in the context of the Users controller, <code>will_paginate</code> <em>assumes</em> the existence of an instance variable called <code>@users</code> (which, as we saw in <a class="ref" href="#sec:pagination">Section&nbsp;9.3.3</a>, should be of class <code>ActiveRecord::Relation</code>). In the present case, since we are still in the Users controller but want to paginate <em>microposts</em> instead, we pass an explicit <code>@microposts</code> variable to <code>will_paginate</code>. Of course, this means that we will have to define such a variable in the user <code>show</code> action (<a class="ref" href="#code:user_show_microposts_instance">Listing&nbsp;10.22</a>).</p>

<p>Finally, note that we have taken this opportunity to add a count of the current number of microposts:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</pre></div>
</div>


<p>As noted, <code>@user.microposts.count</code> is the analogue of the <code>User.count</code> method, except that it counts the microposts belonging to a given user through the user/micropost association.</p>

<p>We come finally to the micropost list itself:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div>
</div>


<p>This code, which uses the <em>ordered list</em> tag&nbsp;<code>ol</code>, is responsible for generating the list of microposts, but you can see that it just defers the heavy lifting to a micropost partial. We saw in <a class="ref" href="#sec:partial_refactoring">Section&nbsp;9.3.4</a> that the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>automatically renders each of the users in the <code>@users</code> variable using the <code>_user.html.erb</code> partial. Similarly, the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>does exactly the same thing for microposts. This means that we must define a <code>_micropost.html.erb</code> partial (along with a <code>micropost</code> views directory), as shown in <a class="ref" href="#code:micropost_partial">Listing&nbsp;10.21</a>.</p>

<div class="label" id="code:micropost_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.21.</span> <span class="description">A partial for showing a single micropost. <br /> <code>app/views/microposts/_micropost.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>This uses the awesome <code>time_ago_in_words</code> helper method, whose effect we will see in <a class="ref" href="#sec:sample_microposts">Section&nbsp;10.2.2</a>.</p>

<p>Thus far, despite defining all the relevant ERb templates, the test in <a class="ref" href="#code:user_show_microposts_test">Listing&nbsp;10.19</a> should have been failing for want of an <code>@microposts</code> variable. We can get it to pass with <a class="ref" href="#code:user_show_microposts_instance">Listing&nbsp;10.22</a>.</p>

<div class="label" id="code:user_show_microposts_instance"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.22.</span> <span class="description">Adding an <code>@microposts</code> instance variable to the user <code>show</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notice here how clever <code>paginate</code> is&mdash;it even works through the microposts association, reaching into the <tt>microposts</tt> table and pulling out the desired page of microposts.</p>

<p>At this point, we can get a look at our new user profile page in <a class="ref" href="#fig:user_profile_no_microposts">Figure&nbsp;10.5</a>. It&rsquo;s rather&hellip; disappointing. Of course, this is because there are not currently any microposts. It&rsquo;s time to change that.</p>

<div class="label" id="fig:user_profile_no_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_no_microposts_bootstrap.png" alt="user_profile_no_microposts_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.5: </span><span class="description">The user profile page with code for microposts&mdash;but no microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_no_microposts_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:sample_microposts"></div>


<h3><a id="sec:10.2.2" href="#sec:sample_microposts" class="heading"><span class="number">10.2.2</span> Sample microposts</a></h3>


<p>With all the work making templates for user microposts in <a class="ref" href="#sec:augmenting_the_user_show_page">Section&nbsp;10.2.1</a>, the ending was rather anticlimactic. We can rectify this sad situation by adding microposts to the sample populator from <a class="ref" href="#sec:sample_users">Section&nbsp;9.3.2</a>. Adding sample microposts for <em>all</em> the users actually takes a rather long time, so first we&rsquo;ll select just the first six users<sup class="footnote" id="fnref:10.3"><a href="#fn:10.3">3</a></sup> using the <code>:limit</code> option to the <code>User.all</code> method:<sup class="footnote" id="fnref:10.4"><a href="#fn:10.4">4</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>


<p>We then make 50 microposts for each user (plenty to overflow the pagination limit of&nbsp;30), generating sample content for each micropost using the Faker gem&rsquo;s handy <a href="http://faker.rubyforge.org/rdoc/classes/Faker/Lorem.html"><tt>Lorem.sentence</tt> method</a>. (<code>Faker::Lorem.sentence</code> returns <em>lorem ipsum</em> text; as noted in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>, <em>lorem ipsum</em> has a <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">fascinating back story</a>.) The result is the new sample data populator shown in <a class="ref" href="#code:sample_microposts">Listing&nbsp;10.23</a>.</p>

<div class="label" id="code:sample_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.23.</span> <span class="description">Adding microposts to the sample data. <br /> <code>lib/tasks/sample_data.rake</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
    <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Of course, to generate the new sample data we have to run the <code>db:populate</code> Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>With that, we are in a position to enjoy the fruits of our <a class="ref" href="#sec:augmenting_the_user_show_page">Section&nbsp;10.2.1</a> labors by displaying information for each micropost.<sup class="footnote" id="fnref:10.5"><a href="#fn:10.5">5</a></sup> The preliminary results appear in <a class="ref" href="#fig:user_profile_microposts_no_styling">Figure&nbsp;10.6</a>.</p>

<div class="label" id="fig:user_profile_microposts_no_styling"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_microposts_no_styling_bootstrap.png" alt="user_profile_microposts_no_styling_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.6: </span><span class="description">The user profile (<a href="http://localhost:3000/users/1">/users/1</a>) with unstyled microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_microposts_no_styling_bootstrap-full.png">(full size)</a></span></div></div>


<p>The page shown in <a class="ref" href="#fig:user_profile_microposts_no_styling">Figure&nbsp;10.6</a> has no micropost-specific styling, so let&rsquo;s add some (<a class="ref" href="#code:micropost_css">Listing&nbsp;10.24</a>) and take a look the resulting pages.<sup class="footnote" id="fnref:10.6"><a href="#fn:10.6">6</a></sup> <a class="ref" href="#fig:user_profile_with_microposts">Figure&nbsp;10.7</a>, which displays the user profile page for the first (signed-in) user, while <a class="ref" href="#fig:other_profile_with_microposts">Figure&nbsp;10.8</a> shows the profile for a second user. Finally, <a class="ref" href="#fig:user_profile_microposts_page_2_rails_3">Figure&nbsp;10.9</a> shows the <em>second</em> page of microposts for the first user, along with the pagination links at the bottom of the display. In all three cases, observe that each micropost display indicates the time since it was created (e.g., &ldquo;Posted 1 minute ago.&rdquo;); this is the work of the <code>time_ago_in_words</code> method from <a class="ref" href="#code:micropost_partial">Listing&nbsp;10.21</a>. If you wait a couple minutes and reload the pages, you&rsquo;ll see how the text gets automatically updated based on the new time.</p>

<div class="label" id="code:micropost_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.24.</span> <span class="description">The CSS for microposts (including all the CSS for this chapter). <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.content</span> <span class="p">{</span>
  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_with_microposts_bootstrap.png" alt="user_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.7: </span><span class="description">The user profile (<a href="http://localhost:3000/users/1">/users/1</a>) with microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_with_microposts_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:other_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/other_profile_with_microposts_bootstrap.png" alt="other_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.8: </span><span class="description">The profile of a different user, also with microposts (<a href="http://localhost:3000/users/3">/users/3</a>).&nbsp;<a href="http://railstutorial.org/images/figures/other_profile_with_microposts_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:user_profile_microposts_page_2_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_microposts_page_2_rails_3_bootstrap.png" alt="user_profile_microposts_page_2_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.9: </span><span class="description">Micropost pagination links (<a href="http://localhost:3000/users/1?page=2">/users/1?page=2</a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_microposts_page_2_rails_3_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:manipulating_microposts"></div>


<h2><a id="sec:10.3" href="#sec:manipulating_microposts" class="heading"><span class="number">10.3</span> Manipulating microposts</a></h2>


<p>Having finished both the data modeling and display templates for microposts, we now turn our attention to the interface for creating them through the web. The result will be our third example of using an HTML form to create a resource&mdash;in this case, a Microposts resource.<sup class="footnote" id="fnref:10.7"><a href="#fn:10.7">7</a></sup> In this section, we&rsquo;ll also see the first hint of a <em>status feed</em>&mdash;a notion brought to full fruition in <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>. Finally, as with users, we&rsquo;ll make it possible to destroy microposts through the web.</p>

<p>There is one break with past convention worth noting: the interface to the Microposts resource will run principally through the Users and StaticPages controllers, rather than relying on a controller of its own. This means that the routes for the Microposts resource are unusually simple, as seen in <a class="ref" href="#code:microposts_resource">Listing&nbsp;10.25</a>. The code in <a class="ref" href="#code:microposts_resource">Listing&nbsp;10.25</a> leads in turn to the RESTful routes shown in <a class="ref" href="#table:RESTful_microposts">Table&nbsp;10.2</a>, which is a small subset of the full set of routes seen in <a class="ref" href="#table:demo_RESTful_microposts">Table&nbsp;2.3</a>. Of course, this simplicity is a sign of being <em>more</em> advanced, not less&mdash;we&rsquo;ve come a long way since our reliance on scaffolding in <a class="ref" href="#cha:a_demo_app">Chapter&nbsp;2</a>, and we no longer need most of its complexity.</p>

<div class="label" id="code:microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.25.</span> <span class="description">Routes for the Microposts resource. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table:RESTful_microposts"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>POST</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>create</code></td><td class="align_left">create a new micropost</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">delete micropost with id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 10.2: </span><span class="description">RESTful routes provided by the Microposts resource in <a class="ref" href="#code:microposts_resource">Listing&nbsp;10.25</a>.</span></div></div>




<div class="label" id="sec:access_control"></div>


<h3><a id="sec:10.3.1" href="#sec:access_control" class="heading"><span class="number">10.3.1</span> Access control</a></h3>


<p>We begin our development of the Microposts resource with some access control in the Microposts controller. The idea is simple: both the <code>create</code> and <code>destroy</code> actions should require users to be signed in. The RSpec code to test for this appears in <a class="ref" href="#code:micropost_access_control">Listing&nbsp;10.26</a>. (We&rsquo;ll test for and add a third protection&mdash;ensuring that only a micropost&rsquo;s user can destroy it&mdash;in <a class="ref" href="#sec:destroying_microposts">Section&nbsp;10.3.4</a>.)</p>

<div class="label" id="code:micropost_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.26.</span> <span class="description">Access control tests for microposts. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Microposts controller&quot;</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the create action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">microposts_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the destroy action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">))</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Rather than using the (yet-to-be-built) web interface for microposts, the code in <a class="ref" href="#code:micropost_access_control">Listing&nbsp;10.26</a> operates at the level of the individual micropost actions, a strategy we first saw in <a class="ref" href="#code:edit_update_wrong_user_tests">Listing&nbsp;9.14</a>. In this case, a non-signed-in user is redirected upon submitting a <tt>POST</tt> request to /microposts (<code>post microposts_path</code>, which hits the <code>create</code> action) or submitting a <tt>DELETE</tt> request to /microposts/1 (<code>delete micropost_path(micropost)</code>, which hits the <code>destroy</code> action).</p>

<p>Writing the application code needed to get the tests in <a class="ref" href="#code:micropost_access_control">Listing&nbsp;10.26</a> to pass requires a little refactoring first. Recall from <a class="ref" href="#sec:requiring_signed_in_users">Section&nbsp;9.2.1</a> that we enforced the signin requirement using a before filter that called the <code>signed_in_user</code> method (<a class="ref" href="#code:authorize_before_filter">Listing&nbsp;9.12</a>). At the time, we only needed that method in the Users controller, but now we find that we need it in the Microposts controller as well, so we&rsquo;ll move it into the Sessions helper, as shown in <a class="ref" href="#code:sessions_helper_authenticate">Listing&nbsp;10.27</a>.<sup class="footnote" id="fnref:10.8"><a href="#fn:10.8">8</a></sup></p>

<div class="label" id="code:sessions_helper_authenticate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.27.</span> <span class="description">Moving the <code>signed_in_user</code> method into the Sessions helper. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in_user</span>
    <span class="k">unless</span> <span class="n">signed_in?</span>
      <span class="n">store_location</span>
      <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To avoid code repetition, you should also remove <code>signed_in_user</code> from the Users controller at this time.</p>

<p>With the code in <a class="ref" href="#code:sessions_helper_authenticate">Listing&nbsp;10.27</a>, the <code>signed_in_user</code> method is now available in the Microposts controller, which means that we can restrict access to the <code>create</code> and <code>destroy</code> actions with the before filter shown in <a class="ref" href="#code:microposts_controller_access_control">Listing&nbsp;10.28</a>. (Since we didn&rsquo;t generate it at the command line, you will have to create the Microposts controller file by hand.)</p>

<div class="label" id="code:microposts_controller_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.28.</span> <span class="description">Adding authentication to the Microposts controller actions. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we haven&rsquo;t restricted the actions the before filter applies to since it applies to them both by default. If we were to add, say, an <code>index</code> action accessible even to non-signed-in users, we would need to specify the protected actions explicitly:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>At this point, the tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec:creating_microposts"></div>


<h3><a id="sec:10.3.2" href="#sec:creating_microposts" class="heading"><span class="number">10.3.2</span> Creating microposts</a></h3>


<p>In <a class="ref" href="#cha:sign_up">Chapter&nbsp;7</a>, we implemented user signup by making an HTML form that issued an HTTP <tt>POST</tt> request to the <code>create</code> action in the Users controller. The implementation of micropost creation is similar; the main difference is that, rather than using a separate page at /microposts/new, we will (following Twitter&rsquo;s convention) put the form on the Home page itself (i.e., the root path&nbsp;/), as mocked up in <a class="ref" href="#fig:home_page_with_micropost_form_mockup">Figure&nbsp;10.10</a>.</p>

<div class="label" id="fig:home_page_with_micropost_form_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_micropost_form_mockup_bootstrap.png" alt="home_page_with_micropost_form_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.10: </span><span class="description">A mockup of the Home page with a form for creating microposts.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_micropost_form_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>When we last left the Home page, it appeared as in <a class="ref" href="#fig:sample_app_logo">Figure&nbsp;5.6</a>&mdash;that is, it had a &ldquo;Sign up now!&rdquo; button in the middle. Since a micropost creation form only makes sense in the context of a particular signed-in user, one goal of this section will be to serve different versions of the Home page depending on a visitor&rsquo;s signin status. We&rsquo;ll implement this in <a class="ref" href="#code:microposts_home_page">Listing&nbsp;10.31</a> below, but we can still write the tests now. As with the Users resource, we&rsquo;ll use an integration test:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test micropost_pages
</pre></div>
</div>


<p>The micropost creation tests then parallel those for user creation from <a class="ref" href="#code:basic_signup_tests">Listing&nbsp;7.16</a>; the result appears in <a class="ref" href="#code:microposts_create_tests">Listing&nbsp;10.29</a>.</p>

<div class="label" id="code:microposts_create_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.29.</span> <span class="description">Tests for creating microposts. <br /> <code>spec/requests/micropost_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;micropost creation&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;error messages&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span> 
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">fill_in</span> <span class="s1">&#39;micropost_content&#39;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Lorem ipsum&quot;</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s2">&quot;should create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;ll start with the <code>create</code> action for microposts, which is similar to its user analogue (<a class="ref" href="#code:user_create_action">Listing&nbsp;7.25</a>); the principal difference lies in using the user/micropost association to <code>build</code> the new micropost, as seen in <a class="ref" href="#code:microposts_create_action">Listing&nbsp;10.30</a>.</p>

<div class="label" id="code:microposts_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.30.</span> <span class="description">The Microposts controller <code>create</code> action. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To build a form for creating microposts, we use the code in <a class="ref" href="#code:microposts_home_page">Listing&nbsp;10.31</a>, which serves up different HTML based on whether the site visitor is signed in or not.</p>

<div class="label" id="code:microposts_home_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.31.</span> <span class="description">Adding microposts creation to the Home page (<a href="http://localhost:3000/">/</a>). <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;/div&gt;</span>  
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> 
                                <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span> 
</pre></div>
</div></div>


<p>Having so much code in each branch of the <code>if</code>-<code>else</code> conditional is a bit messy, and cleaning it up using partials is left as an exercise (<a class="ref" href="#sec:micropost_exercises">Section&nbsp;10.5</a>). Filling in the necessary partials from <a class="ref" href="#code:microposts_home_page">Listing&nbsp;10.31</a> isn&rsquo;t an exercise, though; we fill in the new Home page sidebar in <a class="ref" href="#code:user_info">Listing&nbsp;10.32</a>
and the micropost form partial in <a class="ref" href="#code:micropost_form">Listing&nbsp;10.33</a>.</p>

<div class="label" id="code:user_info"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.32.</span> <span class="description">The partial for the user info sidebar. <br /> <code>app/views/shared/_user_info.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;view my profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;micropost&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div></div>


<p>As in <a class="ref" href="#code:user_index_view">Listing&nbsp;9.25</a>, the code in <a class="ref" href="#code:user_info">Listing&nbsp;10.32</a> uses the version of the <code>gravatar_for</code> helper defined in <a class="ref" href="#code:gravatar_option">Listing&nbsp;7.29</a>.</p>

<p>Note that, as in the profile sidebar (<a class="ref" href="#code:user_show_microposts">Listing&nbsp;10.20</a>), the user info in <a class="ref" href="#code:user_info">Listing&nbsp;10.32</a> displays the total number of microposts for the user. There&rsquo;s a slight difference in the display, though; in the profile sidebar, &ldquo;Microposts&rdquo; is a label, and showing &ldquo;Microposts (1)&rdquo; makes sense. In the present case, though, saying &ldquo;1 microposts&rdquo; is ungrammatical, so we arrange to display &ldquo;1 micropost&rdquo; (but &ldquo;2 microposts&rdquo;) using <code>pluralize</code>.</p>

<p>We next define the form for creating microposts (<a class="ref" href="#code:micropost_form">Listing&nbsp;10.33</a>), which is similar to the signup form in <a class="ref" href="#code:signup_form">Listing&nbsp;7.17</a>.</p>

<div class="label" id="code:micropost_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.33.</span> <span class="description">The form partial for creating microposts. <br /> <code>app/views/shared/_micropost_form.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder:</span> <span class="s2">&quot;Compose new micropost...&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Post&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>We need to make two changes before the form in <a class="ref" href="#code:micropost_form">Listing&nbsp;10.33</a> will work. First, we need to define <code>@micropost</code>, which (as before) we do through the association:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>The result appears in <a class="ref" href="#code:micropost_instance_variable">Listing&nbsp;10.34</a>.</p>

<div class="label" id="code:micropost_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.34.</span> <span class="description">Adding a micropost instance variable to the <code>home</code> action. <br /> <code>app/controllers/static_pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:micropost_instance_variable">Listing&nbsp;10.34</a> has the advantage that it will break the test suite if we forget to require the user to sign in.</p>

<p>The second change needed to get <a class="ref" href="#code:micropost_form">Listing&nbsp;10.33</a> to work is to redefine the error messages partial so that</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>works. You may recall from <a class="ref" href="#code:f_error_messages">Listing&nbsp;7.22</a> that the error messages partial references the <code>@user</code> variable explicitly, but in the present case we have an <code>@micropost</code> variable instead. We should define an error messages partial that works regardless of the kind of object passed to it. Happily, the form variable&nbsp;<code>f</code> can access the associated object through <code>f.object</code>, so that in</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code> is <code>@user</code>, and in</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code> is <code>@micropost</code>.</p>

<p>To pass the object to the partial, we use a hash with value equal to the object and key equal to the desired name of the variable in the partial, which is what this code accomplishes:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>In other words, <code>object: f.object</code> creates a variable called <code>object</code> in the <code>error_messages</code> partial. We can use this object to construct a customized error message, as shown in <a class="ref" href="#code:updated_error_messages_partial">Listing&nbsp;10.35</a>.</p>

<div class="label" id="code:updated_error_messages_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.35.</span> <span class="description">Updating the error-messages partial from <a class="ref" href="#code:errors_partial">Listing&nbsp;7.23</a> to work with other objects. <br /> <code>app/views/shared/_error_messages.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>As this point, the tests in <a class="ref" href="#code:microposts_create_tests">Listing&nbsp;10.29</a> should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/micropost_pages_spec.rb
</pre></div>
</div>


<p>Unfortunately, the User request spec is now broken because the signup and edit forms use the old version of the error messages partial. To fix them, we&rsquo;ll update them with the more general version, as shown in <a class="ref" href="#code:signup_errors_updated">Listing&nbsp;10.36</a> and <a class="ref" href="#code:edit_errors_updated">Listing&nbsp;10.37</a>. (<em>Note</em>: Your code will differ if you implemented <a class="ref" href="#code:new_edit_partial">Listing&nbsp;9.50</a> and <a class="ref" href="#code:new_user_with_partial">Listing&nbsp;9.51</a> from the exercises in <a class="ref" href="#sec:updating_deleting_exercises">Section&nbsp;9.6</a>. <a href="http://en.wikipedia.org/wiki/Mutatis_mutandis"><em>Mutatis mutandis</em>.</a>)</p>

<div class="label" id="code:signup_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.36.</span> <span class="description">Updating the rendering of user signup errors. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:edit_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.37.</span> <span class="description">Updating the errors for editing users. <br /> <code>app/views/users/edit.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span> 
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>At this point, all the tests should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Additionally, all the HTML in this section should render properly, showing the form as in <a class="ref" href="#fig:home_with_form">Figure&nbsp;10.11</a>, and a form with a submission error as in <a class="ref" href="#fig:home_form_errors">Figure&nbsp;10.12</a>. You are invited at this point to create a new post for yourself and verify that everything is working&mdash;but you should probably wait until after <a class="ref" href="#sec:a_proto_feed">Section&nbsp;10.3.3</a>.</p>

<div class="label" id="fig:home_with_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_with_form_bootstrap.png" alt="home_with_form_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.11: </span><span class="description">The Home page (<a href="http://localhost:3000/">/</a>) with a new micropost form.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_form_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:home_form_errors"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_form_errors_bootstrap.png" alt="home_form_errors_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.12: </span><span class="description">The home page with form errors.&nbsp;<a href="http://railstutorial.org/images/figures/home_form_errors_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:a_proto_feed"></div>


<h3><a id="sec:10.3.3" href="#sec:a_proto_feed" class="heading"><span class="number">10.3.3</span> A proto-feed</a></h3>


<p>The comment at the end of <a class="ref" href="#sec:creating_microposts">Section&nbsp;10.3.2</a> alluded to a problem: the current Home page doesn&rsquo;t display any microposts. If you like, you can verify that the form shown in <a class="ref" href="#fig:home_with_form">Figure&nbsp;10.11</a> is working by submitting a valid entry and then navigating to the <a href="http://localhost:3000/users/1">profile page</a> to see the post, but that&rsquo;s rather cumbersome. It would be far better to have a <em>feed</em> of microposts that includes the user&rsquo;s own posts, as mocked up in <a class="ref" href="#fig:proto_feed_mockup">Figure&nbsp;10.13</a>. (In <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>, we&rsquo;ll generalize this feed to include the microposts of users being <em>followed</em> by the current user.)</p>

<div class="label" id="fig:proto_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/proto_feed_mockup_bootstrap.png" alt="proto_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.13: </span><span class="description">A mockup of the Home page with a proto-feed.&nbsp;<a href="http://railstutorial.org/images/figures/proto_feed_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>Since each user should have a feed, we are led naturally to a <code>feed</code> method in the User model. Eventually, we will test that the feed returns the microposts of the users being followed, but for now we&rsquo;ll just test that the <code>feed</code> method <em>includes</em> the current user&rsquo;s microposts but <em>excludes</em> the posts of a different user. We can express these requirements in code with <a class="ref" href="#code:feed_specs">Listing&nbsp;10.38</a>.</p>

<div class="label" id="code:feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.38.</span> <span class="description">Tests for the (proto-)status feed. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>These tests introduce (via the RSpec boolean convention) the array <code>include?</code> method, which simply checks if an array includes the given element:<sup class="footnote" id="fnref:10.9"><a href="#fn:10.9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>This example shows just how flexible the RSpec boolean convention is; even though <code>include</code> is already a Ruby keyword (used to include a module, as seen in, e.g., <a class="ref" href="#code:sessions_helper_include">Listing&nbsp;8.14</a>), in this context RSpec correctly guesses that we want to test array inclusion.</p>

<p>We can arrange for an appropriate micropost <code>feed</code> method by selecting all the microposts with <code>user_id</code> equal to the current user&rsquo;s id, which we accomplish using the <code>where</code> method on the <code>Micropost</code> model, as shown in <a class="ref" href="#code:proto_status_feed">Listing&nbsp;10.39</a>.<sup class="footnote" id="fnref:10.10"><a href="#fn:10.10">10</a></sup></p>

<div class="label" id="code:proto_status_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.39.</span> <span class="description">A preliminary implementation for the micropost status feed. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># This is preliminary. See &quot;Following users&quot; for the full implementation.</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The question mark in</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>ensures that <code>id</code>&nbsp;is properly <em>escaped</em> before being included in the underlying SQL query, thereby avoiding a serious security hole called <a href="http://en.wikipedia.org/wiki/SQL_injection"><em>SQL injection</em></a>. The&nbsp;<code>id</code> attribute here is just an integer, so there is no danger in this case, but <em>always</em> escaping variables injected into SQL statements is a good habit to cultivate.</p>

<p>Alert readers might note at this point that the code in <a class="ref" href="#code:proto_status_feed">Listing&nbsp;10.39</a> is essentially equivalent to writing</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We&rsquo;ve used the code in <a class="ref" href="#code:proto_status_feed">Listing&nbsp;10.39</a> instead because it generalizes much more naturally to the full status feed needed in <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>.</p>

<p>To test the display of the status feed, we first create a couple of microposts and then verify that a list element (<code>li</code>) appears on the page for each one (<a class="ref" href="#code:home_page_feed_test">Listing&nbsp;10.40</a>).</p>

<div class="label" id="code:home_page_feed_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.40.</span> <span class="description">A test for rendering the feed on the Home page. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Dolor sit amet&quot;</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the user&#39;s feed&quot;</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:home_page_feed_test">Listing&nbsp;10.40</a> assumes that each feed item has a unique CSS&nbsp;id, so that</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>


<p>will generate a match for each item. (Note that the first&nbsp;<code>#</code> in <code>li##{item.id}</code> is Capybara syntax for a CSS&nbsp;id, whereas the second&nbsp;<code>#</code> is the beginning of a Ruby string interpolation&nbsp;<code>#{}</code>.)</p>

<p>To use the feed in the sample application, we add an <code>@feed_items</code> instance variable for the current user&rsquo;s (paginated) feed, as in <a class="ref" href="#code:feed_instance_variable">Listing&nbsp;10.41</a>, and then add a feed partial (<a class="ref" href="#code:feed_partial">Listing&nbsp;10.42</a>) to the Home page (<a class="ref" href="#code:home_with_feed">Listing&nbsp;10.44</a>). (Adding tests for pagination is left as an exercise; see <a class="ref" href="#sec:micropost_exercises">Section&nbsp;10.5</a>.)</p>

<div class="label" id="code:feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.41.</span> <span class="description">Adding a feed instance variable to the <code>home</code> action. <br /> <code>app/controllers/static_pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:feed_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.42.</span> <span class="description">The status feed partial. <br /> <code>app/views/shared/_feed.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>The status feed partial defers the feed item rendering to a feed item partial using the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Here we pass a <code>:collection</code> parameter with the feed items, which causes <code>render</code> to use the given partial (<code>&rsquo;feed_item&rsquo;</code> in this case) to render each item in the collection. (We have omitted the <code>:partial</code> parameter in previous renderings, writing, e.g., <code>render &rsquo;shared/micropost&rsquo;</code>, but with a <code>:collection</code> parameter that syntax doesn&rsquo;t work.) The feed item partial itself appears in <a class="ref" href="#code:feed_item_partial">Listing&nbsp;10.43</a>.</p>

<div class="label" id="code:feed_item_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.43.</span> <span class="description">A partial for a single feed item. <br /> <code>app/views/shared/_feed_item.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:feed_item_partial">Listing&nbsp;10.43</a> also adds a CSS&nbsp;id for each feed item using</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>as required by the test in <a class="ref" href="#code:home_page_feed_test">Listing&nbsp;10.40</a>.</p>

<p>We can then add the feed to the Home page by rendering the feed partial as usual (<a class="ref" href="#code:home_with_feed">Listing&nbsp;10.44</a>). The result is a display of the feed on the Home page, as required (<a class="ref" href="#fig:home_with_proto_feed">Figure&nbsp;10.14</a>).</p>

<div class="label" id="code:home_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.44.</span> <span class="description">Adding a status feed to the Home page. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    .
    .
    .
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/feed&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_with_proto_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_with_proto_feed_bootstrap.png" alt="home_with_proto_feed_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.14: </span><span class="description">The Home page (<a href="http://localhost:3000/">/</a>) with a proto-feed.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_proto_feed-full.png">(full size)</a></span></div></div>


<p>At this point, creating a new micropost works as expected, as seen in <a class="ref" href="#fig:micropost_created">Figure&nbsp;10.15</a>. There is one subtlety, though: on <em>failed</em> micropost submission, the Home page expects an <code>@feed_items</code> instance variable, so failed submissions currently break (as you should be able to verify by running your test suite). The easiest solution is to suppress the feed entirely by assigning it an empty array, as shown in <a class="ref" href="#code:microposts_create_action_with_feed">Listing&nbsp;10.45</a>.<sup class="footnote" id="fnref:10.11"><a href="#fn:10.11">11</a></sup></p>

<div class="label" id="fig:micropost_created"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_created_bootstrap.png" alt="micropost_created_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.15: </span><span class="description">The Home page after creating a new micropost.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_created_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="code:microposts_create_action_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.45.</span> <span class="description">Adding an (empty) <code>@feed_items</code> instance variable to the <code>create</code> action. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point, the proto-feed should be working, and the test suite should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:destroying_microposts"></div>


<h3><a id="sec:10.3.4" href="#sec:destroying_microposts" class="heading"><span class="number">10.3.4</span> Destroying microposts</a></h3>


<p>The last piece of functionality to add to the Microposts resource is the ability to destroy posts. As with user deletion (<a class="ref" href="#sec:the_destroy_action">Section&nbsp;9.4.2</a>), we accomplish this with &ldquo;delete&rdquo; links, as mocked up in <a class="ref" href="#fig:micropost_delete_links_mockup">Figure&nbsp;10.16</a>. Unlike that case, which restricted user destruction to admin users, the delete links will work only for microposts created by the current user.</p>

<div class="label" id="fig:micropost_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_delete_links_mockup_bootstrap.png" alt="micropost_delete_links_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.16: </span><span class="description">A mockup of the proto-feed with micropost delete links.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_delete_links_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>Our first step is to add a delete link to the micropost partial as in <a class="ref" href="#code:feed_item_partial">Listing&nbsp;10.43</a>, and while we&rsquo;re at it we&rsquo;ll add a similar link to the feed item partial from <a class="ref" href="#code:feed_item_partial">Listing&nbsp;10.43</a>. The results appear in <a class="ref" href="#code:micropost_partial_with_delete">Listing&nbsp;10.46</a> and <a class="ref" href="#code:feed_item_partial_with_delete">Listing&nbsp;10.47</a>. (The two cases are almost identical, and eliminating this duplication is left as an exercise (<a class="ref" href="#sec:micropost_exercises">Section&nbsp;10.5</a>).)</p>

<div class="label" id="code:micropost_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.46.</span> <span class="description">Adding a delete link to the micropost partial. <br /> <code>app/views/microposts/_micropost.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:feed_item_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.47.</span> <span class="description">The feed item partial with added delete link. <br /> <code>app/views/shared/_feed_item.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>The test for destroying microposts uses Capybara to click the &ldquo;delete&rdquo; link and expects the Micropost count to decrease by&nbsp;1 (<a class="ref" href="#code:micropost_destroy_specs">Listing&nbsp;10.48</a>).</p>

<div class="label" id="code:micropost_destroy_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.48.</span> <span class="description">Tests for the Microposts controller <code>destroy</code> action. <br /> <code>spec/requests/micropost_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost destruction&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;as correct user&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">&quot;should delete a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;delete&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The application code is also analogous to the user case in <a class="ref" href="#code:admin_destroy_before_filter">Listing&nbsp;9.48</a>; the main difference is that, rather than using an <code>admin_user</code> before filter, in the case of microposts we have a <code>correct_user</code> before filter to check that the current user actually has a micropost with the given id. The code appears in <a class="ref" href="#code:microposts_destroy_action">Listing&nbsp;10.49</a>, and the result of destroying the second-most-recent post appears in <a class="ref" href="#fig:home_post_delete">Figure&nbsp;10.17</a>.</p>

<div class="label" id="code:microposts_destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.49.</span> <span class="description">The Microposts controller <code>destroy</code> action. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>In the <code>correct_user</code> before filter, note that we find microposts <em>through</em> the association:</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>This automatically ensures that we find only microposts belonging to the current user. In this case, we use <code>find_by_id</code> instead of <code>find</code> because the latter raises an exception when the micropost doesn&rsquo;t exist instead of returning <code>nil</code>. By the way, if you&rsquo;re comfortable with exceptions in Ruby, you could also write the <code>correct_user</code> filter like this:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">correct_user</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">rescue</span>
  <span class="n">redirect_to</span> <span class="n">root_path</span>
<span class="k">end</span>
</pre></div>
</div>


<p>It might occur to you that we could implement the <code>correct_user</code> filter using the <code>Micropost</code> model directly, like this:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="n">redirect_to</span> <span class="n">root_path</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>This would be equivalent to the code in <a class="ref" href="#code:microposts_destroy_action">Listing&nbsp;10.49</a>, but, as explained by <a href="http://www.rubyfocus.biz/">Wolfram Arnold</a> in the blog post <a href="http://www.rubyfocus.biz/blog/2011/06/15/access_control_101_in_rails_and_the_citibank-hack.html">Access Control 101 in Rails and the Citibank Hack</a>, for security purposes it is a good practice always to run lookups through the association.</p>

<div class="label" id="fig:home_post_delete"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_post_delete_bootstrap.png" alt="home_post_delete_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.17: </span><span class="description">The user home page after deleting the second-most-recent micropost.&nbsp;<a href="http://railstutorial.org/images/figures/home_post_delete_bootstrap-full.png">(full size)</a></span></div></div>


<p>With the code in this section, our Micropost model and interface are complete, and the test suite should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<h2><a id="sec:10.4" href="#sec:10.4" class="heading"><span class="number">10.4</span> Conclusion</a></h2>


<p>With the addition of the Microposts resource, we are nearly finished with our sample application. All that remains is to add a social layer by letting users follow each other. We&rsquo;ll learn how to model such user relationships, and see the implications for the status feed, in <a class="ref" href="#cha:following_users">Chapter&nbsp;11</a>.</p>

<p>Before proceeding, be sure to commit and merge your changes if you&rsquo;re using Git for version control:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add user microposts&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
<span class="gp">$</span> git push
</pre></div>
</div>


<p>You can also push the app up to Heroku at this point. Because the data model has changed through the addition of the <code>microposts</code> table, you will also need to migrate the production database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset SHARED_DATABASE --confirm &lt;name-heroku-gave-to-your-app&gt;
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<div class="label" id="sec:micropost_exercises"></div>


<h2><a id="sec:10.5" href="#sec:micropost_exercises" class="heading"><span class="number">10.5</span> Exercises</a></h2>


<p>We&rsquo;ve covered enough material now that there is a combinatorial explosion of possible extensions to the application. Below are just a few of the many possibilities.</p>

<ol>
<li>Add tests for the sidebar micropost counts (including proper pluralization).</li>
<li>Add tests for micropost pagination.</li>
<li>Refactor the Home page to use separate partials for the two branches of the <code>if</code>-<code>else</code> statement.</li>
<li>Write a test to make sure delete links do not appear for microposts not created by the current user.</li>
<li>Using partials, eliminate the duplication in the delete links from <a class="ref" href="#code:micropost_partial_with_delete">Listing&nbsp;10.46</a> and <a class="ref" href="#code:feed_item_partial_with_delete">Listing&nbsp;10.47</a>.</li>
<li>Very long words currently break our layout, as shown in <a class="ref" href="#fig:long_word_micropost">Figure&nbsp;10.18</a>. Fix this problem using the <code>wrap</code> helper defined in <a class="ref" href="#code:wrap">Listing&nbsp;10.50</a>. Note the use of the <code>raw</code> method to prevent Rails from escaping the resulting HTML, together with the <code>sanitize</code> method needed to prevent cross-site scripting. This code also uses the strange-looking but useful <em>ternary operator</em> (<a class="ref" href="#sidebar:ternary_operator">Box&nbsp;10.1</a>).</li>
<li><strong>(challenging)</strong> Add a JavaScript display to the Home page to count down from&nbsp;140 characters.</li>
</ol>




<div class="label" id="sidebar:ternary_operator"></div>


<div class="sidebar"><span class="title"><span class="header">Box 10.1.</span><span class="description">10 types of people</span></span>
<p>There are 10 kinds of people in the world: Those who like the ternary operator, those who don&rsquo;t, and those who don&rsquo;t know about it. (If you happen to be in the third category, soon you won&rsquo;t be any longer.)</p>

<p>When you do a lot of programming, you quickly learn that one of the most common bits of control flow goes something like this:</p>

<pre class="verbatim">  if boolean? 
    do_one_thing 
  else 
    do_something_else 
  end </pre>


<p>Ruby, like many other languages (including C/C++, Perl, PHP, and Java), allows you to replace this with a much more compact expression using the <em>ternary operator</em> (so called because it consists of three parts):</p>

<pre class="verbatim">  boolean? ? do_one_thing : do_something_else </pre>


<p>You can also use the ternary operator to replace assignment:</p>

<pre class="verbatim">  if boolean?
    var = foo
  else 
    var = bar
  end </pre>


<p>becomes</p>

<pre class="verbatim">  var = boolean? ? foo : bar</pre>


<p>Another common use is in a function&rsquo;s return value:</p>

<pre class="verbatim">  def foo
    do_stuff
    boolean? ? &quot;bar&quot; : &quot;baz&quot;
  end</pre>


<p>Since Ruby implicitly returns the value of the last expression in a function, here the <tt>foo</tt> method returns <tt>"bar"</tt> or <tt>"baz"</tt> depending on the value of <tt>boolean?</tt>. It is this final construction that appears in <a class="ref" href="#code:wrap">Listing&nbsp;10.50</a>.</p>
</div>




<div class="label" id="fig:long_word_micropost"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/long_word_micropost_bootstrap.png" alt="long_word_micropost_bootstrap" /></span></div><div class="caption"><span class="header">Figure 10.18: </span><span class="description">The (broken) site layout with a particularly long word.&nbsp;<a href="http://railstutorial.org/images/figures/long_word_micropost_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="code:wrap"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.50.</span> <span class="description">A helper to wrap long words. <br /> <code>app/helpers/microposts_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">&quot;&amp;#8203;&quot;</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span> 
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn:10.1">Technically, we treated sessions as a resource in <a class="ref" href="#cha:sign_in_sign_out">Chapter&nbsp;8</a>, but sessions are not saved to the database the way users and microposts are.&nbsp;<a class="arrow" href="#fnref:10.1">&uarr;</a></li>
<li id="fn:10.2">The <code>content</code> attribute will be a <code>string</code>, but, as noted briefly in <a class="ref" href="#sec:modeling_demo_microposts">Section&nbsp;2.1.2</a>, for longer text fields you should use the <code>text</code> data type.&nbsp;<a class="arrow" href="#fnref:10.2">&uarr;</a></li>
<li id="fn:10.3">(i.e., the five users with custom Gravatars, and one with the default Gravatar)&nbsp;<a class="arrow" href="#fnref:10.3">&uarr;</a></li>
<li id="fn:10.4">Tail your <code>log/development.log</code> file if you&rsquo;re curious about the SQL this method generates.&nbsp;<a class="arrow" href="#fnref:10.4">&uarr;</a></li>
<li id="fn:10.5">By design, the Faker gem&rsquo;s <em>lorem ipsum</em> text is randomized, so the contents of your sample microposts will differ.&nbsp;<a class="arrow" href="#fnref:10.5">&uarr;</a></li>
<li id="fn:10.6">For convenience, <a class="ref" href="#code:micropost_css">Listing&nbsp;10.24</a> actually has <em>all</em> the CSS needed for this chapter.&nbsp;<a class="arrow" href="#fnref:10.6">&uarr;</a></li>
<li id="fn:10.7">The other two resources are Users in <a class="ref" href="#sec:signup_form">Section&nbsp;7.2</a> and Sessions in <a class="ref" href="#sec:signin_failure">Section&nbsp;8.1</a>.&nbsp;<a class="arrow" href="#fnref:10.7">&uarr;</a></li>
<li id="fn:10.8">We noted in <a class="ref" href="#sec:remember_me">Section&nbsp;8.2.1</a> that helper methods are available only in <em>views</em> by default, but we arranged for the Sessions helper methods to be available in the controllers as well by adding <code>include SessionsHelper</code> to the Application controller (<a class="ref" href="#code:sessions_helper_include">Listing&nbsp;8.14</a>).&nbsp;<a class="arrow" href="#fnref:10.8">&uarr;</a></li>
<li id="fn:10.9">Learning about methods such as <code>include?</code> is one reason why, as noted in <a class="ref" href="#sec:comments_for_various_readers">Section&nbsp;1.1.1</a>, I recommend reading a pure Ruby book after finishing this one.&nbsp;<a class="arrow" href="#fnref:10.9">&uarr;</a></li>
<li id="fn:10.10">See the Rails Guide on the <a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a> for more on <code>where</code> and the like.&nbsp;<a class="arrow" href="#fnref:10.10">&uarr;</a></li>
<li id="fn:10.11">Unfortunately, returning a paginated feed doesn&rsquo;t work in this case. Implement it and click on a pagination link to see why.&nbsp;<a class="arrow" href="#fnref:10.11">&uarr;</a></li>
</ol>
</div>




<div class="label" id="cha:following_users"></div>


<h1 class="chapter"><a id="sec:11" href="#cha:following_users" class="heading"><span class="number">Chapter 11</span> Following users</a></h1>


<p>In this chapter, we will complete the core sample application by adding a social layer that allows users to follow (and unfollow) other users, resulting in each user&rsquo;s Home page displaying a status feed of the followed users&rsquo; microposts. We will also make views to display both a user&rsquo;s followers and the users each user is following. We will learn how to model relationships between users in <a class="ref" href="#sec:the_relationship_model">Section&nbsp;11.1</a>, and then make the web interface in <a class="ref" href="#sec:a_web_interface_for_following_and_followers">Section&nbsp;11.2</a> (including an introduction to Ajax). Finally, we&rsquo;ll end by developing a fully functional status feed in <a class="ref" href="#sec:the_status_feed">Section&nbsp;11.3</a>.</p>

<p>This final chapter contains some of the most challenging material in the tutorial, including some Ruby/SQL trickery to make the status feed. Through these examples, you will see how Rails can handle even rather intricate data models, which should serve you well as you go on to develop your own applications with their own specific requirements. To help with the transition from tutorial to independent development, <a class="ref" href="#sec:following_conclusion">Section&nbsp;11.4</a> contains suggested extensions to the core sample application, along with pointers to more advanced resources.</p>

<p>As usual, Git users should create a new topic branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b following-users
</pre></div>
</div>


<p>Because the material in this chapter is particularly challenging, before writing any code we&rsquo;ll pause for a moment and take a tour of the interface. As in previous chapters, at this early stage we&rsquo;ll represent pages using mockups.<sup class="footnote" id="fnref:11.1"><a href="#fn:11.1">1</a></sup>  The full page flow runs as follows: a user (John Calvin) starts at his profile page (<a class="ref" href="#fig:page_flow_profile_mockup">Figure&nbsp;11.1</a>) and navigates to the Users page (<a class="ref" href="#fig:page_flow_user_index_mockup">Figure&nbsp;11.2</a>) to select a user to follow. Calvin navigates to the profile of a second user, Thomas Hobbes (<a class="ref" href="#fig:page_flow_other_profile_follow_button_mockup">Figure&nbsp;11.3</a>), clicking on the &ldquo;Follow&rdquo; button to follow that user. This changes the &ldquo;Follow&rdquo; button to &ldquo;Unfollow&rdquo;, and increments Hobbes&rsquo;s &ldquo;followers&rdquo; count by one (<a class="ref" href="#fig:page_flow_other_profile_unfollow_button_mockup">Figure&nbsp;11.4</a>). Navigating to his home page, Calvin now sees an incremented &ldquo;following&rdquo; count and finds Hobbes&rsquo;s microposts in his status feed (<a class="ref" href="#fig:page_flow_home_page_feed_mockup">Figure&nbsp;11.5</a>). The rest of this chapter is dedicated to making this page flow actually work.</p>

<div class="label" id="fig:page_flow_profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_profile_mockup_bootstrap.png" alt="page_flow_profile_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.1: </span><span class="description">The current user&rsquo;s profile.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_profile_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:page_flow_user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_user_index_mockup_bootstrap.png" alt="page_flow_user_index_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.2: </span><span class="description">Finding a user to follow.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_user_index_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:page_flow_other_profile_follow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_other_profile_follow_button_mockup_bootstrap.png" alt="page_flow_other_profile_follow_button_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.3: </span><span class="description">The profile of a user to follow, with a follow button.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_other_profile_follow_button_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:page_flow_other_profile_unfollow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap.png" alt="page_flow_other_profile_unfollow_button_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.4: </span><span class="description">A profile with an unfollow button and incremented followers count.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:page_flow_home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="page_flow_home_page_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.5: </span><span class="description">The Home page with status feed and incremented following count.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_home_page_feed_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:the_relationship_model"></div>


<h2><a id="sec:11.1" href="#sec:the_relationship_model" class="heading"><span class="number">11.1</span> The Relationship model</a></h2>


<p>Our first step in implementing following users is to construct a data model, which is not as straightforward as it seems.  Na&iuml;vely, it seems that a <code>has_many</code> relationship should do: a user <code>has_many</code> followed users and <code>has_many</code> followers. As we will see, there is a problem with this approach, and we&rsquo;ll learn how to fix it using <code>has_many through</code>. It&rsquo;s likely that many of the ideas in this section won&rsquo;t seem obvious at first, and it may take a while for the rather complicated data model to sink in. If you find yourself getting confused, try pushing forward to the end; then, read the section a second time through to see if things are clearer.</p>

<div class="label" id="sec:a_problem_with_the_data_model"></div>


<h3><a id="sec:11.1.1" href="#sec:a_problem_with_the_data_model" class="heading"><span class="number">11.1.1</span> A problem with the data model (and a solution)</a></h3>


<p>As a first step toward constructing a data model for following users, let&rsquo;s examine a typical case. For instance, consider a user who follows a second user: we could say that, e.g., Calvin is following Hobbes, and Hobbes is followed by Calvin, so that Calvin is the <em>follower</em> and Hobbes is <em>followed</em>. Using Rails&rsquo; default pluralization convention, the set of all users following a given user is that user&rsquo;s <em>followers</em>, and <code>user.followers</code> is an array of those users. Unfortunately, the reverse doesn&rsquo;t work: by default, the set of all followed users would be called the <em>followeds</em>, which is ungrammatical and clumsy. We could call them <em>following</em>, but that&rsquo;s ambiguous: in normal English, a &ldquo;following&rdquo; is the set of people following <em>you</em>, i.e., your followers&mdash;exactly the opposite of the intended meaning. Although we will use &ldquo;following&rdquo; as a label, as in &ldquo;50 following, 75 followers&rdquo;, we&rsquo;ll use &ldquo;followed users&rdquo; for the users themselves, with a corresponding <code>user.followed_users</code> array.<sup class="footnote" id="fnref:11.2"><a href="#fn:11.2">2</a></sup></p>

<p>This discussion suggests modeling the followed users as in <a class="ref" href="#fig:naive_user_has_many_following">Figure&nbsp;11.6</a>, with a <code>followed_users</code> table and a <code>has_many</code> association. Since <code>user.followed_users</code> should be an array of users, each row of the <code>followed_users</code> table would need to be a user, as identified by the <code>followed_id</code>, together with the <code>follower_id</code> to establish the association.<sup class="footnote" id="fnref:11.3"><a href="#fn:11.3">3</a></sup> In addition, since each row is a user, we would need to include the user&rsquo;s other attributes, including the name, password, etc.</p>

<div class="label" id="fig:naive_user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/naive_user_has_many_followed_users.png" alt="naive_user_has_many_followed_users" /></span></div><div class="caption"><span class="header">Figure 11.6: </span><span class="description">A na&iuml;ve implementation of user following.</span></div></div>


<p>The problem with the data model in <a class="ref" href="#fig:naive_user_has_many_following">Figure&nbsp;11.6</a> is that it is terribly redundant: each row contains not only each followed user&rsquo;s id, but all their other information as well&mdash;all of which are <em>already</em> in the <code>users</code> table. Even worse, to model user <em>followers</em> we would need a separate, similarly redundant <code>followers</code> table. Finally, this data model is a maintainability nightmare: each time a user changed (say) his name, we would need to update not just the user&rsquo;s record in the <code>users</code> table but also <em>every row containing that user</em>
in both the <code>followed_users</code> and <code>followers</code> tables.</p>

<p>The problem here is that we are missing an underlying abstraction. One way to find the proper abstraction is to consider how we might implement the act of <em>following</em> in a web application. Recall from <a class="ref" href="#sec:a_users_resource">Section&nbsp;7.1.2</a> that the REST architecture involves <em>resources</em> that are created and destroyed. This leads us to ask two questions: When a user follows another user, what is being created? When a user <em>un</em>follows another user, what is being destroyed?</p>

<p>Upon reflection, we see that in these cases the application should either create or destroy a <em>relationship</em> between two users. A user then <code>has_many :relationships</code>, and has many <code>followed_users</code> (or <code>followers</code>) <em>through</em> these relationships. Indeed, <a class="ref" href="#fig:naive_user_has_many_following">Figure&nbsp;11.6</a> already contains most of the implementation: since each followed user is uniquely identified by <code>followed_id</code>, we could convert <code>followed_users</code> to a <code>relationships</code> table, omit the user details, and use <code>followed_id</code> to retrieve the followed user from the <code>users</code> table. Moreover, by considering <em>reverse</em> relationships, we could use the <code>follower_id</code> column to extract an array of user&rsquo;s followers.</p>

<p>To make a <code>followed_users</code> array of users, it would be possible to pull out an array of <code>followed_id</code> attributes and then find the user for each one. As you might expect, though, Rails has a way to make this procedure more convenient, and the relevant technique is known as <code>has_many through</code>. As we will see in <a class="ref" href="#sec:following">Section&nbsp;11.1.4</a>, Rails allows us to say that a user is following many users <em>through</em> the relationships table, using the succinct code</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:followed</span>
</pre></div>
</div>


<p>This code automatically populates <code>user.followed_users</code> with an array of followed users. A diagram of the data model appears in <a class="ref" href="#fig:user_has_many_following">Figure&nbsp;11.7</a>.</p>

<div class="label" id="fig:user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_followed_users.png" alt="user_has_many_followed_users" /></span></div><div class="caption"><span class="header">Figure 11.7: </span><span class="description">A model of followed users through user relationships.</span></div></div>


<p>To get started with the implementation, we first generate a Relationship model as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div>
</div>


<p>Since we will be finding relationships by <code>follower_id</code> and by <code>followed_id</code>, we should add an index on each column for efficiency, as shown in <a class="ref" href="#code:relationships_migration">Listing&nbsp;11.1</a>.</p>

<div class="label" id="code:relationships_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.1.</span> <span class="description">Adding indices for the <code>relationships</code> table. <br /> <code>db/migrate/[timestamp]_create_relationships.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code:relationships_migration">Listing&nbsp;11.1</a> also includes a <em>composite</em> index that enforces uniqueness of pairs of (<code>follower_id</code>, <code>followed_id</code>), so that a user can&rsquo;t follow another user more than once:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>(Compare to the email uniqueness index from <a class="ref" href="#code:email_uniqueness_index">Listing&nbsp;6.22</a>.) As we&rsquo;ll see starting in <a class="ref" href="#sec:following">Section&nbsp;11.1.4</a>, our user interface won&rsquo;t allow this to happen, but adding a unique index arranges to raise an error if a user tries to create duplicate relationships anyway (using, e.g., a command-line tool such as <tt>curl</tt>). We could also add a uniqueness validation to the Relationship model, but because it is <em>always</em> an error to create duplicate relationships, the unique index is sufficient for our purposes.</p>

<p>To create the <code>relationships</code> table, we migrate the database and prepare the test database as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>The result is the Relationship data model shown in <a class="ref" href="#fig:relationship_model">Figure&nbsp;11.8</a>.</p>

<div class="label" id="fig:relationship_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/relationship_model.png" alt="relationship_model" /></span></div><div class="caption"><span class="header">Figure 11.8: </span><span class="description">The Relationship data model.</span></div></div>




<div class="label" id="sec:relationship_user_associations"></div>


<h3><a id="sec:11.1.2" href="#sec:relationship_user_associations" class="heading"><span class="number">11.1.2</span> User/relationship associations</a></h3>


<p>Before implementing followed users and followers, we first need to establish the association between users and relationships. A user <code>has_many</code> relationships, and&mdash;since relationships involve <em>two</em> users&mdash;a relationship <code>belongs_to</code> both a follower and a followed user.</p>

<p>As with microposts in <a class="ref" href="#sec:user_micropost_associations">Section&nbsp;10.1.3</a>, we will create new relationships using the user association, with code such as</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>We start with some tests, shown in <a class="ref" href="#code:relationship_create_test">Listing&nbsp;11.2</a>, which make a <code>relationship</code> variable, checks that it is valid, and ensures that the <code>follower_id</code> isn&rsquo;t accessible. (If the test for accessible attributes doesn&rsquo;t fail, be sure that your <code>application.rb</code> has been updated in accordance with <a class="ref" href="#code:application_whitelist">Listing&nbsp;10.6</a>.)</p>

<div class="label" id="code:relationship_create_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.2.</span> <span class="description">Testing Relationship creation and attributes. <br /> <code>spec/models/relationship_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="p">{</span> <span class="n">follower</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">relationship</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to follower_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Relationship</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">follower_id:</span> <span class="n">follower</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that, unlike the tests for the User and Micropost models, which use <code>@user</code> and <code>@micropost</code>, respectively, <a class="ref" href="#code:relationship_create_test">Listing&nbsp;11.2</a> uses <code>let</code> in preference to an instance variable. The differences rarely matter,<sup class="footnote" id="fnref:11.4"><a href="#fn:11.4">4</a></sup> but I consider <code>let</code> to be cleaner than using an instance variable. We originally used instance variables both because instance variables are important to introduce early and because <code>let</code> is a little more advanced.</p>

<p>We should also test the User model for a <code>relationships</code> attribute, as shown in <a class="ref" href="#code:user_relationships_method_test">Listing&nbsp;11.3</a>.</p>

<div class="label" id="code:user_relationships_method_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.3.</span> <span class="description">Testing for the <code>user.relationships</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point, you might expect application code as in <a class="ref" href="#sec:user_micropost_associations">Section&nbsp;10.1.3</a>, and it&rsquo;s similar, but there is one critical difference: in the case of the Micropost model, we could say</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>because the <code>microposts</code> table has a <code>user_id</code> attribute  to identify the user (<a class="ref" href="#sec:the_basic_model">Section&nbsp;10.1.1</a>). An id used in this manner to connect two database tables is known as a <em>foreign key</em>, and when the foreign key for a User model object is <code>user_id</code>, Rails infers the association automatically: by default, Rails expects a foreign key of the form <code>&lt;class&gt;_id</code>, where <code>&lt;class&gt;</code> is the lower-case version of the class name.<sup class="footnote" id="fnref:11.5"><a href="#fn:11.5">5</a></sup> In the present case, although we are still dealing with users, they are now identified with the foreign key <code>follower_id</code>, so we have to tell that to Rails, as shown in <a class="ref" href="#code:user_relationships_association">Listing&nbsp;11.4</a>.<sup class="footnote" id="fnref:11.6"><a href="#fn:11.6">6</a></sup></p>

<div class="label" id="code:user_relationships_association"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.4.</span> <span class="description">Implementing the user/relationships <code>has_many</code> association. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Since destroying a user should also destroy that user&rsquo;s relationships, we&rsquo;ve gone ahead and added <code>dependent: :destroy</code> to the association; writing a test for this is left as an exercise (<a class="ref" href="#sec:following_exercises">Section&nbsp;11.5</a>).)</p>

<p>As with the Micropost model, the Relationship model has a <code>belongs_to</code> relationship with users; in this case, a relationship object belongs to both a <code>follower</code> and a <code>followed</code> user, which we test for in <a class="ref" href="#code:relationships_belongs_to_test">Listing&nbsp;11.5</a>.</p>

<div class="label" id="code:relationships_belongs_to_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.5.</span> <span class="description">Testing the user/relationships <code>belongs_to</code> association. <br /> <code>spec/models/relationship_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;follower methods&quot;</span> <span class="k">do</span>    
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">follower</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">followed</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To write the application code, we define the <code>belongs_to</code> relationship as usual. Rails infers the names of the foreign keys from the corresponding symbols (i.e., <code>follower_id</code> from <code>:follower</code>, and <code>followed_id</code> from <code>:followed</code>), but since there is neither a Followed nor a Follower model we need to supply the class name <code>User</code>. The result is shown in <a class="ref" href="#code:relationship_belongs_to">Listing&nbsp;11.6</a>. Note that, unlike the default generate Relationship model, in this case only the <code>followed_id</code> is accessible.</p>

<div class="label" id="code:relationship_belongs_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.6.</span> <span class="description">Adding the <code>belongs_to</code> associations to the Relationship model. <br /> <code>app/models/relationship.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:followed_id</span>

  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The <code>followed</code> association isn&rsquo;t actually needed until <a class="ref" href="#sec:followers">Section&nbsp;11.1.5</a>, but the parallel follower/followed structure is clearer if we implement them both at the same time.</p>

<p>At this point, the tests in <a class="ref" href="#code:relationship_create_test">Listing&nbsp;11.2</a> and <a class="ref" href="#code:user_relationships_method_test">Listing&nbsp;11.3</a> should pass.</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:relationship_validations"></div>


<h3><a id="sec:11.1.3" href="#sec:relationship_validations" class="heading"><span class="number">11.1.3</span> Validations</a></h3>


<p>Before moving on, we&rsquo;ll add a couple of Relationship model validations for completeness. The tests (<a class="ref" href="#code:relationship_validation_tests">Listing&nbsp;11.7</a>) and application code (<a class="ref" href="#code:relationship_validations">Listing&nbsp;11.8</a>) are straightforward.</p>

<div class="label" id="code:relationship_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.7.</span> <span class="description">Testing the Relationship model validations. <br /> <code>spec/models/relationship_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when followed id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when follower id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:relationship_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.8.</span> <span class="description">Adding the Relationship model validations. <br /> <code>app/models/relationship.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:followed_id</span>

  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>

  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:following"></div>


<h3><a id="sec:11.1.4" href="#sec:following" class="heading"><span class="number">11.1.4</span> Followed users</a></h3>


<p>We come now to the heart of the Relationship associations: <code>followed_users</code> and <code>followers</code>. We start with <code>followed_users</code>, as shown <a class="ref" href="#code:user_following_test">Listing&nbsp;11.9</a>.</p>

<div class="label" id="code:user_following_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.9.</span> <span class="description">A test for the <code>user.followed_users</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The implementation uses <code>has_many through</code> for the first time: a user has many following <em>through</em> relationships, as illustrated in <a class="ref" href="#fig:user_has_many_following">Figure&nbsp;11.7</a>. By default, in a <code>has_many through</code> association Rails looks for a foreign key corresponding to the singular version of the association; in other words, code like</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span>
</pre></div>
</div>


<p>would assemble an array using the <code>followed_id</code> in the <code>relationships</code> table. But, as noted in <a class="ref" href="#sec:a_problem_with_the_data_model">Section&nbsp;11.1.1</a>, <code>user.followeds</code> is rather awkward; far more natural is to use &ldquo;followed users&rdquo; as a plural of &ldquo;followed&rdquo;, and write instead <code>user.followed_users</code> for the array of followed users. Naturally, Rails allows us to override the default, in this case using the <code>:source</code> parameter (<a class="ref" href="#code:has_many_following_through_relationships">Listing&nbsp;11.10</a>), which explicitly tells Rails that the source of the <code>followed_users</code> array is the set of <code>followed</code>&nbsp;ids.</p>

<div class="label" id="code:has_many_following_through_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.10.</span> <span class="description">Adding the User model <code>followed_users</code> association.<br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:followed</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To create a following relationship, we&rsquo;ll introduce a <code>follow!</code> utility method so that we can write <code>user.follow!(other_user)</code>. (This <code>follow!</code> method should always work, so, as with <code>create!</code> and <code>save!</code>, we indicate with an exclamation point that an exception will be raised on failure.) We&rsquo;ll also add an associated <code>following?</code> boolean method to test if one user is following another.<sup class="footnote" id="fnref:11.7"><a href="#fn:11.7">7</a></sup> The tests in <a class="ref" href="#code:utility_method_tests">Listing&nbsp;11.11</a> show how we expect these methods to be used in practice.</p>

<div class="label" id="code:utility_method_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.11.</span> <span class="description">Tests for some &ldquo;following&rdquo; utility methods. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>  
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:following?</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>    
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>In the application code, the <code>following?</code> method takes in a user, called <code>other_user</code>, and checks to see if a followed user with that id exists in the database; the <code>follow!</code> method calls <code>create!</code> through the <code>relationships</code> association to create the following relationship. The results appear in <a class="ref" href="#code:following_p_follow_bang">Listing&nbsp;11.12</a>.</p>

<div class="label" id="code:following_p_follow_bang"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.12.</span> <span class="description">The <code>following?</code> and <code>follow!</code> utility methods. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that in <a class="ref" href="#code:following_p_follow_bang">Listing&nbsp;11.12</a> we have omitted the user itself, writing just</p>

<div class="code"><div class="highlight"><pre><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>instead of the equivalent code</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>Whether to include the explicit <code>self</code> is largely a matter of taste.</p>

<p>Of course, users should be able to unfollow other users as well as follow them, which leads to the somewhat predictable <code>unfollow!</code> method, as shown in <a class="ref" href="#code:user_unfollow_test">Listing&nbsp;11.13</a>.<sup class="footnote" id="fnref:11.8"><a href="#fn:11.8">8</a></sup></p>

<div class="label" id="code:user_unfollow_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.13.</span> <span class="description">A test for unfollowing a user. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:unfollow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;and unfollowing&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code for <code>unfollow!</code> is straightforward: just find the relationship by followed&nbsp;id and destroy it (<a class="ref" href="#code:user_unfollow">Listing&nbsp;11.14</a>).</p>

<div class="label" id="code:user_unfollow"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.14.</span> <span class="description">Unfollowing a user by destroying a user relationship. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:followers"></div>


<h3><a id="sec:11.1.5" href="#sec:followers" class="heading"><span class="number">11.1.5</span> Followers</a></h3>


<p>The final piece of the relationships puzzle is to add a <code>user.followers</code> method to go with <code>user.followed_users</code>. You may have noticed from <a class="ref" href="#fig:user_has_many_following">Figure&nbsp;11.7</a> that all the information needed to extract an array of followers is already present in the <code>relationships</code> table. Indeed, the technique is exactly the same as for user following, with the roles of <code>follower_id</code> and <code>followed_id</code> reversed. This suggests that, if we could somehow arrange for a <code>reverse_relationships</code> table with those two columns reversed (<a class="ref" href="#fig:user_has_many_followers">Figure&nbsp;11.9</a>), we could implement <code>user.followers</code> with little effort.</p>

<div class="label" id="fig:user_has_many_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_followers_2nd_ed.png" alt="user_has_many_followers_2nd_ed" /></span></div><div class="caption"><span class="header">Figure 11.9: </span><span class="description">A model for user followers using a reverse Relationship model.</span></div></div>


<p>We begin with the tests, having faith that the magic of Rails will come to the rescue (<a class="ref" href="#code:reverse_relationships_test">Listing&nbsp;11.15</a>).</p>

<div class="label" id="code:reverse_relationships_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.15.</span> <span class="description">Testing for reverse relationships. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:reverse_relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;followed user&quot;</span> <span class="k">do</span>
      <span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notice how we switch subjects using the <code>subject</code> method, replacing <code>@user</code> with <code>other_user</code>, allowing us to test the follower relationship in a natural way:</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>As you probably suspect, we will not be making a whole database table just to hold reverse relationships. Instead, we will exploit the underlying symmetry between followers and followed users to simulate a <code>reverse_relationships</code> table by passing <code>followed_id</code> as the primary key. In other words, where the <code>relationships</code> association uses the <code>follower_id</code> foreign key,</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span>
</pre></div>
</div>


<p>the <code>reverse_relationships</code> association uses <code>followed_id</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span>
</pre></div>
</div>


<p>The <code>followers</code> association then gets built through the reverse relationships, as shown in <a class="ref" href="#code:user_reverse_relationships">Listing&nbsp;11.16</a>.</p>

<div class="label" id="code:user_reverse_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.16.</span> <span class="description">Implementing <code>user.followers</code> using reverse relationships. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                   <span class="ss">class_name:</span>  <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span>
                                   <span class="ss">dependent:</span>   <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:follower</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(As with <a class="ref" href="#code:user_relationships_association">Listing&nbsp;11.4</a>, the test for <code>dependent :destroy</code> is left as an exercise (<a class="ref" href="#sec:following_exercises">Section&nbsp;11.5</a>).) Note that we actually have to include the <em>class</em> name for this association, i.e.,</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                 <span class="ss">class_name:</span> <span class="s2">&quot;Relationship&quot;</span>
</pre></div>
</div>


<p>because otherwise Rails would look for a <code>ReverseRelationship</code> class, which doesn&rsquo;t exist.</p>

<p>It&rsquo;s also worth noting that we could actually omit the <code>:source</code> key in this case, using simply</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:reverse_relationships</span>
</pre></div>
</div>


<p>since, in the case of a <code>:followers</code> attribute, Rails will singularize &ldquo;followers&rdquo; and automatically look for the foreign key <code>follower_id</code> in this case. I&rsquo;ve kept the <code>:source</code> key to emphasize the parallel structure with the <code>has_many :followed_users</code> association, but you are free to leave it off.</p>

<p>With the code in <a class="ref" href="#code:user_reverse_relationships">Listing&nbsp;11.16</a>, the following/follower associations are complete, and all the tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>This section has placed rather heavy demands on your data modeling skills, and it&rsquo;s fine if it takes a while to soak in. In fact, one of the best ways to understand the associations is to use them in the web interface, as seen in the next section.</p>

<div class="label" id="sec:a_web_interface_for_following_and_followers"></div>


<h2><a id="sec:11.2" href="#sec:a_web_interface_for_following_and_followers" class="heading"><span class="number">11.2</span> A web interface for following users</a></h2>


<p>In the introduction to this chapter, we saw a preview of the page flow for user following. In this section, we will implement the basic interface and following/unfollowing functionality shown in those mockups. We will also make separate pages to show the user following and followers arrays. In <a class="ref" href="#sec:the_status_feed">Section&nbsp;11.3</a>, we&rsquo;ll complete our sample application by adding the user&rsquo;s status feed.</p>

<div class="label" id="sec:sample_following_data"></div>


<h3><a id="sec:11.2.1" href="#sec:sample_following_data" class="heading"><span class="number">11.2.1</span> Sample following data</a></h3>


<p>As in previous chapters, we will find it convenient to use the sample data Rake task to fill the database with sample relationships. This will allow us to design the look and feel of the web pages first, deferring the back-end functionality until later in this section.</p>

<p>When we last left the sample data populator in <a class="ref" href="#code:sample_microposts">Listing&nbsp;10.23</a>, it was getting rather cluttered, so we begin by defining separate methods to make users and microposts, and then add sample relationship data using a new <code>make_relationships</code> method. The results are shown in <a class="ref" href="#code:sample_relationships">Listing&nbsp;11.17</a>.</p>

<div class="label" id="code:sample_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.17.</span> <span class="description">Adding following/follower relationships to the sample data. <br /> <code>lib/tasks/sample_data.rake</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">make_users</span>
    <span class="n">make_microposts</span>
    <span class="n">make_relationships</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_users</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                       <span class="ss">email:</span>    <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                       <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                       <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
  <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker::Name</span><span class="o">.</span><span class="n">name</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
    <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="nb">name</span><span class="p">,</span>
                 <span class="ss">email:</span>    <span class="n">email</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="n">password</span><span class="p">,</span>
                 <span class="ss">password_confirmation:</span> <span class="n">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_microposts</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
  <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here the sample relationships are created using the code</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We somewhat arbitrarily arrange for the first user to follow users&nbsp;3 through 51, and then have users 4 through 41 follow that user back. The resulting relationships will be sufficient for developing the application interface.</p>

<p>To execute the code in <a class="ref" href="#code:sample_relationships">Listing&nbsp;11.17</a>, populate the database as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>




<div class="label" id="sec:stats_and_a_follow_form"></div>


<h3><a id="sec:11.2.2" href="#sec:stats_and_a_follow_form" class="heading"><span class="number">11.2.2</span> Stats and a follow form</a></h3>


<p>Now that our sample users have both followed user and followers arrays, we need to update the profile page and Home page to reflect this. We&rsquo;ll start by making a partial to display the following and follower statistics on the profile and home pages. We&rsquo;ll next add a follow/unfollow form, and then make dedicated pages for showing user followed users and followers.</p>

<p>As noted in <a class="ref" href="#sec:a_problem_with_the_data_model">Section&nbsp;11.1.1</a>, the word &ldquo;following&rdquo; is ambiguous as an attribute (where <code>user.following</code> could reasonably mean either the followed users or the user&rsquo;s followers), it makes sense as a label, as in &ldquo;50 following&rdquo;. Indeed, this is the label used by Twitter itself, a usage adopted in the mockups starting in <a class="ref" href="#fig:page_flow_profile_mockup">Figure&nbsp;11.1</a> and shown in close-up in <a class="ref" href="#fig:stats_partial_mockup">Figure&nbsp;11.10</a>.</p>

<div class="label" id="fig:stats_partial_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/stats_partial_mockup.png" alt="stats_partial_mockup" /></span></div><div class="caption"><span class="header">Figure 11.10: </span><span class="description">A mockup of the stats partial.</span></div></div>


<p>The stats in <a class="ref" href="#fig:stats_partial_mockup">Figure&nbsp;11.10</a> consist of the number of users the current user is following and the number of followers, each of which should be a link to its respective dedicated display page. In <a class="ref" href="#cha:filling_in_the_layout">Chapter&nbsp;5</a>, we stubbed out such links with the dummy text&nbsp;<code>&rsquo;#&rsquo;</code>, but that was before we had much experience with routes. This time, although we&rsquo;ll defer the actual pages to <a class="ref" href="#sec:following_and_followers_pages">Section&nbsp;11.2.3</a>, we&rsquo;ll make the routes now, as seen in <a class="ref" href="#code:following_followers_actions_routes">Listing&nbsp;11.18</a>. This code uses the <code>:member</code> method inside a <code>resources</code> <em>block</em>, which we haven&rsquo;t seen before, but see if you can guess what it does. (<em>Note</em>: The code in <a class="ref" href="#code:following_followers_actions_routes">Listing&nbsp;11.18</a> should <em>replace</em> the <code>resources :users</code>.)</p>

<div class="label" id="code:following_followers_actions_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.18.</span> <span class="description">Adding <code>followed_users</code> and <code>followers</code> actions to the Users controller. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You might suspect that the URIs will look like /users/1/following and /users/1/followers, and that is exactly what the code in <a class="ref" href="#code:following_followers_actions_routes">Listing&nbsp;11.18</a> does. Since both pages will be showing data, we use <code>get</code> to arrange for the URIs to respond to <tt>GET</tt> requests (as required by the REST convention for such pages), and the <code>member</code> method means that the routes respond to URIs containing the user id. The other possibility, <code>collection</code>, works without the id, so that</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>would respond to the URI /users/tigers (presumably to display all the tigers in our application). For more details on such routing options, see the <a href="http://guides.rubyonrails.org/routing.html">Rails Guides article on &ldquo;Rails Routing from the Outside In&rdquo;</a>. A table of the routes generated by <a class="ref" href="#code:following_followers_actions_routes">Listing&nbsp;11.18</a> appears in <a class="ref" href="#table:following_routes">Table&nbsp;11.1</a>; note the named routes for the followed user and followers pages, which we&rsquo;ll put to use shortly. The unfortunate hybrid usage in the &ldquo;following&rdquo; route is forced by our choice to use the unambiguous &ldquo;followed users&rdquo; terminology along with the &ldquo;following&rdquo; usage from Twitter. Since the former would lead to routes of the form <code>followed_users_user_path</code>, which sounds strange, we&rsquo;ve opted for the latter in the context of <a class="ref" href="#table:following_routes">Table&nbsp;11.1</a>, yielding <code>following_user_path</code>.</p>

<div class="label" id="table:following_routes"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Named route</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/following</td><td class="align_left"><code>following</code></td><td class="align_left"><code>following_user_path(1)</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/followers</td><td class="align_left"><code>followers</code></td><td class="align_left"><code>followers_user_path(1)</code></td></tr></table></div><div class="caption"><span class="header">Table 11.1: </span><span class="description">RESTful routes provided by the custom rules in resource in <a class="ref" href="#code:following_followers_actions_routes">Listing&nbsp;11.18</a>.</span></div></div>


<p>With the routes defined, we are now in a position to make tests for the stats partial. (We could have written the tests first, but the named routes would have been hard to motivate without the updated routes file.) The stats partial will appear on both the profile page and the Home page; <a class="ref" href="#code:stats_view_test">Listing&nbsp;11.19</a> opts to test it on the latter.</p>

<div class="label" id="code:stats_view_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.19.</span> <span class="description">Testing the following/follower statistics on the Home page. <br /> <code>spec/requests/static_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;StaticPages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Lorem&quot;</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Ipsum&quot;</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the user&#39;s feed&quot;</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;follower/following counts&quot;</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">other_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">root_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;0 following&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;1 followers&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The core of this test is the expectation that the following and follower counts appear on the page, together with the right URIs:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;0 following&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;1 followers&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>Here we have used the named routes shown in <a class="ref" href="#table:following_routes">Table&nbsp;11.1</a> to verify that the links have the right addresses. Also note that in this case the word &ldquo;followers&rdquo; is acting as a <em>label</em>, so we keep it plural even when there is only one follower.</p>

<p>The application code for the stats partial is just a couple of links inside a div, as shown in <a class="ref" href="#code:stats_partial">Listing&nbsp;11.20</a>.</p>

<div class="label" id="code:stats_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.20.</span> <span class="description">A partial for displaying follower stats. <br /> <code>app/views/shared/_stats.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;stats&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;followers&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Since we will be including the stats on both the user show pages and the home page, the first line of <a class="ref" href="#code:stats_partial">Listing&nbsp;11.20</a> picks the right one using</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>As discussed in <a class="ref" href="#sidebar:or_equals">Box&nbsp;8.2</a>, this does nothing when <code>@user</code> is not <code>nil</code> (as on a profile page), but when it is (as on the Home page) it sets <code>@user</code> to the current user.</p>

<p>Note also that the following/follower counts are calculated through the associations using</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>Compare these to the microposts count from <a class="ref" href="#code:user_show_microposts">Listing&nbsp;10.20</a>, where we wrote</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>to count the microposts.</p>

<p>One final detail worth noting is the presence of CSS ids on some elements, as in</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</pre></div>
</div>


<p>This is for the benefit of the Ajax implementation in <a class="ref" href="#sec:a_working_follow_button_with_ajax">Section&nbsp;11.2.5</a>, which accesses elements on the page using their unique ids.</p>

<p>With the partial in hand, including the stats on the Home page is easy, as shown in <a class="ref" href="#code:home_page_stats">Listing&nbsp;11.21</a>. (This also gets the test in <a class="ref" href="#code:stats_view_test">Listing&nbsp;11.19</a> to pass.)</p>

<div class="label" id="code:home_page_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.21.</span> <span class="description">Adding follower stats to the Home page. <br /> <code>app/views/static_pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      .
      .
      .
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>To style the stats, we&rsquo;ll add some SCSS, as shown in <a class="ref" href="#code:stats_css">Listing&nbsp;11.22</a> (which contains all the stylesheet code needed in this chapter). The result appears in <a class="ref" href="#fig:home_page_follow_stats">Figure&nbsp;11.11</a>.</p>

<div class="label" id="code:stats_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.22.</span> <span class="description">SCSS for the Home page sidebar. <br /> <code>app/assets/stylesheets/custom.css.scss</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.stats</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">border-left</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">padding-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
      <span class="na">color</span><span class="o">:</span> <span class="nv">$blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.user_avatars</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_page_follow_stats"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_follow_stats_bootstrap.png" alt="home_page_follow_stats_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.11: </span><span class="description">The Home page (<a href="http://localhost:3000/">/</a>) with follow stats.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_follow_stats_bootstrap-full.png">(full size)</a></span></div></div>


<p>We&rsquo;ll render the stats partial on the profile page in a moment, but first let&rsquo;s make a partial for the follow/unfollow button, as shown in <a class="ref" href="#code:follow_form_partial">Listing&nbsp;11.23</a>.</p>

<div class="label" id="code:follow_form_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.23.</span> <span class="description">A partial for a follow/unfollow form. <br /> <code>app/views/users/_follow_form.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;follow_form&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;unfollow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>This does nothing but defer the real work to <code>follow</code> and <code>unfollow</code> partials, which need a new routes file with rules for the Relationships resource, which follows the Microposts resource example (<a class="ref" href="#code:microposts_resource">Listing&nbsp;10.25</a>), as seen in  <a class="ref" href="#code:relationships_resource">Listing&nbsp;11.24</a>.</p>

<div class="label" id="code:relationships_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.24.</span> <span class="description">Adding the routes for user relationships. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>      <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>    <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The follow/unfollow partials themselves are shown in <a class="ref" href="#code:follow_form">Listing&nbsp;11.25</a> and <a class="ref" href="#code:unfollow_form">Listing&nbsp;11.26</a>.</p>

<div class="label" id="code:follow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.25.</span> <span class="description">A form for following a user. <br /> <code>app/views/users/_follow.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:unfollow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.26.</span> <span class="description">A form for unfollowing a user. <br /> <code>app/views/users/_unfollow.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
             <span class="ss">html:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>These two forms both use <code>form_for</code> to manipulate a Relationship model object; the main difference between the two is that <a class="ref" href="#code:follow_form">Listing&nbsp;11.25</a> builds a <em>new</em> relationship, whereas <a class="ref" href="#code:unfollow_form">Listing&nbsp;11.26</a> finds the existing relationship. Naturally, the former sends a <tt>POST</tt> request to the Relationships controller to <code>create</code> a relationship, while the latter sends a <tt>DELETE</tt> request to <code>destroy</code> a relationship. (We&rsquo;ll write these actions in <a class="ref" href="#sec:a_working_follow_button_the_standard_way">Section&nbsp;11.2.4</a>.) Finally, you&rsquo;ll note that the follow/unfollow form doesn&rsquo;t have any content other than the button, but it still needs to send the <code>followed_id</code>, which we accomplish with the <code>hidden_field</code> method, which produces HTML of the form</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;followed_relationship_followed_id&quot;</span>
<span class="na">name=</span><span class="s">&quot;followed_relationship[followed_id]&quot;</span>
<span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>The &ldquo;hidden&rdquo; <code>input</code> tag puts the relevant information on the page without displaying it in the browser.</p>

<p>We can now include the follow form and the following statistics on the user profile page simply by rendering the partials, as shown in <a class="ref" href="#code:user_follow_form_profile_stats">Listing&nbsp;11.27</a>. Profiles with follow and unfollow buttons, respectively, appear in <a class="ref" href="#fig:profile_follow_button">Figure&nbsp;11.12</a> and <a class="ref" href="#fig:profile_unfollow_button">Figure&nbsp;11.13</a>.</p>

<div class="label" id="code:user_follow_form_profile_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.27.</span> <span class="description">Adding the follow form and follower stats to the user profile page. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow_form&#39;</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
    .
    .
    .       
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span> 
</pre></div>
</div></div>




<div class="label" id="fig:profile_follow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_follow_button_bootstrap.png" alt="profile_follow_button_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.12: </span><span class="description">A user profile with a follow button (<a href="http://localhost:3000/users/2">/users/2</a>).&nbsp;<a href="http://railstutorial.org/images/figures/profile_follow_button_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:profile_unfollow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_unfollow_button_bootstrap.png" alt="profile_unfollow_button_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.13: </span><span class="description">A user profile with an unfollow button (<a href="http://localhost:3000/users/8">/users/6</a>).&nbsp;<a href="http://railstutorial.org/images/figures/profile_unfollow_button_bootstrap-full.png">(full size)</a></span></div></div>


<p>We&rsquo;ll get these buttons working soon enough&mdash;in fact, we&rsquo;ll do it two ways, the standard way (<a class="ref" href="#sec:a_working_follow_button_the_standard_way">Section&nbsp;11.2.4</a>) and using Ajax (<a class="ref" href="#sec:a_working_follow_button_with_ajax">Section&nbsp;11.2.5</a>)&mdash;but first we&rsquo;ll finish the HTML interface by making the following and followers pages.</p>

<div class="label" id="sec:following_and_followers_pages"></div>


<h3><a id="sec:11.2.3" href="#sec:following_and_followers_pages" class="heading"><span class="number">11.2.3</span> Following and followers pages</a></h3>


<p>Pages to display followed users and followers will resemble a hybrid of the user profile page and the user index page (<a class="ref" href="#sec:user_index">Section&nbsp;9.3.1</a>), with a sidebar of user information (including the following stats) and a list of users. In addition, we&rsquo;ll include a raster of user profile image links in the sidebar. Mockups matching these requirements appear in <a class="ref" href="#fig:following_mockup">Figure&nbsp;11.14</a> (following) and <a class="ref" href="#fig:followers_mockup">Figure&nbsp;11.15</a> (followers).</p>

<div class="label" id="fig:following_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/following_mockup_bootstrap.png" alt="following_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.14: </span><span class="description">A mockup of the user following page.&nbsp;<a href="http://railstutorial.org/images/figures/following_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:followers_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/followers_mockup_bootstrap.png" alt="followers_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.15: </span><span class="description">A mockup of the user followers page.&nbsp;<a href="http://railstutorial.org/images/figures/followers_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>Our first step is to get the following and followers links to work. We&rsquo;ll follow Twitter&rsquo;s lead and have both pages to require user signin, as tested in <a class="ref" href="#code:following_followers_authorization_test">Listing&nbsp;11.28</a>. For signed-in users, the pages should have links for following and followers, respectively, as tested in <a class="ref" href="#code:following_followers_tests">Listing&nbsp;11.29</a>.</p>

<div class="label" id="code:following_followers_authorization_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.28.</span> <span class="description">Tests for the authorization of the following and followers pages. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">&quot;visiting the following page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;visiting the followers page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:following_followers_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.29.</span> <span class="description">Test for the <code>followed_users</code> and <code>followers</code> pages. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following/followers&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;followed users&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Following&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Following&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;followers&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">other_user</span>
        <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Followers&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Followers&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The only tricky part of the implementation is realizing that we need to add two new actions to the Users controller; based on the routes defined in <a class="ref" href="#code:following_followers_actions_routes">Listing&nbsp;11.18</a>, we need to call them <code>following</code> and <code>followers</code>. Each action needs to set a title, find the user, retrieve either <code>@user.followed_users</code> or <code>@user.followers</code> (in paginated form), and then render the page. The result appears in <a class="ref" href="#code:following_followers_actions">Listing&nbsp;11.30</a>.</p>

<div class="label" id="code:following_followers_actions"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.30.</span> <span class="description">The <code>following</code> and <code>followers</code> actions. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> 
                <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Following&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Followers&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note here that both actions make an <em>explicit</em> call to <code>render</code>, in this case rendering a view called <code>show_follow</code>, which we must create. The reason for the common view is that the ERb is nearly identical for the two cases, and <a class="ref" href="#code:show_follow_view">Listing&nbsp;11.31</a> covers them both.</p>

<div class="label" id="code:show_follow_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.31.</span> <span class="description">The <code>show_follow</code> view used to render following and followers. <br /> <code>app/views/users/show_follow.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;view my profile&quot;</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;user_avatars&quot;</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>With that, the tests should now be passing, and the pages should render as shown in <a class="ref" href="#fig:user_following">Figure&nbsp;11.16</a> (following) and <a class="ref" href="#fig:user_followers">Figure&nbsp;11.17</a> (followers).</p>

<div class="label" id="fig:user_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_following_bootstrap.png" alt="user_following_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.16: </span><span class="description">Showing the users being followed by the current user.&nbsp;<a href="http://railstutorial.org/images/figures/user_following_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:user_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_followers_bootstrap.png" alt="user_followers_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.17: </span><span class="description">Showing the current user&rsquo;s followers.&nbsp;<a href="http://railstutorial.org/images/figures/user_followers_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:a_working_follow_button_the_standard_way"></div>


<h3><a id="sec:11.2.4" href="#sec:a_working_follow_button_the_standard_way" class="heading"><span class="number">11.2.4</span> A working follow button the standard way</a></h3>


<p>Now that our views are in order, it&rsquo;s time to get the follow/unfollow buttons working. The tests for these button combine many of the testing techniques covered throughout this tutorial and make for a good exercise in reading code. Study <a class="ref" href="#code:follow_unfollow_button_tests">Listing&nbsp;11.32</a> until you are convinced that you understand what it&rsquo;s testing and why. (There&rsquo;s one minor security ommission as well; see if you can spot it. We&rsquo;ll cover it momentarily.)</p>

<div class="label" id="code:follow_unfollow_button_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.32.</span> <span class="description">Tests for the Follow/Unfollow button. <br /> <code>spec/requests/user_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;follow/unfollow buttons&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;following a user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="s2">&quot;should increment the followed user count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should increment the other user&#39;s followers count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;toggling the button&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="ss">value:</span> <span class="s1">&#39;Unfollow&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;unfollowing a user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should decrement the followed user count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should decrement the other user&#39;s followers count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;toggling the button&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="ss">value:</span> <span class="s1">&#39;Follow&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>  
</pre></div>
</div></div>


<p><a class="ref" href="#code:follow_unfollow_button_tests">Listing&nbsp;11.32</a> tests the following buttons by clicking on them and specifying the proper behavior. Writing the implementation involves digging a little deeper: following and unfollowing involve <em>creating</em> and <em>destroying</em> relationships, which means defining <code>create</code> and <code>destroy</code> actions in a Relationships controller (which we must create).  Although the following buttons only appear for signed-in users, giving us a superficial layer of security, the tests in <a class="ref" href="#code:follow_unfollow_button_tests">Listing&nbsp;11.32</a> miss a lower-level issue, namely, the <code>create</code> and <code>destroy</code> actions themselves should only be accessible to signed-in users. (This is the security hole alluded to above.) <a class="ref" href="#code:relationships_controller_authorization_test">Listing&nbsp;11.33</a> expresses this requirement using the <code>post</code> and <code>delete</code> methods to hit those actions directly.</p>

<div class="label" id="code:relationships_controller_authorization_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.33.</span> <span class="description">Tests for the Relationships controller authorization. <br /> <code>spec/requests/authentication_pages_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Relationships controller&quot;</span> <span class="k">do</span>
        <span class="n">describe</span> <span class="s2">&quot;submitting to the create action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">relationships_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the destroy action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>          
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that, in order to avoid the overhead of creating a virtually useless Relationship object, the <code>delete</code> test hard-codes the id&nbsp;<code>1</code> in the named route:</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>This works because the user should be redirected before the application ever tries to retrieve the relationship with this&nbsp;id.</p>

<p>The controller code needed to get these tests to pass is remarkably concise: we just retrieve the user followed or to be followed, and then follow or unfollow the user using the relevant utility method. The full implementation appears in <a class="ref" href="#code:relationships_controller">Listing&nbsp;11.34</a>.</p>

<div class="label" id="code:relationships_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.34.</span> <span class="description">The Relationships controller. <br /> <code>app/controllers/relationships_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can see from <a class="ref" href="#code:relationships_controller">Listing&nbsp;11.34</a> why the security issue mentioned above is minor: if an unsigned-in user were to hit either action directly (e.g., using a command-line tool), <code>current_user</code> would be <code>nil</code>, and in both cases the action&rsquo;s second line would raise an exception, resulting in an error but no harm to the application or its data. It&rsquo;s best not to rely on that, though, so we&rsquo;ve taken the extra step and added an extra layer of security.</p>

<p>With that, the core follow/unfollow functionality is complete, and any user can follow (or unfollow) any other user, which you should verify both by clicking around in the sample application and by running the test suite:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec:a_working_follow_button_with_ajax"></div>


<h3><a id="sec:11.2.5" href="#sec:a_working_follow_button_with_ajax" class="heading"><span class="number">11.2.5</span> A working follow button with Ajax</a></h3>


<p>Although our user following implementation is complete as it stands, we have one bit of polish left to add before starting work on the status feed. You may have noticed in <a class="ref" href="#sec:a_working_follow_button_the_standard_way">Section&nbsp;11.2.4</a> that both the <code>create</code> and <code>destroy</code> actions in the Relationships controller simply redirect <em>back</em> to the original profile. In other words, a user starts on a profile page, follows the user, and is immediately redirected back to the original page. It is reasonable to ask why the user needs to leave that page at all.</p>

<p>This is exactly the problem solved by <em>Ajax</em>, which allows web pages to send requests asynchronously to the server without leaving the page.<sup class="footnote" id="fnref:11.9"><a href="#fn:11.9">9</a></sup> Because the practice of adding Ajax to web forms is quite common, Rails makes Ajax easy to implement. Indeed, updating the follow/unfollow form partials is trivial: just change</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">remote:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>and Rails <a href="http://catb.org/jargon/html/A/automagically.html">automagically</a> uses Ajax.<sup class="footnote" id="fnref:11.10"><a href="#fn:11.10">10</a></sup> The updated partials appear in <a class="ref" href="#code:follow_form_ajax">Listing&nbsp;11.35</a> and <a class="ref" href="#code:unfollow_form_ajax">Listing&nbsp;11.36</a>.</p>

<div class="label" id="code:follow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.35.</span> <span class="description">A form for following a user using Ajax. <br /> <code>app/views/users/_follow.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">remote:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:unfollow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.36.</span> <span class="description">A form for unfollowing a user using Ajax. <br /> <code>app/views/users/_unfollow.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
             <span class="ss">html:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">},</span>
             <span class="ss">remote:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>The actual HTML generated by this ERb isn&rsquo;t particularly relevant, but you might be curious, so here&rsquo;s a peek:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/relationships/117&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_relationship&quot;</span> <span class="na">data-remote=</span><span class="s">&quot;true&quot;</span>
      <span class="na">id=</span><span class="s">&quot;edit_relationship_117&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>


<p>This sets the variable <code>data-remote="true"</code> inside the form tag, which tells Rails to allow the form to be handled by JavaScript. By using a simple HTML property instead of inserting the full JavaScript code (as in previous versions of Rails), Rails&nbsp;3 follows the philosophy of <a href="http://railscasts.com/episodes/205-unobtrusive-javascript"><em>unobtrusive JavaScript</em></a>.</p>

<p>Having updated the form, we now need to arrange for the Relationships controller to respond to Ajax requests. Testing Ajax is quite tricky, and doing it thoroughly is a large subject in its own right, but we can get started with the code in <a class="ref" href="#code:relationships_controller_spec_ajax">Listing&nbsp;11.37</a>. This uses the <code>xhr</code> method (for &ldquo;XmlHttpRequest&rdquo;) to issue an Ajax request; compare to the <code>get</code>, <code>post</code>, <code>put</code>, and <code>delete</code> methods used in previous tests. We then verify that the <code>create</code> and <code>destroy</code> actions do the correct things when hit with an Ajax request. (To write more thorough test suites for Ajax-heavy applications, take a look at <a href="http://seleniumhq.org/">Selenium</a> and <a href="http://watir.com/">Watir</a>.)</p>

<div class="label" id="code:relationships_controller_spec_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.37.</span> <span class="description">Tests for the Relationships controller responses to Ajax requests. <br /> <code>spec/controllers/relationships_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">RelationshipsController</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;creating a relationship with Ajax&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should increment the Relationship count&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond with success&quot;</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;destroying a relationship with Ajax&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should decrement the Relationship count&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond with success&quot;</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="#code:relationships_controller_spec_ajax">Listing&nbsp;11.37</a> is our first example of a <em>controller</em> test, which I used to use extensively (as in the previous edition of this book) but now mainly eschew in favor of integration tests. In this case, though, the <code>xhr</code> method is (somewhat inexplicably) not available in integration tests. Although our use of <code>xhr</code> is new, at this point in the tutorial you should be able to infer from context what the code does:</p>

<div class="code"><div class="highlight"><pre><span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
</pre></div>
</div>


<p>We see that <code>xhr</code> takes as arguments a symbol for the relevant HTTP method, a symbol for the action, and a hash representing the contents of <code>params</code> in the controller itself. As in previous examples, we use <code>expect</code> to wrap the operation in a block and test for an increment or decrement in the relevant count.</p>

<p>As implied by the tests, the application code uses the same <code>create</code> and <code>destroy</code> actions to respond to the Ajax requests that it uses to respond to ordinary <tt>POST</tt> and <tt>DELETE</tt> HTTP requests. All we need to do is respond to a normal HTTP request with a redirect (as in <a class="ref" href="#sec:a_working_follow_button_the_standard_way">Section&nbsp;11.2.4</a>) and respond to an Ajax request with JavaScript. The controller code appears as in <a class="ref" href="#code:relationships_controller_ajax">Listing&nbsp;11.38</a>. (See <a class="ref" href="#sec:following_exercises">Section&nbsp;11.5</a> for an exercise showing an even more compact way to accomplish the same thing.)</p>

<div class="label" id="code:relationships_controller_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.38.</span> <span class="description">Responding to Ajax requests in the Relationships controller. <br /> <code>app/controllers/relationships_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code uses <code>respond_to</code> to take the appropriate action depending on the kind of request. (There is no relationship between this <code>respond_to</code> and the <code>respond_to</code> used in the RSpec examples.) The syntax is potentially confusing, and it&rsquo;s important to understand that in</p>

<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div>
</div>


<p>only <em>one</em> of the lines gets executed (based on the nature of the request).</p>

<p>In the case of an Ajax request, Rails automatically calls a <em>JavaScript Embedded Ruby</em> (<code>.js.erb</code>) file with the same name as the action, i.e., <code>create.js.erb</code> or <code>destroy.js.erb</code>. As you might guess, the files allow us to mix JavaScript and Embedded Ruby to perform actions on the current page. It is these files that we need to create and edit in order to update the user profile page upon being followed or unfollowed.</p>

<p>Inside a JS-ERb file, Rails automatically provides the <a href="http://jquery.com/">jQuery</a> JavaScript helpers to manipulate the page using the <a href="http://www.w3.org/DOM/">Document Object Model (DOM)</a>. The jQuery library provides a large number of methods for manipulating the DOM, but here we will need only two. First, we will need to know about the dollar-sign syntax to access a DOM element based in its unique CSS&nbsp;id. For example, to manipulate the <code>follow_form</code> element, we will use the syntax</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>(Recall from <a class="ref" href="#code:follow_form_partial">Listing&nbsp;11.23</a> that this is a <code>div</code> that wraps the form, not the form itself.) This syntax, inspired by CSS, uses the&nbsp;<code>#</code> symbol to indicate a CSS&nbsp;id. As you might guess, jQuery, like CSS, uses a dot&nbsp;<code>.</code> to manipulate CSS classes.</p>

<p>The second method we&rsquo;ll need is <code>html</code>, which updates the HTML inside the relevant element with the contents of its argument. For example, to replace the entire follow form with the string <code>"foobar"</code>, we would write</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Unlike plain JavaScript files, JS-ERb files also allow the use of Embedded Ruby, which we apply in the <code>create.js.erb</code> file to update the follow form with the <code>unfollow</code> partial (which is what should show after a successful following) and update the follower count. The result is shown in <a class="ref" href="#code:create_js_erb">Listing&nbsp;11.39</a>. This uses the <code>escape_javascript</code> function, which is needed to escape out the result when inserting HTML in a JavaScript file.</p>

<div class="label" id="code:create_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.39.</span> <span class="description">The JavaScript Embedded Ruby to create a following relationship. <br /> <code>app/views/relationships/create.js.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/unfollow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#followers&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= @user.followers.count %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p>The <code>destroy.js.erb</code> file is analogous (<a class="ref" href="#code:destroy_js_erb">Listing&nbsp;11.40</a>).</p>

<div class="label" id="code:destroy_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.40.</span> <span class="description">The Ruby JavaScript (RJS) to destroy a following relationship. <br /> <code>app/views/relationships/destroy.js.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/follow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#followers&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= @user.followers.count %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p>With that, you should navigate to a user profile page and verify that you can follow and unfollow without a page refresh, and the test suite should also pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Using Ajax in Rails is a large and fast-moving subject, so we&rsquo;ve only been able to scratch the surface here, but (as with the rest of the material in this tutorial) our treatment should give you a good foundation for more advanced resources.</p>

<div class="label" id="sec:the_status_feed"></div>


<h2><a id="sec:11.3" href="#sec:the_status_feed" class="heading"><span class="number">11.3</span> The status feed</a></h2>


<p>We come now to the pinnacle of our sample application: the status feed. Appropriately, this section contains some of the most advanced material in the entire tutorial. The full status feed builds on the proto-feed from <a class="ref" href="#sec:a_proto_feed">Section&nbsp;10.3.3</a> by assembling an array of the microposts from the users being followed by the current user, along with the current user&rsquo;s own microposts. To accomplish this feat, we will need some fairly advanced Rails, Ruby, and even SQL programming techniques.</p>

<p>Because of the heavy lifting ahead, it&rsquo;s especially important to review where we&rsquo;re going. A recap of the final user status feed, shown in <a class="ref" href="#fig:page_flow_home_page_feed_mockup">Figure&nbsp;11.5</a>, appears again in <a class="ref" href="#fig:home_page_feed_mockup">Figure&nbsp;11.18</a>.</p>

<div class="label" id="fig:home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="page_flow_home_page_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.18: </span><span class="description">A mockup of a user&rsquo;s Home page with a status feed.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_home_page_feed_mockup_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:motivation_and_strategy"></div>


<h3><a id="sec:11.3.1" href="#sec:motivation_and_strategy" class="heading"><span class="number">11.3.1</span> Motivation and strategy</a></h3>


<p>The basic idea behind the feed is simple. <a class="ref" href="#fig:user_feed">Figure&nbsp;11.19</a> shows a sample <code>microposts</code> database table and the resulting feed. The purpose of a feed is to pull out the microposts whose user ids correspond to the users being followed by the current user (and the current user itself), as indicated by the arrows in the diagram.</p>

<div class="label" id="fig:user_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_feed.png" alt="user_feed" /></span></div><div class="caption"><span class="header">Figure 11.19: </span><span class="description">The feed for a user (id 1) following users 2, 7, 8, and 10.</span></div></div>


<p>Since we need a way to find all the microposts from users followed by a given user, we&rsquo;ll plan on implementing a method called <code>from_users_followed_by</code>, which we will use as follows:</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>Although we don&rsquo;t yet know how to implement it, we can already write tests for its functionality. The key is to check all three requirements for the feed: microposts for followed users and the user itself should be included in the feed, but a post from an <em>unfollowed</em> user should not be included. Two of these requirements already appear in our tests: <a class="ref" href="#code:feed_specs">Listing&nbsp;10.38</a> verifies that a user&rsquo;s own microposts appear in the feed, while the micropost from an unfollowed user doesn&rsquo;t appear. Now that we know how to follow users, we can add a third type of test, this time checking that the microposts of a followed user appear in the feed, as shown in <a class="ref" href="#code:full_feed_specs">Listing&nbsp;11.41</a>.</p>

<div class="label" id="code:full_feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.41.</span> <span class="description">The final tests for the status feed. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:followed_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed_user</span><span class="p">)</span>
        <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
          <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Implementing the feed simply defers the hard work to <code>Micropost.from_users_followed_by</code>, as shown in <a class="ref" href="#code:user_feed">Listing&nbsp;11.42</a>.</p>

<div class="label" id="code:user_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.42.</span> <span class="description">Adding the completed feed to the User model. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:a_first_feed_implementation"></div>


<h3><a id="sec:11.3.2" href="#sec:a_first_feed_implementation" class="heading"><span class="number">11.3.2</span> A first feed implementation</a></h3>


<p>Now it&rsquo;s time to implement <code>Micropost.from_users_followed_by</code>, which for simplicity we&rsquo;ll just refer to as &ldquo;the feed&rdquo;. Since the final result is rather intricate, we&rsquo;ll build up to the final feed implementation by introducing one piece at a time.</p>

<p>The first step is to think of the kind of query we&rsquo;ll need. What we want to do is select from the <code>microposts</code> table all the microposts with ids corresponding to the users being followed by a given user (or the user itself). We might write this schematically as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div>
</div>


<p>In writing this code, we&rsquo;ve guessed that SQL supports an <code>IN</code> keyword that allows us to test for set inclusion. (Happily, it does.)</p>

<p>Recall from the proto-feed in <a class="ref" href="#sec:a_proto_feed">Section&nbsp;10.3.3</a> that Active Record uses the <code>where</code> method to accomplish the kind of select shown above, as illustrated in <a class="ref" href="#code:proto_status_feed">Listing&nbsp;10.39</a>. There, our select was very simple; we just picked out all the microposts with user id corresponding to the current user:</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>Here, we expect it to be more complicated, something like</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id in (?) OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>(Here we&rsquo;ve used the Rails convention of <code>user</code> instead of <code>user.id</code> in the condition; Rails automatically uses the&nbsp;<code>id</code>. We&rsquo;ve also omitted the leading <code>Micropost.</code> since we expect this method to live in the Micropost model itself.)</p>

<p>We see from these conditions that we&rsquo;ll need an array of ids corresponding to the users being followed. One way to do this is to use Ruby&rsquo;s <code>map</code> method, available on any &ldquo;enumerable&rdquo; object, i.e., any object (such as an Array or a Hash) that consists of a collection of elements.<sup class="footnote" id="fnref:11.11"><a href="#fn:11.11">11</a></sup> We saw an example of this method in <a class="ref" href="#sec:blocks">Section&nbsp;4.3.2</a>; it works like this:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p>Situations like the one illustrated above, where the same method (e.g., <code>to_s</code>) gets called on each element, are common enough that there&rsquo;s a shorthand notation using an <em>ampersand</em>&nbsp;<code>&amp;</code> and a symbol corresponding to the method:<sup class="footnote" id="fnref:11.12"><a href="#fn:11.12">12</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p>Using the <code>join</code> method(<a class="ref" href="#sec:arrays_and_ranges">Section&nbsp;4.3.1</a>), we can create a string composed of the ids by joining them on comma-space :</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1, 2, 3, 4&quot;</span>
</pre></div>
</div>


<p>We can use the above method to construct the necessary array of followed user ids by calling&nbsp;<code>id</code> on each element in <code>user.followed_users</code>. For example, for the first user in the database this array appears as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div>
</div>


<p>In fact, because this sort of construction is so useful, Active Record provides it by default:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div>
</div>


<p>Here the <code>followed_user_ids</code> method is synthesized by Active Record based on the <code>has_many :followed_users</code> association (<a class="ref" href="#code:has_many_following_through_relationships">Listing&nbsp;11.10</a>); the result is that we need only append <code>_ids</code> to the association name to get the ids corresponding to the <code>user.followed_users</code> collection. A string of followed user ids then appears as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="go">=&gt; &quot;4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51&quot;</span>
</pre></div>
</div>


<p>When inserting into an SQL string, though, you don&rsquo;t need to do this; the <code>?</code> interpolation takes care of it for you (and in fact eliminates some database-dependent incompatibilities). This means we can use</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>by itself.</p>

<p>At this point, you might guess that code like</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>will involve a class method in the <code>Micropost</code> class (a construction mentioned briefly in <a class="ref" href="#sec:constructors">Section&nbsp;4.4.1</a>). A proposed implementation along these lines appears in <a class="ref" href="#code:from_users_followed_by_first_cut">Listing&nbsp;11.43</a>.</p>

<div class="label" id="code:from_users_followed_by_first_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.43.</span> <span class="description">A first cut at the <code>from_users_followed_by</code> method. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (?) OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Although the discussion leading up to <a class="ref" href="#code:from_users_followed_by_first_cut">Listing&nbsp;11.43</a> was couched in hypothetical terms, it actually works! You can verify this yourself by running the test suite, which should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>In some applications, this initial implementation might be good enough for most practical purposes. But it&rsquo;s not the final implementation; see if you can make a guess about why not before moving on to the next section. (<em>Hint:</em> What if a user is following 5000 other users?)</p>

<div class="label" id="sec:scopes_subselects_and_a_lambda"></div>


<h3><a id="sec:11.3.3" href="#sec:scopes_subselects_and_a_lambda" class="heading"><span class="number">11.3.3</span> Subselects</a></h3>


<p>As hinted at in the last section, the feed implementation in <a class="ref" href="#sec:a_first_feed_implementation">Section&nbsp;11.3.2</a> doesn&rsquo;t scale well when the number of microposts in the feed is large, as would likely happen if a user were following, say, 5000 other users. In this section, we&rsquo;ll reimplement the status feed in a way that scales better with the number of followed users.</p>

<p>The problem with the code in <a class="ref" href="#sec:a_first_feed_implementation">Section&nbsp;11.3.2</a> is that</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>pulls <em>all</em> the followed users&rsquo; ids into memory, and creates an array the full length of the followed users array. Since the condition in <a class="ref" href="#code:from_users_followed_by_first_cut">Listing&nbsp;11.43</a> actually just checks inclusion in a set, there must be a more efficient way to do this, and indeed SQL is optimized for just such set operations.The solution involves pushing the finding of followed user ids into the database using a <em>subselect</em>.</p>

<p>We&rsquo;ll start by refactoring the feed with the slightly modified code in <a class="ref" href="#code:from_users_followed_by_second_cut">Listing&nbsp;11.44</a>.</p>

<div class="label" id="code:from_users_followed_by_second_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.44.</span> <span class="description">Improving <code>from_users_followed_by</code>. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Returns microposts from the users being followed by the given user.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (:followed_user_ids) OR user_id = :user_id&quot;</span><span class="p">,</span>
          <span class="ss">followed_user_ids:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As preparation for the next step, we have replaced</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (?) OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>with the equivalent</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (:followed_user_ids) OR user_id = :user_id&quot;</span><span class="p">,</span>
      <span class="ss">followed_user_ids:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="p">))</span>
</pre></div>
</div>


<p>The question mark syntax is fine, but when we want the <em>same</em> variable inserted in more than one place, the second syntax is more convenient.</p>

<p>The above discussion implies that we will be adding a <em>second</em> occurrence of <code>user_id</code> in the SQL query. In particular, we can replace the Ruby code</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>with the SQL snippet</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">&quot;SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE follower_id = :user_id&quot;</span>
</pre></div>
</div>


<p>This code contains an SQL subselect, and internally the entire select for user&nbsp;1 would look something like this:</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span> <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>


<p>This subselect arranges for all the set logic to be pushed into the database, which is more efficient.<sup class="footnote" id="fnref:11.13"><a href="#fn:11.13">13</a></sup></p>

<p>With this foundation, we are ready for an efficient feed implementation, as seen in <a class="ref" href="#code:from_users_followed_by_final">Listing&nbsp;11.45</a>. Note that, because it is now raw SQL, <code>followed_user_ids</code> is <em>interpolated</em>, not escaped. (It actually works either way, but logically it makes more sense to interpolate in this context.)</p>

<div class="label" id="code:from_users_followed_by_final"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.45.</span> <span class="description">The final implementation of <code>from_users_followed_by</code>. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>

  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">&quot;SELECT followed_id FROM relationships</span>
<span class="s2">                         WHERE follower_id = :user_id&quot;</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (</span><span class="si">#{</span><span class="n">followed_user_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id&quot;</span><span class="p">,</span> 
          <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code has a formidable combination of Rails, Ruby, and SQL, but it does the job, and does it well. (Of course, even the subselect won&rsquo;t scale forever. For bigger sites, you would probably need to generate the feed asynchronously using a background job. Such scaling subtleties are beyond the scope of this tutorial, but the <a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a> screencasts are a good place to start.)</p>

<div class="label" id="sec:the_new_status_feed"></div>


<h3><a id="sec:11.3.4" href="#sec:the_new_status_feed" class="heading"><span class="number">11.3.4</span> The new status feed</a></h3>


<p>With the code in <a class="ref" href="#code:from_users_followed_by_final">Listing&nbsp;11.45</a>, our status feed is complete. As a reminder, the code for the Home page appears in <a class="ref" href="#code:real_feed_instance_variable">Listing&nbsp;11.46</a>; this code creates a paginated feed of the relevant microposts for use in the view, as seen in <a class="ref" href="#fig:home_page_with_feed">Figure&nbsp;11.20</a>.<sup class="footnote" id="fnref:11.14"><a href="#fn:11.14">14</a></sup> Note that the <code>paginate</code> method actually reaches all the way into the Micropost model method in <a class="ref" href="#code:from_users_followed_by_final">Listing&nbsp;11.45</a>, arranging to pull out only&nbsp;30 microposts at a time from the database. (You can verify this by examining the SQL statements in the development server log file.)</p>

<div class="label" id="code:real_feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.46.</span> <span class="description">The <code>home</code> action with a paginated feed. <br /> <code>app/controllers/static_pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_page_with_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_feed_bootstrap.png" alt="home_page_with_feed_bootstrap" /></span></div><div class="caption"><span class="header">Figure 11.20: </span><span class="description">The Home page with a working status feed.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_feed_bootstrap-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:following_conclusion"></div>


<h2><a id="sec:11.4" href="#sec:following_conclusion" class="heading"><span class="number">11.4</span> Conclusion</a></h2>


<p>With the addition of the status feed, we&rsquo;ve finished the core sample application for the <em>Ruby on Rails Tutorial</em>. This application includes examples of all the major features of Rails, including models, views, controllers, templates, partials, filters, validations, callbacks, <code>has_many</code>/<code>belongs_to</code> and <code>has_many through</code> associations, security, testing, and deployment. Despite this impressive list, there is still much to learn about Rails. As a first step in this process, this section contains some suggested extensions to the core application, as well as suggestions for further learning.</p>

<p>Before moving on to tackle any of the application extensions, it&rsquo;s a good idea to merge in your changes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add user following&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge following-users
</pre></div>
</div>


<p>As usual, you can also push the code and deploy the application if you want:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset SHARED_DATABASE --confirm &lt;name-heroku-gave-to-your-app&gt;
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<p></p>

<div class="label" id="sec:extensions_to_the_sample_application"></div>


<h3><a id="sec:11.4.1" href="#sec:extensions_to_the_sample_application" class="heading"><span class="number">11.4.1</span> Extensions to the sample application</a></h3>


<p>The proposed extensions in this section are mostly inspired either by general features common to web applications, such as password reminders and email confirmation, or features specific to our type of sample application, such as search, replies, and messaging. Implementing one or more of these application extensions will help you make the transition from following a tutorial to writing original applications of your own.</p>

<p>Don&rsquo;t be surprised if it&rsquo;s tough going at first; the blank slate of a new feature can be quite intimidating. To help get you started, I can give two pieces of general advice. First, before adding any feature to a Rails application, take a look at the <a href="http://railscasts.com/episodes/archive">RailsCasts archive</a> to see if Ryan Bates has already covered the subject.<sup class="footnote" id="fnref:11.15"><a href="#fn:11.15">15</a></sup> If he has, watching the relevant RailsCast first will often save you a ton of time. Second, always do extensive Google searches on your proposed feature to find relevant blog posts and tutorials. Web application development is hard, and it helps to learn from the experience (and mistakes) of others.</p>

<p>Many of the following features are quite challenging, and I have given some hints about the tools you might need to implement them. Even with hints, they are <em>much</em> more difficult than the book&rsquo;s end-of-chapter exercises, so don&rsquo;t be discouraged if you can&rsquo;t solve them without considerable effort. Due to time constraints, I am not available for one-on-one assistance, but if there is sufficient interest I might release standalone article/screencast bundles on some of these extensions in the future; go to the main Rails Tutorial website at <a href="http://railstutorial.org/">http://railstutorial.org/</a> and subscribe to the news feed to get the latest updates.</p>

<div class="label" id="sec:replies"></div>


<h4><a id="sec:11.4.1.1" href="#sec:replies" class="heading">Replies</a></h4>


<p>Twitter allows users to make &ldquo;@replies&rdquo;, which are microposts whose first characters are the user&rsquo;s login preceded by the <tt>@</tt>&nbsp;sign. These posts only appear in the feed of the user in question or users following that user. Implement a simplified version of this, restricting @replies to appear only in the feeds of the recipient and the sender. This might involve adding an <code>in_reply_to</code> column in the <code>microposts</code> table and an extra <code>including_replies</code> scope to the Micropost model.</p>

<p>Since our application lacks unique user logins, you will also have to decide on a way to represent users. One option is to use a combination of the id and the name, such as <code>@1-michael-hartl</code>. Another is to <em>add</em> a unique username to the signup process and then use it in @replies.</p>

<div class="label" id="sec:messaging"></div>


<h4><a id="sec:11.4.1.2" href="#sec:messaging" class="heading">Messaging</a></h4>


<p>Twitter supports direct (private) messaging by prefixing a micropost with the letter&nbsp;&ldquo;d&rdquo;. Implement this feature for the sample application. The solution will probably involve a Message model and a regular expression match on new microposts.</p>

<div class="label" id="sec:follower_notifications"></div>


<h4><a id="sec:11.4.1.3" href="#sec:follower_notifications" class="heading">Follower notifications</a></h4>


<p>Implement a feature to send each user an email notification when they gain a new follower. Then make the notification optional, so that users can opt out if desired. Among other things, adding this feature requires learning how to send mail with Rails. To get started, I suggest viewing the <a href="http://railscasts.com/episodes/206-action-mailer-in-rails-3">RailsCast on Action Mailer in Rails&nbsp;3</a>.</p>

<div class="label" id="sec:password_reminders"></div>


<h4><a id="sec:11.4.1.4" href="#sec:password_reminders" class="heading">Password reminders</a></h4>


<p>Currently, if our application&rsquo;s users forget their passwords, they have no way to retrieve them. Because of the one-way secure password hashing in <a class="ref" href="#cha:modeling_users">Chapter&nbsp;6</a>, our application can&rsquo;t email the user&rsquo;s password, but it can send a link to a reset form. Follow the steps in the <a href="http://railscasts.com/episodes/274-remember-me-reset-password">RailsCast on Remember Me &amp; Reset Password</a> to fix this omission.</p>

<div class="label" id="sec:signup_confirmation"></div>


<h4><a id="sec:11.4.1.5" href="#sec:signup_confirmation" class="heading">Signup confirmation</a></h4>


<p>Apart from an email regular expression, the sample application currently has no way to verify the validity of a user&rsquo;s email address. Add an email address verification step to confirm a user&rsquo;s signup. The new feature should create users in an inactive state, email the user an activation URI, and then change the user to an active state when the URI gets hit. You might want to read up on <a href="http://www.google.com/search?q=state+machines+in+rails">state machines in Rails</a> to help you with the inactive/active transition.</p>

<div class="label" id="sec:rss_feed"></div>


<h4><a id="sec:11.4.1.6" href="#sec:rss_feed" class="heading">RSS feed</a></h4>


<p>For each user, implement an RSS feed for their microposts. Then implement an RSS feed for their status feed, optionally restricting access to that feed using an authentication scheme. The <a href="http://railscasts.com/episodes/87-generating-rss-feeds">RailsCast on generating RSS feeds</a> will help get you started.</p>

<div class="label" id="sec:rest_api"></div>


<h4><a id="sec:11.4.1.7" href="#sec:rest_api" class="heading">REST API</a></h4>


<p>Many websites expose an Application Programmer Interface (API) so that third-party applications can get, post, put, and delete the application&rsquo;s resources. Implement such a REST API for the sample application. The solution will involve adding <code>respond_to</code> blocks (<a class="ref" href="#sec:a_working_follow_button_with_ajax">Section&nbsp;11.2.5</a>) to many of the application&rsquo;s controller actions; these should respond to requests for XML. Be careful about security; the API should only be accessible to authorized users.</p>

<div class="label" id="sec:search"></div>


<h4><a id="sec:11.4.1.8" href="#sec:search" class="heading">Search</a></h4>


<p>Currently, there is no way for users to find each other, apart from paging through the user index or viewing the feeds of other users. Implement a search feature to remedy this. Then add another search feature for microposts. The <a href="http://railscasts.com/episodes/37-simple-search-form">RailsCast on simple search forms</a> will help get you started. If you deploy using a shared host or a dedicated server, I suggest using <a href="http://freelancing-god.github.com/ts/en/">Thinking Sphinx</a> (following the <a href="http://railscasts.com/episodes/120-thinking-sphinx">RailsCast on Thinking Sphinx</a>). If you deploy on Heroku, you should follow the <a href="http://devcenter.heroku.com/articles/full-text-search">Heroku full text search</a> instructions.</p>

<div class="label" id="sec:guide_to_further_resources"></div>


<h3><a id="sec:11.4.2" href="#sec:guide_to_further_resources" class="heading"><span class="number">11.4.2</span> Guide to further resources</a></h3>


<p>There are a wealth of Rails resources in stores and on the web&mdash;indeed, the supply is so rich that it can be overwhelming. The good news is that, having gotten this far, you&rsquo;re ready for almost anything else out there. Here are some suggestions for further learning:</p>

<ul>
<li><a href="http://railstutorial.org/screencasts">The <em>Ruby on Rails Tutorial</em> screencasts</a>: I have prepared a full-length screencast course based on this book. In addition to covering all the material in the book, the screencasts are filled with tips, tricks, and the kind of see-how-it&rsquo;s-done demos that are hard to capture in print. They are available for purchase through the <a href="http://railstutorial.org/">Ruby on Rails Tutorial website</a>.</li>

<li><a href="http://railscasts.com/">RailsCasts</a>: It&rsquo;s hard to overemphasize what a great resource the RailsCasts are. I suggest starting by visiting the <a href="http://railscasts.com/episodes/archive">RailsCasts episode archive</a> and clicking on subjects that catch your eye.</li>

<li><a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a>: One topic we&rsquo;ve hardly covered in the <em>Ruby on Rails Tutorial</em> book is performance, optimization, and scaling. Luckily, most sites will never run into serious scaling issues, and using anything beyond plain Rails is probably premature optimization. If you do run into performance issues, the <a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a> series from Gregg Pollack of <a href="http://envylabs.com/">Envy Labs</a> is a good place to start. I also recommend investigating the site monitoring applications <a href="http://scoutapp.com/">Scout</a> and <a href="http://www.newrelic.com/">New Relic</a>.<sup class="footnote" id="fnref:11.16"><a href="#fn:11.16">16</a></sup> And, as you might suspect by now, there are RailsCasts on many scaling subjects, including profiling, caching, and background jobs.</li>

<li>Ruby and Rails books: I recommend <a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a> by Peter Cooper, <a href="http://www.amazon.com/gp/product/1933988657"><em>The Well-Grounded Rubyist</em></a> by David&nbsp;A. Black, and <a href="http://www.amazon.com/gp/product/0672328844"><em>The Ruby Way</em></a> by Hal Fulton for further Ruby learning, and <a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails&nbsp;3 Way</em></a> by Obie Fernandez and <em>Rails&nbsp;3 in Action</em> (wait for the second edition) by Ryan Bigg and Yehuda Katz for more about Rails.</li>

<li><a href="http://peepcode.com/">PeepCode</a> and <a href="http://codeschool.com/">Code School</a>: The screencasts at PeepCode and interactive courses at Code School are consistently high-quality, and I warmly recommend them.</li>

</ul>




<div class="label" id="sec:following_exercises"></div>


<h2><a id="sec:11.5" href="#sec:following_exercises" class="heading"><span class="number">11.5</span> Exercises</a></h2>




<ol>
<li>Add tests for destroying relationships associated with a given user (i.e., as implemented by <code>dependent :destroy</code> in <a class="ref" href="#code:user_relationships_association">Listing&nbsp;11.4</a> and <a class="ref" href="#code:user_reverse_relationships">Listing&nbsp;11.16</a>). <em>Hint</em>: Follow the example in <a class="ref" href="#code:micropost_dependency_test">Listing&nbsp;10.15</a>.</li>
<li>The <code>respond_to</code> method seen in <a class="ref" href="#code:relationships_controller_ajax">Listing&nbsp;11.38</a> can actually be hoisted out of the actions into the Relationships controller itself, and the <code>respond_to</code> blocks can be replaced with a Rails method called <code>respond_with</code>. Prove that the resulting code, shown in <a class="ref" href="#code:compact_respond_to">Listing&nbsp;11.47</a>, is correct by verifying that the test suite still passes. (For details on this method, do a Google search on &ldquo;rails respond_with&rdquo;.)</li>
<li>Refactor <a class="ref" href="#code:show_follow_view">Listing&nbsp;11.31</a> by adding partials for the code common to the following/followers pages, the Home page, and the user show page.</li>
<li>Following the model in <a class="ref" href="#code:stats_view_test">Listing&nbsp;11.19</a>, write tests for the stats on the profile page.</li>
</ol>




<div class="label" id="code:compact_respond_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.47.</span> <span class="description">A compact refactoring of <a class="ref" href="#code:relationships_controller_ajax">Listing&nbsp;11.38</a>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:js</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<div class="footnotes">
<ol>
<li id="fn:11.1">The photographs in the mockup tour are from <a href="http://www.flickr.com/photos/john_lustig/2518452221/">http://www.flickr.com/photos/john_lustig/2518452221/</a> and <a href="http://www.flickr.com/photos/30775272@N05/2884963755/">http://www.flickr.com/photos/30775272@N05/2884963755/</a>.&nbsp;<a class="arrow" href="#fnref:11.1">&uarr;</a></li>
<li id="fn:11.2">The first edition of this book used the <code>user.following</code> terminology, which even I found confusing at times. Thanks to reader Cosmo Lee for convincing me to change the terminology and for offering suggestions on how to make it clearer. (I didn&rsquo;t follow his exact advice, though, so if it&rsquo;s still confusing he bears none of the blame.)&nbsp;<a class="arrow" href="#fnref:11.2">&uarr;</a></li>
<li id="fn:11.3">For simplicity, <a class="ref" href="#fig:naive_user_has_many_following">Figure&nbsp;11.6</a> suppresses the <code>followed_users</code> table&rsquo;s&nbsp;<code>id</code> column.&nbsp;<a class="arrow" href="#fnref:11.3">&uarr;</a></li>
<li id="fn:11.4">See the discussion on <a href="http://stackoverflow.com/questions/5359558/when-to-use-rspec-let">when to use let at Stack Overflow</a> for more information.&nbsp;<a class="arrow" href="#fnref:11.4">&uarr;</a></li>
<li id="fn:11.5">Technically, Rails uses the <code>underscore</code> method to convert the class name to an id. For example, <code>"FooBar".underscore</code> is <code>"foo_bar"</code>, so the foreign key for a <code>FooBar</code> object would be <code>foo_bar_id</code>. (Incidentally, the inverse of <code>underscore</code> is <code>camelize</code>, which converts <code>"camel_case"</code> to <code>"CamelCase"</code>.)&nbsp;<a class="arrow" href="#fnref:11.5">&uarr;</a></li>
<li id="fn:11.6">If you&rsquo;ve noticed that <code>followed_id</code> also identifies a user, and are concerned about the asymmetric treatment of followed and follower, you&rsquo;re ahead of the game. We&rsquo;ll deal with this issue in <a class="ref" href="#sec:followers">Section&nbsp;11.1.5</a>.&nbsp;<a class="arrow" href="#fnref:11.6">&uarr;</a></li>
<li id="fn:11.7">Once you have a lot of experience modeling a particular domain, you can often guess such utility methods in advance, and even when you can&rsquo;t you&rsquo;ll often find yourself writing them to make the tests cleaner. In this case, though, it&rsquo;s OK if you wouldn&rsquo;t have guessed them. Software development is usually an iterative process&mdash;you write code until it starts getting ugly, and then you refactor it&mdash;but for brevity the tutorial presentation is streamlined a bit.&nbsp;<a class="arrow" href="#fnref:11.7">&uarr;</a></li>
<li id="fn:11.8">The <code>unfollow!</code> method <em>doesn&rsquo;t</em> raise an exception on failure&mdash;in fact, I don&rsquo;t even know how Rails indicates a failed destroy&mdash;but we use an exclamation point to maintain the symmetry with <code>follow!</code>.&nbsp;<a class="arrow" href="#fnref:11.8">&uarr;</a></li>
<li id="fn:11.9">Because it is nominally an acronym for <em>asynchronous JavaScript and XML</em>, Ajax is sometimes misspelled &ldquo;AJAX&rdquo;, even though the <a href="http://www.adaptivepath.com/ideas/essays/archives/000385.php">original Ajax article</a> spells it as &ldquo;Ajax&rdquo; throughout.&nbsp;<a class="arrow" href="#fnref:11.9">&uarr;</a></li>
<li id="fn:11.10">This only works if JavaScript is enabled in the browser, but it degrades gracefully, working exactly as in <a class="ref" href="#sec:a_working_follow_button_the_standard_way">Section&nbsp;11.2.4</a> if JavaScript is disabled.&nbsp;<a class="arrow" href="#fnref:11.10">&uarr;</a></li>
<li id="fn:11.11">The main requirement is that enumerable objects must implement an <code>each</code> method to iterate through the collection.&nbsp;<a class="arrow" href="#fnref:11.11">&uarr;</a></li>
<li id="fn:11.12">This notation actually started as an extension Rails made to the core Ruby language; it was so useful that it has now been incorporated into Ruby itself. How cool is that?&nbsp;<a class="arrow" href="#fnref:11.12">&uarr;</a></li>
<li id="fn:11.13">For a more advanced way to create the necessary subselect, see the blog post <a href="http://pivotallabs.com/users/jsusser/blog/articles/567-hacking-a-subselect-in-activerecord">&ldquo;Hacking a subselect in ActiveRecord&rdquo;.</a>&nbsp;<a class="arrow" href="#fnref:11.13">&uarr;</a></li>
<li id="fn:11.14">In order to make a prettier feed for <a class="ref" href="#fig:home_page_with_feed">Figure&nbsp;11.20</a>, I&rsquo;ve added a few extra microposts by hand using the Rails console.&nbsp;<a class="arrow" href="#fnref:11.14">&uarr;</a></li>
<li id="fn:11.15">Note that RailsCasts usually omit the tests, which is probably necessary to keep the episodes nice and short, but you could get the wrong idea about the importance of testing. Once you&rsquo;ve watched the relevant RailsCast to get a basic idea of how to proceed, I suggest writing the new feature using test-driven development. (In this context, I recommend taking a look at <a href="http://railscasts.com/episodes/275-how-i-test">the RailsCast on &ldquo;How I test&rdquo;</a>. You&rsquo;ll see that Ryan Bates himself often uses TDD for real-life development, and in fact his testing style is similar to style used in this tutorial.)&nbsp;<a class="arrow" href="#fnref:11.15">&uarr;</a></li>
<li id="fn:11.16">In addition to being a clever phrase&mdash;<em>new relic</em> being a contradiction in terms&mdash;New Relic is also an anagram for the name of the company&rsquo;s founder, Lew Cirne.&nbsp;<a class="arrow" href="#fnref:11.16">&uarr;</a></li>
</ol>
</div>




    </div>
  <div id="book_bottom">
  </div>
</div>
        
        </div>  
Michael Hartl is a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for sites to earn advertising fees by advertising and linking to Amazon.com.</div>
 
    <div id="container-bottom"></div>
    
<div id="fb-root"></div>
<script>
  window.fbAsyncInit = function() {
    FB.init({appId: '145973438749643', status: true, cookie: true,
             xfbml: true});
  };
  (function() {
    var e = document.createElement('script');
    e.type = 'text/javascript';
    e.src = document.location.protocol +
      '//connect.facebook.net/en_US/all.js';
    e.async = true;
    document.getElementById('fb-root').appendChild(e);
  }());
</script>

  
      <script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script>
  <script type="text/javascript">
  try {
  var pageTracker = _gat._getTracker("UA-8667566-1");
  pageTracker._trackPageview();
  } catch(err) {}</script>

  
  
  </div>
</body>
</html>